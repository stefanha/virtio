<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head>
<title>Virtual I/O Device (VIRTIO) Version 1.1</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<!-- info,charset=utf-8,fn-in,html --> 
<meta name="src" content="virtio-v1.1-cs01.tex"> 
<link rel="stylesheet" type="text/css" href="virtio-v1.1-cs01.css"> 
</head><body 
>
<!--l. 1--><p class="noindent" >
                                                                  

                                                                  
<!--l. 4--><p class="noindent" ><table style="border-collapse:collapse;"><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ><img 
src="images/oasis.png" alt="PIC"  
>  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<!--l. 9--><p class="noindent" ><div style="color: #446CAA; font-size: 24pt;"> <span 
class="aebx-10">Virtual I/O Device (VIRTIO) Version 1.1 </span></div>
<!--l. 10--><p class="noindent" ><div style="color: #446CAA; font-size: 18pt;"> <span 
class="aebx-10">Committee Specification 01 </span></div>
<!--l. 12--><p class="noindent" ><div style="color: #446CAA; font-size: 18pt;"> <span 
class="aebx-10">11 April 2019 </span></div>
<!--l. 14--><p class="noindent" ><div style="color: #446CAA; font-size: 12pt;"> <span 
class="aebx-10">Specification URIs </span></div>
<!--l. 16--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">This version: </span></div> <div style="margin-left: 20px;">  <a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/tex/" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/tex/</a>
(Authoritative)<br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.pdf" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.pdf</a><br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html</a> </div>
<!--l. 22--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Previous version: </span></div> <div style="margin-left: 20px;">  N/A  </div>
<!--l. 26--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Latest version: </span></div> <div style="margin-left: 20px;">  <a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.pdf" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.pdf</a><br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html</a> </div>
<!--l. 31--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Technical Committee: </span></div> <div style="margin-left: 20px;">  <a 
href="https://www.oasis-open.org/committees/virtio/" >OASIS Virtual I/O Device (VIRTIO) TC</a>  </div>
<!--l. 35--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Chair: </span></div> <div style="margin-left: 20px;"> <a 
 id="x1-1doc"></a> Michael S. Tsirkin (<a 
href="mailto:mst@redhat.com" >mst@redhat.com</a>), <a 
href="https://www.redhat.com/" >Red Hat</a><br 
class="newline" /> </div>
<!--l. 39--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Editors: </span></div> <div style="margin-left: 20px;">  Michael S. Tsirkin (<a 
href="mailto:mst@redhat.com" >mst@redhat.com</a>), <a 
href="https://www.redhat.com/" >Red Hat</a><br 
class="newline" />Cornelia Huck (<a 
href="mailto:cohuck@redhat.com" >cohuck@redhat.com</a>), <a 
href="https://www.redhat.com/" >Red Hat</a><br 
class="newline" /> </div>
<!--l. 45--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Additional artifacts: </span></div> <div style="margin-left: 20px;">  This prose specification is one component of a Work
Product that also includes:
     <ul class="itemize1">
     <li class="itemize">Example Driver Listing: <br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/listings/" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/listings/</a></li></ul>
                                                                  

                                                                  
</div>
<!--l. 54--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Related work: </span></div> <div style="margin-left: 20px;">  This specification replaces or supersedes:
     <ul class="itemize1">
     <li class="itemize">Virtual  I/O  Device  (VIRTIO)  Version  1.0.  Edited  by  Rusty  Russell,
     Michael S. Tsirkin, Cornelia Huck, and Pawel Moll. Latest version:<br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html</a>
     <a 
href="http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf" class="url" >http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf</a>
     </li>
     <li class="itemize">Virtio PCI Card Specification Version 0.9.5:<br 
class="newline" /><a 
href="http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf" class="url" >http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf</a></li></ul>
</div>
<!--l. 77--><p class="noindent" >
                                                                  

                                                                  
<!--l. 79--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Abstract: </span></div> <div style="margin-left: 20px;">  This document describes the specifications of the “virtio” family of
devices. These devices are found in virtual environments, yet by design they look like
physical devices to the guest within the virtual machine - and this document treats
them as such. This similarity allows the guest to use standard drivers and discovery
mechanisms.
<!--l. 8--><p class="noindent" >The purpose of virtio and this specification is that virtual environments and guests
should have a straightforward, efficient, standard and extensible mechanism for
virtual devices, rather than boutique per-environment or per-OS mechanisms.   </div>
<!--l. 83--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Status: </span></div> <div style="margin-left: 20px;">  This document was last revised or approved by the Virtual I/O
Device (VIRTIO) TC on the above date. The level of approval is also
listed above. Check the “Latest version” location noted above for possible
later revisions of this document. Any other numbered Versions and other
technical work produced by the Technical Committee (TC) are listed at
<a 
href="https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=virtio#technical" class="url" >https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=virtio#technical</a>.
<!--l. 91--><p class="noindent" >Technical Committee members should send comments on this specification to the
Technical Committee’s email list. Others should send comments to the Technical
Committee by using the “<a 
href="https://www.oasis-open.org/committees/comments/form.php?wg_abbrev=virtio" >Send A Comment</a>” button on the Technical Committee’s
web page at <a 
href="https://www.oasis-open.org/committees/virtio/" class="url" >https://www.oasis-open.org/committees/virtio/</a>.
<!--l. 1--><p class="noindent" >This specification is provided under the <a 
href="https://www.oasis-open.org/policies-guidelines/ipr#Non-Assertion-Mode" >Non-Assertion</a> Mode of the <a 
href="https://www.oasis-open.org/policies-guidelines/ipr" >OASIS IPR
Policy</a>, the mode chosen when the Technical Committee was established. For
information on whether any patents have been disclosed that may be essential to
implementing this specification, and any offers of patent licensing terms,
please refer to the Intellectual Property Rights section of the TC’s web page
(<a 
href="https://github.com/oasis-tcs/virtio-admin/blob/master/IPR.md" class="url" >https://github.com/oasis-tcs/virtio-admin/blob/master/IPR.md</a>).
<!--l. 100--><p class="noindent" >Note that any machine-readable content (<a 
href="https://www.oasis-open.org/policies-guidelines/tc-process#wpComponentsCompLang" >Computer Language Definitions</a>) declared
Normative for this Work Product is provided in separate plain text files. In the event
of a discrepancy between any such plain text file and display content in the Work
Product’s prose narrative document(s), the content in the separate plain text file
prevails.
</div>
<!--l. 111--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aebx-10">Citation format: </span></div> <div style="margin-left: 20px;">  When referencing this specification the following citation
format should be used:<br 
class="newline" />
<!--l. 114--><p class="noindent" ><span 
class="aebx-10">[VIRTIO-v1.1]</span><br 
class="newline" /><span 
class="aeti-10">Virtual I/O Device (VIRTIO) Version 1.1</span>. Edited by Michael S. Tsirkin
and Cornelia Huck. 11 April 2019. OASIS Committee Specification 01.
<a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html</a>. Latest
version: <a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html</a>.  </div>
                                                                  

                                                                  
<!--l. 120--><p class="noindent" >
                                                                  

                                                                  
__________________________________________________________________
<!--l. 122--><p class="noindent" ><div style="color: #446CAA; font-size: 18pt;"> <span 
class="aebx-10">Notices </span></div>
<!--l. 124--><p class="noindent" >Copyright <span 
class="cmsy-10">© </span>OASIS Open 2018. All Rights Reserved.
<!--l. 126--><p class="noindent" >All capitalized terms in the following text have the meanings assigned to them in the
OASIS Intellectual Property Rights Policy (the "OASIS IPR Policy"). The full <a 
href="https://www.oasis-open.org/policies-guidelines/ipr" >Policy</a>
may be found at the OASIS website.
<!--l. 130--><p class="noindent" >This document and translations of it may be copied and furnished to others, and
derivative works that comment on or otherwise explain it or assist in its
implementation may be prepared, copied, published, and distributed, in whole or in
part, without restriction of any kind, provided that the above copyright notice and
this section are included on all such copies and derivative works. However, this
document itself may not be modified in any way, including by removing the copyright
notice or references to OASIS, except as needed for the purpose of developing any
document or deliverable produced by an OASIS Technical Committee (in which case
the rules applicable to copyrights, as set forth in the OASIS IPR Policy,
must be followed) or as required to translate it into languages other than
English.
<!--l. 1--><p class="noindent" >This specification is provided under the <a 
href="https://www.oasis-open.org/policies-guidelines/ipr#Non-Assertion-Mode" >Non-Assertion</a> Mode of the <a 
href="https://www.oasis-open.org/policies-guidelines/ipr" >OASIS IPR
Policy</a>, the mode chosen when the Technical Committee was established. For
information on whether any patents have been disclosed that may be essential to
implementing this specification, and any offers of patent licensing terms,
please refer to the Intellectual Property Rights section of the TC’s web page
(<a 
href="https://github.com/oasis-tcs/virtio-admin/blob/master/IPR.md" class="url" >https://github.com/oasis-tcs/virtio-admin/blob/master/IPR.md</a>).
<!--l. 145--><p class="noindent" >The limited permissions granted above are perpetual and will not be revoked by
OASIS or its successors or assigns.
<!--l. 148--><p class="noindent" >This document and the information contained herein is provided on an "AS IS" basis
and OASIS DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED,
INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF
THE INFORMATION HEREIN WILL NOT INFRINGE ANY OWNERSHIP
RIGHTS OR ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR
FITNESS FOR A PARTICULAR PURPOSE.
<!--l. 155--><p class="noindent" >OASIS requests that any OASIS Party or any other party that believes it has patent
claims that would necessarily be infringed by implementations of this OASIS
Committee Specification or OASIS Standard, to notify OASIS TC Administrator and
provide an indication of its willingness to grant patent licenses to such patent claims
in a manner consistent with the IPR Mode of the OASIS Technical Committee that
produced this specification.
<!--l. 163--><p class="noindent" >OASIS invites any party to contact the OASIS TC Administrator if it is aware of a
claim of ownership of any patent claims that would necessarily be infringed by
implementations of this specification by a patent holder that is not willing to provide
                                                                  

                                                                  
a license to such patent claims in a manner consistent with the IPR Mode of
the OASIS Technical Committee that produced this specification. OASIS
may include such claims on its website, but disclaims any obligation to do
so.
<!--l. 171--><p class="noindent" >OASIS takes no position regarding the validity or scope of any intellectual property
or other rights that might be claimed to pertain to the implementation or use
of the technology described in this document or the extent to which any
license under such rights might or might not be available; neither does it
represent that it has made any effort to identify any such rights. Information on
OASIS’ procedures with respect to rights in any document or deliverable
produced by an OASIS Technical Committee can be found on the OASIS
website. Copies of claims of rights made available for publication and any
assurances of licenses to be made available, or the result of an attempt made to
obtain a general license or permission for the use of such proprietary rights by
implementers or users of this OASIS Committee Specification or OASIS
Standard, can be obtained from the OASIS TC Administrator. OASIS makes no
representation that any information or list of intellectual property rights will at
any time be complete, or that any claims in such list are, in fact, Essential
Claims.
<!--l. 188--><p class="noindent" >The name "OASIS" is a trademark of <a 
href="https://www.oasis-open.org/" >OASIS</a>, the owner and developer of this
specification, and should be used only to refer to the organization and its official
outputs. OASIS welcomes reference to, and implementation and use of, specifications,
while reserving the right to enforce its marks against misleading uses. Please see
<a 
href="https://www.oasis-open.org/policies-guidelines/trademark" class="url" >https://www.oasis-open.org/policies-guidelines/trademark</a> for above guidance.
<br 
class="newline" /><br 
class="newline" />
                                                                  

                                                                  
                                                                  

                                                                  
__________________________________________________________________
<h2 class="likechapterHead"><a 
 id="x1-1000"></a>Table of Contents</h2>
<div class="tableofcontents">
<span class="chapterToc" >1 <a 
href="#x1-20001" id="QQ2-1-2">Introduction</a></span>
<br /> <span class="sectionToc" >1.1 <a 
href="#x1-30001" id="QQ2-1-3">Normative References</a></span>
<br /> <span class="sectionToc" >1.2 <a 
href="#x1-40002" id="QQ2-1-4">Non-Normative References</a></span>
<br /> <span class="sectionToc" >1.3 <a 
href="#x1-50003" id="QQ2-1-5">Terminology</a></span>
<br />  <span class="subsectionToc" >1.3.1 <a 
href="#x1-60001" id="QQ2-1-6">Legacy Interface: Terminology</a></span>
<br />  <span class="subsectionToc" >1.3.2 <a 
href="#x1-70002" id="QQ2-1-7">Transition from earlier specification drafts</a></span>
<br /> <span class="sectionToc" >1.4 <a 
href="#x1-80004" id="QQ2-1-8">Structure Specifications</a></span>
<br /><span class="chapterToc" >2 <a 
href="#x1-90002" id="QQ2-1-9">Basic Facilities of a Virtio Device</a></span>
<br /> <span class="sectionToc" >2.1 <a 
href="#x1-100001" id="QQ2-1-10"><span 
class="aeti-10">Device Status </span>Field</a></span>
<br />  <span class="subsectionToc" >2.1.1 <a 
href="#x1-110001" id="QQ2-1-11">Driver Requirements: Device Status Field</a></span>
<br />  <span class="subsectionToc" >2.1.2 <a 
href="#x1-120002" id="QQ2-1-12">Device Requirements: Device Status Field</a></span>
<br /> <span class="sectionToc" >2.2 <a 
href="#x1-130002" id="QQ2-1-13">Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.1 <a 
href="#x1-140001" id="QQ2-1-14">Driver Requirements: Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.2 <a 
href="#x1-150002" id="QQ2-1-15">Device Requirements: Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.3 <a 
href="#x1-160003" id="QQ2-1-16">Legacy Interface: A Note on Feature Bits</a></span>
<br /> <span class="sectionToc" >2.3 <a 
href="#x1-170003" id="QQ2-1-17">Notifications</a></span>
<br /> <span class="sectionToc" >2.4 <a 
href="#x1-180004" id="QQ2-1-18">Device Configuration Space</a></span>
<br />  <span class="subsectionToc" >2.4.1 <a 
href="#x1-190001" id="QQ2-1-19">Driver Requirements: Device Configuration Space</a></span>
<br />  <span class="subsectionToc" >2.4.2 <a 
href="#x1-200002" id="QQ2-1-20">Device Requirements: Device Configuration Space</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >2.4.3 <a 
href="#x1-210003" id="QQ2-1-21">Legacy Interface: A Note on Device Configuration Space endian-ness</a></span>
<br />  <span class="subsectionToc" >2.4.4 <a 
href="#x1-220004" id="QQ2-1-22">Legacy Interface: Device Configuration Space</a></span>
<br /> <span class="sectionToc" >2.5 <a 
href="#x1-230005" id="QQ2-1-23">Virtqueues</a></span>
<br /> <span class="sectionToc" >2.6 <a 
href="#x1-240006" id="QQ2-1-24">Split Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.6.1 <a 
href="#x1-250001" id="QQ2-1-25">Driver Requirements: Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.6.2 <a 
href="#x1-260002" id="QQ2-1-26">Legacy Interfaces: A Note on Virtqueue Layout</a></span>
<br />  <span class="subsectionToc" >2.6.3 <a 
href="#x1-270003" id="QQ2-1-27">Legacy Interfaces: A Note on Virtqueue Endianness</a></span>
<br />  <span class="subsectionToc" >2.6.4 <a 
href="#x1-280004" id="QQ2-1-28">Message Framing</a></span>
<br />  <span class="subsectionToc" >2.6.5 <a 
href="#x1-320005" id="QQ2-1-32">The Virtqueue Descriptor Table</a></span>
<br />  <span class="subsectionToc" >2.6.6 <a 
href="#x1-380006" id="QQ2-1-38">The Virtqueue Available Ring</a></span>
<br />  <span class="subsectionToc" >2.6.7 <a 
href="#x1-400007" id="QQ2-1-40">Used Buffer Notification Suppression</a></span>
<br />  <span class="subsectionToc" >2.6.8 <a 
href="#x1-430008" id="QQ2-1-43">The Virtqueue Used Ring</a></span>
<br />  <span class="subsectionToc" >2.6.9 <a 
href="#x1-470009" id="QQ2-1-47">In-order use of descriptors</a></span>
<br />  <span class="subsectionToc" >2.6.10 <a 
href="#x1-4800010" id="QQ2-1-48">Available Buffer Notification Suppression</a></span>
<br />  <span class="subsectionToc" >2.6.11 <a 
href="#x1-5100011" id="QQ2-1-51">Helpers for Operating Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.6.12 <a 
href="#x1-5200012" id="QQ2-1-52">Virtqueue Operation</a></span>
<br />  <span class="subsectionToc" >2.6.13 <a 
href="#x1-5300013" id="QQ2-1-53">Supplying Buffers to The Device</a></span>
<br />  <span class="subsectionToc" >2.6.14 <a 
href="#x1-6000014" id="QQ2-1-60">Receiving Used Buffers From The Device</a></span>
<br /> <span class="sectionToc" >2.7 <a 
href="#x1-610007" id="QQ2-1-61">Packed Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.7.1 <a 
href="#x1-620001" id="QQ2-1-62">Driver and Device Ring Wrap Counters</a></span>
<br />  <span class="subsectionToc" >2.7.2 <a 
href="#x1-630002" id="QQ2-1-63">Polling of available and used descriptors</a></span>
<br />  <span class="subsectionToc" >2.7.3 <a 
href="#x1-640003" id="QQ2-1-64">Write Flag</a></span>
<br />  <span class="subsectionToc" >2.7.4 <a 
href="#x1-650004" id="QQ2-1-65">Element Address and Length</a></span>
<br />  <span class="subsectionToc" >2.7.5 <a 
href="#x1-660005" id="QQ2-1-66">Scatter-Gather Support</a></span>
<br />  <span class="subsectionToc" >2.7.6 <a 
href="#x1-670006" id="QQ2-1-67">Next Flag: Descriptor Chaining</a></span>
<br />  <span class="subsectionToc" >2.7.7 <a 
href="#x1-680007" id="QQ2-1-68">Indirect Flag: Scatter-Gather Support</a></span>
<br />  <span class="subsectionToc" >2.7.8 <a 
href="#x1-690008" id="QQ2-1-69">In-order use of descriptors</a></span>
<br />  <span class="subsectionToc" >2.7.9 <a 
href="#x1-700009" id="QQ2-1-70">Multi-buffer requests</a></span>
<br />  <span class="subsectionToc" >2.7.10 <a 
href="#x1-7100010" id="QQ2-1-71">Driver and Device Event Suppression</a></span>
<br />  <span class="subsectionToc" >2.7.11 <a 
href="#x1-7300011" id="QQ2-1-73">Driver Requirements: Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.7.12 <a 
href="#x1-7400012" id="QQ2-1-74">Device Requirements: Virtqueues</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >2.7.13 <a 
href="#x1-7500013" id="QQ2-1-75">The Virtqueue Descriptor Format</a></span>
<br />  <span class="subsectionToc" >2.7.14 <a 
href="#x1-7600014" id="QQ2-1-76">Event Suppression Structure Format</a></span>
<br />  <span class="subsectionToc" >2.7.15 <a 
href="#x1-7700015" id="QQ2-1-77">Device Requirements: The Virtqueue Descriptor Table</a></span>
<br />  <span class="subsectionToc" >2.7.16 <a 
href="#x1-7800016" id="QQ2-1-78">Driver Requirements: The Virtqueue Descriptor Table</a></span>
<br />  <span class="subsectionToc" >2.7.17 <a 
href="#x1-7900017" id="QQ2-1-79">Driver Requirements: Scatter-Gather Support</a></span>
<br />  <span class="subsectionToc" >2.7.18 <a 
href="#x1-8000018" id="QQ2-1-80">Device Requirements: Scatter-Gather Support</a></span>
<br />  <span class="subsectionToc" >2.7.19 <a 
href="#x1-8100019" id="QQ2-1-81">Driver Requirements: Indirect Descriptors</a></span>
<br />  <span class="subsectionToc" >2.7.20 <a 
href="#x1-8200020" id="QQ2-1-82">Virtqueue Operation</a></span>
<br />  <span class="subsectionToc" >2.7.21 <a 
href="#x1-8300021" id="QQ2-1-83">Supplying Buffers to The Device</a></span>
<br />  <span class="subsectionToc" >2.7.22 <a 
href="#x1-8900022" id="QQ2-1-89">Receiving Used Buffers From The Device</a></span>
<br />  <span class="subsectionToc" >2.7.23 <a 
href="#x1-9000023" id="QQ2-1-90">Driver notifications</a></span>
<br /> <span class="sectionToc" >2.8 <a 
href="#x1-910008" id="QQ2-1-91">Shared Memory Regions</a></span>
<br />  <span class="subsectionToc" >2.8.1 <a 
href="#x1-920001" id="QQ2-1-92">Addressing within regions</a></span>
<br />  <span class="subsectionToc" >2.8.2 <a 
href="#x1-930002" id="QQ2-1-93">Device Requirements: Shared Memory Regions</a></span>
<br /><span class="chapterToc" >3 <a 
href="#x1-940003" id="QQ2-1-94">General Initialization And Device Operation</a></span>
<br /> <span class="sectionToc" >3.1 <a 
href="#x1-950001" id="QQ2-1-95">Device Initialization</a></span>
<br />  <span class="subsectionToc" >3.1.1 <a 
href="#x1-960001" id="QQ2-1-96">Driver Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >3.1.2 <a 
href="#x1-970002" id="QQ2-1-97">Legacy Interface: Device Initialization</a></span>
<br /> <span class="sectionToc" >3.2 <a 
href="#x1-980002" id="QQ2-1-98">Device Operation</a></span>
<br />  <span class="subsectionToc" >3.2.1 <a 
href="#x1-990001" id="QQ2-1-99">Notification of Device Configuration Changes</a></span>
<br /> <span class="sectionToc" >3.3 <a 
href="#x1-1000003" id="QQ2-1-100">Device Cleanup</a></span>
<br />  <span class="subsectionToc" >3.3.1 <a 
href="#x1-1010001" id="QQ2-1-101">Driver Requirements: Device Cleanup</a></span>
<br /><span class="chapterToc" >4 <a 
href="#x1-1020004" id="QQ2-1-102">Virtio Transport Options</a></span>
<br /> <span class="sectionToc" >4.1 <a 
href="#x1-1030001" id="QQ2-1-103">Virtio Over PCI Bus</a></span>
<br />  <span class="subsectionToc" >4.1.1 <a 
href="#x1-1040001" id="QQ2-1-104">Device Requirements: Virtio Over PCI Bus</a></span>
<br />  <span class="subsectionToc" >4.1.2 <a 
href="#x1-1050002" id="QQ2-1-105">PCI Device Discovery</a></span>
<br />  <span class="subsectionToc" >4.1.3 <a 
href="#x1-1090003" id="QQ2-1-109">PCI Device Layout</a></span>
<br />  <span class="subsectionToc" >4.1.4 <a 
href="#x1-1120004" id="QQ2-1-112">Virtio Structure PCI Capabilities</a></span>
<br />  <span class="subsectionToc" >4.1.5 <a 
href="#x1-1330005" id="QQ2-1-133">PCI-specific Initialization And Device Operation</a></span>
<br /> <span class="sectionToc" >4.2 <a 
href="#x1-1490002" id="QQ2-1-150">Virtio Over MMIO</a></span>
<br />  <span class="subsectionToc" >4.2.1 <a 
href="#x1-1500001" id="QQ2-1-151">MMIO Device Discovery</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >4.2.2 <a 
href="#x1-1510002" id="QQ2-1-152">MMIO Device Register Layout</a></span>
<br />  <span class="subsectionToc" >4.2.3 <a 
href="#x1-1540003" id="QQ2-1-157">MMIO-specific Initialization And Device Operation</a></span>
<br />  <span class="subsectionToc" >4.2.4 <a 
href="#x1-1610004" id="QQ2-1-165">Legacy interface</a></span>
<br /> <span class="sectionToc" >4.3 <a 
href="#x1-1620003" id="QQ2-1-167">Virtio Over Channel I/O</a></span>
<br />  <span class="subsectionToc" >4.3.1 <a 
href="#x1-1630001" id="QQ2-1-168">Basic Concepts</a></span>
<br />  <span class="subsectionToc" >4.3.2 <a 
href="#x1-1680002" id="QQ2-1-173">Device Initialization</a></span>
<br />  <span class="subsectionToc" >4.3.3 <a 
href="#x1-1870003" id="QQ2-1-192">Device Operation</a></span>
<br /><span class="chapterToc" >5 <a 
href="#x1-1980005" id="QQ2-1-204">Device Types</a></span>
<br /> <span class="sectionToc" >5.1 <a 
href="#x1-1990001" id="QQ2-1-205">Network Device</a></span>
<br />  <span class="subsectionToc" >5.1.1 <a 
href="#x1-2000001" id="QQ2-1-206">Device ID</a></span>
<br />  <span class="subsectionToc" >5.1.2 <a 
href="#x1-2010002" id="QQ2-1-207">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.1.3 <a 
href="#x1-2020003" id="QQ2-1-208">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.1.4 <a 
href="#x1-2050004" id="QQ2-1-211">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.1.5 <a 
href="#x1-2090005" id="QQ2-1-215">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.1.6 <a 
href="#x1-2100006" id="QQ2-1-216">Device Operation</a></span>
<br /> <span class="sectionToc" >5.2 <a 
href="#x1-2440002" id="QQ2-1-250">Block Device</a></span>
<br />  <span class="subsectionToc" >5.2.1 <a 
href="#x1-2450001" id="QQ2-1-251">Device ID</a></span>
<br />  <span class="subsectionToc" >5.2.2 <a 
href="#x1-2460002" id="QQ2-1-252">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.2.3 <a 
href="#x1-2470003" id="QQ2-1-253">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.2.4 <a 
href="#x1-2490004" id="QQ2-1-255">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.2.5 <a 
href="#x1-2510005" id="QQ2-1-257">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.2.6 <a 
href="#x1-2550006" id="QQ2-1-261">Device Operation</a></span>
<br /> <span class="sectionToc" >5.3 <a 
href="#x1-2600003" id="QQ2-1-266">Console Device</a></span>
<br />  <span class="subsectionToc" >5.3.1 <a 
href="#x1-2610001" id="QQ2-1-267">Device ID</a></span>
<br />  <span class="subsectionToc" >5.3.2 <a 
href="#x1-2620002" id="QQ2-1-268">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.3.3 <a 
href="#x1-2630003" id="QQ2-1-269">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.3.4 <a 
href="#x1-2640004" id="QQ2-1-270">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.3.5 <a 
href="#x1-2660005" id="QQ2-1-272">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.3.6 <a 
href="#x1-2680006" id="QQ2-1-274">Device Operation</a></span>
<br /> <span class="sectionToc" >5.4 <a 
href="#x1-2750004" id="QQ2-1-281">Entropy Device</a></span>
<br />  <span class="subsectionToc" >5.4.1 <a 
href="#x1-2760001" id="QQ2-1-282">Device ID</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >5.4.2 <a 
href="#x1-2770002" id="QQ2-1-283">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.4.3 <a 
href="#x1-2780003" id="QQ2-1-284">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.4.4 <a 
href="#x1-2790004" id="QQ2-1-285">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.4.5 <a 
href="#x1-2800005" id="QQ2-1-286">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.4.6 <a 
href="#x1-2810006" id="QQ2-1-287">Device Operation</a></span>
<br /> <span class="sectionToc" >5.5 <a 
href="#x1-2840005" id="QQ2-1-290">Traditional Memory Balloon Device</a></span>
<br />  <span class="subsectionToc" >5.5.1 <a 
href="#x1-2850001" id="QQ2-1-291">Device ID</a></span>
<br />  <span class="subsectionToc" >5.5.2 <a 
href="#x1-2860002" id="QQ2-1-292">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.5.3 <a 
href="#x1-2870003" id="QQ2-1-293">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.5.4 <a 
href="#x1-2910004" id="QQ2-1-297">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.5.5 <a 
href="#x1-2930005" id="QQ2-1-299">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.5.6 <a 
href="#x1-2940006" id="QQ2-1-300">Device Operation</a></span>
<br /> <span class="sectionToc" >5.6 <a 
href="#x1-3030006" id="QQ2-1-309">SCSI Host Device</a></span>
<br />  <span class="subsectionToc" >5.6.1 <a 
href="#x1-3040001" id="QQ2-1-310">Device ID</a></span>
<br />  <span class="subsectionToc" >5.6.2 <a 
href="#x1-3050002" id="QQ2-1-311">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.6.3 <a 
href="#x1-3060003" id="QQ2-1-312">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.6.4 <a 
href="#x1-3070004" id="QQ2-1-313">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.6.5 <a 
href="#x1-3110005" id="QQ2-1-317">Device Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.6.6 <a 
href="#x1-3120006" id="QQ2-1-318">Device Operation</a></span>
<br /> <span class="sectionToc" >5.7 <a 
href="#x1-3250007" id="QQ2-1-331">GPU Device</a></span>
<br />  <span class="subsectionToc" >5.7.1 <a 
href="#x1-3260001" id="QQ2-1-332">Device ID</a></span>
<br />  <span class="subsectionToc" >5.7.2 <a 
href="#x1-3270002" id="QQ2-1-333">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.7.3 <a 
href="#x1-3280003" id="QQ2-1-334">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.7.4 <a 
href="#x1-3290004" id="QQ2-1-335">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.7.5 <a 
href="#x1-3320005" id="QQ2-1-338">Device Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.7.6 <a 
href="#x1-3330006" id="QQ2-1-339">Device Operation</a></span>
<br />  <span class="subsectionToc" >5.7.7 <a 
href="#x1-3430007" id="QQ2-1-349">VGA Compatibility</a></span>
<br /> <span class="sectionToc" >5.8 <a 
href="#x1-3440008" id="QQ2-1-350">Input Device</a></span>
<br />  <span class="subsectionToc" >5.8.1 <a 
href="#x1-3450001" id="QQ2-1-351">Device ID</a></span>
<br />  <span class="subsectionToc" >5.8.2 <a 
href="#x1-3460002" id="QQ2-1-352">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.8.3 <a 
href="#x1-3470003" id="QQ2-1-353">Feature bits</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >5.8.4 <a 
href="#x1-3480004" id="QQ2-1-354">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.8.5 <a 
href="#x1-3490005" id="QQ2-1-355">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.8.6 <a 
href="#x1-3520006" id="QQ2-1-358">Device Operation</a></span>
<br /> <span class="sectionToc" >5.9 <a 
href="#x1-3550009" id="QQ2-1-361">Crypto Device</a></span>
<br />  <span class="subsectionToc" >5.9.1 <a 
href="#x1-3560001" id="QQ2-1-362">Device ID</a></span>
<br />  <span class="subsectionToc" >5.9.2 <a 
href="#x1-3570002" id="QQ2-1-363">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.9.3 <a 
href="#x1-3580003" id="QQ2-1-364">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.9.4 <a 
href="#x1-3600004" id="QQ2-1-366">Supported crypto services</a></span>
<br />  <span class="subsectionToc" >5.9.5 <a 
href="#x1-3650005" id="QQ2-1-371">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.9.6 <a 
href="#x1-3680006" id="QQ2-1-374">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.9.7 <a 
href="#x1-3700007" id="QQ2-1-376">Device Operation</a></span>
<br /> <span class="sectionToc" >5.10 <a 
href="#x1-39500010" id="QQ2-1-401">Socket Device</a></span>
<br />  <span class="subsectionToc" >5.10.1 <a 
href="#x1-3960001" id="QQ2-1-402">Device ID</a></span>
<br />  <span class="subsectionToc" >5.10.2 <a 
href="#x1-3970002" id="QQ2-1-403">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.10.3 <a 
href="#x1-3980003" id="QQ2-1-404">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.10.4 <a 
href="#x1-3990004" id="QQ2-1-405">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.10.5 <a 
href="#x1-4000005" id="QQ2-1-406">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.10.6 <a 
href="#x1-4010006" id="QQ2-1-407">Device Operation</a></span>
<br /> <span class="sectionToc" >5.11 <a 
href="#x1-41500011" id="QQ2-1-421">File System Device</a></span>
<br />  <span class="subsectionToc" >5.11.1 <a 
href="#x1-4160001" id="QQ2-1-422">Device ID</a></span>
<br />  <span class="subsectionToc" >5.11.2 <a 
href="#x1-4170002" id="QQ2-1-423">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.11.3 <a 
href="#x1-4180003" id="QQ2-1-424">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.11.4 <a 
href="#x1-4190004" id="QQ2-1-425">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.11.5 <a 
href="#x1-4220005" id="QQ2-1-428">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.11.6 <a 
href="#x1-4230006" id="QQ2-1-429">Device Operation</a></span>
<br /><span class="chapterToc" >6 <a 
href="#x1-4330006" id="QQ2-1-439">Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.1 <a 
href="#x1-4340001" id="QQ2-1-440">Driver Requirements: Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.2 <a 
href="#x1-4350002" id="QQ2-1-441">Device Requirements: Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.3 <a 
href="#x1-4360003" id="QQ2-1-442">Legacy Interface: Reserved Feature Bits</a></span>
<br /><span class="chapterToc" >7 <a 
href="#x1-4370007" id="QQ2-1-443">Conformance</a></span>
<br /> <span class="sectionToc" >7.1 <a 
href="#x1-4380001" id="QQ2-1-444">Conformance Targets</a></span>
                                                                  

                                                                  
<br /> <span class="sectionToc" >7.2 <a 
href="#x1-4390002" id="QQ2-1-445">Clause 1: Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.1 <a 
href="#x1-4400001" id="QQ2-1-446">Clause 2: PCI Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.2 <a 
href="#x1-4410002" id="QQ2-1-447">Clause 3: MMIO Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.3 <a 
href="#x1-4420003" id="QQ2-1-448">Clause 4: Channel I/O Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.4 <a 
href="#x1-4430004" id="QQ2-1-449">Clause 5: Network Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.5 <a 
href="#x1-4440005" id="QQ2-1-450">Clause 6: Block Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.6 <a 
href="#x1-4450006" id="QQ2-1-451">Clause 7: Console Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.7 <a 
href="#x1-4460007" id="QQ2-1-452">Clause 8: Entropy Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.8 <a 
href="#x1-4470008" id="QQ2-1-453">Clause 9: Traditional Memory Balloon Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.9 <a 
href="#x1-4480009" id="QQ2-1-454">Clause 10: SCSI Host Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.10 <a 
href="#x1-44900010" id="QQ2-1-455">Clause 11: Input Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.11 <a 
href="#x1-45000011" id="QQ2-1-456">Clause 12: Crypto Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.12 <a 
href="#x1-45100012" id="QQ2-1-457">Clause 13: Socket Driver Conformance</a></span>
<br /> <span class="sectionToc" >7.3 <a 
href="#x1-4520003" id="QQ2-1-458">Clause 14: Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.1 <a 
href="#x1-4530001" id="QQ2-1-459">Clause 15: PCI Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.2 <a 
href="#x1-4540002" id="QQ2-1-460">Clause 16: MMIO Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.3 <a 
href="#x1-4550003" id="QQ2-1-461">Clause 17: Channel I/O Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.4 <a 
href="#x1-4560004" id="QQ2-1-462">Clause 18: Network Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.5 <a 
href="#x1-4570005" id="QQ2-1-463">Clause 19: Block Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.6 <a 
href="#x1-4580006" id="QQ2-1-464">Clause 20: Console Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.7 <a 
href="#x1-4590007" id="QQ2-1-465">Clause 21: Entropy Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.8 <a 
href="#x1-4600008" id="QQ2-1-466">Clause 22: Traditional Memory Balloon Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.9 <a 
href="#x1-4610009" id="QQ2-1-467">Clause 23: SCSI Host Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.10 <a 
href="#x1-46200010" id="QQ2-1-468">Clause 24: Input Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.11 <a 
href="#x1-46300011" id="QQ2-1-469">Clause 25: Crypto Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.12 <a 
href="#x1-46400012" id="QQ2-1-470">Clause 26: Socket Device Conformance</a></span>
<br /> <span class="sectionToc" >7.4 <a 
href="#x1-4650004" id="QQ2-1-471">Clause 27: Legacy Interface: Transitional Device and Transitional Driver Conformance</a></span>
<br /><span class="appendixToc" >A <a 
href="#x1-466000A" id="QQ2-1-472">virtio_queue.h</a></span>
<br /><span class="appendixToc" >B <a 
href="#x1-467000B" id="QQ2-1-474">Creating New Device Types</a></span>
<br /> <span class="sectionToc" >B.1 <a 
href="#x1-4680001" id="QQ2-1-475">How Many Virtqueues?</a></span>
<br /> <span class="sectionToc" >B.2 <a 
href="#x1-4690002" id="QQ2-1-476">What Device Configuration Space Layout?</a></span>
                                                                  

                                                                  
<br /> <span class="sectionToc" >B.3 <a 
href="#x1-4700003" id="QQ2-1-477">What Device Number?</a></span>
<br /> <span class="sectionToc" >B.4 <a 
href="#x1-4710004" id="QQ2-1-478">How many MSI-X vectors? (for PCI)</a></span>
<br /> <span class="sectionToc" >B.5 <a 
href="#x1-4720005" id="QQ2-1-479">Device Improvements</a></span>
<br /><span class="appendixToc" >C <a 
href="#x1-473000C" id="QQ2-1-480">Acknowledgements</a></span>
<br /><span class="appendixToc" >D <a 
href="#x1-476000D" id="QQ2-1-485">Revision History</a></span>
</div>
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 1--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">1</span> <a 
 id="x1-20001"></a>Introduction</h2>
This document describes the specifications of the “virtio” family of devices. These
devices are found in virtual environments, yet by design they look like physical
devices to the guest within the virtual machine - and this document treats them as
such. This similarity allows the guest to use standard drivers and discovery
mechanisms.
<!--l. 8--><p class="noindent" >The purpose of virtio and this specification is that virtual environments
and guests should have a straightforward, efficient, standard and extensible
mechanism for virtual devices, rather than boutique per-environment or per-OS
mechanisms.
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Straightforward:</span> </dt><dd 
class="description">Virtio devices use normal bus mechanisms of interrupts and
     DMA which should be familiar to any device driver author. There is no
     exotic page-flipping or COW mechanism: it’s just a normal device.<span class="footnote-mark"><a 
href="#fn1x1" id="fn1x1-bk"><sup class="textsuperscript">1</sup></a></span><a 
 id="x1-2001f1"></a>
     </dd><dt class="description">
<span 
class="aebx-10">Efficient:</span> </dt><dd 
class="description">Virtio  devices  consist  of  rings  of  descriptors  for  both  input  and
     output, which are neatly laid out to avoid cache effects from both driver
     and device writing to the same cache lines.
     </dd><dt class="description">
<span 
class="aebx-10">Standard:</span> </dt><dd 
class="description">Virtio makes no assumptions about the environment in which it
     operates, beyond supporting the bus to which device is attached. In this
     specification, virtio devices are implemented over MMIO, Channel I/O and
     PCI bus transports <span class="footnote-mark"><a 
href="#fn2x1" id="fn2x1-bk"><sup class="textsuperscript">2</sup></a></span><a 
 id="x1-2002f2"></a>,
     earlier drafts have been implemented on other buses not included here.
     </dd><dt class="description">
<span 
class="aebx-10">Extensible:</span> </dt><dd 
class="description">Virtio devices contain feature bits which are acknowledged by the
     guest  operating  system  during  device  setup.  This  allows  forwards  and
     backwards compatibility: the device offers all the features it knows about,
     and the driver acknowledges those it understands and wishes to use.</dd></dl>
<a 
 id="x1-2003r1"></a>
<h3 class="sectionHead"><span class="titlemark">1.1   </span> <a 
 id="x1-30001"></a>Normative References</h3>
<a 
 id="x1-3001r1"></a><!--l. 40--><div class="longtable"> <table id="TBL-2" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-2-1g"><col 
id="TBL-2-1"><col 
id="TBL-2-2"></colgroup>
<tr  
 style="vertical-align:baseline;" id="TBL-2-1-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-1-1"  
class="td11"> <a 
 id="likesection.1"></a><span 
class="aebx-10">[RFC2119]              </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-1-2"  
class="td11">
 <!--l. 41--><p class="noindent" >Bradner S., “Key words for use in RFCs to Indicate Requirement Levels”, BCP 14,
  RFC 2119, March 1997. <br 
class="newline" /><a 
href="http://www.ietf.org/rfc/rfc2119.txt" class="url" >http://www.ietf.org/rfc/rfc2119.txt</a>                                                                </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-2-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-2-1"  
class="td11"> <a 
 id="likesection.2"></a><span 
class="aebx-10">[S390 PoP]              </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-2-2"  
class="td11">
 <!--l. 43--><p class="noindent" >z/Architecture Principles of Operation, IBM Publication SA22-7832, <br 
class="newline" /><a 
href="http://publibfi.boulder.ibm.com/epubs/pdf/dz9zr009.pdf" class="url" >http://publibfi.boulder.ibm.com/epubs/pdf/dz9zr009.pdf</a>, and any future revisions  </td>
                                                                  

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-3-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-3-1"  
class="td11"> <a 
 id="likesection.3"></a><span 
class="aebx-10">[S390 Common I/O]  </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-3-2"  
class="td11">
 <!--l. 44--><p class="noindent" >ESA/390 Common I/O-Device and Self-Description, IBM Publication SA22-7204, <br 
class="newline" /><a 
href="http://publibfp.dhe.ibm.com/cgi-bin/bookmgr/BOOKS/dz9ar501/CCONTENTS" class="url" >http://publibfp.dhe.ibm.com/cgi-bin/bookmgr/BOOKS/dz9ar501/CCONTENTS</a>,
  and any future revisions                                                                               </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-4-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-4-1"  
class="td11"> <a 
 id="likesection.4"></a><span 
class="aebx-10">[PCI]                     </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-4-2"  
class="td11">
 <!--l. 46--><p class="noindent" >Conventional PCI Specifications, <br 
class="newline" /><a 
href="http://www.pcisig.com/specifications/conventional/" class="url" >http://www.pcisig.com/specifications/conventional/</a>, PCI-SIG                             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-5-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-5-1"  
class="td11"> <a 
 id="likesection.5"></a><span 
class="aebx-10">[PCIe]                    </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-5-2"  
class="td11">
 <!--l. 50--><p class="noindent" >PCI Express Specifications <br 
class="newline" /><a 
href="http://www.pcisig.com/specifications/pciexpress/" class="url" >http://www.pcisig.com/specifications/pciexpress/</a>, PCI-SIG                                </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-6-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-6-1"  
class="td11"> <a 
 id="likesection.6"></a><span 
class="aebx-10">[IEEE 802]              </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-6-2"  
class="td11">
 <!--l. 54--><p class="noindent" >IEEE  Standard  for  Local  and  Metropolitan  Area  Networks:  Overview  and
  Architecture, <br 
class="newline" /><a 
href="http://www.ieee802.org/" class="url" >http://www.ieee802.org/</a>, IEEE                                                                     </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-7-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-7-1"  
class="td11"> <a 
 id="likesection.7"></a><span 
class="aebx-10">[SAM]                    </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-7-2"  
class="td11">
 <!--l. 58--><p class="noindent" >SCSI Architectural Model, <br 
class="newline" /><a 
href="http://www.t10.org/cgi-bin/ac.pl?t=f&f=sam4r05.pdf" class="url" >http://www.t10.org/cgi-bin/ac.pl?t=f&f=sam4r05.pdf</a>                                       </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-8-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-8-1"  
class="td11"> <a 
 id="likesection.8"></a><span 
class="aebx-10">[SCSI MMC]           </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-8-2"  
class="td11">
 <!--l. 61--><p class="noindent" >SCSI Multimedia Commands, <br 
class="newline" /><a 
href="http://www.t10.org/cgi-bin/ac.pl?t=f&f=mmc6r00.pdf" class="url" >http://www.t10.org/cgi-bin/ac.pl?t=f&f=mmc6r00.pdf</a>                                      </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-9-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-9-1"  
class="td11"> <a 
 id="likesection.9"></a><span 
class="aebx-10">[FUSE]                   </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-9-2"  
class="td11">
 <!--l. 64--><p class="noindent" >Linux FUSE interface, <br 
class="newline" /><a 
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/fuse.h" class="url" >https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/fuse.h</a> </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-10-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-10-1"  
class="td11">                   </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-11-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-11-1"  
class="td11">                   </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-12-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-12-1"  
class="td11">                   </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-13-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-13-1"  
class="td11">                   </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-14-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-14-1"  
class="td11">                      </td><td  style="white-space:wrap; text-align:left;" id="TBL-2-14-2"  
class="td11">
</td></tr>
</table></div>
<a 
 id="x1-3002r3"></a>
<h3 class="sectionHead"><span class="titlemark">1.2   </span> <a 
 id="x1-40002"></a>Non-Normative References</h3>
<a 
 id="x1-4001r2"></a><!--l. 72--><div class="longtable"> <table id="TBL-3" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-3-1g"><col 
id="TBL-3-1"><col 
id="TBL-3-2"></colgroup>
<tr  
 style="vertical-align:baseline;" id="TBL-3-1-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-1-1"  
class="td11"> <a 
 id="likesection.10"></a><span 
class="aebx-10">[Virtio PCI Draft]  </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-3-1-2"  
class="td11">
 <!--l. 73--><p class="noindent" >Virtio PCI Draft Specification <br 
class="newline" /><a 
href="http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf" class="url" >http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf</a>                                          </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-2-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-2-1"  
class="td11">                 </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-3-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-3-1"  
class="td11">                 </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-4-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-4-1"  
class="td11">                 </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-5-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-5-1"  
class="td11">                 </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-6-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-6-1"  
class="td11">                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-3-6-2"  
class="td11">
</td></tr>
</table></div>
<a 
 id="x1-4002r4"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">1.3   </span> <a 
 id="x1-50003"></a>Terminology</h3>
<!--l. 79--><p class="noindent" >The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in
this document are to be interpreted as described in <a 
href="#x1-3001r1">[RFC2119]</a>.
<a 
 id="x1-5001r1"></a>
<h4 class="subsectionHead"><span class="titlemark">1.3.1   </span> <a 
 id="x1-60001"></a>Legacy Interface: Terminology</h4>
<!--l. 84--><p class="noindent" >Specification drafts preceding version 1.0 of this specification (e.g. see <a 
href="#x1-4001r2">[Virtio PCI
Draft]</a>) defined a similar, but different interface between the driver and the device.
Since these are widely deployed, this specification accommodates OPTIONAL
features to simplify transition from these earlier draft interfaces.
<!--l. 92--><p class="noindent" >Specifically devices and drivers MAY support:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Legacy Interface</span> </dt><dd 
class="description">is  an  interface  specified  by  an  earlier  draft  of  this
     specification (before 1.0)
     </dd><dt class="description">
<span 
class="aebx-10">Legacy Device</span> </dt><dd 
class="description">is a device implemented before this specification was released,
     and implementing a legacy interface on the host side
     </dd><dt class="description">
<span 
class="aebx-10">Legacy Driver</span> </dt><dd 
class="description">is a driver implemented before this specification was released,
     and implementing a legacy interface on the guest side</dd></dl>
<!--l. 105--><p class="noindent" >Legacy devices and legacy drivers are not compliant with this specification.
<!--l. 108--><p class="noindent" >To simplify transition from these earlier draft interfaces, a device MAY implement:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Transitional Device</span> </dt><dd 
class="description">a  device  supporting  both  drivers  conforming  to  this
     specification, and allowing legacy drivers.</dd></dl>
<!--l. 117--><p class="noindent" >Similarly, a driver MAY implement:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Transitional Driver</span> </dt><dd 
class="description">a  driver  supporting  both  devices  conforming  to  this
     specification, and legacy devices.</dd></dl>
<span 
class="aebx-10">Note:</span> Legacy interfaces are not required; ie. don’t implement them unless you
      have a need for backwards compatibility!
<!--l. 129--><p class="noindent" >Devices or drivers with no legacy compatibility are referred to as non-transitional
devices and drivers, respectively.
<a 
 id="x1-6001r6"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">1.3.2   </span> <a 
 id="x1-70002"></a>Transition from earlier specification drafts</h4>
<!--l. 134--><p class="noindent" >For devices and drivers already implementing the legacy interface, some changes will
have to be made to support this specification.
<!--l. 138--><p class="noindent" >In this case, it might be beneficial for the reader to focus on sections tagged "Legacy
Interface" in the section title. These highlight the changes made since the earlier
drafts.
<a 
 id="x1-7001r5"></a>
<h3 class="sectionHead"><span class="titlemark">1.4   </span> <a 
 id="x1-80004"></a>Structure Specifications</h3>
<!--l. 144--><p class="noindent" >Many device and driver in-memory structure layouts are documented using the C
struct syntax. All structures are assumed to be without additional padding.
To stress this, cases where common C compilers are known to insert extra
padding within structures are tagged using the GNU C __attribute__((packed))
syntax.
<!--l. 150--><p class="noindent" >For the integer data types used in the structure definitions, the following conventions
are used:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">u8, u16, u32, u64</span> </dt><dd 
class="description">An unsigned integer of the specified length in bits.
     </dd><dt class="description">
<span 
class="aebx-10">le16, le32, le64</span> </dt><dd 
class="description">An  unsigned  integer  of  the  specified  length  in  bits,  in
     little-endian byte order.
     </dd><dt class="description">
<span 
class="aebx-10">be16, be32, be64</span> </dt><dd 
class="description">An  unsigned  integer  of  the  specified  length  in  bits,  in
     big-endian byte order.</dd></dl>
<!--l. 163--><p class="noindent" >Some of the fields to be defined in this specification don’t start or don’t end on a byte
boundary. Such fields are called bit-fields. A set of bit-fields is always a sub-division
of an integer typed field.
<!--l. 167--><p class="noindent" >Bit-fields within integer fields are always listed in order, from the least significant
to the most significant bit. The bit-fields are considered unsigned integers
of the specified width with the next in significance relationship of the bits
preserved.
<!--l. 173--><p class="noindent" >For example: <!--l. 174-->
<div class="lstlisting" id="listing-1"><span class="label"><a 
 id="x1-8001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">S</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">B</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">y</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 183--><p class="noindent" >documents the value A stored in the low 15 bit of <span 
class="aeti-10">x </span>and the value B stored in the
high bit of <span 
class="aeti-10">x</span>, the 16-bit integer <span 
class="aeti-10">x </span>in turn stored using the big-endian byte order at
the beginning of the structure S, and being followed immediately by an unsigned
                                                                  

                                                                  
integer <span 
class="aeti-10">y </span>stored in big-endian byte order at an offset of 2 bytes (16 bits) from the
beginning of the structure.
<!--l. 191--><p class="noindent" >Note that this notation somewhat resembles the C bitfield syntax but should not be
naively converted to a bitfield notation for portable code: it matches the way bitfields
are packed by C compilers on little-endian architectures but not the way bitfields are
packed by C compilers on big-endian architectures.
<!--l. 197--><p class="noindent" >Assuming that CPU_TO_BE16 converts a 16-bit integer from a native CPU to the
big-endian byte order, the following is the equivalent portable C code to generate a
value to be stored into <span 
class="aeti-10">x</span>: <!--l. 200-->
<div class="lstlisting" id="listing-2"><span class="label"><a 
 id="x1-8008r1"></a></span><span 
class="pcrr8t-x-x-80">CPU_TO_BE16</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">B</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><<</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80">)</span>
</div>
<!--l. 204--><p class="noindent" >
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 1--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">2</span> <a 
 id="x1-90002"></a>Basic Facilities of a Virtio Device</h2>
A virtio device is discovered and identified by a bus-specific method (see
the bus specific sections: <a 
href="#x1-1030001">4.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus --></a> <a 
href="#x1-1030001">Virtio Over PCI Bus<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus --></a>, <a 
href="#x1-1490002">4.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO --></a> <a 
href="#x1-1490002">Virtio Over MMIO<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO --></a>
and <a 
href="#x1-1620003">4.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over Channel I/O --></a> <a 
href="#x1-1620003">Virtio Over Channel I/O<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over Channel I/O --></a>). Each device consists of the following
parts:
     <ul class="itemize1">
     <li class="itemize">Device status field
     </li>
     <li class="itemize">Feature bits
     </li>
     <li class="itemize">Notifications
     </li>
     <li class="itemize">Device Configuration space
     </li>
     <li class="itemize">One or more virtqueues</li></ul>
<a 
 id="x1-9001r8"></a>
<h3 class="sectionHead"><span class="titlemark">2.1   </span> <a 
 id="x1-100001"></a><span 
class="aeti-10">Device Status </span>Field</h3>
<!--l. 17--><p class="noindent" >During device initialization by a driver, the driver follows the sequence of steps
specified in <a 
href="#x1-950001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.
<!--l. 22--><p class="noindent" >The <span 
class="aeti-10">device status </span>field provides a simple low-level indication of the completed steps of
this sequence. It’s most useful to imagine it hooked up to traffic lights on the console
indicating the status of each device. The following bits are defined (listed below in
the order in which they would be typically set):
     <dl class="description"><dt class="description">
<span 
class="aebx-10">ACKNOWLEDGE (1)</span> </dt><dd 
class="description">Indicates that the guest OS has found the device and
     recognized it as a valid virtio device.
     </dd><dt class="description">
<span 
class="aebx-10">DRIVER (2)</span> </dt><dd 
class="description">Indicates that the guest OS knows how to drive the device.
     <span 
class="aebx-10">Note:</span> There could be a significant (or infinite) delay before setting this
           bit. For example, under Linux, drivers can be loadable modules.
     </dd><dt class="description">
<span 
class="aebx-10">FAILED (128)</span> </dt><dd 
class="description">Indicates that something went wrong in the guest, and it has given
     up on the device. This could be an internal error, or the driver didn’t
     like the device for some reason, or even a fatal error during device
     operation.
     </dd><dt class="description">
<span 
class="aebx-10">FEATURES_OK (8)</span> </dt><dd 
class="description">Indicates that the driver has acknowledged all the features it
                                                                  

                                                                  
     understands, and feature negotiation is complete.
     </dd><dt class="description">
<span 
class="aebx-10">DRIVER_OK (4)</span> </dt><dd 
class="description">Indicates that the driver is set up and ready to drive the
     device.
     </dd><dt class="description">
<span 
class="aebx-10">DEVICE_NEEDS_RESET (64)</span> </dt><dd 
class="description">Indicates that the device has experienced an
     error from which it can’t recover.</dd></dl>
<a 
 id="x1-10001r7"></a>
<h4 class="subsectionHead"><span class="titlemark">2.1.1   </span> <a 
 id="x1-110001"></a>Driver Requirements: Device Status Field</h4>
<!--l. 55--><p class="noindent" >The driver MUST update <span 
class="aeti-10">device status</span>, setting bits to indicate the completed steps of
the driver initialization sequence specified in <a 
href="#x1-950001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>. The driver MUST NOT clear a
<span 
class="aeti-10">device status </span>bit. If the driver sets the FAILED bit, the driver MUST later reset the
device before attempting to re-initialize.
<!--l. 64--><p class="noindent" >The driver SHOULD NOT rely on completion of operations of a device if
DEVICE_NEEDS_RESET is set.
<span 
class="aebx-10">Note:</span> For example, the driver can’t assume requests in flight will be completed
      if DEVICE_NEEDS_RESET is set, nor can it assume that they have not
      been completed. A good implementation will try to recover by issuing a
      reset.
<a 
 id="x1-11001r11"></a>
<h4 class="subsectionHead"><span class="titlemark">2.1.2   </span> <a 
 id="x1-120002"></a>Device Requirements: Device Status Field</h4>
<!--l. 74--><p class="noindent" >The device MUST initialize <span 
class="aeti-10">device status </span>to 0 upon reset.
<!--l. 76--><p class="noindent" >The device MUST NOT consume buffers or send any used buffer notifications to the
driver before DRIVER_OK.
<!--l. 79--><p class="noindent" >The device SHOULD set DEVICE_NEEDS_RESET when it enters an error state
that a reset is needed. If DRIVER_OK is set, after it sets DEVICE_NEEDS_RESET,
the device MUST send a device configuration change notification to the
driver.
<a 
 id="x1-12001r10"></a>
<h3 class="sectionHead"><span class="titlemark">2.2   </span> <a 
 id="x1-130002"></a>Feature Bits</h3>
<!--l. 85--><p class="noindent" >Each virtio device offers all the features it understands. During device initialization,
the driver reads this and tells the device the subset that it accepts. The only way to
renegotiate is to reset the device.
<!--l. 90--><p class="noindent" >This allows for forwards and backwards compatibility: if the device is enhanced with
a new feature bit, older drivers will not write that feature bit back to the device.
Similarly, if a driver is enhanced with a feature that the device doesn’t support, it see
                                                                  

                                                                  
the new feature is not offered.
<!--l. 95--><p class="noindent" >Feature bits are allocated as follows:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">0 to 23</span> </dt><dd 
class="description">Feature bits for the specific device type
     </dd><dt class="description">
<span 
class="aebx-10">24 to 37</span> </dt><dd 
class="description">Feature  bits  reserved  for  extensions  to  the  queue  and  feature
     negotiation mechanisms
     </dd><dt class="description">
<span 
class="aebx-10">38 and above</span> </dt><dd 
class="description">Feature bits reserved for future extensions.</dd></dl>
<span 
class="aebx-10">Note:</span> For example, feature bit 0 for a network device (i.e. Device ID 1) indicates
      that the device supports checksumming of packets.
<!--l. 112--><p class="noindent" >In particular, new fields in the device configuration space are indicated by offering a
new feature bit.
<a 
 id="x1-13001r12"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.1   </span> <a 
 id="x1-140001"></a>Driver Requirements: Feature Bits</h4>
<!--l. 116--><p class="noindent" >The driver MUST NOT accept a feature which the device did not offer, and
MUST NOT accept a feature which requires another feature which was not
accepted.
<!--l. 120--><p class="noindent" >The driver SHOULD go into backwards compatibility mode if the device does not
offer a feature it understands, otherwise MUST set the FAILED <span 
class="aeti-10">device status </span>bit and
cease initialization.
<a 
 id="x1-14001r14"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.2   </span> <a 
 id="x1-150002"></a>Device Requirements: Feature Bits</h4>
<!--l. 125--><p class="noindent" >The device MUST NOT offer a feature which requires another feature which was not
offered. The device SHOULD accept any valid subset of features the driver accepts,
otherwise it MUST fail to set the FEATURES_OK <span 
class="aeti-10">device status </span>bit when the driver
writes it.
<!--l. 130--><p class="noindent" >If a device has successfully negotiated a set of features at least once (by accepting the
FEATURES_OK <span 
class="aeti-10">device status </span>bit during device initialization), then it SHOULD
NOT fail re-negotiation of the same set of features after a device or system
reset. Failure to do so would interfere with resuming from suspend and error
recovery.
<a 
 id="x1-15001r15"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.3   </span> <a 
 id="x1-160003"></a>Legacy Interface: A Note on Feature Bits</h4>
<!--l. 141--><p class="noindent" >Transitional Drivers MUST detect Legacy Devices by detecting that the feature bit
VIRTIO_F_VERSION_1 is not offered. Transitional devices MUST detect Legacy
                                                                  

                                                                  
drivers by detecting that VIRTIO_F_VERSION_1 has not been acknowledged by the
driver.
<!--l. 146--><p class="noindent" >In this case device is used through the legacy interface.
<!--l. 148--><p class="noindent" >Legacy interface support is OPTIONAL. Thus, both transitional and non-transitional
devices and drivers are compliant with this specification.
<!--l. 152--><p class="noindent" >Requirements pertaining to transitional devices and drivers is contained in sections
named ’Legacy Interface’ like this one.
<!--l. 155--><p class="noindent" >When device is used through the legacy interface, transitional devices and
transitional drivers MUST operate according to the requirements documented within
these legacy interface sections. Specification text within these sections generally does
not apply to non-transitional devices.
<a 
 id="x1-16001r13"></a>
<h3 class="sectionHead"><span class="titlemark">2.3   </span> <a 
 id="x1-170003"></a>Notifications</h3>
<!--l. 164--><p class="noindent" >The notion of sending a notification (driver to device or device to driver) plays an
important role in this specification. The modus operandi of the notifications is
transport specific.
<!--l. 168--><p class="noindent" >There are three types of notifications:
     <ul class="itemize1">
     <li class="itemize">configuration change notification
     </li>
     <li class="itemize">available buffer notification
     </li>
     <li class="itemize">used buffer notification.</li></ul>
<!--l. 175--><p class="noindent" >Configuration change notifications and used buffer notifications are sent by the
device, the recipient is the driver. A configuration change notification indicates that
the device configuration space has changed; a used buffer notification indicates
that a buffer may have been made used on the virtqueue designated by the
notification.
<!--l. 181--><p class="noindent" >Available buffer notifications are sent by the driver, the recipient is the device. This
type of notification indicates that a buffer may have been made available on the
virtqueue designated by the notification.
<!--l. 185--><p class="noindent" >The semantics, the transport-specific implementations, and other important
aspects of the different notifications are specified in detail in the following
chapters.
<!--l. 189--><p class="noindent" >Most transports implement notifications sent by the device to the driver using
interrupts. Therefore, in previous versions of this specification, these notifications
were often called interrupts. Some names defined in this specification still retain this
interrupt terminology. Occasionally, the term event is used to refer to a notification
                                                                  

                                                                  
or a receipt of a notification.
<a 
 id="x1-17001r17"></a>
<h3 class="sectionHead"><span class="titlemark">2.4   </span> <a 
 id="x1-180004"></a>Device Configuration Space</h3>
<!--l. 198--><p class="noindent" >Device configuration space is generally used for rarely-changing or initialization-time
parameters. Where configuration fields are optional, their existence is indicated by
feature bits: Future versions of this specification will likely extend the device
configuration space by adding extra fields at the tail.
<span 
class="aebx-10">Note:</span> The  device  configuration  space  uses  the  little-endian  format  for
      multi-byte fields.
<!--l. 209--><p class="noindent" >Each transport also provides a generation count for the device configuration space,
which will change whenever there is a possibility that two accesses to the device
configuration space can see different versions of that space.
<a 
 id="x1-18001r16"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.1   </span> <a 
 id="x1-190001"></a>Driver Requirements: Device Configuration Space</h4>
<!--l. 215--><p class="noindent" >Drivers MUST NOT assume reads from fields greater than 32 bits wide are atomic,
nor are reads from multiple fields: drivers SHOULD read device configuration space
fields like so:
<!--l. 219-->
<div class="lstlisting" id="listing-3"><span class="label"><a 
 id="x1-19001r1"></a></span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-19002r2"></a></span><span 
class="pcrr8t-x-x-80">do</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-19003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_config_generation</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-19004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">entry</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-19005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_config_generation</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-19006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">while</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 228--><p class="noindent" >For optional configuration space fields, the driver MUST check that the
corresponding feature is offered before accessing that part of the configuration
space.
<span 
class="aebx-10">Note:</span> See section <a 
href="#x1-950001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> for details on feature negotiation.
<!--l. 235--><p class="noindent" >Drivers MUST NOT limit structure size and device configuration space size. Instead,
drivers SHOULD only check that device configuration space is <span 
class="aeti-10">large enough </span>to
contain the fields necessary for device operation.
<span 
class="aebx-10">Note:</span> For example, if the specification states that device configuration space
      ’includes a single 8-bit field’ drivers should understand this to mean that
      the device configuration space might also include an arbitrary amount
      of tail padding, and accept any device configuration space size equal to
      or greater than the specified 8-bit size.
<a 
 id="x1-19007r19"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">2.4.2   </span> <a 
 id="x1-200002"></a>Device Requirements: Device Configuration Space</h4>
<!--l. 249--><p class="noindent" >The device MUST allow reading of any device-specific configuration field
before FEATURES_OK is set by the driver. This includes fields which are
conditional on feature bits, as long as those feature bits are offered by the
device.
<a 
 id="x1-20001r20"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.3   </span> <a 
 id="x1-210003"></a>Legacy Interface: A Note on Device Configuration Space endian-ness</h4>
<!--l. 256--><p class="noindent" >Note that for legacy interfaces, device configuration space is generally the guest’s
native endian, rather than PCI’s little-endian. The correct endian-ness is documented
for each device.
<a 
 id="x1-21001r21"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.4   </span> <a 
 id="x1-220004"></a>Legacy Interface: Device Configuration Space</h4>
<!--l. 262--><p class="noindent" >Legacy devices did not have a configuration generation field, thus are susceptible to
race conditions if configuration is updated. This affects the block <span 
class="aeti-10">capacity </span>(see <a 
href="#x1-2490004">5.2.4<!--tex4ht:ref: sec:Device Types / Block Device / Device configuration layout --></a>)
and network <span 
class="aeti-10">mac </span>(see <a 
href="#x1-2050004">5.1.4<!--tex4ht:ref: sec:Device Types / Network Device / Device configuration layout --></a>) fields; when using the legacy interface, drivers
SHOULD read these fields multiple times until two reads generate a consistent
result.
<a 
 id="x1-22001r18"></a>
<h3 class="sectionHead"><span class="titlemark">2.5   </span> <a 
 id="x1-230005"></a>Virtqueues</h3>
<!--l. 274--><p class="noindent" >The mechanism for bulk data transport on virtio devices is
pretentiously called a virtqueue. Each device can have zero or more
virtqueues<span class="footnote-mark"><a 
href="#fn3x2" id="fn3x2-bk"><sup class="textsuperscript">3</sup></a></span><a 
 id="x1-23001f3"></a>.
<!--l. 279--><p class="noindent" >Driver makes requests available to device by adding an available buffer to the queue,
i.e., adding a buffer describing the request to a virtqueue, and optionally
triggering a driver event, i.e., sending an available buffer notification to the
device.
<!--l. 285--><p class="noindent" >Device executes the requests and - when complete - adds a used buffer to
the queue, i.e., lets the driver know by marking the buffer as used. Device
can then trigger a device event, i.e., send a used buffer notification to the
driver.
<!--l. 290--><p class="noindent" >Device reports the number of bytes it has written to memory for each buffer it uses.
This is referred to as “used length”.
<!--l. 293--><p class="noindent" >Device is not generally required to use buffers in the same order in which they have
been made available by the driver.
<!--l. 297--><p class="noindent" >Some devices always use descriptors in the same order in which they have been made
available. These devices can offer the VIRTIO_F_IN_ORDER feature. If negotiated,
this knowledge might allow optimizations or simplify driver and/or device
                                                                  

                                                                  
code.
<!--l. 302--><p class="noindent" >Each virtqueue can consist of up to 3 parts:
     <ul class="itemize1">
     <li class="itemize">Descriptor Area - used for describing buffers
     </li>
     <li class="itemize">Driver Area - extra data supplied by driver to the device
     </li>
     <li class="itemize">Device Area - extra data supplied by device to driver</li></ul>
<span 
class="aebx-10">Note:</span> Note that previous versions of this spec used different names for these parts
      (following <a 
href="#x1-240006">2.6<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Split Virtqueues --></a>):
          <ul class="itemize1">
          <li class="itemize">Descriptor Table - for the Descriptor Area
          </li>
          <li class="itemize">Available Ring - for the Driver Area
          </li>
          <li class="itemize">Used Ring - for the Device Area</li></ul>
<!--l. 320--><p class="noindent" >Two formats are supported: Split Virtqueues (see <a 
href="#x1-240006">2.6<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Split Virtqueues --></a> <a 
href="#x1-240006">Split Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Split Virtqueues --></a>) and Packed
Virtqueues (see <a 
href="#x1-610007">2.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues --></a> <a 
href="#x1-610007">Packed Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues --></a>).
<!--l. 328--><p class="noindent" >Every driver and device supports either the Packed or the Split Virtqueue format, or
both.
<a 
 id="x1-23002r23"></a>
<h3 class="sectionHead"><span class="titlemark">2.6   </span> <a 
 id="x1-240006"></a>Split Virtqueues</h3>
<!--l. 2--><p class="noindent" >The split virtqueue format was the only format supported by the version 1.0 (and
earlier) of this standard.
<!--l. 5--><p class="noindent" >The split virtqueue format separates the virtqueue into several parts, where each part
is write-able by either the driver or the device, but not both. Multiple parts and/or
locations within a part need to be updated when making a buffer available and when
marking it as used.
<!--l. 11--><p class="noindent" >Each queue has a 16-bit queue size parameter, which sets the number of entries and
implies the total size of the queue.
<!--l. 15--><p class="noindent" >Each virtqueue consists of three parts:
     <ul class="itemize1">
     <li class="itemize">Descriptor Table - occupies the Descriptor Area
     </li>
     <li class="itemize">Available Ring - occupies the Driver Area
                                                                  

                                                                  
     </li>
     <li class="itemize">Used Ring - occupies the Device Area</li></ul>
<!--l. 23--><p class="noindent" >where each part is physically-contiguous in guest memory, and has different
alignment requirements.
<!--l. 26--><p class="noindent" >The memory alignment and size requirements, in bytes, of each part of the virtqueue
are summarized in the following table:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtqueue Part    </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Alignment  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Size                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Descriptor Table  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16            </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">16</span><span 
class="cmsy-10">∗</span>(Queue Size)     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Available Ring    </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">6 + 2</span><span 
class="cmsy-10">∗</span>(Queue Size)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Used Ring          </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">6 + 8</span><span 
class="cmsy-10">∗</span>(Queue Size)  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 41--><p class="noindent" >The Alignment column gives the minimum alignment for each part of the
virtqueue.
<!--l. 44--><p class="noindent" >The Size column gives the total number of bytes for each part of the virtqueue.
<!--l. 47--><p class="noindent" >Queue Size corresponds to the maximum number of buffers in the
virtqueue<span class="footnote-mark"><a 
href="#fn4x2" id="fn4x2-bk"><sup class="textsuperscript">4</sup></a></span><a 
 id="x1-24001f4"></a>.
Queue Size value is always a power of 2. The maximum Queue Size value is 32768.
This value is specified in a bus-specific way.
<!--l. 53--><p class="noindent" >When the driver wants to send a buffer to the device, it fills in a slot in the descriptor
table (or chains several together), and writes the descriptor index into the
available ring. It then notifies the device. When the device has finished a buffer,
it writes the descriptor index into the used ring, and sends a used buffer
notification.
<a 
 id="x1-24002r22"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.1   </span> <a 
 id="x1-250001"></a>Driver Requirements: Virtqueues</h4>
<!--l. 61--><p class="noindent" >The driver MUST ensure that the physical address of the first byte of each
virtqueue part is a multiple of the specified alignment value in the above
table.
<a 
 id="x1-25001r25"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.2   </span> <a 
 id="x1-260002"></a>Legacy Interfaces: A Note on Virtqueue Layout</h4>
<!--l. 67--><p class="noindent" >For Legacy Interfaces, several additional restrictions are placed on the virtqueue
layout:
<!--l. 70--><p class="noindent" >Each virtqueue occupies two or more physically-contiguous pages (usually defined as
4096 bytes, but depending on the transport; henceforth referred to as Queue Align)
and consists of three parts:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Descriptor Table  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Available Ring (…padding…)  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Used Ring  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
</div>
<!--l. 81--><p class="noindent" >The bus-specific Queue Size field controls the total number of bytes for the virtqueue.
                                                                  

                                                                  
When using the legacy interface, the transitional driver MUST retrieve the Queue
Size field from the device and MUST allocate the total number of bytes for the
virtqueue according to the following formula (Queue Align given in qalign and Queue
Size given in qsz):
<!--l. 89-->
<div class="lstlisting" id="listing-4"><span class="label"><a 
 id="x1-26001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(((</span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qalign</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">qalign</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26002r2"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_size</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26003r3"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">u16</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*(3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">u16</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<!--l. 98--><p class="noindent" >This wastes some space with padding. When using the legacy interface, both
transitional devices and drivers MUST use the following virtqueue layout structure to
locate elements of the virtqueue:
<!--l. 103-->
<div class="lstlisting" id="listing-5"><span class="label"><a 
 id="x1-26007r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26008r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26009r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26010r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26011r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">running</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26012r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26013r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26014r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Align</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">boundary</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26015r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26016r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26017r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">running</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26018r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-26019r13"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-26020r26"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.3   </span> <a 
 id="x1-270003"></a>Legacy Interfaces: A Note on Virtqueue Endianness</h4>
<!--l. 121--><p class="noindent" >Note that when using the legacy interface, transitional devices and drivers
MUST use the native endian of the guest as the endian of fields and in the
virtqueue. This is opposed to little-endian for non-legacy interface as specified
by this standard. It is assumed that the host is already aware of the guest
endian.
<a 
 id="x1-27001r27"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.4   </span> <a 
 id="x1-280004"></a>Message Framing</h4>
<!--l. 129--><p class="noindent" >The framing of messages with descriptors is independent of the contents of the
buffers. For example, a network transmit buffer consists of a 12 byte header followed
by the network packet. This could be most simply placed in the descriptor table as a
12 byte output descriptor followed by a 1514 byte output descriptor, but it could also
consist of a single 1526 byte output descriptor in the case where the header and
packet are adjacent, or even three or more descriptors (possibly with loss of efficiency
in that case).
<!--l. 138--><p class="noindent" >Note that, some device implementations have large-but-reasonable restrictions on
total descriptor size (such as based on IOV_MAX in the host OS). This has not been
a problem in practice: little sympathy will be given to drivers which create
unreasonably-sized descriptors such as by dividing a network packet into 1500
single-byte descriptors!
<a 
 id="x1-28001r1"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.6.4.1   </span> <a 
 id="x1-290001"></a>Device Requirements: Message Framing</h5>
<!--l. 146--><p class="noindent" >The device MUST NOT make assumptions about the particular arrangement of
descriptors. The device MAY have a reasonable limit of descriptors it will allow in a
chain.
<a 
 id="x1-29001r29"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.4.2   </span> <a 
 id="x1-300002"></a>Driver Requirements: Message Framing</h5>
<!--l. 151--><p class="noindent" >The driver MUST place any device-writable descriptor elements after any
device-readable descriptor elements.
<!--l. 154--><p class="noindent" >The driver SHOULD NOT use an excessive number of descriptors to describe a
buffer.
<a 
 id="x1-30001r30"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.4.3   </span> <a 
 id="x1-310003"></a>Legacy Interface: Message Framing</h5>
<!--l. 159--><p class="noindent" >Regrettably, initial driver implementations used simple layouts, and devices came to
rely on it, despite this specification wording. In addition, the specification for
virtio_blk SCSI commands required intuiting field lengths from frame boundaries (see
<a 
href="#x1-2580003">5.2.6.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a> <a 
href="#x1-2580003">Legacy Interface: Device Operation<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a>)
<!--l. 165--><p class="noindent" >Thus when using the legacy interface, the VIRTIO_F_ANY_LAYOUT feature
indicates to both the device and the driver that no assumptions were made about
framing. Requirements for transitional drivers when this is not negotiated are
included in each device section.
<a 
 id="x1-31001r28"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.5   </span> <a 
 id="x1-320005"></a>The Virtqueue Descriptor Table</h4>
<!--l. 173--><p class="noindent" >The descriptor table refers to the buffers the driver is using for the device. <span 
class="aeti-10">addr </span>is a
physical address, and the buffers can be chained via <span 
class="aeti-10">next</span>. Each descriptor describes a
buffer which is read-only for the device (“device-readable”) or write-only for the
device (“device-writable”), but a chain of descriptors can contain both device-readable
and device-writable buffers.
<!--l. 179--><p class="noindent" >The actual contents of the memory offered to the device depends on the device type.
Most common is to begin the data with a header (containing little-endian fields)
for the device to read, and postfix it with a status tailer for the device to
write.
<!--l. 184-->
<div class="lstlisting" id="listing-6"><span class="label"><a 
 id="x1-32001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32007r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">continuing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32009r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">otherwise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32011r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">means</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contains</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_INDIRECT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-32017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 204--><p class="noindent" >The number of descriptors in the table is defined by the queue size for this virtqueue:
this is the maximum possible descriptor chain length.
                                                                  

                                                                  
<!--l. 207--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, driver uses descriptors in ring order:
starting from offset 0 in the table, and wrapping around at the end of the
table.
<span 
class="aebx-10">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to this structure as vring_desc,
      and the constants as VRING_DESC_F_NEXT, etc, but the layout and
      values were identical.
<a 
 id="x1-32018r31"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.5.1   </span> <a 
 id="x1-330001"></a>Device Requirements: The Virtqueue Descriptor Table</h5>
<!--l. 218--><p class="noindent" >A device MUST NOT write to a device-readable buffer, and a device SHOULD NOT
read a device-writable buffer (it MAY do so for debugging or diagnostic
purposes).
<a 
 id="x1-33001r33"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.5.2   </span> <a 
 id="x1-340002"></a>Driver Requirements: The Virtqueue Descriptor Table</h5>
<!--l. 223--><p class="noindent" >Drivers MUST NOT add a descriptor chain longer than <span 
class="cmr-10">2</span><sup><span 
class="cmr-7">32</span></sup> bytes in total; this
implies that loops in the descriptor chain are forbidden!
<!--l. 226--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, and when making a descriptor with
VRING_DESC_F_NEXT set in <span 
class="aeti-10">flags </span>at offset <span 
class="cmmi-10">x </span>in the table available to the
device, driver MUST set <span 
class="aeti-10">next </span>to <span 
class="cmr-10">0 </span>for the last descriptor in the table (where
<span 
class="cmmi-10">x </span><span 
class="cmr-10">= </span><span 
class="cmmi-10">queue</span>_<span 
class="cmmi-10">size </span><span 
class="cmsy-10">− </span><span 
class="cmr-10">1</span>) and to <span 
class="cmmi-10">x </span><span 
class="cmr-10">+ 1 </span>for the rest of the descriptors.
<a 
 id="x1-34001r34"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.5.3   </span> <a 
 id="x1-350003"></a>Indirect Descriptors</h5>
<!--l. 234--><p class="noindent" >Some devices benefit by concurrently dispatching a large number of large requests.
The VIRTIO_F_INDIRECT_DESC feature allows this (see <a 
href="#x1-466000A">A<!--tex4ht:ref: sec:virtio-queue.h --></a> <a 
href="#x1-466000A">virtio_queue.h<!--tex4ht:ref: sec:virtio-queue.h --></a>). To
increase ring capacity the driver can store a table of indirect descriptors
anywhere in memory, and insert a descriptor in main virtqueue (with
<span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_INDIRECT on) that refers to memory buffer containing this
indirect descriptor table; <span 
class="aeti-10">addr </span>and <span 
class="aeti-10">len </span>refer to the indirect table address and length
in bytes, respectively.
<!--l. 243--><p class="noindent" >The indirect table layout structure looks like this (<span 
class="aeti-10">len </span>is the length of the
descriptor that refers to this table, which is a variable, so this code won’t
compile):
<!--l. 247-->
<div class="lstlisting" id="listing-7"><span class="label"><a 
 id="x1-35001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indirect_descriptor_table</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-35002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-35003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-35004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 254--><p class="noindent" >The first indirect descriptor is located at start of the indirect descriptor table (index
                                                                  

                                                                  
0), additional indirect descriptors are chained by <span 
class="aeti-10">next</span>. An indirect descriptor without
a valid <span 
class="aeti-10">next </span>(with <span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_NEXT off) signals the end of the
descriptor. A single indirect descriptor table can include both device-readable and
device-writable descriptors.
<!--l. 261--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, indirect descriptors use sequential
indices, in-order: index 0 followed by index 1 followed by index 2, etc.
<a 
 id="x1-35005r1"></a>
<h5 class="paragraphHead"><span class="titlemark">2.6.5.3.1</span> <a 
 id="x1-360001"></a>Driver Requirements: Indirect Descriptors</h5>
The driver MUST NOT set the VIRTQ_DESC_F_INDIRECT flag unless the
VIRTIO_F_INDIRECT_DESC feature was negotiated. The driver MUST NOT set
the VIRTQ_DESC_F_INDIRECT flag within an indirect descriptor (ie. only one table
per descriptor).
<!--l. 271--><p class="noindent" >A driver MUST NOT create a descriptor chain longer than the Queue Size of the
device.
<!--l. 274--><p class="noindent" >A driver MUST NOT set both VIRTQ_DESC_F_INDIRECT and VIRTQ_DESC_F_NEXT
in <span 
class="aeti-10">flags</span>.
<!--l. 277--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, indirect descriptors MUST appear
sequentially, with <span 
class="aeti-10">next </span>taking the value of 1 for the 1st descriptor, 2 for the 2nd one,
etc.
<a 
 id="x1-36001r36"></a>
<h5 class="paragraphHead"><span class="titlemark">2.6.5.3.2</span> <a 
 id="x1-370002"></a>Device Requirements: Indirect Descriptors</h5>
The device MUST ignore the write-only flag (<span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_WRITE) in the
descriptor that refers to an indirect table.
<!--l. 284--><p class="noindent" >The device MUST handle the case of zero or more normal chained descriptors
followed by a single descriptor with <span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_INDIRECT.
<span 
class="aebx-10">Note:</span> While unusual (most implementations either create a chain solely using
      non-indirect descriptors, or use a single indirect element), such a layout
      is valid.
<a 
 id="x1-37001r32"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.6   </span> <a 
 id="x1-380006"></a>The Virtqueue Available Ring</h4>
<!--l. 295--><p class="noindent" >The available ring has the following layout structure:
<!--l. 297-->
<div class="lstlisting" id="listing-8"><span class="label"><a 
 id="x1-38001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-38002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_AVAIL_F_NO_INTERRUPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-38003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-38004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-38005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-38006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-38007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
                                                                  

                                                                  
<!--l. 307--><p class="noindent" >The driver uses the available ring to offer buffers to the device: each ring entry refers
to the head of a descriptor chain. It is only written by the driver and read by the
device.
<!--l. 311--><p class="noindent" ><span 
class="aeti-10">idx </span>field indicates where the driver would put the next descriptor entry in the ring
(modulo the queue size). This starts at 0, and increases.
<span 
class="aebx-10">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to this structure as vring_avail,
      and  the  constant  as  VRING_AVAIL_F_NO_INTERRUPT,  but  the
      layout and value were identical.
<a 
 id="x1-38008r35"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.6.1   </span> <a 
 id="x1-390001"></a>Driver Requirements: The Virtqueue Available Ring</h5>
<!--l. 321--><p class="noindent" >A driver MUST NOT decrement the available <span 
class="aeti-10">idx </span>on a virtqueue (ie. there is no way
to “unexpose” buffers).
<a 
 id="x1-39001r38"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.7   </span> <a 
 id="x1-400007"></a>Used Buffer Notification Suppression</h4>
<!--l. 327--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated, the <span 
class="aeti-10">flags </span>field in the
available ring offers a crude mechanism for the driver to inform the device that it
doesn’t want notifications when buffers are used. Otherwise <span 
class="aeti-10">used_event </span>is a more
performant alternative where the driver specifies how far the device can progress
before a notification is required.
<!--l. 334--><p class="noindent" >Neither of these notification suppression methods are reliable, as they are not
synchronized with the device, but they serve as useful optimizations.
<a 
 id="x1-40001r39"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.7.1   </span> <a 
 id="x1-410001"></a>Driver Requirements: Used Buffer Notification Suppression</h5>
<!--l. 339--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST set <span 
class="aeti-10">flags </span>to 0 or 1.
     </li>
     <li class="itemize">The driver MAY set <span 
class="aeti-10">flags </span>to 1 to advise the device that notifications are
     not needed.</li></ul>
<!--l. 346--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST set <span 
class="aeti-10">flags </span>to 0.
     </li>
     <li class="itemize">The driver MAY use <span 
class="aeti-10">used_event </span>to advise the device that notifications are
     unnecessary until the device writes an entry with an index specified by
     <span 
class="aeti-10">used_event </span>into the used ring (equivalently, until <span 
class="aeti-10">idx </span>in the used ring will
                                                                  

                                                                  
     reach the value <span 
class="aeti-10">used_event </span>+ 1).</li></ul>
<!--l. 354--><p class="noindent" >The driver MUST handle spurious notifications from the device.
<a 
 id="x1-41001r41"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.7.2   </span> <a 
 id="x1-420002"></a>Device Requirements: Used Buffer Notification Suppression</h5>
<!--l. 358--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST ignore the <span 
class="aeti-10">used_event </span>value.
     </li>
     <li class="itemize">After the device writes a descriptor index into the used ring:
         <ul class="itemize2">
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 1, the device SHOULD NOT send a notification.
         </li>
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 0, the device MUST send a notification.</li></ul>
     </li></ul>
<!--l. 368--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST ignore the lower bit of <span 
class="aeti-10">flags</span>.
     </li>
     <li class="itemize">After the device writes a descriptor index into the used ring:
         <ul class="itemize2">
         <li class="itemize">If  the  <span 
class="aeti-10">idx  </span>field  in  the  used  ring  (which  determined  where  that
         descriptor  index  was  placed)  was  equal  to  <span 
class="aeti-10">used_event</span>,  the  device
         MUST send a notification.
         </li>
         <li class="itemize">Otherwise the device SHOULD NOT send a notification.</li></ul>
     </li></ul>
<span 
class="aebx-10">Note:</span> For example, if <span 
class="aeti-10">used_event </span>is 0, then a device using
      <!--l. 383--><p class="noindent" >VIRTIO_F_EVENT_IDX would send a used buffer notification to the
      driver after the first buffer is used (and again after the 65536th buffer,
      etc).
<a 
 id="x1-42001r40"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.8   </span> <a 
 id="x1-430008"></a>The Virtqueue Used Ring</h4>
<!--l. 390--><p class="noindent" >The used ring has the following layout structure:
<!--l. 392-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-9"><span class="label"><a 
 id="x1-43001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_USED_F_NO_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43009r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">here</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reasons</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43010r10"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Total</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">was</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43015r15"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 410--><p class="noindent" >The used ring is where the device returns buffers once it is done with them: it is only
written to by the device, and read by the driver.
<!--l. 413--><p class="noindent" >Each entry in the ring is a pair: <span 
class="aeti-10">id </span>indicates the head entry of the descriptor chain
describing the buffer (this matches an entry placed in the available ring by the guest
earlier), and <span 
class="aeti-10">len </span>the total of bytes written into the buffer.
<span 
class="aebx-10">Note:</span> <span 
class="aeti-10">len </span>is particularly useful for drivers using untrusted buffers: if a driver
      does not know exactly how much has been written by the device, the
      driver would have to zero the buffer in advance to ensure no data leakage
      occurs.
      <!--l. 424--><p class="noindent" >For example, a network driver may hand a received buffer directly to
      an unprivileged userspace application. If the network device has not
      overwritten  the  bytes  which  were  in  that  buffer,  this  could  leak  the
      contents of freed memory from other processes to the application.
<!--l. 430--><p class="noindent" ><span 
class="aeti-10">idx </span>field indicates where the device would put the next descriptor entry in the ring
(modulo the queue size). This starts at 0, and increases.
<span 
class="aebx-10">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to these structures as vring_used
      and                                                                   vring_used_elem,
      and the constant as VRING_USED_F_NO_NOTIFY, but the layout and
      value were identical.
<a 
 id="x1-43016r42"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.8.1   </span> <a 
 id="x1-440001"></a>Legacy Interface: The Virtqueue Used Ring</h5>
<!--l. 445--><p class="noindent" >Historically, many drivers ignored the <span 
class="aeti-10">len </span>value, as a result, many devices set <span 
class="aeti-10">len</span>
incorrectly. Thus, when using the legacy interface, it is generally a good idea to
ignore the <span 
class="aeti-10">len </span>value in used ring entries if possible. Specific known issues are listed
per device type.
<a 
 id="x1-44001r44"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.8.2   </span> <a 
 id="x1-450002"></a>Device Requirements: The Virtqueue Used Ring</h5>
<!--l. 453--><p class="noindent" >The device MUST set <span 
class="aeti-10">len </span>prior to updating the used <span 
class="aeti-10">idx</span>.
<!--l. 455--><p class="noindent" >The device MUST write at least <span 
class="aeti-10">len </span>bytes to descriptor, beginning at the first
device-writable buffer, prior to updating the used <span 
class="aeti-10">idx</span>.
<!--l. 459--><p class="noindent" >The device MAY write more than <span 
class="aeti-10">len </span>bytes to descriptor.
                                                                  

                                                                  
<span 
class="aebx-10">Note:</span> There are potential error cases where a device might not know what parts
      of the buffers have been written. This is why <span 
class="aeti-10">len </span>is permitted to be an
      underestimate: that’s preferable to the driver believing that uninitialized
      memory has been overwritten when it has not.
<a 
 id="x1-45001r45"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.8.3   </span> <a 
 id="x1-460003"></a>Driver Requirements: The Virtqueue Used Ring</h5>
<!--l. 470--><p class="noindent" >The driver MUST NOT make assumptions about data in device-writable buffers
beyond the first <span 
class="aeti-10">len </span>bytes, and SHOULD ignore this data.
<a 
 id="x1-46001r43"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.9   </span> <a 
 id="x1-470009"></a>In-order use of descriptors</h4>
<!--l. 476--><p class="noindent" >Some devices always use descriptors in the same order in which they have been made
available. These devices can offer the VIRTIO_F_IN_ORDER feature. If negotiated,
this knowledge allows devices to notify the use of a batch of buffers to the
driver by only writing out a single used ring entry with the <span 
class="aeti-10">id </span>corresponding
to the head entry of the descriptor chain describing the last buffer in the
batch.
<!--l. 484--><p class="noindent" >The device then skips forward in the ring according to the size of the batch.
Accordingly, it increments the used <span 
class="aeti-10">idx </span>by the size of the batch.
<!--l. 488--><p class="noindent" >The driver needs to look up the used <span 
class="aeti-10">id </span>and calculate the batch size to be
able to advance to where the next used ring entry will be written by the
device.
<!--l. 492--><p class="noindent" >This will result in the used ring entry at an offset matching the first available ring
entry in the batch, the used ring entry for the next batch at an offset matching the
first available ring entry in the next batch, etc.
<!--l. 497--><p class="noindent" >The skipped buffers (for which no used ring entry was written) are assumed to have
been used (read or written) by the device completely.
<a 
 id="x1-47001r47"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.10   </span> <a 
 id="x1-4800010"></a>Available Buffer Notification Suppression</h4>
<!--l. 503--><p class="noindent" >The device can suppress available buffer notifications in a manner analogous to the
way drivers can suppress used buffer notifications as detailed in section <a 
href="#x1-400007">2.6.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>. The
device manipulates <span 
class="aeti-10">flags </span>or <span 
class="aeti-10">avail_event </span>in the used ring the same way the driver
manipulates <span 
class="aeti-10">flags </span>or <span 
class="aeti-10">used_event </span>in the available ring.
<a 
 id="x1-48001r46"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.10.1   </span> <a 
 id="x1-490001"></a>Driver Requirements: Available Buffer Notification Suppression</h5>
<!--l. 512--><p class="noindent" >The driver MUST initialize <span 
class="aeti-10">flags </span>in the used ring to 0 when allocating the used
ring.
<!--l. 515--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
                                                                  

                                                                  
     <ul class="itemize1">
     <li class="itemize">The driver MUST ignore the <span 
class="aeti-10">avail_event </span>value.
     </li>
     <li class="itemize">After the driver writes a descriptor index into the available ring:
         <ul class="itemize2">
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 1, the driver SHOULD NOT send a notification.
         </li>
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 0, the driver MUST send a notification.</li></ul>
     </li></ul>
<!--l. 525--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST ignore the lower bit of <span 
class="aeti-10">flags</span>.
     </li>
     <li class="itemize">After the driver writes a descriptor index into the available ring:
         <ul class="itemize2">
         <li class="itemize">If the <span 
class="aeti-10">idx  </span>field in the available ring (which determined where that
         descriptor  index  was  placed)  was  equal  to  <span 
class="aeti-10">avail_event</span>,  the  driver
         MUST send a notification.
         </li>
         <li class="itemize">Otherwise the driver SHOULD NOT send a notification.</li></ul>
     </li></ul>
<a 
 id="x1-49001r49"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.10.2   </span> <a 
 id="x1-500002"></a>Device Requirements: Available Buffer Notification Suppression</h5>
<!--l. 538--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST set <span 
class="aeti-10">flags </span>to 0 or 1.
     </li>
     <li class="itemize">The device MAY set <span 
class="aeti-10">flags </span>to 1 to advise the driver that notifications are
     not needed.</li></ul>
<!--l. 545--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST set <span 
class="aeti-10">flags </span>to 0.
     </li>
     <li class="itemize">The device MAY use <span 
class="aeti-10">avail_event </span>to advise the driver that notifications
     are unnecessary until the driver writes entry with an index specified by
     <span 
class="aeti-10">avail_event </span>into the available ring (equivalently, until <span 
class="aeti-10">idx </span>in the available
                                                                  

                                                                  
     ring will reach the value <span 
class="aeti-10">avail_event </span>+ 1).</li></ul>
<!--l. 552--><p class="noindent" >The device MUST handle spurious notifications from the driver.
<a 
 id="x1-50001r48"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.11   </span> <a 
 id="x1-5100011"></a>Helpers for Operating Virtqueues</h4>
<!--l. 556--><p class="noindent" >The Linux Kernel Source code contains the definitions above and helper routines in a
more usable form, in include/uapi/linux/virtio_ring.h. This was explicitly licensed
by IBM and Red Hat under the (3-clause) BSD license so that it can be
freely used by all other projects, and is reproduced (with slight variation) in
<a 
href="#x1-466000A">A<!--tex4ht:ref: sec:virtio-queue.h --></a> <a 
href="#x1-466000A">virtio_queue.h<!--tex4ht:ref: sec:virtio-queue.h --></a>.
<a 
 id="x1-51001r51"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.12   </span> <a 
 id="x1-5200012"></a>Virtqueue Operation</h4>
<!--l. 565--><p class="noindent" >There are two parts to virtqueue operation: supplying new available buffers to the
device, and processing used buffers from the device.
<span 
class="aebx-10">Note:</span> As an example, the simplest virtio network device has two virtqueues: the
      transmit virtqueue and the receive virtqueue. The driver adds outgoing
      (device-readable) packets to the transmit virtqueue, and then frees them
      after  they  are  used.  Similarly,  incoming  (device-writable)  buffers  are
      added to the receive virtqueue, and processed after they are used.
<!--l. 578--><p class="noindent" >What follows is the requirements of each of these two parts when using the split
virtqueue format in more detail.
<a 
 id="x1-52001r52"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.13   </span> <a 
 id="x1-5300013"></a>Supplying Buffers to The Device</h4>
<!--l. 583--><p class="noindent" >The driver offers buffers to one of the device’s virtqueues as follows:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-53002x1"><a 
 id="x1-530011"></a> The driver places the buffer into free descriptor(s) in the descriptor table,
     chaining as necessary (see <a 
href="#x1-320005">2.6.5<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a> <a 
href="#x1-320005">The Virtqueue Descriptor Table<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>).
     </li>
     <li 
  class="enumerate" id="x1-53004x2"><a 
 id="x1-530032"></a> The driver places the index of the head of the descriptor chain into the
     next ring entry of the available ring.
     </li>
     <li 
  class="enumerate" id="x1-53006x3">Steps <a 
href="#x1-530011">1<!--tex4ht:ref: itm:Basic Facilities of a Virtio Device / Virtqueues / Supplying Buffers to The Device / Place Buffers --></a> and <a 
href="#x1-530032">2<!--tex4ht:ref: itm:Basic Facilities of a Virtio Device / Virtqueues / Supplying Buffers to The Device / Place Index --></a> MAY be performed repeatedly if batching is possible.
     </li>
     <li 
  class="enumerate" id="x1-53008x4">The driver performs a suitable memory barrier to ensure the device sees
     the updated descriptor table and available ring before the next step.
     </li>
     <li 
  class="enumerate" id="x1-53010x5">The available <span 
class="aeti-10">idx  </span>is increased by the number of descriptor chain heads
                                                                  

                                                                  
     added to the available ring.
     </li>
     <li 
  class="enumerate" id="x1-53012x6">The driver performs a suitable memory barrier to ensure that it updates
     the <span 
class="aeti-10">idx </span>field before checking for notification suppression.
     </li>
     <li 
  class="enumerate" id="x1-53014x7">The  driver  sends  an  available  buffer  notification  to  the  device  if  such
     notifications are not suppressed.</li></ol>
<!--l. 609--><p class="noindent" >Note that the above code does not take precautions against the available ring buffer
wrapping around: this is not possible since the ring buffer is the same size as the
descriptor table, so step (1) will prevent such a condition.
<!--l. 614--><p class="noindent" >In addition, the maximum queue size is 32768 (the highest power of 2 which fits in 16
bits), so the 16-bit <span 
class="aeti-10">idx </span>value can always distinguish between a full and empty
buffer.
<!--l. 618--><p class="noindent" >What follows is the requirements of each stage in more detail.
<a 
 id="x1-53015r50"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.13.1   </span> <a 
 id="x1-540001"></a>Placing Buffers Into The Descriptor Table</h5>
<!--l. 622--><p class="noindent" >A buffer consists of zero or more device-readable physically-contiguous elements
followed by zero or more physically-contiguous device-writable elements (each has at
least one element). This algorithm maps it into the descriptor table to form a
descriptor chain:
<!--l. 628--><p class="noindent" >for each buffer element, b:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-54002x1">Get the next free descriptor table entry, d
     </li>
     <li 
  class="enumerate" id="x1-54004x2">Set <span 
class="aeti-10">d.addr </span>to the physical address of the start of b
     </li>
     <li 
  class="enumerate" id="x1-54006x3">Set <span 
class="aeti-10">d.len </span>to the length of b.
     </li>
     <li 
  class="enumerate" id="x1-54008x4">If b is device-writable, set <span 
class="aeti-10">d.flags </span>to VIRTQ_DESC_F_WRITE, otherwise
     0.
     </li>
     <li 
  class="enumerate" id="x1-54010x5">If there is a buffer element after this:
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x1-54012x1">Set <span 
class="aeti-10">d.next </span>to the index of the next free descriptor element.
         </li>
         <li 
  class="enumerate" id="x1-54014x2">Set the VIRTQ_DESC_F_NEXT bit in <span 
class="aeti-10">d.flags</span>.</li></ol>
     </li></ol>
                                                                  

                                                                  
<!--l. 644--><p class="noindent" >In practice, <span 
class="aeti-10">d.next </span>is usually used to chain free descriptors, and a separate
count kept to check there are enough free descriptors before beginning the
mappings.
<a 
 id="x1-54015r54"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.13.2   </span> <a 
 id="x1-550002"></a>Updating The Available Ring</h5>
<!--l. 650--><p class="noindent" >The descriptor chain head is the first d in the algorithm above, ie. the index of the
descriptor table entry referring to the first part of the buffer. A naive driver
implementation MAY do the following (with the appropriate conversion to-and-from
little-endian assumed):
<!--l. 655-->
<div class="lstlisting" id="listing-10"><span class="label"><a 
 id="x1-55001r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 659--><p class="noindent" >However, in general the driver MAY add many descriptor chains before it updates <span 
class="aeti-10">idx</span>
(at which point they become visible to the device), so it is common to keep a counter
of how many the driver has added:
<!--l. 663-->
<div class="lstlisting" id="listing-11"><span class="label"><a 
 id="x1-55002r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[(</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">added</span><span 
class="pcrr8t-x-x-80">++)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<a 
 id="x1-55003r55"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.13.3   </span> <a 
 id="x1-560003"></a>Updating <span 
class="aeti-10">idx</span></h5>
<!--l. 669--><p class="noindent" ><span 
class="aeti-10">idx </span>always increments, and wraps naturally at 65536:
<!--l. 672-->
<div class="lstlisting" id="listing-12"><span class="label"><a 
 id="x1-56001r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">added</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 676--><p class="noindent" >Once available <span 
class="aeti-10">idx </span>is updated by the driver, this exposes the descriptor and its
contents. The device MAY access the descriptor chains the driver created and the
memory they refer to immediately.
<a 
 id="x1-56002r37"></a>
<h5 class="paragraphHead"><span class="titlemark">2.6.13.3.1</span> <a 
 id="x1-570001"></a>Driver Requirements: Updating idx</h5>
The driver MUST perform a suitable memory barrier before the <span 
class="aeti-10">idx </span>update, to
ensure the device sees the most up-to-date copy.
<a 
 id="x1-57001r56"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.6.13.4   </span> <a 
 id="x1-580004"></a>Notifying The Device</h5>
<!--l. 687--><p class="noindent" >The actual method of device notification is bus-specific, but generally it can be
expensive. So the device MAY suppress such notifications if it doesn’t need them, as
detailed in section <a 
href="#x1-4800010">2.6.10<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Notification Suppression --></a>.
<!--l. 691--><p class="noindent" >The driver has to be careful to expose the new <span 
class="aeti-10">idx </span>value before checking if
notifications are suppressed.
<a 
 id="x1-58001r57"></a>
<h5 class="paragraphHead"><span class="titlemark">2.6.13.4.1</span> <a 
 id="x1-590001"></a>Driver Requirements: Notifying The Device</h5>
The driver MUST perform a suitable memory barrier before reading <span 
class="aeti-10">flags </span>or
<span 
class="aeti-10">avail_event</span>, to avoid missing a notification.
<a 
 id="x1-59001r53"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.14   </span> <a 
 id="x1-6000014"></a>Receiving Used Buffers From The Device</h4>
<!--l. 700--><p class="noindent" >Once the device has used buffers referred to by a descriptor (read from or written to
them, or parts of both, depending on the nature of the virtqueue and the
device), it sends a used buffer notification to the driver as detailed in section
<a 
href="#x1-400007">2.6.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>.
<span 
class="aebx-10">Note:</span>
      <!--l. 708--><p class="noindent" >For optimal performance, a driver MAY disable used buffer notifications
      while  processing  the  used  ring,  but  beware  the  problem  of  missing
      notifications between emptying the ring and reenabling notifications.
      This  is  usually  handled  by  re-checking  for  more  used  buffers  after
      notifications are re-enabled:
      <!--l. 714-->
      <div class="lstlisting" id="listing-13"><span class="label"><a 
 id="x1-60001r1"></a></span><span 
class="pcrr8t-x-x-80">virtq_disable_used_buffer_notifications</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60003r3"></a></span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(;;)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16_to_cpu</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_enable_used_buffer_notifications</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mb</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16_to_cpu</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">break</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_disable_used_buffer_notifications</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80">vsz</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">process_buffer</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80">++;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60017r17"></a></span><span 
class="pcrr8t-x-x-80">}</span>
      
      </div>
<a 
 id="x1-60018r24"></a>
<h3 class="sectionHead"><span class="titlemark">2.7   </span> <a 
 id="x1-610007"></a>Packed Virtqueues</h3>
<!--l. 3--><p class="noindent" >Packed virtqueues is an alternative compact virtqueue layout using read-write
memory, that is memory that is both read and written by both host and
guest.
<!--l. 7--><p class="noindent" >Use of packed virtqueues is negotiated by the VIRTIO_F_RING_PACKED feature
bit.
<!--l. 10--><p class="noindent" >Packed virtqueues support up to <span 
class="cmr-10">2</span><sup><span 
class="cmr-7">15</span></sup> entries each.
                                                                  

                                                                  
<!--l. 12--><p class="noindent" >With current transports, virtqueues are located in guest memory allocated by the
driver. Each packed virtqueue consists of three parts:
     <ul class="itemize1">
     <li class="itemize">Descriptor Ring - occupies the Descriptor Area
     </li>
     <li class="itemize">Driver Event Suppression - occupies the Driver Area
     </li>
     <li class="itemize">Device Event Suppression - occupies the Device Area</li></ul>
<!--l. 22--><p class="noindent" >Where the Descriptor Ring in turn consists of descriptors, and where each descriptor
can contain the following parts:
     <ul class="itemize1">
     <li class="itemize">Buffer ID
     </li>
     <li class="itemize">Element Address
     </li>
     <li class="itemize">Element Length
     </li>
     <li class="itemize">Flags</li></ul>
<!--l. 32--><p class="noindent" >A buffer consists of zero or more device-readable physically-contiguous elements
followed by zero or more physically-contiguous device-writable elements (each buffer
has at least one element).
<!--l. 36--><p class="noindent" >When the driver wants to send such a buffer to the device, it writes at least one
available descriptor describing elements of the buffer into the Descriptor Ring. The
descriptor(s) are associated with a buffer by means of a Buffer ID stored within the
descriptor.
<!--l. 42--><p class="noindent" >The driver then notifies the device. When the device has finished processing the
buffer, it writes a used device descriptor including the Buffer ID into the Descriptor
Ring (overwriting a driver descriptor previously made available), and sends a used
event notification.
<!--l. 48--><p class="noindent" >The Descriptor Ring is used in a circular manner: the driver writes descriptors into
the ring in order. After reaching the end of the ring, the next descriptor is placed at
the head of the ring. Once the ring is full of driver descriptors, the driver stops
sending new requests and waits for the device to start processing descriptors and
to write out some used descriptors before making new driver descriptors
available.
<!--l. 56--><p class="noindent" >Similarly, the device reads descriptors from the ring in order and detects that a driver
descriptor has been made available. As processing of descriptors is completed, used
descriptors are written by the device back into the ring.
                                                                  

                                                                  
<!--l. 61--><p class="noindent" >Note: after reading driver descriptors and starting their processing in order, the
device might complete their processing out of order. Used device descriptors are
written in the order in which their processing is complete.
<!--l. 66--><p class="noindent" >The Device Event Suppression data structure is write-only by the device. It includes
information for reducing the number of device events, i.e., sending fewer available
buffer notifications to the device.
<!--l. 71--><p class="noindent" >The Driver Event Suppression data structure is read-only by the device. It includes
information for reducing the number of driver events, i.e., sending fewer used buffer
notifications to the driver.
<a 
 id="x1-61001r60"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.1   </span> <a 
 id="x1-620001"></a>Driver and Device Ring Wrap Counters</h4>
<!--l. 78--><p class="noindent" >Each of the driver and the device are expected to maintain, internally, a single-bit
ring wrap counter initialized to 1.
<!--l. 81--><p class="noindent" >The counter maintained by the driver is called the Driver Ring Wrap Counter. The
driver changes the value of this counter each time it makes available the last
descriptor in the ring (after making the last descriptor available).
<!--l. 87--><p class="noindent" >The counter maintained by the device is called the Device Ring Wrap Counter. The
device changes the value of this counter each time it uses the last descriptor in the
ring (after marking the last descriptor used).
<!--l. 92--><p class="noindent" >It is easy to see that the Driver Ring Wrap Counter in the driver matches the Device
Ring Wrap Counter in the device when both are processing the same descriptor, or
when all available descriptors have been used.
<!--l. 96--><p class="noindent" >To mark a descriptor as available and used, both the driver and the device use the
following two flags: <!--l. 98-->
<div class="lstlisting" id="listing-14"><span class="label"><a 
 id="x1-62001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_AVAIL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><<</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-62002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_USED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><<</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15)</span>
</div>
<!--l. 103--><p class="noindent" >To mark a descriptor as available, the driver sets the VIRTQ_DESC_F_AVAIL bit
in Flags to match the internal Driver Ring Wrap Counter. It also sets the
VIRTQ_DESC_F_USED bit to match the <span 
class="aeti-10">inverse </span>value (i.e. to not match the internal
Driver Ring Wrap Counter).
<!--l. 109--><p class="noindent" >To mark a descriptor as used, the device sets the VIRTQ_DESC_F_USED bit in
Flags to match the internal Device Ring Wrap Counter. It also sets the
VIRTQ_DESC_F_AVAIL bit to match the <span 
class="aeti-10">same </span>value.
<!--l. 114--><p class="noindent" >Thus VIRTQ_DESC_F_AVAIL and VIRTQ_DESC_F_USED bits are different for an
available descriptor and equal for a used descriptor.
<!--l. 117--><p class="noindent" >Note that this observation is mostly useful for sanity-checking as these are necessary
but not sufficient conditions - for example, all descriptors are zero-initialized. To
                                                                  

                                                                  
detect used and available descriptors it is possible for drivers and devices to keep
track of the last observed value of VIRTQ_DESC_F_USED/VIRTQ_DESC_F_AVAIL.
Other techniques to detect VIRTQ_DESC_F_AVAIL/VIRTQ_DESC_F_USED bit
changes might also be possible.
<a 
 id="x1-62003r62"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.2   </span> <a 
 id="x1-630002"></a>Polling of available and used descriptors</h4>
<!--l. 129--><p class="noindent" >Writes of device and driver descriptors can generally be reordered, but each side
(driver and device) are only required to poll (or test) a single location in memory: the
next device descriptor after the one they processed previously, in circular
order.
<!--l. 134--><p class="noindent" >Sometimes the device needs to only write out a single used descriptor after processing
a batch of multiple available descriptors. As described in more detail below, this can
happen when using descriptor chaining or with in-order use of descriptors. In this
case, the device writes out a used descriptor with the buffer id of the last descriptor
in the group. After processing the used descriptor, both device and driver then skip
forward in the ring the number of the remaining descriptors in the group until
processing (reading for the driver and writing for the device) the next used
descriptor.
<a 
 id="x1-63001r63"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.3   </span> <a 
 id="x1-640003"></a>Write Flag</h4>
<!--l. 148--><p class="noindent" >In an available descriptor, the VIRTQ_DESC_F_WRITE bit within Flags is used to
mark a descriptor as corresponding to a write-only or read-only element of a
buffer.
<!--l. 152-->
<div class="lstlisting" id="listing-15"><span class="label"><a 
 id="x1-64001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">otherwise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-64002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 157--><p class="noindent" >In a used descriptor, this bit is used to specify whether any data has been written by
the device into any parts of the buffer.
<a 
 id="x1-64003r64"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.4   </span> <a 
 id="x1-650004"></a>Element Address and Length</h4>
<!--l. 164--><p class="noindent" >In an available descriptor, Element Address corresponds to the physical address of
the buffer element. The length of the element assumed to be physically contiguous is
stored in Element Length.
<!--l. 168--><p class="noindent" >In a used descriptor, Element Address is unused. Element Length specifies the length
of the buffer that has been initialized (written to) by the device.
<!--l. 172--><p class="noindent" >Element Length is reserved for used descriptors without the VIRTQ_DESC_F_WRITE
flag, and is ignored by drivers.
                                                                  

                                                                  
<a 
 id="x1-65001r65"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.5   </span> <a 
 id="x1-660005"></a>Scatter-Gather Support</h4>
<!--l. 178--><p class="noindent" >Some drivers need an ability to supply a list of multiple buffer elements (also known
as a scatter/gather list) with a request. Two features support this: descriptor
chaining and indirect descriptors.
<!--l. 182--><p class="noindent" >If neither feature is in use by the driver, each buffer is physically-contiguous, either
read-only or write-only and is described completely by a single descriptor.
<!--l. 186--><p class="noindent" >While unusual (most implementations either create all lists solely using non-indirect
descriptors, or always use a single indirect element), if both features have been
negotiated, mixing indirect and non-indirect descriptors in a ring is valid, as long as
each list only contains descriptors of a given type.
<!--l. 192--><p class="noindent" >Scatter/gather lists only apply to available descriptors. A single used descriptor
corresponds to the whole list.
<!--l. 195--><p class="noindent" >The device limits the number of descriptors in a list through a transport-specific
and/or device-specific value. If not limited, the maximum number of descriptors in a
list is the virt queue size.
<a 
 id="x1-66001r66"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.6   </span> <a 
 id="x1-670006"></a>Next Flag: Descriptor Chaining</h4>
<!--l. 203--><p class="noindent" >The packed ring format allows the driver to supply a scatter/gather list to the device
by using multiple descriptors, and setting the VIRTQ_DESC_F_NEXT bit in Flags
for all but the last available descriptor.
<!--l. 208-->
<div class="lstlisting" id="listing-16"><span class="label"><a 
 id="x1-67001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">continuing</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-67002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 213--><p class="noindent" >Buffer ID is included in the last descriptor in the list.
<!--l. 215--><p class="noindent" >The driver always makes the first descriptor in the list available after the rest of the
list has been written out into the ring. This guarantees that the device will never
observe a partial scatter/gather list in the ring.
<!--l. 220--><p class="noindent" >Note: all flags, including VIRTQ_DESC_F_AVAIL, VIRTQ_DESC_F_USED,
VIRTQ_DESC_F_WRITE must be set/cleared correctly in all descriptors in the list,
not just the first one.
<!--l. 224--><p class="noindent" >The device only writes out a single used descriptor for the whole list. It
then skips forward according to the number of descriptors in the list. The
driver needs to keep track of the size of the list corresponding to each buffer
ID, to be able to skip to where the next used descriptor is written by the
device.
                                                                  

                                                                  
<!--l. 230--><p class="noindent" >For example, if descriptors are used in the same order in which they are made
available, this will result in the used descriptor overwriting the first available
descriptor in the list, the used descriptor for the next list overwriting the first
available descriptor in the next list, etc.
<!--l. 236--><p class="noindent" >VIRTQ_DESC_F_NEXT is reserved in used descriptors, and should be ignored by
drivers.
<a 
 id="x1-67003r67"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.7   </span> <a 
 id="x1-680007"></a>Indirect Flag: Scatter-Gather Support</h4>
<!--l. 242--><p class="noindent" >Some devices benefit by concurrently dispatching a large number of large requests.
The VIRTIO_F_INDIRECT_DESC feature allows this. To increase ring capacity the
driver can store a (read-only by the device) table of indirect descriptors anywhere
in memory, and insert a descriptor in the main virtqueue (with <span 
class="aeti-10">Flags </span>bit
VIRTQ_DESC_F_INDIRECT on) that refers to a buffer element containing this
indirect descriptor table; <span 
class="aeti-10">addr </span>and <span 
class="aeti-10">len </span>refer to the indirect table address and length
in bytes, respectively. <!--l. 251-->
<div class="lstlisting" id="listing-17"><span class="label"><a 
 id="x1-68001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">means</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">element</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contains</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">table</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-68002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_INDIRECT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span>
</div>
<!--l. 256--><p class="noindent" >The indirect table layout structure looks like this (<span 
class="aeti-10">len </span>is the Buffer Length of the
descriptor that refers to this table, which is a variable):
<!--l. 260-->
<div class="lstlisting" id="listing-18"><span class="label"><a 
 id="x1-68003r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_indirect_descriptor_table</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-68004r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structures</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-68005r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-68006r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 267--><p class="noindent" >The first descriptor is located at the start of the indirect descriptor table, additional
indirect descriptors come immediately afterwards. The VIRTQ_DESC_F_WRITE
<span 
class="aeti-10">flags </span>bit is the only valid flag for descriptors in the indirect table. Others are reserved
and are ignored by the device. Buffer ID is also reserved and is ignored by the
device.
<!--l. 274--><p class="noindent" >In descriptors with VIRTQ_DESC_F_INDIRECT set VIRTQ_DESC_F_WRITE is
reserved and is ignored by the device.
<a 
 id="x1-68007r68"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.8   </span> <a 
 id="x1-690008"></a>In-order use of descriptors</h4>
<!--l. 280--><p class="noindent" >Some devices always use descriptors in the same order in which they have been made
available. These devices can offer the VIRTIO_F_IN_ORDER feature. If negotiated,
this knowledge allows devices to notify the use of a batch of buffers to the driver by
only writing out a single used descriptor with the Buffer ID corresponding to the last
descriptor in the batch.
                                                                  

                                                                  
<!--l. 287--><p class="noindent" >The device then skips forward in the ring according to the size of the batch. The
driver needs to look up the used Buffer ID and calculate the batch size to be
able to advance to where the next used descriptor will be written by the
device.
<!--l. 292--><p class="noindent" >This will result in the used descriptor overwriting the first available descriptor in the
batch, the used descriptor for the next batch overwriting the first available descriptor
in the next batch, etc.
<!--l. 297--><p class="noindent" >The skipped buffers (for which no used descriptor was written) are assumed to have
been used (read or written) by the device completely.
<a 
 id="x1-69001r69"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.9   </span> <a 
 id="x1-700009"></a>Multi-buffer requests</h4>
<!--l. 303--><p class="noindent" >Some devices combine multiple buffers as part of processing of a single request. These
devices always mark the descriptor corresponding to the first buffer in the request
used after the rest of the descriptors (corresponding to rest of the buffers) in the
request - which follow the first descriptor in ring order - has been marked used and
written out into the ring. This guarantees that the driver will never observe a partial
request in the ring.
<a 
 id="x1-70001r70"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.10   </span> <a 
 id="x1-7100010"></a>Driver and Device Event Suppression</h4>
<!--l. 314--><p class="noindent" >In many systems used and available buffer notifications involve significant overhead.
To mitigate this overhead, each virtqueue includes two identical structures used for
controlling notifications between the device and the driver.
<!--l. 319--><p class="noindent" >The Driver Event Suppression structure is read-only by the device and controls the
used buffer notifications sent by the device to the driver.
<!--l. 323--><p class="noindent" >The Device Event Suppression structure is read-only by the driver and controls the
available buffer notifications sent by the driver to the device.
<!--l. 327--><p class="noindent" >Each of these Event Suppression structures includes the following fields:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Descriptor Ring Change Event Flags</span> </dt><dd 
class="description">Takes values: <!--l. 331-->
     <div class="lstlisting" id="listing-19"><span class="label"><a 
 id="x1-71001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Enable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_ENABLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71003r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Disable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DISABLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71005r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Enable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specified</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Change</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Offset</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">Wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_RING_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">has</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">been</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DESC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71011r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span>
     
     </div>
     </dd><dt class="description">
<span 
class="aebx-10">Descriptor Ring Change Event Offset</span> </dt><dd 
class="description">If Event Flags set to descriptor specific
     event: offset within the ring (in units of descriptor size). Event will only trigger
     when this descriptor is made available/used respectively.
     </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aebx-10">Descriptor Ring Change Event Wrap Counter</span> </dt><dd 
class="description">If Event Flags set to descriptor
     specific event: offset within the ring (in units of descriptor size). Event will only
     trigger when Ring Wrap Counter matches this value and a descriptor is made
     available/used respectively.</dd></dl>
<!--l. 355--><p class="noindent" >After writing out some descriptors, both the device and the driver are expected to
consult the relevant structure to find out whether a used respectively an available
buffer notification should be sent.
<a 
 id="x1-71012r58"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.10.1   </span> <a 
 id="x1-720001"></a>Structure Size and Alignment</h5>
<!--l. 362--><p class="noindent" >Each part of the virtqueue is physically-contiguous in guest memory, and has
different alignment requirements.
<!--l. 365--><p class="noindent" >The memory alignment and size requirements, in bytes, of each part of the virtqueue
are summarized in the following table:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtqueue Part                </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Alignment  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Size                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Descriptor Ring               </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16            </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">16</span><span 
class="cmsy-10">∗</span>(Queue Size)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Event Suppression  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Driver Event Suppression  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4                      </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 380--><p class="noindent" >The Alignment column gives the minimum alignment for each part of the
virtqueue.
<!--l. 383--><p class="noindent" >The Size column gives the total number of bytes for each part of the virtqueue.
<!--l. 386--><p class="noindent" >Queue Size corresponds to the maximum number of descriptors in the
virtqueue<span class="footnote-mark"><a 
href="#fn5x2" id="fn5x2-bk"><sup class="textsuperscript">5</sup></a></span><a 
 id="x1-72001f5"></a>.
The Queue Size value does not have to be a power of 2.
<a 
 id="x1-72002r71"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.11   </span> <a 
 id="x1-7300011"></a>Driver Requirements: Virtqueues</h4>
<!--l. 393--><p class="noindent" >The driver MUST ensure that the physical address of the first byte of each
virtqueue part is a multiple of the specified alignment value in the above
table.
<a 
 id="x1-73001r73"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.12   </span> <a 
 id="x1-7400012"></a>Device Requirements: Virtqueues</h4>
<!--l. 399--><p class="noindent" >The device MUST start processing driver descriptors in the order in which they
appear in the ring. The device MUST start writing device descriptors into the ring in
the order in which they complete. The device MAY reorder descriptor writes once
they are started.
<a 
 id="x1-74001r74"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.13   </span> <a 
 id="x1-7500013"></a>The Virtqueue Descriptor Format</h4>
<!--l. 409--><p class="noindent" >The available descriptor refers to the buffers the driver is sending to the device. <span 
class="aeti-10">addr</span>
                                                                  

                                                                  
is a physical address, and the descriptor is identified with a buffer using the <span 
class="aeti-10">id</span>
field.
<!--l. 413-->
<div class="lstlisting" id="listing-20"><span class="label"><a 
 id="x1-75001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Address</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ID</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">depending</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 426--><p class="noindent" >The descriptor ring is zero-initialized.
<a 
 id="x1-75011r75"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.14   </span> <a 
 id="x1-7600014"></a>Event Suppression Structure Format</h4>
<!--l. 432--><p class="noindent" >The following structure is used to reduce the number of notifications sent between
driver and device.
<!--l. 435-->
<div class="lstlisting" id="listing-21"><span class="label"><a 
 id="x1-76001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_event_suppress</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc_event_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Change</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc_event_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Change</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">If</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc_event_flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">set</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DESC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc_event_flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Change</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">14;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Reserved</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">set</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-76010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-76011r76"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.15   </span> <a 
 id="x1-7700015"></a>Device Requirements: The Virtqueue Descriptor Table</h4>
<!--l. 449--><p class="noindent" >A device MUST NOT write to a device-readable buffer, and a device SHOULD NOT
read a device-writable buffer. A device MUST NOT use a descriptor unless it
observes the VIRTQ_DESC_F_AVAIL bit in its <span 
class="aeti-10">flags </span>being changed (e.g. as compared
to the initial zero value). A device MUST NOT change a descriptor after changing
it’s the VIRTQ_DESC_F_USED bit in its <span 
class="aeti-10">flags</span>.
<a 
 id="x1-77001r77"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.16   </span> <a 
 id="x1-7800016"></a>Driver Requirements: The Virtqueue Descriptor Table</h4>
<!--l. 458--><p class="noindent" >A driver MUST NOT change a descriptor unless it observes the VIRTQ_DESC_F_USED
bit in its <span 
class="aeti-10">flags </span>being changed. A driver MUST NOT change a descriptor after
changing the VIRTQ_DESC_F_AVAIL bit in its <span 
class="aeti-10">flags</span>. When notifying the device,
driver MUST set <span 
class="aeti-10">next_off  </span>and <span 
class="aeti-10">next_wrap </span>to match the next descriptor not
yet made available to the device. A driver MAY send multiple available
buffer notifications without making any new descriptors available to the
device.
<a 
 id="x1-78001r78"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.17   </span> <a 
 id="x1-7900017"></a>Driver Requirements: Scatter-Gather Support</h4>
<!--l. 471--><p class="noindent" >A driver MUST NOT create a descriptor list longer than allowed by the
device.
                                                                  

                                                                  
<!--l. 474--><p class="noindent" >A driver MUST NOT create a descriptor list longer than the Queue Size.
<!--l. 477--><p class="noindent" >This implies that loops in the descriptor list are forbidden!
<!--l. 479--><p class="noindent" >The driver MUST place any device-writable descriptor elements after any
device-readable descriptor elements.
<!--l. 482--><p class="noindent" >A driver MUST NOT depend on the device to use more descriptors to be able to
write out all descriptors in a list. A driver MUST make sure there’s enough space in
the ring for the whole list before making the first descriptor in the list available to
the device.
<!--l. 488--><p class="noindent" >A driver MUST NOT make the first descriptor in the list available before all
subsequent descriptors comprising the list are made available.
<a 
 id="x1-79001r79"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.18   </span> <a 
 id="x1-8000018"></a>Device Requirements: Scatter-Gather Support</h4>
<!--l. 494--><p class="noindent" >The device MUST use descriptors in a list chained by the VIRTQ_DESC_F_NEXT
flag in the same order that they were made available by the driver.
<!--l. 498--><p class="noindent" >The device MAY limit the number of buffers it will allow in a list.
<a 
 id="x1-80001r80"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.19   </span> <a 
 id="x1-8100019"></a>Driver Requirements: Indirect Descriptors</h4>
<!--l. 502--><p class="noindent" >The driver MUST NOT set the DESC_F_INDIRECT flag unless the
VIRTIO_F_INDIRECT_DESC feature was negotiated. The driver MUST NOT set
any flags except DESC_F_WRITE within an indirect descriptor.
<!--l. 506--><p class="noindent" >A driver MUST NOT create a descriptor chain longer than allowed by the
device.
<!--l. 509--><p class="noindent" >A driver MUST NOT write direct descriptors with DESC_F_INDIRECT set in a
scatter-gather list linked by VIRTQ_DESC_F_NEXT. <span 
class="aeti-10">flags</span>.
<a 
 id="x1-81001r81"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.20   </span> <a 
 id="x1-8200020"></a>Virtqueue Operation</h4>
<!--l. 516--><p class="noindent" >There are two parts to virtqueue operation: supplying new available buffers to the
device, and processing used buffers from the device.
<!--l. 520--><p class="noindent" >What follows is the requirements of each of these two parts when using the packed
virtqueue format in more detail.
<a 
 id="x1-82001r82"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.21   </span> <a 
 id="x1-8300021"></a>Supplying Buffers to The Device</h4>
<!--l. 525--><p class="noindent" >The driver offers buffers to one of the device’s virtqueues as follows:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-83002x1">The driver places the buffer into free descriptor(s) in the Descriptor Ring.
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x1-83004x2">The driver performs a suitable memory barrier to ensure that it updates
     the descriptor(s) before checking for notification suppression.
     </li>
     <li 
  class="enumerate" id="x1-83006x3">If notifications are not suppressed, the driver notifies the device of the new
     available buffers.</li></ol>
<!--l. 537--><p class="noindent" >What follows are the requirements of each stage in more detail.
<a 
 id="x1-83007r72"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.21.1   </span> <a 
 id="x1-840001"></a>Placing Available Buffers Into The Descriptor Ring</h5>
<!--l. 541--><p class="noindent" >For each buffer element, b:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-84002x1">Get the next descriptor table entry, d
     </li>
     <li 
  class="enumerate" id="x1-84004x2">Get the next free buffer id value
     </li>
     <li 
  class="enumerate" id="x1-84006x3">Set <span 
class="aeti-10">d.addr </span>to the physical address of the start of b
     </li>
     <li 
  class="enumerate" id="x1-84008x4">Set <span 
class="aeti-10">d.len </span>to the length of b.
     </li>
     <li 
  class="enumerate" id="x1-84010x5">Set <span 
class="aeti-10">d.id </span>to the buffer id
     </li>
     <li 
  class="enumerate" id="x1-84012x6">Calculate the flags as follows:
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x1-84014x1">If b is device-writable, set the VIRTQ_DESC_F_WRITE bit to 1,
         otherwise 0
         </li>
         <li 
  class="enumerate" id="x1-84016x2">Set the VIRTQ_DESC_F_AVAIL bit to the current value of the Driver
         Ring Wrap Counter
         </li>
         <li 
  class="enumerate" id="x1-84018x3">Set the VIRTQ_DESC_F_USED bit to inverse value</li></ol>
     </li>
     <li 
  class="enumerate" id="x1-84020x7">Perform a memory barrier to ensure that the descriptor has been initialized
     </li>
     <li 
  class="enumerate" id="x1-84022x8">Set <span 
class="aeti-10">d.flags </span>to the calculated flags value
     </li>
     <li 
  class="enumerate" id="x1-84024x9">If d is the last descriptor in the ring, toggle the Driver Ring Wrap
     Counter
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x1-84026x10">Otherwise, increment d to point at the next descriptor</li></ol>
<!--l. 563--><p class="noindent" >This makes a single descriptor buffer available. However, in general the driver
MAY make use of a batch of descriptors as part of a single request. In that
case, it defers updating the descriptor flags for the first descriptor (and the
previous memory barrier) until after the rest of the descriptors have been
initialized.
<!--l. 570--><p class="noindent" >Once the descriptor <span 
class="aeti-10">flags </span>field is updated by the driver, this exposes the descriptor
and its contents. The device MAY access the descriptor and any following descriptors
the driver created and the memory they refer to immediately.
<a 
 id="x1-84027r59"></a>
<h5 class="paragraphHead"><span class="titlemark">2.7.21.1.1</span> <a 
 id="x1-850001"></a>Driver Requirements: Updating flags</h5>
The driver MUST perform a suitable memory barrier before the <span 
class="aeti-10">flags </span>update, to
ensure the device sees the most up-to-date copy.
<a 
 id="x1-85001r84"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.21.2   </span> <a 
 id="x1-860002"></a>Sending Available Buffer Notifications</h5>
<!--l. 586--><p class="noindent" >The actual method of device notification is bus-specific, but generally it can be
expensive. So the device MAY suppress such notifications if it doesn’t need them,
using the Event Suppression structure comprising the Device Area as detailed in
section <a 
href="#x1-7600014">2.7.14<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues / Event Suppression Structure Format --></a>.
<!--l. 593--><p class="noindent" >The driver has to be careful to expose the new <span 
class="aeti-10">flags </span>value before checking if
notifications are suppressed.
<a 
 id="x1-86001r86"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.21.3   </span> <a 
 id="x1-870003"></a>Implementation Example</h5>
<!--l. 598--><p class="noindent" >Below is a driver code example. It does not attempt to reduce the number of available
buffer notifications, neither does it support the VIRTIO_F_RING_EVENT_IDX
feature.
<!--l. 602-->
<div class="lstlisting" id="listing-22"><span class="label"><a 
 id="x1-87001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">avail_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">initialized</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87002r2"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">array</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">same</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87004r4"></a></span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alloc_id</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87006r6"></a></span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87007r7"></a></span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87008r8"></a></span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">element</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">++;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_addr</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_len</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">avail_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">?</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_AVAIL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">avail_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">?</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_USED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">f</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_flags</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">not</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">last</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">element</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">f</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Don</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mark</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80">st</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">until</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">all</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">them</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ready</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">==</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">f</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">else</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">f</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">last</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">++;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">>=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">avail_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\^=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87037r37"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87038r38"></a></span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87039r39"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">included</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">last</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87040r40"></a></span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">last</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87041r41"></a></span><span 
class="pcrr8t-x-x-80">write_memory_barrier</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87042r42"></a></span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87044r44"></a></span><span 
class="pcrr8t-x-x-80">memory_barrier</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87045r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87046r46"></a></span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">device_event</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DISABLE</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_device</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87048r48"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<a 
 id="x1-87051r85"></a>
<h5 class="paragraphHead"><span class="titlemark">2.7.21.3.1</span> <a 
 id="x1-880001"></a>Driver Requirements: Sending Available Buffer Notifications</h5>
The driver MUST perform a suitable memory barrier before reading the Event
Suppression structure occupying the Device Area. Failing to do so could result in
mandatory available buffer notifications not being sent.
                                                                  

                                                                  
<a 
 id="x1-88001r83"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.22   </span> <a 
 id="x1-8900022"></a>Receiving Used Buffers From The Device</h4>
<!--l. 663--><p class="noindent" >Once the device has used buffers referred to by a descriptor (read from or written to
them, or parts of both, depending on the nature of the virtqueue and the
device), it sends a used buffer notification to the driver as detailed in section
<a 
href="#x1-7600014">2.7.14<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues / Event Suppression Structure Format --></a>.
<span 
class="aebx-10">Note:</span>
      <!--l. 672--><p class="noindent" >For optimal performance, a driver MAY disable used buffer notifications
      while processing the used buffers, but beware the problem of missing
      notifications  between  emptying  the  ring  and  reenabling  used  buffer
      notifications. This is usually handled by re-checking for more used buffers
      after notifications are re-enabled:
<!--l. 680-->
<div class="lstlisting" id="listing-23"><span class="label"><a 
 id="x1-89001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">initialized</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89003r3"></a></span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">driver_event</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DISABLE</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89005r5"></a></span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(;;)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_used</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Check</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">has</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">been</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">made</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">check</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">necessary</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">making</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">new</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">parallel</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">g</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">another</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">thread</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">there</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">many</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">other</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ways</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">check</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">g</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">track</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">number</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">outstanding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffers</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">check</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">not</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">has</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">been</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bool</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_AVAIL</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bool</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_USED</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">||</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">driver_event</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_ENABLE</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">memory_barrier</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Re</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">test</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">case</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">made</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">more</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">parallel</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">g</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">another</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">thread</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">more</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">enabled</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bool</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_AVAIL</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bool</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_USED</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">||</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">break</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">driver_event</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DISABLE</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read_memory_barrier</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89042r42"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">skip</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">until</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89044r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89045r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">assert</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89046r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89048r48"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">>=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89049r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">next_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89050r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\^=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89051r51"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89052r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89053r53"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free_id</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89054r54"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89055r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">process_buffer</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-89056r56"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<a 
 id="x1-89057r89"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.23   </span> <a 
 id="x1-9000023"></a>Driver notifications</h4>
<!--l. 336--><p class="noindent" >The driver is sometimes required to send an available buffer notification to the
device.
<!--l. 339--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has not been negotiated, this notification
involves sending the virtqueue number to the device (method depending on the
transport).
<!--l. 343--><p class="noindent" >However, some devices benefit from the ability to find out the amount of available
data in the queue without accessing the virtqueue in memory: for efficiency or as a
debugging aid.
<!--l. 347--><p class="noindent" >To help with these optimizations, when VIRTIO_F_NOTIFICATION_DATA
has been negotiated, driver notifications to the device include the following
information:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">vqn</span> </dt><dd 
class="description">VQ number to be notified.
     </dd><dt class="description">
<span 
class="aebx-10">next_off</span> </dt><dd 
class="description">Offset  within  the  ring  where  the  next  available  ring  entry  will
     be written. When VIRTIO_F_RING_PACKED has not been negotiated
     this refers to the 15 least significant bits of the available index. When
     VIRTIO_F_RING_PACKED has been negotiated this refers to the offset
                                                                  

                                                                  
     (in units of descriptor entries) within the descriptor ring where the next
     available descriptor will be written.
     </dd><dt class="description">
<span 
class="aebx-10">next_wrap</span> </dt><dd 
class="description">Wrap  Counter.  With  VIRTIO_F_RING_PACKED  this  is  the
     wrap  counter  referring  to  the  next  available  descriptor.  Without
     VIRTIO_F_RING_PACKED this is the most significant bit (bit 15) of the
     available index.</dd></dl>
<!--l. 369--><p class="noindent" >Note that the driver can send multiple notifications even without making any
more buffers available. When VIRTIO_F_NOTIFICATION_DATA has been
negotiated, these notifications would then have identical <span 
class="aeti-10">next_off  </span>and <span 
class="aeti-10">next_wrap</span>
values.
<a 
 id="x1-90001r61"></a>
<h3 class="sectionHead"><span class="titlemark">2.8   </span> <a 
 id="x1-910008"></a>Shared Memory Regions</h3>
<!--l. 3--><p class="noindent" >Shared memory regions are an additional facility available to devices that
need a region of memory that’s continuously shared between the device and
the driver, rather than passed between them in the way virtqueue elements
are.
<!--l. 8--><p class="noindent" >Example uses include shared caches and version pools for versioned data
structures.
<!--l. 11--><p class="noindent" >The memory region is allocated by the device and presented to the driver. Where the
device is implemented in software on a host, this arrangement allows the memory
region to be allocated by a library on the host, which the device may not have full
control over.
<!--l. 17--><p class="noindent" >A device may have multiple shared memory regions associated with it. Each region
has a <span 
class="aeti-10">shmid </span>to identify it, the meaning of which is device-specific.
<!--l. 21--><p class="noindent" >Enumeration and location of shared memory regions is performed in a transport-specific
way.
<!--l. 24--><p class="noindent" >Memory consistency rules vary depending on the region and the device and they will
be specified as required by each device.
<a 
 id="x1-91001r90"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.1   </span> <a 
 id="x1-920001"></a>Addressing within regions</h4>
<!--l. 29--><p class="noindent" >References into shared memory regions are represented as offsets from the beginning
of the region instead of absolute memory addresses. Offsets are used both for
references between structures stored within shared memory and for requests placed in
virtqueues that refer to shared memory. The <span 
class="aeti-10">shmid </span>may be explicit or may be
inferred from the context of the reference.
<a 
 id="x1-92001r92"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">2.8.2   </span> <a 
 id="x1-930002"></a>Device Requirements: Shared Memory Regions</h4>
<!--l. 39--><p class="noindent" >Shared memory regions MUST NOT expose shared memory regions which are used
to control the operation of the device, nor to stream data.
                                                                  

                                                                  
<!--l. 376--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">3</span> <a 
 id="x1-940003"></a>General Initialization And Device Operation</h2>
We start with an overview of device initialization, then expand on the details of the
device and how each step is preformed. This section is best read along with the
bus-specific section which describes how to communicate with the specific
device.
<a 
 id="x1-94001r91"></a>
<h3 class="sectionHead"><span class="titlemark">3.1   </span> <a 
 id="x1-950001"></a>Device Initialization</h3>
<a 
 id="x1-95001r93"></a>
<h4 class="subsectionHead"><span class="titlemark">3.1.1   </span> <a 
 id="x1-960001"></a>Driver Requirements: Device Initialization</h4>
<!--l. 386--><p class="noindent" >The driver MUST follow this sequence to initialize a device:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-96002x1">Reset the device.
     </li>
     <li 
  class="enumerate" id="x1-96004x2">Set the ACKNOWLEDGE status bit: the guest OS has noticed the device.
     </li>
     <li 
  class="enumerate" id="x1-96006x3">Set the DRIVER status bit: the guest OS knows how to drive the device.
     </li>
     <li 
  class="enumerate" id="x1-96008x4"><a 
 id="x1-960074"></a> Read device feature bits, and write the subset of feature bits understood
     by the OS and driver to the device. During this step the driver MAY read
     (but MUST NOT write) the device-specific configuration fields to check
     that it can support the device before accepting it.
     </li>
     <li 
  class="enumerate" id="x1-96010x5"><a 
 id="x1-960095"></a> Set the FEATURES_OK status bit. The driver MUST NOT accept new
     feature bits after this step.
     </li>
     <li 
  class="enumerate" id="x1-96012x6"><a 
 id="x1-960116"></a> Re-read  <span 
class="aeti-10">device  status  </span>to  ensure  the  FEATURES_OK  bit  is  still  set:
     otherwise, the device does not support our subset of features and the
     device is unusable.
     </li>
     <li 
  class="enumerate" id="x1-96014x7"><a 
 id="x1-960137"></a> Perform device-specific setup, including discovery of virtqueues for the
     device, optional per-bus setup, reading and possibly writing the device’s
     virtio configuration space, and population of virtqueues.
     </li>
     <li 
  class="enumerate" id="x1-96016x8"><a 
 id="x1-960158"></a> Set the DRIVER_OK status bit. At this point the device is “live”.</li></ol>
<!--l. 415--><p class="noindent" >If any of these steps go irrecoverably wrong, the driver SHOULD set the FAILED
status bit to indicate that it has given up on the device (it can reset the device later
to restart if desired). The driver MUST NOT continue initialization in that
case.
                                                                  

                                                                  
<!--l. 420--><p class="noindent" >The driver MUST NOT send any buffer available notifications to the device before
setting DRIVER_OK.
<a 
 id="x1-96017r96"></a>
<h4 class="subsectionHead"><span class="titlemark">3.1.2   </span> <a 
 id="x1-970002"></a>Legacy Interface: Device Initialization</h4>
<!--l. 424--><p class="noindent" >Legacy devices did not support the FEATURES_OK status bit, and thus did not
have a graceful way for the device to indicate unsupported feature combinations.
They also did not provide a clear mechanism to end feature negotiation,
which meant that devices finalized features on first-use, and no features
could be introduced which radically changed the initial operation of the
device.
<!--l. 431--><p class="noindent" >Legacy driver implementations often used the device before setting the DRIVER_OK
bit, and sometimes even before writing the feature bits to the device.
<!--l. 435--><p class="noindent" >The result was the steps <a 
href="#x1-960095">5<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set FEATURES-OK --></a> and <a 
href="#x1-960116">6<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Re-read FEATURES-OK --></a> were omitted, and steps <a 
href="#x1-960074">4<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Read feature bits --></a>, <a 
href="#x1-960137">7<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Device-specific Setup --></a> and <a 
href="#x1-960158">8<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set DRIVER-OK --></a> were
conflated.
<!--l. 444--><p class="noindent" >Therefore, when using the legacy interface:
     <ul class="itemize1">
     <li class="itemize">The  transitional  driver  MUST  execute  the  initialization  sequence  as
     described in <a 
href="#x1-950001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> but omitting the steps <a 
href="#x1-960095">5<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set FEATURES-OK --></a> and <a 
href="#x1-960116">6<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Re-read FEATURES-OK --></a>.
     </li>
     <li class="itemize">The  transitional  device  MUST  support  the  driver  writing  device
     configuration fields before the step <a 
href="#x1-960074">4<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Read feature bits --></a>.
     </li>
     <li class="itemize">The transitional device MUST support the driver using the device before
     the step <a 
href="#x1-960158">8<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set DRIVER-OK --></a>.</li></ul>
<a 
 id="x1-97001r95"></a>
<h3 class="sectionHead"><span class="titlemark">3.2   </span> <a 
 id="x1-980002"></a>Device Operation</h3>
<!--l. 468--><p class="noindent" >When operating the device, each field in the device configuration space can be
changed by either the driver or the device.
<!--l. 471--><p class="noindent" >Whenever such a configuration change is triggered by the device, driver is notified.
This makes it possible for drivers to cache device configuration, avoiding expensive
configuration reads unless notified.
<a 
 id="x1-98001r97"></a>
<h4 class="subsectionHead"><span class="titlemark">3.2.1   </span> <a 
 id="x1-990001"></a>Notification of Device Configuration Changes</h4>
<!--l. 479--><p class="noindent" >For devices where the device-specific configuration information can be changed, a
configuration change notification is sent when a device-specific configuration change
occurs.
                                                                  

                                                                  
<!--l. 483--><p class="noindent" >In addition, this notification is triggered by the device setting DEVICE_NEEDS_RESET
(see <a 
href="#x1-120002">2.1.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Status Field / DEVICENEEDSRESET --></a>).
<a 
 id="x1-99001r98"></a>
<h3 class="sectionHead"><span class="titlemark">3.3   </span> <a 
 id="x1-1000003"></a>Device Cleanup</h3>
<!--l. 488--><p class="noindent" >Once the driver has set the DRIVER_OK status bit, all the configured virtqueue of
the device are considered live. None of the virtqueues of a device are live once the
device has been reset.
<a 
 id="x1-100001r99"></a>
<h4 class="subsectionHead"><span class="titlemark">3.3.1   </span> <a 
 id="x1-1010001"></a>Driver Requirements: Device Cleanup</h4>
<!--l. 494--><p class="noindent" >A driver MUST NOT alter virtqueue entries for exposed buffers, i.e., buffers which
have been made available to the device (and not been used by the device) of a live
virtqueue.
<!--l. 499--><p class="noindent" >Thus a driver MUST ensure a virtqueue isn’t live (by device reset) before removing
exposed buffers.
                                                                  

                                                                  
<!--l. 501--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">4</span> <a 
 id="x1-1020004"></a>Virtio Transport Options</h2>
Virtio can use various different buses, thus the standard is split into virtio general
and bus-specific sections.
<a 
 id="x1-102001r100"></a>
<h3 class="sectionHead"><span class="titlemark">4.1   </span> <a 
 id="x1-1030001"></a>Virtio Over PCI Bus</h3>
<!--l. 508--><p class="noindent" >Virtio devices are commonly implemented as PCI devices.
<!--l. 510--><p class="noindent" >A Virtio device can be implemented as any kind of PCI device: a Conventional PCI
device or a PCI Express device. To assure designs meet the latest level requirements,
see the PCI-SIG home page at <a 
href="http://www.pcisig.com" class="url" >http://www.pcisig.com</a> for any approved
changes.
<a 
 id="x1-103001r101"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.1   </span> <a 
 id="x1-1040001"></a>Device Requirements: Virtio Over PCI Bus</h4>
<!--l. 518--><p class="noindent" >A Virtio device using Virtio Over PCI Bus MUST expose to guest an interface that
meets the specification requirements of the appropriate PCI specification: <a 
href="#x1-3001r1">[PCI]</a> and
<a 
href="#x1-3001r1">[PCIe]</a> respectively.
<a 
 id="x1-104001r104"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.2   </span> <a 
 id="x1-1050002"></a>PCI Device Discovery</h4>
<!--l. 526--><p class="noindent" >Any PCI device with PCI Vendor ID 0x1AF4, and PCI Device ID 0x1000 through
0x107F inclusive is a virtio device. The actual value within this range indicates which
virtio device is supported by the device. The PCI Device ID is calculated by adding
0x1040 to the Virtio Device ID, as indicated in section <a 
href="#x1-1980005">5<!--tex4ht:ref: sec:Device Types --></a>. Additionally, devices MAY
utilize a Transitional PCI Device ID range, 0x1000 to 0x103F depending on the
device type.
<a 
 id="x1-105001r87"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.1   </span> <a 
 id="x1-1060001"></a>Device Requirements: PCI Device Discovery</h5>
<!--l. 536--><p class="noindent" >Devices MUST have the PCI Vendor ID 0x1AF4. Devices MUST either have the PCI
Device ID calculated by adding 0x1040 to the Virtio Device ID, as indicated in
section <a 
href="#x1-1980005">5<!--tex4ht:ref: sec:Device Types --></a> or have the Transitional PCI Device ID depending on the device type, as
follows:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Transitional PCI Device ID  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Virtio Device              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0x1000 </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >network card</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1001                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         block device               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1002                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > memory ballooning (traditional)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1003                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            console                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1004                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          SCSI host                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1005                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         entropy source             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1009                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         9P transport               </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-9"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 562--><p class="noindent" >For example, the network card device with the Virtio Device ID 1 has the PCI Device
ID 0x1041 or the Transitional PCI Device ID 0x1000.
                                                                  

                                                                  
<!--l. 565--><p class="noindent" >The PCI Subsystem Vendor ID and the PCI Subsystem Device ID MAY reflect the
PCI Vendor and Device ID of the environment (for informational purposes by the
driver).
<!--l. 568--><p class="noindent" >Non-transitional devices SHOULD have a PCI Device ID in the range 0x1040 to
0x107f. Non-transitional devices SHOULD have a PCI Revision ID of 1 or higher.
Non-transitional devices SHOULD have a PCI Subsystem Device ID of 0x40 or
higher.
<!--l. 573--><p class="noindent" >This is to reduce the chance of a legacy driver attempting to drive the device.
<a 
 id="x1-106001r106"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.2   </span> <a 
 id="x1-1070002"></a>Driver Requirements: PCI Device Discovery</h5>
<!--l. 577--><p class="noindent" >Drivers MUST match devices with the PCI Vendor ID 0x1AF4 and the PCI Device
ID in the range 0x1040 to 0x107f, calculated by adding 0x1040 to the Virtio Device
ID, as indicated in section <a 
href="#x1-1980005">5<!--tex4ht:ref: sec:Device Types --></a>. Drivers for device types listed in section <a 
href="#x1-1050002">4.1.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a> MUST
match devices with the PCI Vendor ID 0x1AF4 and the Transitional PCI Device ID
indicated in section <a 
href="#x1-1050002">4.1.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>.
<!--l. 588--><p class="noindent" >Drivers MUST match any PCI Revision ID value. Drivers MAY match any PCI
Subsystem Vendor ID and any PCI Subsystem Device ID value.
<a 
 id="x1-107001r107"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.3   </span> <a 
 id="x1-1080003"></a>Legacy Interfaces: A Note on PCI Device Discovery</h5>
<!--l. 593--><p class="noindent" >Transitional devices MUST have a PCI Revision ID of 0. Transitional devices MUST
have the PCI Subsystem Device ID matching the Virtio Device ID, as indicated in
section <a 
href="#x1-1980005">5<!--tex4ht:ref: sec:Device Types --></a>. Transitional devices MUST have the Transitional PCI Device ID in the
range 0x1000 to 0x103f.
<!--l. 599--><p class="noindent" >This is to match legacy drivers.
<a 
 id="x1-108001r105"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.3   </span> <a 
 id="x1-1090003"></a>PCI Device Layout</h4>
<!--l. 603--><p class="noindent" >The device is configured via I/O and/or memory regions (though see <a 
href="#x1-1270008">4.1.4.8<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a> for
access via the PCI configuration space), as specified by Virtio Structure PCI
Capabilities.
<!--l. 608--><p class="noindent" >Fields of different sizes are present in the device configuration regions. All 64-bit,
32-bit and 16-bit fields are little-endian. 64-bit fields are to be treated as two 32-bit
fields, with low 32 bit part followed by the high 32 bit part.
<a 
 id="x1-109001r108"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.3.1   </span> <a 
 id="x1-1100001"></a>Driver Requirements: PCI Device Layout</h5>
<!--l. 616--><p class="noindent" >For device configuration access, the driver MUST use 8-bit wide accesses for 8-bit
wide fields, 16-bit wide and aligned accesses for 16-bit wide fields and 32-bit
wide and aligned accesses for 32-bit and 64-bit wide fields. For 64-bit fields,
                                                                  

                                                                  
the driver MAY access each of the high and low 32-bit parts of the field
independently.
<a 
 id="x1-110001r110"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.3.2   </span> <a 
 id="x1-1110002"></a>Device Requirements: PCI Device Layout</h5>
<!--l. 625--><p class="noindent" >For 64-bit device configuration fields, the device MUST allow driver independent
access to high and low 32-bit parts of the field.
<a 
 id="x1-111001r109"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.4   </span> <a 
 id="x1-1120004"></a>Virtio Structure PCI Capabilities</h4>
<!--l. 630--><p class="noindent" >The virtio device configuration layout includes several structures:
     <ul class="itemize1">
     <li class="itemize">Common configuration
     </li>
     <li class="itemize">Notifications
     </li>
     <li class="itemize">ISR Status
     </li>
     <li class="itemize">Device-specific configuration (optional)
     </li>
     <li class="itemize">PCI configuration access</li></ul>
<!--l. 639--><p class="noindent" >Each structure can be mapped by a Base Address register (BAR) belonging to the
function, or accessed via the special VIRTIO_PCI_CAP_PCI_CFG field in the PCI
configuration space.
<!--l. 642--><p class="noindent" >The location of each structure is specified using a vendor-specific PCI capability
located on the capability list in PCI configuration space of the device. This virtio
structure capability uses little-endian format; all fields are read-only for the driver
unless stated otherwise:
<!--l. 647-->
<div class="lstlisting" id="listing-24"><span class="label"><a 
 id="x1-112001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_vndr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI_CAP_ID_VNDR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ptr</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capability</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cfg_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Identifies</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structure</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bar</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Where</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">find</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Multiple</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capabilities</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">same</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[2];</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Pad</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">full</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dword</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">within</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bar</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structure</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112011r11"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 661--><p class="noindent" >This structure can be followed by extra data, depending on <span 
class="aeti-10">cfg_type</span>, as documented
below.
<!--l. 664--><p class="noindent" >The fields are interpreted as follows:
     <dl class="description"><dt class="description">
<span 
class="aebxti-10">cap_vndr</span> </dt><dd 
class="description">0x09; Identifies a vendor-specific capability.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebxti-10">cap_next</span> </dt><dd 
class="description">Link to next capability in the capability list in the PCI configuration
     space.
     </dd><dt class="description">
<span 
class="aebxti-10">cap_len</span> </dt><dd 
class="description">Length  of  this  capability  structure,  including  the  whole  of  struct
     virtio_pci_cap, and extra data if any. This length MAY include padding,
     or fields unused by the driver.
     </dd><dt class="description">
<span 
class="aebxti-10">cfg_type</span> </dt><dd 
class="description">identifies the structure, according to the following table:
     <!--l. 681-->
     <div class="lstlisting" id="listing-25"><span class="label"><a 
 id="x1-112012r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Common</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112013r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_COMMON_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112014r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Notifications</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112015r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_NOTIFY_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112016r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ISR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112017r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_ISR_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112018r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112019r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_DEVICE_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112020r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">access</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112021r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_PCI_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112022r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Shared</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">memory</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">region</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112023r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_SHARED_MEMORY_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span>
     
     </div>
     <!--l. 696--><p class="noindent" >Any other value is reserved for future use.
     <!--l. 698--><p class="noindent" >Each structure is detailed individually below.
     <!--l. 700--><p class="noindent" >The device MAY offer more than one structure of any type - this makes it
     possible for the device to expose multiple interfaces to drivers. The order of the
     capabilities in the capability list specifies the order of preference suggested by
     the device. A device may specify that this ordering mechanism be overridden by
     the use of the <span 
class="aeti-10">id </span>field.
     <span 
class="aebx-10">Note:</span> For   example,   on   some   hypervisors,   notifications   using   IO
           accesses  are  faster  than  memory  accesses.  In  this  case,  the
           device  would  expose  two  capabilities  with  <span 
class="aeti-10">cfg_type   </span>set  to
           VIRTIO_PCI_CAP_NOTIFY_CFG:  the  first  one  addressing  an
           I/O  BAR,  the  second  one  addressing  a  memory  BAR.  In  this
           example, the driver would use the I/O BAR if I/O resources are
           available, and fall back on memory BAR when I/O resources are
           unavailable.
     </dd><dt class="description">
<span 
class="aebxti-10">bar</span> </dt><dd 
class="description">values 0x0 to 0x5 specify a Base Address register (BAR) belonging to the
     function located beginning at 10h in PCI Configuration Space and
     used to map the structure into Memory or I/O Space. The BAR is
     permitted to be either 32-bit or 64-bit, it can map Memory Space or I/O
     Space.
     <!--l. 721--><p class="noindent" >Any other value is reserved for future use.
     </dd><dt class="description">
<span 
class="aebxti-10">id</span> </dt><dd 
class="description">Used by some device types to uniquely identify multiple capabilities of a certain
     type. If the device type does not specify the meaning of this field, its contents
     are undefined.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebxti-10">offset</span> </dt><dd 
class="description">indicates where the structure begins relative to the base address associated
     with the BAR. The alignment requirements of <span 
class="aeti-10">offset </span>are indicated in each
     structure-specific section below.
     </dd><dt class="description">
<span 
class="aebxti-10">length</span> </dt><dd 
class="description">indicates the length of the structure.
     <!--l. 737--><p class="noindent" ><span 
class="aeti-10">length </span>MAY include padding, or fields unused by the driver, or future
     extensions.
     <span 
class="aebx-10">Note:</span> For example, a future device might present a large structure size of
           several MBytes. As current devices never utilize structures larger
           than 4KBytes in size, driver MAY limit the mapped structure size
           to e.g. 4KBytes (thus ignoring parts of structure after the first
           4KBytes) to allow forward compatibility with such devices without
           loss of functionality and without wasting resources.
     </dd></dl>
<!--l. 751--><p class="noindent" >A variant of this type, struct virtio_pci_cap64, is defined for those capaibilites that
require offsets or lengths larger than 4GiB:
<!--l. 755-->
<div class="lstlisting" id="listing-26"><span class="label"><a 
 id="x1-112024r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112025r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112026r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset_hi</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112027r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length_hi</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-112028r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 763--><p class="noindent" >Given that the <span 
class="aeti-10">cap.length </span>and <span 
class="aeti-10">cap.offset </span>fields are only 32 bit, the additional <span 
class="aeti-10">offset_hi</span>
and <span 
class="aeti-10">length_hi </span>fields provide the most significant 32 bits of a total 64 bit offset and
length within the bar specified by <span 
class="aeti-10">cap.bar</span>.
<a 
 id="x1-112029r111"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.1   </span> <a 
 id="x1-1130001"></a>Driver Requirements: Virtio Structure PCI Capabilities</h5>
<!--l. 770--><p class="noindent" >The driver MUST ignore any vendor-specific capability structure which has a
reserved <span 
class="aeti-10">cfg_type </span>value.
<!--l. 773--><p class="noindent" >The driver SHOULD use the first instance of each virtio structure type they can
support.
<!--l. 776--><p class="noindent" >The driver MUST accept a <span 
class="aeti-10">cap_len </span>value which is larger than specified here.
<!--l. 778--><p class="noindent" >The driver MUST ignore any vendor-specific capability structure which has a
reserved <span 
class="aeti-10">bar </span>value.
<!--l. 781--><p class="noindent" >The drivers SHOULD only map part of configuration structure large enough for
device operation. The drivers MUST handle an unexpectedly large <span 
class="aeti-10">length</span>, but MAY
check that <span 
class="aeti-10">length </span>is large enough for device operation.
                                                                  

                                                                  
<!--l. 786--><p class="noindent" >The driver MUST NOT write into any field of the capability structure, with the
exception of those with <span 
class="aeti-10">cap_type </span>VIRTIO_PCI_CAP_PCI_CFG as detailed in
<a 
href="#x1-1290002">4.1.4.8.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>.
<a 
 id="x1-113001r113"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.2   </span> <a 
 id="x1-1140002"></a>Device Requirements: Virtio Structure PCI Capabilities</h5>
<!--l. 792--><p class="noindent" >The device MUST include any extra data (from the beginning of the <span 
class="aeti-10">cap_vndr </span>field
through end of the extra data fields if any) in <span 
class="aeti-10">cap_len</span>. The device MAY append extra
data or padding to any structure beyond that.
<!--l. 797--><p class="noindent" >If the device presents multiple structures of the same type, it SHOULD order them
from optimal (first) to least-optimal (last).
<a 
 id="x1-114001r114"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.3   </span> <a 
 id="x1-1150003"></a>Common configuration structure layout</h5>
<!--l. 802--><p class="noindent" >The common configuration structure is found at the <span 
class="aeti-10">bar </span>and <span 
class="aeti-10">offset </span>within the
VIRTIO_PCI_CAP_COMMON_CFG capability; its layout is below.
<!--l. 804-->
<div class="lstlisting" id="listing-27"><span class="label"><a 
 id="x1-115001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_common_cfg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">About</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">whole</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_feature_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_feature</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver_feature_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver_feature</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">msix_config</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">config_generation</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">About</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_msix_vector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_enable</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_driver</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_device</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-115021r21"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
     <dl class="description"><dt class="description">
<span 
class="aebxti-10">device_feature_select</span> </dt><dd 
class="description">The  driver  uses  this  to  select  which  feature  bits
     <span 
class="aeti-10">device_feature </span>shows. Value 0x0 selects Feature Bits 0 to 31, 0x1 selects
     Feature Bits 32 to 63, etc.
     </dd><dt class="description">
<span 
class="aebxti-10">device_feature</span> </dt><dd 
class="description">The device uses this to report which feature bits it is offering to
     the driver: the driver writes to <span 
class="aeti-10">device_feature_select </span>to select which feature
     bits are presented.
     </dd><dt class="description">
<span 
class="aebxti-10">driver_feature_select</span> </dt><dd 
class="description">The  driver  uses  this  to  select  which  feature  bits
     <span 
class="aeti-10">driver_feature </span>shows. Value 0x0 selects Feature Bits 0 to 31, 0x1 selects
     Feature Bits 32 to 63, etc.
     </dd><dt class="description">
<span 
class="aebxti-10">driver_feature</span> </dt><dd 
class="description">The driver writes this to accept feature bits offered by the
     device. Driver Feature Bits selected by <span 
class="aeti-10">driver_feature_select</span>.
     </dd><dt class="description">
<span 
class="aebxti-10">config_msix_vector</span> </dt><dd 
class="description">The driver sets the Configuration Vector for MSI-X.
     </dd><dt class="description">
<span 
class="aebxti-10">num_queues</span> </dt><dd 
class="description">The  device  specifies  the  maximum  number  of  virtqueues
     supported here.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebxti-10">device_status</span> </dt><dd 
class="description">The driver writes the device status here (see <a 
href="#x1-100001">2.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Status Field --></a>). Writing 0 into
     this field resets the device.
     </dd><dt class="description">
<span 
class="aebxti-10">config_generation</span> </dt><dd 
class="description">Configuration  atomicity  value.  The  device  changes  this
     every time the configuration noticeably changes.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_select</span> </dt><dd 
class="description">Queue Select. The driver selects which virtqueue the following
     fields refer to.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_size</span> </dt><dd 
class="description">Queue Size. On reset, specifies the maximum queue size supported
     by  the  device.  This  can  be  modified  by  the  driver  to  reduce  memory
     requirements. A 0 means the queue is unavailable.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_msix_vector</span> </dt><dd 
class="description">The driver uses this to specify the queue vector for MSI-X.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_enable</span> </dt><dd 
class="description">The  driver  uses  this  to  selectively  prevent  the  device  from
     executing requests from this virtqueue. 1 - enabled; 0 - disabled.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_notify_off</span> </dt><dd 
class="description">The driver reads this to calculate the offset from start of
     Notification structure at which this virtqueue is located.
     <span 
class="aebx-10">Note:</span> this is <span 
class="aeti-10">not an offset in bytes. See </span><a 
href="#x1-1180004"><span 
class="aeti-10">4.1.4.4</span><!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a> <span 
class="aeti-10">below.</span>
     </dd><dt class="description">
<span 
class="aebxti-10">queue_desc</span> </dt><dd 
class="description">The driver writes the physical address of Descriptor Area here. See
     section <a 
href="#x1-230005">2.5<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_driver</span> </dt><dd 
class="description">The driver writes the physical address of Driver Area here. See
     section <a 
href="#x1-230005">2.5<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_device</span> </dt><dd 
class="description">The driver writes the physical address of Device Area here. See
     section <a 
href="#x1-230005">2.5<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.</dd></dl>
<a 
 id="x1-115022r88"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.3.1</span> <a 
 id="x1-1160001"></a>Device Requirements: Common configuration structure layout</h5>
<span 
class="aeti-10">offset </span>MUST be 4-byte aligned.
<!--l. 896--><p class="noindent" >The device MUST present at least one common configuration capability.
<!--l. 898--><p class="noindent" >The device MUST present the feature bits it is offering in <span 
class="aeti-10">device_feature</span>, starting at
bit <span 
class="aeti-10">device_feature_select </span><span 
class="cmsy-10">∗ </span>32 for any <span 
class="aeti-10">device_feature_select </span>written by the
                                                                  

                                                                  
driver.
<span 
class="aebx-10">Note:</span> This means that it will present 0 for any <span 
class="aeti-10">device_feature_select </span>other than
      0 or 1, since no feature defined here exceeds 63.
<!--l. 903--><p class="noindent" >The device MUST present any valid feature bits the driver has written in
<span 
class="aeti-10">driver_feature</span>, starting at bit <span 
class="aeti-10">driver_feature_select </span><span 
class="cmsy-10">∗ </span>32 for any <span 
class="aeti-10">driver_feature_select</span>
written by the driver. Valid feature bits are those which are subset of the
corresponding <span 
class="aeti-10">device_feature </span>bits. The device MAY present invalid bits written by the
driver.
<span 
class="aebx-10">Note:</span> This means that a device can ignore writes for feature bits it never
      offers, and simply present 0 on reads. Or it can just mirror what the
      driver wrote (but it will still have to check them when the driver sets
      FEATURES_OK).
<span 
class="aebx-10">Note:</span> A  driver  shouldn’t  write  invalid  bits  anyway,  as  per  <a 
href="#x1-960001">3.1.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Initialization --></a>,  but  this
      attempts to handle it.
<!--l. 915--><p class="noindent" >The device MUST present a changed <span 
class="aeti-10">config_generation </span>after the driver has read a
device-specific configuration value which has changed since any part of the
device-specific configuration was last read.
<span 
class="aebx-10">Note:</span> As <span 
class="aeti-10">config_generation </span>is an 8-bit value, simply incrementing it on every
      configuration change could violate this requirement due to wrap. Better
      would be to set an internal flag when it has changed, and if that flag is set
      when the driver reads from the device-specific configuration, increment
      <span 
class="aeti-10">config_generation </span>and clear the flag.
<!--l. 927--><p class="noindent" >The device MUST reset when 0 is written to <span 
class="aeti-10">device_status</span>, and present a 0 in
<span 
class="aeti-10">device_status </span>once that is done.
<!--l. 930--><p class="noindent" >The device MUST present a 0 in <span 
class="aeti-10">queue_enable </span>on reset.
<!--l. 932--><p class="noindent" >The device MUST present a 0 in <span 
class="aeti-10">queue_size </span>if the virtqueue corresponding to the
current <span 
class="aeti-10">queue_select </span>is unavailable.
<!--l. 935--><p class="noindent" >If VIRTIO_F_RING_PACKED has not been negotiated, the device MUST present
either a value of 0 or a power of 2 in <span 
class="aeti-10">queue_size</span>.
<a 
 id="x1-116001r116"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.3.2</span> <a 
 id="x1-1170002"></a>Driver Requirements: Common configuration structure layout</h5>
The driver MUST NOT write to <span 
class="aeti-10">device_feature</span>, <span 
class="aeti-10">num_queues</span>, <span 
class="aeti-10">config_generation </span>or
<span 
class="aeti-10">queue_notify_off</span>.
<!--l. 943--><p class="noindent" >If VIRTIO_F_RING_PACKED has been negotiated, the driver MUST NOT
                                                                  

                                                                  
write the value 0 to <span 
class="aeti-10">queue_size</span>. If VIRTIO_F_RING_PACKED has not been
negotiated, the driver MUST NOT write a value which is not a power of 2 to
<span 
class="aeti-10">queue_size</span>.
<!--l. 948--><p class="noindent" >The driver MUST configure the other virtqueue fields before enabling the virtqueue
with <span 
class="aeti-10">queue_enable</span>.
<!--l. 951--><p class="noindent" >After writing 0 to <span 
class="aeti-10">device_status</span>, the driver MUST wait for a read of <span 
class="aeti-10">device_status </span>to
return 0 before reinitializing the device.
<!--l. 954--><p class="noindent" >The driver MUST NOT write a 0 to <span 
class="aeti-10">queue_enable</span>.
<a 
 id="x1-117001r115"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.4   </span> <a 
 id="x1-1180004"></a>Notification structure layout</h5>
<!--l. 958--><p class="noindent" >The notification location is found using the VIRTIO_PCI_CAP_NOTIFY_CFG
capability. This capability is immediately followed by an additional field, like
so:
<!--l. 962-->
<div class="lstlisting" id="listing-28"><span class="label"><a 
 id="x1-118001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_notify_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-118002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-118003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-118004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 969--><p class="noindent" ><span 
class="aeti-10">notify_off_multiplier </span>is combined with the <span 
class="aeti-10">queue_notify_off  </span>to derive the Queue
Notify address within a BAR for a virtqueue:
<!--l. 972-->
<div class="lstlisting" id="listing-29"><span class="label"><a 
 id="x1-118005r1"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span>
</div>
<!--l. 976--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>and <span 
class="aeti-10">notify_off_multiplier </span>are taken from the notification capability
structure above, and the <span 
class="aeti-10">queue_notify_off </span>is taken from the common configuration
structure.
<span 
class="aebx-10">Note:</span> For  example,  if  <span 
class="aeti-10">notifier_off_multiplier  </span>is  0,  the  device  uses  the  same
      Queue Notify address for all queues.
<a 
 id="x1-118006r117"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.4.1</span> <a 
 id="x1-1190001"></a>Device Requirements: Notification capability</h5>
The device MUST present at least one notification capability.
<!--l. 988--><p class="noindent" >For devices not offering VIRTIO_F_NOTIFICATION_DATA:
<!--l. 990--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 2-byte aligned.
                                                                  

                                                                  
<!--l. 992--><p class="noindent" >The device MUST either present <span 
class="aeti-10">notify_off_multiplier </span>as an even power of 2, or
present <span 
class="aeti-10">notify_off_multiplier </span>as 0.
<!--l. 995--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 2 and MUST be large
enough to support queue notification offsets for all supported queues in all possible
configurations.
<!--l. 999--><p class="noindent" >For all queues, the value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy:
<!--l. 1000-->
<div class="lstlisting" id="listing-30"><span class="label"><a 
 id="x1-119001r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">>=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 1004--><p class="noindent" >For devices offering VIRTIO_F_NOTIFICATION_DATA:
<!--l. 1006--><p class="noindent" >The device MUST either present <span 
class="aeti-10">notify_off_multiplier </span>as a number that is
a power of 2 that is also a multiple 4, or present <span 
class="aeti-10">notify_off_multiplier </span>as
0.
<!--l. 1010--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 4-byte aligned.
<!--l. 1012--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 4 and MUST be large
enough to support queue notification offsets for all supported queues in all possible
configurations.
<!--l. 1016--><p class="noindent" >For all queues, the value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy:
<!--l. 1017-->
<div class="lstlisting" id="listing-31"><span class="label"><a 
 id="x1-119002r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">>=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span>
</div>
<a 
 id="x1-119003r118"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.5   </span> <a 
 id="x1-1200005"></a>ISR status capability</h5>
<!--l. 1023--><p class="noindent" >The VIRTIO_PCI_CAP_ISR_CFG capability refers to at least a single byte,
which contains the 8-bit ISR status field to be used for INT#x interrupt
handling.
<!--l. 1027--><p class="noindent" >The <span 
class="aeti-10">offset </span>for the <span 
class="aeti-10">ISR status </span>has no alignment requirements.
<!--l. 1029--><p class="noindent" >The ISR bits allow the device to distinguish between device-specific configuration
change interrupts and normal virtqueue interrupts:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits       </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                      </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1                                         </td><td style="text-align: left; min-width: \@testpach 4 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2 to 31    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Queue Interrupt  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Configuration Interrupt  </td><td style="text-align: left; min-width: \@testpach 4 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
</div>
<!--l. 1040--><p class="noindent" >To avoid an extra access, simply reading this register resets it to 0 and causes the
device to de-assert the interrupt.
<!--l. 1043--><p class="noindent" >In this way, driver read of ISR status causes the device to de-assert an interrupt.
                                                                  

                                                                  
<!--l. 1046--><p class="noindent" >See sections <a 
href="#x1-1430003">4.1.5.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Used Buffer Notifications --></a> and <a 
href="#x1-1450004">4.1.5.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a> for how this is used.
<a 
 id="x1-120001r119"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.5.1</span> <a 
 id="x1-1210001"></a>Device Requirements: ISR status capability</h5>
The device MUST present at least one VIRTIO_PCI_CAP_ISR_CFG capability.
<!--l. 1052--><p class="noindent" >The device MUST set the Device Configuration Interrupt bit in <span 
class="aeti-10">ISR status </span>before
sending a device configuration change notification to the driver.
<!--l. 1056--><p class="noindent" >If MSI-X capability is disabled, the device MUST set the Queue Interrupt bit in <span 
class="aeti-10">ISR</span>
<span 
class="aeti-10">status </span>before sending a virtqueue notification to the driver.
<!--l. 1060--><p class="noindent" >If MSI-X capability is disabled, the device MUST set the Interrupt Status bit
in the PCI Status register in the PCI Configuration Header of the device
to the logical OR of all bits in <span 
class="aeti-10">ISR status </span>of the device. The device then
asserts/deasserts INT#x interrupts unless masked according to standard PCI rules
<a 
href="#x1-3001r1">[PCI]</a>.
<!--l. 1066--><p class="noindent" >The device MUST reset <span 
class="aeti-10">ISR status </span>to 0 on driver read.
<a 
 id="x1-121001r121"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.5.2</span> <a 
 id="x1-1220002"></a>Driver Requirements: ISR status capability</h5>
If MSI-X capability is enabled, the driver SHOULD NOT access <span 
class="aeti-10">ISR status </span>upon
detecting a Queue Interrupt.
<a 
 id="x1-122001r120"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.6   </span> <a 
 id="x1-1230006"></a>Device-specific configuration</h5>
<!--l. 1075--><p class="noindent" >The device MUST present at least one VIRTIO_PCI_CAP_DEVICE_CFG capability
for any device type which has a device-specific configuration.
<a 
 id="x1-123001r122"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.6.1</span> <a 
 id="x1-1240001"></a>Device Requirements: Device-specific configuration</h5>
The <span 
class="aeti-10">offset </span>for the device-specific configuration MUST be 4-byte aligned.
<a 
 id="x1-124001r123"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.7   </span> <a 
 id="x1-1250007"></a>Shared memory capability</h5>
<!--l. 1084--><p class="noindent" >Shared memory regions <a 
href="#x1-910008">2.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Shared Memory Regions --></a> are enumerated on the PCI transport as a sequence of
VIRTIO_PCI_CAP_SHARED_MEMORY_CFG capabilities, one per region.
<!--l. 1088--><p class="noindent" >The capability is defined by a struct virtio_pci_cap64 and utilises the <span 
class="aeti-10">cap.id </span>to allow
multiple shared memory regions per device. The identifier in <span 
class="aeti-10">cap.id </span>does not
denote a certain order of preference; it is only used to uniquely identify a
region.
<a 
 id="x1-125001r124"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">4.1.4.7.1</span> <a 
 id="x1-1260001"></a>Device Requirements: Device-specific configuration</h5>
The region defined by the combination of the <span 
class="aeti-10">cap.offset</span>, <span 
class="aeti-10">cap.offset_hi</span>, and <span 
class="aeti-10">cap.length</span>,
<span 
class="aeti-10">cap.length_hi </span>fields MUST be contained within the declared bar.
<!--l. 1100--><p class="noindent" >The <span 
class="aeti-10">cap.id </span>MUST be unique for any one device instance.
<a 
 id="x1-126001r125"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.8   </span> <a 
 id="x1-1270008"></a>PCI configuration access capability</h5>
<!--l. 1104--><p class="noindent" >The VIRTIO_PCI_CAP_PCI_CFG capability creates an alternative (and likely
suboptimal) access method to the common configuration, notification, ISR and
device-specific configuration regions.
<!--l. 1108--><p class="noindent" >The capability is immediately followed by an additional field like so:
<!--l. 1110-->
<div class="lstlisting" id="listing-32"><span class="label"><a 
 id="x1-127001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cfg_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pci_cfg_data</span><span 
class="pcrr8t-x-x-80">[4];</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BAR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">access</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1117--><p class="noindent" >The fields <span 
class="aeti-10">cap.bar</span>, <span 
class="aeti-10">cap.length</span>, <span 
class="aeti-10">cap.offset </span>and <span 
class="aeti-10">pci_cfg_data </span>are read-write (RW) for the
driver.
<!--l. 1120--><p class="noindent" >To access a device region, the driver writes into the capability structure (ie. within
the PCI configuration space) as follows:
     <ul class="itemize1">
     <li class="itemize">The driver sets the BAR to access by writing to <span 
class="aeti-10">cap.bar</span>.
     </li>
     <li class="itemize">The driver sets the size of the access by writing 1, 2 or 4 to <span 
class="aeti-10">cap.length</span>.
     </li>
     <li class="itemize">The driver sets the offset within the BAR by writing to <span 
class="aeti-10">cap.offset</span>.</li></ul>
<!--l. 1133--><p class="noindent" >At that point, <span 
class="aeti-10">pci_cfg_data </span>will provide a window of size <span 
class="aeti-10">cap.length </span>into the given
<span 
class="aeti-10">cap.bar </span>at offset <span 
class="aeti-10">cap.offset</span>.
<a 
 id="x1-127005r126"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.8.1</span> <a 
 id="x1-1280001"></a>Device Requirements: PCI configuration access capability</h5>
The device MUST present at least one VIRTIO_PCI_CAP_PCI_CFG capability.
<!--l. 1140--><p class="noindent" >Upon detecting driver write access to <span 
class="aeti-10">pci_cfg_data</span>, the device MUST execute a write
access at offset <span 
class="aeti-10">cap.offset </span>at BAR selected by <span 
class="aeti-10">cap.bar </span>using the first <span 
class="aeti-10">cap.length </span>bytes
from <span 
class="aeti-10">pci_cfg_data</span>.
<!--l. 1145--><p class="noindent" >Upon detecting driver read access to <span 
class="aeti-10">pci_cfg_data</span>, the device MUST execute a read
access of length cap.length at offset <span 
class="aeti-10">cap.offset </span>at BAR selected by <span 
class="aeti-10">cap.bar </span>and store
                                                                  

                                                                  
the first <span 
class="aeti-10">cap.length </span>bytes in <span 
class="aeti-10">pci_cfg_data</span>.
<a 
 id="x1-128001r128"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.8.2</span> <a 
 id="x1-1290002"></a>Driver Requirements: PCI configuration access capability</h5>
The driver MUST NOT write a <span 
class="aeti-10">cap.offset </span>which is not a multiple of <span 
class="aeti-10">cap.length </span>(ie. all
accesses MUST be aligned).
<!--l. 1156--><p class="noindent" >The driver MUST NOT read or write <span 
class="aeti-10">pci_cfg_data </span>unless <span 
class="aeti-10">cap.bar</span>, <span 
class="aeti-10">cap.length </span>and
<span 
class="aeti-10">cap.offset </span>address <span 
class="aeti-10">cap.length </span>bytes within a BAR range specified by some other
Virtio Structure PCI Capability of type other than <span 
class="aeti-10">VIRTIO_PCI_CAP_PCI_CFG</span>.
<a 
 id="x1-129001r127"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.9   </span> <a 
 id="x1-1300009"></a>Legacy Interfaces: A Note on PCI Device Layout</h5>
<!--l. 1164--><p class="noindent" >Transitional devices MUST present part of configuration registers in a legacy
configuration structure in BAR0 in the first I/O region of the PCI device, as
documented below. When using the legacy interface, transitional drivers MUST use
the legacy configuration structure in BAR0 in the first I/O region of the PCI device,
as documented below.
<!--l. 1171--><p class="noindent" >When using the legacy interface the driver MAY access the device-specific
configuration region using any width accesses, and a transitional device MUST
present driver with the same results as when accessed using the “natural” access
method (i.e. 32-bit accesses for 32-bit fields, etc).
<!--l. 1177--><p class="noindent" >Note that this is possible because while the virtio common configuration structure is
PCI (i.e. little) endian, when using the legacy interface the device-specific
configuration region is encoded in the native endian of the guest (where such
distinction is applicable).
<!--l. 1182--><p class="noindent" >When used through the legacy interface, the virtio common configuration structure
looks as follows:
<!--l. 1194--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Read
 /
 Write  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose</td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device
 Features
 bits
 0:31   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Driver
 Features
 bits
 0:31   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Queue
 Address</td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">queue_size</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ><span 
class="aeti-10">queue_select</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Queue
 Notify </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device
 Status </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > ISR <br 
class="newline" />Status </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       </td>
</tr></table>
<!--l. 1196--><p class="noindent" >If MSI-X is enabled for the device, two additional fields immediately follow this
header:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits                   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16                       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16                       </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Read/Write         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W                  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose (MSI-X)  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">config_msix_vector  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">queue_msix_vector  </span></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
                                                                  

                                                                  
<!--l. 1209--><p class="noindent" >Note: When MSI-X capability is enabled, device-specific configuration starts at byte
offset 24 in virtio common configuration structure structure. When MSI-X capability
is not enabled, device-specific configuration starts at byte offset 20 in virtio header.
ie. once you enable MSI-X on the device, the other fields move. If you turn it off
again, they move back!
<!--l. 1215--><p class="noindent" >Any device-specific configuration space immediately follows these general
headers:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <div class="multirow"><!-- rows=13 -->
…</div>  </td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >
</td></tr><tr 
class="cline"><td><hr></td><td><hr></td><td></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Read / Write  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >   </td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >
</td></tr><tr 
class="cline"><td><hr></td><td><hr></td><td></td></tr><tr class="row-5"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >   </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 1228--><p class="noindent" >When accessing the device-specific configuration space using the legacy interface,
transitional drivers MUST access the device-specific configuration space at an offset
immediately following the general headers.
<!--l. 1233--><p class="noindent" >When using the legacy interface, transitional devices MUST present the
device-specific configuration space if any at an offset immediately following the
general headers.
<!--l. 1237--><p class="noindent" >Note that only Feature Bits 0 to 31 are accessible through the Legacy Interface.
When used through the Legacy Interface, Transitional Devices MUST assume that
Feature Bits 32 to 63 are not acknowledged by Driver.
<!--l. 1242--><p class="noindent" >As legacy devices had no <span 
class="aeti-10">config_generation </span>field, see <a 
href="#x1-220004">2.4.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a> <a 
href="#x1-220004">Legacy Interface: Device
Configuration Space<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a> for workarounds.
<a 
 id="x1-130001r130"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.10   </span> <a 
 id="x1-13100010"></a>Non-transitional Device With Legacy Driver: A Note on PCI Device
Layout</h5>
<!--l. 1252--><p class="noindent" >All known legacy drivers check either the PCI Revision or the Device and Vendor
IDs, and thus won’t attempt to drive a non-transitional device.
<!--l. 1256--><p class="noindent" >A buggy legacy driver might mistakenly attempt to drive a non-transitional device. If
support for such drivers is required (as opposed to fixing the bug), the following
would be the recommended way to detect and handle them.
<span 
class="aebx-10">Note:</span> Such buggy drivers are not currently known to be used in production.
<a 
 id="x1-131001r1"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.4.10.0.1</span> <a 
 id="x1-1320001"></a>Device Requirements: Non-transitional Device With Legacy Driver</h6>
Non-transitional devices, on a platform where a legacy driver for a legacy device with
the same ID (including PCI Revision, Device and Vendor IDs) is known to have
previously existed, SHOULD take the following steps to cause the legacy driver to fail
gracefully when it attempts to drive them:
     <ol  class="enumerate1" >
                                                                  

                                                                  
     <li 
  class="enumerate" id="x1-132002x1">Present an I/O BAR in BAR0, and
     </li>
     <li 
  class="enumerate" id="x1-132004x2">Respond to a single-byte zero write to offset 18 (corresponding to Device
     Status register in the legacy layout) of BAR0 by presenting zeroes on every
     BAR and ignoring writes.</li></ol>
<a 
 id="x1-132005r112"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.5   </span> <a 
 id="x1-1330005"></a>PCI-specific Initialization And Device Operation</h4>
<a 
 id="x1-133001r131"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.1   </span> <a 
 id="x1-1340001"></a>Device Initialization</h5>
<!--l. 1292--><p class="noindent" >This documents PCI-specific steps executed during Device Initialization.
<a 
 id="x1-134001r129"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.1</span> <a 
 id="x1-1350001"></a>Virtio Device Configuration Layout Detection</h5>
As a prerequisite to device initialization, the driver scans the PCI capability list,
detecting virtio configuration layout using Virtio Structure PCI capabilities as
detailed in <a 
href="#x1-1120004">4.1.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
<a 
 id="x1-135001r132"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.1.1</span> <a 
 id="x1-1360001"></a>Legacy Interface: A Note on Device Layout Detection</h6>
Legacy drivers skipped the Device Layout Detection step, assuming legacy device
configuration space in BAR0 in I/O space unconditionally.
<!--l. 1305--><p class="noindent" >Legacy devices did not have the Virtio PCI Capability in their capability
list.
<!--l. 1308--><p class="noindent" >Therefore:
<!--l. 1310--><p class="noindent" >Transitional devices MUST expose the Legacy Interface in I/O space in
BAR0.
<!--l. 1313--><p class="noindent" >Transitional drivers MUST look for the Virtio PCI Capabilities on the capability list.
If these are not present, driver MUST assume a legacy device, and use it through the
legacy interface.
<!--l. 1318--><p class="noindent" >Non-transitional drivers MUST look for the Virtio PCI Capabilities on the capability
list. If these are not present, driver MUST assume a legacy device, and fail
gracefully.
<a 
 id="x1-136001r135"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.2</span> <a 
 id="x1-1370002"></a>MSI-X Vector Configuration</h5>
When MSI-X capability is present and enabled in the device (through standard PCI
configuration space) <span 
class="aeti-10">config_msix_vector </span>and <span 
class="aeti-10">queue_msix_vector </span>are used to map
                                                                  

                                                                  
configuration change and queue interrupts to MSI-X vectors. In this case, the ISR
Status is unused.
<!--l. 1329--><p class="noindent" >Writing a valid MSI-X Table entry number, 0 to 0x7FF, to <span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector</span>
maps interrupts triggered by the configuration change/selected queue events
respectively to the corresponding MSI-X vector. To disable interrupts for an
event type, the driver unmaps this event by writing a special NO_VECTOR
value:
<!--l. 1336-->
<div class="lstlisting" id="listing-33"><span class="label"><a 
 id="x1-137001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">MSI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-137002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MSI_NO_VECTOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">xffff</span>
</div>
<!--l. 1341--><p class="noindent" >Note that mapping an event to vector might require device to allocate internal device
resources, and thus could fail.
<a 
 id="x1-137003r136"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.2.1</span> <a 
 id="x1-1380001"></a>Device Requirements: MSI-X Vector Configuration</h6>
A device that has an MSI-X capability SHOULD support at least 2 and at most
0x800 MSI-X vectors. Device MUST report the number of vectors supported in <span 
class="aeti-10">Table</span>
<span 
class="aeti-10">Size </span>in the MSI-X Capability as specified in <a 
href="#x1-3001r1">[PCI]</a>. The device SHOULD restrict
the reported MSI-X Table Size field to a value that might benefit system
performance.
<span 
class="aebx-10">Note:</span> For example, a device which does not expect to send interrupts at a high
      rate might only specify 2 MSI-X vectors.
<!--l. 1357--><p class="noindent" >Device MUST support mapping any event type to any valid vector 0 to MSI-X <span 
class="aeti-10">Table</span>
<span 
class="aeti-10">Size</span>. Device MUST support unmapping any event type.
<!--l. 1361--><p class="noindent" >The device MUST return vector mapped to a given event, (NO_VECTOR if
unmapped) on read of <span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector</span>. The device
MUST have all queue and configuration change events are unmapped upon
reset.
<!--l. 1366--><p class="noindent" >Devices SHOULD NOT cause mapping an event to vector to fail unless it is
impossible for the device to satisfy the mapping request. Devices MUST report
mapping failures by returning the NO_VECTOR value when the relevant
<span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector </span>field is read.
<a 
 id="x1-138001r138"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.2.2</span> <a 
 id="x1-1390002"></a>Driver Requirements: MSI-X Vector Configuration</h6>
Driver MUST support device with any MSI-X Table Size 0 to 0x7FF. Driver MAY
fall back on using INT#x interrupts for a device which only supports one MSI-X
vector (MSI-X Table Size = 0).
                                                                  

                                                                  
<!--l. 1378--><p class="noindent" >Driver MAY intepret the Table Size as a hint from the device for the suggested
number of MSI-X vectors to use.
<!--l. 1381--><p class="noindent" >Driver MUST NOT attempt to map an event to a vector outside the MSI-X Table
supported by the device, as reported by <span 
class="aeti-10">Table Size </span>in the MSI-X Capability.
<!--l. 1385--><p class="noindent" >After mapping an event to vector, the driver MUST verify success by reading the
Vector field value: on success, the previously written value is returned, and on
failure, NO_VECTOR is returned. If a mapping failure is detected, the driver
MAY retry mapping with fewer vectors, disable MSI-X or report device
failure.
<a 
 id="x1-139001r137"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.3</span> <a 
 id="x1-1400003"></a>Virtqueue Configuration</h5>
As a device can have zero or more virtqueues for bulk data
transport<span class="footnote-mark"><a 
href="#fn6x4" id="fn6x4-bk"><sup class="textsuperscript">6</sup></a></span><a 
 id="x1-140001f6"></a>,
the driver needs to configure them as part of the device-specific configuration.
<!--l. 1399--><p class="noindent" >The driver typically does this as follows, for each virtqueue a device has:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-140003x1">Write the virtqueue index (first queue is 0) to <span 
class="aeti-10">queue_select</span>.
     </li>
     <li 
  class="enumerate" id="x1-140005x2">Read  the  virtqueue  size  from  <span 
class="aeti-10">queue_size</span>.  This  controls  how  big  the
     virtqueue is (see <a 
href="#x1-230005">2.5<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a> <a 
href="#x1-230005">Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>). If this field is 0, the virtqueue does not
     exist.
     </li>
     <li 
  class="enumerate" id="x1-140007x3">Optionally, select a smaller virtqueue size and write it to <span 
class="aeti-10">queue_size</span>.
     </li>
     <li 
  class="enumerate" id="x1-140009x4">Allocate  and  zero  Descriptor  Table,  Available  and  Used  rings  for  the
     virtqueue in contiguous physical memory.
     </li>
     <li 
  class="enumerate" id="x1-140011x5">Optionally,  if  MSI-X  capability  is  present  and  enabled  on  the  device,
     select a vector to use to request interrupts triggered by virtqueue events.
     Write the MSI-X Table entry number corresponding to this vector into
     <span 
class="aeti-10">queue_msix_vector</span>. Read <span 
class="aeti-10">queue_msix_vector</span>: on success, previously written
     value is returned; on failure, NO_VECTOR value is returned.</li></ol>
<a 
 id="x1-140012r139"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.3.1</span> <a 
 id="x1-1410001"></a>Legacy Interface: A Note on Virtqueue Configuration</h6>
When using the legacy interface, the queue layout follows <a 
href="#x1-260002">2.6.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-260002">Legacy
Interfaces: A Note on Virtqueue Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> with an alignment of 4096. Driver
writes the physical address, divided by 4096 to the Queue Address
field<span class="footnote-mark"><a 
href="#fn7x4" id="fn7x4-bk"><sup class="textsuperscript">7</sup></a></span><a 
 id="x1-141001f7"></a>.
                                                                  

                                                                  
There was no mechanism to negotiate the queue size.
<a 
 id="x1-141002r134"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.2   </span> <a 
 id="x1-1420002"></a>Available Buffer Notifications</h5>
<!--l. 1430--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has not been negotiated, the driver sends
an available buffer notification to the device by writing the 16-bit virtqueue index of
this virtqueue to the Queue Notify address.
<!--l. 1435--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has been negotiated, the driver sends an
available buffer notification to the device by writing the following 32-bit value to the
Queue Notify address: <!--l. 1438--><div class="lstinputlisting">
<a 
 id="x1-142001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142002r1"></a></span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142003r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vqn</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142004r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142006r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1440--><p class="noindent" >See <a 
href="#x1-9000023">2.7.23<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-9000023">Driver notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> for the definition of the components.
<!--l. 1443--><p class="noindent" >See <a 
href="#x1-1180004">4.1.4.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a> for how to calculate the Queue Notify address.
<a 
 id="x1-142007r142"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.3   </span> <a 
 id="x1-1430003"></a>Used Buffer Notifications</h5>
<!--l. 1448--><p class="noindent" >If a used buffer notification is necessary for a virtqueue, the device would typically
act as follows:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-143002x1">Set the lower bit of the ISR Status field for the device.
         </li>
         <li 
  class="enumerate" id="x1-143004x2">Send the appropriate PCI interrupt for the device.</li></ol>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-143006x1">If <span 
class="aeti-10">queue_msix_vector </span>is not NO_VECTOR, request the appropriate
         MSI-X interrupt message for the device, <span 
class="aeti-10">queue_msix_vector </span>sets the
         MSI-X Table entry number.</li></ol>
     </li></ul>
<a 
 id="x1-143007r140"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.3.1</span> <a 
 id="x1-1440001"></a>Device Requirements: Used Buffer Notifications</h5>
If MSI-X capability is enabled and <span 
class="aeti-10">queue_msix_vector </span>is NO_VECTOR for a
                                                                  

                                                                  
virtqueue, the device MUST NOT deliver an interrupt for that virtqueue.
<a 
 id="x1-144001r144"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.4   </span> <a 
 id="x1-1450004"></a>Notification of Device Configuration Changes</h5>
<!--l. 1475--><p class="noindent" >Some virtio PCI devices can change the device configuration state, as reflected in the
device-specific configuration region of the device. In this case:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-145002x1">Set the second lower bit of the ISR Status field for the device.
         </li>
         <li 
  class="enumerate" id="x1-145004x2">Send the appropriate PCI interrupt for the device.</li></ol>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-145006x1">If <span 
class="aeti-10">config_msix_vector </span>is not NO_VECTOR, request the appropriate
         MSI-X interrupt message for the device, <span 
class="aeti-10">config_msix_vector </span>sets the
         MSI-X Table entry number.</li></ol>
     </li></ul>
<!--l. 1495--><p class="noindent" >A single interrupt MAY indicate both that one or more virtqueue has been used and
that the configuration space has changed.
<a 
 id="x1-145007r145"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.4.1</span> <a 
 id="x1-1460001"></a>Device Requirements: Notification of Device Configuration Changes</h5>
If MSI-X capability is enabled and <span 
class="aeti-10">config_msix_vector </span>is NO_VECTOR,
the device MUST NOT deliver an interrupt for device configuration space
changes.
<a 
 id="x1-146001r147"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.4.2</span> <a 
 id="x1-1470002"></a>Driver Requirements: Notification of Device Configuration Changes</h5>
A driver MUST handle the case where the same interrupt is used to indicate
both device configuration space change and one or more virtqueues being
used.
<a 
 id="x1-147001r146"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.5   </span> <a 
 id="x1-1480005"></a>Driver Handling Interrupts</h5>
<!--l. 1510--><p class="noindent" >The driver interrupt handler would typically:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
                                                                  

                                                                  
         <ul class="itemize2">
         <li class="itemize">Read the ISR Status field, which will reset it to zero.
         </li>
         <li class="itemize">If the lower bit is set: look through all virtqueues for the device, to see
         if any progress has been made by the device which requires servicing.
         </li>
         <li class="itemize">If the second lower bit is set: re-examine the configuration space to
         see what changed.</li></ul>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
         <ul class="itemize2">
         <li class="itemize">Look through all virtqueues mapped to that MSI-X vector for the
         device, to see if any progress has been made by the device which
         requires servicing.
         </li>
         <li class="itemize">If the MSI-X vector is equal to <span 
class="aeti-10">config_msix_vector</span>, re-examine the
         configuration space to see what changed.</li></ul>
     </li></ul>
<a 
 id="x1-148001r103"></a>
<h3 class="sectionHead"><span class="titlemark">4.2   </span> <a 
 id="x1-1490002"></a>Virtio Over MMIO</h3>
<!--l. 1537--><p class="noindent" >Virtual environments without PCI support (a common situation in embedded devices
models) might use simple memory mapped device (“virtio-mmio”) instead of the PCI
device.
<!--l. 1541--><p class="noindent" >The memory mapped virtio device behaviour is based on the PCI device
specification. Therefore most operations including device initialization, queues
configuration and buffer transfers are nearly identical. Existing differences are
described in the following sections.
<a 
 id="x1-149001r133"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.1   </span> <a 
 id="x1-1500001"></a>MMIO Device Discovery</h4>
<!--l. 1549--><p class="noindent" >Unlike PCI, MMIO provides no generic device discovery mechanism. For each device,
the guest OS will need to know the location of the registers and interrupt(s) used.
The suggested binding for systems using flattened device trees is shown in this
example:
<!--l. 1554-->
<div class="lstlisting" id="listing-34"><span class="label"><a 
 id="x1-150001r1"></a></span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXAMPLE</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">taking</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1e000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">42.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-150002r2"></a></span><span 
class="pcrr8t-x-x-80">virtio_block@1e000</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-150003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compatible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">virtio</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80">mmio</span><span 
class="pcrr8t-x-x-80">";</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-150004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><0</span><span 
class="pcrr8t-x-x-80">x1e000</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x200</span><span 
class="pcrr8t-x-x-80">>;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-150005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupts</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><42>;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-150006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
                                                                  

                                                                  
<a 
 id="x1-150007r151"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.2   </span> <a 
 id="x1-1510002"></a>MMIO Device Register Layout</h4>
<!--l. 1565--><p class="noindent" >MMIO virtio devices provide a set of memory mapped control registers followed by a
device-specific configuration space, described in the table <a 
href="#x1-151001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>.
<!--l. 1569--><p class="noindent" >All register values are organized as Little Endian.
<a 
 id="x1-151001r1"></a>
<!--l. 1580--><div class="longtable"> <table id="TBL-14" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-14-1g"><col 
id="TBL-14-1"><col 
id="TBL-14-2"></colgroup>
                                                                  

                                                                  
<tr  
 style="vertical-align:baseline;" id="TBL-14-1-"><td colspan="2" style="white-space:nowrap; text-align:center;" id="TBL-14-1-1"  
class="td11">    <div class="multicolumn"  style="white-space:nowrap; text-align:center;"> <div class="caption" 
><span class="id">Table 4.1: </span><span  
class="content">MMIO Device Register Layout</span></div><!--tex4ht:label?: x1-151001r1 -->                               </div>        <a 
 id="x1-151002"></a>
</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-2-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-2-1"  
class="td11">
 <!--l. 1583--><p class="noindent" ><span 
class="aeti-10">Name </span><br 
class="newline" />Offset       from
  base <br 
class="newline" />Direction          </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-2-2"  
class="td11">
 <!--l. 1583--><p class="noindent" ><span 
class="aebx-10">Function </span><br 
class="newline" />Description                                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-3-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-3-1"  
class="td11">
 <!--l. 1586--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-4-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-4-1"  
class="td11">               </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-4-2"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-14-12-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-12-1"  
class="td11">
 <!--l. 1597--><p class="noindent" ><span 
class="aeti-10">MagicValue </span><br 
class="newline" />0x000 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-12-2"  
class="td11">
 <!--l. 1597--><p class="noindent" ><span 
class="aebx-10">Magic value </span><br 
class="newline" />0x74726976  (a  Little  Endian  equivalent  of  the  “virt”
  string).                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-13-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-13-1"  
class="td11">
 <!--l. 1604--><p class="noindent" ><span 
class="aeti-10">Version </span><br 
class="newline" />0x004 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-13-2"  
class="td11">
 <!--l. 1604--><p class="noindent" ><span 
class="aebx-10">Device version number </span><br 
class="newline" />0x2.
  <span 
class="aebx-10">Note:</span> Legacy devices (see <a 
href="#x1-1610004">4.2.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a> <a 
href="#x1-1610004">Legacy interface<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a>) used
            0x1.
  <!--l. 1605--><p class="noindent" >                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-14-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-14-1"  
class="td11">
 <!--l. 1612--><p class="noindent" ><span 
class="aeti-10">DeviceID </span><br 
class="newline" />0x008 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-14-2"  
class="td11">
 <!--l. 1612--><p class="noindent" ><span 
class="aebx-10">Virtio Subsystem Device ID </span><br 
class="newline" />See  <a 
href="#x1-1980005">5<!--tex4ht:ref: sec:Device Types --></a> <a 
href="#x1-1980005">Device  Types<!--tex4ht:ref: sec:Device Types --></a>  for  possible  values.  Value  zero
  (0x0)  is  used  to  define  a  system  memory  map  with
  placeholder  devices  at  static,  well  known  addresses,
  assigning functions to them depending on user’s needs.  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-15-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-15-1"  
class="td11">
 <!--l. 1614--><p class="noindent" ><span 
class="aeti-10">VendorID </span><br 
class="newline" />0x00c <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-15-2"  
class="td11">
 <!--l. 1614--><p class="noindent" ><span 
class="aebx-10">Virtio Subsystem Vendor ID </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-16-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-16-1"  
class="td11">
 <!--l. 1624--><p class="noindent" ><span 
class="aeti-10">DeviceFeatures </span><br 
class="newline" />0x010 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-16-2"  
class="td11">
 <!--l. 1624--><p class="noindent" ><span 
class="aebx-10">Flags representing features the device supports </span><br 
class="newline" />Reading  from  this  register  returns  32  consecutive
  flag  bits,  the  least  significant  bit  depending  on  the
  last  value  written  to  <span 
class="aeti-10">DeviceFeaturesSel</span>.  Access  to
  this  register  returns  bits  <span 
class="aeti-10">DeviceFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32  </span>to
  <span 
class="cmr-10">(</span><span 
class="aeti-10">DeviceFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32) + 31</span>, eg. feature bits 0 to 31 if
  <span 
class="aeti-10">DeviceFeaturesSel </span>is set to 0 and features bits 32 to 63 if
  <span 
class="aeti-10">DeviceFeaturesSel </span>is set to 1. Also see <a 
href="#x1-130002">2.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a> <a 
href="#x1-130002">Feature Bits<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a>.  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-17-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-17-1"  
class="td11">
 <!--l. 1629--><p class="noindent" ><span 
class="aeti-10">DeviceFeaturesSel</span>
  <br 
class="newline" />0x014 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-17-2"  
class="td11">
 <!--l. 1629--><p class="noindent" ><span 
class="aebx-10">Device (host) features word selection. </span><br 
class="newline" />Writing to this register selects a set of 32 device feature
  bits accessible by reading from <span 
class="aeti-10">DeviceFeatures</span>.             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-18-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-18-1"  
class="td11">
 <!--l. 1638--><p class="noindent" ><span 
class="aeti-10">DriverFeatures </span><br 
class="newline" />0x020 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-18-2"  
class="td11">
 <!--l. 1638--><p class="noindent" ><span 
class="aebx-10">Flags  representing  device  features  understood</span>
  <span 
class="aebx-10">and activated by the driver </span><br 
class="newline" />Writing to this register sets 32 consecutive flag bits, the
  least significant bit depending on the last value written
  to <span 
class="aeti-10">DriverFeaturesSel</span>. Access to this register sets bits
  <span 
class="aeti-10">DriverFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32 </span>to <span 
class="cmr-10">(</span><span 
class="aeti-10">DriverFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32) + 31</span>,
  eg. feature bits 0 to 31 if <span 
class="aeti-10">DriverFeaturesSel </span>is set to 0
  and features bits 32 to 63 if <span 
class="aeti-10">DriverFeaturesSel </span>is set to
  1. Also see <a 
href="#x1-130002">2.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a> <a 
href="#x1-130002">Feature Bits<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a>.                                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-19-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-19-1"  
class="td11">
 <!--l. 1643--><p class="noindent" ><span 
class="aeti-10">DriverFeaturesSel</span>
  <br 
class="newline" />0x024 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-19-2"  
class="td11">
 <!--l. 1643--><p class="noindent" ><span 
class="aebx-10">Activated (guest) features word selection </span><br 
class="newline" />Writing  to  this  register  selects  a  set  of  32  activated
  feature bits accessible by writing to <span 
class="aeti-10">DriverFeatures</span>.       </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-20-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-20-1"  
class="td11">
 <!--l. 1651--><p class="noindent" ><span 
class="aeti-10">QueueSel </span><br 
class="newline" />0x030 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-20-2"  
class="td11">
 <!--l. 1651--><p class="noindent" ><span 
class="aebx-10">Virtual queue index </span><br 
class="newline" />Writing to this register selects the virtual queue that
  the following operations on <span 
class="aeti-10">QueueNumMax</span>, <span 
class="aeti-10">QueueNum</span>,
  <span 
class="aeti-10">QueueReady</span>,       <span 
class="aeti-10">QueueDescLow</span>,       <span 
class="aeti-10">QueueDescHigh</span>,
  <span 
class="aeti-10">QueueAvailLow</span>,  <span 
class="aeti-10">QueueAvailHigh</span>,  <span 
class="aeti-10">QueueUsedLow  </span>and
  <span 
class="aeti-10">QueueUsedHigh </span>apply to. The index number of the first
  queue is zero (0x0).                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-21-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-21-1"  
class="td11">
 <!--l. 1658--><p class="noindent" ><span 
class="aeti-10">QueueNumMax</span>
  <br 
class="newline" />0x034 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-21-2"  
class="td11">
 <!--l. 1658--><p class="noindent" ><span 
class="aebx-10">Maximum virtual queue size </span><br 
class="newline" />Reading  from  the  register  returns  the  maximum  size
  (number of elements) of the queue the device is ready to
  process or zero (0x0) if the queue is not available. This
  applies to the queue selected by writing to <span 
class="aeti-10">QueueSel</span>.     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-22-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-22-1"  
class="td11">
 <!--l. 1665--><p class="noindent" ><span 
class="aeti-10">QueueNum </span><br 
class="newline" />0x038 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-22-2"  
class="td11">
 <!--l. 1665--><p class="noindent" ><span 
class="aebx-10">Virtual queue size </span><br 
class="newline" />Queue  size  is  the  number  of  elements  in  the  queue.
  Writing to this register notifies the device what size of
  the queue the driver will use. This applies to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-23-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-23-1"  
class="td11">
 <!--l. 1672--><p class="noindent" ><span 
class="aeti-10">QueueReady </span><br 
class="newline" />0x044 <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-23-2"  
class="td11">
 <!--l. 1672--><p class="noindent" ><span 
class="aebx-10">Virtual queue ready bit </span><br 
class="newline" />Writing one (0x1) to this register notifies the device that
  it can execute requests from this virtual queue. Reading
  from this register returns the last value written to it.
  Both read and write accesses apply to the queue selected
  by writing to <span 
class="aeti-10">QueueSel</span>.                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-24-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-24-1"  
class="td11">
 <!--l. 1688--><p class="noindent" ><span 
class="aeti-10">QueueNotify </span><br 
class="newline" />0x050 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-24-2"  
class="td11">
 <!--l. 1688--><p class="noindent" ><span 
class="aebx-10">Queue notifier </span><br 
class="newline" />Writing a value to this register notifies the device that
  there are new buffers to process in a queue.
  <!--l. 1688--><p class="noindent" >When   VIRTIO_F_NOTIFICATION_DATA   has   not
  been negotiated, the value written is the queue index.
  <!--l. 1688--><p class="noindent" >When  VIRTIO_F_NOTIFICATION_DATA  has  been
  negotiated, the <span 
class="aeti-10">Notification data </span>value has the following
  format:
  <!--l. 1688--><div class="lstinputlisting">
  <a 
 id="x1-151003"></a>
  <span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-151004r1"></a></span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-151005r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vqn</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-151006r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-151007r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-151008r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
 
</div>
<!--l. 1688--><p class="noindent" >See <a 
href="#x1-9000023">2.7.23<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-9000023">Driver notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> for the definition of the
components.                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-25-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-25-1"  
class="td11">
 <!--l. 1701--><p class="noindent" ><span 
class="aeti-10">InterruptStatus</span>
  <br 
class="newline" />0x60 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-25-2"  
class="td11">
 <!--l. 1701--><p class="noindent" ><span 
class="aebx-10">Interrupt status </span><br 
class="newline" />Reading from this register returns a bit mask of events that
  caused the device interrupt to be asserted. The following
  events are possible:
         <dl class="description"><dt class="description">
  <span 
class="aebx-10">Used Buffer Notification</span> </dt><dd 
class="description">- bit 0 - the interrupt was
         asserted because the device has used a buffer in at
         least one of the active virtual queues.
         </dd><dt class="description">
  <span 
class="aebx-10">Configuration Change Notification</span> </dt><dd 
class="description">-  bit  1  -  the
         interrupt was asserted because the configuration
         of the device has changed.</dd></dl>
  <!--l. 1702--><p class="noindent" >                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-26-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-26-1"  
class="td11">
 <!--l. 1707--><p class="noindent" ><span 
class="aeti-10">InterruptACK </span><br 
class="newline" />0x064 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-26-2"  
class="td11">
 <!--l. 1707--><p class="noindent" ><span 
class="aebx-10">Interrupt acknowledge </span><br 
class="newline" />Writing           a           value           with           bits
  set as defined in <span 
class="aeti-10">InterruptStatus </span>to this register notifies
  the device that events causing the interrupt have been
  handled.                                                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-27-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-27-1"  
class="td11">
 <!--l. 1716--><p class="noindent" ><span 
class="aeti-10">Status </span><br 
class="newline" />0x070 <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-27-2"  
class="td11">
 <!--l. 1716--><p class="noindent" ><span 
class="aebx-10">Device status </span><br 
class="newline" />Reading from this register returns the current device
  status flags. Writing non-zero values to this register sets
  the status flags, indicating the driver progress. Writing
  zero (0x0) to this register triggers a device reset. See
  also p. <a 
href="#x1-1550001">4.2.3.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-1550001">Device Initialization<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a>.                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-28-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-28-1"  
class="td11">
 <!--l. 1723--><p class="noindent" ><span 
class="aeti-10">QueueDescLow</span>
  <br 
class="newline" />0x080 <br 
class="newline" /><span 
class="aeti-10">QueueDescHigh</span>
  <br 
class="newline" />0x084 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-28-2"  
class="td11">
 <!--l. 1723--><p class="noindent" ><span 
class="aebx-10">Virtual  queue’s  Descriptor  Area  64  bit  long</span>
  <span 
class="aebx-10">physical address </span><br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueDescLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueDescHigh</span>) notifies the device about location of
  the Descriptor Area of the queue selected by writing to
  <span 
class="aeti-10">QueueSel </span>register.                                                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-29-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-29-1"  
class="td11">
 <!--l. 1730--><p class="noindent" ><span 
class="aeti-10">QueueDriverLow</span>
  <br 
class="newline" />0x090 <br 
class="newline" /><span 
class="aeti-10">QueueDriverHigh</span>
  <br 
class="newline" />0x094 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-29-2"  
class="td11">
 <!--l. 1730--><p class="noindent" ><span 
class="aebx-10">Virtual queue’s Driver Area 64 bit long physical</span>
  <span 
class="aebx-10">address </span><br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueAvailLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueAvailHigh</span>) notifies the device about location of
  the  Driver  Area  of  the  queue  selected  by  writing  to
  <span 
class="aeti-10">QueueSel</span>.                                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-30-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-30-1"  
class="td11">
 <!--l. 1737--><p class="noindent" ><span 
class="aeti-10">QueueDeviceLow</span>
  <br 
class="newline" />0x0a0 <br 
class="newline" /><span 
class="aeti-10">QueueDeviceHigh</span>
  <br 
class="newline" />0x0a4 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-30-2"  
class="td11">
 <!--l. 1737--><p class="noindent" ><span 
class="aebx-10">Virtual queue’s Device Area 64 bit long physical</span>
  <span 
class="aebx-10">address </span><br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueUsedLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueUsedHigh</span>) notifies the device about location of
  the  Device  Area  of  the  queue  selected  by  writing  to
  <span 
class="aeti-10">QueueSel</span>.                                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-31-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-31-1"  
class="td11">
 <!--l. 1743--><p class="noindent" ><span 
class="aeti-10">SHMSel </span><br 
class="newline" />0x0ac <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-31-2"  
class="td11">
 <!--l. 1743--><p class="noindent" ><span 
class="aebx-10">Shared memory id </span><br 
class="newline" />Writing to this register selects the shared memory region
  <a 
href="#x1-910008">2.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Shared Memory Regions --></a> following operations on <span 
class="aeti-10">SHMLenLow</span>, <span 
class="aeti-10">SHMLenHigh</span>,
  <span 
class="aeti-10">SHMBaseLow </span>and <span 
class="aeti-10">SHMBaseHigh </span>apply to.                 </td>

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-32-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-32-1"  
class="td11">
 <!--l. 1744--><p class="noindent" >            </td>
</tr>
<tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-33-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-33-1"  
class="td11">
 <!--l. 1753--><p class="noindent" ><span 
class="aeti-10">SHMLenLow </span><br 
class="newline" />0x0b0 <br 
class="newline" /><span 
class="aeti-10">SHMLenHigh </span><br 
class="newline" />0x0xb4 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-33-2"  
class="td11">
 <!--l. 1753--><p class="noindent" ><span 
class="aebx-10">Shared memory region 64 bit long length </span><br 
class="newline" />These registers return the length of the shared memory
  region in bytes, as defined by the device for the region
  selected by the <span 
class="aeti-10">SHMSel </span>register. The lower 32 bits of
  the length are read from <span 
class="aeti-10">SHMLenLow </span>and the higher
  32 bits from <span 
class="aeti-10">SHMLenHigh</span>. Reading from a non-existent
  region (i.e. where the ID written to <span 
class="aeti-10">SHMSel </span>is unused)
  results in a length of -1.                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-34-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-34-1"  
class="td11">
 <!--l. 1764--><p class="noindent" ><span 
class="aeti-10">SHMBaseLow </span><br 
class="newline" />0x0b8 <br 
class="newline" /><span 
class="aeti-10">SHMBaseHigh </span><br 
class="newline" />0x0xbc <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-34-2"  
class="td11">
 <!--l. 1764--><p class="noindent" ><span 
class="aebx-10">Shared  memory  region  64  bit  long  physical</span>
  <span 
class="aebx-10">address </span><br 
class="newline" />The  driver  reads  these  registers  to  discover  the  base
  address of the region in physical address space. This
  address  is  chosen  by  the  device  (or  other  part  of
  the  VMM).  The  lower  32  bits  of  the  address  are
  read from <span 
class="aeti-10">SHMBaseLow </span>with the higher 32 bits from
  <span 
class="aeti-10">SHMBaseHigh</span>. Reading from a non-existent region (i.e.
  where the ID written to <span 
class="aeti-10">SHMSel </span>is unused) results in a
  base address of 0xffffffffffffffff.                                    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-35-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-35-1"  
class="td11">
 <!--l. 1772--><p class="noindent" ><span 
class="aeti-10">ConfigGeneration</span>
  <br 
class="newline" />0x0fc <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-35-2"  
class="td11">
 <!--l. 1772--><p class="noindent" ><span 
class="aebx-10">Configuration atomicity value </span><br 
class="newline" /> Reading from this register returns a value describing
  a version of the device-specific configuration space (see
  <span 
class="aeti-10">Config</span>). The driver can then access the configuration
  space and, when finished, read <span 
class="aeti-10">ConfigGeneration </span>again.
  If  no  part  of  the  configuration  space  has  changed
  between these two <span 
class="aeti-10">ConfigGeneration </span>reads, the returned
  values  are  identical.  If  the  values  are  different,  the
  configuration space accesses were not atomic and the
  driver has to perform the operations again. See also <a 
href="#x1-180004">2.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space --></a>.  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-36-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-36-1"  
class="td11">
 <!--l. 1778--><p class="noindent" ><span 
class="aeti-10">Config </span><br 
class="newline" />0x100+ <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-36-2"  
class="td11">
 <!--l. 1778--><p class="noindent" ><span 
class="aebx-10">Configuration space </span><br 
class="newline" /> Device-specific configuration space starts at the offset
  0x100 and is accessed with byte alignment. Its meaning
  and size depend on the device and the driver.              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-37-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-37-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-38-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-38-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-39-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-39-1"  
class="td11">
 <!--l. 1780--><p class="noindent" >            </td>
                                                                  

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-40-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-40-1"  
class="td11">
 <!--l. 1780--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-41-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-41-1"  
class="td11">
 <!--l. 1780--><p class="noindent" >            </td>
</tr>
<tr  
 style="vertical-align:baseline;" id="TBL-14-10-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-10-1"  
class="td11">
 <!--l. 1593--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-11-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-11-1"  
class="td11">
 <!--l. 1593--><p class="noindent" >            </td>
</tr>
</table></div>
<a 
 id="x1-151009r149"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.2.1   </span> <a 
 id="x1-1520001"></a>Device Requirements: MMIO Device Register Layout</h5>
<!--l. 1784--><p class="nopar" >The device MUST return 0x74726976 in <span 
class="aeti-10">MagicValue</span>.
<!--l. 1786--><p class="noindent" >The device MUST return value 0x2 in <span 
class="aeti-10">Version</span>.
<!--l. 1788--><p class="noindent" >The device MUST present each event by setting the corresponding bit in
<span 
class="aeti-10">InterruptStatus </span>from the moment it takes place, until the driver acknowledges
the interrupt by writing a corresponding bit mask to the <span 
class="aeti-10">InterruptACK</span>
register. Bits which do not represent events which took place MUST be
zero.
<!--l. 1793--><p class="noindent" >Upon reset, the device MUST clear all bits in <span 
class="aeti-10">InterruptStatus </span>and ready bits in the
<span 
class="aeti-10">QueueReady </span>register for all queues in the device.
<!--l. 1796--><p class="noindent" >The device MUST change value returned in <span 
class="aeti-10">ConfigGeneration </span>if there is any risk of a
driver seeing an inconsistent configuration state.
<!--l. 1799--><p class="noindent" >The device MUST NOT access virtual queue contents when <span 
class="aeti-10">QueueReady </span>is zero
(0x0).
<a 
 id="x1-152001r155"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.2.2   </span> <a 
 id="x1-1530002"></a>Driver Requirements: MMIO Device Register Layout</h5>
<!--l. 1802--><p class="nopar" >The driver MUST NOT access memory locations not described in the table <a 
href="#x1-151001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a> (or, in
case of the configuration space, described in the device specification), MUST NOT
write to the read-only registers (direction R) and MUST NOT read from the
write-only registers (direction W).
<!--l. 1808--><p class="noindent" >The driver MUST only use 32 bit wide and aligned reads and writes to access the
control registers described in table <a 
href="#x1-151001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>. For the device-specific configuration space,
the driver MUST use 8 bit wide accesses for 8 bit wide fields, 16 bit wide and aligned
accesses for 16 bit wide fields and 32 bit wide and aligned accesses for 32 and 64 bit
wide fields.
<!--l. 1814--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">MagicValue </span>which is not 0x74726976,
although it MAY report an error.
                                                                  

                                                                  
<!--l. 1817--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">Version </span>which is not 0x2, although it MAY
report an error.
<!--l. 1820--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">DeviceID </span>0x0, but MUST NOT report any
error.
<!--l. 1823--><p class="noindent" >Before reading from <span 
class="aeti-10">DeviceFeatures</span>, the driver MUST write a value to
<span 
class="aeti-10">DeviceFeaturesSel</span>.
<!--l. 1825--><p class="noindent" >Before writing to the <span 
class="aeti-10">DriverFeatures </span>register, the driver MUST write a value to the
<span 
class="aeti-10">DriverFeaturesSel </span>register.
<!--l. 1827--><p class="noindent" >The driver MUST write a value to <span 
class="aeti-10">QueueNum </span>which is less than or equal to the value
presented by the device in <span 
class="aeti-10">QueueNumMax</span>.
<!--l. 1830--><p class="noindent" >When <span 
class="aeti-10">QueueReady </span>is not zero, the driver MUST NOT access <span 
class="aeti-10">QueueNum</span>,
<span 
class="aeti-10">QueueDescLow</span>, <span 
class="aeti-10">QueueDescHigh</span>, <span 
class="aeti-10">QueueAvailLow</span>, <span 
class="aeti-10">QueueAvailHigh</span>, <span 
class="aeti-10">QueueUsedLow</span>,
<span 
class="aeti-10">QueueUsedHigh</span>.
<!--l. 1834--><p class="noindent" >To stop using the queue the driver MUST write zero (0x0) to this <span 
class="aeti-10">QueueReady </span>and
MUST read the value back to ensure synchronization.
<!--l. 1838--><p class="noindent" >The driver MUST ignore undefined bits in <span 
class="aeti-10">InterruptStatus</span>.
<!--l. 1840--><p class="noindent" >The driver MUST write a value with a bit mask describing events it handled into
<span 
class="aeti-10">InterruptACK </span>when it finishes handling an interrupt and MUST NOT set any of the
undefined bits in the value.
<a 
 id="x1-153001r152"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.3   </span> <a 
 id="x1-1540003"></a>MMIO-specific Initialization And Device Operation</h4>
<a 
 id="x1-154001r156"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.1   </span> <a 
 id="x1-1550001"></a>Device Initialization</h5>
<a 
 id="x1-155001r148"></a>
<h5 class="paragraphHead"><span class="titlemark">4.2.3.1.1</span> <a 
 id="x1-1560001"></a>Driver Requirements: Device Initialization</h5>
The driver MUST start the device initialization by reading and checking values from
<span 
class="aeti-10">MagicValue </span>and <span 
class="aeti-10">Version</span>. If both values are valid, it MUST read <span 
class="aeti-10">DeviceID </span>and if its
value is zero (0x0) MUST abort initialization and MUST NOT access any other
register.
<!--l. 1855--><p class="noindent" >Drivers not expecting shared memory MUST NOT use the shared memory
registers.
<!--l. 1858--><p class="noindent" >Further initialization MUST follow the procedure described in <a 
href="#x1-950001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-950001">Device
Initialization<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.
<a 
 id="x1-156001r158"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.2   </span> <a 
 id="x1-1570002"></a>Virtqueue Configuration</h5>
<!--l. 1863--><p class="nopar" >The driver will typically initialize the virtual queue in the following way:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-157002x1">Select the queue writing its index (first queue is 0) to <span 
class="aeti-10">QueueSel</span>.
     </li>
     <li 
  class="enumerate" id="x1-157004x2">Check if the queue is not already in use: read <span 
class="aeti-10">QueueReady</span>, and expect a
     returned value of zero (0x0).
     </li>
     <li 
  class="enumerate" id="x1-157006x3">Read maximum queue size (number of elements) from <span 
class="aeti-10">QueueNumMax</span>. If
     the returned value is zero (0x0) the queue is not available.
     </li>
     <li 
  class="enumerate" id="x1-157008x4">Allocate and zero the queue memory, making sure the memory is physically
     contiguous.
     </li>
     <li 
  class="enumerate" id="x1-157010x5">Notify the device about the queue size by writing the size to <span 
class="aeti-10">QueueNum</span>.
     </li>
     <li 
  class="enumerate" id="x1-157012x6">Write physical addresses of the queue’s Descriptor Area, Driver Area and
     Device                    Area                    to                    (respectively)
     the <span 
class="aeti-10">QueueDescLow</span>/<span 
class="aeti-10">QueueDescHigh</span>, <span 
class="aeti-10">QueueDriverLow</span>/<span 
class="aeti-10">QueueDriverHigh</span>
     and <span 
class="aeti-10">QueueDeviceLow</span>/<span 
class="aeti-10">QueueDeviceHigh </span>register pairs.
     </li>
     <li 
  class="enumerate" id="x1-157014x7">Write 0x1 to <span 
class="aeti-10">QueueReady</span>.</li></ol>
<a 
 id="x1-157015r160"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.3   </span> <a 
 id="x1-1580003"></a>Available Buffer Notifications</h5>
<!--l. 1893--><p class="nopar" >When VIRTIO_F_NOTIFICATION_DATA has not been negotiated, the driver sends
an available buffer notification to the device by writing the 16-bit virtqueue index of
the queue to be notified to <span 
class="aeti-10">QueueNotify</span>.
<!--l. 1898--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has been negotiated, the driver sends an
available buffer notification to the device by writing the following 32-bit value to
<span 
class="aeti-10">QueueNotify</span>: <!--l. 1901--><div class="lstinputlisting">
<a 
 id="x1-158001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-158002r1"></a></span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-158003r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vqn</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-158004r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-158005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-158006r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1903--><p class="noindent" >See <a 
href="#x1-9000023">2.7.23<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-9000023">Driver notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> for the definition of the components.
<a 
 id="x1-158007r161"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.4   </span> <a 
 id="x1-1590004"></a>Notifications From The Device</h5>
<!--l. 1908--><p class="nopar" >The memory mapped virtio device is using a single, dedicated interrupt signal,
which is asserted when at least one of the bits described in the description of
<span 
class="aeti-10">InterruptStatus </span>is set. This is how the device sends a used buffer notification or a
configuration change notification to the device.
<a 
 id="x1-159001r159"></a>
<h5 class="paragraphHead"><span class="titlemark">4.2.3.4.1</span> <a 
 id="x1-1600001"></a>Driver Requirements: Notifications From The Device</h5>
After receiving an interrupt, the driver MUST read <span 
class="aeti-10">InterruptStatus </span>to check what
caused the interrupt (see the register description). The used buffer notification bit
being set SHOULD be interpreted as a used buffer notification for each active
virtqueue. After the interrupt is handled, the driver MUST acknowledge it by
writing a bit mask corresponding to the handled events to the InterruptACK
register.
<a 
 id="x1-160001r157"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.4   </span> <a 
 id="x1-1610004"></a>Legacy interface</h4>
<!--l. 1925--><p class="nopar" >The legacy MMIO transport used page-based addressing, resulting in a slightly
different control register layout, the device initialization and the virtual queue
configuration procedure.
<!--l. 1929--><p class="noindent" >Table <a 
href="#x1-161001r2">4.2<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Legacy Register Layout --></a> presents control registers layout, omitting descriptions of registers which
did not change their function nor behaviour:
<a 
 id="x1-161001r2"></a>
<!--l. 1935--><div class="longtable"> <table id="TBL-15" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-15-1g"><col 
id="TBL-15-1"><col 
id="TBL-15-2"></colgroup>
                                                                  

                                                                  
<tr  
 style="vertical-align:baseline;" id="TBL-15-1-"><td colspan="2" style="white-space:nowrap; text-align:center;" id="TBL-15-1-1"  
class="td11">    <div class="multicolumn"  style="white-space:nowrap; text-align:center;"> <div class="caption" 
><span class="id">Table 4.2: </span><span  
class="content">MMIO Device Legacy Register Layout</span></div><!--tex4ht:label?: x1-161001r2 -->                     </div>        <a 
 id="x1-161002"></a>
</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-2-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-2-1"  
class="td11">
 <!--l. 1938--><p class="noindent" ><span 
class="aeti-10">Name </span><br 
class="newline" />Offset       from
  base <br 
class="newline" />Direction          </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-2-2"  
class="td11">
 <!--l. 1938--><p class="noindent" ><span 
class="aebx-10">Function </span><br 
class="newline" />Description                                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-3-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-3-1"  
class="td11">
 <!--l. 1941--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-4-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-4-1"  
class="td11">               </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-4-2"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-15-12-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-12-1"  
class="td11">
 <!--l. 1949--><p class="noindent" ><span 
class="aeti-10">MagicValue </span><br 
class="newline" />0x000 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-12-2"  
class="td11">
 <!--l. 1949--><p class="noindent" ><span 
class="aebx-10">Magic value </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-13-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-13-1"  
class="td11">
 <!--l. 1951--><p class="noindent" ><span 
class="aeti-10">Version </span><br 
class="newline" />0x004 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-13-2"  
class="td11">
 <!--l. 1951--><p class="noindent" ><span 
class="aebx-10">Device version number </span><br 
class="newline" />Legacy device returns value 0x1.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-14-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-14-1"  
class="td11">
 <!--l. 1953--><p class="noindent" ><span 
class="aeti-10">DeviceID </span><br 
class="newline" />0x008 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-14-2"  
class="td11">
 <!--l. 1953--><p class="noindent" ><span 
class="aebx-10">Virtio Subsystem Device ID </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-15-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-15-1"  
class="td11">
 <!--l. 1955--><p class="noindent" ><span 
class="aeti-10">VendorID </span><br 
class="newline" />0x00c <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-15-2"  
class="td11">
 <!--l. 1955--><p class="noindent" ><span 
class="aebx-10">Virtio Subsystem Vendor ID </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-16-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-16-1"  
class="td11">
 <!--l. 1957--><p class="noindent" ><span 
class="aeti-10">HostFeatures </span><br 
class="newline" />0x010 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-16-2"  
class="td11">
 <!--l. 1957--><p class="noindent" ><span 
class="aebx-10">Flags representing features the device supports </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-17-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-17-1"  
class="td11">
 <!--l. 1959--><p class="noindent" ><span 
class="aeti-10">HostFeaturesSel</span>
  <br 
class="newline" />0x014 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-17-2"  
class="td11">
 <!--l. 1959--><p class="noindent" ><span 
class="aebx-10">Device (host) features word selection. </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-18-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-18-1"  
class="td11">
 <!--l. 1961--><p class="noindent" ><span 
class="aeti-10">GuestFeatures </span><br 
class="newline" />0x020 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-18-2"  
class="td11">
 <!--l. 1961--><p class="noindent" ><span 
class="aebx-10">Flags  representing  device  features  understood</span>
  <span 
class="aebx-10">and activated by the driver </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-19-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-19-1"  
class="td11">
 <!--l. 1963--><p class="noindent" ><span 
class="aeti-10">GuestFeaturesSel</span>
  <br 
class="newline" />0x024 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-19-2"  
class="td11">
 <!--l. 1963--><p class="noindent" ><span 
class="aebx-10">Activated (guest) features word selection </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-20-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-20-1"  
class="td11">
 <!--l. 1971--><p class="noindent" ><span 
class="aeti-10">GuestPageSize </span><br 
class="newline" />0x028 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-20-2"  
class="td11">
 <!--l. 1971--><p class="noindent" ><span 
class="aebx-10">Guest page size </span><br 
class="newline" />The driver writes the guest page size in bytes to the
  register during initialization, before any queues are used.
  This value should be a power of 2 and is used by the
  device to calculate the Guest address of the first queue
  page (see QueuePFN).                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-21-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-21-1"  
class="td11">
 <!--l. 1979--><p class="noindent" ><span 
class="aeti-10">QueueSel </span><br 
class="newline" />0x030 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-21-2"  
class="td11">
 <!--l. 1979--><p class="noindent" ><span 
class="aebx-10">Virtual queue index </span><br 
class="newline" />Writing to this register selects the virtual queue that the
  following operations on the <span 
class="aeti-10">QueueNumMax</span>, <span 
class="aeti-10">QueueNum</span>,
  <span 
class="aeti-10">QueueAlign  </span>and  <span 
class="aeti-10">QueuePFN  </span>registers  apply  to.  The
  index number of the first queue is zero (0x0). .             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-22-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-22-1"  
class="td11">
 <!--l. 1987--><p class="noindent" ><span 
class="aeti-10">QueueNumMax</span>
  <br 
class="newline" />0x034 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-22-2"  
class="td11">
 <!--l. 1987--><p class="noindent" ><span 
class="aebx-10">Maximum virtual queue size </span><br 
class="newline" />Reading from the register returns the maximum size of
  the queue the device is ready to process or zero (0x0)
  if the queue is not available. This applies to the queue
  selected  by  writing  to  <span 
class="aeti-10">QueueSel  </span>and  is  allowed  only
  when <span 
class="aeti-10">QueuePFN </span>is set to zero (0x0), so when the queue
  is not actively used.                                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-23-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-23-1"  
class="td11">
 <!--l. 1994--><p class="noindent" ><span 
class="aeti-10">QueueNum </span><br 
class="newline" />0x038 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-23-2"  
class="td11">
 <!--l. 1994--><p class="noindent" ><span 
class="aebx-10">Virtual queue size </span><br 
class="newline" />Queue  size  is  the  number  of  elements  in  the  queue.
  Writing to this register notifies the device what size of
  the queue the driver will use. This applies to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-24-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-24-1"  
class="td11">
 <!--l. 2000--><p class="noindent" ><span 
class="aeti-10">QueueAlign </span><br 
class="newline" />0x03c <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-24-2"  
class="td11">
 <!--l. 2000--><p class="noindent" ><span 
class="aebx-10">Used Ring alignment in the virtual queue </span><br 
class="newline" />Writing  to  this  register  notifies  the  device  about
  alignment boundary of the Used Ring in bytes. This
  value should be a power of 2 and applies to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-25-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-25-1"  
class="td11">
 <!--l. 2014--><p class="noindent" ><span 
class="aeti-10">QueuePFN </span><br 
class="newline" />0x040 <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-25-2"  
class="td11">
 <!--l. 2014--><p class="noindent" ><span 
class="aebx-10">Guest physical page number of the virtual queue</span>
  <br 
class="newline" />Writing to this register notifies the device about location
  of  the  virtual  queue  in  the  Guest’s  physical  address
  space. This value is the index number of a page starting
  with the queue Descriptor Table. Value zero (0x0) means
  physical address zero (0x00000000) and is illegal. When
  the driver stops using the queue it writes zero (0x0)
  to this register. Reading from this register returns the
  currently used page number of the queue, therefore a
  value other than zero (0x0) means that the queue is in
  use. Both read and write accesses apply to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-26-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-26-1"  
class="td11">
 <!--l. 2016--><p class="noindent" ><span 
class="aeti-10">QueueNotify </span><br 
class="newline" />0x050 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-26-2"  
class="td11">
 <!--l. 2016--><p class="noindent" ><span 
class="aebx-10">Queue notifier </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-27-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-27-1"  
class="td11">
 <!--l. 2018--><p class="noindent" ><span 
class="aeti-10">InterruptStatus</span>
  <br 
class="newline" />0x60 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-27-2"  
class="td11">
 <!--l. 2018--><p class="noindent" ><span 
class="aebx-10">Interrupt status </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-28-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-28-1"  
class="td11">
 <!--l. 2020--><p class="noindent" ><span 
class="aeti-10">InterruptACK </span><br 
class="newline" />0x064 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-28-2"  
class="td11">
 <!--l. 2020--><p class="noindent" ><span 
class="aebx-10">Interrupt acknowledge </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-29-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-29-1"  
class="td11">
 <!--l. 2030--><p class="noindent" ><span 
class="aeti-10">Status </span><br 
class="newline" />0x070 <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-29-2"  
class="td11">
 <!--l. 2030--><p class="noindent" ><span 
class="aebx-10">Device status </span><br 
class="newline" />Reading from this register returns the current device
  status  flags.  Writing  non-zero  values  to  this  register
  sets the status flags, indicating the OS/driver progress.
  Writing zero (0x0) to this register triggers a device reset.
  The device sets <span 
class="aeti-10">QueuePFN </span>to zero (0x0) for all queues
  in the device. Also see <a 
href="#x1-950001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-950001">Device Initialization<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-30-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-30-1"  
class="td11">
 <!--l. 2032--><p class="noindent" ><span 
class="aeti-10">Config </span><br 
class="newline" />0x100+ <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-15-30-2"  
class="td11">
 <!--l. 2032--><p class="noindent" ><span 
class="aebx-10">Configuration space </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-31-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-31-1"  
class="td11">             </td>                                                

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-32-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-32-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-33-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-33-1"  
class="td11">
 <!--l. 2034--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-34-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-34-1"  
class="td11">
 <!--l. 2034--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-35-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-35-1"  
class="td11">
 <!--l. 2034--><p class="noindent" >            </td>
</tr>
<tr  
 style="vertical-align:baseline;" id="TBL-15-10-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-10-1"  
class="td11">
 <!--l. 1948--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-11-"><td  style="white-space:wrap; text-align:left;" id="TBL-15-11-1"  
class="td11">
 <!--l. 1948--><p class="noindent" >            </td>
</tr>
</table></div>
<!--l. 2036--><p class="noindent" >The virtual queue page size is defined by writing to <span 
class="aeti-10">GuestPageSize</span>, as written by the
guest. The driver does this before the virtual queues are configured.
<!--l. 2040--><p class="noindent" >The virtual queue layout follows p. <a 
href="#x1-260002">2.6.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-260002">Legacy Interfaces: A Note on Virtqueue
Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>, with the alignment defined in <span 
class="aeti-10">QueueAlign</span>.
<!--l. 2044--><p class="noindent" >The virtual queue is configured as follows:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-161004x1">Select the queue writing its index (first queue is 0) to <span 
class="aeti-10">QueueSel</span>.
     </li>
     <li 
  class="enumerate" id="x1-161006x2">Check if the queue is not already in use: read <span 
class="aeti-10">QueuePFN</span>, expecting a
     returned value of zero (0x0).
     </li>
     <li 
  class="enumerate" id="x1-161008x3">Read maximum queue size (number of elements) from <span 
class="aeti-10">QueueNumMax</span>. If
     the returned value is zero (0x0) the queue is not available.
     </li>
     <li 
  class="enumerate" id="x1-161010x4">Allocate and zero the queue pages in contiguous virtual memory, aligning
     the Used Ring to an optimal boundary (usually page size). The driver
     should choose a queue size smaller than or equal to <span 
class="aeti-10">QueueNumMax</span>.
     </li>
     <li 
  class="enumerate" id="x1-161012x5">Notify the device about the queue size by writing the size to <span 
class="aeti-10">QueueNum</span>.
     </li>
     <li 
  class="enumerate" id="x1-161014x6">Notify the device about the used alignment by writing its value in bytes
     to <span 
class="aeti-10">QueueAlign</span>.
     </li>
     <li 
  class="enumerate" id="x1-161016x7">Write the physical number of the first page of the queue to the <span 
class="aeti-10">QueuePFN</span>
     register.</li></ol>
<!--l. 2071--><p class="noindent" >Notification mechanisms did not change.
                                                                  

                                                                  
<a 
 id="x1-161017r150"></a>
<h3 class="sectionHead"><span class="titlemark">4.3   </span> <a 
 id="x1-1620003"></a>Virtio Over Channel I/O</h3>
<!--l. 2075--><p class="nopar" >S/390 based virtual machines support neither PCI nor MMIO, so a different
transport is needed there.
<!--l. 2078--><p class="noindent" >virtio-ccw uses the standard channel I/O based mechanism used for the majority of
devices on S/390. A virtual channel device with a special control unit type acts as
proxy to the virtio device (similar to the way virtio-pci uses a PCI device) and
configuration and operation of the virtio device is accomplished (mostly) via channel
commands. This means virtio devices are discoverable via standard operating system
algorithms, and adding virtio support is mainly a question of supporting a new
control unit type.
<!--l. 2088--><p class="noindent" >As the S/390 is a big endian machine, the data structures transmitted via channel
commands are big-endian: this is made clear by use of the types be16, be32 and
be64.
<a 
 id="x1-162001r165"></a>
<h4 class="subsectionHead"><span class="titlemark">4.3.1   </span> <a 
 id="x1-1630001"></a>Basic Concepts</h4>
<!--l. 2094--><p class="nopar" >As a proxy device, virtio-ccw uses a channel-attached I/O control unit with a special
control unit type (0x3832) and a control unit model corresponding to the attached
virtio device’s subsystem device ID, accessed via a virtual I/O subchannel and a
virtual channel path of type 0x32. This proxy device is discoverable via normal
channel subsystem device discovery (usually a STORE SUBCHANNEL loop) and
answers to the basic channel commands:
     <ul class="itemize1">
     <li class="itemize">NO-OPERATION (0x03)
     </li>
     <li class="itemize">BASIC SENSE (0x04)
     </li>
     <li class="itemize">TRANSFER IN CHANNEL (0x08)
     </li>
     <li class="itemize">SENSE ID (0xe4)</li></ul>
<!--l. 2109--><p class="noindent" >For a virtio-ccw proxy device, SENSE ID will return the following information:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bytes  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Description                </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Contents              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > reserved                     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0xff                     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >1-2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >control unit type </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0x3832</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > control unit model       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <virtio device id>  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4-5     </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > device type                </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 6        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > device model              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 7-255  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > extended SenseId data  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 2130--><p class="noindent" >A virtio-ccw proxy device facilitates:
                                                                  

                                                                  
     <ul class="itemize1">
     <li class="itemize">Discovery and attachment of virtio devices (as described above).
     </li>
     <li class="itemize">Initialization   of   virtqueues   and   transport-specific   facilities   (using
     virtio-specific channel commands).
     </li>
     <li class="itemize">Notifications  (via  hypercall  and  a  combination  of  I/O  interrupts  and
     indicator bits).</li></ul>
<a 
 id="x1-163001r163"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.1   </span> <a 
 id="x1-1640001"></a>Channel Commands for Virtio</h5>
<!--l. 2142--><p class="nopar" >In addition to the basic channel commands, virtio-ccw defines a set of channel
commands related to configuration and operation of virtio:
<!--l. 2146-->
<div class="lstlisting" id="listing-35"><span class="label"><a 
 id="x1-164001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_VQ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x13</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_VDEV_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x33</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_IND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x43</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_CONF_IND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x53</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_IND_ADAPTER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x73</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_FEAT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x12</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_FEAT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x22</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x21</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_STATUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x31</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_VQ_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x32</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_VIRTIO_REV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x83</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-164013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_STATUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x72</span>
</div>
<a 
 id="x1-164014r169"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.2   </span> <a 
 id="x1-1650002"></a>Notifications</h5>
<!--l. 2165--><p class="nopar" >Available buffer notifications are realized as a hypercall. No additional setup by the
driver is needed. The operation of available buffer notifications is described in section
<a 
href="#x1-1940002">4.3.3.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Guest->Host Notification --></a>.
<!--l. 2170--><p class="noindent" >Used buffer notifications are realized either as so-called classic or adapter I/O
interrupts depending on a transport level negotiation. The initialization is described
in sections <a 
href="#x1-1820001">4.3.2.6.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Classic Queue Indicators --></a> and <a 
href="#x1-1840003">4.3.2.6.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Two-Stage Queue Indicators --></a> respectively. The operation of each flavor is
described in sections <a 
href="#x1-1890001">4.3.3.1.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Classic I/O Interrupts --></a> and <a 
href="#x1-1900002">4.3.3.1.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Adapter I/O Interrupts --></a> respectively.
<!--l. 2184--><p class="noindent" >Configuration change notifications are done using so-called classic I/O interrupts.
The initialization is described in section <a 
href="#x1-1830002">4.3.2.6.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Configuration Change Indicators --></a> and the operation in section
<a 
href="#x1-1890001">4.3.3.1.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Classic I/O Interrupts --></a>.
<a 
 id="x1-165001r170"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.3   </span> <a 
 id="x1-1660003"></a>Device Requirements: Basic Concepts</h5>
<!--l. 2194--><p class="nopar" >The virtio-ccw device acts like a normal channel device, as specified in <a 
href="#x1-3001r1">[S390 PoP]</a>
and <a 
href="#x1-3001r1">[S390 Common I/O]</a>. In particular:
     <ul class="itemize1">
     <li class="itemize">A device MUST post a unit check with command reject for any command
     it does not support.
     </li>
                                                                  

                                                                  
     <li class="itemize">If a driver did not suppress length checks for a channel command, the
     device MUST present a subchannel status as detailed in the architecture
     when the actual length did not match the expected length.
     </li>
     <li class="itemize">If a driver did suppress length checks for a channel command, the device
     MUST present a check condition if the transmitted data does not contain
     enough data to process the command. If the driver submitted a buffer that
     was too long, the device SHOULD accept the command.</li></ul>
<a 
 id="x1-166001r171"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.4   </span> <a 
 id="x1-1670004"></a>Driver Requirements: Basic Concepts</h5>
<!--l. 2213--><p class="nopar" >A driver for virtio-ccw devices MUST check for a control unit type of 0x3832 and
MUST ignore the device type and model.
<!--l. 2216--><p class="noindent" >A driver SHOULD attempt to provide the correct length in a channel command even
if it suppresses length checks for that command.
<a 
 id="x1-167001r168"></a>
<h4 class="subsectionHead"><span class="titlemark">4.3.2   </span> <a 
 id="x1-1680002"></a>Device Initialization</h4>
<!--l. 2221--><p class="nopar" >virtio-ccw uses several channel commands to set up a device.
<a 
 id="x1-168001r172"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.1   </span> <a 
 id="x1-1690001"></a>Setting the Virtio Revision</h5>
<!--l. 2225--><p class="nopar" >CCW_CMD_SET_VIRTIO_REV is issued by the driver to set the revision of the
virtio-ccw transport it intends to drive the device with. It uses the following
communication structure:
<!--l. 2229-->
<div class="lstlisting" id="listing-36"><span class="label"><a 
 id="x1-169001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_rev_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-169002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">revision</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-169003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-169004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-169005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2237--><p class="noindent" ><span 
class="aeti-10">revision </span>contains the desired revision id, <span 
class="aeti-10">length </span>the length of the data portion and
<span 
class="aeti-10">data </span>revision-dependent additional desired options.
<!--l. 2240--><p class="noindent" >The following values are supported:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">revision  </span></td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">length  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">data        </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > remarks                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > legacy interface; transitional devices only  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtio 1                                              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > CCW_CMD_READ_STATUS support      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3-n        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > reserved for later revisions                     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 2256--><p class="noindent" >Note that a change in the virtio standard does not necessarily correspond to a change
in the virtio-ccw revision.
<a 
 id="x1-169006r164"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.1</span> <a 
 id="x1-1700001"></a>Device Requirements: Setting the Virtio Revision</h5>
A device MUST post a unit check with command reject for any <span 
class="aeti-10">revision </span>it does not
support. For any invalid combination of <span 
class="aeti-10">revision</span>, <span 
class="aeti-10">length </span>and <span 
class="aeti-10">data</span>, it MUST post a
unit check with command reject as well. A non-transitional device MUST reject
revision id 0.
<!--l. 2266--><p class="noindent" >A device MUST answer with command reject to any virtio-ccw specific channel
command that is not contained in the revision selected by the driver.
<!--l. 2270--><p class="noindent" >A device MUST answer with command reject to any attempt to select a different
revision after a revision has been successfully selected by the driver.
<!--l. 2273--><p class="noindent" >A device MUST treat the revision as unset from the time the associated subchannel
has been enabled until a revision has been successfully set by the driver. This implies
that revisions are not persistent across disabling and enabling of the associated
subchannel.
<a 
 id="x1-170001r175"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.2</span> <a 
 id="x1-1710002"></a>Driver Requirements: Setting the Virtio Revision</h5>
A driver SHOULD start with trying to set the highest revision it supports and
continue with lower revisions if it gets a command reject.
<!--l. 2283--><p class="noindent" >A driver MUST NOT issue any other virtio-ccw specific channel commands prior to
setting the revision.
<!--l. 2286--><p class="noindent" >After a revision has been successfully selected by the driver, it MUST NOT attempt
to select a different revision.
<a 
 id="x1-171001r176"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.3</span> <a 
 id="x1-1720003"></a>Legacy Interfaces: A Note on Setting the Virtio Revision</h5>
A legacy device will not support the CCW_CMD_SET_VIRTIO_REV and answer
with a command reject. A non-transitional driver MUST stop trying to operate this
device in that case. A transitional driver MUST operate the device as if it had been
able to set revision 0.
<!--l. 2296--><p class="noindent" >A legacy driver will not issue the CCW_CMD_SET_VIRTIO_REV prior
to issuing other virtio-ccw specific channel commands. A non-transitional
device therefore MUST answer any such attempts with a command reject. A
transitional device MUST assume in this case that the driver is a legacy driver and
continue as if the driver selected revision 0. This implies that the device
MUST reject any command not valid for revision 0, including a subsequent
CCW_CMD_SET_VIRTIO_REV.
<a 
 id="x1-172001r174"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.2   </span> <a 
 id="x1-1730002"></a>Configuring a Virtqueue</h5>
<!--l. 2306--><p class="nopar" >CCW_CMD_READ_VQ_CONF is issued by the driver to obtain information about a
queue. It uses the following structure for communicating:
<!--l. 2309-->
<div class="lstlisting" id="listing-37"><span class="label"><a 
 id="x1-173001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_config_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2316--><p class="noindent" >The requested number of buffers for queue <span 
class="aeti-10">index </span>is returned in <span 
class="aeti-10">max_num</span>.
<!--l. 2319--><p class="noindent" >Afterwards, CCW_CMD_SET_VQ is issued by the driver to inform the device about
the location used for its queue. The transmitted structure is
<!--l. 2323-->
<div class="lstlisting" id="listing-38"><span class="label"><a 
 id="x1-173005r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_info_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173006r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173007r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">res0</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173008r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173009r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173010r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173011r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-173012r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2334--><p class="noindent" ><span 
class="aeti-10">desc</span>, <span 
class="aeti-10">driver </span>and <span 
class="aeti-10">device </span>contain the guest addresses for the descriptor area, available
area and used area for queue <span 
class="aeti-10">index</span>, respectively. The actual virtqueue size (number
of allocated buffers) is transmitted in <span 
class="aeti-10">num</span>.
<a 
 id="x1-173013r177"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.2.1</span> <a 
 id="x1-1740001"></a>Device Requirements: Configuring a Virtqueue</h5>
<span 
class="aeti-10">res0 </span>is reserved and MUST be ignored by the device.
<a 
 id="x1-174001r179"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.2.2</span> <a 
 id="x1-1750002"></a>Legacy Interface: A Note on Configuring a Virtqueue</h5>
For a legacy driver or for a driver that selected revision 0, CCW_CMD_SET_VQ uses
the following communication block:
<!--l. 2348-->
<div class="lstlisting" id="listing-39"><span class="label"><a 
 id="x1-175001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_info_block_legacy</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-175002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-175003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">align</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-175004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-175005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-175006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2357--><p class="noindent" ><span 
class="aeti-10">queue </span>contains the guest address for queue <span 
class="aeti-10">index</span>, <span 
class="aeti-10">num </span>the number of buffers and
<span 
class="aeti-10">align </span>the alignment. The queue layout follows <a 
href="#x1-260002">2.6.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-260002">Legacy Interfaces: A Note on
Virtqueue Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>.
<a 
 id="x1-175007r178"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.3   </span> <a 
 id="x1-1760003"></a>Communicating Status Information</h5>
<!--l. 2362--><p class="nopar" >The driver changes the status of a device via the CCW_CMD_WRITE_STATUS
command, which transmits an 8 bit status value.
<!--l. 2366--><p class="noindent" >As described in <a 
href="#x1-150002">2.2.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Feature Bits --></a>, a device sometimes fails to set the <span 
class="aeti-10">device status </span>field: For
example, it might fail to accept the FEATURES_OK status bit during device
initialization.
<!--l. 2371--><p class="noindent" >With revision 2, CCW_CMD_READ_STATUS is defined: It reads an 8 bit status value
from the device and acts as a reverse operation to CCW_CMD_WRITE_STATUS.
<a 
 id="x1-176001r180"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.3.1</span> <a 
 id="x1-1770001"></a>Driver Requirements: Communicating Status Information</h5>
If the device posts a unit check with command reject in response to the
CCW_CMD_WRITE_STATUS command, the driver MUST assume that the
device failed to set the status and the <span 
class="aeti-10">device status </span>field retained its previous
value.
<!--l. 2381--><p class="noindent" >If at least revision 2 has been negotiated, the driver SHOULD use the
CCW_CMD_READ_STATUS command to retrieve the <span 
class="aeti-10">device status </span>field after a
configuration change has been detected.
<!--l. 2385--><p class="noindent" >If not at least revision 2 has been negotiated, the driver MUST NOT attempt to issue
the CCW_CMD_READ_STATUS command.
<a 
 id="x1-177001r182"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.3.2</span> <a 
 id="x1-1780002"></a>Device Requirements: Communicating Status Information</h5>
If the device fails to set the <span 
class="aeti-10">device status </span>field to the value written by the driver, the
device MUST assure that the <span 
class="aeti-10">device status </span>field is left unchanged and MUST post a
unit check with command reject.
<!--l. 2395--><p class="noindent" >If at least revision 2 has been negotiated, the device MUST return the current <span 
class="aeti-10">device</span>
<span 
class="aeti-10">status </span>field if the CCW_CMD_READ_STATUS command is issued.
<a 
 id="x1-178001r181"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.4   </span> <a 
 id="x1-1790004"></a>Handling Device Features</h5>
<!--l. 2401--><p class="nopar" >Feature bits are arranged in an array of 32 bit values, making for a total of 8192
feature bits. Feature bits are in little-endian byte order.
<!--l. 2405--><p class="noindent" >The CCW commands dealing with features use the following communication
block:
<!--l. 2408-->
<div class="lstlisting" id="listing-40"><span class="label"><a 
 id="x1-179001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_feature_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-179002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">features</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-179003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-179004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 2415--><p class="noindent" ><span 
class="aeti-10">features </span>are the 32 bits of features currently accessed, while <span 
class="aeti-10">index </span>describes which of
the feature bit values is to be accessed. No padding is added at the end of the
structure, it is exactly 5 bytes in length.
<!--l. 2420--><p class="noindent" >The guest obtains the device’s device feature set via the CCW_CMD_READ_FEAT
command. The device stores the features at <span 
class="aeti-10">index </span>to <span 
class="aeti-10">features</span>.
<!--l. 2424--><p class="noindent" >For communicating its supported features to the device, the driver uses the
CCW_CMD_WRITE_FEAT command, denoting a <span 
class="aeti-10">features</span>/<span 
class="aeti-10">index </span>combination.
<a 
 id="x1-179005r184"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.5   </span> <a 
 id="x1-1800005"></a>Device Configuration</h5>
<!--l. 2430--><p class="nopar" >The device’s configuration space is located in host memory.
<!--l. 2432--><p class="noindent" >To obtain information from the configuration space, the driver uses
CCW_CMD_READ_CONF, specifying the guest memory for the device to write
to.
<!--l. 2436--><p class="noindent" >For changing configuration information, the driver uses CCW_CMD_WRITE_CONF,
specifying the guest memory for the device to read from.
<!--l. 2440--><p class="noindent" >In both cases, the complete configuration space is transmitted. This allows the driver
to compare the new configuration space with the old version, and keep a generation
count internally whenever it changes.
<a 
 id="x1-180001r185"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.6   </span> <a 
 id="x1-1810006"></a>Setting Up Indicators</h5>
<!--l. 2446--><p class="nopar" >In order to set up the indicator bits for host->guest notification, the driver
uses different channel commands depending on whether it wishes to use
traditional I/O interrupts tied to a subchannel or adapter I/O interrupts for
virtqueue notifications. For any given device, the two mechanisms are mutually
exclusive.
<!--l. 2452--><p class="noindent" >For the configuration change indicators, only a mechanism using traditional I/O
interrupts is provided, regardless of whether traditional or adapter I/O interrupts are
used for virtqueue notifications.
<a 
 id="x1-181001r183"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.1</span> <a 
 id="x1-1820001"></a>Setting Up Classic Queue Indicators</h5>
Indicators for notification via classic I/O interrupts are contained in a 64 bit value
per virtio-ccw proxy device.
<!--l. 2462--><p class="noindent" >To communicate the location of the indicator bits for host->guest notification, the
driver uses the CCW_CMD_SET_IND command, pointing to a location containing
the guest address of the indicators in a 64 bit value.
                                                                  

                                                                  
<!--l. 2467--><p class="noindent" >If the driver has already set up two-staged queue indicators via the
CCW_CMD_SET_IND_ADAPTER command, the device MUST post a unit check
with command reject to any subsequent CCW_CMD_SET_IND command.
<a 
 id="x1-182001r187"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.2</span> <a 
 id="x1-1830002"></a>Setting Up Configuration Change Indicators</h5>
Indicators for configuration change host->guest notification are contained in a 64 bit
value per virtio-ccw proxy device.
<!--l. 2476--><p class="noindent" >To communicate the location of the indicator bits used in the configuration change
host->guest notification, the driver issues the CCW_CMD_SET_CONF_IND
command, pointing to a location containing the guest address of the indicators in a
64 bit value.
<a 
 id="x1-183001r188"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.3</span> <a 
 id="x1-1840003"></a>Setting Up Two-Stage Queue Indicators</h5>
Indicators for notification via adapter I/O interrupts consist of two stages:
     <ul class="itemize1">
     <li class="itemize">a  summary  indicator  byte  covering  the  virtqueues  for  one  or  more
     virtio-ccw proxy devices
     </li>
     <li class="itemize">a set of contigous indicator bits for the virtqueues for a virtio-ccw proxy
     device</li></ul>
<!--l. 2492--><p class="noindent" >To communicate the location of the summary and queue indicator bits, the driver
uses the CCW_CMD_SET_IND_ADAPTER command with the following
payload:
<!--l. 2496-->
<div class="lstlisting" id="listing-41"><span class="label"><a 
 id="x1-184001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_thinint_area</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">summary_indicator</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicator</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bit_nr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">isc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">__attribute__</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">((</span><span 
class="pcrr8t-x-x-80">packed</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 2505--><p class="noindent" ><span 
class="aeti-10">summary_indicator </span>contains the guest address of the 8 bit summary indicator.
<span 
class="aeti-10">indicator </span>contains the guest address of an area wherein the indicators for the devices
are contained, starting at <span 
class="aeti-10">bit_nr</span>, one bit per virtqueue of the device. Bit numbers
start at the left, i.e. the most significant bit in the first byte is assigned the bit
number 0. <span 
class="aeti-10">isc </span>contains the I/O interruption subclass to be used for the adapter I/O
interrupt. It MAY be different from the isc used by the proxy virtio-ccw device’s
subchannel. No padding is added at the end of the structure, it is exactly 25 bytes in
length.
<a 
 id="x1-184007r141"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">4.3.2.6.3.1</span> <a 
 id="x1-1850001"></a>Device Requirements: Setting Up Two-Stage Queue Indicators</h6>
If the driver has already set up classic queue indicators via the CCW_CMD_SET_IND
command, the device MUST post a unit check with command reject to any
subsequent CCW_CMD_SET_IND_ADAPTER command.
<a 
 id="x1-185001r189"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.4</span> <a 
 id="x1-1860004"></a>Legacy Interfaces: A Note on Setting Up Indicators</h5>
In some cases, legacy devices will only support classic queue indicators; in that case,
they will reject CCW_CMD_SET_IND_ADAPTER as they don’t know that
command. Some legacy devices will support two-stage queue indicators, though, and
a driver will be able to successfully use CCW_CMD_SET_IND_ADAPTER to set
them up.
<a 
 id="x1-186001r173"></a>
<h4 class="subsectionHead"><span class="titlemark">4.3.3   </span> <a 
 id="x1-1870003"></a>Device Operation</h4>
<a 
 id="x1-187001r186"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.1   </span> <a 
 id="x1-1880001"></a>Host->Guest Notification</h5>
<!--l. 2535--><p class="nopar" >There are two modes of operation regarding host->guest notification, classic I/O
interrupts and adapter I/O interrupts. The mode to be used is determined by the driver
by using CCW_CMD_SET_IND respectively CCW_CMD_SET_IND_ADAPTER to
set up queue indicators.
<!--l. 2540--><p class="noindent" >For configuration changes, the driver always uses classic I/O interrupts.
<a 
 id="x1-188001r191"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.1</span> <a 
 id="x1-1890001"></a>Notification via Classic I/O Interrupts</h5>
If the driver used the CCW_CMD_SET_IND command to set up queue indicators,
the device will use classic I/O interrupts for host->guest notification about virtqueue
activity.
<!--l. 2549--><p class="noindent" >For notifying the driver of virtqueue buffers, the device sets the corresponding bit in
the guest-provided indicators. If an interrupt is not already pending for the
subchannel, the device generates an unsolicited I/O interrupt.
<!--l. 2554--><p class="noindent" >If the device wants to notify the driver about configuration changes, it sets bit 0
in the configuration indicators and generates an unsolicited I/O interrupt,
if needed. This also applies if adapter I/O interrupts are used for queue
notifications.
<a 
 id="x1-189001r194"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.2</span> <a 
 id="x1-1900002"></a>Notification via Adapter I/O Interrupts</h5>
If the driver used the CCW_CMD_SET_IND_ADAPTER command to set up queue
                                                                  

                                                                  
indicators, the device will use adapter I/O interrupts for host->guest notification
about virtqueue activity.
<!--l. 2565--><p class="noindent" >For notifying the driver of virtqueue buffers, the device sets the bit in the
guest-provided indicator area at the corresponding offset. The guest-provided
summary indicator is set to 0x01. An adapter I/O interrupt for the corresponding
interruption subclass is generated.
<!--l. 2570--><p class="noindent" >The recommended way to process an adapter I/O interrupt by the driver is as
follows:
     <ul class="itemize1">
     <li class="itemize">Process all queue indicator bits associated with the summary indicator.
     </li>
     <li class="itemize">Clear  the  summary  indicator,  performing  a  synchronization  (memory
     barrier) afterwards.
     </li>
     <li class="itemize">Process all queue indicator bits associated with the summary indicator
     again.</li></ul>
<a 
 id="x1-190001r190"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.3.3.1.2.1</span> <a 
 id="x1-1910001"></a>Device Requirements: Notification via Adapter I/O Interrupts</h6>
The device SHOULD only generate an adapter I/O interrupt if the summary
indicator had not been set prior to notification.
<a 
 id="x1-191001r196"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.3.3.1.2.2</span> <a 
 id="x1-1920002"></a>Driver Requirements: Notification via Adapter I/O Interrupts</h6>
The driver MUST clear the summary indicator after receiving an adapter I/O
interrupt before it processes the queue indicators.
<a 
 id="x1-192001r195"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.3</span> <a 
 id="x1-1930003"></a>Legacy Interfaces: A Note on Host->Guest Notification</h5>
As legacy devices and drivers support only classic queue indicators, host->guest
notification will always be done via classic I/O interrupts.
<a 
 id="x1-193001r193"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.2   </span> <a 
 id="x1-1940002"></a>Guest->Host Notification</h5>
<!--l. 2598--><p class="nopar" >For notifying the device of virtqueue buffers, the driver unfortunately can’t use a
channel command (the asynchronous characteristics of channel I/O interact badly
with the host block I/O backend). Instead, it uses a diagnose 0x500 call with subcode
3 specifying the queue, as follows:
                                                                  

                                                                  
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > GPR  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Input Value        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Output Value  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x3                   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Subchannel ID </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Host Cookie</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Notification data  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Host Cookie        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 2618--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has not been negotiated, the <span 
class="aeti-10">Notification</span>
<span 
class="aeti-10">data </span>contains the Virtqueue number.
<!--l. 2621--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has been negotiated, the value has the
following format: <!--l. 2623--><div class="lstinputlisting">
<a 
 id="x1-194001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-194002r1"></a></span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-194003r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vqn</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-194004r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-194005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-194006r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2625--><p class="noindent" >See <a 
href="#x1-9000023">2.7.23<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-9000023">Driver notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> for the definition of the components.
<a 
 id="x1-194007r198"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.2.1</span> <a 
 id="x1-1950001"></a>Device Requirements: Guest->Host Notification</h5>
The device MUST ignore bits 0-31 (counting from the left) of GPR2. This aligns
passing the subchannel ID with the way it is passed for the existing I/O
instructions.
<!--l. 2633--><p class="noindent" >The device MAY return a 64-bit host cookie in GPR2 to speed up the notification
execution.
<a 
 id="x1-195001r201"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.2.2</span> <a 
 id="x1-1960002"></a>Driver Requirements: Guest->Host Notification</h5>
For each notification, the driver SHOULD use GPR4 to pass the host cookie received
in GPR2 from the previous notication.
<span 
class="aebx-10">Note:</span> For example: <!--l. 2642-->
      <div class="lstlisting" id="listing-42"><span class="label"><a 
 id="x1-196001r1"></a></span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">cookie</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">do_notify</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">schid</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-196002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue_get_queue_index</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-196003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">cookie</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
      
      </div>
<a 
 id="x1-196004r199"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.3   </span> <a 
 id="x1-1970003"></a>Resetting Devices</h5>
<!--l. 2651--><p class="nopar" >In order to reset a device, a driver sends the CCW_CMD_VDEV_RESET
command.
                                                                  

                                                                  
<!--l. 2655--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">5</span> <a 
 id="x1-1980005"></a>Device Types</h2>
On top of the queues, config space and feature negotiation facilities built into virtio,
several devices are defined.
<!--l. 2660--><p class="noindent" >The following device IDs are used to identify different types of virtio devices. Some
device IDs are reserved for devices which are not currently defined in this
standard.
<!--l. 2664--><p class="noindent" >Discovering what devices are available and their type is bus-dependent.
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device ID  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Virtio Device              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       reserved (invalid)            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         network card              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >block device</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            console                  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >4 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >entropy source</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 5             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > memory ballooning (traditional)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 6             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          ioMemory                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-9"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 7             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            rpmsg                   </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-10"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          SCSI host                </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-11"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >9 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >9P transport</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-12"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 10            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >        mac80211 wlan             </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-13"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >11 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >rproc serial</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-14"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 12            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          virtio CAIF               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-15"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 13            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >        memory balloon            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-16"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          GPU device               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-17"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 17            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >      Timer/Clock device          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-18"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 18            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Input device               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-19"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 19            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Socket device              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-20"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 20            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Crypto device              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-21"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 21            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >   Signal Distribution Module     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-22"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 22            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         pstore device              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-23"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 23            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >        IOMMU device             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-24"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 24            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >        Memory device             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-25"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 26            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       file system device            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-26"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 27            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         PMEM device              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-27"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 2722--><p class="noindent" >Some of the devices above are unspecified by this document, because they are seen as
immature or especially niche. Be warned that some are only specified by the sole
existing implementation; they could become part of a future specification, be
abandoned entirely, or live on outside this standard. We shall speak of them no
further.
<a 
 id="x1-198001r167"></a>
<h3 class="sectionHead"><span class="titlemark">5.1   </span> <a 
 id="x1-1990001"></a>Network Device</h3>
<!--l. 2731--><p class="nopar" >The virtio network device is a virtual ethernet card, and is the most complex of the
devices supported so far by virtio. It has enhanced rapidly and demonstrates clearly
how support for new features are added to an existing device. Empty buffers are
placed in one virtqueue for receiving packets, and outgoing packets are enqueued into
another for transmission in that order. A third command queue is used to control
advanced filtering features.
<a 
 id="x1-199001r192"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.1.1   </span> <a 
 id="x1-2000001"></a>Device ID</h4>
<!--l. 2742--><p class="nopar" >1
<a 
 id="x1-200001r206"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.2   </span> <a 
 id="x1-2010002"></a>Virtqueues</h4>
     <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">receiveq1
     </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">transmitq1
     </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description">
     </dd><dt class="description">
<span 
class="aebx-10">2(N-1)</span> </dt><dd 
class="description">receiveqN
     </dd><dt class="description">
<span 
class="aebx-10">2(N-1)+1</span> </dt><dd 
class="description">transmitqN
     </dd><dt class="description">
<span 
class="aebx-10">2N</span> </dt><dd 
class="description">controlq</dd></dl>
<!--l. 2755--><p class="nopar" >N=1 if VIRTIO_NET_F_MQ is not negotiated, otherwise N is set by
<span 
class="aeti-10">max_virtqueue_pairs</span>.
<!--l. 2758--><p class="noindent" >controlq only exists if VIRTIO_NET_F_CTRL_VQ set.
<a 
 id="x1-201001r207"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.3   </span> <a 
 id="x1-2020003"></a>Feature bits</h4>
     <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CSUM (0)</span> </dt><dd 
class="description">Device handles packets with partial checksum.
     This “checksum offload” is a common feature on modern network cards.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_CSUM (1)</span> </dt><dd 
class="description">Driver handles packets with partial
     checksum.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_GUEST_OFFLOADS (2)</span> </dt><dd 
class="description">Control        channel
     offloads reconfiguration support.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MTU(3)</span> </dt><dd 
class="description">Device maximum MTU reporting is supported. If
     offered by the device, device advises driver about the value of its maximum
     MTU. If negotiated, the driver uses <span 
class="aeti-10">mtu </span>as the maximum MTU value.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MAC (5)</span> </dt><dd 
class="description">Device has given MAC address.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_TSO4 (7)</span> </dt><dd 
class="description">Driver can receive TSOv4.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_TSO6 (8)</span> </dt><dd 
class="description">Driver can receive TSOv6.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_ECN (9)</span> </dt><dd 
class="description">Driver can receive TSO with ECN.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_UFO (10)</span> </dt><dd 
class="description">Driver can receive UFO.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_TSO4 (11)</span> </dt><dd 
class="description">Device can receive TSOv4.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_TSO6 (12)</span> </dt><dd 
class="description">Device can receive TSOv6.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_ECN (13)</span> </dt><dd 
class="description">Device can receive TSO with ECN.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_UFO (14)</span> </dt><dd 
class="description">Device can receive UFO.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MRG_RXBUF (15)</span> </dt><dd 
class="description">Driver can merge receive buffers.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_STATUS (16)</span> </dt><dd 
class="description">Configuration status field is available.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_VQ (17)</span> </dt><dd 
class="description">Control channel is available.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_RX (18)</span> </dt><dd 
class="description">Control channel RX mode support.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_VLAN (19)</span> </dt><dd 
class="description">Control channel VLAN filtering.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_ANNOUNCE(21)</span> </dt><dd 
class="description">Driver can send gratuitous
     packets.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MQ(22)</span> </dt><dd 
class="description">Device   supports   multiqueue   with   automatic
     receive steering.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_MAC_ADDR(23)</span> </dt><dd 
class="description">Set   MAC   address   through
     control channel.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_RSC_EXT(61)</span> </dt><dd 
class="description">Device can process duplicated ACKs and
     report number of coalesced segments and duplicated ACKs
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_STANDBY(62)</span> </dt><dd 
class="description">Device  may  act  as  a  standby  for  a
     primary device with the same MAC address.</dd></dl>
<a 
 id="x1-202001r203"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.3.1   </span> <a 
 id="x1-2030001"></a>Feature bit requirements</h5>
<!--l. 2823--><p class="nopar" >Some networking feature bits require other networking feature bits (see <a 
href="#x1-140001">2.2.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Feature Bits --></a>):
     <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_TSO4</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_TSO6</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_ECN</span> </dt><dd 
class="description">Requires  VIRTIO_NET_F_GUEST_TSO4
     or VIRTIO_NET_F_GUEST_TSO6.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_UFO</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_TSO4</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_TSO6</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_ECN</span> </dt><dd 
class="description">Requires  VIRTIO_NET_F_HOST_TSO4  or
     VIRTIO_NET_F_HOST_TSO6.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_UFO</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_RX</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_VLAN</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_ANNOUNCE</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MQ</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_MAC_ADDR</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_RSC_EXT</span> </dt><dd 
class="description">Requires   VIRTIO_NET_F_HOST_TSO4   or
     VIRTIO_NET_F_HOST_TSO6.</dd></dl>
<a 
 id="x1-203001r209"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.3.2   </span> <a 
 id="x1-2040002"></a>Legacy Interface: Feature bits</h5>
     <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GSO (6)</span> </dt><dd 
class="description">Device handles packets with any GSO type. This
     was supposed to indicate segmentation offload support, but upon further
     investigation it became clear that multiple bits were needed.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_RSC4 (41)</span> </dt><dd 
class="description">Device coalesces TCPIP v4 packets.
     This was implemented by hypervisor patch for certification purposes and
     current Windows driver depends on it. It will not function if virtio-net
     device reports this feature.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_RSC6 (42)</span> </dt><dd 
class="description">Device coalesces TCPIP v6 packets.
     Similar to VIRTIO_NET_F_GUEST_RSC4.</dd></dl>
<a 
 id="x1-204001r208"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.4   </span> <a 
 id="x1-2050004"></a>Device configuration layout</h4>
<!--l. 2857--><p class="nopar" >Three driver-read-only configuration fields are currently defined. The <span 
class="aeti-10">mac </span>address
field always exists (though is only valid if VIRTIO_NET_F_MAC is set), and <span 
class="aeti-10">status</span>
only exists if VIRTIO_NET_F_STATUS is set. Two read-only bits (for the driver)
are currently defined for the status field: VIRTIO_NET_S_LINK_UP and
VIRTIO_NET_S_ANNOUNCE.
<!--l. 2863-->
<div class="lstlisting" id="listing-43"><span class="label"><a 
 id="x1-205001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_S_LINK_UP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-205002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_S_ANNOUNCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 2868--><p class="noindent" >The following driver-read-only field, <span 
class="aeti-10">max_virtqueue_pairs </span>only exists if
VIRTIO_NET_F_MQ is set. This field specifies the maximum number of each of
transmit and receive virtqueues (receiveq1…receiveqN and transmitq1…transmitqN
respectively) that can be configured once VIRTIO_NET_F_MQ is negotiated.
<!--l. 2874--><p class="noindent" >The following driver-read-only field, <span 
class="aeti-10">mtu </span>only exists if VIRTIO_NET_F_MTU is set.
This field specifies the maximum MTU for the driver to use.
<!--l. 2878-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-44"><span class="label"><a 
 id="x1-205003r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-205004r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac</span><span 
class="pcrr8t-x-x-80">[6];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-205005r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-205006r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_virtqueue_pairs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-205007r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mtu</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-205008r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-205009r210"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.1   </span> <a 
 id="x1-2060001"></a>Device Requirements: Device configuration layout</h5>
<!--l. 2889--><p class="nopar" >The device MUST set <span 
class="aeti-10">max_virtqueue_pairs </span>to between 1 and 0x8000 inclusive, if it
offers VIRTIO_NET_F_MQ.
<!--l. 2892--><p class="noindent" >The device MUST set <span 
class="aeti-10">mtu </span>to between 68 and 65535 inclusive, if it offers
VIRTIO_NET_F_MTU.
<!--l. 2895--><p class="noindent" >The device SHOULD set <span 
class="aeti-10">mtu </span>to at least 1280, if it offers VIRTIO_NET_F_MTU.
<!--l. 2898--><p class="noindent" >The device MUST NOT modify <span 
class="aeti-10">mtu </span>once it has been set.
<!--l. 2900--><p class="noindent" >The device MUST NOT pass received packets that exceed <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) size with <span 
class="aeti-10">gso_type </span>NONE or ECN after VIRTIO_NET_F_MTU has
been successfully negotiated.
<!--l. 2904--><p class="noindent" >The device MUST forward transmitted packets of up to <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) size with <span 
class="aeti-10">gso_type </span>NONE or ECN, and do so without fragmentation,
after VIRTIO_NET_F_MTU has been successfully negotiated.
<!--l. 2909--><p class="noindent" >If the driver negotiates the VIRTIO_NET_F_STANDBY feature, the device
MAY act as a standby device for a primary device with the same MAC
address.
<a 
 id="x1-206001r212"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.2   </span> <a 
 id="x1-2070002"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 2914--><p class="nopar" >A driver SHOULD negotiate VIRTIO_NET_F_MAC if the device offers it. If
the driver negotiates the VIRTIO_NET_F_MAC feature, the driver MUST
set the physical address of the NIC to <span 
class="aeti-10">mac</span>. Otherwise, it SHOULD use a
locally-administered MAC address (see <a 
href="#x1-3001r1">IEEE 802</a>, “9.2 48-bit universal LAN MAC
addresses”).
<!--l. 2920--><p class="noindent" >If the driver does not negotiate the VIRTIO_NET_F_STATUS feature, it SHOULD
assume the link is active, otherwise it SHOULD read the link status from the bottom
bit of <span 
class="aeti-10">status</span>.
<!--l. 2924--><p class="noindent" >A driver SHOULD negotiate VIRTIO_NET_F_MTU if the device offers it.
<!--l. 2926--><p class="noindent" >If the driver negotiates VIRTIO_NET_F_MTU, it MUST supply enough receive
buffers to receive at least one receive packet of size <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) with <span 
class="aeti-10">gso_type </span>NONE or ECN.
<!--l. 2930--><p class="noindent" >If the driver negotiates VIRTIO_NET_F_MTU, it MUST NOT transmit packets of
size exceeding the value of <span 
class="aeti-10">mtu </span>(plus low level ethernet header length) with <span 
class="aeti-10">gso_type</span>
NONE or ECN.
                                                                  

                                                                  
<!--l. 2934--><p class="noindent" >A driver SHOULD negotiate the VIRTIO_NET_F_STANDBY feature if the device
offers it.
<a 
 id="x1-207001r213"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.3   </span> <a 
 id="x1-2080003"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 2938--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format <span 
class="aeti-10">status</span>
and <span 
class="aeti-10">max_virtqueue_pairs </span>in struct virtio_net_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 2944--><p class="noindent" >When using the legacy interface, <span 
class="aeti-10">mac </span>is driver-writable which provided a way for drivers
to update the MAC without negotiating VIRTIO_NET_F_CTRL_MAC_ADDR.
<a 
 id="x1-208001r211"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.5   </span> <a 
 id="x1-2090005"></a>Device Initialization</h4>
<!--l. 2950--><p class="nopar" >A driver would perform a typical initialization routine like so:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-209002x1">Identify  and  initialize  the  receive  and  transmission  virtqueues,  up  to
     N  of  each  kind.  If  VIRTIO_NET_F_MQ  feature  bit  is  negotiated,
     N=<span 
class="aeti-10">max_virtqueue_pairs</span>, otherwise identify N=1.
     </li>
     <li 
  class="enumerate" id="x1-209004x2">If the VIRTIO_NET_F_CTRL_VQ feature bit is negotiated, identify the
     control virtqueue.
     </li>
     <li 
  class="enumerate" id="x1-209006x3">Fill the receive queues with buffers: see <a 
href="#x1-2160003">5.1.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>.
     </li>
     <li 
  class="enumerate" id="x1-209008x4">Even with VIRTIO_NET_F_MQ, only receiveq1, transmitq1 and controlq
     are       used       by       default.       The       driver       would       send
     the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command specifying the
     number of the transmit and receive queues to use.
     </li>
     <li 
  class="enumerate" id="x1-209010x5">If the VIRTIO_NET_F_MAC feature bit is set, the configuration space
     <span 
class="aeti-10">mac </span>entry indicates the “physical” address of the network card, otherwise
     the driver would typically generate a random local MAC address.
     </li>
     <li 
  class="enumerate" id="x1-209012x6">If the VIRTIO_NET_F_STATUS feature bit is negotiated, the link status
     comes from the bottom bit of <span 
class="aeti-10">status</span>. Otherwise, the driver assumes it’s
     active.
     </li>
     <li 
  class="enumerate" id="x1-209014x7">A performant driver would indicate that it will generate checksumless
     packets by negotating the VIRTIO_NET_F_CSUM feature.
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x1-209016x8">If that feature is negotiated, a driver can use TCP or UDP segmentation
     offload  by  negotiating  the  VIRTIO_NET_F_HOST_TSO4  (IPv4  TCP),
     VIRTIO_NET_F_HOST_TSO6            (IPv6            TCP)            and
     VIRTIO_NET_F_HOST_UFO (UDP fragmentation) features.
     </li>
     <li 
  class="enumerate" id="x1-209018x9">The converse features are also available: a driver can save the virtual device
     some work by negotiating these features.
     <span 
class="aebx-10">Note:</span> For example, a network packet transported between two guests on
           the                                 same                                 system
           might not need checksumming at all, nor segmentation, if both
           guests are amenable. The VIRTIO_NET_F_GUEST_CSUM feature
           indicates  that  partially  checksummed  packets  can  be  received,
           and if it can do that then the VIRTIO_NET_F_GUEST_TSO4,
           VIRTIO_NET_F_GUEST_TSO6,  VIRTIO_NET_F_GUEST_UFO
           and VIRTIO_NET_F_GUEST_ECN are the input equivalents of
           the  features  described  above.  See  <a 
href="#x1-2160003">5.1.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a> <a 
href="#x1-2160003">Setting  Up  Receive
           Buffers<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a> and <a 
href="#x1-2190004">5.1.6.4<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a> <a 
href="#x1-2190004">Processing of Incoming Packets<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a> below.
<!--l. 3002--><p class="noindent" >A truly minimal driver would only accept VIRTIO_NET_F_MAC and ignore
everything else.
<a 
 id="x1-209019r215"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.6   </span> <a 
 id="x1-2100006"></a>Device Operation</h4>
<!--l. 3007--><p class="nopar" >Packets are transmitted by placing them in the transmitq1…transmitqN, and buffers
for incoming packets are placed in the receiveq1…receiveqN. In each case, the packet
itself is preceded by a header:
<!--l. 3012-->
<div class="lstlisting" id="listing-45"><span class="label"><a 
 id="x1-210001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_F_NEEDS_CSUM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_F_DATA_VALID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_F_RSC_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_TCPV4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_UDP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_TCPV6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_ECN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gso_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gso_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">csum_start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">csum_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_buffers</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-210017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 3032--><p class="noindent" >The controlq is used to control device features such as filtering.
<a 
 id="x1-210018r214"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.1   </span> <a 
 id="x1-2110001"></a>Legacy Interface: Device Operation</h5>
<!--l. 3036--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_net_hdr according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 3041--><p class="noindent" >The legacy driver only presented <span 
class="aeti-10">num_buffers </span>in the struct virtio_net_hdr when
                                                                  

                                                                  
VIRTIO_NET_F_MRG_RXBUF was negotiated; without that feature the structure
was 2 bytes shorter.
<!--l. 3045--><p class="noindent" >When using the legacy interface, the driver SHOULD ignore the used length for the
transmit queues and the controlq queue.
<span 
class="aebx-10">Note:</span> Historically, some devices put the total descriptor length there, even
      though no data was actually written.
<a 
 id="x1-211001r217"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.2   </span> <a 
 id="x1-2120002"></a>Packet Transmission</h5>
<!--l. 3056--><p class="nopar" >Transmitting a single packet is simple, but varies depending on the different features
the driver negotiated.
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-212002x1">The driver can send a completely checksummed packet. In this case, <span 
class="aeti-10">flags</span>
    will be zero, and <span 
class="aeti-10">gso_type </span>will be VIRTIO_NET_HDR_GSO_NONE.
    </li>
    <li 
  class="enumerate" id="x1-212004x2">If the driver negotiated VIRTIO_NET_F_CSUM, it can skip checksumming the
    packet:
        <ul class="itemize1">
        <li class="itemize"><span 
class="aeti-10">flags </span>has the VIRTIO_NET_HDR_F_NEEDS_CSUM set,
        </li>
        <li class="itemize"><span 
class="aeti-10">csum_start   </span>is   set   to   the   offset   within   the   packet   to   begin
        checksumming, and
        </li>
        <li class="itemize"><span 
class="aeti-10">csum_offset </span>indicates how many bytes after the csum_start the new
        (16 bit ones’ complement) checksum is placed by the device.
        </li>
        <li class="itemize">The TCP checksum field in the packet is set to the sum of the TCP
        pseudo header, so that replacing it by the ones’ complement checksum
        of the TCP header and body will give the correct result.</li></ul>
    <span 
class="aebx-10">Note:</span> For example, consider a partially checksummed TCP (IPv4) packet.
          It will have a 14 byte ethernet header and 20 byte IP header followed
          by the TCP header (with the TCP checksum field 16 bytes into
          that header). <span 
class="aeti-10">csum_start </span>will be 14+20 = 34 (the TCP checksum
          includes the header), and <span 
class="aeti-10">csum_offset </span>will be 16.
    </li>
    <li 
  class="enumerate" id="x1-212006x3">If the driver negotiated VIRTIO_NET_F_HOST_TSO4, TSO6 or UFO, and the
    packet requires TCP segmentation or UDP fragmentation, then <span 
class="aeti-10">gso_type </span>is set
    to VIRTIO_NET_HDR_GSO_TCPV4, TCPV6 or UDP. (Otherwise, it is set to
                                                                  

                                                                  
    VIRTIO_NET_HDR_GSO_NONE). In this case, packets larger than 1514
    bytes can be transmitted: the metadata indicates how to replicate the
    packet header to cut it into smaller packets. The other gso fields are
    set:
        <ul class="itemize1">
        <li class="itemize"><span 
class="aeti-10">hdr_len </span>is a hint to the device as to how much of the header needs to be
        kept to copy into each packet, usually set to the length of the headers,
        including the transport header<span class="footnote-mark"><a 
href="#fn8x5" id="fn8x5-bk"><sup class="textsuperscript">8</sup></a></span><a 
 id="x1-212007f8"></a>.
        </li>
        <li class="itemize"><span 
class="aeti-10">gso_size </span>is the maximum size of each packet beyond that header (ie.
        MSS).
        </li>
        <li class="itemize">If the driver negotiated the VIRTIO_NET_F_HOST_ECN feature, the
        VIRTIO_NET_HDR_GSO_ECN bit in <span 
class="aeti-10">gso_type </span>indicates that the TCP
        packet has the ECN bit set<span class="footnote-mark"><a 
href="#fn9x5" id="fn9x5-bk"><sup class="textsuperscript">9</sup></a></span><a 
 id="x1-212008f9"></a>.</li></ul>
    </li>
    <li 
  class="enumerate" id="x1-212010x4"><span 
class="aeti-10">num_buffers </span>is set to zero. This field is unused on transmitted packets.
    </li>
    <li 
  class="enumerate" id="x1-212012x5">The header and packet are added as one output descriptor to the transmitq, and
    the device is notified of the new entry (see <a 
href="#x1-2090005">5.1.5<!--tex4ht:ref: sec:Device Types / Network Device / Device Initialization --></a> <a 
href="#x1-2090005">Device Initialization<!--tex4ht:ref: sec:Device Types / Network Device / Device Initialization --></a>).</li></ol>
<a 
 id="x1-212013r202"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.1</span> <a 
 id="x1-2130001"></a>Driver Requirements: Packet Transmission</h5>
The driver MUST set <span 
class="aeti-10">num_buffers </span>to zero.
<!--l. 3124--><p class="noindent" >If VIRTIO_NET_F_CSUM is not negotiated, the driver MUST set <span 
class="aeti-10">flags </span>to zero and
SHOULD supply a fully checksummed packet to the device.
<!--l. 3128--><p class="noindent" >If VIRTIO_NET_F_HOST_TSO4 is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_TCPV4 to request TCPv4 segmentation, otherwise the
driver MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV4.
<!--l. 3133--><p class="noindent" >If VIRTIO_NET_F_HOST_TSO6 is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_TCPV6 to request TCPv6 segmentation, otherwise the
driver MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV6.
<!--l. 3138--><p class="noindent" >If VIRTIO_NET_F_HOST_UFO is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_UDP to request UDP segmentation, otherwise the driver
MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_UDP.
<!--l. 3143--><p class="noindent" >The driver SHOULD NOT send to the device TCP packets requiring segmentation
offload which have the Explicit Congestion Notification bit set, unless the
VIRTIO_NET_F_HOST_ECN feature is negotiated, in which case the driver MUST
set the VIRTIO_NET_HDR_GSO_ECN bit in <span 
class="aeti-10">gso_type</span>.
                                                                  

                                                                  
<!--l. 3149--><p class="noindent" >If the VIRTIO_NET_F_CSUM feature has been negotiated, the driver MAY set the
VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags</span>, if so:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-213002x1">the driver MUST validate the packet checksum at offset <span 
class="aeti-10">csum_offset </span>from
    <span 
class="aeti-10">csum_start </span>as well as all preceding offsets;
    </li>
    <li 
  class="enumerate" id="x1-213004x2">the  driver  MUST  set  the  packet  checksum  stored  in  the  buffer  to  the
    TCP/UDP pseudo header;
    </li>
    <li 
  class="enumerate" id="x1-213006x3">the driver MUST set <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset </span>such that calculating a
    ones’ complement checksum from <span 
class="aeti-10">csum_start </span>up until the end of the packet
    and storing the result at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>will result in
    a fully checksummed packet;</li></ol>
<!--l. 3166--><p class="noindent" >If none of the VIRTIO_NET_F_HOST_TSO4, TSO6 or UFO options have been
negotiated, the driver MUST set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_NONE.
<!--l. 3170--><p class="noindent" >If <span 
class="aeti-10">gso_type </span>differs from VIRTIO_NET_HDR_GSO_NONE, then the driver MUST also
set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>and MUST set <span 
class="aeti-10">gso_size </span>to
indicate the desired MSS.
<!--l. 3175--><p class="noindent" >If one of the VIRTIO_NET_F_HOST_TSO4, TSO6 or UFO options have been
negotiated, the driver SHOULD set <span 
class="aeti-10">hdr_len </span>to a value not less than the length of the
headers, including the transport header.
<!--l. 3180--><p class="noindent" >The driver MUST NOT set the VIRTIO_NET_HDR_F_DATA_VALID and
VIRTIO_NET_HDR_F_RSC_INFO bits in <span 
class="aeti-10">flags</span>.
<a 
 id="x1-213007r219"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.2</span> <a 
 id="x1-2140002"></a>Device Requirements: Packet Transmission</h5>
The device MUST ignore <span 
class="aeti-10">flag </span>bits that it does not recognize.
<!--l. 3186--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>is not set, the device MUST
NOT use the <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset</span>.
<!--l. 3189--><p class="noindent" >If one of the VIRTIO_NET_F_HOST_TSO4, TSO6 or UFO options have been
negotiated, the device MAY use <span 
class="aeti-10">hdr_len </span>only as a hint about the transport header
size. The device MUST NOT rely on <span 
class="aeti-10">hdr_len </span>to be correct.
<span 
class="aebx-10">Note:</span> This is due to various bugs in implementations.
<!--l. 3197--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM is not set, the device MUST NOT rely on
the packet checksum being correct.
<a 
 id="x1-214001r220"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.3</span> <a 
 id="x1-2150003"></a>Packet Transmission Interrupt</h5>
Often a driver will suppress transmission virtqueue interrupts and check for used
packets in the transmit path of following packets.
<!--l. 3205--><p class="noindent" >The normal behavior in this interrupt handler is to retrieve used buffers from the
virtqueue and free the corresponding headers and packets.
<a 
 id="x1-215001r218"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.3   </span> <a 
 id="x1-2160003"></a>Setting Up Receive Buffers</h5>
<!--l. 3211--><p class="nopar" >It is generally a good idea to keep the receive virtqueue as fully populated as
possible: if it runs out, network performance will suffer.
<!--l. 3215--><p class="noindent" >If the VIRTIO_NET_F_GUEST_TSO4, VIRTIO_NET_F_GUEST_TSO6 or
VIRTIO_NET_F_GUEST_UFO features are used, the maximum incoming packet will
be to 65550 bytes long (the maximum size of a TCP or UDP packet, plus the 14 byte
ethernet header), otherwise 1514 bytes. The 12-byte struct virtio_net_hdr is
prepended to this, making for 65562 or 1526 bytes.
<a 
 id="x1-216001r221"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.3.1</span> <a 
 id="x1-2170001"></a>Driver Requirements: Setting Up Receive Buffers</h5>
    <ul class="itemize1">
    <li class="itemize">If VIRTIO_NET_F_MRG_RXBUF is not negotiated:
        <ul class="itemize2">
        <li class="itemize">If  VIRTIO_NET_F_GUEST_TSO4,  VIRTIO_NET_F_GUEST_TSO6
        or VIRTIO_NET_F_GUEST_UFO are negotiated, the driver SHOULD
        populate the receive queue(s) with buffers of at least 65562 bytes.
        </li>
        <li class="itemize">Otherwise, the driver SHOULD populate the receive queue(s) with
        buffers of at least 1526 bytes.</li></ul>
    </li>
    <li class="itemize">If VIRTIO_NET_F_MRG_RXBUF is negotiated, each buffer MUST be at least
    the size of the struct virtio_net_hdr.</li></ul>
<span 
class="aebx-10">Note:</span> Obviously each buffer can be split across multiple descriptor elements.
<!--l. 3241--><p class="nopar" >If VIRTIO_NET_F_MQ is negotiated, each of receiveq1…receiveqN that will be used
SHOULD be populated with receive buffers.
<a 
 id="x1-217001r223"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.3.2</span> <a 
 id="x1-2180002"></a>Device Requirements: Setting Up Receive Buffers</h5>
The device MUST set <span 
class="aeti-10">num_buffers </span>to the number of descriptors used to hold the
                                                                  

                                                                  
incoming packet.
<!--l. 3249--><p class="noindent" >The device MUST use only a single descriptor if VIRTIO_NET_F_MRG_RXBUF was
not negotiated.
<span 
class="aebx-10">Note:</span> This                                                                                means
      that <span 
class="aeti-10">num_buffers </span>will always be 1 if VIRTIO_NET_F_MRG_RXBUF is
      not negotiated.
<a 
 id="x1-218001r222"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.4   </span> <a 
 id="x1-2190004"></a>Processing of Incoming Packets</h5>
<!--l. 3259--><p class="nopar" >When a packet is copied into a buffer in the receiveq, the optimal path is to disable
further used buffer notifications for the receiveq and process packets until no more
are found, then re-enable them.
<!--l. 3264--><p class="noindent" >Processing incoming packets involves:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-219002x1"><span 
class="aeti-10">num_buffers                              </span>indicates                                how
    many descriptors this packet is spread over (including this one): this will
    always be 1 if VIRTIO_NET_F_MRG_RXBUF was not negotiated. This
    allows receipt of large packets without having to allocate large buffers: a
    packet that does not fit in a single buffer can flow over to the next buffer,
    and so on. In this case, there will be at least <span 
class="aeti-10">num_buffers </span>used buffers in the
    virtqueue, and the device chains them together to form a single packet in a
    way similar to how it would store it in a single buffer spread over multiple
    descriptors. The other buffers will not begin with a struct virtio_net_hdr.
    </li>
    <li 
  class="enumerate" id="x1-219004x2">If <span 
class="aeti-10">num_buffers </span>is one, then the entire packet will be contained within this
    buffer, immediately following the struct virtio_net_hdr.
    </li>
    <li 
  class="enumerate" id="x1-219006x3">If  the  VIRTIO_NET_F_GUEST_CSUM  feature  was  negotiated,  the
    VIRTIO_NET_HDR_F_DATA_VALID bit in <span 
class="aeti-10">flags </span>can be set: if so, device
    has  validated  the  packet  checksum.  In  case  of  multiple  encapsulated
    protocols, one level of checksums has been validated.</li></ol>
<!--l. 3290--><p class="noindent" >Additionally, VIRTIO_NET_F_GUEST_CSUM, TSO4, TSO6, UDP and ECN
features enable receive checksum, large receive offload and ECN support which are
the input equivalents of the transmit checksum, transmit segmentation offloading and
ECN features, as described in <a 
href="#x1-2120002">5.1.6.2<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Packet Transmission --></a>:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-219008x1">If                        the                        VIRTIO_NET_F_GUEST_TSO4,
    TSO6 or UFO options were negotiated, then <span 
class="aeti-10">gso_type </span>MAY be something
    other than VIRTIO_NET_HDR_GSO_NONE, and <span 
class="aeti-10">gso_size </span>field indicates
    the desired MSS (see Packet Transmission point 2).
                                                                  

                                                                  
    </li>
    <li 
  class="enumerate" id="x1-219010x2">If  the  VIRTIO_NET_F_RSC_EXT  option  was  negotiated  (this  implies
    one of VIRTIO_NET_F_GUEST_TSO4, TSO6), the device processes also
    duplicated ACK segments, reports number of coalesced TCP segments in
    <span 
class="aeti-10">csum_start </span>field and number of duplicated ACK segments in <span 
class="aeti-10">csum_offset</span>
    field and sets bit VIRTIO_NET_HDR_F_RSC_INFO in <span 
class="aeti-10">flags</span>.
    </li>
    <li 
  class="enumerate" id="x1-219012x3">If  the  VIRTIO_NET_F_GUEST_CSUM  feature  was  negotiated,  the
    VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>can be set: if so, the
    packet checksum at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>and any preceding
    checksums have been validated. The checksum on the packet is incomplete
    and  if  bit  VIRTIO_NET_HDR_F_RSC_INFO  is  not  set  in  <span 
class="aeti-10">flags</span>,  then
    <span 
class="aeti-10">csum_start  </span>and  <span 
class="aeti-10">csum_offset  </span>indicate  how  to  calculate  it  (see  Packet
    Transmission point 1).
    </li></ol>
<a 
 id="x1-219013r224"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.4.1</span> <a 
 id="x1-2200001"></a>Device Requirements: Processing of Incoming Packets</h5>
If VIRTIO_NET_F_MRG_RXBUF has not been negotiated, the device MUST set
<span 
class="aeti-10">num_buffers </span>to 1.
<!--l. 3324--><p class="noindent" >If VIRTIO_NET_F_MRG_RXBUF has been negotiated, the device MUST set
<span 
class="aeti-10">num_buffers </span>to indicate the number of buffers the packet (including the header) is
spread over.
<!--l. 3328--><p class="noindent" >If a receive packet is spread over multiple buffers, the device MUST use all buffers
but the last (i.e. the first <span 
class="cmmi-10">num</span><sub><span 
class="cmmi-7">b</span></sub><span 
class="cmmi-10">uffers</span><span 
class="cmsy-10">− </span><span 
class="cmr-10">1 </span>buffers) completely up to the full length of
each buffer supplied by the driver.
<!--l. 3333--><p class="noindent" >The device MUST use all buffers used by a single receive packet together, such that
at least <span 
class="aeti-10">num_buffers </span>are observed by driver as used.
<!--l. 3337--><p class="noindent" >If VIRTIO_NET_F_GUEST_CSUM is not negotiated, the device MUST
set <span 
class="aeti-10">flags </span>to zero and SHOULD supply a fully checksummed packet to the
driver.
<!--l. 3341--><p class="noindent" >If VIRTIO_NET_F_GUEST_TSO4 is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV4.
<!--l. 3344--><p class="noindent" >If VIRTIO_NET_F_GUEST_UDP is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_UDP.
<!--l. 3347--><p class="noindent" >If VIRTIO_NET_F_GUEST_TSO6 is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV6.
<!--l. 3350--><p class="noindent" >The device SHOULD NOT send to the driver TCP packets requiring segmentation
offload which have the Explicit Congestion Notification bit set, unless the
VIRTIO_NET_F_GUEST_ECN feature is negotiated, in which case the device MUST
                                                                  

                                                                  
set the VIRTIO_NET_HDR_GSO_ECN bit in <span 
class="aeti-10">gso_type</span>.
<!--l. 3356--><p class="noindent" >If the VIRTIO_NET_F_GUEST_CSUM feature has been negotiated, the
device MAY set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags</span>, if
so:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-220002x1">the device MUST validate the packet checksum at offset <span 
class="aeti-10">csum_offset </span>from
    <span 
class="aeti-10">csum_start </span>as well as all preceding offsets;
    </li>
    <li 
  class="enumerate" id="x1-220004x2">the device MUST set the packet checksum stored in the receive buffer to
    the TCP/UDP pseudo header;
    </li>
    <li 
  class="enumerate" id="x1-220006x3">the device MUST set <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset </span>such that calculating a
    ones’ complement checksum from <span 
class="aeti-10">csum_start </span>up until the end of the packet
    and storing the result at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>will result in
    a fully checksummed packet;</li></ol>
<!--l. 3373--><p class="noindent" >If none of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the device MUST set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_NONE.
<!--l. 3377--><p class="noindent" >If <span 
class="aeti-10">gso_type </span>differs from VIRTIO_NET_HDR_GSO_NONE, then the device MUST also
set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>MUST set <span 
class="aeti-10">gso_size </span>to
indicate the desired MSS. If VIRTIO_NET_F_RSC_EXT was negotiated, the device
MUST also set VIRTIO_NET_HDR_F_RSC_INFO bit in <span 
class="aeti-10">flags</span>, set <span 
class="aeti-10">csum_start </span>to
number of coalesced TCP segments and set <span 
class="aeti-10">csum_offset </span>to number of received
duplicated ACK segments.
<!--l. 3385--><p class="noindent" >If VIRTIO_NET_F_RSC_EXT was not negotiated, the device MUST not set
VIRTIO_NET_HDR_F_RSC_INFO bit in <span 
class="aeti-10">flags</span>.
<!--l. 3388--><p class="noindent" >If one of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the device SHOULD set <span 
class="aeti-10">hdr_len </span>to a value not less than the length of the
headers, including the transport header.
<!--l. 3393--><p class="noindent" >If the VIRTIO_NET_F_GUEST_CSUM feature has been negotiated, the device MAY
set the VIRTIO_NET_HDR_F_DATA_VALID bit in <span 
class="aeti-10">flags</span>, if so, the device MUST
validate the packet checksum (in case of multiple encapsulated protocols, one level of
checksums is validated).
<a 
 id="x1-220007r226"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.4.2</span> <a 
 id="x1-2210002"></a>Driver Requirements: Processing of Incoming Packets</h5>
The driver MUST ignore <span 
class="aeti-10">flag </span>bits that it does not recognize.
<!--l. 3405--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>is not set or if
VIRTIO_NET_HDR_F_RSC_INFO bit <span 
class="aeti-10">flags </span>is set, the driver MUST NOT use the
<span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset</span>.
                                                                  

                                                                  
<!--l. 3409--><p class="noindent" >If one of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the driver MAY use <span 
class="aeti-10">hdr_len </span>only as a hint about the transport header
size. The driver MUST NOT rely on <span 
class="aeti-10">hdr_len </span>to be correct.
<span 
class="aebx-10">Note:</span> This is due to various bugs in implementations.
<!--l. 3417--><p class="noindent" >If neither VIRTIO_NET_HDR_F_NEEDS_CSUM nor VIRTIO_NET_HDR_F_DATA_VALID
is set, the driver MUST NOT rely on the packet checksum being correct.
<a 
 id="x1-221001r225"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.5   </span> <a 
 id="x1-2220005"></a>Control Virtqueue</h5>
<!--l. 3422--><p class="nopar" >The driver uses the control virtqueue (if VIRTIO_NET_F_CTRL_VQ is negotiated)
to send commands to manipulate various features of the device which would not
easily map into the configuration space.
<!--l. 3427--><p class="noindent" >All commands are of the following form:
<!--l. 3429-->
<div class="lstlisting" id="listing-46"><span class="label"><a 
 id="x1-222001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">class</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ack</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222008r8"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ack</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_ERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 3442--><p class="noindent" >The <span 
class="aeti-10">class</span>, <span 
class="aeti-10">command </span>and command-specific-data are set by the driver, and the device
sets the <span 
class="aeti-10">ack </span>byte. There is little it can do except issue a diagnostic if <span 
class="aeti-10">ack </span>is not
VIRTIO_NET_OK.
<a 
 id="x1-222011r227"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.1</span> <a 
 id="x1-2230001"></a>Packet Receive Filtering</h5>
If the VIRTIO_NET_F_CTRL_RX and VIRTIO_NET_F_CTRL_RX_EXTRA features
are negotiated, the driver can send control commands for promiscuous mode,
multicast, unicast and broadcast receiving.
<span 
class="aebx-10">Note:</span> In general, these commands are best-effort: unwanted packets could still
      arrive.
<!--l. 3459-->
<div class="lstlisting" id="listing-47"><span class="label"><a 
 id="x1-223001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-223002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_PROMISC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-223003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_ALLMULTI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-223004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_ALLUNI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-223005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOMULTI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-223006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOUNI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-223007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOBCAST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span>
</div>
<a 
 id="x1-223008r197"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.1.1</span> <a 
 id="x1-2240001"></a>Device Requirements: Packet Receive Filtering</h6>
If the VIRTIO_NET_F_CTRL_RX feature has been negotiated, the device MUST
                                                                  

                                                                  
support the following VIRTIO_NET_CTRL_RX class commands:
    <ul class="itemize1">
    <li class="itemize">VIRTIO_NET_CTRL_RX_PROMISC turns promiscuous mode on and off.
    The command-specific-data is one byte containing 0 (off) or 1 (on). If
    promiscous mode is on, the device SHOULD receive all incoming packets.
    This  SHOULD  take  effect  even  if  one  of  the  other  modes  set  by  a
    VIRTIO_NET_CTRL_RX class command is on.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_ALLMULTI turns all-multicast receive on and
    off. The command-specific-data is one byte containing 0 (off) or 1 (on).
    When all-multicast receive is on the device SHOULD allow all incoming
    multicast packets.</li></ul>
<!--l. 3488--><p class="noindent" >If the VIRTIO_NET_F_CTRL_RX_EXTRA feature has been negotiated, the device
MUST support the following VIRTIO_NET_CTRL_RX class commands:
    <ul class="itemize1">
    <li class="itemize">VIRTIO_NET_CTRL_RX_ALLUNI  turns  all-unicast  receive  on  and  off.
    The command-specific-data is one byte containing 0 (off) or 1 (on). When
    all-unicast receive is on the device SHOULD allow all incoming unicast
    packets.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOMULTI  suppresses  multicast  receive.  The
    command-specific-data is one byte containing 0 (multicast receive allowed)
    or 1 (multicast receive suppressed). When multicast receive is suppressed,
    the  device  SHOULD  NOT  send  multicast  packets  to  the  driver.  This
    SHOULD take effect even if VIRTIO_NET_CTRL_RX_ALLMULTI is on.
    This filter SHOULD NOT apply to broadcast packets.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOUNI    suppresses    unicast    receive.    The
    command-specific-data is one byte containing 0 (unicast receive allowed)
    or 1 (unicast receive suppressed). When unicast receive is suppressed, the
    device SHOULD NOT send unicast packets to the driver. This SHOULD
    take effect even if VIRTIO_NET_CTRL_RX_ALLUNI is on.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOBCAST suppresses broadcast receive. The
    command-specific-data is one byte containing 0 (broadcast receive allowed)
    or 1 (broadcast receive suppressed). When broadcast receive is suppressed,
    the  device  SHOULD  NOT  send  broadcast  packets  to  the  driver.  This
    SHOULD take effect even if VIRTIO_NET_CTRL_RX_ALLMULTI is on.</li></ul>
<a 
 id="x1-224001r230"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.1.2</span> <a 
 id="x1-2250002"></a>Driver Requirements: Packet Receive Filtering</h6>
If the VIRTIO_NET_F_CTRL_RX feature has not been negotiated, the driver
MUST NOT issue commands VIRTIO_NET_CTRL_RX_PROMISC or
VIRTIO_NET_CTRL_RX_ALLMULTI.
<!--l. 3523--><p class="noindent" >If the VIRTIO_NET_F_CTRL_RX_EXTRA feature has not been negotiated, the
driver MUST NOT issue commands VIRTIO_NET_CTRL_RX_ALLUNI,
VIRTIO_NET_CTRL_RX_NOMULTI, VIRTIO_NET_CTRL_RX_NOUNI or
VIRTIO_NET_CTRL_RX_NOBCAST.
<a 
 id="x1-225001r229"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.2</span> <a 
 id="x1-2260002"></a>Setting MAC Address Filtering</h5>
If the VIRTIO_NET_F_CTRL_RX feature is negotiated, the driver can send control
commands for MAC address filtering.
<!--l. 3535-->
<div class="lstlisting" id="listing-48"><span class="label"><a 
 id="x1-226001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl_mac</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-226002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-226003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">macs</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">][6];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-226004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-226005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-226006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-226007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC_TABLE_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-226008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC_ADDR_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 3546--><p class="noindent" >The device can filter incoming packets by any number of destination MAC
addresses<span class="footnote-mark"><a 
href="#fn10x5" id="fn10x5-bk"><sup class="textsuperscript">10</sup></a></span><a 
 id="x1-226009f10"></a>.
This table is set using the class VIRTIO_NET_CTRL_MAC and the command
VIRTIO_NET_CTRL_MAC_TABLE_SET. The command-specific-data is
two variable length tables of 6-byte MAC addresses (as described in struct
virtio_net_ctrl_mac). The first table contains unicast addresses, and the second
contains multicast addresses.
<!--l. 3556--><p class="noindent" >The VIRTIO_NET_CTRL_MAC_ADDR_SET command is used to set the default
MAC address which rx filtering accepts (and if VIRTIO_NET_F_MAC_ADDR has
been negotiated, this will be reflected in <span 
class="aeti-10">mac </span>in config space).
<!--l. 3561--><p class="noindent" >The command-specific-data for VIRTIO_NET_CTRL_MAC_ADDR_SET is the 6-byte
MAC address.
<a 
 id="x1-226010r231"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.1</span> <a 
 id="x1-2270001"></a>Device Requirements: Setting MAC Address Filtering</h6>
The device MUST have an empty MAC filtering table on reset.
<!--l. 3568--><p class="noindent" >The device MUST update the MAC filtering table before it consumes the
VIRTIO_NET_CTRL_MAC_TABLE_SET command.
<!--l. 3571--><p class="noindent" >The device MUST update <span 
class="aeti-10">mac </span>in config space before it consumes the
VIRTIO_NET_CTRL_MAC_ADDR_SET command, if VIRTIO_NET_F_MAC_ADDR
has been negotiated.
                                                                  

                                                                  
<!--l. 3575--><p class="noindent" >The device SHOULD drop incoming packets which have a destination MAC which
matches neither the <span 
class="aeti-10">mac </span>(or that set with VIRTIO_NET_CTRL_MAC_ADDR_SET)
nor the MAC filtering table.
<a 
 id="x1-227001r233"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.2</span> <a 
 id="x1-2280002"></a>Driver Requirements: Setting MAC Address Filtering</h6>
If VIRTIO_NET_F_CTRL_RX has not been negotiated, the driver MUST NOT issue
VIRTIO_NET_CTRL_MAC class commands.
<!--l. 3584--><p class="noindent" >If VIRTIO_NET_F_CTRL_RX has been negotiated, the driver SHOULD issue
VIRTIO_NET_CTRL_MAC_ADDR_SET to set the default mac if it is different from
<span 
class="aeti-10">mac</span>.
<!--l. 3588--><p class="noindent" >The driver MUST follow the VIRTIO_NET_CTRL_MAC_TABLE_SET command by
a le32 number, followed by that number of non-multicast MAC addresses, followed by
another le32 number, followed by that number of multicast addresses. Either number
MAY be 0.
<a 
 id="x1-228001r234"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.3</span> <a 
 id="x1-2290003"></a>Legacy Interface: Setting MAC Address Filtering</h6>
When using the legacy interface, transitional devices and drivers MUST
format <span 
class="aeti-10">entries </span>in struct virtio_net_ctrl_mac according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 3599--><p class="noindent" >Legacy drivers that didn’t negotiate VIRTIO_NET_F_CTRL_MAC_ADDR changed
<span 
class="aeti-10">mac </span>in config space when NIC is accepting incoming packets. These drivers
always wrote the mac value from first to last byte, therefore after detecting
such drivers, a transitional device MAY defer MAC update, or MAY defer
processing incoming packets until driver writes the last byte of <span 
class="aeti-10">mac </span>in the config
space.
<a 
 id="x1-229001r232"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.3</span> <a 
 id="x1-2300003"></a>VLAN Filtering</h5>
If the driver negotiates the VIRTION_NET_F_CTRL_VLAN feature, it can control a
VLAN filter table in the device.
<!--l. 3612-->
<div class="lstlisting" id="listing-49"><span class="label"><a 
 id="x1-230001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-230002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN_ADD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-230003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN_DEL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 3618--><p class="noindent" >Both the VIRTIO_NET_CTRL_VLAN_ADD and VIRTIO_NET_CTRL_VLAN_DEL
command take a little-endian 16-bit VLAN id as the command-specific-data.
<a 
 id="x1-230004r235"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.3.1</span> <a 
 id="x1-2310001"></a>Legacy Interface: VLAN Filtering</h6>
When using the legacy interface, transitional devices and drivers MUST format the
VLAN id according to the native endian of the guest rather than (necessarily when
not using the legacy interface) little-endian.
<a 
 id="x1-231001r236"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.4</span> <a 
 id="x1-2320004"></a>Gratuitous Packet Sending</h5>
If the driver negotiates the VIRTIO_NET_F_GUEST_ANNOUNCE (depends on
VIRTIO_NET_F_CTRL_VQ), the device can ask the driver to send gratuitous
packets; this is usually done after the guest has been physically migrated, and needs
to announce its presence on the new network links. (As hypervisor does not have the
knowledge of guest network configuration (eg. tagged vlan) it is simplest to prod the
guest in this way).
<!--l. 3637-->
<div class="lstlisting" id="listing-50"><span class="label"><a 
 id="x1-232001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_ANNOUNCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_ANNOUNCE_ACK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
</div>
<!--l. 3642--><p class="noindent" >The driver checks VIRTIO_NET_S_ANNOUNCE bit in the device configuration
<span 
class="aeti-10">status </span>field when it notices the changes of device configuration. The command
VIRTIO_NET_CTRL_ANNOUNCE_ACK is used to indicate that driver has received
the notification and device clears the VIRTIO_NET_S_ANNOUNCE bit in
<span 
class="aeti-10">status</span>.
<!--l. 3648--><p class="noindent" >Processing this notification involves:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-232004x1">Sending the gratuitous packets (eg. ARP) or marking there are pending
    gratuitous packets to be sent and letting deferred routine to send them.
    </li>
    <li 
  class="enumerate" id="x1-232006x2">Sending   VIRTIO_NET_CTRL_ANNOUNCE_ACK   command   through
    control vq.</li></ol>
<a 
 id="x1-232007r237"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.4.1</span> <a 
 id="x1-2330001"></a>Driver Requirements: Gratuitous Packet Sending</h6>
If the driver negotiates VIRTIO_NET_F_GUEST_ANNOUNCE, it SHOULD notify
network peers of its new location after it sees the VIRTIO_NET_S_ANNOUNCE
bit in <span 
class="aeti-10">status</span>. The driver MUST send a command on the command
queue with class VIRTIO_NET_CTRL_ANNOUNCE and command
VIRTIO_NET_CTRL_ANNOUNCE_ACK.
<a 
 id="x1-233001r239"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.4.2</span> <a 
 id="x1-2340002"></a>Device Requirements: Gratuitous Packet Sending</h6>
If VIRTIO_NET_F_GUEST_ANNOUNCE is negotiated, the device MUST
clear the VIRTIO_NET_S_ANNOUNCE bit in <span 
class="aeti-10">status </span>upon receipt of a
command buffer with class VIRTIO_NET_CTRL_ANNOUNCE and command
VIRTIO_NET_CTRL_ANNOUNCE_ACK before marking the buffer as used.
<a 
 id="x1-234001r238"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.5</span> <a 
 id="x1-2350005"></a>Automatic receive steering in multiqueue mode</h5>
If the driver negotiates the VIRTIO_NET_F_MQ feature bit (depends on
VIRTIO_NET_F_CTRL_VQ), it MAY transmit outgoing packets on one of
the multiple transmitq1…transmitqN and ask the device to queue incoming
packets into one of the multiple receiveq1…receiveqN depending on the packet
flow.
<!--l. 3681-->
<div class="lstlisting" id="listing-51"><span class="label"><a 
 id="x1-235001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl_mq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-235002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue_pairs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-235003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-235004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-235005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-235006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-235007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_MIN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-235008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_MAX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x8000</span>
</div>
<!--l. 3692--><p class="noindent" >Multiqueue is disabled by default. The driver enables multiqueue by executing the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command, specifying the number of the
transmit and receive queues to be used up to <span 
class="aeti-10">max_virtqueue_pairs</span>; subsequently,
transmitq1…transmitqn and receiveq1…receiveqn where n=<span 
class="aeti-10">virtqueue_pairs </span>MAY be
used.
<!--l. 3699--><p class="noindent" >When multiqueue is enabled, the device MUST use automatic receive steering based
on packet flow. Programming of the receive steering classificator is implicit.
After the driver transmitted a packet of a flow on transmitqX, the device
SHOULD cause incoming packets for that flow to be steered to receiveqX.
For uni-directional protocols, or where no packets have been transmitted
yet, the device MAY steer a packet to a random queue out of the specified
receiveq1…receiveqn.
<!--l. 3707--><p class="noindent" >Multiqueue is disabled by setting <span 
class="aeti-10">virtqueue_pairs </span>to 1 (this is the default) and
waiting for the device to use the command buffer.
<a 
 id="x1-235009r240"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.5.1</span> <a 
 id="x1-2360001"></a>Driver Requirements: Automatic receive steering in multiqueue
mode</h6>
The driver MUST configure the virtqueues before enabling them with the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command.
<!--l. 3715--><p class="noindent" >The driver MUST NOT request a <span 
class="aeti-10">virtqueue_pairs </span>of 0 or greater than
<span 
class="aeti-10">max_virtqueue_pairs </span>in the device configuration space.
                                                                  

                                                                  
<!--l. 3718--><p class="noindent" >The driver MUST queue packets only on any transmitq1 before the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command.
<!--l. 3721--><p class="noindent" >The driver MUST NOT queue packets on transmit queues greater than
<span 
class="aeti-10">virtqueue_pairs </span>once it has placed the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET
command in the available ring.
<a 
 id="x1-236001r242"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.5.2</span> <a 
 id="x1-2370002"></a>Device Requirements: Automatic receive steering in multiqueue
mode</h6>
The device MUST queue packets only on any receiveq1 before the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command.
<!--l. 3729--><p class="noindent" >The device MUST NOT queue packets on receive queues greater than <span 
class="aeti-10">virtqueue_pairs</span>
once it has placed the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command in a
used buffer.
<a 
 id="x1-237001r243"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.5.3</span> <a 
 id="x1-2380003"></a>Legacy Interface: Automatic receive steering in multiqueue mode</h6>
When using the legacy interface, transitional devices and drivers MUST format
<span 
class="aeti-10">virtqueue_pairs </span>according to the native endian of the guest rather than (necessarily
when not using the legacy interface) little-endian.
<a 
 id="x1-238001r241"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.6</span> <a 
 id="x1-2390006"></a>Offloads State Configuration</h5>
If the VIRTIO_NET_F_CTRL_GUEST_OFFLOADS feature is negotiated, the driver
can send control commands for dynamic offloads state configuration.
<a 
 id="x1-239001r244"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.1</span> <a 
 id="x1-2400001"></a>Setting Offloads State</h6>
To configure the offloads, the following layout structure and definitions are
used:
<!--l. 3749-->
<div class="lstlisting" id="listing-52"><span class="label"><a 
 id="x1-240001r1"></a></span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offloads</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_CSUM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_TSO4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_TSO6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_ECN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_UFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_GUEST_OFFLOADS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-240010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_GUEST_OFFLOADS_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
</div>
<!--l. 3762--><p class="noindent" >The class VIRTIO_NET_CTRL_GUEST_OFFLOADS has one command:
VIRTIO_NET_CTRL_GUEST_OFFLOADS_SET applies the new offloads
configuration.
<!--l. 3765--><p class="noindent" >le64 value passed as command data is a bitmask, bits set define offloads to be
enabled, bits cleared - offloads to be disabled.
                                                                  

                                                                  
<!--l. 3768--><p class="noindent" >There is a corresponding device feature for each offload. Upon feature negotiation
corresponding offload gets enabled to preserve backward compartibility.
<a 
 id="x1-240011r246"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.2</span> <a 
 id="x1-2410002"></a>Driver Requirements: Setting Offloads State</h6>
A driver MUST NOT enable an offload for which the appropriate feature has not
been negotiated.
<a 
 id="x1-241001r247"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.3</span> <a 
 id="x1-2420003"></a>Legacy Interface: Setting Offloads State</h6>
When using the legacy interface, transitional devices and drivers MUST format
<span 
class="aeti-10">offloads </span>according to the native endian of the guest rather than (necessarily when not
using the legacy interface) little-endian.
<a 
 id="x1-242001r228"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.6   </span> <a 
 id="x1-2430006"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 3787--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use a single descriptor for the struct
virtio_net_hdr on both transmit and receive, with the network data in the following
descriptors.
<!--l. 3792--><p class="noindent" >Additionally, when using the control virtqueue (see <a 
href="#x1-2220005">5.1.6.5<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue --></a>) , transitional drivers
which have not negotiated VIRTIO_F_ANY_LAYOUT MUST:
    <ul class="itemize1">
    <li class="itemize">for all commands, use a single 2-byte descriptor including the first two
    fields: <span 
class="aeti-10">class </span>and <span 
class="aeti-10">command</span>
    </li>
    <li class="itemize">for all commands except VIRTIO_NET_CTRL_MAC_TABLE_SET use a
    single descriptor including command-specific-data with no padding.
    </li>
    <li class="itemize">for  the  VIRTIO_NET_CTRL_MAC_TABLE_SET  command  use  exactly
    two descriptors including command-specific-data with no padding: the first
    of these descriptors MUST include the virtio_net_ctrl_mac table structure
    for the unicast addresses with no padding, the second of these descriptors
    MUST include the virtio_net_ctrl_mac table structure for the multicast
    addresses with no padding.
    </li>
    <li class="itemize">for all commands, use a single 1-byte descriptor for the <span 
class="aeti-10">ack </span>field</li></ul>
<!--l. 3813--><p class="noindent" >See <a 
href="#x1-280004">2.6.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing --></a>.
<a 
 id="x1-243001r205"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">5.2   </span> <a 
 id="x1-2440002"></a>Block Device</h3>
<!--l. 3818--><p class="nopar" >The virtio block device is a simple virtual block device (ie. disk). Read and write
requests (and other exotic requests) are placed in the queue, and serviced (probably
out of order) by the device except where noted.
<a 
 id="x1-244001r216"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.1   </span> <a 
 id="x1-2450001"></a>Device ID</h4>
<!--l. 3824--><p class="nopar" >2
<a 
 id="x1-245001r251"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.2   </span> <a 
 id="x1-2460002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">requestq</dd></dl>
<a 
 id="x1-246001r252"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.3   </span> <a 
 id="x1-2470003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_SIZE_MAX (1)</span> </dt><dd 
class="description">Maximum size of any single segment is in
    <span 
class="aeti-10">size_max</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_SEG_MAX (2)</span> </dt><dd 
class="description">Maximum   number   of   segments   in   a
    request is in <span 
class="aeti-10">seg_max</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_GEOMETRY (4)</span> </dt><dd 
class="description">Disk-style    geometry    specified    in
    <span 
class="aeti-10">geometry</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_RO (5)</span> </dt><dd 
class="description">Device is read-only.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_BLK_SIZE (6)</span> </dt><dd 
class="description">Block size of disk is in <span 
class="aeti-10">blk_size</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_FLUSH (9)</span> </dt><dd 
class="description">Cache flush command support.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_TOPOLOGY (10)</span> </dt><dd 
class="description">Device    exports    information    on
    optimal I/O alignment.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_CONFIG_WCE (11)</span> </dt><dd 
class="description">Device can toggle its cache between
    writeback and writethrough modes.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_DISCARD (13)</span> </dt><dd 
class="description">Device  can  support  discard  command,
                                                                  

                                                                  
    maximum discard sectors size in <span 
class="aeti-10">max_discard_sectors </span>and maximum discard
    segment number in <span 
class="aeti-10">max_discard_seg</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_WRITE_ZEROES (14)</span> </dt><dd 
class="description">Device can support write zeroes
    command, maximum write zeroes sectors size in <span 
class="aeti-10">max_write_zeroes_sectors</span>
    and maximum write zeroes segment number in <span 
class="aeti-10">max_write_zeroes_seg</span>.</dd></dl>
<a 
 id="x1-247001r249"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.3.1   </span> <a 
 id="x1-2480001"></a>Legacy Interface: Feature bits</h5>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_BARRIER (0)</span> </dt><dd 
class="description">Device supports request barriers.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_SCSI (7)</span> </dt><dd 
class="description">Device supports scsi packet commands.</dd></dl>
<span 
class="aebx-10">Note:</span> In  the  legacy  interface,  VIRTIO_BLK_F_FLUSH  was  also  called
      VIRTIO_BLK_F_WCE.
<a 
 id="x1-248001r253"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.4   </span> <a 
 id="x1-2490004"></a>Device configuration layout</h4>
<!--l. 3879--><p class="nopar" >The <span 
class="aeti-10">capacity </span>of the device (expressed in 512-byte sectors) is always present.
The availability of the others all depend on various feature bits as indicated
above.
<!--l. 3883--><p class="noindent" >The parameters in the configuration space of the device <span 
class="aeti-10">max_discard_sectors</span>
<span 
class="aeti-10">discard_sector_alignment </span>are expressed in 512-byte units if the VIRTIO_BLK_F_DISCARD
feature bit is negotiated. The <span 
class="aeti-10">max_write_zeroes_sectors </span>is expressed in 512-byte units
if the VIRTIO_BLK_F_WRITE_ZEROES feature bit is negotiated.
<!--l. 3889-->
<div class="lstlisting" id="listing-53"><span class="label"><a 
 id="x1-249001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capacity</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">seg_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_geometry</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cylinders</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">geometry</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blk_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_topology</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">logical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">per</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">log2</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">physical_block_exp</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aligned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">logical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alignment_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">suggested</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">minimum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">min_io_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimal</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">suggested</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">maximum</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opt_io_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">topology</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">writeback</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unused0</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_discard_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_discard_seg</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">discard_sector_alignment</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_write_zeroes_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_write_zeroes_seg</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write_zeroes_may_unmap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unused1</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249030r30"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-249031r254"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.4.1   </span> <a 
 id="x1-2500001"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 3924--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_blk_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-250001r255"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.2.5   </span> <a 
 id="x1-2510005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-251002x1">The device size can be read from <span 
class="aeti-10">capacity</span>.
    </li>
    <li 
  class="enumerate" id="x1-251004x2">If the VIRTIO_BLK_F_BLK_SIZE feature is negotiated, <span 
class="aeti-10">blk_size </span>can be
    read to determine the optimal sector size for the driver to use. This does
    not affect the units used in the protocol (always 512 bytes), but awareness
    of the correct value can affect performance.
    </li>
    <li 
  class="enumerate" id="x1-251006x3">If the VIRTIO_BLK_F_RO feature is set by the device, any write requests
    will fail.
    </li>
    <li 
  class="enumerate" id="x1-251008x4">If the VIRTIO_BLK_F_TOPOLOGY feature is negotiated, the fields in the
    <span 
class="aeti-10">topology </span>struct can be read to determine the physical block size and optimal
    I/O lengths for the driver to use. This also does not affect the units in the
    protocol, only performance.
    </li>
    <li 
  class="enumerate" id="x1-251010x5">If  the  VIRTIO_BLK_F_CONFIG_WCE  feature  is  negotiated,  the  cache
    mode can be read or set through the <span 
class="aeti-10">writeback </span>field. 0 corresponds to a
    writethrough cache, 1 to a writeback cache<span class="footnote-mark"><a 
href="#fn11x5" id="fn11x5-bk"><sup class="textsuperscript">11</sup></a></span><a 
 id="x1-251011f11"></a>.
    The cache mode after reset can be either writeback or writethrough. The
    actual mode can be determined by reading <span 
class="aeti-10">writeback </span>after feature negotiation.
    </li>
    <li 
  class="enumerate" id="x1-251013x6">If                                                                                           the
    VIRTIO_BLK_F_DISCARD feature is negotiated, <span 
class="aeti-10">max_discard_sectors </span>and
    <span 
class="aeti-10">max_discard_seg </span>can be read to determine the maximum discard sectors
    and maximum number of discard segments for the block driver to use.
    <span 
class="aeti-10">discard_sector_alignment </span>can be used by OS when splitting a request based
    on alignment.
    </li>
    <li 
  class="enumerate" id="x1-251015x7">if        the        VIRTIO_BLK_F_WRITE_ZEROES        feature        is
    negotiated, <span 
class="aeti-10">max_write_zeroes_sectors </span>and <span 
class="aeti-10">max_write_zeroes_seg </span>can be read
    to determine the maximum write zeroes sectors and maximum number of
    write zeroes segments for the block driver to use.</li></ol>
<a 
 id="x1-251016r256"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.1   </span> <a 
 id="x1-2520001"></a>Driver Requirements: Device Initialization</h5>
<!--l. 3975--><p class="nopar" >Drivers SHOULD NOT negotiate VIRTIO_BLK_F_FLUSH if they are incapable of
sending VIRTIO_BLK_T_FLUSH commands.
<!--l. 3978--><p class="noindent" >If neither VIRTIO_BLK_F_CONFIG_WCE nor VIRTIO_BLK_F_FLUSH are
                                                                  

                                                                  
negotiated, the driver MAY deduce the presence of a writethrough cache. If
VIRTIO_BLK_F_CONFIG_WCE was not negotiated but VIRTIO_BLK_F_FLUSH
was, the driver SHOULD assume presence of a writeback cache.
<!--l. 3983--><p class="noindent" >The driver MUST NOT read <span 
class="aeti-10">writeback </span>before setting the FEATURES_OK <span 
class="aeti-10">device</span>
<span 
class="aeti-10">status </span>bit.
<a 
 id="x1-252001r258"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.2   </span> <a 
 id="x1-2530002"></a>Device Requirements: Device Initialization</h5>
<!--l. 3988--><p class="nopar" >Devices SHOULD always offer VIRTIO_BLK_F_FLUSH, and MUST offer it if they
offer VIRTIO_BLK_F_CONFIG_WCE.
<!--l. 3991--><p class="noindent" >If VIRTIO_BLK_F_CONFIG_WCE is negotiated but VIRTIO_BLK_F_FLUSH is not,
the device MUST initialize <span 
class="aeti-10">writeback </span>to 0.
<!--l. 3994--><p class="noindent" >The device MUST initialize padding bytes <span 
class="aeti-10">unused0 </span>and <span 
class="aeti-10">unused1 </span>to 0.
<a 
 id="x1-253001r259"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.3   </span> <a 
 id="x1-2540003"></a>Legacy Interface: Device Initialization</h5>
<!--l. 3999--><p class="nopar" >Because legacy devices do not have FEATURES_OK, transitional devices
MUST implement slightly different behavior around feature negotiation
when used through the legacy interface. In particular, when using the legacy
interface:
    <ul class="itemize1">
    <li class="itemize">the driver MAY read or write <span 
class="aeti-10">writeback  </span>before setting the DRIVER or
    DRIVER_OK <span 
class="aeti-10">device status </span>bit
    </li>
    <li class="itemize">the device MUST NOT modify the cache mode (and <span 
class="aeti-10">writeback</span>) as a result
    of a driver setting a status bit, unless the DRIVER_OK bit is being set and
    the driver has not set the VIRTIO_BLK_F_CONFIG_WCE driver feature
    bit.
    </li>
    <li class="itemize">the device MUST NOT modify the cache mode (and <span 
class="aeti-10">writeback</span>) as a result
    of a driver modifying the driver feature bits, for example if the driver sets
    the VIRTIO_BLK_F_CONFIG_WCE driver feature bit but does not set
    the VIRTIO_BLK_F_FLUSH bit.</li></ul>
<a 
 id="x1-254001r257"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.6   </span> <a 
 id="x1-2550006"></a>Device Operation</h4>
<!--l. 4022--><p class="nopar" >The driver queues requests to the virtqueue, and they are used by the device (not
necessarily in order). Each request is of form:
<!--l. 4025-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-54"><span class="label"><a 
 id="x1-255001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4035--><p class="noindent" >The type of the request is either a read (VIRTIO_BLK_T_IN), a write
(VIRTIO_BLK_T_OUT), a discard (VIRTIO_BLK_T_DISCARD), a write zeroes
(VIRTIO_BLK_T_WRITE_ZEROES) or a flush (VIRTIO_BLK_T_FLUSH).
<!--l. 4039-->
<div class="lstlisting" id="listing-55"><span class="label"><a 
 id="x1-255008r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255009r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255010r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_FLUSH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255011r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_DISCARD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255012r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_WRITE_ZEROES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">13</span>
</div>
<!--l. 4047--><p class="noindent" >The <span 
class="aeti-10">sector </span>number indicates the offset (multiplied by 512) where the read or write is
to occur. This field is unused and set to 0 for commands other than read or
write.
<!--l. 4051--><p class="noindent" >VIRTIO_BLK_T_IN requests populate <span 
class="aeti-10">data </span>with the contents of sectors read
from the block device (in multiples of 512 bytes). VIRTIO_BLK_T_OUT
requests write the contents of <span 
class="aeti-10">data </span>to the block device (in multiples of 512
bytes).
<!--l. 4056--><p class="noindent" >The <span 
class="aeti-10">data </span>used for discard or write zeroes commands consists of one or more
segments. The maximum number of segments is <span 
class="aeti-10">max_discard_seg </span>for discard
commands and <span 
class="aeti-10">max_write_zeroes_seg </span>for write zeroes commands. Each segment is of
form:
<!--l. 4061-->
<div class="lstlisting" id="listing-56"><span class="label"><a 
 id="x1-255013r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_discard_write_zeroes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255014r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255015r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255016r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255017r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">:1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255018r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">:31;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255019r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255020r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4072--><p class="noindent" ><span 
class="aeti-10">sector </span>indicates the starting offset (in 512-byte units) of the segment, while
<span 
class="aeti-10">num_sectors </span>indicates the number of sectors in each discarded range. <span 
class="aeti-10">unmap </span>is only
used in write zeroes commands and allows the device to discard the specified range,
provided that following reads return zeroes.
<!--l. 4078--><p class="noindent" >The final <span 
class="aeti-10">status </span>byte is written by the device: either VIRTIO_BLK_S_OK for success,
VIRTIO_BLK_S_IOERR for device or driver error or VIRTIO_BLK_S_UNSUPP for a
request unsupported by device:
<!--l. 4082-->
<div class="lstlisting" id="listing-57"><span class="label"><a 
 id="x1-255021r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255022r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_IOERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-255023r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_UNSUPP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
                                                                  

                                                                  
<!--l. 4088--><p class="noindent" >The status of individual segments is indeterminate when a discard or write zero
command produces VIRTIO_BLK_S_IOERR. A segment may have completed
successfully, failed, or not been processed by the device.
<a 
 id="x1-255024r260"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.1   </span> <a 
 id="x1-2560001"></a>Driver Requirements: Device Operation</h5>
<!--l. 4094--><p class="nopar" >A driver MUST NOT submit a request which would cause a read or write beyond
<span 
class="aeti-10">capacity</span>.
<!--l. 4097--><p class="noindent" >A driver SHOULD accept the VIRTIO_BLK_F_RO feature if offered.
<!--l. 4099--><p class="noindent" >A driver MUST set <span 
class="aeti-10">sector </span>to 0 for a VIRTIO_BLK_T_FLUSH request. A driver
SHOULD NOT include any data in a VIRTIO_BLK_T_FLUSH request.
<!--l. 4102--><p class="noindent" >The length of <span 
class="aeti-10">data </span>MUST be a multiple of 512 bytes for VIRTIO_BLK_T_IN and
VIRTIO_BLK_T_OUT requests.
<!--l. 4105--><p class="noindent" >The length of <span 
class="aeti-10">data </span>MUST be a multiple of the size of struct virtio_blk_discard_write_zeroes
for VIRTIO_BLK_T_DISCARD and VIRTIO_BLK_T_WRITE_ZEROES
requests.
<!--l. 4109--><p class="noindent" >VIRTIO_BLK_T_DISCARD requests MUST NOT contain more than <span 
class="aeti-10">max_discard_seg</span>
struct virtio_blk_discard_write_zeroes segments in <span 
class="aeti-10">data</span>.
<!--l. 4113--><p class="noindent" >VIRTIO_BLK_T_WRITE_ZEROES requests MUST NOT contain more than
<span 
class="aeti-10">max_write_zeroes_seg </span>struct virtio_blk_discard_write_zeroes segments in <span 
class="aeti-10">data</span>.
<!--l. 4117--><p class="noindent" >If the VIRTIO_BLK_F_CONFIG_WCE feature is negotiated, the driver MAY switch
to writethrough or writeback mode by writing respectively 0 and 1 to the
<span 
class="aeti-10">writeback </span>field. After writing a 0 to <span 
class="aeti-10">writeback</span>, the driver MUST NOT assume
that any volatile writes have been committed to persistent device backend
storage.
<!--l. 4123--><p class="noindent" >The <span 
class="aeti-10">unmap </span>bit MUST be zero for discard commands. The driver MUST NOT
assume anything about the data returned by read requests after a range of sectors
has been discarded.
<!--l. 4127--><p class="noindent" >A driver MUST NOT assume that individual segments in a multi-segment
VIRTIO_BLK_T_DISCARD or VIRTIO_BLK_T_WRITE_ZEROES request
completed successfully, failed, or were processed by the device at all if the request
failed with VIRTIO_BLK_S_IOERR.
<a 
 id="x1-256001r262"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.2   </span> <a 
 id="x1-2570002"></a>Device Requirements: Device Operation</h5>
<!--l. 4134--><p class="nopar" >A device MUST set the <span 
class="aeti-10">status </span>byte to VIRTIO_BLK_S_IOERR for a write request
if the VIRTIO_BLK_F_RO feature if offered, and MUST NOT write any
data.
<!--l. 4138--><p class="noindent" >The device MUST set the <span 
class="aeti-10">status </span>byte to VIRTIO_BLK_S_UNSUPP for discard and
                                                                  

                                                                  
write zeroes commands if any unknown flag is set. Furthermore, the device MUST set
the <span 
class="aeti-10">status </span>byte to VIRTIO_BLK_S_UNSUPP for discard commands if the <span 
class="aeti-10">unmap </span>flag
is set.
<!--l. 4143--><p class="noindent" >For discard commands, the device MAY deallocate the specified range of sectors in
the device backend storage.
<!--l. 4146--><p class="noindent" >For write zeroes commands, if the <span 
class="aeti-10">unmap </span>is set, the device MAY deallocate the
specified range of sectors in the device backend storage, as if the discard command
had been sent. After a write zeroes command is completed, reads of the specified
ranges of sectors MUST return zeroes. This is true independent of whether <span 
class="aeti-10">unmap</span>
was set or clear.
<!--l. 4152--><p class="noindent" >The device SHOULD clear the <span 
class="aeti-10">write_zeroes_may_unmap </span>field of the virtio
configuration space if and only if a write zeroes request cannot result in deallocating
one or more sectors. The device MAY change the content of the field during
operation of the device; when this happens, the device SHOULD trigger a
configuration change notification.
<!--l. 4158--><p class="noindent" >A write is considered volatile when it is submitted; the contents of sectors covered by
a volatile write are undefined in persistent device backend storage until the write
becomes stable. A write becomes stable once it is completed and one or more of the
following conditions is true:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-257002x1"><a 
 id="x1-2570011"></a> neither  VIRTIO_BLK_F_CONFIG_WCE  nor  VIRTIO_BLK_F_FLUSH
    feature were negotiated, but VIRTIO_BLK_F_FLUSH was offered by the
    device;
    </li>
    <li 
  class="enumerate" id="x1-257004x2"><a 
 id="x1-2570032"></a> the  VIRTIO_BLK_F_CONFIG_WCE  feature  was  negotiated  and  the
    <span 
class="aeti-10">writeback </span>field in configuration space was 0 <span 
class="aebx-10">all the time between the</span>
    <span 
class="aebx-10">submission of the write and its completion</span>;
    </li>
    <li 
  class="enumerate" id="x1-257006x3"><a 
 id="x1-2570053"></a> a VIRTIO_BLK_T_FLUSH request is sent <span 
class="aebx-10">after the write is completed</span>
    and is completed itself.</li></ol>
<!--l. 4176--><p class="noindent" >If the device is backed by persistent storage, the device MUST ensure that stable
writes are committed to it, before reporting completion of the write (cases <a 
href="#x1-2570011">1<!--tex4ht:ref: item:flush1 --></a>
and <a 
href="#x1-2570032">2<!--tex4ht:ref: item:flush2 --></a>) or the flush (case <a 
href="#x1-2570053">3<!--tex4ht:ref: item:flush3 --></a>). Failure to do so can cause data loss in case of a
crash.
<!--l. 4182--><p class="noindent" >If the driver changes <span 
class="aeti-10">writeback </span>between the submission of the write and its
completion, the write could be either volatile or stable when its completion is
reported; in other words, the exact behavior is undefined.
<!--l. 4192--><p class="noindent" >If VIRTIO_BLK_F_FLUSH was not offered by the
device<span class="footnote-mark"><a 
href="#fn12x5" id="fn12x5-bk"><sup class="textsuperscript">12</sup></a></span><a 
 id="x1-257007f12"></a>,
the device MAY also commit writes to persistent device backend storage before
reporting their completion. Unlike case <a 
href="#x1-2570011">1<!--tex4ht:ref: item:flush1 --></a>, however, this is not an absolute
                                                                  

                                                                  
requirement of the specification.
<span 
class="aebx-10">Note:</span> An implementation that does not offer VIRTIO_BLK_F_FLUSH and
      does not commit completed writes will not be resilient to data loss in
      case  of  crashes.  Not  offering  VIRTIO_BLK_F_FLUSH  is  an  absolute
      requirement for implementations that do not wish to be safe against such
      data losses.
<a 
 id="x1-257008r263"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.3   </span> <a 
 id="x1-2580003"></a>Legacy Interface: Device Operation</h5>
<!--l. 4208--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format the
fields in struct virtio_blk_req according to the native endian of the guest rather than
(necessarily when not using the legacy interface) little-endian.
<!--l. 4213--><p class="noindent" >When using the legacy interface, transitional drivers SHOULD ignore the used length
values.
<span 
class="aebx-10">Note:</span> Historically, some devices put the total descriptor length, or the total
      length of device-writable buffers there, even when only the status byte
      was actually written.
<!--l. 4221--><p class="noindent" >The <span 
class="aeti-10">reserved </span>field was previously called <span 
class="aeti-10">ioprio</span>. <span 
class="aeti-10">ioprio </span>is a hint about the relative
priorities of requests to the device: higher numbers indicate more important
requests.
<!--l. 4225-->
<div class="lstlisting" id="listing-58"><span class="label"><a 
 id="x1-258001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_FLUSH_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span>
</div>
<!--l. 4229--><p class="noindent" >The command VIRTIO_BLK_T_FLUSH_OUT was a synonym for
VIRTIO_BLK_T_FLUSH; a driver MUST treat it as a VIRTIO_BLK_T_FLUSH
command.
<!--l. 4232-->
<div class="lstlisting" id="listing-59"><span class="label"><a 
 id="x1-258002r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_BARRIER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80000000</span>
</div>
<!--l. 4236--><p class="noindent" >If the device has VIRTIO_BLK_F_BARRIER feature the high bit
(VIRTIO_BLK_T_BARRIER) indicates that this request acts as a barrier and that
all preceding requests SHOULD be complete before this one, and all following
requests SHOULD NOT be started until this is complete.
                                                                  

                                                                  
<span 
class="aebx-10">Note:</span> A barrier does not flush caches in the underlying backend device in
      host, and thus does not serve as data consistency guarantee. Only a
      VIRTIO_BLK_T_FLUSH request does that.
<!--l. 4248--><p class="noindent" >Some older legacy devices did not commit completed writes to persistent device
backend storage when VIRTIO_BLK_F_FLUSH was offered but not negotiated.
In order to work around this, the driver MAY set the <span 
class="aeti-10">writeback </span>to 0 (if
available) or it MAY send an explicit flush request after every completed
write.
<!--l. 4254--><p class="noindent" >If the device has VIRTIO_BLK_F_SCSI feature, it can also support scsi packet
command requests, each of these requests is of form:
<!--l. 4257-->
<div class="lstlisting" id="listing-60"><span class="label"><a 
 id="x1-258003r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">All</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">native</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endian</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258004r2"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_pc_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258005r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258006r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ioprio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258007r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258008r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cmd</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258009r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[][512];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258010r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SCSI_SENSE_BUFFERSIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">96</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258011r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">SCSI_SENSE_BUFFERSIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258012r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">errors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258013r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258014r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258015r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">residual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258016r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258017r15"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4275--><p class="noindent" >A request type can also be a scsi packet command (VIRTIO_BLK_T_SCSI_CMD or
VIRTIO_BLK_T_SCSI_CMD_OUT). The two types are equivalent, the device does
not distinguish between them:
<!--l. 4279-->
<div class="lstlisting" id="listing-61"><span class="label"><a 
 id="x1-258018r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_SCSI_CMD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258019r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_SCSI_CMD_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 4284--><p class="noindent" >The <span 
class="aeti-10">cmd </span>field is only present for scsi packet command requests, and indicates the
command to perform. This field MUST reside in a single, separate device-readable
buffer; command length can be derived from the length of this buffer.
<!--l. 4289--><p class="noindent" >Note that these first three (four for scsi packet commands) fields are always
device-readable: <span 
class="aeti-10">data </span>is either device-readable or device-writable, depending on the
request. The size of the read or write can be derived from the total size of the request
buffers.
<!--l. 4294--><p class="noindent" ><span 
class="aeti-10">sense </span>is only present for scsi packet command requests, and indicates the buffer for
scsi sense data.
<!--l. 4297--><p class="noindent" ><span 
class="aeti-10">data_len </span>is only present for scsi packet command requests, this field is deprecated,
and SHOULD be ignored by the driver. Historically, devices copied data length
there.
<!--l. 4301--><p class="noindent" ><span 
class="aeti-10">sense_len </span>is only present for scsi packet command requests and indicates the number
of bytes actually written to the <span 
class="aeti-10">sense </span>buffer.
<!--l. 4305--><p class="noindent" ><span 
class="aeti-10">residual </span>field is only present for scsi packet command requests and indicates the
residual size, calculated as data length - number of bytes actually transferred.
<a 
 id="x1-258020r264"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.4   </span> <a 
 id="x1-2590004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 4311--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT:
    <ul class="itemize1">
    <li class="itemize">MUST use a single 8-byte descriptor containing <span 
class="aeti-10">type</span>, <span 
class="aeti-10">reserved </span>and <span 
class="aeti-10">sector</span>,
    followed by descriptors for <span 
class="aeti-10">data</span>, then finally a separate 1-byte descriptor
    for <span 
class="aeti-10">status</span>.
    </li>
    <li class="itemize">For SCSI commands there are additional constraints. <span 
class="aeti-10">sense </span>MUST reside
    in  a  single  separate  device-writable  descriptor  of  size  96  bytes,  and
    <span 
class="aeti-10">errors</span>, <span 
class="aeti-10">data_len</span>, <span 
class="aeti-10">sense_len  </span>and <span 
class="aeti-10">residual  </span>MUST reside a single separate
    device-writable descriptor.</li></ul>
<!--l. 4328--><p class="noindent" >See <a 
href="#x1-280004">2.6.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing --></a>.
<a 
 id="x1-259001r250"></a>
<h3 class="sectionHead"><span class="titlemark">5.3   </span> <a 
 id="x1-2600003"></a>Console Device</h3>
<!--l. 4332--><p class="nopar" >The virtio console device is a simple device for data input and output. A
device MAY have one or more ports. Each port has a pair of input and
output virtqueues. Moreover, a device has a pair of control IO virtqueues. The
control virtqueues are used to communicate information between the device
and the driver about ports being opened and closed on either side of the
connection, indication from the device about whether a particular port is a console
port, adding new ports, port hot-plug/unplug, etc., and indication from
the driver about whether a port or a device was successfully added, port
open/close, etc. For data IO, one or more empty buffers are placed in the receive
queue for incoming data and outgoing characters are placed in the transmit
queue.
<a 
 id="x1-260001r261"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.1   </span> <a 
 id="x1-2610001"></a>Device ID</h4>
<!--l. 4347--><p class="nopar" >3
<a 
 id="x1-261001r267"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.2   </span> <a 
 id="x1-2620002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">receiveq(port0)
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">transmitq(port0)
    </dd><dt class="description">
<span 
class="aebx-10">2</span> </dt><dd 
class="description">control receiveq
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebx-10">3</span> </dt><dd 
class="description">control transmitq
    </dd><dt class="description">
<span 
class="aebx-10">4</span> </dt><dd 
class="description">receiveq(port1)
    </dd><dt class="description">
<span 
class="aebx-10">5</span> </dt><dd 
class="description">transmitq(port1)
    </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description"></dd></dl>
<!--l. 4361--><p class="nopar" >The port 0 receive and transmit queues always exist: other queues only exist if
VIRTIO_CONSOLE_F_MULTIPORT is set.
<a 
 id="x1-262001r268"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.3   </span> <a 
 id="x1-2630003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_F_SIZE (0)</span> </dt><dd 
class="description">Configuration <span 
class="aeti-10">cols </span>and <span 
class="aeti-10">rows </span>are valid.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_F_MULTIPORT (1)</span> </dt><dd 
class="description">Device has support for multiple
    ports; <span 
class="aeti-10">max_nr_ports </span>is valid and control virtqueues will be used.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_F_EMERG_WRITE (2)</span> </dt><dd 
class="description">Device   has   support   for
    emergency write. Configuration field emerg_wr is valid.</dd></dl>
<a 
 id="x1-263001r269"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.4   </span> <a 
 id="x1-2640004"></a>Device configuration layout</h4>
<!--l. 4379--><p class="nopar" >The size of the console is supplied in the configuration space if
the VIRTIO_CONSOLE_F_SIZE feature is set. Furthermore, if the
VIRTIO_CONSOLE_F_MULTIPORT feature is set, the maximum number of ports
supported by the device can be fetched.
<!--l. 4385--><p class="noindent" >If VIRTIO_CONSOLE_F_EMERG_WRITE is set then the driver can use emergency
write to output a single character without initializing virtio queues, or even
acknowledging the feature.
<!--l. 4389-->
<div class="lstlisting" id="listing-62"><span class="label"><a 
 id="x1-264001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cols</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rows</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_nr_ports</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">emerg_wr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-264007r265"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.4.1   </span> <a 
 id="x1-2650001"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 4399--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
                                                                  

                                                                  
format the fields in struct virtio_console_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-265001r270"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.5   </span> <a 
 id="x1-2660005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-266002x1">If         the         VIRTIO_CONSOLE_F_EMERG_WRITE         feature
    is offered, <span 
class="aeti-10">emerg_wr </span>field of the configuration can be written at any time.
    Thus it works for very early boot debugging output as well as catastophic
    OS failures (eg. virtio ring corruption).
    </li>
    <li 
  class="enumerate" id="x1-266004x2">If the VIRTIO_CONSOLE_F_SIZE feature is negotiated, the driver can
    read the console dimensions from <span 
class="aeti-10">cols </span>and <span 
class="aeti-10">rows</span>.
    </li>
    <li 
  class="enumerate" id="x1-266006x3">If  the  VIRTIO_CONSOLE_F_MULTIPORT  feature  is  negotiated,  the
    driver can spawn multiple ports, not all of which are necessarily attached to
    a console. Some could be generic ports. In this case, the control virtqueues
    are enabled and according to <span 
class="aeti-10">max_nr_ports</span>, the appropriate number of
    virtqueues are created. A control message indicating the driver is ready
    is  sent  to  the  device.  The  device  can  then  send  control  messages  for
    adding new ports to the device. After creating and initializing each port, a
    VIRTIO_CONSOLE_PORT_READY control message is sent to the device
    for  that  port  so  the  device  can  let  the  driver  know  of  any  additional
    configuration options set for that port.
    </li>
    <li 
  class="enumerate" id="x1-266008x4">The receiveq for each port is populated with one or more receive buffers.</li></ol>
<a 
 id="x1-266009r271"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.5.1   </span> <a 
 id="x1-2670001"></a>Device Requirements: Device Initialization</h5>
<!--l. 4434--><p class="nopar" >The device MUST allow a write to <span 
class="aeti-10">emerg_wr</span>, even on an unconfigured device.
<!--l. 4437--><p class="noindent" >The device SHOULD transmit the lower byte written to <span 
class="aeti-10">emerg_wr </span>to an appropriate
log or output method.
<a 
 id="x1-267001r272"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.6   </span> <a 
 id="x1-2680006"></a>Device Operation</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-268002x1">For output, a buffer containing the characters is placed in the port’s transmitq<span class="footnote-mark"><a 
href="#fn13x5" id="fn13x5-bk"><sup class="textsuperscript">13</sup></a></span><a 
 id="x1-268003f13"></a>.
    </li>
    <li 
  class="enumerate" id="x1-268005x2">When  a  buffer  is  used  in  the  receiveq  (signalled  by  a  used  buffer
    notification), the contents is the input to the port associated with the
                                                                  

                                                                  
    virtqueue for which the notification was received.
    </li>
    <li 
  class="enumerate" id="x1-268007x3">If  the  driver  negotiated  the  VIRTIO_CONSOLE_F_SIZE  feature,  a
    configuration change notification indicates that the updated size can be
    read from the configuration fields. This size applies to port 0 only.
    </li>
    <li 
  class="enumerate" id="x1-268009x4">If the driver negotiated the VIRTIO_CONSOLE_F_MULTIPORT feature,
    active      ports      are      announced      by      the      device      using
    the VIRTIO_CONSOLE_PORT_ADD control message. The same message
    is used for port hot-plug as well.</li></ol>
<a 
 id="x1-268010r273"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.1   </span> <a 
 id="x1-2690001"></a>Driver Requirements: Device Operation</h5>
<!--l. 4469--><p class="nopar" >The driver MUST NOT put a device-readable in a receiveq. The driver MUST NOT
put a device-writable buffer in a transmitq.
<a 
 id="x1-269001r275"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.2   </span> <a 
 id="x1-2700002"></a>Multiport Device Operation</h5>
<!--l. 4474--><p class="nopar" >If the driver negotiated the VIRTIO_CONSOLE_F_MULTIPORT, the two control
queues are used to manipulate the different console ports: the control receiveq for
messages from the device to the driver, and the control sendq for driver-to-device
messages. The layout of the control messages is:
<!--l. 4480-->
<div class="lstlisting" id="listing-63"><span class="label"><a 
 id="x1-270001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Port</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">number</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">kind</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Extra</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">information</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4488--><p class="noindent" >The values for <span 
class="aeti-10">event </span>are:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_DEVICE_READY (0)</span> </dt><dd 
class="description">Sent      by      the      driver
    at initialization to indicate that it is ready to receive control messages. A
    value of 1 indicates success, and 0 indicates failure. The port number <span 
class="aeti-10">id </span>is
    unused.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_DEVICE_ADD (1)</span> </dt><dd 
class="description">Sent by the device, to create a
    new port. <span 
class="aeti-10">value </span>is unused.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_DEVICE_REMOVE (2)</span> </dt><dd 
class="description">Sent   by   the   device,   to
    remove an existing port. <span 
class="aeti-10">value </span>is unused.
    </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aebx-10">VIRTIO_CONSOLE_PORT_READY (3)</span> </dt><dd 
class="description">Sent by the driver in response
    to the device’s VIRTIO_CONSOLE_PORT_ADD message, to indicate that
    the port is ready to be used. A <span 
class="aeti-10">value </span>of 1 indicates success, and 0 indicates
    failure.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_CONSOLE_PORT (4)</span> </dt><dd 
class="description">Sent   by   the   device   to
    nominate a port as a console port. There MAY be more than one console
    port.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_RESIZE (5)</span> </dt><dd 
class="description">Sent by the device to indicate a console size
    change. <span 
class="aeti-10">value </span>is unused. The buffer is followed by the number of columns and
    rows: <!--l. 4505-->
    <div class="lstlisting" id="listing-64"><span class="label"><a 
 id="x1-270006r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_resize</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270007r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cols</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270008r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rows</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270009r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_PORT_OPEN (6)</span> </dt><dd 
class="description">This message is sent by both the device
    and the driver. <span 
class="aeti-10">value </span>indicates the state: 0 (port closed) or 1 (port open). This
    allows for ports to be used directly by guest and host processes to communicate
    in an application-defined manner.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_PORT_NAME (7)</span> </dt><dd 
class="description">Sent by the device to give a tag to the
    port. This control command is immediately followed by the UTF-8
    name of the port for identification within the guest (without a NUL
    terminator).</dd></dl>
<a 
 id="x1-270010r245"></a>
<h5 class="paragraphHead"><span class="titlemark">5.3.6.2.1</span> <a 
 id="x1-2710001"></a>Device Requirements: Multiport Device Operation</h5>
The device MUST NOT specify a port which exists in a VIRTIO_CONSOLE_DEVICE_ADD
message, nor a port which is equal or greater than <span 
class="aeti-10">max_nr_ports</span>.
<!--l. 4528--><p class="noindent" >The device MUST NOT specify a port in VIRTIO_CONSOLE_DEVICE_REMOVE
which has not been created with a previous VIRTIO_CONSOLE_DEVICE_ADD.
<a 
 id="x1-271001r277"></a>
<h5 class="paragraphHead"><span class="titlemark">5.3.6.2.2</span> <a 
 id="x1-2720002"></a>Driver Requirements: Multiport Device Operation</h5>
The driver MUST send a VIRTIO_CONSOLE_DEVICE_READY message if
VIRTIO_CONSOLE_F_MULTIPORT is negotiated.
<!--l. 4536--><p class="noindent" >Upon receipt of a VIRTIO_CONSOLE_CONSOLE_PORT message, the driver
SHOULD treat the port in a manner suitable for text console access and MUST
respond with a VIRTIO_CONSOLE_PORT_OPEN message, which MUST have <span 
class="aeti-10">value</span>
                                                                  

                                                                  
set to 1.
<a 
 id="x1-272001r276"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.3   </span> <a 
 id="x1-2730003"></a>Legacy Interface: Device Operation</h5>
<!--l. 4542--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format
the fields in struct virtio_console_control according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 4547--><p class="noindent" >When using the legacy interface, the driver SHOULD ignore the used length values
for the transmit queues and the control transmitq.
<span 
class="aebx-10">Note:</span> Historically, some devices put the total descriptor length there, even
      though no data was actually written.
<a 
 id="x1-273001r279"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.4   </span> <a 
 id="x1-2740004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 4558--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use only a single descriptor for all buffers in the
control receiveq and control transmitq.
<a 
 id="x1-274001r266"></a>
<h3 class="sectionHead"><span class="titlemark">5.4   </span> <a 
 id="x1-2750004"></a>Entropy Device</h3>
<!--l. 4564--><p class="nopar" >The virtio entropy device supplies high-quality randomness for guest use.
<a 
 id="x1-275001r274"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.1   </span> <a 
 id="x1-2760001"></a>Device ID</h4>
<!--l. 4568--><p class="nopar" >4
<a 
 id="x1-276001r282"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.2   </span> <a 
 id="x1-2770002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">requestq</dd></dl>
<a 
 id="x1-277001r283"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.3   </span> <a 
 id="x1-2780003"></a>Feature bits</h4>
<!--l. 4576--><p class="nopar" >None currently defined
<a 
 id="x1-278001r284"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.4   </span> <a 
 id="x1-2790004"></a>Device configuration layout</h4>
<!--l. 4579--><p class="nopar" >None currently defined.
                                                                  

                                                                  
<a 
 id="x1-279001r285"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.5   </span> <a 
 id="x1-2800005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-280002x1">The virtqueue is initialized</li></ol>
<a 
 id="x1-280003r286"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.6   </span> <a 
 id="x1-2810006"></a>Device Operation</h4>
<!--l. 4589--><p class="nopar" >When the driver requires random bytes, it places the descriptor of one or more
buffers in the queue. It will be completely filled by random data by the
device.
<a 
 id="x1-281001r280"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.4.6.1   </span> <a 
 id="x1-2820001"></a>Driver Requirements: Device Operation</h5>
<!--l. 4595--><p class="nopar" >The driver MUST NOT place driver-readable buffers into the queue.
<!--l. 4597--><p class="noindent" >The driver MUST examine the length written by the device to determine how many
random bytes were received.
<a 
 id="x1-282001r288"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.4.6.2   </span> <a 
 id="x1-2830002"></a>Device Requirements: Device Operation</h5>
<!--l. 4602--><p class="nopar" >The device MUST place one or more random bytes into the buffer, but it MAY use
less than the entire buffer length.
<a 
 id="x1-283001r281"></a>
<h3 class="sectionHead"><span class="titlemark">5.5   </span> <a 
 id="x1-2840005"></a>Traditional Memory Balloon Device</h3>
<!--l. 4607--><p class="nopar" >This is the traditional balloon device. The device number 13 is reserved for a new
memory balloon interface, with different semantics, which is expected in a future
version of the standard.
<!--l. 4611--><p class="noindent" >The traditional virtio memory balloon device is a primitive device for managing guest
memory: the device asks for a certain amount of memory, and the driver supplies it
(or withdraws it, if the device has more than it asks for). This allows the guest to
adapt to changes in allowance of underlying physical memory. If the feature is
negotiated, the device can also be used to communicate guest memory statistics to
the host.
<a 
 id="x1-284001r287"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.1   </span> <a 
 id="x1-2850001"></a>Device ID</h4>
<!--l. 4620--><p class="nopar" >5
<a 
 id="x1-285001r291"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.5.2   </span> <a 
 id="x1-2860002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">inflateq
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">deflateq
    </dd><dt class="description">
<span 
class="aebx-10">2</span> </dt><dd 
class="description">statsq.</dd></dl>
<!--l. 4629--><p class="nopar" >Virtqueue 2 only exists if VIRTIO_BALLON_F_STATS_VQ set.
<a 
 id="x1-286001r292"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.3   </span> <a 
 id="x1-2870003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_F_MUST_TELL_HOST (0)</span> </dt><dd 
class="description">Host  has  to  be  told
    before pages from the balloon are used.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_F_STATS_VQ (1)</span> </dt><dd 
class="description">A  virtqueue  for  reporting  guest
    memory statistics is present.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_F_DEFLATE_ON_OOM (2)</span>  </dt><dd 
class="description">Deflate   balloon   on
    guest out of memory condition.
    </dd></dl>
<a 
 id="x1-287001r289"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.3.1   </span> <a 
 id="x1-2880001"></a>Driver Requirements: Feature bits</h5>
<!--l. 4644--><p class="nopar" >The driver SHOULD accept the VIRTIO_BALLOON_F_MUST_TELL_HOST feature
if offered by the device.
<a 
 id="x1-288001r294"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.3.2   </span> <a 
 id="x1-2890002"></a>Device Requirements: Feature bits</h5>
<!--l. 4648--><p class="nopar" >If the device offers the VIRTIO_BALLOON_F_MUST_TELL_HOST feature bit, and
if the driver did not accept this feature bit, the device MAY signal failure
by failing to set FEATURES_OK <span 
class="aeti-10">device status </span>bit when the driver writes
it.
<a 
 id="x1-289001r248"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.5.3.2.0.1</span> <a 
 id="x1-2900001"></a>Legacy Interface: Feature bits</h6>
As the legacy interface does not have a way to gracefully report feature negotiation
failure, when using the legacy interface, transitional devices MUST support
guests which do not negotiate VIRTIO_BALLOON_F_MUST_TELL_HOST
                                                                  

                                                                  
feature, and SHOULD allow guest to use memory before notifying host if
VIRTIO_BALLOON_F_MUST_TELL_HOST is not negotiated.
<a 
 id="x1-290001r293"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.4   </span> <a 
 id="x1-2910004"></a>Device configuration layout</h4>
<!--l. 4663--><p class="nopar" >Both fields of this configuration are always available.
<!--l. 4666-->
<div class="lstlisting" id="listing-65"><span class="label"><a 
 id="x1-291001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_balloon_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-291002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_pages</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-291003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-291004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-291005r296"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.5.4.0.0.1</span> <a 
 id="x1-2920001"></a>Legacy Interface: Device configuration layout</h6>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_balloon_config according to the little-endian
format.
<span 
class="aebx-10">Note:</span> This is unlike the usual convention that legacy device fields are guest
      endian.
<a 
 id="x1-292001r297"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.5   </span> <a 
 id="x1-2930005"></a>Device Initialization</h4>
<!--l. 4684--><p class="nopar" >The device initialization process is outlined below:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-293002x1">The inflate and deflate virtqueues are identified.
    </li>
    <li 
  class="enumerate" id="x1-293004x2">If the VIRTIO_BALLOON_F_STATS_VQ feature bit is negotiated:
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-293006x1">Identify the stats virtqueue.
        </li>
        <li 
  class="enumerate" id="x1-293008x2">Add one empty buffer to the stats virtqueue.
        </li>
        <li 
  class="enumerate" id="x1-293010x3">DRIVER_OK is set: device operation begins.
        </li>
        <li 
  class="enumerate" id="x1-293012x4">Notify the device about the stats virtqueue buffer.</li></ol>
    </li></ol>
<a 
 id="x1-293013r299"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.5.6   </span> <a 
 id="x1-2940006"></a>Device Operation</h4>
<!--l. 4700--><p class="nopar" >The device is driven either by the receipt of a configuration change notification, or by
changing guest memory needs, such as performing memory compaction or responding
to out of memory conditions.
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-294002x1"><span 
class="aeti-10">num_pages </span>configuration field is examined. If this is greater than the <span 
class="aeti-10">actual</span>
    number of pages, the balloon wants more memory from the guest. If it is
    less than <span 
class="aeti-10">actual</span>, the balloon doesn’t need it all.
    </li>
    <li 
  class="enumerate" id="x1-294004x2">To supply memory to the balloon (aka. inflate):
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-294006x1">The driver constructs an array of addresses of unused memory pages.
        These addresses are divided by 4096<span class="footnote-mark"><a 
href="#fn14x5" id="fn14x5-bk"><sup class="textsuperscript">14</sup></a></span><a 
 id="x1-294007f14"></a>
        and the descriptor describing the resulting 32-bit array is added to the
        inflateq.</li></ol>
    </li>
    <li 
  class="enumerate" id="x1-294009x3">To remove memory from the balloon (aka. deflate):
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-294011x1">The driver constructs an array of addresses of memory pages it has
        previously given to the balloon, as described above. This descriptor is
        added to the deflateq.
        </li>
        <li 
  class="enumerate" id="x1-294013x2">If    the    VIRTIO_BALLOON_F_MUST_TELL_HOST    feature    is
        negotiated, the guest informs the device of pages before it uses them.
        </li>
        <li 
  class="enumerate" id="x1-294015x3">Otherwise, the guest is allowed to re-use pages previously given to the
        balloon before the device has acknowledged their withdrawal<span class="footnote-mark"><a 
href="#fn15x5" id="fn15x5-bk"><sup class="textsuperscript">15</sup></a></span><a 
 id="x1-294016f15"></a>.</li></ol>
    </li>
    <li 
  class="enumerate" id="x1-294018x4">In either case, the device acknowledges inflate and deflate requests by using the
    descriptor.
    </li>
    <li 
  class="enumerate" id="x1-294020x5">Once the device has acknowledged the inflation or deflation, the driver updates
    <span 
class="aeti-10">actual </span>to reflect the new number of pages in the balloon.</li></ol>
<a 
 id="x1-294021r295"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.1   </span> <a 
 id="x1-2950001"></a>Driver Requirements: Device Operation</h5>
<!--l. 4741--><p class="nopar" >The driver SHOULD supply pages to the balloon when <span 
class="aeti-10">num_pages </span>is greater than the
actual number of pages in the balloon.
<!--l. 4744--><p class="noindent" >The driver MAY use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than the actual
                                                                  

                                                                  
number of pages in the balloon.
<!--l. 4747--><p class="noindent" >The driver MAY supply pages to the balloon when <span 
class="aeti-10">num_pages </span>is greater than or
equal to the actual number of pages in the balloon.
<!--l. 4750--><p class="noindent" >If VIRTIO_BALLOON_F_DEFLATE_ON_OOM has not been negotiated, the driver
MUST NOT use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than or equal to the
actual number of pages in the balloon.
<!--l. 4755--><p class="noindent" >If VIRTIO_BALLOON_F_DEFLATE_ON_OOM has been negotiated, the
driver MAY use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than or
equal to the actual number of pages in the balloon if this is required for
system stability (e.g. if memory is required by applications running within the
guest).
<!--l. 4762--><p class="noindent" >The driver MUST use the deflateq to inform the device of pages that it wants to use
from the balloon.
<!--l. 4765--><p class="noindent" >If the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is negotiated, the driver
MUST NOT use pages from the balloon until the device has acknowledged the deflate
request.
<!--l. 4769--><p class="noindent" >Otherwise, if the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is not
negotiated, the driver MAY begin to re-use pages previously given to the balloon
before the device has acknowledged the deflate request.
<!--l. 4774--><p class="noindent" >In any case, the driver MUST NOT use pages from the balloon after adding the
pages to the balloon, but before the device has acknowledged the inflate
request.
<!--l. 4778--><p class="noindent" >The driver MUST NOT request deflation of pages in the balloon before the device
has acknowledged the inflate request.
<!--l. 4782--><p class="noindent" >The driver MUST update <span 
class="aeti-10">actual </span>after changing the number of pages in the
balloon.
<!--l. 4785--><p class="noindent" >The driver MAY update <span 
class="aeti-10">actual </span>once after multiple inflate and deflate operations.
<a 
 id="x1-295001r301"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.2   </span> <a 
 id="x1-2960002"></a>Device Requirements: Device Operation</h5>
<!--l. 4790--><p class="nopar" >The device MAY modify the contents of a page in the balloon after detecting its
physical number in an inflate request and before acknowledging the inflate request by
using the inflateq descriptor.
<!--l. 4795--><p class="noindent" >If the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is negotiated, the device
MAY modify the contents of a page in the balloon after detecting its physical number
in an inflate request and before detecting its physical number in a deflate request and
acknowledging the deflate request.
<a 
 id="x1-296001r278"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.5.6.2.1</span> <a 
 id="x1-2970001"></a>Legacy Interface: Device Operation</h5>
When using the legacy interface, the driver SHOULD ignore the used length
values.
<span 
class="aebx-10">Note:</span> Historically, some devices put the total descriptor length there, even
      though no data was actually written.
<!--l. 4810--><p class="nopar" >When using the legacy interface, the driver MUST write out all 4 bytes each time it
updates the <span 
class="aeti-10">actual </span>value in the configuration space, using a single atomic
operation.
<!--l. 4814--><p class="noindent" >When using the legacy interface, the device SHOULD NOT use the <span 
class="aeti-10">actual </span>value
written by the driver in the configuration space, until the last, most-significant byte
of the value has been written.
<span 
class="aebx-10">Note:</span> Historically, devices used the <span 
class="aeti-10">actual </span>value, even though when using Virtio
      Over PCI Bus the device-specific configuration space was not guaranteed
      to be atomic. Using intermediate values during update by driver is best
      avoided, except for debugging.
      <!--l. 4825--><p class="noindent" >Historically, drivers using Virtio Over PCI Bus wrote the <span 
class="aeti-10">actual </span>value
      by using multiple single-byte writes in order, from the least-significant
      to the most-significant value.
<a 
 id="x1-297001r302"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.3   </span> <a 
 id="x1-2980003"></a>Memory Statistics</h5>
<!--l. 4831--><p class="nopar" >The stats virtqueue is atypical because communication is driven by the device (not
the driver). The channel becomes active at driver initialization time when the driver
adds an empty buffer and notifies the device. A request for memory statistics
proceeds as follows:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-298002x1">The device uses the buffer and sends a used buffer notification.
    </li>
    <li 
  class="enumerate" id="x1-298004x2">The driver pops the used buffer and discards it.
    </li>
    <li 
  class="enumerate" id="x1-298006x3">The driver collects memory statistics and writes them into a new buffer.
    </li>
    <li 
  class="enumerate" id="x1-298008x4">The driver adds the buffer to the virtqueue and notifies the device.
    </li>
    <li 
  class="enumerate" id="x1-298010x5">The device pops the buffer (retaining it to initiate a subsequent request)
    and consumes the statistics.</li></ol>
                                                                  

                                                                  
<!--l. 4852--><p class="noindent" >Within the buffer, statistics are an array of 6-byte entries. Each statistic consists of a
16 bit tag and a 64 bit value. All statistics are optional and the driver chooses which
ones to supply. To guarantee backwards compatibility, devices omit unsupported
statistics.
<!--l. 4858-->
<div class="lstlisting" id="listing-66"><span class="label"><a 
 id="x1-298011r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_balloon_stat</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298012r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_SWAP_IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298013r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_SWAP_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298014r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MAJFLT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298015r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MINFLT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298016r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MEMFREE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298017r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MEMTOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298018r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_AVAIL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298019r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_CACHES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298020r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_HTLB_PGALLOC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298021r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_HTLB_PGFAIL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298022r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298023r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">val</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298024r14"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">__attribute__</span><span 
class="pcrr8t-x-x-80">((</span><span 
class="pcrr8t-x-x-80">packed</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<a 
 id="x1-298025r303"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.1</span> <a 
 id="x1-2990001"></a>Driver Requirements: Memory Statistics</h5>
Normative statements in this section apply if and only if the
VIRTIO_BALLOON_F_STATS_VQ feature has been negotiated.
<!--l. 4879--><p class="noindent" >The driver MUST make at most one buffer available to the device in the statsq, at all
times.
<!--l. 4882--><p class="noindent" >After initializing the device, the driver MUST make an output buffer available in the
statsq.
<!--l. 4885--><p class="noindent" >Upon detecting that device has used a buffer in the statsq, the driver MUST make an
output buffer available in the statsq.
<!--l. 4888--><p class="noindent" >Before making an output buffer available in the statsq, the driver MUST initialize
it, including one struct virtio_balloon_stat entry for each statistic that it
supports.
<!--l. 4892--><p class="noindent" >Driver MUST use an output buffer size which is a multiple of 6 bytes for all buffers
submitted to the statsq.
<!--l. 4895--><p class="noindent" >Driver MAY supply struct virtio_balloon_stat entries in the output buffer submitted
to the statsq in any order, without regard to <span 
class="aeti-10">tag </span>values.
<!--l. 4899--><p class="noindent" >Driver MAY supply a subset of all statistics in the output buffer submitted to the
statsq.
<!--l. 4902--><p class="noindent" >Driver MUST supply the same subset of statistics in all buffers submitted to the
statsq.
<a 
 id="x1-299001r305"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.2</span> <a 
 id="x1-3000002"></a>Device Requirements: Memory Statistics</h5>
Normative statements in this section apply if and only if the
VIRTIO_BALLOON_F_STATS_VQ feature has been negotiated.
<!--l. 4909--><p class="noindent" >Within an output buffer submitted to the statsq, the device MUST ignore entries
with <span 
class="aeti-10">tag </span>values that it does not recognize.
                                                                  

                                                                  
<!--l. 4912--><p class="noindent" >Within an output buffer submitted to the statsq, the device MUST accept struct
virtio_balloon_stat entries in any order without regard to <span 
class="aeti-10">tag </span>values.
<a 
 id="x1-300001r306"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.3</span> <a 
 id="x1-3010003"></a>Legacy Interface: Memory Statistics</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_balloon_stat according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 4923--><p class="noindent" >When using the legacy interface, the device SHOULD ignore all values in the first
buffer in the statsq supplied by the driver after device initialization.
<span 
class="aebx-10">Note:</span> Historically, drivers supplied an uninitialized buffer in the first buffer.
<a 
 id="x1-301001r304"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.4   </span> <a 
 id="x1-3020004"></a>Memory Statistics Tags</h5>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_SWAP_IN (0)</span> </dt><dd 
class="description">The  amount  of  memory  that  has
    been swapped in (in bytes).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_SWAP_OUT (1)</span> </dt><dd 
class="description">The amount of memory that has
    been swapped out to disk (in bytes).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_MAJFLT (2)</span> </dt><dd 
class="description">The  number  of  major  page  faults
    that have occurred.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_MINFLT (3)</span> </dt><dd 
class="description">The  number  of  minor  page  faults
    that have occurred.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_MEMFREE (4)</span> </dt><dd 
class="description">The amount of memory not being
    used for any purpose (in bytes).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_MEMTOT (5)</span> </dt><dd 
class="description">The   total   amount   of   memory
    available (in bytes).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_AVAIL (6)</span> </dt><dd 
class="description">An estimate of how much memory is
    available  (in  bytes)  for  starting  new  applications,  without  pushing  the
    system to swap.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_CACHES (7)</span> </dt><dd 
class="description">The  amount  of  memory,  in  bytes,
                                                                  

                                                                  
    that can be quickly reclaimed without additional I/O. Typically these pages
    are used for caching files from disk.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_HTLB_PGALLOC (8)</span> </dt><dd 
class="description">The number of successful
    hugetlb page allocations in the guest.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_HTLB_PGFAIL (9)</span> </dt><dd 
class="description">The number of failed hugetlb
    page allocations in the guest.</dd></dl>
<a 
 id="x1-302001r290"></a>
<h3 class="sectionHead"><span class="titlemark">5.6   </span> <a 
 id="x1-3030006"></a>SCSI Host Device</h3>
<!--l. 4968--><p class="nopar" >The virtio SCSI host device groups together one or more virtual logical units (such as
disks), and allows communicating to them using the SCSI protocol. An instance of
the device represents a SCSI host to which many targets and LUNs are
attached.
<!--l. 4973--><p class="noindent" >The virtio SCSI device services two kinds of requests:
    <ul class="itemize1">
    <li class="itemize">command requests for a logical unit;
    </li>
    <li class="itemize">task management functions related to a logical unit, target or command.</li></ul>
<!--l. 4981--><p class="noindent" >The device is also able to send out notifications about added and removed logical
units. Together, these capabilities provide a SCSI transport protocol that uses
virtqueues as the transfer medium. In the transport protocol, the virtio driver acts as
the initiator, while the virtio SCSI host provides one or more targets that receive and
process the requests.
<!--l. 4988--><p class="noindent" >This section relies on definitions from <a 
href="#x1-3001r1">SAM</a>.
<a 
 id="x1-303001r300"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.1   </span> <a 
 id="x1-3040001"></a>Device ID</h4>
<!--l. 4991--><p class="nopar" >8
<a 
 id="x1-304001r310"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.2   </span> <a 
 id="x1-3050002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">controlq
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">eventq
    </dd><dt class="description">
<span 
class="aebx-10">2</span><span 
class="aebx-10">…n</span> </dt><dd 
class="description">request queues</dd></dl>
                                                                  

                                                                  
<a 
 id="x1-305001r311"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.3   </span> <a 
 id="x1-3060003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_F_INOUT (0)</span> </dt><dd 
class="description">A    single    request    can    include    both
    device-readable and device-writable data buffers.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_F_HOTPLUG (1)</span> </dt><dd 
class="description">The host SHOULD enable reporting of
    hot-plug and hot-unplug events for LUNs and targets on the SCSI bus.
    The guest SHOULD handle hot-plug and hot-unplug events.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_F_CHANGE (2)</span> </dt><dd 
class="description">The  host  will  report  changes  to  LUN
    parameters  via  a  VIRTIO_SCSI_T_PARAM_CHANGE  event;  the  guest
    SHOULD handle them.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_F_T10_PI (3)</span> </dt><dd 
class="description">The   extended   fields   for   T10   protection
    information (DIF/DIX) are included in the SCSI request header.</dd></dl>
<a 
 id="x1-306001r312"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.4   </span> <a 
 id="x1-3070004"></a>Device configuration layout</h4>
<!--l. 5021--><p class="nopar" >All fields of this configuration are always available.
<!--l. 5023-->
<div class="lstlisting" id="listing-67"><span class="label"><a 
 id="x1-307001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">seg_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cmd_per_lun</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_info_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cdb_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_channel</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_target</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_lun</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-307012r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">num_queues</span> </dt><dd 
class="description">is the total number of request virtqueues exposed by the device.
    The driver MAY use only one request queue, or it can use more to achieve
    better performance.
    </dd><dt class="description">
<span 
class="aebxti-10">seg_max</span> </dt><dd 
class="description">is the maximum number of segments that can be in a command. A
    bidirectional command can include <span 
class="aeti-10">seg_max </span>input segments and <span 
class="aeti-10">seg_max</span>
    output segments.
    </dd><dt class="description">
<span 
class="aebxti-10">max_sectors</span> </dt><dd 
class="description">is a hint to the driver about the maximum transfer size to use.
    </dd><dt class="description">
<span 
class="aebxti-10">cmd_per_lun</span> </dt><dd 
class="description">tells the driver the maximum number of linked commands it can
    send to one LUN.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebxti-10">event_info_size</span> </dt><dd 
class="description">is the maximum size that the device will fill for buffers that
    the driver places in the eventq. It is written by the device depending on
    the set of negotiated features.
    </dd><dt class="description">
<span 
class="aebxti-10">sense_size</span> </dt><dd 
class="description">is the maximum size of the sense data that the device will write.
    The default value is written by the device and MUST be 96, but the driver
    can modify it. It is restored to the default when the device is reset.
    </dd><dt class="description">
<span 
class="aebxti-10">cdb_size</span> </dt><dd 
class="description">is the maximum size of the CDB that the driver will write. The default
    value is written by the device and MUST be 32, but the driver can likewise
    modify it. It is restored to the default when the device is reset.
    </dd><dt class="description">
<span 
class="aebxti-10">max_channel</span><span 
class="aebx-10">, </span><span 
class="aebxti-10">max_target </span><span 
class="aebx-10">and </span><span 
class="aebxti-10">max_lun</span> </dt><dd 
class="description">can be used by the driver as hints
    to constrain scanning the logical units on the host to channel/target/logical
    unit  numbers  that  are  less  than  or  equal  to  the  value  of  the  fields.
    <span 
class="aeti-10">max_channel </span>SHOULD be zero. <span 
class="aeti-10">max_target </span>SHOULD be less than or equal
    to 255. <span 
class="aeti-10">max_lun </span>SHOULD be less than or equal to 16383.</dd></dl>
<a 
 id="x1-307013r308"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.1   </span> <a 
 id="x1-3080001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 5078--><p class="nopar" >The driver MUST NOT write to device configuration fields other than <span 
class="aeti-10">sense_size </span>and
<span 
class="aeti-10">cdb_size</span>.
<!--l. 5081--><p class="noindent" >The driver MUST NOT send more than <span 
class="aeti-10">cmd_per_lun </span>linked commands to one LUN,
and MUST NOT send more than the virtqueue size number of linked commands to
one LUN.
<a 
 id="x1-308001r314"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.2   </span> <a 
 id="x1-3090002"></a>Device Requirements: Device configuration layout</h5>
<!--l. 5087--><p class="nopar" >On reset, the device MUST set <span 
class="aeti-10">sense_size </span>to 96 and <span 
class="aeti-10">cdb_size </span>to 32.
<a 
 id="x1-309001r315"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.3   </span> <a 
 id="x1-3100003"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 5091--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-310001r313"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.5   </span> <a 
 id="x1-3110005"></a>Device Requirements: Device Initialization</h4>
<!--l. 5098--><p class="nopar" >On initialization the driver SHOULD first discover the device’s virtqueues.
                                                                  

                                                                  
<!--l. 5101--><p class="noindent" >If the driver uses the eventq, the driver SHOULD place at least one buffer in the
eventq.
<!--l. 5104--><p class="noindent" >The  driver  MAY  immediately  issue
requests<span class="footnote-mark"><a 
href="#fn16x5" id="fn16x5-bk"><sup class="textsuperscript">16</sup></a></span><a 
 id="x1-311001f16"></a> or task
management functions<span class="footnote-mark"><a 
href="#fn17x5" id="fn17x5-bk"><sup class="textsuperscript">17</sup></a></span><a 
 id="x1-311002f17"></a>.
<a 
 id="x1-311003r317"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.6   </span> <a 
 id="x1-3120006"></a>Device Operation</h4>
<!--l. 5110--><p class="nopar" >Device operation consists of operating request queues, the control queue and the
event queue.
<a 
 id="x1-312001r307"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.0.1</span> <a 
 id="x1-3130001"></a>Legacy Interface: Device Operation</h5>
When using the legacy interface, the driver SHOULD ignore the used length
values.
<span 
class="aebx-10">Note:</span> Historically, devices put the total descriptor length, or the total length
      of device-writable buffers there, even when only part of the buffers were
      actually written.
<a 
 id="x1-313001r316"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.1   </span> <a 
 id="x1-3140001"></a>Device Operation: Request Queues</h5>
<!--l. 5126--><p class="nopar" >The driver queues requests to an arbitrary request queue, and they are used by the
device on that same queue. It is the responsibility of the driver to ensure strict
request ordering for commands placed on different queues, because they will be
consumed with no order constraints.
<!--l. 5132--><p class="noindent" >Requests have the following format:
<!--l. 5134-->
<div class="lstlisting" id="listing-68"><span class="label"><a 
 id="x1-314001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_req_cmd</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">task_attr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">prio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">crn</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cdb</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">cdb_size</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">three</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">present</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_F_T10_PI</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_bytesout</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_bytesin</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_out</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">pi_bytesout</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dataout</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">residual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status_qualifier</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sense_size</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">present</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_F_T10_PI</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_in</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">pi_bytesin</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">datain</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314027r27"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314030r30"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314031r31"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314032r32"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OVERRUN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314033r33"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ABORTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314034r34"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BAD_TARGET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314035r35"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314036r36"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314037r37"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314038r38"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TARGET_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314039r39"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_NEXUS_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314040r40"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314042r42"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">task_attr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314043r43"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_SIMPLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314044r44"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ORDERED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314045r45"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_HEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-314046r46"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ACA</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 5183--><p class="noindent" ><span 
class="aeti-10">lun </span>addresses the REPORT LUNS well-known logical unit, or a target and
logical unit in the virtio-scsi device’s SCSI domain. When used to address the
REPORT LUNS logical unit, <span 
class="aeti-10">lun </span>is 0xC1, 0x01 and six zero bytes. The
virtio-scsi device SHOULD implement the REPORT LUNS well-known logical
unit.
<!--l. 5189--><p class="noindent" >When used to address a target and logical unit, the only supported format for <span 
class="aeti-10">lun </span>is:
first byte set to 1, second byte set to target, third and fourth byte representing a
single level LUN structure, followed by four zero bytes. With this representation, a
virtio-scsi device can serve up to 256 targets and 16384 LUNs per target. The device
                                                                  

                                                                  
MAY also support having a well-known logical units in the third and fourth
byte.
<!--l. 5196--><p class="noindent" ><span 
class="aeti-10">id </span>is the command identifier (“tag”).
<!--l. 5198--><p class="noindent" ><span 
class="aeti-10">task_attr </span>defines the task attribute as in the table above, but all task attributes MAY
be mapped to SIMPLE by the device. Some commands are defined by SCSI
standards as "implicit head of queue"; for such commands, all task attributes MAY
also be mapped to HEAD OF QUEUE. Drivers and applications SHOULD NOT
send a command with the ORDERED task attribute if the command has an implicit
HEAD OF QUEUE attribute, because whether the ORDERED task attribute is
honored is vendor-specific.
<!--l. 5206--><p class="noindent" ><span 
class="aeti-10">crn </span>may also be provided by clients, but is generally expected to be 0. The maximum
CRN value defined by the protocol is 255, since CRN is stored in an 8-bit
integer.
<!--l. 5210--><p class="noindent" >The CDB is included in <span 
class="aeti-10">cdb </span>and its size, <span 
class="aeti-10">cdb_size</span>, is taken from the configuration
space.
<!--l. 5213--><p class="noindent" >All of these fields are defined in <a 
href="#x1-3001r1">SAM</a> and are always device-readable.
<!--l. 5216--><p class="noindent" ><span 
class="aeti-10">pi_bytesout </span>determines the size of the <span 
class="aeti-10">pi_out </span>field in bytes. If it is nonzero, the
<span 
class="aeti-10">pi_out </span>field contains outgoing protection information for write operations.
<span 
class="aeti-10">pi_bytesin </span>determines the size of the <span 
class="aeti-10">pi_in </span>field in the device-writable section, in
bytes. All three fields are only present if VIRTIO_SCSI_F_T10_PI has been
negotiated.
<!--l. 5222--><p class="noindent" >The remainder of the device-readable part is the data output buffer, <span 
class="aeti-10">dataout</span>.
<!--l. 5225--><p class="noindent" ><span 
class="aeti-10">sense </span>and subsequent fields are always device-writable. <span 
class="aeti-10">sense_len </span>indicates the
number of bytes actually written to the sense buffer.
<!--l. 5229--><p class="noindent" ><span 
class="aeti-10">residual </span>indicates the residual size, calculated as “data_length - number_of_transferred_bytes”,
for read or write operations. For bidirectional commands, the number_of_transferred_bytes
includes both read and written bytes. A <span 
class="aeti-10">residual </span>that is less than the size of <span 
class="aeti-10">datain</span>
means that <span 
class="aeti-10">dataout </span>was processed entirely. A <span 
class="aeti-10">residual </span>that exceeds the size of <span 
class="aeti-10">datain</span>
means that <span 
class="aeti-10">dataout </span>was processed partially and <span 
class="aeti-10">datain </span>was not processed at
all.
<!--l. 5239--><p class="noindent" >If the <span 
class="aeti-10">pi_bytesin </span>is nonzero, the <span 
class="aeti-10">pi_in </span>field contains incoming protection information
for read operations. <span 
class="aeti-10">pi_in </span>is only present if VIRTIO_SCSI_F_T10_PI has been
negotiated<span class="footnote-mark"><a 
href="#fn18x5" id="fn18x5-bk"><sup class="textsuperscript">18</sup></a></span><a 
 id="x1-314047f18"></a>.
<!--l. 5247--><p class="noindent" >The remainder of the device-writable part is the data input buffer, <span 
class="aeti-10">datain</span>.
<a 
 id="x1-314048r319"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.1</span> <a 
 id="x1-3150001"></a>Device Requirements: Device Operation: Request Queues</h5>
The device MUST write the <span 
class="aeti-10">status </span>byte as the status code as defined in
<a 
href="#x1-3001r1">SAM</a>.
                                                                  

                                                                  
<!--l. 5256--><p class="noindent" >The device MUST write the <span 
class="aeti-10">response </span>byte as one of the following:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_OK</span> </dt><dd 
class="description">when the request was completed and the <span 
class="aeti-10">status </span>byte is
    filled with a SCSI status code (not necessarily “GOOD”).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_OVERRUN</span> </dt><dd 
class="description">if  the  content  of  the  CDB  (such  as  the
    allocation length, parameter length or transfer size) requires more data
    than is available in the datain and dataout buffers.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_ABORTED</span> </dt><dd 
class="description">if the request was cancelled due to an ABORT
    TASK or ABORT TASK SET task management function.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_BAD_TARGET</span> </dt><dd 
class="description">if   the   request   was   never   processed
    because the target indicated by <span 
class="aeti-10">lun </span>does not exist.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_RESET</span> </dt><dd 
class="description">if the request was cancelled due to a bus or device
    reset (including a task management function).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span> </dt><dd 
class="description">if the request failed due to a
    problem in the connection between the host and the target (severed link).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_TARGET_FAILURE</span> </dt><dd 
class="description">if the target is suffering a failure
    and to tell the driver not to retry on other paths.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_NEXUS_FAILURE</span> </dt><dd 
class="description">if the nexus is suffering a failure but
    retrying on other paths might yield a different result.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_BUSY</span> </dt><dd 
class="description">if the request failed but retrying on the same path
    is likely to work.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_FAILURE</span> </dt><dd 
class="description">for other host or driver error. In particular, if
    neither  <span 
class="aeti-10">dataout  </span>nor  <span 
class="aeti-10">datain  </span>is  empty,  and  the  VIRTIO_SCSI_F_INOUT
    feature has not been negotiated, the request will be immediately returned
    with a response equal to VIRTIO_SCSI_S_FAILURE.</dd></dl>
<!--l. 5297--><p class="noindent" >All commands must be completed before the virtio-scsi device is reset or unplugged.
The device MAY choose to abort them, or if it does not do so MUST pick the
VIRTIO_SCSI_S_FAILURE response.
<a 
 id="x1-315001r321"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.2</span> <a 
 id="x1-3160002"></a>Driver Requirements: Device Operation: Request Queues</h5>
<span 
class="aeti-10">task_attr</span>, <span 
class="aeti-10">prio </span>and <span 
class="aeti-10">crn </span>SHOULD be zero.
<!--l. 5305--><p class="noindent" >Upon receiving a VIRTIO_SCSI_S_TARGET_FAILURE response, the driver
SHOULD NOT retry the request on other paths.
<a 
 id="x1-316001r322"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.3</span> <a 
 id="x1-3170003"></a>Legacy Interface: Device Operation: Request Queues</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_req_cmd according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-317001r320"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.2   </span> <a 
 id="x1-3180002"></a>Device Operation: controlq</h5>
<!--l. 5316--><p class="nopar" >The controlq is used for other SCSI transport operations. Requests have the following
format:
<!--l. 5321-->
<div class="lstlisting" id="listing-69"><span class="label"><a 
 id="x1-318001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318003r3"></a></span><span 
class="pcrr8t-x-x-80">…</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318007r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">all</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">commands</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BAD_TARGET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TARGET_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_NEXUS_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318015r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_INCORRECT_LUN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span>
</div>
<!--l. 5340--><p class="noindent" >The <span 
class="aeti-10">type </span>identifies the remaining fields.
<!--l. 5342--><p class="noindent" >The following commands are defined:
    <ul class="itemize1">
    <li class="itemize">Task management function. <!--l. 5346-->
    <div class="lstlisting" id="listing-70"><span class="label"><a 
 id="x1-318016r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318017r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318018r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_ABORT_TASK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318019r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_ABORT_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318020r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_CLEAR_ACA</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318021r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_CLEAR_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318022r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_I_T_NEXUS_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318023r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_LOGICAL_UNIT_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318024r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_QUERY_TASK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318025r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_QUERY_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318026r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318027r12"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_tmf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318028r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318029r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318030r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">subtype</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318031r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318032r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318033r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318034r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318035r20"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318036r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318037r22"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318038r23"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_COMPLETE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318039r24"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_SUCCEEDED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318040r25"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_REJECTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span>
    
    </div>
    <!--l. 5374--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_TMF; <span 
class="aeti-10">subtype </span>defines which task management
    function. All fields except <span 
class="aeti-10">response </span>are filled by the driver.
    <!--l. 5378--><p class="noindent" >Other fields which are irrelevant for the requested TMF are ignored but they are
    still present. <span 
class="aeti-10">lun </span>is in the same format specified for request queues; the single
    level LUN is ignored when the task management function addresses a whole I_T
    nexus. When relevant, the value of <span 
class="aeti-10">id </span>is matched against the id values passed on
    the requestq.
    <!--l. 5385--><p class="noindent" >The outcome of the task management function is written by the device in
    <span 
class="aeti-10">response</span>. The command-specific response values map 1-to-1 with those defined
    in <a 
href="#x1-3001r1">SAM</a>.
                                                                  

                                                                  
    <!--l. 5389--><p class="noindent" >Task management function can affect the response value for commands that are
    in the request queue and have not been completed yet. For example,
    the device MUST complete all active commands on a logical unit or
    target (possibly with a VIRTIO_SCSI_S_RESET response code) upon
    receiving a "logical unit reset" or "I_T nexus reset" TMF. Similarly,
    the device MUST complete the selected commands (possibly with a
    VIRTIO_SCSI_S_ABORTED response code) upon receiving an "abort task" or
    "abort task set" TMF. Such effects MUST take place before the TMF itself is
    successfully completed, and the device MUST use memory barriers
    appropriately in order to ensure that the driver sees these writes in the correct
    order.
    </li>
    <li class="itemize">Asynchronous notification query. <!--l. 5402-->
    <div class="lstlisting" id="listing-71"><span class="label"><a 
 id="x1-318041r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_AN_QUERY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318042r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318043r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318044r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318045r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318046r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318047r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_requested</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318048r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318049r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318050r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318051r11"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318052r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318053r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_OPERATIONAL_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318054r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_POWER_MGMT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318055r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_EXTERNAL_REQUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318056r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_MEDIA_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318057r17"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_MULTI_HOST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318058r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_DEVICE_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">64</span>
    
    </div>
    <!--l. 5423--><p class="noindent" >By sending this command, the driver asks the device which events the given
    LUN can report, as described in paragraphs 6.6 and A.6 of <a 
href="#x1-3001r1">SCSI MMC</a>. The
    driver writes the events it is interested in into <span 
class="aeti-10">event_requested</span>; the device
    responds by writing the events that it supports into <span 
class="aeti-10">event_actual</span>.
    <!--l. 5430--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_AN_QUERY. <span 
class="aeti-10">lun </span>and <span 
class="aeti-10">event_requested </span>are
    written by the driver. <span 
class="aeti-10">event_actual </span>and <span 
class="aeti-10">response </span>fields are written by the
    device.
    <!--l. 5434--><p class="noindent" >No command-specific values are defined for the <span 
class="aeti-10">response </span>byte.
    </li>
    <li class="itemize">Asynchronous notification subscription. <!--l. 5437-->
    <div class="lstlisting" id="listing-72"><span class="label"><a 
 id="x1-318059r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_AN_SUBSCRIBE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318060r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318061r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318062r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318063r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318064r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318065r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_requested</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318066r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318067r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318068r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-318069r11"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 5451--><p class="noindent" >By sending this command, the driver asks the specified LUN to report events for
    its physical interface, again as described in <a 
href="#x1-3001r1">SCSI MMC</a>. The driver writes the
    events it is interested in into <span 
class="aeti-10">event_requested</span>; the device responds by writing the
    events that it supports into <span 
class="aeti-10">event_actual</span>.
    <!--l. 5457--><p class="noindent" >Event types are the same as for the asynchronous notification query
    message.
    <!--l. 5460--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_AN_SUBSCRIBE. <span 
class="aeti-10">lun </span>and <span 
class="aeti-10">event_requested </span>are
    written by the driver. <span 
class="aeti-10">event_actual </span>and <span 
class="aeti-10">response </span>are written by the
    device.
    <!--l. 5464--><p class="noindent" >No command-specific values are defined for the response byte.</li></ul>
                                                                  

                                                                  
<a 
 id="x1-318070r323"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.2.1</span> <a 
 id="x1-3190001"></a>Legacy Interface: Device Operation: controlq</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_ctrl, struct virtio_scsi_ctrl_tmf, struct
virtio_scsi_ctrl_an and struct virtio_scsi_ctrl_an according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-319001r324"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.3   </span> <a 
 id="x1-3200003"></a>Device Operation: eventq</h5>
<!--l. 5479--><p class="nopar" >The eventq is populated by the driver for the device to report information on
logical units that are attached to it. In general, the device will not queue
events to cope with an empty eventq, and will end up dropping events if it
finds no buffer ready. However, when reporting events for many LUNs (e.g.
when a whole target disappears), the device can throttle events to avoid
dropping them. For this reason, placing 10-15 buffers on the event queue is
sufficient.
<!--l. 5488--><p class="noindent" >Buffers returned by the device on the eventq will be referred to as “events” in the rest
of this section. Events have the following format:
<!--l. 5492-->
<div class="lstlisting" id="listing-73"><span class="label"><a 
 id="x1-320001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_EVENTS_MISSED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80000000</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reason</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 5503--><p class="noindent" >The devices sets bit 31 in <span 
class="aeti-10">event </span>to report lost events due to missing buffers.
<!--l. 5506--><p class="noindent" >The meaning of <span 
class="aeti-10">reason </span>depends on the contents of <span 
class="aeti-10">event</span>. The following events are
defined:
    <ul class="itemize1">
    <li class="itemize">No event. <!--l. 5511-->
    <div class="lstlisting" id="listing-74"><span class="label"><a 
 id="x1-320009r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_NO_EVENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
    
    </div>
    <!--l. 5515--><p class="noindent" >This event is fired in the following cases:
        <ul class="itemize2">
        <li class="itemize">When the device detects in the eventq a buffer that is shorter than
        what is indicated in the configuration field, it MAY use it immediately
        and put this dummy value in <span 
class="aeti-10">event</span>. A well-written driver will never
        observe this situation.
                                                                  

                                                                  
        </li>
        <li class="itemize">When events are dropped, the device MAY signal this event as soon
        as the drivers makes a buffer available, in order to request action from
        the driver. In this case, of course, this event will be reported with the
        VIRTIO_SCSI_T_EVENTS_MISSED flag.</li></ul>
    </li>
    <li class="itemize">Transport reset <!--l. 5532-->
    <div class="lstlisting" id="listing-75"><span class="label"><a 
 id="x1-320010r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TRANSPORT_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320011r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320012r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_HARD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320013r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_RESCAN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-320014r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_REMOVED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
    
    </div>
    <!--l. 5540--><p class="noindent" >By sending this event, the device signals that a logical unit on a target
    has been reset, including the case of a new device appearing or
    disappearing on the bus. The device fills in all fields. <span 
class="aeti-10">event </span>is set to
    VIRTIO_SCSI_T_TRANSPORT_RESET. <span 
class="aeti-10">lun </span>addresses a logical unit in the
    SCSI host.
    <!--l. 5547--><p class="noindent" >The <span 
class="aeti-10">reason </span>value is one of the three #define values appearing above:
        <dl class="description"><dt class="description">
    <span 
class="aebx-10">VIRTIO_SCSI_EVT_RESET_REMOVED</span> </dt><dd 
class="description">(“LUN/target  removed”)
        is  used  if  the  target  or  logical  unit  is  no  longer  able  to  receive
        commands.
        </dd><dt class="description">
    <span 
class="aebx-10">VIRTIO_SCSI_EVT_RESET_HARD</span> </dt><dd 
class="description">(“LUN hard reset”) is used if the
        logical unit has been reset, but is still present.
        </dd><dt class="description">
    <span 
class="aebx-10">VIRTIO_SCSI_EVT_RESET_RESCAN</span> </dt><dd 
class="description">(“rescan   LUN/target”)   is
        used if a target or logical unit has just appeared on the device.</dd></dl>
    <!--l. 5562--><p class="noindent" >The “removed” and “rescan” events can happen when VIRTIO_SCSI_F_HOTPLUG
    feature was negotiated; when sent for LUN 0, they MAY apply to the entire
    target so the driver can ask the initiator to rescan the target to detect
    this.
    <!--l. 5567--><p class="noindent" >Events will also be reported via sense codes (this obviously does not apply to
    newly appeared buses or targets, since the application has never discovered
    them):
        <ul class="itemize2">
        <li class="itemize">“LUN/target removed” maps to sense key ILLEGAL REQUEST, asc
        0x25, ascq 0x00 (LOGICAL UNIT NOT SUPPORTED)
        </li>
        <li class="itemize">“LUN hard reset” maps to sense key UNIT ATTENTION, asc 0x29
        (POWER ON, RESET OR BUS DEVICE RESET OCCURRED)
                                                                  

                                                                  
        </li>
        <li class="itemize">“rescan LUN/target” maps to sense key UNIT ATTENTION, asc 0x3f,
        ascq 0x0e (REPORTED LUNS DATA HAS CHANGED)</li></ul>
    <!--l. 5582--><p class="noindent" >The preferred way to detect transport reset is always to use events, because
    sense codes are only seen by the driver when it sends a SCSI command to
    the logical unit or target. However, in case events are dropped, the
    initiator will still be able to synchronize with the actual state of the
    controller if the driver asks the initiator to rescan of the SCSI bus. During
    the rescan, the initiator will be able to observe the above sense codes,
    and it will process them as if it the driver had received the equivalent
    event.
    </li>
    <li class="itemize">Asynchronous notification <!--l. 5593-->
    <div class="lstlisting" id="listing-76"><span class="label"><a 
 id="x1-320015r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_ASYNC_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
    
    </div>
    <!--l. 5597--><p class="noindent" >By sending this event, the device signals that an asynchronous event was fired
    from a physical interface.
    <!--l. 5600--><p class="noindent" >All fields are written by the device. <span 
class="aeti-10">event </span>is set to VIRTIO_SCSI_T_ASYNC_NOTIFY.
    <span 
class="aeti-10">lun </span>addresses a logical unit in the SCSI host. <span 
class="aeti-10">reason </span>is a subset of the events
    that the driver has subscribed to via the “Asynchronous notification
    subscription” command.
    </li>
    <li class="itemize">LUN parameter change <!--l. 5607-->
    <div class="lstlisting" id="listing-77"><span class="label"><a 
 id="x1-320016r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_PARAM_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
    
    </div>
    <!--l. 5611--><p class="noindent" >By sending this event, the device signals a change in the configuration
    parameters of a logical unit, for example the capacity or cache mode. <span 
class="aeti-10">event </span>is
    set to VIRTIO_SCSI_T_PARAM_CHANGE. <span 
class="aeti-10">lun </span>addresses a logical unit in the
    SCSI host.
    <!--l. 5616--><p class="noindent" >The same event SHOULD also be reported as a unit attention condition. <span 
class="aeti-10">reason</span>
    contains the additional sense code and additional sense code qualifier,
    respectively in bits 0…7 and 8…15.
    <span 
class="aebx-10">Note:</span> For example, a change in capacity will be reported as asc 0x2a, ascq
          0x09 (CAPACITY DATA HAS CHANGED).
    <!--l. 5624--><p class="noindent" >For MMC devices (inquiry type 5) there would be some overlap between this
    event and the asynchronous notification event, so for simplicity the host never
                                                                  

                                                                  
    reports this event for MMC devices.</li></ul>
<a 
 id="x1-320017r325"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.1</span> <a 
 id="x1-3210001"></a>Driver Requirements: Device Operation: eventq</h5>
The driver SHOULD keep the eventq populated with buffers. These buffers MUST be
device-writable, and SHOULD be at least <span 
class="aeti-10">event_info_size </span>bytes long, and MUST be
at least the size of struct virtio_scsi_event.
<!--l. 5636--><p class="noindent" >If <span 
class="aeti-10">event </span>has bit 31 set, the driver SHOULD poll the logical units for unit attention
conditions, and/or do whatever form of bus scan is appropriate for the guest
operating system and SHOULD poll for asynchronous events manually using SCSI
commands.
<!--l. 5641--><p class="noindent" >When receiving a VIRTIO_SCSI_T_TRANSPORT_RESET message with <span 
class="aeti-10">reason </span>set to
VIRTIO_SCSI_EVT_RESET_REMOVED or VIRTIO_SCSI_EVT_RESET_RESCAN
for LUN 0, the driver SHOULD ask the initiator to rescan the target, in order to
detect the case when an entire target has appeared or disappeared.
<a 
 id="x1-321001r327"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.2</span> <a 
 id="x1-3220002"></a>Device Requirements: Device Operation: eventq</h5>
The device MUST set bit 31 in <span 
class="aeti-10">event </span>if events were lost due to missing
buffers, and it MAY use a VIRTIO_SCSI_T_NO_EVENT event to report
this.
<!--l. 5653--><p class="noindent" >The device MUST NOT send VIRTIO_SCSI_T_TRANSPORT_RESET
messages with <span 
class="aeti-10">reason </span>set to VIRTIO_SCSI_EVT_RESET_REMOVED or
VIRTIO_SCSI_EVT_RESET_RESCAN unless VIRTIO_SCSI_F_HOTPLUG was
negotiated.
<!--l. 5657--><p class="noindent" >The device MUST NOT report VIRTIO_SCSI_T_PARAM_CHANGE for MMC
devices.
<a 
 id="x1-322001r328"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.3</span> <a 
 id="x1-3230003"></a>Legacy Interface: Device Operation: eventq</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_event according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-323001r326"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.4   </span> <a 
 id="x1-3240004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 5668--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use a single descriptor for the <span 
class="aeti-10">lun</span>, <span 
class="aeti-10">id</span>, <span 
class="aeti-10">task_attr</span>,
<span 
class="aeti-10">prio</span>, <span 
class="aeti-10">crn </span>and <span 
class="aeti-10">cdb </span>fields, and MUST only use a single descriptor for the <span 
class="aeti-10">sense_len</span>,
                                                                  

                                                                  
<span 
class="aeti-10">residual</span>, <span 
class="aeti-10">status_qualifier</span>, <span 
class="aeti-10">status</span>, <span 
class="aeti-10">response </span>and <span 
class="aeti-10">sense </span>fields.
<a 
 id="x1-324001r309"></a>
<h3 class="sectionHead"><span class="titlemark">5.7   </span> <a 
 id="x1-3250007"></a>GPU Device</h3>
<!--l. 3--><p class="nopar" >virtio-gpu is a virtio based graphics adapter. It can operate in 2D mode and in 3D
(virgl) mode. 3D mode will offload rendering ops to the host gpu and therefore
requires a gpu with 3D support on the host machine.
<!--l. 8--><p class="noindent" >3D mode is not covered (yet) in this specification, even though it is mentioned here
and there due to some details of the virtual hardware being designed with 3D mode
in mind.
<!--l. 12--><p class="noindent" >In 2D mode the virtio-gpu device provides support for ARGB Hardware cursors and
multiple scanouts (aka heads).
<a 
 id="x1-325001r318"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.1   </span> <a 
 id="x1-3260001"></a>Device ID</h4>
<!--l. 17--><p class="nopar" >16
<a 
 id="x1-326001r332"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.2   </span> <a 
 id="x1-3270002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">controlq - queue for sending control commands
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">cursorq - queue for sending cursor updates</dd></dl>
<!--l. 26--><p class="nopar" >Both queues have the same format. Each request and each response have a fixed
header, followed by command specific data fields. The separate cursor queue is the
"fast track" for cursor commands (VIRTIO_GPU_CMD_UPDATE_CURSOR and
VIRTIO_GPU_CMD_MOVE_CURSOR), so they go though without being delayed by
time-consuming commands in the control queue.
<a 
 id="x1-327001r333"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.3   </span> <a 
 id="x1-3280003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_F_VIRGL (0)</span> </dt><dd 
class="description">virgl 3D mode is supported.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_F_EDID (1)</span> </dt><dd 
class="description">EDID is supported.</dd></dl>
<a 
 id="x1-328001r334"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.4   </span> <a 
 id="x1-3290004"></a>Device configuration layout</h4>
<!--l. 42--><p class="nopar" >GPU device configuration uses the following layout structure and definitions:
<!--l. 45-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-78"><span class="label"><a 
 id="x1-329001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_EVENT_DISPLAY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><<</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events_read</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events_clear</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_scanouts</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-329009r330"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.4.1   </span> <a 
 id="x1-3300001"></a>Device configuration fields</h5>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">events_read</span> </dt><dd 
class="description">signals pending events to the driver. The driver MUST NOT write
    to this field.
    </dd><dt class="description">
<span 
class="aebxti-10">events_clear</span> </dt><dd 
class="description">clears  pending  events  in  the  device.  Writing  a  ’1’  into  a  bit
    will clear the corresponding bit in <span 
class="aeti-10">events_read</span>, mimicking write-to-clear
    behavior.
    </dd><dt class="description">
<span 
class="aebxti-10">num_scanouts</span> </dt><dd 
class="description">specifies the maximum number of scanouts supported by the
    device. Minimum value is 1, maximum value is 16.</dd></dl>
<a 
 id="x1-330001r336"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.4.2   </span> <a 
 id="x1-3310002"></a>Events</h5>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_EVENT_DISPLAY</span> </dt><dd 
class="description">Display configuration has changed. The
    driver   SHOULD   use   the   VIRTIO_GPU_CMD_GET_DISPLAY_INFO
    command to fetch the information from the device.</dd></dl>
<a 
 id="x1-331001r335"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.5   </span> <a 
 id="x1-3320005"></a>Device Requirements: Device Initialization</h4>
<!--l. 78--><p class="nopar" >The driver SHOULD query the display information from the device using the
VIRTIO_GPU_CMD_GET_DISPLAY_INFO command and use that information for
the initial scanout setup. In case no information is available or all displays are
disabled the driver MAY choose to use a fallback, such as 1024x768 at display
0.
<a 
 id="x1-332001r338"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.6   </span> <a 
 id="x1-3330006"></a>Device Operation</h4>
<!--l. 86--><p class="nopar" >The virtio-gpu is based around the concept of resources private to the host, the guest
must DMA transfer into these resources. This is a design requirement in order to
interface with future 3D rendering. In the unaccelerated 2D mode there is no support
for DMA transfers from resources, just to them.
<!--l. 92--><p class="noindent" >Resources are initially simple 2D resources, consisting of a width, height and format
along with an identifier. The guest must then attach backing store to the
resources in order for DMA transfers to work. This is like a GART in a real
                                                                  

                                                                  
GPU.
<a 
 id="x1-333001r337"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.1   </span> <a 
 id="x1-3340001"></a>Device Operation: Create a framebuffer and configure scanout</h5>
    <ul class="itemize1">
    <li class="itemize">Create                a                host                resource                using
    VIRTIO_GPU_CMD_RESOURCE_CREATE_2D.
    </li>
    <li class="itemize">Allocate a framebuffer from guest ram, and attach it as backing storage to
    the               resource               just               created,               using
    VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING. Scatter lists are
    supported,  so  the  framebuffer  doesn’t  need  to  be  contignous  in  guest
    physical memory.
    </li>
    <li class="itemize">Use  VIRTIO_GPU_CMD_SET_SCANOUT  to  link  the  framebuffer  to  a
    display scanout.</li></ul>
<a 
 id="x1-334001r340"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.2   </span> <a 
 id="x1-3350002"></a>Device Operation: Update a framebuffer and scanout</h5>
    <ul class="itemize1">
    <li class="itemize">Render to your framebuffer memory.
    </li>
    <li class="itemize">Use VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D to update the host
    resource from guest memory.
    </li>
    <li class="itemize">Use  VIRTIO_GPU_CMD_RESOURCE_FLUSH  to  flush  the  updated
    resource to the display.</li></ul>
<a 
 id="x1-335001r341"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.3   </span> <a 
 id="x1-3360003"></a>Device Operation: Using pageflip</h5>
<!--l. 122--><p class="nopar" >It is possible to create multiple framebuffers, flip between them using
VIRTIO_GPU_CMD_SET_SCANOUT and VIRTIO_GPU_CMD_RESOURCE_FLUSH, and
update the invisible framebuffer using VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D.
<a 
 id="x1-336001r342"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.4   </span> <a 
 id="x1-3370004"></a>Device Operation: Multihead setup</h5>
<!--l. 129--><p class="nopar" >In case two or more displays are present there are different ways to configure
things:
    <ul class="itemize1">
    <li class="itemize">Create a single framebuffer, link it to all displays (mirroring).
    </li>
    <li class="itemize">Create an framebuffer for each display.
                                                                  

                                                                  
    </li>
    <li class="itemize">Create  one  big  framebuffer,  configure  scanouts  to  display  a  different
    rectangle of that framebuffer each.</li></ul>
<a 
 id="x1-337001r343"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.5   </span> <a 
 id="x1-3380005"></a>Device Requirements: Device Operation: Command lifecycle and
fencing</h5>
<!--l. 142--><p class="nopar" >The device MAY process controlq commands asyncronously and return them to the
driver before the processing is complete. If the driver needs to know when the
processing is finished it can set the VIRTIO_GPU_FLAG_FENCE flag in the
request. The device MUST finish the processing before returning the command
then.
<!--l. 148--><p class="noindent" >Note: current qemu implementation does asyncrounous processing only in 3d mode,
when offloading the processing to the host gpu.
<a 
 id="x1-338001r344"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.6   </span> <a 
 id="x1-3390006"></a>Device Operation: Configure mouse cursor</h5>
<!--l. 153--><p class="nopar" >The mouse cursor image is a normal resource, except that it must be
64x64 in size. The driver MUST create and populate the resource
(using the usual VIRTIO_GPU_CMD_RESOURCE_CREATE_2D,
VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING and
VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D controlq commands) and make
sure they are completed (using VIRTIO_GPU_FLAG_FENCE).
<!--l. 160--><p class="noindent" >Then VIRTIO_GPU_CMD_UPDATE_CURSOR can be sent to the cursorq to set the
pointer shape and position. To move the pointer without updating the shape use
VIRTIO_GPU_CMD_MOVE_CURSOR instead.
<a 
 id="x1-339001r345"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.7   </span> <a 
 id="x1-3400007"></a>Device Operation: Request header</h5>
<!--l. 166--><p class="nopar" >All requests and responses on the virt queues have a fixed header using the following
layout structure and definitions:
<!--l. 169-->
<div class="lstlisting" id="listing-79"><span class="label"><a 
 id="x1-340001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_type</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">commands</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_GET_DISPLAY_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0100</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_CREATE_2D</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_UNREF</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_SET_SCANOUT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_FLUSH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_GET_CAPSET_INFO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_GET_CAPSET</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_GET_EDID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cursor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">commands</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_UPDATE_CURSOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0300</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_MOVE_CURSOR</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">success</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">responses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_NODATA</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1100</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_DISPLAY_INFO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_CAPSET_INFO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_CAPSET</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_EDID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">error</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">responses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_UNSPEC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1200</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_OUT_OF_MEMORY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_INVALID_SCANOUT_ID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_INVALID_RESOURCE_ID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_INVALID_CONTEXT_ID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_INVALID_PARAMETER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340034r34"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340036r36"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FLAG_FENCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><<</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340038r38"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fence_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340042r42"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ctx_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-340044r44"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 216--><p class="noindent" >The fixed header <span 
class="aeti-10">struct virtio_gpu_ctrl_hdr </span>in each request includes the following
fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">type</span> </dt><dd 
class="description">specifies the type of the driver request (VIRTIO_GPU_CMD_*) or device
    response (VIRTIO_GPU_RESP_*).
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebxti-10">flags</span> </dt><dd 
class="description">request / response flags.
    </dd><dt class="description">
<span 
class="aebxti-10">fence_id</span> </dt><dd 
class="description">If the driver sets the VIRTIO_GPU_FLAG_FENCE bit in the request <span 
class="aeti-10">flags</span>
    field the device MUST:
        <ul class="itemize1">
        <li class="itemize">set VIRTIO_GPU_FLAG_FENCE bit in the response,
        </li>
        <li class="itemize">copy the content of the <span 
class="aeti-10">fence_id </span>field from the request to the response,
        and
        </li>
        <li class="itemize">send the response only after command processing is complete.</li></ul>
    </dd><dt class="description">
<span 
class="aebxti-10">ctx_id</span> </dt><dd 
class="description">Rendering context (used in 3D mode only).</dd></dl>
<!--l. 234--><p class="noindent" >On success the device will return VIRTIO_GPU_RESP_OK_NODATA in
case there is no payload. Otherwise the <span 
class="aeti-10">type </span>field will indicate the kind of
payload.
<!--l. 238--><p class="noindent" >On error the device will return one of the VIRTIO_GPU_RESP_ERR_* error
codes.
<a 
 id="x1-340045r346"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.8   </span> <a 
 id="x1-3410008"></a>Device Operation: controlq</h5>
<!--l. 243--><p class="nopar" >For any coordinates given 0,0 is top left, larger x moves right, larger y moves
down.
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_GET_DISPLAY_INFO</span> </dt><dd 
class="description">Retrieve the current output
    configuration.  No  request  data  (just  bare  <span 
class="aeti-10">struct  virtio_gpu_ctrl_hdr</span>).
    Response  type  is  VIRTIO_GPU_RESP_OK_DISPLAY_INFO,  response
    data is <span 
class="aeti-10">struct virtio_gpu_resp_display_info</span>.
    <!--l. 254-->
    <div class="lstlisting" id="listing-80"><span class="label"><a 
 id="x1-341001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAX_SCANOUTS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">y</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">height</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341010r10"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resp_display_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_display_one</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">enabled</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pmodes</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAX_SCANOUTS</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 274--><p class="noindent" >The response contains a list of per-scanout information. The info contains
    whether the scanout is enabled and what its preferred position and size
    is.
    <!--l. 278--><p class="noindent" >The size (fields <span 
class="aeti-10">width </span>and <span 
class="aeti-10">height</span>) is similar to the native panel resolution in
    EDID display information, except that in the virtual machine case the size can
    change when the host window representing the guest display is gets
    resized.
                                                                  

                                                                  
    <!--l. 283--><p class="noindent" >The position (fields <span 
class="aeti-10">x </span>and <span 
class="aeti-10">y</span>) describe how the displays are arranged (i.e. which
    is – for example – the left display).
    <!--l. 287--><p class="noindent" >The <span 
class="aeti-10">enabled </span>field is set when the user enabled the display. It is roughly the same
    as the connected state of a phyiscal display connector.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_GET_EDID</span> </dt><dd 
class="description">Retrieve the EDID data for a given
    scanout. Request data is <span 
class="aeti-10">struct virtio_gpu_get_edid</span>). Response type is
    VIRTIO_GPU_RESP_OK_EDID, response data is <span 
class="aeti-10">struct virtio_gpu_resp_edid</span>.
    Support is optional and negotiated using the VIRTIO_GPU_F_EDID feature
    flag.
    <!--l. 297-->
    <div class="lstlisting" id="listing-81"><span class="label"><a 
 id="x1-341018r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_get_edid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341019r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341020r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">scanout</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341021r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341022r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341023r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341024r7"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resp_edid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341025r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341026r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341027r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341028r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">edid</span><span 
class="pcrr8t-x-x-80">[1024];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341029r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 312--><p class="noindent" >The response contains the EDID display data blob (as specified by VESA) for
    the scanout.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_RESOURCE_CREATE_2D</span> </dt><dd 
class="description">Create a 2D resource on the
    host. Request data is <span 
class="aeti-10">struct virtio_gpu_resource_create_2d</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 319-->
    <div class="lstlisting" id="listing-82"><span class="label"><a 
 id="x1-341030r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_formats</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341031r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_B8G8R8A8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341032r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_B8G8R8X8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341033r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_A8R8G8B8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341034r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_X8R8G8B8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341035r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341036r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_R8G8B8A8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">67,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341037r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_X8B8G8R8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">68,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341038r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341039r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_A8B8G8R8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">121,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341040r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_R8G8B8X8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">134,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341041r12"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341042r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341043r14"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_create_2d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341044r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341045r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341046r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">format</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341047r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341048r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">height</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341049r20"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 342--><p class="noindent" >This creates a 2D resource on the host with the specified width, height and
    format. The resource ids are generated by the guest.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_RESOURCE_UNREF</span> </dt><dd 
class="description">Destroy a resource.
    Request data is <span 
class="aeti-10">struct virtio_gpu_resource_unref</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 349-->
    <div class="lstlisting" id="listing-83"><span class="label"><a 
 id="x1-341050r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_unref</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341051r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341052r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341053r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341054r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 357--><p class="noindent" >This informs the host that a resource is no longer required by the guest.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_SET_SCANOUT</span> </dt><dd 
class="description">Set the scanout parameters for a single
                                                                  

                                                                  
    output. Request data is <span 
class="aeti-10">struct virtio_gpu_set_scanout</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 365-->
    <div class="lstlisting" id="listing-84"><span class="label"><a 
 id="x1-341055r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_set_scanout</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341056r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341057r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341058r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">scanout_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341059r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341060r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 374--><p class="noindent" >This sets the scanout parameters for a single scanout. The resource_id is the
    resource to be scanned out from, along with a rectangle.
    <!--l. 377--><p class="noindent" >Scanout rectangles must be completely covered by the underlying resource.
    Overlapping (or identical) scanouts are allowed, typical use case is screen
    mirroring.
    <!--l. 381--><p class="noindent" >The driver can use resource_id = 0 to disable a scanout.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_RESOURCE_FLUSH</span> </dt><dd 
class="description">Flush a scanout resource
    Request data is <span 
class="aeti-10">struct virtio_gpu_resource_flush</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 387-->
    <div class="lstlisting" id="listing-85"><span class="label"><a 
 id="x1-341061r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_flush</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341062r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341063r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341064r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341065r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341066r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 396--><p class="noindent" >This flushes a resource to screen. It takes a rectangle and a resource id, and
    flushes any scanouts the resource is being used on.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D</span> </dt><dd 
class="description">Transfer from guest
    memory to host resource. Request data is <span 
class="aeti-10">struct virtio_gpu_transfer_to_host_2d</span>.
    Response type is VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 404-->
    <div class="lstlisting" id="listing-86"><span class="label"><a 
 id="x1-341067r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_transfer_to_host_2d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341068r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341069r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341070r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341071r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341072r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341073r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 414--><p class="noindent" >This takes a resource id along with an destination offset into the resource, and a
    box to transfer to the host backing for the resource.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING</span> </dt><dd 
class="description">Assign backing
    pages to a resource. Request data is <span 
class="aeti-10">struct virtio_gpu_resource_attach_backing</span>,
    followed by <span 
class="aeti-10">struct virtio_gpu_mem_entry </span>entries. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
                                                                  

                                                                  
    <!--l. 423-->
    <div class="lstlisting" id="listing-87"><span class="label"><a 
 id="x1-341074r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_attach_backing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341075r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341076r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341077r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nr_entries</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341078r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341079r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341080r7"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_mem_entry</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341081r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341082r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341083r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341084r11"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 437--><p class="noindent" >This assign an array of guest pages as the backing store for a resource. These
    pages are then used for the transfer operations for that resource from that point
    on.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING</span> </dt><dd 
class="description">Detach backing
    pages from a resource. Request data is <span 
class="aeti-10">struct virtio_gpu_resource_detach_backing</span>.
    Response type is VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 446-->
    <div class="lstlisting" id="listing-88"><span class="label"><a 
 id="x1-341085r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_detach_backing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341086r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341087r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341088r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-341089r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 454--><p class="noindent" >This detaches any backing pages from a resource, to be used in case of guest
    swapping or object destruction.
    </dd></dl>
<a 
 id="x1-341090r347"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.9   </span> <a 
 id="x1-3420009"></a>Device Operation: cursorq</h5>
<!--l. 461--><p class="nopar" >Both cursorq commands use the same command struct.
<!--l. 463-->
<div class="lstlisting" id="listing-89"><span class="label"><a 
 id="x1-342001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_cursor_pos</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">scanout_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">y</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342008r8"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_update_cursor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_cursor_pos</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pos</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hot_x</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hot_y</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-342015r15"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_UPDATE_CURSOR</span> </dt><dd 
class="description">
    Update cursor. Request data is <span 
class="aeti-10">struct virtio_gpu_update_cursor</span>. Response
    type is VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 488--><p class="noindent" >Full cursor update. Cursor will be loaded from the specified <span 
class="aeti-10">resource_id</span>
    and will be moved to <span 
class="aeti-10">pos</span>. The driver must transfer the cursor into the
    resource beforehand (using control queue commands) and make sure the
    commands to fill the resource are actually processed (using fencing).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_GPU_CMD_MOVE_CURSOR</span> </dt><dd 
class="description">Move
    cursor. Request data is <span 
class="aeti-10">struct virtio_gpu_update_cursor</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
                                                                  

                                                                  
    <!--l. 499--><p class="noindent" >Move cursor to the place specified in <span 
class="aeti-10">pos</span>. The other fields are not used and
    will be ignored by the device.
    </dd></dl>
<a 
 id="x1-342016r339"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.7   </span> <a 
 id="x1-3430007"></a>VGA Compatibility</h4>
<!--l. 506--><p class="nopar" >Applies to Virtio Over PCI only. The GPU device can come with and without VGA
compatibility. The PCI class should be DISPLAY_VGA if VGA compatibility is
present and DISPLAY_OTHER otherwise.
<!--l. 510--><p class="noindent" >VGA compatibility: PCI region 0 has the linear framebuffer, standard vga registers
are present. Configuring a scanout (VIRTIO_GPU_CMD_SET_SCANOUT) switches
the device from vga compatibility mode into native virtio mode. A reset switches it
back into vga compatibility mode.
<!--l. 516--><p class="noindent" >Note: qemu implementation also provides bochs dispi interface io ports and mmio bar
at pci region 1 and is therefore fully compatible with the qemu stdvga (see
<a 
href="https://git.qemu-project.org/?p=qemu.git;a=blob;f=docs/specs/standard-vga.txt;hb=HEAD" >docs/specs/standard-vga.txt</a> in the qemu source tree).
<a 
 id="x1-343001r331"></a>
<h3 class="sectionHead"><span class="titlemark">5.8   </span> <a 
 id="x1-3440008"></a>Input Device</h3>
<!--l. 3--><p class="nopar" >The virtio input device can be used to create virtual human interface devices such as
keyboards, mice and tablets. An instance of the virtio device represents one such
input device. Device behavior mirrors that of the evdev layer in Linux, making
pass-through implementations on top of evdev easy.
<!--l. 9--><p class="noindent" >This specification defines how evdev events are transported over virtio and how
the set of supported events is discovered by a driver. It does not, however,
define the semantics of input events as this is dependent on the particular
evdev implementation. For the list of events used by Linux input devices, see
<a 
href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/input-event-codes.h" >include/uapi/linux/input-event-codes.h</a> in the Linux source tree.
<a 
 id="x1-344001r349"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.1   </span> <a 
 id="x1-3450001"></a>Device ID</h4>
<!--l. 19--><p class="nopar" >18
<a 
 id="x1-345001r351"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.2   </span> <a 
 id="x1-3460002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">eventq
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">statusq</dd></dl>
<a 
 id="x1-346001r352"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.8.3   </span> <a 
 id="x1-3470003"></a>Feature bits</h4>
<!--l. 30--><p class="nopar" >None.
<a 
 id="x1-347001r353"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.4   </span> <a 
 id="x1-3480004"></a>Device configuration layout</h4>
<!--l. 34--><p class="nopar" >Device configuration holds all information the guest needs to handle the device, most
importantly the events which are supported.
<!--l. 37-->
<div class="lstlisting" id="listing-90"><span class="label"><a 
 id="x1-348001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_config_select</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_UNSET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_ID_NAME</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_ID_SERIAL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_ID_DEVIDS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_PROP_BITS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x10</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_EV_BITS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x11</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_ABS_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x12</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348011r11"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_absinfo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">min</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuzz</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flat</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">res</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348019r19"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_devids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bustype</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vendor</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">product</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">version</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348024r24"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348026r26"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">subsel</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[5];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">union</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">char</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">string</span><span 
class="pcrr8t-x-x-80">[128];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bitmap</span><span 
class="pcrr8t-x-x-80">[128];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_absinfo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">abs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_devids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-348037r37"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 77--><p class="noindent" >To query a specific piece of information the driver sets <span 
class="aeti-10">select </span>and <span 
class="aeti-10">subsel </span>accordingly,
then checks <span 
class="aeti-10">size </span>to see how much information is available. <span 
class="aeti-10">size </span>can be zero if no
information is available. Strings do not include a NUL terminator. Related evdev
ioctl names are provided for reference.
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_INPUT_CFG_ID_NAME</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel </span>is zero. Returns the name of the
    device, in <span 
class="aeti-10">u.string</span>.
    <!--l. 88--><p class="noindent" >Similar to EVIOCGNAME ioctl for Linux evdev devices.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_INPUT_CFG_ID_SERIAL</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel  </span>is  zero.  Returns  the  serial
    number of the device, in <span 
class="aeti-10">u.string</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_INPUT_CFG_ID_DEVIDS</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel </span>is zero. Returns ID information
    of the device, in <span 
class="aeti-10">u.ids</span>.
    <!--l. 98--><p class="noindent" >Similar to EVIOCGID ioctl for Linux evdev devices.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_INPUT_CFG_PROP_BITS</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel               </span>is                zero.
    Returns input properties of the device, in <span 
class="aeti-10">u.bitmap</span>. Individual bits in the
    bitmap correspond to INPUT_PROP_* constants used by the underlying
    evdev implementation.
    <!--l. 106--><p class="noindent" >Similar to EVIOCGPROP ioctl for Linux evdev devices.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_INPUT_CFG_EV_BITS</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel  </span>specifies  the  event  type  using
    EV_* constants in the underlying evdev implementation. If <span 
class="aeti-10">size </span>is non-zero
    the  event  type  is  supported  and  a  bitmap  of  supported  event  codes
    is  returned  in  <span 
class="aeti-10">u.bitmap</span>.  Individual  bits  in  the  bitmap  correspond  to
    implementation-defined input event codes, for example keys or pointing
                                                                  

                                                                  
    device axes.
    <!--l. 117--><p class="noindent" >Similar to EVIOCGBIT ioctl for Linux evdev devices.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_INPUT_CFG_ABS_INFO</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel </span>specifies the absolute axis using
    ABS_*  constants  in  the  underlying  evdev  implementation.  Information
    about the axis will be returned in <span 
class="aeti-10">u.abs</span>.
    <!--l. 124--><p class="noindent" >Similar to EVIOCGABS ioctl for Linux evdev devices.
    </dd></dl>
<a 
 id="x1-348038r354"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.5   </span> <a 
 id="x1-3490005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-349002x1">The device is queried for supported event types and codes.
    </li>
    <li 
  class="enumerate" id="x1-349004x2">The eventq is populated with receive buffers.</li></ol>
<a 
 id="x1-349005r348"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.8.5.1   </span> <a 
 id="x1-3500001"></a>Driver Requirements: Device Initialization</h5>
<!--l. 136--><p class="nopar" >A driver MUST set both <span 
class="aeti-10">select </span>and <span 
class="aeti-10">subsel </span>when querying device configuration, in any
order.
<!--l. 139--><p class="noindent" >A driver MUST NOT write to configuration fields other than <span 
class="aeti-10">select </span>and
<span 
class="aeti-10">subsel</span>.
<!--l. 142--><p class="noindent" >A driver SHOULD check the <span 
class="aeti-10">size </span>field before accessing the configuration
information.
<a 
 id="x1-350001r356"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.8.5.2   </span> <a 
 id="x1-3510002"></a>Device Requirements: Device Initialization</h5>
<!--l. 146--><p class="nopar" >A device MUST set the <span 
class="aeti-10">size </span>field to zero if it doesn’t support a given <span 
class="aeti-10">select </span>and
<span 
class="aeti-10">subsel </span>combination.
<a 
 id="x1-351001r355"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.6   </span> <a 
 id="x1-3520006"></a>Device Operation</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-352002x1">Input events such as press and release events for keys and buttons, and
    motion events for pointing devices are sent from the device to the driver
    using the eventq.
    </li>
    <li 
  class="enumerate" id="x1-352004x2">Status feedback such as keyboard LED updates are sent from the driver to
    the device using the statusq.
                                                                  

                                                                  
    </li>
    <li 
  class="enumerate" id="x1-352006x3">Both queues use the same virtio_input_event struct. <span 
class="aeti-10">type</span>, <span 
class="aeti-10">code </span>and <span 
class="aeti-10">value</span>
    are filled according to the Linux input layer (evdev) interface, except that
    the fields are in little endian byte order whereas the evdev ioctl interface
    uses native endian-ness.</li></ol>
<!--l. 164-->
<div class="lstlisting" id="listing-91"><span class="label"><a 
 id="x1-352007r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-352008r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-352009r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">code</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-352010r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-352011r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-352012r357"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.8.6.1   </span> <a 
 id="x1-3530001"></a>Driver Requirements: Device Operation</h5>
<!--l. 174--><p class="nopar" >A driver SHOULD keep the eventq populated with buffers. These buffers MUST be
device-writable and MUST be at least the size of struct virtio_input_event.
<!--l. 178--><p class="noindent" >Buffers placed into the statusq by a driver MUST be at least the size of struct
virtio_input_event.
<!--l. 181--><p class="noindent" >A driver SHOULD ignore eventq input events it does not recognize. Note that evdev
devices generally maintain backward compatibility by sending redundant events and
relying on the consuming side using only the events it understands and ignoring the
rest.
<a 
 id="x1-353001r359"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.8.6.2   </span> <a 
 id="x1-3540002"></a>Device Requirements: Device Operation</h5>
<!--l. 188--><p class="nopar" >A device MAY drop input events if the eventq does not have enough available
buffers. It SHOULD NOT drop individual input events if they are part of a
sequence forming one input device update. For example, a pointing device
update typically consists of several input events, one for each axis, and a
terminating EV_SYN event. A device SHOULD either buffer or drop the entire
sequence.
<a 
 id="x1-354001r350"></a>
<h3 class="sectionHead"><span class="titlemark">5.9   </span> <a 
 id="x1-3550009"></a>Crypto Device</h3>
<!--l. 3--><p class="nopar" >The virtio crypto device is a virtual cryptography device as well as a virtual
cryptographic accelerator. The virtio crypto device provides the following crypto
services: CIPHER, MAC, HASH, and AEAD. Virtio crypto devices have a single
control queue and at least one data queue. Crypto operation requests are placed into
a data queue, and serviced by the device. Some crypto operation requests are only
valid in the context of a session. The role of the control queue is facilitating control
operation requests. Sessions management is realized with control operation
requests.
<a 
 id="x1-355001r358"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.9.1   </span> <a 
 id="x1-3560001"></a>Device ID</h4>
<!--l. 15--><p class="nopar" >20
<a 
 id="x1-356001r362"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.2   </span> <a 
 id="x1-3570002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">dataq1
    </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aebx-10">N-1</span> </dt><dd 
class="description">dataqN
    </dd><dt class="description">
<span 
class="aebx-10">N</span> </dt><dd 
class="description">controlq</dd></dl>
<!--l. 26--><p class="nopar" >N is set by <span 
class="aeti-10">max_dataqueues</span>.
<a 
 id="x1-357001r363"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.3   </span> <a 
 id="x1-3580003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_REVISION_1 (0) revision 1. Revision 1 has a specific
    request format and other enhancements (which result in some additional
    requirements).
    </dd><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE   (1)   stateless   mode
    requests are supported by the CIPHER service.
    </dd><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_HASH_STATELESS_MODE (2) stateless mode requests
    are supported by the HASH service.
    </dd><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_MAC_STATELESS_MODE (3) stateless mode requests
    are supported by the MAC service.
    </dd><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE    (4)    stateless    mode
    requests are supported by the AEAD service.</dd></dl>
<a 
 id="x1-358001r360"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.3.1   </span> <a 
 id="x1-3590001"></a>Feature bit requirements</h5>
<!--l. 47--><p class="nopar" >Some crypto feature bits require other crypto feature bits (see <a 
href="#x1-140001">2.2.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Feature Bits --></a>):
    <dl class="description"><dt class="description">
                                                                  

                                                                  
<span 
class="aebx-10">VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE</span> </dt><dd 
class="description">Requires
    VIRTIO_CRYPTO_F_REVISION_1.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CRYPTO_F_HASH_STATELESS_MODE</span> </dt><dd 
class="description">Requires
    VIRTIO_CRYPTO_F_REVISION_1.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CRYPTO_F_MAC_STATELESS_MODE</span> </dt><dd 
class="description">Requires
    VIRTIO_CRYPTO_F_REVISION_1.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE</span> </dt><dd 
class="description">Requires
    VIRTIO_CRYPTO_F_REVISION_1.</dd></dl>
<a 
 id="x1-359001r364"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.4   </span> <a 
 id="x1-3600004"></a>Supported crypto services</h4>
<!--l. 59--><p class="nopar" >The following crypto services are defined:
<!--l. 61-->
<div class="lstlisting" id="listing-92"><span class="label"><a 
 id="x1-360001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-360002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-360003r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-360004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-360005r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">Message</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authentication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Codes</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-360006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-360007r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">Authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Encryption</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Associated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Data</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-360008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 72--><p class="noindent" >The above constants designate bits used to indicate the which of crypto services are
offered by the device as described in, see <a 
href="#x1-3650005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
<a 
 id="x1-360009r365"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.4.1   </span> <a 
 id="x1-3610001"></a>CIPHER services</h5>
<!--l. 77--><p class="nopar" >The following CIPHER algorithms are defined:
<!--l. 79-->
<div class="lstlisting" id="listing-93"><span class="label"><a 
 id="x1-361001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NO_CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_ARC4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_ECB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_CTR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_DES_ECB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_DES_CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_3DES_ECB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_3DES_CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_3DES_CTR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_KASUMI_F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_SNOW3G_UEA2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_XTS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">13</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-361015r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_ZUC_EEA3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">14</span>
</div>
<!--l. 97--><p class="noindent" >The above constants have two usages:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-361017x1">As bit numbers, used to tell the driver which CIPHER algorithms are
    supported by the device, see <a 
href="#x1-3650005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
    </li>
    <li 
  class="enumerate" id="x1-361019x2">As  values,  used  to  designate  the  algorithm  in  (CIPHER  type)  crypto
    operation requests, see <a 
href="#x1-3730001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>.</li></ol>
<a 
 id="x1-361020r367"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.9.4.2   </span> <a 
 id="x1-3620002"></a>HASH services</h5>
<!--l. 107--><p class="nopar" >The following HASH algorithms are defined:
<!--l. 109-->
<div class="lstlisting" id="listing-94"><span class="label"><a 
 id="x1-362001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NO_HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_MD5</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA_224</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA_256</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA_384</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA_512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_224</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_256</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_384</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_SHAKE128</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_SHAKE256</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span>
</div>
<!--l. 125--><p class="noindent" >The above constants have two usages:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-362015x1">As  bit  numbers,  used  to  tell  the  driver  which  HASH  algorithms  are
    supported by the device, see <a 
href="#x1-3650005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
    </li>
    <li 
  class="enumerate" id="x1-362017x2">As values, used to designate the algorithm in (HASH type) crypto operation
    requires, see <a 
href="#x1-3730001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>.</li></ol>
<a 
 id="x1-362018r368"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.4.3   </span> <a 
 id="x1-3630003"></a>MAC services</h5>
<!--l. 135--><p class="nopar" >The following MAC algorithms are defined:
<!--l. 137-->
<div class="lstlisting" id="listing-95"><span class="label"><a 
 id="x1-363001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NO_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_MD5</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA_224</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA_256</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA_384</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA_512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CMAC_3DES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">25</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CMAC_AES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">26</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_KASUMI_F9</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">27</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_SNOW3G_UIA2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">28</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_GMAC_AES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">41</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_GMAC_TWOFISH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">42</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CBCMAC_AES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">49</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363015r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CBCMAC_KASUMI_F9</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">50</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363016r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_XCBC_AES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">53</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-363017r17"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_ZUC_EIA3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">54</span>
</div>
<!--l. 157--><p class="noindent" >The above constants have two usages:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-363019x1">As  bit  numbers,  used  to  tell  the  driver  which  MAC  algorithms  are
    supported by the device, see <a 
href="#x1-3650005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
    </li>
    <li 
  class="enumerate" id="x1-363021x2">As values, used to designate the algorithm in (MAC type) crypto operation
    requests, see <a 
href="#x1-3730001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>.</li></ol>
<a 
 id="x1-363022r369"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.4.4   </span> <a 
 id="x1-3640004"></a>AEAD services</h5>
<!--l. 167--><p class="nopar" >The following AEAD algorithms are defined:
<!--l. 169-->
<div class="lstlisting" id="listing-96"><span class="label"><a 
 id="x1-364001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NO_AEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_GCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_CCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_CHACHA20_POLY1305</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
                                                                  

                                                                  
</div>
<!--l. 176--><p class="noindent" >The above constants have two usages:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-364006x1">As  bit  numbers,  used  to  tell  the  driver  which  AEAD  algorithms  are
    supported by the device, see <a 
href="#x1-3650005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
    </li>
    <li 
  class="enumerate" id="x1-364008x2">As  values,  used  to  designate  the  algorithm  in  (DEAD  type)  crypto
    operation requests, see <a 
href="#x1-3730001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>.</li></ol>
<a 
 id="x1-364009r366"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.5   </span> <a 
 id="x1-3650005"></a>Device configuration layout</h4>
<!--l. 186--><p class="nopar" >Crypto device configuration uses the following layout structure:
<!--l. 188-->
<div class="lstlisting" id="listing-97"><span class="label"><a 
 id="x1-365001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_dataqueues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">crypto_services</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Detailed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algorithms</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mask</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_algo_l</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_algo_h</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac_algo_l</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac_algo_h</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aead_algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Maximum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_cipher_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Maximum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_auth_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Maximum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">crypto</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">request</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">content</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-365019r19"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
 </dt><dd 
class="description">Currently, only one <span 
class="aeti-10">status </span>bit is defined: VIRTIO_CRYPTO_S_HW_READY set
    indicates that the device is ready to process requests, this bit is read-only for the
    driver <!--l. 214-->
    <div class="lstlisting" id="listing-98"><span class="label"><a 
 id="x1-365020r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_S_HW_READY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><<</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span>
    
    </div>
    </dd><dt class="description">
<span 
class="aebxti-10">max_dataqueues</span> </dt><dd 
class="description">is the maximum number of data virtqueues that can be
    configured by the device. The driver MAY use only one data queue, or it can use
    more to achieve better performance.
    </dd><dt class="description">
<span 
class="aebxti-10">crypto_services</span> </dt><dd 
class="description">crypto service offered, see <a 
href="#x1-3600004">5.9.4<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">cipher_algo_l</span> </dt><dd 
class="description">CIPHER algorithms bits 0-31, see <a 
href="#x1-3610001">5.9.4.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / CIPHER services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">cipher_algo_h</span> </dt><dd 
class="description">CIPHER algorithms bits 32-63, see <a 
href="#x1-3610001">5.9.4.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / CIPHER services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">hash_algo</span> </dt><dd 
class="description">HASH algorithms bits, see <a 
href="#x1-3620002">5.9.4.2<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / HASH services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">mac_algo_l</span> </dt><dd 
class="description">MAC algorithms bits 0-31, see <a 
href="#x1-3630003">5.9.4.3<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / MAC services --></a>.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebxti-10">mac_algo_h</span> </dt><dd 
class="description">MAC algorithms bits 32-63, see <a 
href="#x1-3630003">5.9.4.3<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / MAC services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">aead_algo</span> </dt><dd 
class="description">AEAD algorithms bits, see <a 
href="#x1-3640004">5.9.4.4<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / AEAD services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">max_cipher_key_len</span> </dt><dd 
class="description">is the maximum length of cipher key supported by the
    device.
    </dd><dt class="description">
<span 
class="aebxti-10">max_auth_key_len</span> </dt><dd 
class="description">is the maximum length of authenticated key supported by the
    device.
    </dd><dt class="description">
<span 
class="aebxti-10">reserved</span> </dt><dd 
class="description">is reserved for future use.
    </dd><dt class="description">
<span 
class="aebxti-10">max_size</span> </dt><dd 
class="description">is the maximum size of the variable-length parameters of data operation
    of each crypto request’s content supported by the device.</dd></dl>
<span 
class="aebx-10">Note:</span> Unless explicitly stated otherwise all lengths and sizes are in bytes.
<a 
 id="x1-365021r370"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.5.1   </span> <a 
 id="x1-3660001"></a>Device Requirements: Device configuration layout</h5>
    <ul class="itemize1">
    <li class="itemize">The device MUST set <span 
class="aeti-10">max_dataqueues </span>to between 1 and 65535 inclusive.
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>with valid flags, undefined flags MUST
    NOT be set.
    </li>
    <li class="itemize">The  device  MUST  accept  and  handle  requests  after  <span 
class="aeti-10">status  </span>is  set  to
    VIRTIO_CRYPTO_S_HW_READY.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">crypto_services  </span>based on the crypto services the
    device offers.
    </li>
    <li class="itemize">The device MUST set detailed algorithms masks for each service advertised
    by <span 
class="aeti-10">crypto_services</span>. The device MUST NOT set the not defined algorithms
    bits.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">max_size </span>to show the maximum size of crypto request
    the device supports.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">max_cipher_key_len </span>to show the maximum length of
    cipher key if the device supports CIPHER service.
    </li>
                                                                  

                                                                  
    <li class="itemize">The device MUST set <span 
class="aeti-10">max_auth_key_len </span>to show the maximum length of
    authenticated key if the device supports MAC service.</li></ul>
<a 
 id="x1-366001r372"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.5.2   </span> <a 
 id="x1-3670002"></a>Driver Requirements: Device configuration layout</h5>
    <ul class="itemize1">
    <li class="itemize">The  driver  MUST  read  the  <span 
class="aeti-10">status  </span>from  the  bottom  bit  of  status  to
    check whether the VIRTIO_CRYPTO_S_HW_READY is set, and the driver
    MUST reread it after device reset.
    </li>
    <li class="itemize">The  driver  MUST  NOT  transmit  any  requests  to  the  device  if  the
    VIRTIO_CRYPTO_S_HW_READY is not set.
    </li>
    <li class="itemize">The driver MUST read <span 
class="aeti-10">max_dataqueues </span>field to discover the number of
    data queues the device supports.
    </li>
    <li class="itemize">The driver MUST read <span 
class="aeti-10">crypto_services </span>field to discover which services the
    device is able to offer.
    </li>
    <li class="itemize">The driver SHOULD ignore the not defined algorithms bits.
    </li>
    <li class="itemize">The   driver   MUST   read   the   detailed   algorithms   fields   based   on
    <span 
class="aeti-10">crypto_services </span>field.
    </li>
    <li class="itemize">The driver SHOULD read <span 
class="aeti-10">max_size </span>to discover the maximum size of the
    variable-length parameters of data operation of the crypto request’s content
    the device supports and MUST guarantee the size of each crypto request’s
    content within the <span 
class="aeti-10">max_size</span>, otherwise the request will fail and the driver
    MUST reset the device.
    </li>
    <li class="itemize">The driver SHOULD read <span 
class="aeti-10">max_cipher_key_len </span>to discover the maximum
    length of cipher key the device supports and MUST guarantee the <span 
class="aeti-10">key_len</span>
    (CIPHER service or AEAD service) within the <span 
class="aeti-10">max_cipher_key_len </span>of the
    device configuration, otherwise the request will fail.
    </li>
    <li class="itemize">The  driver  SHOULD  read  <span 
class="aeti-10">max_auth_key_len  </span>to  discover  the  maximum
    length of authenticated key the device supports and MUST guarantee the
    <span 
class="aeti-10">auth_key_len  </span>(MAC  service)  within  the  <span 
class="aeti-10">max_auth_key_len  </span>of  the  device
    configuration, otherwise the request will fail.</li></ul>
<a 
 id="x1-367001r371"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.6   </span> <a 
 id="x1-3680006"></a>Device Initialization</h4>
<a 
 id="x1-368001r373"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.9.6.1   </span> <a 
 id="x1-3690001"></a>Driver Requirements: Device Initialization</h5>
    <ul class="itemize1">
    <li class="itemize">The driver MUST configure and initialize all virtqueues.
    </li>
    <li class="itemize">The  driver  MUST  read  the  supported  crypto  services  from  bits  of
    <span 
class="aeti-10">crypto_services</span>.
    </li>
    <li class="itemize">The driver MUST read the supported algorithms based on <span 
class="aeti-10">crypto_services</span>
    field.</li></ul>
<a 
 id="x1-369001r374"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.7   </span> <a 
 id="x1-3700007"></a>Device Operation</h4>
<!--l. 300--><p class="nopar" >The operation of a virtio crypto device is driven by requests placed on the virtqueues.
Requests consist of a queue-type specific header (specifying among others the
operation) and an operation specific payload.
<!--l. 304--><p class="noindent" >If VIRTIO_CRYPTO_F_REVISION_1 is negotiated the device may support both
session mode (See <a 
href="#x1-3730001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>) and stateless mode operation requests. In stateless mode
all operation parameters are supplied as a part of each request, while in session
mode, some or all operation parameters are managed within the session.
Stateless mode is guarded by feature bits 0-4 on a service level. If stateless
mode is negotiated for a service, the service accepts both session mode and
stateless requests; otherwise stateless mode requests are rejected (via operation
status).
<a 
 id="x1-370001r375"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.1   </span> <a 
 id="x1-3710001"></a>Operation Status</h5>
<!--l. 315--><p class="nopar" >The device MUST return a status code as part of the operation (both session
operation and service operation) result. The valid operation status as follows:
<!--l. 318-->
<div class="lstlisting" id="listing-99"><span class="label"><a 
 id="x1-371001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_STATUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-371002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-371003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_ERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-371004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_BADMSG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-371005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NOTSUPP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-371006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_INVSESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-371007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NOSPC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-371008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAX</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-371009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <ul class="itemize1">
    <li class="itemize">VIRTIO_CRYPTO_OK: success.
    </li>
    <li class="itemize">VIRTIO_CRYPTO_BADMSG:  authentication  failed  (only  when  AEAD
    decryption).
    </li>
    <li class="itemize">VIRTIO_CRYPTO_NOTSUPP: operation or algorithm is unsupported.
    </li>
    <li class="itemize">VIRTIO_CRYPTO_INVSESS: invalid session ID when executing crypto
                                                                  

                                                                  
    operations.
    </li>
    <li class="itemize">VIRTIO_CRYPTO_NOSPC:   no   free   session   ID   (only   when   the
    VIRTIO_CRYPTO_F_REVISION_1 feature bit is negotiated).
    </li>
    <li class="itemize">VIRTIO_CRYPTO_ERR: any failure not mentioned above occurs.</li></ul>
<a 
 id="x1-371010r377"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.2   </span> <a 
 id="x1-3720002"></a>Control Virtqueue</h5>
<!--l. 342--><p class="nopar" >The driver uses the control virtqueue to send control commands to the device, such
as session operations (See <a 
href="#x1-3730001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>).
<!--l. 346--><p class="noindent" >The header for controlq is of the following form: <!--l. 347-->
<div class="lstlisting" id="listing-100"><span class="label"><a 
 id="x1-372001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(((</span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><<</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_ctrl_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_CREATE_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_DESTROY_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_CREATE_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_HASH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_DESTROY_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_HASH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CREATE_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_MAC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_DESTROY_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_MAC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372016r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_CREATE_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372018r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_DESTROY_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algorithms</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flag</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372025r25"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 375--><p class="noindent" >The controlq request is composed of four parts: <!--l. 376-->
<div class="lstlisting" id="listing-101"><span class="label"><a 
 id="x1-372026r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_op_ctrl_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372027r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372028r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372029r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_ctrl_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372030r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372031r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CTRLQ_OP_SPEC_HDR_LEGACY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">56</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372032r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fixed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372033r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">flf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372034r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372035r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">variable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372036r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vlf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372037r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372038r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372039r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372040r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">completion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372041r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_outcome</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">outcome_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-372042r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 396--><p class="noindent" ><span 
class="aeti-10">header </span>is a general header (see above).
<!--l. 398--><p class="noindent" ><span 
class="aeti-10">op_flf  </span>is the opcode (in <span 
class="aeti-10">header</span>) specific fixed-length paramenters.
<!--l. 400--><p class="noindent" ><span 
class="aeti-10">flf_len </span>depends on the VIRTIO_CRYPTO_F_REVISION_1 feature bit (see
below).
<!--l. 402--><p class="noindent" ><span 
class="aeti-10">op_vlf  </span>is the opcode (in <span 
class="aeti-10">header</span>) specific variable-length paramenters.
<!--l. 404--><p class="noindent" ><span 
class="aeti-10">vlf_len </span>is the size of the specific structure used.
<span 
class="aebx-10">Note:</span> The  <span 
class="aeti-10">vlf_len  </span>of  session-destroy  operation  and  the  hash-session-create
      operation is ZERO.
    <ul class="itemize1">
    <li class="itemize">If                 the                 opcode                 (in                 <span 
class="aeti-10">header</span>)
    is VIRTIO_CRYPTO_CIPHER_CREATE_SESSION then <span 
class="aeti-10">op_flf  </span>is struct
    virtio_crypto_sym_create_session_flf if VIRTIO_CRYPTO_F_REVISION_1
    is negotiated and struct virtio_crypto_sym_create_session_flf is padded to
    56     bytes     if     NOT     negotiated,     and     <span 
class="aeti-10">op_vlf     </span>is     struct
    virtio_crypto_sym_create_session_vlf.
    </li>
    <li class="itemize">If                 the                 opcode                 (in                 <span 
class="aeti-10">header</span>)
    is  VIRTIO_CRYPTO_HASH_CREATE_SESSION  then  <span 
class="aeti-10">op_flf  </span>is  struct
                                                                  

                                                                  
    virtio_crypto_hash_create_session_flf if VIRTIO_CRYPTO_F_REVISION_1
    is negotiated and struct virtio_crypto_hash_create_session_flf is padded to
    56 bytes if NOT negotiated.
    </li>
    <li class="itemize">If the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_MAC_CREATE_SESSION
    then                         <span 
class="aeti-10">op_flf                        </span>is                         struct
    virtio_crypto_mac_create_session_flf if VIRTIO_CRYPTO_F_REVISION_1
    is negotiated and struct virtio_crypto_mac_create_session_flf is padded to
    56     bytes     if     NOT     negotiated,     and     <span 
class="aeti-10">op_vlf     </span>is     struct
    virtio_crypto_mac_create_session_vlf.
    </li>
    <li class="itemize">If                 the                 opcode                 (in                 <span 
class="aeti-10">header</span>)
    is  VIRTIO_CRYPTO_AEAD_CREATE_SESSION  then  <span 
class="aeti-10">op_flf  </span>is  struct
    virtio_crypto_aead_create_session_flf if VIRTIO_CRYPTO_F_REVISION_1
    is negotiated and struct virtio_crypto_aead_create_session_flf is padded to
    56     bytes     if     NOT     negotiated,     and     <span 
class="aeti-10">op_vlf     </span>is     struct
    virtio_crypto_aead_create_session_vlf.
    </li>
    <li class="itemize">If                                                                                           the
    opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_CIPHER_DESTROY_SESSION
    or              VIRTIO_CRYPTO_HASH_DESTROY_SESSION              or
    VIRTIO_CRYPTO_MAC_DESTROY_SESSION
    or VIRTIO_CRYPTO_AEAD_DESTROY_SESSION then <span 
class="aeti-10">op_flf  </span>is struct
    virtio_crypto_destroy_session_flf  if  VIRTIO_CRYPTO_F_REVISION_1  is
    negotiated and struct virtio_crypto_destroy_session_flf is padded to 56 bytes
    if NOT negotiated.</li></ul>
<!--l. 437--><p class="noindent" ><span 
class="aeti-10">op_outcome </span>stores the result of operation and must be struct virtio_crypto_destroy_session_input
for destroy session or struct virtio_crypto_create_session_input for create
session.
<!--l. 441--><p class="noindent" ><span 
class="aeti-10">outcome_len </span>is the size of the structure used.
<a 
 id="x1-372043r329"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.2.1</span> <a 
 id="x1-3730001"></a>Session operation</h5>
The session is a handle which describes the cryptographic parameters to be applied
to a number of buffers.
<!--l. 450--><p class="noindent" >The following structure stores the result of session creation set by the device:
<!--l. 452-->
<div class="lstlisting" id="listing-102"><span class="label"><a 
 id="x1-373001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_create_session_input</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">session_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 460--><p class="noindent" >A request to destroy a session includes the following information:
                                                                  

                                                                  
<!--l. 462-->
<div class="lstlisting" id="listing-103"><span class="label"><a 
 id="x1-373006r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_destroy_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373007r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373008r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">session_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373009r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373010r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373011r6"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_destroy_session_input</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373012r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373013r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373014r9"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-373015r298"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.1</span> <a 
 id="x1-3740001"></a>Session operation: HASH session</h6>
The fixed-length paramenters of HASH session requests is as follows:
<!--l. 480-->
<div class="lstlisting" id="listing-104"><span class="label"><a 
 id="x1-374001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_create_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-374002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-374003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-374004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-374005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-374006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-374007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-374008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-374009r380"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.2</span> <a 
 id="x1-3750002"></a>Session operation: MAC session</h6>
The fixed-length and the variable-length parameters of MAC session requests are as
follows:
<!--l. 497-->
<div class="lstlisting" id="listing-105"><span class="label"><a 
 id="x1-375001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_create_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375011r11"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375013r13"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_create_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-375018r18"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 518--><p class="noindent" >The length of <span 
class="aeti-10">auth_key </span>is specified in <span 
class="aeti-10">auth_key_len </span>in the struct
virtio_crypto_mac_create_session_flf.
<a 
 id="x1-375019r381"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.3</span> <a 
 id="x1-3760003"></a>Session operation: Symmetric algorithms session</h6>
The request of symmetric session could be the CIPHER algorithms request or the
chain algorithms (chaining CIPHER and HASH/MAC) request.
<!--l. 528--><p class="noindent" >The fixed-length and the variable-length parameters of CIPHER session requests are
as follows:
<!--l. 530-->
<div class="lstlisting" id="listing-106"><span class="label"><a 
 id="x1-376001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_ENCRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_DECRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">encryption</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">decryption</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376013r13"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376015r15"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376020r20"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 553--><p class="noindent" >The length of <span 
class="aeti-10">cipher_key </span>is specified in <span 
class="aeti-10">key_len </span>in the struct virtio_crypto_cipher_session_flf.
                                                                  

                                                                  
<!--l. 556--><p class="noindent" >The fixed-length and the variable-length parameters of Chain session requests are as
follows:
<!--l. 558-->
<div class="lstlisting" id="listing-107"><span class="label"><a 
 id="x1-376021r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376022r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376023r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376024r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376025r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376026r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alg_chain_order</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376027r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Plain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376028r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_HASH_MODE_PLAIN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376029r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">mac</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376030r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_HASH_MODE_AUTH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376031r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Nested</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376032r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_HASH_MODE_NESTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376033r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_mode</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376034r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376035r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376036r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_ALG_CHAIN_SESS_OP_SPEC_HDR_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376037r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fixed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376038r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_ALG_CHAIN_SESS_OP_SPEC_HDR_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376039r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376040r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">AAD</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376041r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376042r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376043r23"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376044r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376045r25"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376046r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376047r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376048r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376049r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376050r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376051r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376052r32"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 593--><p class="noindent" ><span 
class="aeti-10">hash_mode </span>decides the type used by <span 
class="aeti-10">algo_flf</span>.
<!--l. 595--><p class="noindent" ><span 
class="aeti-10">algo_flf  </span>is fixed to 16 bytes and MUST contains or be one of the following
types:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_hash_create_session_flf
    </li>
    <li class="itemize">struct virtio_crypto_mac_create_session_flf</li></ul>
<!--l. 601--><p class="nopar" >The data of unused part (if has) in <span 
class="aeti-10">algo_flf  </span>will be ignored.
<!--l. 603--><p class="noindent" >The length of <span 
class="aeti-10">cipher_key </span>is specified in <span 
class="aeti-10">key_len </span>in <span 
class="aeti-10">cipher_hdr</span>.
<!--l. 605--><p class="noindent" >The length of <span 
class="aeti-10">auth_key </span>is specified in <span 
class="aeti-10">auth_key_len </span>in struct virtio_crypto_mac_create_session_flf.
<!--l. 608--><p class="noindent" >The fixed-length parameters of Symmetric session requests are as follows:
<!--l. 610-->
<div class="lstlisting" id="listing-108"><span class="label"><a 
 id="x1-376053r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_create_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376054r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376055r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376056r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_SESS_OP_SPEC_HDR_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">48</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376057r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fixed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376058r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_SESS_OP_SPEC_HDR_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376059r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376060r8"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">No</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376061r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376062r10"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376063r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376064r12"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">any</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">any</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">order</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376065r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">depends</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alg_chain_order</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">param</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376066r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_ALGORITHM_CHAINING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376067r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376068r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376069r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 630--><p class="noindent" ><span 
class="aeti-10">op_flf  </span>is fixed to 48 bytes, MUST contains or be one of the following types:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_session_flf
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_session_flf</li></ul>
<!--l. 636--><p class="nopar" >The data of unused part (if has) in <span 
class="aeti-10">op_flf  </span>will be ignored.
<!--l. 638--><p class="noindent" ><span 
class="aeti-10">op_type </span>decides the type used by <span 
class="aeti-10">op_flf</span>.
<!--l. 640--><p class="noindent" >The variable-length parameters of Symmetric session requests are as follows:
<!--l. 642-->
<div class="lstlisting" id="listing-109"><span class="label"><a 
 id="x1-376070r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_create_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376071r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376072r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">variable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376073r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vlf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376074r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 650--><p class="noindent" ><span 
class="aeti-10">op_vlf  </span>MUST contains or be one of the following types:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_session_vlf
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_session_vlf</li></ul>
<!--l. 656--><p class="noindent" ><span 
class="aeti-10">op_type </span>in struct virtio_crypto_sym_create_session_flf decides the type used by
<span 
class="aeti-10">op_vlf</span>.
<!--l. 659--><p class="noindent" ><span 
class="aeti-10">vlf_len </span>is the size of the specific structure used.
<a 
 id="x1-376075r382"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.4</span> <a 
 id="x1-3770004"></a>Session operation: AEAD session</h6>
The fixed-length and the variable-length parameters of AEAD session requests are as
follows:
<!--l. 667-->
<div class="lstlisting" id="listing-110"><span class="label"><a 
 id="x1-377001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_create_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authentication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">AAD</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">encryption</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">decryption</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377015r15"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377017r17"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_create_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-377020r20"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 690--><p class="noindent" >The length of <span 
class="aeti-10">key </span>is specified in <span 
class="aeti-10">key_len </span>in struct virtio_crypto_aead_create_session_flf.
<a 
 id="x1-377021r383"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.5</span> <a 
 id="x1-3780005"></a>Driver Requirements: Session operation: create session</h6>
    <ul class="itemize1">
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">opcode </span>field based on service type: CIPHER,
    HASH, MAC, or AEAD.
    </li>
    <li class="itemize">The  driver  MUST  set  the  control  general  header,  the  opcode  specific
    header,  the  opcode  specific  extra  parameters  and  the  opcode  specific
    outcome buffer in turn. See <a 
href="#x1-3720002">5.9.7.2<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue --></a>.
    </li>
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">reversed </span>field to zero.</li></ul>
<a 
 id="x1-378001r384"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.6</span> <a 
 id="x1-3790006"></a>Device Requirements: Session operation: create session</h6>
    <ul class="itemize1">
    <li class="itemize">The  device  MUST  use  the  corresponding  opcode  specific  structure
    according to the <span 
class="aeti-10">opcode </span>in the control general header.
    </li>
    <li class="itemize">The device MUST extract extra parameters according to the structures
    used.
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>field to one of the following values of enum
                                                                  

                                                                  
    VIRTIO_CRYPTO_STATUS after finish a session creation:
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if a session is created successfully.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOSPC  if  no  free  session  ID  (only  when  the
        VIRTIO_CRYPTO_F_REVISION_1 feature bit is negotiated).
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if failure not mentioned above occurs.</li></ul>
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">session_id </span>field to a unique session identifier only if
    the status is set to VIRTIO_CRYPTO_OK.</li></ul>
<a 
 id="x1-379001r385"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.7</span> <a 
 id="x1-3800007"></a>Driver Requirements: Session operation: destroy session</h6>
    <ul class="itemize1">
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">opcode </span>field based on service type: CIPHER,
    HASH, MAC, or AEAD.
    </li>
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">session_id </span>to a valid value assigned by the device
    when the session was created.</li></ul>
<a 
 id="x1-380001r386"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.8</span> <a 
 id="x1-3810008"></a>Device Requirements: Session operation: destroy session</h6>
    <ul class="itemize1">
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>field to one of the following values of enum
    VIRTIO_CRYPTO_STATUS.
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if a session is created successfully.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if any failure occurs.</li></ul>
    </li></ul>
<a 
 id="x1-381001r378"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.3   </span> <a 
 id="x1-3820003"></a>Data Virtqueue</h5>
<!--l. 748--><p class="nopar" >The driver uses the data virtqueues to transmit crypto operation requests to the
device, and completes the crypto operations.
<!--l. 751--><p class="noindent" >The header for dataq is as follows:
<!--l. 753-->
<div class="lstlisting" id="listing-111"><span class="label"><a 
 id="x1-382001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_op_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_ENCRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_DECRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_HASH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_MAC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_ENCRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_DECRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">\</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algorithms</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">session_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382018r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_FLAG_SESSION_MODE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flag</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flag</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382022r22"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<span 
class="aebx-10">Note:</span> If  VIRTIO_CRYPTO_F_REVISION_1  is  not  negotiated  the  <span 
class="aeti-10">flag  </span>is
      ignored.
      <!--l. 781--><p class="noindent" >If          VIRTIO_CRYPTO_F_REVISION_1          is          negotiated
      but  VIRTIO_CRYPTO_F_<SERVICE>_STATELESS_MODE  is  not
      negotiated, then the device SHOULD reject <SERVICE> requests if
      VIRTIO_CRYPTO_FLAG_SESSION_MODE is not set (in <span 
class="aeti-10">flag</span>).
<!--l. 786--><p class="noindent" >The dataq request is composed of four parts: <!--l. 787-->
<div class="lstlisting" id="listing-112"><span class="label"><a 
 id="x1-382023r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_op_data_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382024r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382025r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382026r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_op_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382027r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382028r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_DATAQ_OP_SPEC_HDR_LEGACY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">48</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382029r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fixed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382030r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">flf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382031r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382032r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382033r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">variable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382034r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vlf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382035r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382036r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382037r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_inhdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inhdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382038r16"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 806--><p class="noindent" ><span 
class="aeti-10">header </span>is a general header (see above).
<!--l. 808--><p class="noindent" ><span 
class="aeti-10">op_flf  </span>is the opcode (in <span 
class="aeti-10">header</span>) specific header.
<!--l. 810--><p class="noindent" ><span 
class="aeti-10">flf_len </span>depends on the VIRTIO_CRYPTO_F_REVISION_1 feature bit (see
below).
<!--l. 813--><p class="noindent" ><span 
class="aeti-10">op_vlf  </span>is the opcode (in <span 
class="aeti-10">header</span>) specific parameters.
<!--l. 815--><p class="noindent" ><span 
class="aeti-10">vlf_len </span>is the size of the specific structure used.
    <ul class="itemize1">
    <li class="itemize">If the the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_CIPHER_ENCRYPT or
    VIRTIO_CRYPTO_CIPHER_DECRYPT then:
        <ul class="itemize2">
        <li class="itemize">If VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE is negotiated,
        <span 
class="aeti-10">op_flf </span>is struct virtio_crypto_sym_data_flf_stateless, and <span 
class="aeti-10">op_vlf </span>is struct
        virtio_crypto_sym_data_vlf_stateless.
        </li>
        <li class="itemize">If                   VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE
        is   NOT   negotiated,   <span 
class="aeti-10">op_flf   </span>is   struct   virtio_crypto_sym_data_flf
        if   VIRTIO_CRYPTO_F_REVISION_1   is   negotiated   and   struct
        virtio_crypto_sym_data_flf is padded to 48 bytes if NOT negotiated,
        and <span 
class="aeti-10">op_vlf  </span>is struct virtio_crypto_sym_data_vlf.</li></ul>
    </li>
    <li class="itemize">If the the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_HASH:
        <ul class="itemize2">
        <li class="itemize">If  VIRTIO_CRYPTO_F_HASH_STATELESS_MODE  is  negotiated,
        <span 
class="aeti-10">op_flf  </span>is  struct  virtio_crypto_hash_data_flf_stateless,  and  <span 
class="aeti-10">op_vlf  </span>is
        struct virtio_crypto_hash_data_vlf_stateless.
                                                                  

                                                                  
        </li>
        <li class="itemize">If                       VIRTIO_CRYPTO_F_HASH_STATELESS_MODE
        is   NOT   negotiated,   <span 
class="aeti-10">op_flf   </span>is   struct   virtio_crypto_hash_data_flf
        if   VIRTIO_CRYPTO_F_REVISION_1   is   negotiated   and   struct
        virtio_crypto_hash_data_flf is padded to 48 bytes if NOT negotiated,
        and <span 
class="aeti-10">op_vlf  </span>is struct virtio_crypto_hash_data_vlf.</li></ul>
    </li>
    <li class="itemize">If the the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_MAC:
        <ul class="itemize2">
        <li class="itemize">If   VIRTIO_CRYPTO_F_MAC_STATELESS_MODE   is   negotiated,
        <span 
class="aeti-10">op_flf   </span>is  struct  virtio_crypto_mac_data_flf_stateless,  and  <span 
class="aeti-10">op_vlf   </span>is
        struct virtio_crypto_mac_data_vlf_stateless.
        </li>
        <li class="itemize">If                        VIRTIO_CRYPTO_F_MAC_STATELESS_MODE
        is   NOT   negotiated,   <span 
class="aeti-10">op_flf   </span>is   struct   virtio_crypto_mac_data_flf
        if   VIRTIO_CRYPTO_F_REVISION_1   is   negotiated   and   struct
        virtio_crypto_mac_data_flf is padded to 48 bytes if NOT negotiated,
        and <span 
class="aeti-10">op_vlf  </span>is struct virtio_crypto_mac_data_vlf.</li></ul>
    </li>
    <li class="itemize">If the the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_AEAD_ENCRYPT or
    VIRTIO_CRYPTO_AEAD_DECRYPT then:
        <ul class="itemize2">
        <li class="itemize">If  VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE  is  negotiated,
        <span 
class="aeti-10">op_flf  </span>is  struct  virtio_crypto_aead_data_flf_stateless,  and  <span 
class="aeti-10">op_vlf  </span>is
        struct virtio_crypto_aead_data_vlf_stateless.
        </li>
        <li class="itemize">If                      VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE
        is   NOT   negotiated,   <span 
class="aeti-10">op_flf   </span>is   struct   virtio_crypto_aead_data_flf
        if   VIRTIO_CRYPTO_F_REVISION_1   is   negotiated   and   struct
        virtio_crypto_aead_data_flf is padded to 48 bytes if NOT negotiated,
        and <span 
class="aeti-10">op_vlf  </span>is struct virtio_crypto_aead_data_vlf.</li></ul>
    </li></ul>
<!--l. 862--><p class="noindent" ><span 
class="aeti-10">inhdr </span>is a unified input header that used to return the status of the operations, is
defined as follows:
<!--l. 865-->
<div class="lstlisting" id="listing-113"><span class="label"><a 
 id="x1-382039r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_inhdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382040r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-382041r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-382042r388"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.4   </span> <a 
 id="x1-3830004"></a>HASH Service Operation</h5>
<!--l. 873--><p class="nopar" >Session mode HASH service requests are as follows:
<!--l. 875-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-114"><span class="label"><a 
 id="x1-383001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383008r8"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383016r16"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 894--><p class="noindent" >Each data request uses the virtio_crypto_hash_data_flf structure and the
virtio_crypto_hash_data_vlf structure to store information used to run the HASH
operations.
<!--l. 898--><p class="noindent" ><span 
class="aeti-10">src_data </span>is the source data that will be processed. <span 
class="aeti-10">src_data_len </span>is the length of
source data. <span 
class="aeti-10">hash_result </span>is the result data and <span 
class="aeti-10">hash_result_len </span>is the length of
it.
<!--l. 903--><p class="noindent" >Stateless mode HASH service requests are as follows:
<!--l. 905-->
<div class="lstlisting" id="listing-115"><span class="label"><a 
 id="x1-383017r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383018r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383019r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383020r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383021r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383022r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383023r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383024r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383025r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383026r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383027r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383028r12"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383029r13"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383030r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383031r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383032r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383033r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383034r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383035r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383036r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-383037r21"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-383038r379"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.4.1</span> <a 
 id="x1-3840001"></a>Driver Requirements: HASH Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the driver uses the session mode, then the driver MUST set <span 
class="aeti-10">session_id</span>
    in struct virtio_crypto_op_header to a valid value assigned by the device
    when the session was created.
    </li>
    <li class="itemize">If  the  VIRTIO_CRYPTO_F_HASH_STATELESS_MODE  feature  bit  is
    negotiated, 1) if the driver uses the stateless mode, then the driver MUST
    set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header to ZERO and MUST set
    the fields in struct virtio_crypto_hash_data_flf_stateless.sess_para, 2) if the
    driver                uses                the                session                mode,
    then the driver MUST set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header
    to VIRTIO_CRYPTO_FLAG_SESSION_MODE.
    </li>
    <li class="itemize">The  driver  MUST  set  <span 
class="aeti-10">opcode  </span>in  struct  virtio_crypto_op_header  to
    VIRTIO_CRYPTO_HASH.</li></ul>
<a 
 id="x1-384001r390"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.4.2</span> <a 
 id="x1-3850002"></a>Device Requirements: HASH Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">The device MUST use the corresponding structure according to the <span 
class="aeti-10">opcode</span>
    in the data general header.
    </li>
    <li class="itemize">If            the            VIRTIO_CRYPTO_F_HASH_STATELESS_MODE
                                                                  

                                                                  
    feature  bit  is  negotiated,  the  device  MUST  parse  <span 
class="aeti-10">flag  </span>field  in  struct
    virtio_crypto_op_header in order to decide which mode the driver uses.
    </li>
    <li class="itemize">The device MUST copy the results of HASH operations in the hash_result[]
    if HASH operations success.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">status </span>in struct virtio_crypto_inhdr to one of the following
    values of enum VIRTIO_CRYPTO_STATUS:
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if the operation success.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_INVSESS if the session ID invalid when in session
        mode.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if any failure not mentioned above occurs.</li></ul>
    </li></ul>
<a 
 id="x1-385001r389"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.5   </span> <a 
 id="x1-3860005"></a>MAC Service Operation</h5>
<!--l. 967--><p class="nopar" >Session mode MAC service requests are as follows:
<!--l. 969-->
<div class="lstlisting" id="listing-116"><span class="label"><a 
 id="x1-386001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386005r5"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386013r13"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 985--><p class="noindent" >Each request uses the virtio_crypto_mac_data_flf structure and the
virtio_crypto_mac_data_vlf structure to store information used to run the MAC
operations.
<!--l. 989--><p class="noindent" ><span 
class="aeti-10">src_data </span>is the source data that will be processed. <span 
class="aeti-10">src_data_len </span>is the length of
source data. <span 
class="aeti-10">hash_result </span>is the result data and <span 
class="aeti-10">hash_result_len </span>is the length of
it.
<!--l. 994--><p class="noindent" >Stateless mode MAC service requests are as follows:
<!--l. 996-->
<div class="lstlisting" id="listing-117"><span class="label"><a 
 id="x1-386014r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386015r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386016r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386017r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386018r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386019r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386020r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386021r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386022r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386023r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386024r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386025r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386026r13"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386027r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386028r15"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386029r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386030r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386031r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386032r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386033r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386034r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386035r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386036r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386037r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386038r25"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1024--><p class="noindent" ><span 
class="aeti-10">auth_key </span>is the authenticated key that will be used during the process. <span 
class="aeti-10">auth_key_len</span>
is the length of the key.
                                                                  

                                                                  
<a 
 id="x1-386039r391"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.5.1</span> <a 
 id="x1-3870001"></a>Driver Requirements: MAC Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the driver uses the session mode, then the driver MUST set <span 
class="aeti-10">session_id</span>
    in struct virtio_crypto_op_header to a valid value assigned by the device
    when the session was created.
    </li>
    <li class="itemize">If  the  VIRTIO_CRYPTO_F_MAC_STATELESS_MODE  feature  bit  is
    negotiated, 1) if the driver uses the stateless mode, then the driver MUST
    set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header to ZERO and MUST set
    the fields in struct virtio_crypto_mac_data_flf_stateless.sess_para, 2) if the
    driver                uses                the                session                mode,
    then the driver MUST set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header
    to VIRTIO_CRYPTO_FLAG_SESSION_MODE.
    </li>
    <li class="itemize">The  driver  MUST  set  <span 
class="aeti-10">opcode  </span>in  struct  virtio_crypto_op_header  to
    VIRTIO_CRYPTO_MAC.</li></ul>
<a 
 id="x1-387001r393"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.5.2</span> <a 
 id="x1-3880002"></a>Device Requirements: MAC Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If             the             VIRTIO_CRYPTO_F_MAC_STATELESS_MODE
    feature  bit  is  negotiated,  the  device  MUST  parse  <span 
class="aeti-10">flag  </span>field  in  struct
    virtio_crypto_op_header in order to decide which mode the driver uses.
    </li>
    <li class="itemize">The device MUST copy the results of MAC operations in the hash_result[]
    if HASH operations success.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">status </span>in struct virtio_crypto_inhdr to one of the following
    values of enum VIRTIO_CRYPTO_STATUS:
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if the operation success.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_INVSESS if the session ID invalid when in session
        mode.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if any failure not mentioned above occurs.</li></ul>
    </li></ul>
<a 
 id="x1-388001r392"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.6   </span> <a 
 id="x1-3890006"></a>Symmetric algorithms Operation</h5>
<!--l. 1062--><p class="nopar" >Session mode CIPHER service requests are as follows:
<!--l. 1064-->
<div class="lstlisting" id="listing-118"><span class="label"><a 
 id="x1-389001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pointed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">below</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ciphers</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Kasumi</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SNOW3G</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">UEA2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">same</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ciphers</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CTR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">counter</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">same</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389019r19"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ciphers</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Kasumi</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SNOW3G</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">UEA2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ciphers</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CTR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">counter</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AES</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">XTS</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">128</span><span 
class="pcrr8t-x-x-80">bit</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tweak</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">i</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IEEE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Std</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1619-2007.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">updated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">every</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">partial</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cryptographic</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389041r41"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1108--><p class="noindent" >Session mode requests of algorithm chaining are as follows:
<!--l. 1110-->
<div class="lstlisting" id="listing-119"><span class="label"><a 
 id="x1-389042r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389043r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389044r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389045r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389046r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389047r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389048r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">point</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389049r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_start_src_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389050r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">computed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389051r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len_to_cipher</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389052r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">point</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389053r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_start_src_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389054r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">computed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389055r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len_to_hash</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389056r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389057r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389058r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389059r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389060r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389061r20"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389062r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389063r22"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389064r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389065r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389066r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389067r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389068r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389069r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389070r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">exists</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389071r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389072r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389073r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389074r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389075r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389076r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389077r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389078r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389079r38"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1151--><p class="noindent" >Session mode requests of symmetric algorithm are as follows:
<!--l. 1153-->
<div class="lstlisting" id="listing-120"><span class="label"><a 
 id="x1-389080r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389081r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389082r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389083r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_DATA_REQ_HDR_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">40</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389084r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_DATA_REQ_HDR_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389085r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389086r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389087r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389088r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389089r10"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389090r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389091r12"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389092r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sym_para_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389093r14"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1170--><p class="noindent" >Each request uses the virtio_crypto_sym_data_flf structure and the
virtio_crypto_sym_data_flf structure to store information used to run the CIPHER
operations.
<!--l. 1174--><p class="noindent" ><span 
class="aeti-10">op_type_flf  </span>is the <span 
class="aeti-10">op_type </span>specific header, it MUST starts with or be one of the
following structures:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_data_flf
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_data_flf</li></ul>
<!--l. 1181--><p class="noindent" >The length of <span 
class="aeti-10">op_type_flf </span>is fixed to 40 bytes, the data of unused part (if has) will be
ingored.
<!--l. 1184--><p class="noindent" ><span 
class="aeti-10">op_type_vlf </span>is the <span 
class="aeti-10">op_type </span>specific parameters, it MUST starts with or be one of the
following structures:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_data_vlf
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_data_vlf</li></ul>
<!--l. 1191--><p class="noindent" ><span 
class="aeti-10">sym_para_len </span>is the size of the specific structure used.
<!--l. 1193--><p class="noindent" >Stateless mode CIPHER service requests are as follows:
                                                                  

                                                                  
<!--l. 1195-->
<div class="lstlisting" id="listing-121"><span class="label"><a 
 id="x1-389094r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389095r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389096r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389097r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389098r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389099r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389100r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389101r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389102r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389103r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389104r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389105r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389106r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pointed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">below</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389107r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389108r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389109r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389110r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389111r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389112r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389113r20"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389114r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389115r22"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389116r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389117r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389118r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389119r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389120r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389121r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389122r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389123r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389124r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389125r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389126r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389127r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389128r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389129r36"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1234--><p class="noindent" >Stateless mode requests of algorithm chaining are as follows:
<!--l. 1236-->
<div class="lstlisting" id="listing-122"><span class="label"><a 
 id="x1-389130r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389131r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389132r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_ALG_CHAIN_ORDER_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389133r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alg_chain_order</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389134r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389135r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389136r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389137r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389138r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389139r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389140r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389141r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389142r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389143r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389144r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389145r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389146r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389147r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389148r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389149r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389150r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389151r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_HASH_MODE_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389152r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_mode</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389153r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389154r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389155r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389156r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389157r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389158r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389159r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389160r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389161r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">point</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389162r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_start_src_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389163r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">computed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389164r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len_to_cipher</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389165r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">point</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389166r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_start_src_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389167r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">computed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389168r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len_to_hash</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389169r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389170r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389171r42"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389172r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389173r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389174r45"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389175r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389176r47"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389177r48"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389178r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389179r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389180r51"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389181r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389182r53"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389183r54"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389184r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389185r56"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">exists</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389186r57"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389187r58"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389188r59"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389189r60"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389190r61"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389191r62"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389192r63"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389193r64"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389194r65"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389195r66"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389196r67"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1306--><p class="noindent" >Stateless mode requests of symmetric algorithm are as follows:
<!--l. 1308-->
<div class="lstlisting" id="listing-123"><span class="label"><a 
 id="x1-389197r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389198r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389199r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_DATE_REQ_HDR_STATELESS_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">72</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389200r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_DATE_REQ_HDR_STATELESS_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389201r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389202r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389203r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389204r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389205r9"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389206r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389207r11"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389208r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sym_para_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-389209r13"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1324--><p class="noindent" ><span 
class="aeti-10">op_type_flf  </span>is the <span 
class="aeti-10">op_type </span>specific header, it MUST starts with or be one of the
following structures:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_data_flf_stateless
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_data_flf_stateless</li></ul>
<!--l. 1331--><p class="noindent" >The length of <span 
class="aeti-10">op_type_flf </span>is fixed to 72 bytes, the data of unused part (if has) will be
ingored.
<!--l. 1334--><p class="noindent" ><span 
class="aeti-10">op_type_vlf </span>is the <span 
class="aeti-10">op_type </span>specific parameters, it MUST starts with or be one of the
following structures:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_data_vlf_stateless
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_data_vlf_stateless</li></ul>
<!--l. 1341--><p class="noindent" ><span 
class="aeti-10">sym_para_len </span>is the size of the specific structure used.
<a 
 id="x1-389210r394"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.6.1</span> <a 
 id="x1-3900001"></a>Driver Requirements: Symmetric algorithms Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the driver uses the session mode, then the driver MUST set <span 
class="aeti-10">session_id</span>
    in struct virtio_crypto_op_header to a valid value assigned by the device
    when the session was created.
                                                                  

                                                                  
    </li>
    <li class="itemize">If the VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE feature bit is
    negotiated, 1) if the driver uses the stateless mode, then the driver MUST
    set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header to ZERO and MUST
    set the fields in struct virtio_crypto_cipher_data_flf_stateless.sess_para or
    struct virtio_crypto_alg_chain_data_flf_stateless.sess_para, 2) if the driver
    uses the session mode, then the driver MUST set the <span 
class="aeti-10">flag </span>field in struct
    virtio_crypto_op_header to VIRTIO_CRYPTO_FLAG_SESSION_MODE.
    </li>
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">opcode </span>field in struct virtio_crypto_op_header to
    VIRTIO_CRYPTO_CIPHER_ENCRYPT                                        or
    VIRTIO_CRYPTO_CIPHER_DECRYPT.
    </li>
    <li class="itemize">The driver MUST specify the fields of struct virtio_crypto_cipher_data_flf in
    struct virtio_crypto_sym_data_flf and struct virtio_crypto_cipher_data_vlf
    in   struct   virtio_crypto_sym_data_vlf   if   the   request   is   based   on
    VIRTIO_CRYPTO_SYM_OP_CIPHER.
    </li>
    <li class="itemize">The         driver         MUST         specify         the         fields         of
    struct virtio_crypto_alg_chain_data_flf in struct virtio_crypto_sym_data_flf
    and                                                                                    struct
    virtio_crypto_alg_chain_data_vlf in struct virtio_crypto_sym_data_vlf if the
    request is of the VIRTIO_CRYPTO_SYM_OP_ALGORITHM_CHAINING
    type.</li></ul>
<a 
 id="x1-390001r396"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.6.2</span> <a 
 id="x1-3910002"></a>Device Requirements: Symmetric algorithms Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE feature bit is
    negotiated,              the              device              MUST              parse
    <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header in order to decide which mode
    the driver uses.
    </li>
    <li class="itemize">The  device  MUST  parse  the  virtio_crypto_sym_data_req  based  on  the
    <span 
class="aeti-10">opcode </span>field in general header.
    </li>
    <li class="itemize">The device MUST parse the fields of struct virtio_crypto_cipher_data_flf in
    struct virtio_crypto_sym_data_flf and struct virtio_crypto_cipher_data_vlf
    in   struct   virtio_crypto_sym_data_vlf   if   the   request   is   based   on
    VIRTIO_CRYPTO_SYM_OP_CIPHER.
    </li>
    <li class="itemize">The device MUST parse the fields of struct virtio_crypto_alg_chain_data_flf
    in          struct          virtio_crypto_sym_data_flf          and          struct
    virtio_crypto_alg_chain_data_vlf in struct virtio_crypto_sym_data_vlf if the
    request is of the VIRTIO_CRYPTO_SYM_OP_ALGORITHM_CHAINING
                                                                  

                                                                  
    type.
    </li>
    <li class="itemize">The  device  MUST  copy  the  result  of  cryptographic  operation  in  the
    dst_data[] in both plain CIPHER mode and algorithms chain mode.
    </li>
    <li class="itemize">The device MUST check the <span 
class="aeti-10">para</span>.<span 
class="aeti-10">add_len </span>is bigger than 0 before parse the
    additional authenticated data in plain algorithms chain mode.
    </li>
    <li class="itemize">The                                                                                    device
    MUST copy the result of HASH/MAC operation in the hash_result[] is of
    the VIRTIO_CRYPTO_SYM_OP_ALGORITHM_CHAINING type.
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>field in struct virtio_crypto_inhdr to one of the
    following values of enum VIRTIO_CRYPTO_STATUS:
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if the operation success.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_INVSESS  if  the  session  ID  is  invalid  in  session
        mode.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if failure not mentioned above occurs.</li></ul>
    </li></ul>
<a 
 id="x1-391001r395"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.7   </span> <a 
 id="x1-3920007"></a>AEAD Service Operation</h5>
<!--l. 1400--><p class="nopar" >Session mode requests of symmetric algorithm are as follows:
<!--l. 1402-->
<div class="lstlisting" id="listing-124"><span class="label"><a 
 id="x1-392001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">either</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">96-</span><span 
class="pcrr8t-x-x-80">bit</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IVs</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">case</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">points</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">J0</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nonce</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">can</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">range</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">13</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inclusive</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">least</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authentication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392020r20"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392022r22"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">either</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">96</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">J0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">other</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizes</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">where</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">J0</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">defined</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NIST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SP800</span><span 
class="pcrr8t-x-x-80">-38</span><span 
class="pcrr8t-x-x-80">D</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Regardless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">full</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">needs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">allocated</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nonce</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[1]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">allow</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">space</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">implementation</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">byte</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">full</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">allocated</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">even</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">though</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">have</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">less</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">than</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">updated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">every</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">partial</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cryptographic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392042r42"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">exists</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392044r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392045r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392046r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Pointer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">output</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392048r48"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1453--><p class="noindent" >Each request uses the virtio_crypto_aead_data_flf structure and the
virtio_crypto_aead_data_flf structure to store information used to run the AEAD
operations.
<!--l. 1457--><p class="noindent" >Stateless mode AEAD service requests are as follows:
<!--l. 1459-->
<div class="lstlisting" id="listing-125"><span class="label"><a 
 id="x1-392049r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392050r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392051r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392052r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392053r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392054r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392055r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">encrypt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">decrypt</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392056r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392057r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392058r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392059r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392060r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392061r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authentication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392062r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392063r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392064r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392065r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392066r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392067r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">least</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392068r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392069r21"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392070r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392071r23"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392072r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392073r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392074r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392075r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392076r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392077r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392078r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392079r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392080r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">exists</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392081r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392082r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392083r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392084r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Pointer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">output</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392085r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-392086r38"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
                                                                  

                                                                  
<a 
 id="x1-392087r397"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.7.1</span> <a 
 id="x1-3930001"></a>Driver Requirements: AEAD Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the driver uses the session mode, then the driver MUST set <span 
class="aeti-10">session_id</span>
    in struct virtio_crypto_op_header to a valid value assigned by the device
    when the session was created.
    </li>
    <li class="itemize">If  the  VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE  feature  bit  is
    negotiated, 1) if the driver uses the stateless mode, then the driver MUST
    set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header to ZERO and MUST set
    the fields in struct virtio_crypto_aead_data_flf_stateless.sess_para, 2) if the
    driver                uses                the                session                mode,
    then the driver MUST set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header
    to VIRTIO_CRYPTO_FLAG_SESSION_MODE.
    </li>
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">opcode </span>field in struct virtio_crypto_op_header to
    VIRTIO_CRYPTO_AEAD_ENCRYPT                                           or
    VIRTIO_CRYPTO_AEAD_DECRYPT.</li></ul>
<a 
 id="x1-393001r399"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.7.2</span> <a 
 id="x1-3940002"></a>Device Requirements: AEAD Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If  the  VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE  feature  bit  is
    negotiated,                                                                              the
    device MUST parse the virtio_crypto_aead_data_vlf_stateless based on the
    <span 
class="aeti-10">opcode </span>field in general header.
    </li>
    <li class="itemize">The  device  MUST  copy  the  result  of  cryptographic  operation  in  the
    dst_data[].
    </li>
    <li class="itemize">The device MUST copy the authentication tag in the dst_data[] offset the
    cipher result.
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>field in struct virtio_crypto_inhdr to one
    of the following values of enum VIRTIO_CRYPTO_STATUS:
    </li>
    <li class="itemize">When the <span 
class="aeti-10">opcode </span>field is VIRTIO_CRYPTO_AEAD_DECRYPT, the device
    MUST verify and return the verification result to the driver.
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if the operation success.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
                                                                  

                                                                  
        </li>
        <li class="itemize">VIRTIO_CRYPTO_BADMSG if the verification result is incorrect.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_INVSESS if the session ID invalid when in session
        mode.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if any failure not mentioned above occurs.</li></ul>
    </li></ul>
<a 
 id="x1-394001r361"></a>
<h3 class="sectionHead"><span class="titlemark">5.10   </span> <a 
 id="x1-39500010"></a>Socket Device</h3>
<!--l. 3--><p class="nopar" >The virtio socket device is a zero-configuration socket communications device. It
facilitates data transfer between the guest and device without using the Ethernet or
IP protocols.
<a 
 id="x1-395001r376"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.1   </span> <a 
 id="x1-3960001"></a>Device ID</h4>
<!--l. 8--><p class="nopar" >19
<a 
 id="x1-396001r402"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.2   </span> <a 
 id="x1-3970002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">rx
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">tx
    </dd><dt class="description">
<span 
class="aebx-10">2</span> </dt><dd 
class="description">event</dd></dl>
<a 
 id="x1-397001r403"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.3   </span> <a 
 id="x1-3980003"></a>Feature bits</h4>
<!--l. 19--><p class="nopar" >There are currently no feature bits defined for this device.
<a 
 id="x1-398001r404"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.4   </span> <a 
 id="x1-3990004"></a>Device configuration layout</h4>
<!--l. 23--><p class="nopar" >Socket device configuration uses the following layout structure:
<!--l. 25-->
<div class="lstlisting" id="listing-126"><span class="label"><a 
 id="x1-399001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-399002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">guest_cid</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-399003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
                                                                  

                                                                  
<!--l. 31--><p class="noindent" >The <span 
class="aeti-10">guest_cid </span>field contains the guest’s context ID, which uniquely identifies
the device for its lifetime. The upper 32 bits of the CID are reserved and
zeroed.
<!--l. 35--><p class="noindent" >The following CIDs are reserved and cannot be used as the guest’s context
ID:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > CID             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Notes                                 </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Reserved</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1                 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved                            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2                 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Well-known CID for the host  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0xffffffff         </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved                            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0xffffffffffffffff  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved                            </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<a 
 id="x1-399004r405"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.5   </span> <a 
 id="x1-4000005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-400002x1">The guest’s cid is read from <span 
class="aeti-10">guest_cid</span>.
    </li>
    <li 
  class="enumerate" id="x1-400004x2">Buffers are added to the event virtqueue to receive events from the device.
    </li>
    <li 
  class="enumerate" id="x1-400006x3">Buffers are added to the rx virtqueue to start receiving packets.</li></ol>
<a 
 id="x1-400007r406"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.6   </span> <a 
 id="x1-4010006"></a>Device Operation</h4>
<!--l. 65--><p class="nopar" >Packets transmitted or received contain a header before the payload:
<!--l. 67-->
<div class="lstlisting" id="listing-127"><span class="label"><a 
 id="x1-401001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_cid</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_cid</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_port</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_port</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buf_alloc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fwd_cnt</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401012r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 82--><p class="noindent" >The upper 32 bits of src_cid and dst_cid are reserved and zeroed.
<!--l. 84--><p class="noindent" >Most packets simply transfer data but control packets are also used for connection
and buffer space management. <span 
class="aeti-10">op </span>is one of the following operation constants:
<!--l. 88-->
<div class="lstlisting" id="listing-128"><span class="label"><a 
 id="x1-401013r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401014r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_INVALID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401015r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401016r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Connect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operations</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401017r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_REQUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401018r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_RESPONSE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401019r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_RST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401020r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_SHUTDOWN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401021r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401022r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">To</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">send</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">payload</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401023r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_RW</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401024r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401025r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Tell</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">our</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">credit</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401026r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_CREDIT_UPDATE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401027r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">send</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">credit</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">us</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401028r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_CREDIT_REQUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-401029r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-401030r398"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.1   </span> <a 
 id="x1-4020001"></a>Virtqueue Flow Control</h5>
<!--l. 110--><p class="nopar" >The tx virtqueue carries packets initiated by applications and replies to received
packets. The rx virtqueue carries packets initiated by the device and replies to
                                                                  

                                                                  
previously transmitted packets.
<!--l. 114--><p class="noindent" >If both rx and tx virtqueues are filled by the driver and device at the same time then
it appears that a deadlock is reached. The driver has no free tx descriptors to send
replies. The device has no free rx descriptors to send replies either. Therefore neither
device nor driver can process virtqueues since that may involve sending new
replies.
<!--l. 120--><p class="noindent" >This is solved using additional resources outside the virtqueue to hold packets. With
additional resources, it becomes possible to process incoming packets even when
outgoing packets cannot be sent.
<!--l. 124--><p class="noindent" >Eventually even the additional resources will be exhausted and further processing is
not possible until the other side processes the virtqueue that it has neglected. This
stop to processing prevents one side from causing unbounded resource consumption
in the other side.
<a 
 id="x1-402001r400"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.1.1</span> <a 
 id="x1-4030001"></a>Driver Requirements: Device Operation: Virtqueue Flow Control</h5>
The rx virtqueue MUST be processed even when the tx virtqueue is full so long
as there are additional resources available to hold packets outside the tx
virtqueue.
<a 
 id="x1-403001r409"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.1.2</span> <a 
 id="x1-4040002"></a>Device Requirements: Device Operation: Virtqueue Flow Control</h5>
The tx virtqueue MUST be processed even when the rx virtqueue is full so long
as there are additional resources available to hold packets outside the rx
virtqueue.
<a 
 id="x1-404001r408"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.2   </span> <a 
 id="x1-4050002"></a>Addressing</h5>
<!--l. 139--><p class="nopar" >Flows are identified by a (source, destination) address tuple. An address consists of a
(cid, port number) tuple. The header fields used for this are <span 
class="aeti-10">src_cid</span>, <span 
class="aeti-10">src_port</span>, <span 
class="aeti-10">dst_cid</span>,
and <span 
class="aeti-10">dst_port</span>.
<!--l. 143--><p class="noindent" >Currently only stream sockets are supported. <span 
class="aeti-10">type </span>is 1 for stream socket
types.
<!--l. 146--><p class="noindent" >Stream sockets provide in-order, guaranteed, connection-oriented delivery without
message boundaries.
<a 
 id="x1-405001r411"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.3   </span> <a 
 id="x1-4060003"></a>Buffer Space Management</h5>
<!--l. 150--><p class="nopar" ><span 
class="aeti-10">buf_alloc </span>and <span 
class="aeti-10">fwd_cnt </span>are used for buffer space management of stream sockets. The
guest and the device publish how much buffer space is available per socket. Only
                                                                  

                                                                  
payload bytes are counted and header bytes are not included. This facilitates flow
control so data is never dropped.
<!--l. 155--><p class="noindent" ><span 
class="aeti-10">buf_alloc </span>is the total receive buffer space, in bytes, for this socket. This includes both
free and in-use buffers. <span 
class="aeti-10">fwd_cnt </span>is the free-running bytes received counter. The sender
calculates the amount of free receive buffer space as follows:
<!--l. 160-->
<div class="lstlisting" id="listing-129"><span class="label"><a 
 id="x1-406001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tx_cnt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sender</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">running</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">transmitted</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406002r2"></a></span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer_free</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer_buf_alloc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">tx_cnt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer_fwd_cnt</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 165--><p class="noindent" >If there is insufficient buffer space, the sender waits until virtqueue
buffers are returned and checks <span 
class="aeti-10">buf_alloc </span>and <span 
class="aeti-10">fwd_cnt </span>again. Sending the
VIRTIO_VSOCK_OP_CREDIT_REQUEST packet queries how much buffer space is
available. The reply to this query is a VIRTIO_VSOCK_OP_CREDIT_UPDATE
packet. It is also valid to send a VIRTIO_VSOCK_OP_CREDIT_UPDATE packet
without previously receiving a VIRTIO_VSOCK_OP_CREDIT_REQUEST
packet. This allows communicating updates any time a change in buffer space
occurs.
<a 
 id="x1-406003r410"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.3.1</span> <a 
 id="x1-4070001"></a>Driver Requirements: Device Operation: Buffer Space Management</h5>
VIRTIO_VSOCK_OP_RW data packets MUST only be transmitted when the peer
has sufficient free buffer space for the payload.
<!--l. 177--><p class="noindent" >All packets associated with a stream flow MUST contain valid information in
<span 
class="aeti-10">buf_alloc </span>and <span 
class="aeti-10">fwd_cnt </span>fields.
<a 
 id="x1-407001r413"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.3.2</span> <a 
 id="x1-4080002"></a>Device Requirements: Device Operation: Buffer Space Management</h5>
VIRTIO_VSOCK_OP_RW data packets MUST only be transmitted when the peer
has sufficient free buffer space for the payload.
<!--l. 184--><p class="noindent" >All packets associated with a stream flow MUST contain valid information in
<span 
class="aeti-10">buf_alloc </span>and <span 
class="aeti-10">fwd_cnt </span>fields.
<a 
 id="x1-408001r412"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.4   </span> <a 
 id="x1-4090004"></a>Receive and Transmit</h5>
<!--l. 188--><p class="nopar" >The driver queues outgoing packets on the tx virtqueue and incoming packet receive
buffers on the rx virtqueue. Packets are of the following form:
<!--l. 191-->
<div class="lstlisting" id="listing-130"><span class="label"><a 
 id="x1-409001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_packet</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-409002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-409003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-409004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 198--><p class="noindent" >Virtqueue buffers for outgoing packets are read-only. Virtqueue buffers for incoming
packets are write-only.
<a 
 id="x1-409005r414"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.4.1</span> <a 
 id="x1-4100001"></a>Driver Requirements: Device Operation: Receive and Transmit</h5>
The <span 
class="aeti-10">guest_cid </span>configuration field MUST be used as the source CID when sending
outgoing packets.
<!--l. 206--><p class="noindent" >A VIRTIO_VSOCK_OP_RST reply MUST be sent if a packet is received with an
unknown <span 
class="aeti-10">type </span>value.
<a 
 id="x1-410001r416"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.4.2</span> <a 
 id="x1-4110002"></a>Device Requirements: Device Operation: Receive and Transmit</h5>
The <span 
class="aeti-10">guest_cid </span>configuration field MUST NOT contain a reserved CID as listed in
<a 
href="#x1-3990004">5.10.4<!--tex4ht:ref: sec:Device Types / Socket Device / Device configuration layout --></a>.
<!--l. 213--><p class="noindent" >A VIRTIO_VSOCK_OP_RST reply MUST be sent if a packet is received with an
unknown <span 
class="aeti-10">type </span>value.
<a 
 id="x1-411001r415"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.5   </span> <a 
 id="x1-4120005"></a>Stream Sockets</h5>
<!--l. 218--><p class="nopar" >Connections are established by sending a VIRTIO_VSOCK_OP_REQUEST packet. If
a listening socket exists on the destination a VIRTIO_VSOCK_OP_RESPONSE reply
is sent and the connection is established. A VIRTIO_VSOCK_OP_RST reply is sent if
a listening socket does not exist on the destination or the destination has insufficient
resources to establish the connection.
<!--l. 224--><p class="noindent" >When a connected socket receives VIRTIO_VSOCK_OP_SHUTDOWN the header
<span 
class="aeti-10">flags </span>field bit 0 indicates that the peer will not receive any more data and
bit 1 indicates that the peer will not send any more data. These hints are
permanent once sent and successive packets with bits clear do not reset
them.
<!--l. 230--><p class="noindent" >The VIRTIO_VSOCK_OP_RST packet aborts the connection process or forcibly
disconnects a connected socket.
<!--l. 233--><p class="noindent" >Clean disconnect is achieved by one or more VIRTIO_VSOCK_OP_SHUTDOWN
packets that indicate no more data will be sent and received, followed by a
VIRTIO_VSOCK_OP_RST response from the peer. If no VIRTIO_VSOCK_OP_RST
response is received within an implementation-specific amount of time, a
VIRTIO_VSOCK_OP_RST packet is sent to forcibly disconnect the socket.
<!--l. 239--><p class="noindent" >The clean disconnect process ensures that neither peer reuses the (source,
destination) address tuple for a new connection while the other peer is still processing
the old connection.
                                                                  

                                                                  
<a 
 id="x1-412001r418"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.6   </span> <a 
 id="x1-4130006"></a>Device Events</h5>
<!--l. 245--><p class="nopar" >Certain events are communicated by the device to the driver using the event
virtqueue.
<!--l. 248--><p class="noindent" >The event buffer is as follows:
<!--l. 250-->
<div class="lstlisting" id="listing-131"><span class="label"><a 
 id="x1-413001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_event_id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-413002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_EVENT_TRANSPORT_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-413003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-413004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-413005r5"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-413006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-413007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 260--><p class="noindent" >The VIRTIO_VSOCK_EVENT_TRANSPORT_RESET event indicates that
communication has been interrupted. This usually occurs if the guest has been
physically migrated. The driver shuts down established connections and the <span 
class="aeti-10">guest_cid</span>
configuration field is fetched again. Existing listen sockets remain but their CID is
updated to reflect the current <span 
class="aeti-10">guest_cid</span>.
<a 
 id="x1-413008r417"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.6.1</span> <a 
 id="x1-4140001"></a>Driver Requirements: Device Operation: Device Events</h5>
Event virtqueue buffers SHOULD be replenished quickly so that no events are
missed.
<!--l. 272--><p class="noindent" >The <span 
class="aeti-10">guest_cid </span>configuration field MUST be fetched to determine the current CID
when a VIRTIO_VSOCK_EVENT_TRANSPORT_RESET event is received.
<!--l. 275--><p class="noindent" >Existing connections MUST be shut down when a VIRTIO_VSOCK_EVENT_TRANSPORT_RESET
event is received.
<!--l. 278--><p class="noindent" >Listen connections MUST remain operational with the current CID when a
VIRTIO_VSOCK_EVENT_TRANSPORT_RESET event is received.
<a 
 id="x1-414001r401"></a>
<h3 class="sectionHead"><span class="titlemark">5.11   </span> <a 
 id="x1-41500011"></a>File System Device</h3>
<!--l. 3--><p class="nopar" >The virtio file system device provides file system access. The device either directly
manages a file system or it acts as a gateway to a remote file system. The details of
how the device implementation accesses files are hidden by the device interface,
allowing for a range of use cases.
<!--l. 8--><p class="noindent" >Unlike block-level storage devices such as virtio block and SCSI, the virtio file system
device provides file-level access to data. The device interface is based on the Linux
Filesystem in Userspace (FUSE) protocol. This consists of requests for file system
traversal and access the files and directories within it. The protocol details are
defined by <a 
href="#x1-3001r1">FUSE</a>.
                                                                  

                                                                  
<!--l. 14--><p class="noindent" >The device acts as the FUSE file system daemon and the driver acts as the FUSE
client mounting the file system. The virtio file system device provides the mechanism
for transporting FUSE requests, much like /dev/fuse in a traditional FUSE
application.
<!--l. 19--><p class="noindent" >This section relies on definitions from <a 
href="#x1-3001r1">FUSE</a>.
<a 
 id="x1-415001r407"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.1   </span> <a 
 id="x1-4160001"></a>Device ID</h4>
<!--l. 22--><p class="nopar" >26
<a 
 id="x1-416001r422"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.2   </span> <a 
 id="x1-4170002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">hiprio
    </dd><dt class="description">
<span 
class="aebx-10">1</span><span 
class="aebx-10">…n</span> </dt><dd 
class="description">request queues</dd></dl>
<a 
 id="x1-417001r423"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.3   </span> <a 
 id="x1-4180003"></a>Feature bits</h4>
<!--l. 33--><p class="nopar" >There are currently no feature bits defined.
<a 
 id="x1-418001r424"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.4   </span> <a 
 id="x1-4190004"></a>Device configuration layout</h4>
<!--l. 37--><p class="nopar" >All fields of this configuration are always available.
<!--l. 39-->
<div class="lstlisting" id="listing-132"><span class="label"><a 
 id="x1-419001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_fs_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">char</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80">[36];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">tag</span> </dt><dd 
class="description">is the name associated with this file system. The tag is encoded in UTF-8
    and padded with NUL bytes if shorter than the available space. This field
    is not NUL-terminated if the encoded bytes take up the entire field.
    </dd><dt class="description">
<span 
class="aebxti-10">num_queues</span> </dt><dd 
class="description">is the total number of request virtqueues exposed by the device.
    Each  virtqueue  offers  identical  functionality  and  there  are  no  ordering
    guarantees between requests made available on different queues. Use of
    multiple queues is intended to increase performance.</dd></dl>
<a 
 id="x1-419005r419"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.11.4.1   </span> <a 
 id="x1-4200001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 59--><p class="nopar" >The driver MUST NOT write to device configuration fields.
<!--l. 61--><p class="noindent" >The driver MAY use from one up to <span 
class="aeti-10">num_queues </span>virtqueues.
<a 
 id="x1-420001r426"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.4.2   </span> <a 
 id="x1-4210002"></a>Device Requirements: Device configuration layout</h5>
<!--l. 65--><p class="nopar" >The device MUST set <span 
class="aeti-10">num_queues </span>to 1 or greater.
<a 
 id="x1-421001r425"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.5   </span> <a 
 id="x1-4220005"></a>Device Initialization</h4>
<!--l. 69--><p class="nopar" >On initialization the driver first discovers the device’s virtqueues. The FUSE session
is started by sending a FUSE_INIT request as defined by the FUSE protocol on one
request virtqueue. All virtqueues provide access to the same FUSE session and
therefore only one FUSE_INIT request is required regardless of the number of
available virtqueues.
<a 
 id="x1-422001r428"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.6   </span> <a 
 id="x1-4230006"></a>Device Operation</h4>
<!--l. 77--><p class="nopar" >Device operation consists of operating the virtqueues to facilitate file system
access.
<!--l. 80--><p class="noindent" >The FUSE request types are as follows:
    <ul class="itemize1">
    <li class="itemize">Normal requests are made available by the driver and used by the device.
    </li>
    <li class="itemize">Interrupt requests are made available by the driver to abort requests that
    the device has not used yet.</li></ul>
<!--l. 87--><p class="noindent" >Note that FUSE notification requests are not supported.
<a 
 id="x1-423001r427"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.1   </span> <a 
 id="x1-4240001"></a>Device Operation: Request Queues</h5>
<!--l. 91--><p class="nopar" >The driver enqueues normal requests on an arbitrary request queue and they are
completed by the device on that same queue. The device processes requests in any
order. The driver is responsible for ensuring that ordering constraints are met by
making available a dependent request only after its prerequisite request has been
used.
<!--l. 97--><p class="noindent" >Requests have the following format:
<!--l. 99-->
<div class="lstlisting" id="listing-133"><span class="label"><a 
 id="x1-424001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_fs_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_in_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">datain</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_out_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">out</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dataout</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 111--><p class="noindent" >Note that the words "in" and "out" follow the FUSE meaning and do not indicate the
direction of data transfer under VIRTIO. "In" means input to a request and "out"
means output from processing a request.
<!--l. 115--><p class="noindent" ><span 
class="aeti-10">in </span>is the common header for all types of FUSE requests.
<!--l. 117--><p class="noindent" ><span 
class="aeti-10">datain </span>consists of request-specific data, if any. This is identical to the data read from
the /dev/fuse device by a FUSE daemon.
<!--l. 120--><p class="noindent" ><span 
class="aeti-10">out </span>is the completion header common to all types of FUSE requests.
<!--l. 122--><p class="noindent" ><span 
class="aeti-10">dataout </span>consists of request-specific data, if any. This is identical to the data written
to the /dev/fuse device by a FUSE daemon.
<!--l. 125--><p class="noindent" >For example, the full layout of a FUSE_READ request is as follows:
<!--l. 127-->
<div class="lstlisting" id="listing-134"><span class="label"><a 
 id="x1-424010r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_fs_read_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424011r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424012r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_in_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424013r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">union</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424014r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_read_in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">readin</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424015r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">datain</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_read_in</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424016r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424017r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424018r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424019r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_out_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">out</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424020r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dataout</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">out</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_out_header</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-424021r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 142--><p class="noindent" >The FUSE protocol documented in <a 
href="#x1-3001r1">FUSE</a> specifies the set of request types and their
contents.
<!--l. 145--><p class="noindent" >The endianness of the FUSE protocol session is detectable by inspecting the uint32_t
<span 
class="aeti-10">in.opcode </span>field of the FUSE_INIT request sent by the driver to the device.
This allows the device to determine whether the session is little-endian or
big-endian.
<a 
 id="x1-424022r430"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.2   </span> <a 
 id="x1-4250002"></a>Device Operation: High Priority Queue</h5>
<!--l. 152--><p class="nopar" >The hiprio queue follows the same request format as the request queues. This queue
only contains FUSE_INTERRUPT, FUSE_FORGET, and FUSE_BATCH_FORGET
requests.
<!--l. 156--><p class="noindent" >Interrupt and forget requests have a higher priority than normal requests. The
separate hiprio queue is used for these requests to ensure they can be delivered even
when all request queues are full.
<a 
 id="x1-425001r420"></a>
<h5 class="paragraphHead"><span class="titlemark">5.11.6.2.1</span> <a 
 id="x1-4260001"></a>Device Requirements: Device Operation: High Priority Queue</h5>
The device MUST NOT pause processing of the hiprio queue due to activity on a
normal request queue.
<!--l. 165--><p class="noindent" >The device MAY process request queues concurrently with the hiprio queue.
<a 
 id="x1-426001r432"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.11.6.2.2</span> <a 
 id="x1-4270002"></a>Driver Requirements: Device Operation: High Priority Queue</h5>
The driver MUST submit FUSE_INTERRUPT, FUSE_FORGET, and
FUSE_BATCH_FORGET requests solely on the hiprio queue.
<!--l. 171--><p class="noindent" >The driver MUST anticipate that request queues are processed concurrently with the
hiprio queue.
<a 
 id="x1-427001r431"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.3   </span> <a 
 id="x1-4280003"></a>Device Operation: DAX Window</h5>
<!--l. 175--><p class="nopar" >FUSE_READ and FUSE_WRITE requests transfer file contents between the
driver-provided buffer and the device. In cases where data transfer is undesirable, the
device can map file contents into the DAX window shared memory region. The driver
then accesses file contents directly in device-owned memory without a data
transfer.
<!--l. 181--><p class="noindent" >Shared memory region ID 0 is called the DAX window. Drivers map this
shared memory region with writeback caching as if it were regular RAM. The
contents of the DAX window are undefined unless a mapping exists for that
range.
<!--l. 185--><p class="noindent" >The driver maps a file range into the DAX window using the FUSE_SETUPMAPPING
request. Alignment constraints for FUSE_SETUPMAPPING and
FUSE_REMOVEMAPPING requests are communicated during FUSE_INIT
negotiation.
<!--l. 189--><p class="noindent" >When a FUSE_SETUPMAPPING request perfectly overlaps a previous mapping, the
previous mapping is replaced. When a mapping partially overlaps a previous
mapping, the previous mapping is split into one or two smaller mappings. When
a mapping is partially unmapped it is also split into one or two smaller
mappings.
<!--l. 195--><p class="noindent" >Establishing new mappings or splitting existing mappings consumes resources. If the
device runs out of resources the FUSE_SETUPMAPPING request fails until
resources are available again following FUSE_REMOVEMAPPING.
<!--l. 199--><p class="noindent" >After FUSE_SETUPMAPPING has completed successfully the file range is
accessible from the DAX window at the offset provided by the driver in
the request. A mapping is removed using the FUSE_REMOVEMAPPING
request.
<!--l. 203--><p class="noindent" >Data is only guaranteed to be persistent when a FUSE_FSYNC request is used
by the device after having been made available by the driver following the
write.
<a 
 id="x1-428001r433"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.11.6.3.1</span> <a 
 id="x1-4290001"></a>Device Requirements: Device Operation: DAX Window</h5>
The device MUST allow mappings that completely or partially overlap existing
mappings within the DAX window.
<!--l. 210--><p class="noindent" >The device MUST reject mappings that would go beyond the end of the DAX
window.
<a 
 id="x1-429001r435"></a>
<h5 class="paragraphHead"><span class="titlemark">5.11.6.3.2</span> <a 
 id="x1-4300002"></a>Driver Requirements: Device Operation: DAX Window</h5>
The driver SHOULD be prepared to find shared memory region ID 0 absent and fall
back to FUSE_READ and FUSE_WRITE requests.
<!--l. 216--><p class="noindent" >The driver MUST NOT access DAX window areas that have not been mapped.
<a 
 id="x1-430001r434"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.4   </span> <a 
 id="x1-4310004"></a>Security Considerations</h5>
<!--l. 220--><p class="nopar" >The device provides access to a file system containing files owned by one or more
POSIX user ids and group ids. The device has no secure way of differentiating
between users originating requests via the driver. Therefore the device accepts the
POSIX user ids and group ids provided by the driver and security is enforced by the
driver rather than the device. It is nevertheless possible for devices to implement
POSIX user id and group id mapping or whitelisting to control the ownership and
access available to the driver.
<!--l. 228--><p class="noindent" >File systems containing special files including device nodes and setuid executable files
pose a security concern. These properties are defined by the file type and mode,
which are set by the driver when creating new files or by changes at a later time.
These special files present a security risk when the file system is shared with another
system, such as the host or another guest. This issue can be solved on some
operating systems using mount options that ignore special files. It is also
possible for devices to implement restrictions on special files by refusing their
creation.
<!--l. 237--><p class="noindent" >When the device provides shared access to a file system, symlink race conditions,
exhausting file system capacity, and overwriting or deleting files used by others are
factors to consider. These issues have a long history in multi-user operating systems
and also apply to virtio-fs. They are typically managed at the file system
administration level by providing shared access only to mutually trusted
users.
<a 
 id="x1-431001r437"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.5   </span> <a 
 id="x1-4320005"></a>Live migration considerations</h5>
<!--l. 246--><p class="nopar" >When a guest is migrated to a new host it is necessary to consider the FUSE
session and its state. The continuity of FUSE inode numbers (also known as
                                                                  

                                                                  
nodeids) and fh values is necessary so the driver can continue operation without
disruption.
<!--l. 251--><p class="noindent" >It is possible to maintain the FUSE session across live migration either by transferring
the state or by redirecting requests from the new host to the old host where the state
resides. The details of how to achieve this are implementation-dependent and are not
visible at the device interface level.
<!--l. 256--><p class="noindent" >Maintaining version and feature information negotiated by FUSE_INIT is necessary
so that no FUSE protocol feature changes are visible to the driver across live
migration. The FUSE_INIT information forms part of the FUSE session state that
needs to be transferred during live migration.
                                                                  

                                                                  
<!--l. 5682--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">6</span> <a 
 id="x1-4330006"></a>Reserved Feature Bits</h2>
Currently these device-independent feature bits defined:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_F_RING_INDIRECT_DESC (28)</span> </dt><dd 
class="description">
    Negotiating this feature indicates that the driver can use descriptors with
    the VIRTQ_DESC_F_INDIRECT flag set, as described in <a 
href="#x1-350003">2.6.5.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a> <a 
href="#x1-350003">Indirect
    Descriptors<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a> and <a 
href="#x1-680007">2.7.7<!--tex4ht:ref: sec:Packed Virtqueues / Indirect Flag: Scatter-Gather Support --></a> <a 
href="#x1-680007">Indirect Flag: Scatter-Gather Support<!--tex4ht:ref: sec:Packed Virtqueues / Indirect Flag: Scatter-Gather Support --></a>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_RING_EVENT_IDX(29)</span> </dt><dd 
class="description">This  feature  enables  the  <span 
class="aeti-10">used_event</span>
    and the <span 
class="aeti-10">avail_event </span>fields as described in <a 
href="#x1-400007">2.6.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>, <a 
href="#x1-430008">2.6.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a> and <a 
href="#x1-7100010">2.7.10<!--tex4ht:ref: sec:Packed Virtqueues / Driver and Device Event Suppression --></a>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_VERSION_1(32)</span> </dt><dd 
class="description">This
    indicates compliance with this specification, giving a simple way to detect
    legacy devices or drivers.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_ACCESS_PLATFORM(33)</span> </dt><dd 
class="description">This  feature  indicates  that  the
    device can be used on a platform where device access to data in memory is
    limited and/or translated. E.g. this is the case if the device can be located
    behind  an  IOMMU  that  translates  bus  addresses  from  the  device  into
    physical addresses in memory, if the device can be limited to only access
    certain memory addresses or if special commands such as a cache flush
    can be needed to synchronise data in memory with the device. Whether
    accesses are actually limited or translated is described by platform-specific
    means. If this feature bit is set to 0, then the device has same access to
    memory addresses supplied to it as the driver has. In particular, the device
    will always use physical addresses matching addresses used by the driver
    (typically meaning physical addresses used by the CPU) and not translated
    further, and can access any address supplied to it by the driver. When clear,
    this overrides any platform-specific description of whether device access is
    limited or translated in any way, e.g. whether an IOMMU may be present.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_RING_PACKED(34)</span> </dt><dd 
class="description">This  feature  indicates  support  for  the
    packed virtqueue layout as described in <a 
href="#x1-610007">2.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues --></a> <a 
href="#x1-610007">Packed Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues --></a>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_IN_ORDER(35)</span> </dt><dd 
class="description">This feature indicates that all buffers are used
    by the device in the same order in which they have been made available.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_ORDER_PLATFORM(36)</span> </dt><dd 
class="description">This feature indicates that memory
    accesses by the driver and the device are ordered in a way described by the
    platform.
    <!--l. 5731--><p class="noindent" >If this feature bit is negotiated, the ordering in effect for any memory
                                                                  

                                                                  
    accesses by the driver that need to be ordered in a specific way with respect
    to accesses by the device is the one suitable for devices described by the
    platform. This implies that the driver needs to use memory barriers suitable
    for devices described by the platform; e.g. for the PCI transport in the case
    of hardware PCI devices.
    <!--l. 5738--><p class="noindent" >If this feature bit is not negotiated, then the device and driver are assumed
    to be implemented in software, that is they can be assumed to run on
    identical CPUs in an SMP configuration. Thus a weaker form of memory
    barriers is sufficient to yield better performance.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_SR_IOV(37)</span> </dt><dd 
class="description">This  feature  indicates  that  the  device  supports
    Single Root I/O Virtualization. Currently only PCI devices support this
    feature.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_NOTIFICATION_DATA(38)</span> </dt><dd 
class="description">This feature indicates that the
    driver passes extra data (besides identifying the virtqueue) in its device
    notifications. See <a 
href="#x1-9000023">2.7.23<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-9000023">Driver notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a>.</dd></dl>
<a 
 id="x1-433001r421"></a>
<h3 class="sectionHead"><span class="titlemark">6.1   </span> <a 
 id="x1-4340001"></a>Driver Requirements: Reserved Feature Bits</h3>
<!--l. 5755--><p class="nopar" >A driver MUST accept VIRTIO_F_VERSION_1 if it is offered. A driver MAY fail to
operate further if VIRTIO_F_VERSION_1 is not offered.
<!--l. 5758--><p class="noindent" >A driver SHOULD accept VIRTIO_F_ACCESS_PLATFORM if it is offered, and it
MUST then either disable the IOMMU or configure the IOMMU to translate
bus addresses passed to the device into physical addresses in memory. If
VIRTIO_F_ACCESS_PLATFORM is not offered, then a driver MUST pass only
physical addresses to the device.
<!--l. 5764--><p class="noindent" >A driver SHOULD accept VIRTIO_F_RING_PACKED if it is offered.
<!--l. 5766--><p class="noindent" >A driver SHOULD accept VIRTIO_F_ORDER_PLATFORM if it is offered. If
VIRTIO_F_ORDER_PLATFORM has been negotiated, a driver MUST use the
barriers suitable for hardware devices.
<!--l. 5770--><p class="noindent" >If VIRTIO_F_SR_IOV has been negotiated, a driver MAY enable virtual
functions through the device’s PCI SR-IOV capability structure. A driver
MUST NOT negotiate VIRTIO_F_SR_IOV if the device does not have a PCI
SR-IOV capability structure or is not a PCI device. A driver MUST negotiate
VIRTIO_F_SR_IOV and complete the feature negotiation (including checking the
FEATURES_OK <span 
class="aeti-10">device status </span>bit) before enabling virtual functions through the
device’s PCI SR-IOV capability structure. After once successfully negotiating
VIRTIO_F_SR_IOV, the driver MAY enable virtual functions through the device’s
PCI SR-IOV capability structure even if the device or the system has been fully or
partially reset, and even without re-negotiating VIRTIO_F_SR_IOV after the
                                                                  

                                                                  
reset.
<a 
 id="x1-434001r440"></a>
<h3 class="sectionHead"><span class="titlemark">6.2   </span> <a 
 id="x1-4350002"></a>Device Requirements: Reserved Feature Bits</h3>
<!--l. 5787--><p class="nopar" >A device MUST offer VIRTIO_F_VERSION_1. A device MAY fail to operate further
if VIRTIO_F_VERSION_1 is not accepted.
<!--l. 5790--><p class="noindent" >A device SHOULD offer VIRTIO_F_ACCESS_PLATFORM if its access to memory is
through bus addresses distinct from and translated by the platform to physical
addresses used by the driver, and/or if it can only access certain memory
addresses with said access specified and/or granted by the platform. A device
MAY fail to operate further if VIRTIO_F_ACCESS_PLATFORM is not
accepted.
<!--l. 5798--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, a device MUST use buffers in the
same order in which they have been available.
<!--l. 5801--><p class="noindent" >A device MAY fail to operate further if VIRTIO_F_ORDER_PLATFORM is offered
but not accepted. A device MAY operate in a slower emulation mode if
VIRTIO_F_ORDER_PLATFORM is offered but not accepted.
<!--l. 5806--><p class="noindent" >It is RECOMMENDED that an add-in card based PCI device offers both
VIRTIO_F_ACCESS_PLATFORM and VIRTIO_F_ORDER_PLATFORM for
maximum portability.
<!--l. 5810--><p class="noindent" >A device SHOULD offer VIRTIO_F_SR_IOV if it is a PCI device and presents a PCI
SR-IOV capability structure, otherwise it MUST NOT offer VIRTIO_F_SR_IOV.
<a 
 id="x1-435001r441"></a>
<h3 class="sectionHead"><span class="titlemark">6.3   </span> <a 
 id="x1-4360003"></a>Legacy Interface: Reserved Feature Bits</h3>
<!--l. 5816--><p class="nopar" >Transitional devices MAY offer the following:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_F_NOTIFY_ON_EMPTY (24)</span> </dt><dd 
class="description">If this feature has been negotiated by
    driver, the device MUST issue a used buffer notification if the device runs out of
    available descriptors on a virtqueue, even though notifications are suppressed
    using the VIRTQ_AVAIL_F_NO_INTERRUPT flag or the <span 
class="aeti-10">used_event</span>
    field.
    <span 
class="aebx-10">Note:</span> An example of a driver using this feature is the legacy networking
          driver: it doesn’t need to know every time a packet is transmitted,
          but it does need to free the transmitted packets a finite time after
          they are transmitted. It can avoid using a timer if the device notifies
          it when all the packets are transmitted.
    </dd></dl>
                                                                  

                                                                  
<!--l. 5834--><p class="noindent" >Transitional devices MUST offer, and if offered by the device transitional drivers
MUST accept the following:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_F_ANY_LAYOUT (27)</span> </dt><dd 
class="description">This  feature  indicates  that  the  device
    accepts arbitrary descriptor layouts, as described in Section <a 
href="#x1-310003">2.6.4.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a> <a 
href="#x1-310003">Legacy
    Interface: Message Framing<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a>.
    </dd><dt class="description">
<span 
class="aebx-10">UNUSED (30)</span> </dt><dd 
class="description">Bit  30  is  used  by  qemu’s  implementation  to  check  for
    experimental early versions of virtio which did not perform correct feature
    negotiation, and SHOULD NOT be negotiated.</dd></dl>
                                                                  

                                                                  
<!--l. 4--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">7</span> <a 
 id="x1-4370007"></a>Conformance</h2>
This chapter lists the conformance targets and clauses for each; this also forms a
useful checklist which authors are asked to consult for their implementations!
<a 
 id="x1-437001r442"></a>
<h3 class="sectionHead"><span class="titlemark">7.1   </span> <a 
 id="x1-4380001"></a>Conformance Targets</h3>
<!--l. 12--><p class="nopar" >Conformance targets:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">Driver</span> </dt><dd 
class="description">A driver MUST conform to four conformance clauses:
        <ul class="itemize1">
        <li class="itemize">Clause <a 
href="#x1-4390002">7.2<!--tex4ht:ref: sec:Conformance / Driver Conformance --></a>.
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-4400001">7.2.1<!--tex4ht:ref: sec:Conformance / Driver Conformance / PCI Driver Conformance --></a>, <a 
href="#x1-4410002">7.2.2<!--tex4ht:ref: sec:Conformance / Driver Conformance / MMIO Driver Conformance --></a> or <a 
href="#x1-4420003">7.2.3<!--tex4ht:ref: sec:Conformance / Driver Conformance / Channel I/O Driver Conformance --></a>.
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-4430004">7.2.4<!--tex4ht:ref: sec:Conformance / Driver Conformance / Network Driver Conformance --></a>, <a 
href="#x1-4440005">7.2.5<!--tex4ht:ref: sec:Conformance / Driver Conformance / Block Driver Conformance --></a>, <a 
href="#x1-4450006">7.2.6<!--tex4ht:ref: sec:Conformance / Driver Conformance / Console Driver Conformance --></a>, <a 
href="#x1-4460007">7.2.7<!--tex4ht:ref: sec:Conformance / Driver Conformance / Entropy Driver Conformance --></a>, <a 
href="#x1-4470008">7.2.8<!--tex4ht:ref: sec:Conformance / Driver Conformance / Traditional Memory Balloon Driver Conformance --></a>, <a 
href="#x1-4480009">7.2.9<!--tex4ht:ref: sec:Conformance / Driver Conformance / SCSI Host Driver Conformance --></a>, <a 
href="#x1-44900010">7.2.10<!--tex4ht:ref: sec:Conformance / Driver Conformance / Input Driver Conformance --></a>, <a 
href="#x1-45000011">7.2.11<!--tex4ht:ref: sec:Conformance / Driver Conformance / Crypto Driver Conformance --></a> or
        <a 
href="#x1-45100012">7.2.12<!--tex4ht:ref: sec:Conformance / Driver Conformance / Socket Driver Conformance --></a>.
        </li>
        <li class="itemize">Clause <a 
href="#x1-4650004">7.4<!--tex4ht:ref: sec:Conformance / Legacy Interface: Transitional Device and Transitional Driver Conformance --></a>.</li></ul>
    </dd><dt class="description">
<span 
class="aebx-10">Device</span> </dt><dd 
class="description">A device MUST conform to four conformance clauses:
        <ul class="itemize1">
        <li class="itemize">Clause <a 
href="#x1-4520003">7.3<!--tex4ht:ref: sec:Conformance / Device Conformance --></a>.
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-4530001">7.3.1<!--tex4ht:ref: sec:Conformance / Device Conformance / PCI Device Conformance --></a>, <a 
href="#x1-4540002">7.3.2<!--tex4ht:ref: sec:Conformance / Device Conformance / MMIO Device Conformance --></a> or <a 
href="#x1-4550003">7.3.3<!--tex4ht:ref: sec:Conformance / Device Conformance / Channel I/O Device Conformance --></a>.
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-4560004">7.3.4<!--tex4ht:ref: sec:Conformance / Device Conformance / Network Device Conformance --></a>, <a 
href="#x1-4570005">7.3.5<!--tex4ht:ref: sec:Conformance / Device Conformance / Block Device Conformance --></a>, <a 
href="#x1-4580006">7.3.6<!--tex4ht:ref: sec:Conformance / Device Conformance / Console Device Conformance --></a>, <a 
href="#x1-4590007">7.3.7<!--tex4ht:ref: sec:Conformance / Device Conformance / Entropy Device Conformance --></a>, <a 
href="#x1-4600008">7.3.8<!--tex4ht:ref: sec:Conformance / Device Conformance / Traditional Memory Balloon Device Conformance --></a>, <a 
href="#x1-4610009">7.3.9<!--tex4ht:ref: sec:Conformance / Device Conformance / SCSI Host Device Conformance --></a>, <a 
href="#x1-46200010">7.3.10<!--tex4ht:ref: sec:Conformance / Device Conformance / Input Device Conformance --></a>, <a 
href="#x1-46300011">7.3.11<!--tex4ht:ref: sec:Conformance / Device Conformance / Crypto Device Conformance --></a> or
        <a 
href="#x1-46400012">7.3.12<!--tex4ht:ref: sec:Conformance / Device Conformance / Socket Device Conformance --></a>.
        </li>
        <li class="itemize">Clause <a 
href="#x1-4650004">7.4<!--tex4ht:ref: sec:Conformance / Legacy Interface: Transitional Device and Transitional Driver Conformance --></a>.</li></ul>
    </dd></dl>
<a 
 id="x1-438001r444"></a>
<h3 class="sectionHead"><span class="titlemark">7.2   </span> <a 
 id="x1-4390002"></a>Clause 1: Driver Conformance</h3>
<!--l. 32--><p class="nopar" >A driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-110001">2.1.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Device Status Field --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-140001">2.2.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Feature Bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-190001">2.4.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Device Configuration Space --></a>
    </li>
    <li class="itemize"><a 
href="#x1-250001">2.6.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues --></a>
    </li>
    <li class="itemize"><a 
href="#x1-300002">2.6.4.2<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Message Framing --></a>
    </li>
    <li class="itemize"><a 
href="#x1-340002">2.6.5.2<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>
    </li>
    <li class="itemize"><a 
href="#x1-360001">2.6.5.3.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a>
    </li>
    <li class="itemize"><a 
href="#x1-410001">2.6.7.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-390001">2.6.6.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Available Ring --></a>
    </li>
    <li class="itemize"><a 
href="#x1-460003">2.6.8.3<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>
    </li>
    <li class="itemize"><a 
href="#x1-490001">2.6.10.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Available Buffer Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-570001">2.6.13.3.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Supplying Buffers to The Device / Updating idx --></a>
    </li>
    <li class="itemize"><a 
href="#x1-590001">2.6.13.4.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Supplying Buffers to The Device / Notifying The Device --></a>
    </li>
    <li class="itemize"><a 
href="#x1-960001">3.1.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1010001">3.3.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Cleanup --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4340001">6.1<!--tex4ht:ref: drivernormative:Reserved Feature Bits --></a></li></ul>
<a 
 id="x1-439001r429"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.1   </span> <a 
 id="x1-4400001"></a>Clause 2: PCI Driver Conformance</h4>
<!--l. 55--><p class="nopar" >A PCI driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1070002">4.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-1100001">4.1.3.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1130001">4.1.4.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1170002">4.1.4.3.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Common configuration structure layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1220002">4.1.4.5.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / ISR status capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1290002">4.1.4.8.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1390002">4.1.5.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / MSI-X Vector Configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1470002">4.1.5.4.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a></li></ul>
<a 
 id="x1-440001r446"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.2   </span> <a 
 id="x1-4410002"></a>Clause 3: MMIO Driver Conformance</h4>
<!--l. 70--><p class="nopar" >An MMIO driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1530002">4.2.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1560001">4.2.3.1.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1600001">4.2.3.4.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Notifications From The Device --></a></li></ul>
<a 
 id="x1-441001r447"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.3   </span> <a 
 id="x1-4420003"></a>Clause 4: Channel I/O Driver Conformance</h4>
<!--l. 80--><p class="nopar" >A Channel I/O driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1670004">4.3.1.4<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Basic Concepts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1710002">4.3.2.1.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1770001">4.3.2.3.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Communicating Status Information --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1920002">4.3.3.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Adapter I/O Interrupts --></a>
    </li>
                                                                  

                                                                  
    <li class="itemize"><a 
href="#x1-1960002">4.3.3.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Guest->Host Notification --></a></li></ul>
<a 
 id="x1-442001r448"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.4   </span> <a 
 id="x1-4430004"></a>Clause 5: Network Driver Conformance</h4>
<!--l. 92--><p class="nopar" >A network driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2070002">5.1.4.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2130001">5.1.6.2.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Packet Transmission --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2170001">5.1.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2210002">5.1.6.4.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2250002">5.1.6.5.1.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Packet Receive Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2280002">5.1.6.5.2.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2330001">5.1.6.5.4.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Gratuitous Packet Sending --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2360001">5.1.6.5.5.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2410002">5.1.6.5.6.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Offloads State Configuration / Setting Offloads State --></a></li></ul>
<a 
 id="x1-443001r449"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.5   </span> <a 
 id="x1-4440005"></a>Clause 6: Block Driver Conformance</h4>
<!--l. 108--><p class="nopar" >A block driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2520001">5.2.5.1<!--tex4ht:ref: drivernormative:Device Types / Block Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2560001">5.2.6.1<!--tex4ht:ref: drivernormative:Device Types / Block Device / Device Operation --></a></li></ul>
<a 
 id="x1-444001r450"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.6   </span> <a 
 id="x1-4450006"></a>Clause 7: Console Driver Conformance</h4>
<!--l. 117--><p class="nopar" >A console driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2690001">5.3.6.1<!--tex4ht:ref: drivernormative:Device Types / Console Device / Device Operation --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-2720002">5.3.6.2.2<!--tex4ht:ref: drivernormative:Device Types / Console Device / Device Operation / Multiport Device Operation --></a></li></ul>
<a 
 id="x1-445001r451"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.7   </span> <a 
 id="x1-4460007"></a>Clause 8: Entropy Driver Conformance</h4>
<!--l. 126--><p class="nopar" >An entropy driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2820001">5.4.6.1<!--tex4ht:ref: drivernormative:Device Types / Entropy Device / Device Operation --></a></li></ul>
<a 
 id="x1-446001r452"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.8   </span> <a 
 id="x1-4470008"></a>Clause 9: Traditional Memory Balloon Driver Conformance</h4>
<!--l. 134--><p class="nopar" >A traditional memory balloon driver MUST conform to the following normative
statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2880001">5.5.3.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Feature bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2950001">5.5.6.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2990001">5.5.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation / Memory Statistics --></a></li></ul>
<a 
 id="x1-447001r453"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.9   </span> <a 
 id="x1-4480009"></a>Clause 10: SCSI Host Driver Conformance</h4>
<!--l. 144--><p class="nopar" >An SCSI host driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3080001">5.6.4.1<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3160002">5.6.6.1.2<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3210001">5.6.6.3.1<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq --></a></li></ul>
<a 
 id="x1-448001r454"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.10   </span> <a 
 id="x1-44900010"></a>Clause 11: Input Driver Conformance</h4>
<!--l. 154--><p class="nopar" >An input driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3500001">5.8.5.1<!--tex4ht:ref: drivernormative:Device Types / Input Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3530001">5.8.6.1<!--tex4ht:ref: drivernormative:Device Types / Input Device / Device Operation --></a></li></ul>
<a 
 id="x1-449001r455"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.2.11   </span> <a 
 id="x1-45000011"></a>Clause 12: Crypto Driver Conformance</h4>
<!--l. 163--><p class="nopar" >A Crypto driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3670002">5.9.5.2<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3690001">5.9.6.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3780005">5.9.7.2.1.5<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation / Session operation: create session --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3800007">5.9.7.2.1.7<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation / Session operation: destroy session --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3840001">5.9.7.4.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / HASH Service Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3870001">5.9.7.5.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / MAC Service Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3900001">5.9.7.6.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / Symmetric algorithms Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3930001">5.9.7.7.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / AEAD Service Operation --></a></li></ul>
<a 
 id="x1-450001r456"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.12   </span> <a 
 id="x1-45100012"></a>Clause 13: Socket Driver Conformance</h4>
<!--l. 178--><p class="nopar" >A socket driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4070001">5.10.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Socket Device / Device Operation / Buffer Space Management --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4100001">5.10.6.4.1<!--tex4ht:ref: drivernormative:Device Types / Socket Device / Device Operation / Receive and Transmit --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4140001">5.10.6.6.1<!--tex4ht:ref: drivernormative:Device Types / Socket Device / Device Operation / Device Events --></a></li></ul>
<a 
 id="x1-451001r445"></a>
<h3 class="sectionHead"><span class="titlemark">7.3   </span> <a 
 id="x1-4520003"></a>Clause 14: Device Conformance</h3>
<!--l. 188--><p class="nopar" >A device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-120002">2.1.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Device Status Field --></a>
    </li>
    <li class="itemize"><a 
href="#x1-150002">2.2.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Feature Bits --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-200002">2.4.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Device Configuration Space --></a>
    </li>
    <li class="itemize"><a 
href="#x1-290001">2.6.4.1<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Message Framing --></a>
    </li>
    <li class="itemize"><a 
href="#x1-330001">2.6.5.1<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>
    </li>
    <li class="itemize"><a 
href="#x1-370002">2.6.5.3.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a>
    </li>
    <li class="itemize"><a 
href="#x1-420002">2.6.7.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-450002">2.6.8.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>
    </li>
    <li class="itemize"><a 
href="#x1-500002">2.6.10.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / Available Buffer Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-930002">2.8.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Shared Memory Regions --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4350002">6.2<!--tex4ht:ref: devicenormative:Reserved Feature Bits --></a></li></ul>
<a 
 id="x1-452001r457"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.1   </span> <a 
 id="x1-4530001"></a>Clause 15: PCI Device Conformance</h4>
<!--l. 206--><p class="nopar" >A PCI device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1040001">4.1.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1060001">4.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1110002">4.1.3.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1140002">4.1.4.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1160001">4.1.4.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Common configuration structure layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1190001">4.1.4.4.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1210001">4.1.4.5.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / ISR status capability --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-1240001">4.1.4.6.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Device-specific configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1260001">4.1.4.7.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Shared memory capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1280001">4.1.4.8.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1320001">4.1.4.10.0.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Non-transitional Device With Legacy Driver --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1380001">4.1.5.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / MSI-X Vector Configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1440001">4.1.5.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Used Buffer Notifications --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1460001">4.1.5.4.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a></li></ul>
<a 
 id="x1-453001r459"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.2   </span> <a 
 id="x1-4540002"></a>Clause 16: MMIO Device Conformance</h4>
<!--l. 227--><p class="nopar" >An MMIO device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1520001">4.2.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over MMIO / MMIO Device Register Layout --></a></li></ul>
<a 
 id="x1-454001r460"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.3   </span> <a 
 id="x1-4550003"></a>Clause 17: Channel I/O Device Conformance</h4>
<!--l. 235--><p class="nopar" >A Channel I/O device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1660003">4.3.1.3<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Basic Concepts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1700001">4.3.2.1.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1740001">4.3.2.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Configuring a Virtqueue --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1780002">4.3.2.3.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Communicating Status Information --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1850001">4.3.2.6.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Two-Stage Queue Indicators --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1910001">4.3.3.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Adapter I/O Interrupts --></a>
    </li>
                                                                  

                                                                  
    <li class="itemize"><a 
href="#x1-1950001">4.3.3.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Guest->Host Notification --></a></li></ul>
<a 
 id="x1-455001r461"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.4   </span> <a 
 id="x1-4560004"></a>Clause 18: Network Device Conformance</h4>
<!--l. 249--><p class="nopar" >A network device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2060001">5.1.4.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2140002">5.1.6.2.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Packet Transmission --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2180002">5.1.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2200001">5.1.6.4.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2240001">5.1.6.5.1.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Packet Receive Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2270001">5.1.6.5.2.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2340002">5.1.6.5.4.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Gratuitous Packet Sending --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2370002">5.1.6.5.5.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode --></a></li></ul>
<a 
 id="x1-456001r462"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.5   </span> <a 
 id="x1-4570005"></a>Clause 19: Block Device Conformance</h4>
<!--l. 264--><p class="nopar" >A block device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2530002">5.2.5.2<!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2570002">5.2.6.2<!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Operation --></a></li></ul>
<a 
 id="x1-457001r463"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.6   </span> <a 
 id="x1-4580006"></a>Clause 20: Console Device Conformance</h4>
<!--l. 273--><p class="nopar" >A console device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2670001">5.3.5.1<!--tex4ht:ref: devicenormative:Device Types / Console Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2710001">5.3.6.2.1<!--tex4ht:ref: devicenormative:Device Types / Console Device / Device Operation / Multiport Device Operation --></a></li></ul>
<a 
 id="x1-458001r464"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.3.7   </span> <a 
 id="x1-4590007"></a>Clause 21: Entropy Device Conformance</h4>
<!--l. 282--><p class="nopar" >An entropy device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2830002">5.4.6.2<!--tex4ht:ref: devicenormative:Device Types / Entropy Device / Device Operation --></a></li></ul>
<a 
 id="x1-459001r465"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.8   </span> <a 
 id="x1-4600008"></a>Clause 22: Traditional Memory Balloon Device Conformance</h4>
<!--l. 290--><p class="nopar" >A traditional memory balloon device MUST conform to the following normative
statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2890002">5.5.3.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Feature bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2960002">5.5.6.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3000002">5.5.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation / Memory Statistics --></a></li></ul>
<a 
 id="x1-460001r466"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.9   </span> <a 
 id="x1-4610009"></a>Clause 23: SCSI Host Device Conformance</h4>
<!--l. 300--><p class="nopar" >An SCSI host device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3090002">5.6.4.2<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3110005">5.6.5<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3150001">5.6.6.1.1<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3220002">5.6.6.3.2<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq --></a></li></ul>
<a 
 id="x1-461001r467"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.10   </span> <a 
 id="x1-46200010"></a>Clause 24: Input Device Conformance</h4>
<!--l. 311--><p class="nopar" >An input device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3510002">5.8.5.2<!--tex4ht:ref: devicenormative:Device Types / Input Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3540002">5.8.6.2<!--tex4ht:ref: devicenormative:Device Types / Input Device / Device Operation --></a></li></ul>
<a 
 id="x1-462001r468"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.3.11   </span> <a 
 id="x1-46300011"></a>Clause 25: Crypto Device Conformance</h4>
<!--l. 320--><p class="nopar" >A Crypto device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3660001">5.9.5.1<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3790006">5.9.7.2.1.6<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation / Session operation: create session --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3810008">5.9.7.2.1.8<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation / Session operation: destroy session --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3850002">5.9.7.4.2<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / HASH Service Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3880002">5.9.7.5.2<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / MAC Service Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3910002">5.9.7.6.2<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / Symmetric algorithms Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3940002">5.9.7.7.2<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / AEAD Service Operation --></a></li></ul>
<a 
 id="x1-463001r469"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.12   </span> <a 
 id="x1-46400012"></a>Clause 26: Socket Device Conformance</h4>
<!--l. 334--><p class="nopar" >A socket device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4080002">5.10.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Socket Device / Device Operation / Buffer Space Management --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4110002">5.10.6.4.2<!--tex4ht:ref: devicenormative:Device Types / Socket Device / Device Operation / Receive and Transmit --></a></li></ul>
<a 
 id="x1-464001r458"></a>
<h3 class="sectionHead"><span class="titlemark">7.4   </span> <a 
 id="x1-4650004"></a>Clause 27: Legacy Interface: Transitional Device and Transitional Driver
Conformance</h3>
<!--l. 342--><p class="nopar" >A conformant implementation MUST be either transitional or non-transitional, see
<a 
href="#x1-60001">1.3.1<!--tex4ht:ref: intro:Legacy Interface: Terminology --></a>.
<!--l. 346--><p class="noindent" >An implementation MAY choose to implement OPTIONAL support for the legacy
interface, including support for legacy drivers or devices, by conforming to all of the
MUST or REQUIRED level requirements for the legacy interface for the transitional
devices and drivers.
<!--l. 352--><p class="noindent" >The requirements for the legacy interface for transitional implementations are located
in sections named “Legacy Interface” listed below:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize">Section <a 
href="#x1-160003">2.2.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits / Legacy Interface: A Note on Feature Bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-210003">2.4.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: A Note on Configuration Space endian-ness --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-220004">2.4.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-260002">2.6.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-270003">2.6.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Endianness --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-310003">2.6.4.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-970002">3.1.2<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization / Legacy Interface: Device Initialization --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1080003">4.1.2.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery / Legacy Interfaces: A Note on PCI Device Discovery --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1300009">4.1.4.9<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Legacy Interfaces: A Note on PCI Device Layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1360001">4.1.5.1.1.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Virtio Device Configuration Layout Detection / Legacy Interface: A Note on Device Layout Detection --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1410001">4.1.5.1.3.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Virtqueue Configuration / Legacy Interface: A Note on Virtqueue Configuration --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1610004">4.2.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1720003">4.3.2.1.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision / Legacy Interfaces: A Note on Setting the Virtio Revision --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1750002">4.3.2.2.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Configuring a Virtqueue / Legacy Interface: A Note on Configuring a Virtqueue --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1930003">4.3.3.1.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Legacy Interfaces: A Note on Host->Guest Notification --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1860004">4.3.2.6.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Legacy Interfaces: A Note on Setting Up Indicators --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2040002">5.1.3.2<!--tex4ht:ref: sec:Device Types / Network Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2080003">5.1.4.3<!--tex4ht:ref: sec:Device Types / Network Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize">Section <a 
href="#x1-2110001">5.1.6.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2290003">5.1.6.5.2.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering / Legacy Interface: Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2310001">5.1.6.5.3.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / VLAN Filtering / Legacy Interface: VLAN Filtering --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2380003">5.1.6.5.5.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode / Legacy Interface: Automatic receive steering in multiqueue mode --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2420003">5.1.6.5.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Offloads State Configuration / Setting Offloads State / Legacy Interface: Setting Offloads State --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2480001">5.2.3.1<!--tex4ht:ref: sec:Device Types / Block Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2500001">5.2.4.1<!--tex4ht:ref: sec:Device Types / Block Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2540003">5.2.5.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Initialization / Legacy Interface: Device Initialization --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2580003">5.2.6.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2650001">5.3.4.1<!--tex4ht:ref: sec:Device Types / Console Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2730003">5.3.6.3<!--tex4ht:ref: sec:Device Types / Console Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2900001">5.5.3.2.0.1<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2970001">5.5.6.2.1<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3010003">5.5.6.3.3<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Device Operation / Memory Statistics / Legacy Interface: Memory Statistics --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3100003">5.6.4.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3130001">5.6.6.0.1<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3170003">5.6.6.1.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues / Legacy Interface: Device Operation: Request Queues --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3190001">5.6.6.2.1<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: controlq / Legacy Interface: Device Operation: controlq --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize">Section <a 
href="#x1-3230003">5.6.6.3.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq / Legacy Interface: Device Operation: eventq --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-4360003">6.3<!--tex4ht:ref: sec:Reserved Feature Bits / Legacy Interface: Reserved Feature Bits --></a></li></ul>
                                                                  

                                                                  
<a 
 id="x1-465001r443"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix A</span>. <a 
 id="x1-466000A"></a>virtio_queue.h</h2>
This file is also available at the link <a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/listings/virtio_queue.h" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/listings/virtio_queue.h</a>.
All definitions in this section are for non-normative reference only.
<!--l. 8--><div class="lstinputlisting">
<a 
 id="x1-466001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466002r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">ifndef</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466003r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466004r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">An</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interface</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">efficient</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">implementation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466006r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BSD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">licensed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">anyone</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">can</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">use</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">definitions</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466007r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">implement</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compatible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">drivers</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">servers</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466008r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466009r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Copyright</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2007,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2009,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Corporation</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466010r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Copyright</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2011,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Red</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Inc</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466011r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">All</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rights</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466012r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466013r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistribution</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">use</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">binary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">forms</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">without</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466014r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">modification</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">permitted</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">provided</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466015r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">met</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466016r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistributions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">code</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">retain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">copyright</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466017r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notice</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disclaimer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466018r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistributions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">binary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">form</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reproduce</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">copyright</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466019r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notice</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disclaimer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466020r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">documentation</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">other</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">materials</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">provided</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">distribution</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466021r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Neither</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">name</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">names</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">its</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contributors</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466022r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">may</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endorse</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">promote</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">products</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">derived</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">software</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466023r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">without</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">prior</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">permission</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466024r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THIS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SOFTWARE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROVIDED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">COPYRIGHT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">HOLDERS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRIBUTORS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">‘‘</span><span 
class="pcrr8t-x-x-80">AS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IS</span><span 
class="pcrr8t-x-x-80">’’</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466025r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXPRESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IMPLIED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WARRANTIES</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIMITED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466026r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IMPLIED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WARRANTIES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">MERCHANTABILITY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FITNESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PARTICULAR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PURPOSE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466027r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ARE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DISCLAIMED</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EVENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SHALL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRIBUTORS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABLE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466028r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DIRECT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INDIRECT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INCIDENTAL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SPECIAL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXEMPLARY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONSEQUENTIAL</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466029r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DAMAGES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIMITED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROCUREMENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SUBSTITUTE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GOODS</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466030r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SERVICES</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LOSS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">USE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DATA</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROFITS</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUSINESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INTERRUPTION</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466031r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">HOWEVER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CAUSED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ON</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THEORY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABILITY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WHETHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRACT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">STRICT</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466032r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABILITY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TORT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NEGLIGENCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OTHERWISE</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ARISING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WAY</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466033r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">USE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THIS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SOFTWARE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EVEN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ADVISED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">POSSIBILITY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466034r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SUCH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DAMAGE</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466035r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466036r35"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">include</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><</span><span 
class="pcrr8t-x-x-80">stdint</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">h</span><span 
class="pcrr8t-x-x-80">></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466037r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466038r37"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">continuing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466039r38"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466040r39"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">otherwise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466041r40"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466042r41"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">means</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contains</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466043r42"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_INDIRECT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466044r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466045r44"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">advise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">don</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">kick</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">me</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466046r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">when</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">you</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">add</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">It</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unreliable</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">simply</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466047r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimization</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466048r47"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_USED_F_NO_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466049r48"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">advise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">don</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466050r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">me</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">when</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">you</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">consume</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">It</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unreliable</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466051r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">simply</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimization</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466052r51"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_AVAIL_F_NO_INTERRUPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466053r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466054r53"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Support</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indirect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466055r54"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_INDIRECT_DESC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">28</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466056r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466057r56"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Support</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466058r57"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">29</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466059r58"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466060r59"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Arbitrary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">layouts</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466061r60"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_ANY_LAYOUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">27</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466062r61"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466063r62"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Virtqueue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466064r63"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">These</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">can</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">together</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">".</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466065r64"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466066r65"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466067r66"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466068r67"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466069r68"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466070r69"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466071r70"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466072r71"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">We</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unused</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">too</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466073r72"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466074r73"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466075r74"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466076r75"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466077r76"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466078r77"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466079r78"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466080r79"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466081r80"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466082r81"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466083r82"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">here</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reasons</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466084r83"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466085r84"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466086r85"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466087r86"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Total</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">was</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466088r87"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466089r88"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466090r89"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466091r90"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466092r91"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466093r92"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466094r93"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466095r94"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466096r95"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466097r96"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466098r97"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466099r98"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466100r99"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466101r100"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466102r101"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466103r102"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466104r103"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466105r104"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466106r105"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_need_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_idx</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">old_idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466107r106"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466108r107"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">old_idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466109r108"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466110r109"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466111r110"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Get</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">location</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indices</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466112r111"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">virtq_used_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466113r112"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466114r113"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">backwards</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466115r114"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466116r115"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466117r116"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466118r117"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">virtq_avail_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466119r118"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466120r119"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">backwards</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466121r120"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*)</span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466122r121"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466123r122"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">endif</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span>
</div>
                                                                  

                                                                  
<a 
 id="x1-466124r443"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix B</span>. <a 
 id="x1-467000B"></a>Creating New Device Types</h2>
Various considerations are necessary when creating a new device type.
<a 
 id="x1-467001r471"></a>
<h3 class="sectionHead"><span class="titlemark">B.1   </span> <a 
 id="x1-4680001"></a>How Many Virtqueues?</h3>
<!--l. 8--><p class="nopar" >It is possible that a very simple device will operate entirely through its device
configuration space, but most will need at least one virtqueue in which it
will place requests. A device with both input and output (eg. console and
network devices described here) need two queues: one which the driver fills with
buffers to receive input, and one which the driver places buffers to transmit
output.
<a 
 id="x1-468001r475"></a>
<h3 class="sectionHead"><span class="titlemark">B.2   </span> <a 
 id="x1-4690002"></a>What Device Configuration Space Layout?</h3>
<!--l. 18--><p class="nopar" >Device configuration space should only be used for initialization-time parameters. It
is a limited resource with no synchronization between field written by the driver, so
for most uses it is better to use a virtqueue to update configuration information (the
network device does this for filtering, otherwise the table in the config space could
potentially be very large).
<!--l. 25--><p class="noindent" >Remember that configuration fields over 32 bits wide might not be atomically
writable by the driver. Therefore, no writeable field which triggers an action ought to
be wider than 32 bits.
<a 
 id="x1-469001r476"></a>
<h3 class="sectionHead"><span class="titlemark">B.3   </span> <a 
 id="x1-4700003"></a>What Device Number?</h3>
<!--l. 31--><p class="nopar" >Device numbers can be reserved by the OASIS committee: email
virtio-dev@lists.oasis-open.org to secure a unique one.
<!--l. 34--><p class="noindent" >Meanwhile for experimental drivers, use 65535 and work backwards.
<a 
 id="x1-470001r477"></a>
<h3 class="sectionHead"><span class="titlemark">B.4   </span> <a 
 id="x1-4710004"></a>How many MSI-X vectors? (for PCI)</h3>
<!--l. 38--><p class="nopar" >Using the optional MSI-X capability devices can speed up interrupt processing by
removing the need to read ISR Status register by guest driver (which might be an
expensive operation), reducing interrupt sharing between devices and queues within
the device, and handling interrupts from multiple CPUs. However, some systems
impose a limit (which might be as low as 256) on the total number of MSI-X vectors
that can be allocated to all devices. Devices and/or drivers should take this into
account, limiting the number of vectors used unless the device is expected
to cause a high volume of interrupts. Devices can control the number of
                                                                  

                                                                  
vectors used by limiting the MSI-X Table Size or not presenting MSI-X
capability in PCI configuration space. Drivers can control this by mapping events
to as small number of vectors as possible, or disabling MSI-X capability
altogether.
<a 
 id="x1-471001r478"></a>
<h3 class="sectionHead"><span class="titlemark">B.5   </span> <a 
 id="x1-4720005"></a>Device Improvements</h3>
<!--l. 56--><p class="nopar" >Any change to device configuration space, or new virtqueues, or behavioural changes,
should be indicated by negotiation of a new feature bit. This establishes
clarity<span class="footnote-mark"><a 
href="#fn19x9" id="fn19x9-bk"><sup class="textsuperscript">19</sup></a></span><a 
 id="x1-472001f19"></a>
and avoids future expansion problems.
<!--l. 62--><p class="noindent" >Clusters of functionality which are always implemented together can use a single bit,
but if one feature makes sense without the others they should not be gratuitously
grouped together to conserve feature bits.
                                                                  

                                                                  
<a 
 id="x1-472002r443"></a>
<!--l. 4--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix C</span>. <a 
 id="x1-473000C"></a>Acknowledgements</h2>
The following individuals have participated in the creation of this specification and
are gratefully acknowledged:
<a 
 id="Q1-1-481"></a>
<h4 class="likesubsectionHead"><a 
 id="x1-474000C"></a>Participants</h4>
<!--l. 9--><p class="nopar" >Allen Chia, Oracle <br 
class="newline" />Amit Shah, Red Hat <br 
class="newline" />Amos Kong, Red Hat <br 
class="newline" />Anthony Liguori, IBM <br 
class="newline" />Bruce Rogers, SUSE <br 
class="newline" />Bryan Venteicher, NetApp <br 
class="newline" />Chandra Thyamagondlu, Xilinx <br 
class="newline" />Chet Ensign, OASIS <br 
class="newline" />Cornelia Huck, Red Hat <br 
class="newline" />Cunming, Liang, Intel <br 
class="newline" />Damjan, Marion, Cisco <br 
class="newline" />Daniel Kiper, Oracle <br 
class="newline" />Fang Chen, Huawei <br 
class="newline" />Fang You, Huawei <br 
class="newline" />Geoff Brown, M2Mi <br 
class="newline" />Gerd Hoffmann, Red Hat <br 
class="newline" />Gershon Janssen, Individual Member <br 
class="newline" />Grant Likely, ARM <br 
class="newline" />Haggai Eran, Mellanox <br 
class="newline" />Halil Pasic, IBM <br 
class="newline" />James Bottomley, Parallels IP Holdings GmbH <br 
class="newline" />Jani Kokkonen, Huawei <br 
class="newline" />Jan Kiszka, Siemens AG <br 
class="newline" />Jens Freimann, Red Hat <br 
class="newline" />Jian Zhou, Huawei <br 
class="newline" />Karen Xie, Xilinx <br 
class="newline" />Kumar Sanghvi, Xilinx <br 
class="newline" />Lei Gong, Huawei <br 
class="newline" />Lior Narkis, Mellanox <br 
class="newline" />Luiz Capitulino, Red Hat <br 
class="newline" />Marc-André Lureau, Red Hat <br 
class="newline" />Mark Gray, Intel <br 
class="newline" />Michael S. Tsirkin, Red Hat <br 
class="newline" />Mihai Carabas, Oracle <br 
class="newline" />Nishank Trivedi, NetApp <br 
class="newline" />Paolo Bonzini, Red Hat <br 
class="newline" />Paul Mundt, Huawei <br 
class="newline" />Pawel Moll, ARM <br 
class="newline" />Peng Long, Huawei <br 
class="newline" />Piotr Uminski, Intel <br 
class="newline" />Qian Xum, Intel <br 
class="newline" />Richard Sohn, Alcatel-Lucent <br 
class="newline" />Rusty Russell, IBM <br 
class="newline" />Sasha Levin, Oracle <br 
class="newline" />Sergey Tverdyshev, Thales e-Security <br 
class="newline" />Stefan Hajnoczi, Red Hat <br 
class="newline" />Sundar Mohan, Xilinx <br 
class="newline" />Tom Lyon, Samya Systems, Inc. <br 
class="newline" />Victor Kaplansky, Red Hat <br 
class="newline" />Vijay Balakrishna, Oracle <br 
class="newline" />Wei Wang, Intel <br 
class="newline" />Xin Zeng, Intel <br 
class="newline" />
<!--l. 62--><p class="noindent" >The following non-members have provided valuable feedback on this specification and
are gratefully acknowledged:
<a 
 id="Q1-1-483"></a>
<h4 class="likesubsectionHead"><a 
 id="x1-475000C"></a>Reviewers</h4>
<!--l. 66--><p class="nopar" >Aaron Conole, Red Hat <br 
class="newline" />Adam Tao, Huawei <br 
class="newline" />Alexander Duyck, Intel <br 
class="newline" />Andreas Pape, ADITG/ESB <br 
class="newline" />Andrew Thornton, Google <br 
class="newline" />Arun Subbarao, LynuxWorks <br 
class="newline" />Baptiste Reynal, Virtual Open Systems <br 
class="newline" />Bharat Bhushan, NXP Semiconductors <br 
class="newline" />Brian Foley, ARM <br 
class="newline" />Chandra Thyamagondlu, Xilinx <br 
class="newline" />Changpeng Liu, Intel <br 
class="newline" />Christian Pinto, Virtual Open Systems <br 
class="newline" />Christoffer Dall, ARM <br 
class="newline" />Christoph Hellwig, Individual <br 
class="newline" />Christian Borntraeger, IBM <br 
class="newline" />Daniel Marcovitch, Mellanox <br 
class="newline" />David Alan Gilbert, Red Hat <br 
class="newline" />David Hildenbrand, Red Hat <br 
class="newline" />David Riddoch, Solarflare <br 
class="newline" />Denis V. Lunev, OpenVZ <br 
class="newline" />Dmitry Fleytman, Red Hat <br 
class="newline" />Don Wallwork, Broadcom <br 
class="newline" />Emily Drea, ARM <br 
class="newline" />Eric Auger, Red Hat <br 
class="newline" />Fam Zheng, Red Hat <br 
class="newline" />Francesco Fusco, Red Hat <br 
class="newline" />Frank Yang, Google <br 
class="newline" />Gil Savir, Intel <br 
class="newline" />Gonglei (Arei), Huawei <br 
class="newline" />Greg Kurz, IBM <br 
class="newline" />Hannes Reiencke, SUSE <br 
class="newline" />Ian Campbell, Docker <br 
class="newline" />Ilya Lesokhin, Mellanox <br 
class="newline" />Jacques Durand, Fujutsu <br 
class="newline" />Jakub Jermar, Kernkonzept <br 
class="newline" />Jan Scheurich, Ericsson <br 
class="newline" />Jason Baron, Akamai <br 
class="newline" />Jason Wang, Red Hat <br 
class="newline" />Jean-Philippe Brucker, ARM <br 
class="newline" />Jianfeng Tan, intel <br 
class="newline" />Jonathan Helman, Oracle <br 
class="newline" />Karandeep Chahal, DDN <br 
class="newline" />Kevin Lo, MSI <br 
class="newline" />Kevin Tian, Intel <br 
class="newline" />Kully Dhanoa, Intel <br 
class="newline" />Laura Novich, Red Hat <br 
class="newline" />Ladi Prosek, Red Hat <br 
class="newline" />Lars Ganrot, Napatech <br 
class="newline" />Longpeng (Mike), Huawei <br 
class="newline" />Mario Torrecillas Rodriguez, ARM <br 
class="newline" />Mark Rustad, Intel <br 
class="newline" />Maxime Coquelin, Red Hat <br 
class="newline" />Namhyung Kim, LG <br 
class="newline" />Ola Liljedahl, ARM <br 
class="newline" />Pankaj Gupta, Red Hat <br 
class="newline" />Patrick Durusau, OASIS <br 
class="newline" />Pierre Pfister, Cisco <br 
class="newline" />Pranavkumar Sawargaonkar, Linaro <br 
class="newline" />Rauchfuss Holm, Huawei <br 
class="newline" />Rob Miller, Broadcom <br 
class="newline" />Roman Kiryanov, Google <br 
class="newline" />Robin Cover, OASIS <br 
class="newline" />Roger S Chien, Intel <br 
class="newline" />Sameeh Jubran, Red Hat / Daynix <br 
class="newline" />Si-Wei Liu, Oracle <br 
class="newline" />Sridhar Samudrala, Intel <br 
class="newline" />Stefan Fritsch, Individual <br 
class="newline" />Stefano Garzarella, Red Hat <br 
class="newline" />Steven Luong, Cisco <br 
class="newline" />Thomas Huth, Red Hat <br 
class="newline" />Tiwei Bie, Intel <br 
class="newline" />Tomáš Golembiovský, Red Hat <br 
class="newline" />Venu Busireddy, Oracle <br 
class="newline" />Victor Kaplansky, Red Hat <br 
class="newline" />Vijayabhaskar Balakrishna, Oracle <br 
class="newline" />Vlad Yasevich, Red Hat <br 
class="newline" />Yan Vugenfirer, Red Hat / Daynix <br 
class="newline" />Wei Xu, Red Hat <br 
class="newline" />Will Deacon, ARM <br 
class="newline" />Willem de Bruijn, Google <br 
class="newline" />Yuanhan Liu, Intel <br 
class="newline" />Yuri Benditovich, Red Hat / Daynix <br 
class="newline" />Zhi Yong Wu, IBM <br 
class="newline" />Zhoujian, Huawei <br 
class="newline" />
                                                                  

                                                                  
<a 
 id="x1-475001r443"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix D</span>. <a 
 id="x1-476000D"></a>Revision History</h2>
The following changes have been made since the previous version of this
specification:
<a 
 id="x1-476001r1"></a><!--l. 8--><div class="longtable"> <table id="TBL-21" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-21-1g"><col 
id="TBL-21-1"></colgroup><colgroup id="TBL-21-2g"><col 
id="TBL-21-2"></colgroup><colgroup id="TBL-21-3g"><col 
id="TBL-21-3"></colgroup><colgroup id="TBL-21-4g"><col 
id="TBL-21-4"></colgroup>
                                                                  

                                                                  
<tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-1-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-1-1"  
class="td11"> <span 
class="aebx-10">Revision  </span></td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-1-2"  
class="td11"> <span 
class="aebx-10">Date  </span></td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-1-3"  
class="td11"> <span 
class="aebx-10">Editor  </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-21-1-4"  
class="td11">
 <!--l. 8--><p class="noindent" ><span 
class="aebx-10">Changes Made</span>                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-2-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-2-1"  
class="td11">         </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-21-3-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-3-1"  
class="td11">          </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-3-2"  
class="td11">       </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-3-3"  
class="td11">        </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-3-4"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-21-4-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-4-1"  
class="td11"> 5c43ad7  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-4-2"  
class="td11"> 27 Feb 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-4-3"  
class="td11">    Halil Pasic       </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-4-4"  
class="td11">
 <!--l. 1--><p class="noindent" >ccw: be more precise about the
  semantic of revision 1
  <!--l. 4--><p class="noindent" >Revision
  1  of  the  CCW  transport  is
  currently defined as virtio 1.0.
  This  could  become  confusing
  when  we  bump  the  version  of
  the  virtio  specification  to  1.1,
  in  a  sense  that  it  could  be
  interpreted like one can not use
  any features not part of the 1.0
  specification.
  <!--l. 9--><p class="noindent" >So let us try to avoid confusion
  regarding    the    semantic    of
  virtio-ccw revision 1.
  <!--l. 12--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-163" class="url" >https://issues.oasis-open.org/browse/VIRTIO-163</a>
  <!--l. 14--><p class="noindent" >Signed-off-by:     Halil     Pasic
  <pasic@linux.vnet.ibm.com>
  <!--l. 16--><p class="noindent" >Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 18--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 20--><p class="noindent" >See <a 
href="#x1-1690001">4.3.2.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision --></a>.
  <!--l. 23--><p class="noindent" >                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-5-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-5-1"  
class="td11"> d348ac0  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-5-2"  
class="td11"> 27 Feb 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-5-3"  
class="td11">    Halil Pasic       </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-5-4"  
class="td11">
 <!--l. 24--><p class="noindent" >introduction:     simplify     the
  designation of legacy
  <!--l. 27--><p class="noindent" >The  sentence  designating  the
  documents  defining  what  later
  became  known  as  the  legacy
  virtio  interface  had  the  most
  important piece of information
  placed in parenthesis.
  <!--l. 31--><p class="noindent" >Let’s  reword  this  sentence  so
  we  avoid  using  an  ambiguous
  designation based on a relative
  anchor (i.e. ’earlier drafts of this
  specification’) and just use the
  absolute anchor (version 1.0).
  <!--l. 35--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-164" class="url" >https://issues.oasis-open.org/browse/VIRTIO-164</a>
  <!--l. 37--><p class="noindent" >Signed-off-by:     Halil     Pasic
  <pasic@linux.vnet.ibm.com>
  <!--l. 39--><p class="noindent" >Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 41--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 43--><p class="noindent" >See <a 
href="#x1-60001">1.3.1<!--tex4ht:ref: intro:Legacy Interface: Terminology --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-6-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-6-1"  
class="td11">  bef3ff7   </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-6-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-6-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-6-4"  
class="td11">
 <!--l. 46--><p class="noindent" >virtio-blk: document data[] size
  constraints
  <!--l. 49--><p class="noindent" >The                             struct
  virtio_blk_req->data[] field is a
  multiple  of  512  bytes  long  for
  read and write requests. Flush
  requests don’t use data[] at all.
  <!--l. 52--><p class="noindent" >The           new           discard
  and write zeroes requests being
  introduced in VIRTIO 1.1 put
  struct
  virtio_blk_discard_write_zeroes
  elements into data[], so it must
  be a multiple of the struct size.
  <!--l. 56--><p class="noindent" >The                           uint8_t
  data[][512]  pseudo-code  makes
  it  look  like  discard  and  write
  zeroes  requests  must  pad  to
  512 bytes. This wastes memory
  since                           struct
  virtio_blk_discard_write_data  is
  only 16 bytes long.
  <!--l. 60--><p class="noindent" >Furthermore,      all      known
  implementations    wishing    to
  take advantage of this upcoming
  VIRTIO   1.1   feature   do   not
  use  512-byte  padding  (Linux
  virtio_blk.ko, QEMU virtio-blk
  device  emulation,  the  SPDK
  virtio-blk driver, and the SPDK
  vhost-user-blk device backend).
  <!--l. 65--><p class="noindent" >This   patch   documents   the
  data[]  size  constraints  clearly
  in the driver normative section.
  This is clearer than the current
  pseudo-code.
  <!--l. 68--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/32" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/32</a>
  <!--l. 70--><p class="noindent" >Cc:     Michael     S.     Tsirkin
  <mst@redhat.com>
  <!--l. 72--><p class="noindent" >Cc:         Changpeng         Liu
  <changpeng.liu@intel.com>
  <!--l. 74--><p class="noindent" >Cc:       Stefano       Garzarella
  <sgarzare@redhat.com>
  <!--l. 76--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 78--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 80--><p class="noindent" >See <a 
href="#x1-2550006">5.2.6<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-7-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-7-1"  
class="td11"> c5c0ce7   </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-7-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-7-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-7-4"  
class="td11">
 <!--l. 83--><p class="noindent" >virtio-blk:                      move
  virtio_blk_discard_write_zeroes
  definition
  <!--l. 86--><p class="noindent" >struct
  virtio_blk_discard_write_zeroes
  is         defined         alongside
  struct  virtio_blk_req  but  only
  discussed later in the text. Move
  it to where it belongs.
  <!--l. 90--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/32" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/32</a>
  <!--l. 92--><p class="noindent" >Suggested-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 94--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 96--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 98--><p class="noindent" >See <a 
href="#x1-2550006">5.2.6<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-8-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-8-1"  
class="td11">  caffe5c   </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-8-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-8-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-8-4"  
class="td11">
 <!--l. 101--><p class="noindent" >virtio-blk: describe write zeroes
  unmap semantics
  <!--l. 104--><p class="noindent" >Explain
  the meaning of the unmap flag.
  The details are already covered
  in the device normative section
  but  mentioning  it  here  makes
  the text easier to understand.
  <!--l. 108--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/32" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/32</a>
  <!--l. 110--><p class="noindent" >Suggested-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 112--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 114--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 116--><p class="noindent" >See <a 
href="#x1-2550006">5.2.6<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-9-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-9-1"  
class="td11"> 5f1e981   </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-9-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-9-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-9-4"  
class="td11">
 <!--l. 119--><p class="noindent" >virtio-blk:   avoid   inconsistent
  "DISCARD" term
  <!--l. 122--><p class="noindent" >"discard"  (lowercase)  is  used
  throughout  the  text.  Remove
  a lone instance of "DISCARD"
  (uppercase).
  <!--l. 125--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/32" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/32</a>
  <!--l. 127--><p class="noindent" >Suggested-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 129--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 131--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 133--><p class="noindent" >See <a 
href="#x1-2550006">5.2.6<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-10-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-10-1"  
class="td11"> 31a52d2  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-10-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-10-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-10-4"  
class="td11">
 <!--l. 136--><p class="noindent" >virtio-blk:    clarify    semantics
  of multi-segment discard/write
  zeroes commands
  <!--l. 139--><p class="noindent" >Describe  the  failure  case  and
  maximum                   number
  of segments in a multi-segment
  discard/write zeroes command.
  <!--l. 142--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/34" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/34</a>
  <!--l. 144--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 146--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 148--><p class="noindent" >See <a 
href="#x1-2560001">5.2.6.1<!--tex4ht:ref: drivernormative:Device Types / Block Device / Device Operation --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-11-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-11-1"  
class="td11"> 90047f5  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-11-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-11-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-11-4"  
class="td11">
 <!--l. 151--><p class="noindent" >format:  replace  "-  i.e."  with  ",
  i.e.,"
  <!--l. 154--><p class="noindent" >This seems to be preferred by
  native speakers, and seems just
  as effective as a sentence device.
  <!--l. 157--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-171" class="url" >https://issues.oasis-open.org/browse/VIRTIO-171</a>
  Signed-off-by:     Michael     S.
  Tsirkin     <mst@redhat.com>
  Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 162--><p class="noindent" >                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-12-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-12-1"  
class="td11"> c7b2503  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-12-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-12-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-12-4"  
class="td11">
 <!--l. 163--><p class="noindent" >conformance:    add    links    to
  crypto and input devices
  <!--l. 166--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-174" class="url" >https://issues.oasis-open.org/browse/VIRTIO-174</a>
  <!--l. 168--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 170--><p class="noindent" >Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 172--><p class="noindent" >See <a 
href="#x1-4380001">7.1<!--tex4ht:ref: sec:Conformance / Conformance Targets --></a>.                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-13-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-13-1"  
class="td11"> 0b5288f  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-13-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-13-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-13-4"  
class="td11">
 <!--l. 175--><p class="noindent" >signal    start    and    end    of
  structures consistently
  <!--l. 178--><p class="noindent" >Make sure all structs have the
  format:
  <!--l. 180--><p class="noindent" >struct X .
  <!--l. 182--><p class="noindent" >... };
  <!--l. 185--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-170" class="url" >https://issues.oasis-open.org/browse/VIRTIO-170</a>
  Signed-off-by:     Michael     S.
  Tsirkin     <mst@redhat.com>
  Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 190--><p class="noindent" >See <a 
href="#x1-3180002">5.6.6.2<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: controlq --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-14-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-14-1"  
class="td11"> 69daf06  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-14-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-14-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-14-4"  
class="td11">
 <!--l. 193--><p class="noindent" >editorial: explain each structure
  before use
  <!--l. 195--><p class="noindent" >Several   structures   are   listed
  before  they  are  introduced  in
  some   way.   Add   a   sentence
  before  each  one  so  they  don’t
  appear prior to any prose.
  <!--l. 199--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-166" class="url" >https://issues.oasis-open.org/browse/VIRTIO-166</a>
  Signed-off-by:     Michael     S.
  Tsirkin     <mst@redhat.com>
  Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 204--><p class="noindent" >See  <a 
href="#x1-2220005">5.1.6.5<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue --></a>,  <a 
href="#x1-430008">2.6.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>,  <a 
href="#x1-3650005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>,  <a 
href="#x1-3290004">5.7.4<!--tex4ht:ref: sec:Device Types / GPU Device / Device configuration layout --></a>,
  <a 
href="#x1-3400007">5.7.6.7<!--tex4ht:ref: sec:Device Types / GPU Device / Device Operation / Device Operation: Request header --></a>, <a 
href="#x1-3400007">5.7.6.7<!--tex4ht:ref: sec:Device Types / GPU Device / Device Operation / Device Operation: Request header --></a> amd <a 
href="#x1-3990004">5.10.4<!--tex4ht:ref: sec:Device Types / Socket Device / Device configuration layout --></a>.        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-15-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-15-1"  
class="td11"> d608f47  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-15-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-15-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-15-4"  
class="td11">
 <!--l. 213--><p class="noindent" >conformance:  tweak  to  match
  OASIS requirements
  <!--l. 216--><p class="noindent" >Number clauses as required by
  OASIS.
  <!--l. 218--><p class="noindent" >Also  reference  the  transitional
  clause.
  <!--l. 220--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-168" class="url" >https://issues.oasis-open.org/browse/VIRTIO-168</a>
  <!--l. 222--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 224--><p class="noindent" >Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 226--><p class="noindent" >Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 228--><p class="noindent" >See <a 
href="#x1-4370007">7<!--tex4ht:ref: sec:Conformance --></a>.                                    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-16-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-16-1"  
class="td11"> 0dbd52d  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-16-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-16-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-16-4"  
class="td11">
 <!--l. 231--><p class="noindent" >introduction:   update   link   to
  IEEE 802
  <!--l. 234--><p class="noindent" >Looks  like  all  GETIEEE  links
  got broken. Let’s just point to
  their main page.
  <!--l. 237--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-175" class="url" >https://issues.oasis-open.org/browse/VIRTIO-175</a>
  <!--l. 239--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 241--><p class="noindent" >Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 243--><p class="noindent" >Reviewed-by:   Jens   Freimann
  <jfreimann@redhat.com>
  <!--l. 245--><p class="noindent" >See <a 
href="#x1-30001">1.1<!--tex4ht:ref: sec:Normative References --></a>.                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-17-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-17-1"  
class="td11"> 7b361ea  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-17-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-17-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-17-4"  
class="td11">
 <!--l. 248--><p class="noindent" >editorial: upgrade links to https
  <!--l. 251--><p class="noindent" >Several     links     have     been
  upgraded  and  now  redirect  to
  the https version. Upgrade our
  version accordingly.
  <!--l. 254--><p class="noindent" >Note   that   some   other   links
  use  the  status  301  -  moved
  permanently apparently in error
  (e.g.  for  a  language  specific
  redirect), not updating these.
  <!--l. 258--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-173" class="url" >https://issues.oasis-open.org/browse/VIRTIO-173</a>
  <!--l. 260--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 262--><p class="noindent" >Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 264--><p class="noindent" >Reviewed-by:   Jens   Freimann
  <jfreimann@redhat.com>
  <!--l. 266--><p class="noindent" >See <a 
href="#x1-1doc"><!--tex4ht:ref: sec:Chair --></a>.                                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-18-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-18-1"  
class="td11"> 3e49aec  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-18-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-18-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-18-4"  
class="td11">
 <!--l. 269--><p class="noindent" >conformance:    fix    confusion
  about legacy interface
  <!--l. 272--><p class="noindent" >The text describing the legacy
  interface also obliquely refers to
  a                   non-transitional
  implementation. This seems to
  cause confusion and there’s no
  good reason to do it here: this
  section is about legacy interface
  and transitional devices, it add
  not value at all. Just drop it.
  <!--l. 278--><p class="noindent" >Note:  the  spec  does  not  make
  it clear whether description of
  the legacy interface is normative
  or  not,  and  in  particular,  this
  section is not linked to from any
  conformance targets. Resolving
  that is left for later.
  <!--l. 283--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-167" class="url" >https://issues.oasis-open.org/browse/VIRTIO-167</a>
  <!--l. 285--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 287--><p class="noindent" >Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 289--><p class="noindent" >Acked-by:        Halil        Pasic
  <pasic@linux.ibm.com>
  <!--l. 291--><p class="noindent" >See <a 
href="#x1-4650004">7.4<!--tex4ht:ref: sec:Conformance / Legacy Interface: Transitional Device and Transitional Driver Conformance --></a>.                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-19-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-19-1"  
class="td11"> 4cc8a4d  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-19-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-21-19-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-21-19-4"  
class="td11">
 <!--l. 294--><p class="noindent" >block: drop duplicate text
  <!--l. 297--><p class="noindent" >In version 1.1 draft 01 - Section
  5.2.6.4 - second bullet:
  <!--l. 299--><p class="noindent" >Duplicated
  text "errors, data_len, sense_len
  and residual MUST reside in a
  single, separate device-writable
  descriptor"  appears  +both  in
  the beginning and at the end of
  the 2nd sentence.
  <!--l. 303--><p class="noindent" >The original text:
  <!--l. 305--><p class="noindent" >For SCSI commands there are
  additional  constraints.  errors,
  data_len, sense_len and residual
  MUST       reside       in       a
  single, separate device-writable
  descriptor,  sense  MUST  reside
  in                                     a
  single  separate  device-writable
  descriptor   of   size   96   bytes,
  and  errors,  data_len,  sense_len
  and  residual  MUST  reside  a
  single  separate  device-writable
  descriptor.  I  suggest  to  delete
  the  1st  one,  so  in  the  end
  result,  fields  are  described  in
  same order as appear in struct
  virtio_scsi_pc_req.
  <!--l. 313--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/39" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/39</a>
  <!--l. 315--><p class="noindent" >Reported-by:       Gil       Savir
  <gil.savir@intel.com>
  <!--l. 317--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 319--><p class="noindent" >See <a 
href="#x1-2590004">5.2.6.4<!--tex4ht:ref: sec:Device Types / Block Device / Legacy Interface: Framing Requirements --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-21-20-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-20-1"  
class="td11">        </td>                                                      

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-21-21-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-21-1"  
class="td11">        </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-21-22-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-22-1"  
class="td11">        </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-21-23-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-23-1"  
class="td11">        </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-21-24-"><td  style="white-space:nowrap; text-align:center;" id="TBL-21-24-1"  
class="td11">        </td>
</tr>
</table></div>
                                                                  

                                                                  
<div class="footnotes"><!--l. 13--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn1x1-bk" id="fn1x1"><sup class="textsuperscript">1</sup></a></span><span 
class="aer-8">This lack of page-sharing implies that the implementation of the device (e.g. the hypervisor</span>
<span 
class="aer-8">or host) needs full access to the guest memory. Communication with untrusted parties (i.e.</span>
<span 
class="aer-8">inter-guest communication) requires copying.</span>
<!--l. 27--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn2x1-bk" id="fn2x1"><sup class="textsuperscript">2</sup></a></span><span 
class="aer-8">The Linux implementation further separates the virtio transport code from the specific</span>
<span 
class="aer-8">virtio drivers: these drivers are shared between different transports.</span>
<!--l. 277--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn3x2-bk" id="fn3x2"><sup class="textsuperscript">3</sup></a></span><span 
class="aer-8">For example, the simplest network device has one virtqueue for transmit and one for</span>
<span 
class="aer-8">receive.</span>
<!--l. 49--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn4x2-bk" id="fn4x2"><sup class="textsuperscript">4</sup></a></span><span 
class="aer-8">For example, if Queue Size is 4 then at most 4 buffers can be queued at any given</span>
<span 
class="aer-8">time.</span>
<!--l. 388--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn5x2-bk" id="fn5x2"><sup class="textsuperscript">5</sup></a></span><span 
class="aer-8">For example, if Queue Size is 4 then at most 4 buffers can be queued at any given</span>
<span 
class="aer-8">time.</span>
<!--l. 1395--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn6x4-bk" id="fn6x4"><sup class="textsuperscript">6</sup></a></span><span 
class="aer-8">For example, the simplest network device has two virtqueues.</span>
<!--l. 1426--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn7x4-bk" id="fn7x4"><sup class="textsuperscript">7</sup></a></span><span 
class="aer-8">The 4096 is based on the x86 page size, but it’s also large enough to ensure that the separate</span>
<span 
class="aer-8">parts of the virtqueue are on separate cache lines.</span>
<!--l. 3102--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn8x5-bk" id="fn8x5"><sup class="textsuperscript">8</sup></a></span><span 
class="aer-8">Due to various bugs in implementations, this field is not useful as a guarantee of the</span>
<span 
class="aer-8">transport header size.</span>
<!--l. 3110--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn9x5-bk" id="fn9x5"><sup class="textsuperscript">9</sup></a></span><span 
class="aer-8">This case is not handled by some older hardware, so is called out specifically in the</span>
<span 
class="aer-8">protocol.</span>
<!--l. 3550--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn10x5-bk" id="fn10x5"><sup class="textsuperscript">10</sup></a></span><span 
class="aer-8">Since there are no guarantees, it can use a hash filter or silently switch to allmulti or</span>
<span 
class="aer-8">promiscuous mode if it is given too many addresses.</span>
<!--l. 3956--><p class="nopar" ><span class="footnote-mark"><a 
href="#fn11x5-bk" id="fn11x5"><sup class="textsuperscript">11</sup></a></span><span 
class="aer-8">Consistent with </span><a 
href="#x1-2570002"><span 
class="aer-8">5.2.6.2</span><!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Operation --></a><span 
class="aer-8">, a writethrough cache can be defined broadly as a cache that</span>
<span 
class="aer-8">commits writes to persistent device backend storage before reporting their completion. For</span>
<span 
class="aer-8">example, a battery-backed writeback cache actually counts as writethrough according to this</span>
<span 
class="aer-8">definition.</span>
<!--l. 4195--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn12x5-bk" id="fn12x5"><sup class="textsuperscript">12</sup></a></span><span 
class="aer-8">Note that in this case, according to </span><a 
href="#x1-2530002"><span 
class="aer-8">5.2.5.2</span><!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Initialization --></a><span 
class="aer-8">, the device will not have offered</span>
<span 
class="aer-8">VIRTIO_BLK_F_CONFIG_WCE either.</span>
<!--l. 4451--><p class="nopar" ><span class="footnote-mark"><a 
href="#fn13x5-bk" id="fn13x5"><sup class="textsuperscript">13</sup></a></span><span 
class="aer-8">Because this is high importance and low bandwidth, the current Linux implementation</span>
<span 
class="aer-8">polls  for  the  buffer  to  become  used,  rather  than  waiting  for  a  used  buffer  notification,</span>
<span 
class="aer-8">simplifying  the  implementation  significantly.  However,  for  generic  serial  ports  with  the</span>
<span 
class="aer-8">O_NONBLOCK flag set, the polling limitation is relaxed and the consumed buffers are freed</span>
<span 
class="aer-8">upon the next write or poll call or when a port is closed or hot-unplugged.</span>
<!--l. 4715--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn14x5-bk" id="fn14x5"><sup class="textsuperscript">14</sup></a></span><span 
class="aer-8">This is historical, and independent of the guest page size.</span>
<!--l. 4731--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn15x5-bk" id="fn15x5"><sup class="textsuperscript">15</sup></a></span><span 
class="aer-8">In this case, deflation advice is merely a courtesy.</span>
<!--l. 5105--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn16x5-bk" id="fn16x5"><sup class="textsuperscript">16</sup></a></span><span 
class="aer-8">For example, INQUIRY or REPORT LUNS.</span>
<!--l. 5106--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn17x5-bk" id="fn17x5"><sup class="textsuperscript">17</sup></a></span><span 
class="aer-8">For example, I_T RESET.</span>
<!--l. 5245--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn18x5-bk" id="fn18x5"><sup class="textsuperscript">18</sup></a></span><span 
class="aer-8">There is no separate residual size for </span><span 
class="aeti8-">pi_bytesout </span><span 
class="aer-8">and </span><span 
class="aeti8-">pi_bytesin</span><span 
class="aer-8">. It can be computed from the</span>
<span 
class="aeti8-">residual </span><span 
class="aer-8">field, the size of the data integrity information per sector, and the sizes of </span><span 
class="aeti8-">pi_out</span><span 
class="aer-8">, </span><span 
class="aeti8-">pi_in</span><span 
class="aer-8">,</span>
<span 
class="aeti8-">dataout </span><span 
class="aer-8">and </span><span 
class="aeti8-">datain</span><span 
class="aer-8">.</span>
<!--l. 60--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn19x9-bk" id="fn19x9"><sup class="textsuperscript">19</sup></a></span><span 
class="aer-8">Even if it does mean documenting design or implementation mistakes!</span>             </div>
 
</body></html> 

                                                                  


