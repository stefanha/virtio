<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head>
<title>Virtual I/O Device (VIRTIO) Version 1.0</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<!-- info,charset=utf-8,fn-in,html --> 
<meta name="src" content="virtio-v1.0-cs04.tex"> 
<link rel="stylesheet" type="text/css" href="virtio-v1.0-cs04.css"> 
</head><body 
>
<!--l. 1--><p class="noindent" >
                                                                  

                                                                  
<!--l. 4--><p class="noindent" ><table style="border-collapse:collapse;"><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ><img 
src="images/oasis.png" alt="PIC"  
>  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<!--l. 9--><p class="noindent" ><div style="color: #552681; font-size: 24pt;"> <span 
class="aebx-10">Virtual I/O Device (VIRTIO) Version 1.0 </span></div>
<!--l. 10--><p class="noindent" ><div style="color: #552681; font-size: 18pt;"> <span 
class="aebx-10">Committee Specification 04 </span></div>
<!--l. 12--><p class="noindent" ><div style="color: #552681; font-size: 18pt;"> <span 
class="aebx-10">03 March 2016 </span></div>
<!--l. 14--><p class="noindent" ><div style="color: #552681; font-size: 12pt;"> <span 
class="aebx-10">Specification URIs </span></div>
<!--l. 16--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">This version: </span></div> <div style="margin-left: 20px;">  <a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/tex/" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/tex/</a>
(Authoritative)<br 
class="newline" /><a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/virtio-v1.0-cs04.pdf" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/virtio-v1.0-cs04.pdf</a><br 
class="newline" /><a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/virtio-v1.0-cs04.html" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/virtio-v1.0-cs04.html</a> </div>
<!--l. 22--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Previous version: </span></div> <div style="margin-left: 20px;">  <a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs03/tex/" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs03/tex/</a>
(Authoritative)<br 
class="newline" /><a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs03/virtio-v1.0-cs03.pdf" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs03/virtio-v1.0-cs03.pdf</a><br 
class="newline" /><a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs03/virtio-v1.0-cs03.html" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs03/virtio-v1.0-cs03.html</a> </div>
<!--l. 29--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Latest version: </span></div> <div style="margin-left: 20px;">  <a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.pdf" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.pdf</a><br 
class="newline" /><a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html</a> </div>
<!--l. 34--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Technical Committee: </span></div> <div style="margin-left: 20px;">  <a 
href="https://www.oasis-open.org/committees/virtio/" >OASIS Virtual I/O Device (VIRTIO) TC</a>  </div>
<!--l. 38--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Chairs: </span></div> <div style="margin-left: 20px;">  Michael S. Tsirkin (<a 
href="mailto:mst@redhat.com" >mst@redhat.com</a>), <a 
href="http://www.redhat.com/" >Red Hat</a><br 
class="newline" /> </div>
<!--l. 42--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Editors: </span></div> <div style="margin-left: 20px;">  Michael S. Tsirkin (<a 
href="mailto:mst@redhat.com" >mst@redhat.com</a>), <a 
href="http://www.redhat.com/" >Red Hat</a><br 
class="newline" />Cornelia Huck (<a 
href="mailto:cohuck@redhat.com" >cohuck@redhat.com</a>), <a 
href="http://www.redhat.com/" >Red Hat</a><br 
class="newline" />Pawel Moll (<a 
href="mailto:pawel.moll@arm.com" >pawel.moll@arm.com</a>), <a 
href="http://www.arm.com/" >ARM</a>  </div>
<!--l. 49--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Additional artifacts: </span></div> <div style="margin-left: 20px;">  This prose specification is one component of a Work
Product that also includes:
                                                                  

                                                                  
     <ul class="itemize1">
     <li class="itemize">Example Driver Listing: <br 
class="newline" /><a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/listings/" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/listings/</a></li></ul>
</div>
<!--l. 58--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Related work: </span></div> <div style="margin-left: 20px;">  This specification replaces or supersedes:
     <ul class="itemize1">
     <li class="itemize">Virtio PCI Card Specification Version 0.9.5:<br 
class="newline" /><a 
href="http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf" class="url" >http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf</a></li></ul>
</div>
<!--l. 77--><p class="noindent" >
                                                                  

                                                                  
<!--l. 79--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Abstract: </span></div> <div style="margin-left: 20px;">  This document describes the specifications of the “virtio” family of
devices. These devices are found in virtual environments, yet by design they look like
physical devices to the guest within the virtual machine - and this document treats
them as such. This similarity allows the guest to use standard drivers and discovery
mechanisms.
<!--l. 8--><p class="noindent" >The purpose of virtio and this specification is that virtual environments and guests
should have a straightforward, efficient, standard and extensible mechanism for
virtual devices, rather than boutique per-environment or per-OS mechanisms.   </div>
<!--l. 83--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Status: </span></div> <div style="margin-left: 20px;">  This document was last revised or approved by the Virtual I/O
Device (VIRTIO) TC on the above date. The level of approval is also
listed above. Check the “Latest version” location noted above for possible
later revisions of this document. Any other numbered Versions and other
technical work produced by the Technical Committee (TC) are listed at
<a 
href="https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=virtio#technical" class="url" >https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=virtio#technical</a>.
<!--l. 91--><p class="noindent" >Technical Committee members should send comments on this specification to the
Technical Committee’s email list. Others should send comments to the Technical
Committee by using the “<a 
href="https://www.oasis-open.org/committees/comments/form.php?wg_abbrev=virtio" >Send A Comment</a>” button on the Technical Committee’s
web page at <a 
href="https://www.oasis-open.org/committees/virtio/" class="url" >https://www.oasis-open.org/committees/virtio/</a>.
<!--l. 98--><p class="noindent" >For information on whether any patents have been disclosed that may be
essential to implementing this specification, and any offers of patent licensing
terms, please refer to the Intellectual Property Rights section of the Technical
Committee web page (<a 
href="https://www.oasis-open.org/committees/virtio/ipr.php" class="url" >https://www.oasis-open.org/committees/virtio/ipr.php</a>).  </div>
<!--l. 106--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Citation format: </span></div> <div style="margin-left: 20px;">  When referencing this specification the following citation
format should be used:<br 
class="newline" />
<!--l. 109--><p class="noindent" ><span 
class="aebx-10">[VIRTIO-v1.0]</span><br 
class="newline" /><span 
class="aeti-10">Virtual I/O Device (VIRTIO) Version 1.0</span>. Edited by Rusty Russell, Michael S. Tsirkin,
Cornelia Huck, and Pawel Moll. 03 March 2016. OASIS Committee Specification 04.
<a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/virtio-v1.0-cs04.html" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/virtio-v1.0-cs04.html</a>.
Latest version: <a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html</a>.  </div>
<!--l. 116--><p class="noindent" >
                                                                  

                                                                  
__________________________________________________________________
<!--l. 118--><p class="noindent" ><div style="color: #552681; font-size: 18pt;"> <span 
class="aebx-10">Notices </span></div>
<!--l. 120--><p class="noindent" >Copyright <span 
class="cmsy-10">© </span>OASIS Open 2015. All Rights Reserved.
<!--l. 122--><p class="noindent" >All capitalized terms in the following text have the meanings assigned to them in the
OASIS Intellectual Property Rights Policy (the "OASIS IPR Policy"). The full <a 
href="https://www.oasis-open.org/policies-guidelines/ipr" >Policy</a>
may be found at the OASIS website.
<!--l. 126--><p class="noindent" >This document and translations of it may be copied and furnished to others, and
derivative works that comment on or otherwise explain it or assist in its
implementation may be prepared, copied, published, and distributed, in whole or in
part, without restriction of any kind, provided that the above copyright notice and
this section are included on all such copies and derivative works. However, this
document itself may not be modified in any way, including by removing the copyright
notice or references to OASIS, except as needed for the purpose of developing any
document or deliverable produced by an OASIS Technical Committee (in which case
the rules applicable to copyrights, as set forth in the OASIS IPR Policy,
must be followed) or as required to translate it into languages other than
English.
<!--l. 139--><p class="noindent" >The limited permissions granted above are perpetual and will not be revoked by
OASIS or its successors or assigns.
<!--l. 142--><p class="noindent" >This document and the information contained herein is provided on an "AS IS" basis
and OASIS DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED,
INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF
THE INFORMATION HEREIN WILL NOT INFRINGE ANY OWNERSHIP
RIGHTS OR ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR
FITNESS FOR A PARTICULAR PURPOSE.
<!--l. 149--><p class="noindent" >OASIS requests that any OASIS Party or any other party that believes it has patent
claims that would necessarily be infringed by implementations of this OASIS
Committee Specification or OASIS Standard, to notify OASIS TC Administrator and
provide an indication of its willingness to grant patent licenses to such patent claims
in a manner consistent with the IPR Mode of the OASIS Technical Committee that
produced this specification.
<!--l. 157--><p class="noindent" >OASIS invites any party to contact the OASIS TC Administrator if it is aware of a
claim of ownership of any patent claims that would necessarily be infringed by
implementations of this specification by a patent holder that is not willing to provide
a license to such patent claims in a manner consistent with the IPR Mode of
the OASIS Technical Committee that produced this specification. OASIS
may include such claims on its website, but disclaims any obligation to do
so.
<!--l. 165--><p class="noindent" >OASIS takes no position regarding the validity or scope of any intellectual property
or other rights that might be claimed to pertain to the implementation or use
                                                                  

                                                                  
of the technology described in this document or the extent to which any
license under such rights might or might not be available; neither does it
represent that it has made any effort to identify any such rights. Information on
OASIS’ procedures with respect to rights in any document or deliverable
produced by an OASIS Technical Committee can be found on the OASIS
website. Copies of claims of rights made available for publication and any
assurances of licenses to be made available, or the result of an attempt made to
obtain a general license or permission for the use of such proprietary rights by
implementers or users of this OASIS Committee Specification or OASIS
Standard, can be obtained from the OASIS TC Administrator. OASIS makes no
representation that any information or list of intellectual property rights will at
any time be complete, or that any claims in such list are, in fact, Essential
Claims.
<!--l. 182--><p class="noindent" >The name "OASIS" is a trademark of <a 
href="https://www.oasis-open.org/" >OASIS</a>, the owner and developer of this
specification, and should be used only to refer to the organization and its official
outputs. OASIS welcomes reference to, and implementation and use of, specifications,
while reserving the right to enforce its marks against misleading uses. Please see
<a 
href="https://www.oasis-open.org/policies-guidelines/trademark" class="url" >https://www.oasis-open.org/policies-guidelines/trademark</a> for above guidance.
<br 
class="newline" /><br 
class="newline" />
                                                                  

                                                                  
                                                                  

                                                                  
__________________________________________________________________
<h2 class="likechapterHead"><a 
 id="x1-1000"></a>Table of Contents</h2> <div class="tableofcontents">
<span class="chapterToc" >1 <a 
href="#x1-20001" id="QQ2-1-2">Introduction</a></span>
<br /> <span class="sectionToc" >1.1 <a 
href="#x1-30001" id="QQ2-1-3">Normative References</a></span>
<br /> <span class="sectionToc" >1.2 <a 
href="#x1-40002" id="QQ2-1-4">Non-Normative References</a></span>
<br /> <span class="sectionToc" >1.3 <a 
href="#x1-50003" id="QQ2-1-5">Terminology</a></span>
<br />  <span class="subsectionToc" >1.3.1 <a 
href="#x1-60001" id="QQ2-1-6">Legacy Interface: Terminology</a></span>
<br />  <span class="subsectionToc" >1.3.2 <a 
href="#x1-70002" id="QQ2-1-7">Transition from earlier specification drafts</a></span>
<br /> <span class="sectionToc" >1.4 <a 
href="#x1-80004" id="QQ2-1-8">Structure Specifications</a></span>
<br /><span class="chapterToc" >2 <a 
href="#x1-90002" id="QQ2-1-9">Basic Facilities of a Virtio Device</a></span>
<br /> <span class="sectionToc" >2.1 <a 
href="#x1-100001" id="QQ2-1-10"><span 
class="aeti-10">Device Status </span>Field</a></span>
<br />  <span class="subsectionToc" >2.1.1 <a 
href="#x1-110001" id="QQ2-1-11">Driver Requirements: Device Status Field</a></span>
<br />  <span class="subsectionToc" >2.1.2 <a 
href="#x1-120002" id="QQ2-1-12">Device Requirements: Device Status Field</a></span>
<br /> <span class="sectionToc" >2.2 <a 
href="#x1-130002" id="QQ2-1-13">Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.1 <a 
href="#x1-140001" id="QQ2-1-14">Driver Requirements: Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.2 <a 
href="#x1-150002" id="QQ2-1-15">Device Requirements: Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.3 <a 
href="#x1-160003" id="QQ2-1-16">Legacy Interface: A Note on Feature Bits</a></span>
<br /> <span class="sectionToc" >2.3 <a 
href="#x1-170003" id="QQ2-1-17">Device Configuration Space</a></span>
<br />  <span class="subsectionToc" >2.3.1 <a 
href="#x1-180001" id="QQ2-1-18">Driver Requirements: Device Configuration Space</a></span>
<br />  <span class="subsectionToc" >2.3.2 <a 
href="#x1-190002" id="QQ2-1-19">Device Requirements: Device Configuration Space</a></span>
<br />  <span class="subsectionToc" >2.3.3 <a 
href="#x1-200003" id="QQ2-1-20">Legacy Interface: A Note on Device Configuration Space endian-ness</a></span>
<br />  <span class="subsectionToc" >2.3.4 <a 
href="#x1-210004" id="QQ2-1-21">Legacy Interface: Device Configuration Space</a></span>
                                                                  

                                                                  
<br /> <span class="sectionToc" >2.4 <a 
href="#x1-220004" id="QQ2-1-22">Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.4.1 <a 
href="#x1-230001" id="QQ2-1-23">Driver Requirements: Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.4.2 <a 
href="#x1-240002" id="QQ2-1-24">Legacy Interfaces: A Note on Virtqueue Layout</a></span>
<br />  <span class="subsectionToc" >2.4.3 <a 
href="#x1-250003" id="QQ2-1-25">Legacy Interfaces: A Note on Virtqueue Endianness</a></span>
<br />  <span class="subsectionToc" >2.4.4 <a 
href="#x1-260004" id="QQ2-1-26">Message Framing</a></span>
<br />  <span class="subsectionToc" >2.4.5 <a 
href="#x1-300005" id="QQ2-1-30">The Virtqueue Descriptor Table</a></span>
<br />  <span class="subsectionToc" >2.4.6 <a 
href="#x1-360006" id="QQ2-1-36">The Virtqueue Available Ring</a></span>
<br />  <span class="subsectionToc" >2.4.7 <a 
href="#x1-370007" id="QQ2-1-37">Virtqueue Interrupt Suppression</a></span>
<br />  <span class="subsectionToc" >2.4.8 <a 
href="#x1-400008" id="QQ2-1-40">The Virtqueue Used Ring</a></span>
<br />  <span class="subsectionToc" >2.4.9 <a 
href="#x1-440009" id="QQ2-1-44">Virtqueue Notification Suppression</a></span>
<br />  <span class="subsectionToc" >2.4.10 <a 
href="#x1-4700010" id="QQ2-1-47">Helpers for Operating Virtqueues</a></span>
<br /><span class="chapterToc" >3 <a 
href="#x1-480003" id="QQ2-1-48">General Initialization And Device Operation</a></span>
<br /> <span class="sectionToc" >3.1 <a 
href="#x1-490001" id="QQ2-1-49">Device Initialization</a></span>
<br />  <span class="subsectionToc" >3.1.1 <a 
href="#x1-500001" id="QQ2-1-50">Driver Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >3.1.2 <a 
href="#x1-510002" id="QQ2-1-51">Legacy Interface: Device Initialization</a></span>
<br /> <span class="sectionToc" >3.2 <a 
href="#x1-520002" id="QQ2-1-52">Device Operation</a></span>
<br />  <span class="subsectionToc" >3.2.1 <a 
href="#x1-530001" id="QQ2-1-53">Supplying Buffers to The Device</a></span>
<br />  <span class="subsectionToc" >3.2.2 <a 
href="#x1-600002" id="QQ2-1-60">Receiving Used Buffers From The Device</a></span>
<br />  <span class="subsectionToc" >3.2.3 <a 
href="#x1-610003" id="QQ2-1-61">Notification of Device Configuration Changes</a></span>
<br /> <span class="sectionToc" >3.3 <a 
href="#x1-620003" id="QQ2-1-62">Device Cleanup</a></span>
<br />  <span class="subsectionToc" >3.3.1 <a 
href="#x1-630001" id="QQ2-1-63">Driver Requirements: Device Cleanup</a></span>
<br /><span class="chapterToc" >4 <a 
href="#x1-640004" id="QQ2-1-64">Virtio Transport Options</a></span>
<br /> <span class="sectionToc" >4.1 <a 
href="#x1-650001" id="QQ2-1-65">Virtio Over PCI Bus</a></span>
<br />  <span class="subsectionToc" >4.1.1 <a 
href="#x1-660001" id="QQ2-1-66">Device Requirements: Virtio Over PCI Bus</a></span>
<br />  <span class="subsectionToc" >4.1.2 <a 
href="#x1-670002" id="QQ2-1-67">PCI Device Discovery</a></span>
<br />  <span class="subsectionToc" >4.1.3 <a 
href="#x1-710003" id="QQ2-1-71">PCI Device Layout</a></span>
<br />  <span class="subsectionToc" >4.1.4 <a 
href="#x1-740004" id="QQ2-1-74">Virtio Structure PCI Capabilities</a></span>
<br />  <span class="subsectionToc" >4.1.5 <a 
href="#x1-930005" id="QQ2-1-93">PCI-specific Initialization And Device Operation</a></span>
<br /> <span class="sectionToc" >4.2 <a 
href="#x1-1090002" id="QQ2-1-109">Virtio Over MMIO</a></span>
<br />  <span class="subsectionToc" >4.2.1 <a 
href="#x1-1100001" id="QQ2-1-110">MMIO Device Discovery</a></span>
<br />  <span class="subsectionToc" >4.2.2 <a 
href="#x1-1110002" id="QQ2-1-111">MMIO Device Register Layout</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >4.2.3 <a 
href="#x1-1140003" id="QQ2-1-115">MMIO-specific Initialization And Device Operation</a></span>
<br />  <span class="subsectionToc" >4.2.4 <a 
href="#x1-1210004" id="QQ2-1-122">Legacy interface</a></span>
<br /> <span class="sectionToc" >4.3 <a 
href="#x1-1220003" id="QQ2-1-124">Virtio Over Channel I/O</a></span>
<br />  <span class="subsectionToc" >4.3.1 <a 
href="#x1-1230001" id="QQ2-1-125">Basic Concepts</a></span>
<br />  <span class="subsectionToc" >4.3.2 <a 
href="#x1-1260002" id="QQ2-1-128">Device Initialization</a></span>
<br />  <span class="subsectionToc" >4.3.3 <a 
href="#x1-1450003" id="QQ2-1-147">Device Operation</a></span>
<br /><span class="chapterToc" >5 <a 
href="#x1-1560005" id="QQ2-1-158">Device Types</a></span>
<br /> <span class="sectionToc" >5.1 <a 
href="#x1-1570001" id="QQ2-1-159">Network Device</a></span>
<br />  <span class="subsectionToc" >5.1.1 <a 
href="#x1-1580001" id="QQ2-1-160">Device ID</a></span>
<br />  <span class="subsectionToc" >5.1.2 <a 
href="#x1-1590002" id="QQ2-1-161">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.1.3 <a 
href="#x1-1600003" id="QQ2-1-162">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.1.4 <a 
href="#x1-1630004" id="QQ2-1-165">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.1.5 <a 
href="#x1-1670005" id="QQ2-1-169">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.1.6 <a 
href="#x1-1680006" id="QQ2-1-170">Device Operation</a></span>
<br /> <span class="sectionToc" >5.2 <a 
href="#x1-2020002" id="QQ2-1-204">Block Device</a></span>
<br />  <span class="subsectionToc" >5.2.1 <a 
href="#x1-2030001" id="QQ2-1-205">Device ID</a></span>
<br />  <span class="subsectionToc" >5.2.2 <a 
href="#x1-2040002" id="QQ2-1-206">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.2.3 <a 
href="#x1-2050003" id="QQ2-1-207">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.2.4 <a 
href="#x1-2070004" id="QQ2-1-209">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.2.5 <a 
href="#x1-2090005" id="QQ2-1-211">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.2.6 <a 
href="#x1-2130006" id="QQ2-1-215">Device Operation</a></span>
<br /> <span class="sectionToc" >5.3 <a 
href="#x1-2180003" id="QQ2-1-220">Console Device</a></span>
<br />  <span class="subsectionToc" >5.3.1 <a 
href="#x1-2190001" id="QQ2-1-221">Device ID</a></span>
<br />  <span class="subsectionToc" >5.3.2 <a 
href="#x1-2200002" id="QQ2-1-222">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.3.3 <a 
href="#x1-2210003" id="QQ2-1-223">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.3.4 <a 
href="#x1-2220004" id="QQ2-1-224">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.3.5 <a 
href="#x1-2240005" id="QQ2-1-226">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.3.6 <a 
href="#x1-2260006" id="QQ2-1-228">Device Operation</a></span>
<br /> <span class="sectionToc" >5.4 <a 
href="#x1-2330004" id="QQ2-1-235">Entropy Device</a></span>
<br />  <span class="subsectionToc" >5.4.1 <a 
href="#x1-2340001" id="QQ2-1-236">Device ID</a></span>
<br />  <span class="subsectionToc" >5.4.2 <a 
href="#x1-2350002" id="QQ2-1-237">Virtqueues</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >5.4.3 <a 
href="#x1-2360003" id="QQ2-1-238">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.4.4 <a 
href="#x1-2370004" id="QQ2-1-239">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.4.5 <a 
href="#x1-2380005" id="QQ2-1-240">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.4.6 <a 
href="#x1-2390006" id="QQ2-1-241">Device Operation</a></span>
<br /> <span class="sectionToc" >5.5 <a 
href="#x1-2420005" id="QQ2-1-244">Traditional Memory Balloon Device</a></span>
<br />  <span class="subsectionToc" >5.5.1 <a 
href="#x1-2430001" id="QQ2-1-245">Device ID</a></span>
<br />  <span class="subsectionToc" >5.5.2 <a 
href="#x1-2440002" id="QQ2-1-246">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.5.3 <a 
href="#x1-2450003" id="QQ2-1-247">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.5.4 <a 
href="#x1-2490004" id="QQ2-1-251">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.5.5 <a 
href="#x1-2510005" id="QQ2-1-253">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.5.6 <a 
href="#x1-2520006" id="QQ2-1-254">Device Operation</a></span>
<br /> <span class="sectionToc" >5.6 <a 
href="#x1-2610006" id="QQ2-1-263">SCSI Host Device</a></span>
<br />  <span class="subsectionToc" >5.6.1 <a 
href="#x1-2620001" id="QQ2-1-264">Device ID</a></span>
<br />  <span class="subsectionToc" >5.6.2 <a 
href="#x1-2630002" id="QQ2-1-265">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.6.3 <a 
href="#x1-2640003" id="QQ2-1-266">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.6.4 <a 
href="#x1-2650004" id="QQ2-1-267">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.6.5 <a 
href="#x1-2690005" id="QQ2-1-271">Device Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.6.6 <a 
href="#x1-2700006" id="QQ2-1-272">Device Operation</a></span>
<br /> <span class="sectionToc" >5.7 <a 
href="#x1-2830007" id="QQ2-1-285">Vhost-user Device Backend</a></span>
<br />  <span class="subsectionToc" >5.7.1 <a 
href="#x1-2840001" id="QQ2-1-286">Device ID</a></span>
<br />  <span class="subsectionToc" >5.7.2 <a 
href="#x1-2850002" id="QQ2-1-287">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.7.3 <a 
href="#x1-2860003" id="QQ2-1-288">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.7.4 <a 
href="#x1-2870004" id="QQ2-1-289">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.7.5 <a 
href="#x1-2890005" id="QQ2-1-291">Device Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.7.6 <a 
href="#x1-2900006" id="QQ2-1-292">Device Operation</a></span>
<br />  <span class="subsectionToc" >5.7.7 <a 
href="#x1-2920007" id="QQ2-1-294">Additional Device Resources over PCI</a></span>
<br /><span class="chapterToc" >6 <a 
href="#x1-3020006" id="QQ2-1-304">Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.1 <a 
href="#x1-3030001" id="QQ2-1-305">Driver Requirements: Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.2 <a 
href="#x1-3040002" id="QQ2-1-306">Device Requirements: Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.3 <a 
href="#x1-3050003" id="QQ2-1-307">Legacy Interface: Reserved Feature Bits</a></span>
<br /><span class="chapterToc" >7 <a 
href="#x1-3060007" id="QQ2-1-308">Conformance</a></span>
                                                                  

                                                                  
<br /> <span class="sectionToc" >7.1 <a 
href="#x1-3070001" id="QQ2-1-309">Conformance Targets</a></span>
<br /> <span class="sectionToc" >7.2 <a 
href="#x1-3080002" id="QQ2-1-310">Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.1 <a 
href="#x1-3090001" id="QQ2-1-311">PCI Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.2 <a 
href="#x1-3100002" id="QQ2-1-312">MMIO Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.3 <a 
href="#x1-3110003" id="QQ2-1-313">Channel I/O Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.4 <a 
href="#x1-3120004" id="QQ2-1-314">Network Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.5 <a 
href="#x1-3130005" id="QQ2-1-315">Block Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.6 <a 
href="#x1-3140006" id="QQ2-1-316">Console Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.7 <a 
href="#x1-3150007" id="QQ2-1-317">Entropy Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.8 <a 
href="#x1-3160008" id="QQ2-1-318">Traditional Memory Balloon Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.9 <a 
href="#x1-3170009" id="QQ2-1-319">SCSI Host Driver Conformance</a></span>
<br /> <span class="sectionToc" >7.3 <a 
href="#x1-3180003" id="QQ2-1-320">Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.1 <a 
href="#x1-3190001" id="QQ2-1-321">PCI Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.2 <a 
href="#x1-3200002" id="QQ2-1-322">MMIO Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.3 <a 
href="#x1-3210003" id="QQ2-1-323">Channel I/O Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.4 <a 
href="#x1-3220004" id="QQ2-1-324">Network Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.5 <a 
href="#x1-3230005" id="QQ2-1-325">Block Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.6 <a 
href="#x1-3240006" id="QQ2-1-326">Console Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.7 <a 
href="#x1-3250007" id="QQ2-1-327">Entropy Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.8 <a 
href="#x1-3260008" id="QQ2-1-328">Traditional Memory Balloon Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.9 <a 
href="#x1-3270009" id="QQ2-1-329">SCSI Host Device Conformance</a></span>
<br /> <span class="sectionToc" >7.4 <a 
href="#x1-3280004" id="QQ2-1-330">Legacy Interface: Transitional Device and Transitional Driver Conformance</a></span>
<br /><span class="appendixToc" >A <a 
href="#x1-329000A" id="QQ2-1-331">virtio_queue.h</a></span>
<br /><span class="appendixToc" >B <a 
href="#x1-330000B" id="QQ2-1-333">Creating New Device Types</a></span>
<br /> <span class="sectionToc" >B.1 <a 
href="#x1-3310001" id="QQ2-1-334">How Many Virtqueues?</a></span>
<br /> <span class="sectionToc" >B.2 <a 
href="#x1-3320002" id="QQ2-1-335">What Device Configuration Space Layout?</a></span>
<br /> <span class="sectionToc" >B.3 <a 
href="#x1-3330003" id="QQ2-1-336">What Device Number?</a></span>
<br /> <span class="sectionToc" >B.4 <a 
href="#x1-3340004" id="QQ2-1-337">How many MSI-X vectors? (for PCI)</a></span>
<br /> <span class="sectionToc" >B.5 <a 
href="#x1-3350005" id="QQ2-1-338">Device Improvements</a></span>
<br /><span class="appendixToc" >C <a 
href="#x1-336000C" id="QQ2-1-339">Acknowledgements</a></span>
<br /><span class="appendixToc" >D <a 
href="#x1-337000D" id="QQ2-1-340">Revision History</a></span>
                                                                  

                                                                  
</div>
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 1--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">1</span> <a 
 id="x1-20001"></a>Introduction</h2>
This document describes the specifications of the “virtio” family of devices. These
devices are found in virtual environments, yet by design they look like physical
devices to the guest within the virtual machine - and this document treats them as
such. This similarity allows the guest to use standard drivers and discovery
mechanisms.
<!--l. 8--><p class="noindent" >The purpose of virtio and this specification is that virtual environments
and guests should have a straightforward, efficient, standard and extensible
mechanism for virtual devices, rather than boutique per-environment or per-OS
mechanisms.
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Straightforward:</span> </dt><dd 
class="description">Virtio devices use normal bus mechanisms of interrupts and
     DMA which should be familiar to any device driver author. There is no
     exotic page-flipping or COW mechanism: it’s just a normal device.<span class="footnote-mark"><a 
href="#fn1x1" id="fn1x1-bk"><sup class="textsuperscript">1</sup></a></span><a 
 id="x1-2001f1"></a>
     </dd><dt class="description">
<span 
class="aebx-10">Efficient:</span> </dt><dd 
class="description">Virtio  devices  consist  of  rings  of  descriptors  for  both  input  and
     output, which are neatly laid out to avoid cache effects from both driver
     and device writing to the same cache lines.
     </dd><dt class="description">
<span 
class="aebx-10">Standard:</span> </dt><dd 
class="description">Virtio makes no assumptions about the environment in which it
     operates, beyond supporting the bus to which device is attached. In this
     specification, virtio devices are implemented over MMIO, Channel I/O and
     PCI bus transports <span class="footnote-mark"><a 
href="#fn2x1" id="fn2x1-bk"><sup class="textsuperscript">2</sup></a></span><a 
 id="x1-2002f2"></a>,
     earlier drafts have been implemented on other buses not included here.
     </dd><dt class="description">
<span 
class="aebx-10">Extensible:</span> </dt><dd 
class="description">Virtio devices contain feature bits which are acknowledged by the
     guest  operating  system  during  device  setup.  This  allows  forwards  and
     backwards compatibility: the device offers all the features it knows about,
     and the driver acknowledges those it understands and wishes to use.</dd></dl>
<a 
 id="x1-2003r1"></a>
<h3 class="sectionHead"><span class="titlemark">1.1   </span> <a 
 id="x1-30001"></a>Normative References</h3>
<a 
 id="x1-3001r1"></a><!--l. 40--><div class="longtable"> <table id="TBL-2" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-2-1g"><col 
id="TBL-2-1"><col 
id="TBL-2-2"></colgroup>
<tr  
 style="vertical-align:baseline;" id="TBL-2-1-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-1-1"  
class="td11"> <a 
 id="likesection.1"></a><span 
class="aebx-10">[RFC2119]                </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-1-2"  
class="td11">
 <!--l. 41--><p class="noindent" >Bradner S., “Key words for use in RFCs to Indicate Requirement Levels”, BCP 14,
  RFC 2119, March 1997. <br 
class="newline" /><a 
href="http://www.ietf.org/rfc/rfc2119.txt" class="url" >http://www.ietf.org/rfc/rfc2119.txt</a>                                                                </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-2-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-2-1"  
class="td11"> <a 
 id="likesection.2"></a><span 
class="aebx-10">[S390 PoP]               </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-2-2"  
class="td11">
 <!--l. 43--><p class="noindent" >z/Architecture Principles of Operation, IBM Publication SA22-7832, <br 
class="newline" /><a 
href="http://publibfi.boulder.ibm.com/epubs/pdf/dz9zr009.pdf" class="url" >http://publibfi.boulder.ibm.com/epubs/pdf/dz9zr009.pdf</a>, and any future revisions  </td>
                                                                  

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-3-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-3-1"  
class="td11"> <a 
 id="likesection.3"></a><span 
class="aebx-10">[S390 Common I/O]   </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-3-2"  
class="td11">
 <!--l. 44--><p class="noindent" >ESA/390 Common I/O-Device and Self-Description, IBM Publication SA22-7204, <br 
class="newline" /><a 
href="http://publibfp.dhe.ibm.com/cgi-bin/bookmgr/BOOKS/dz9ar501/CCONTENTS" class="url" >http://publibfp.dhe.ibm.com/cgi-bin/bookmgr/BOOKS/dz9ar501/CCONTENTS</a>,
  and any future revisions                                                                               </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-4-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-4-1"  
class="td11"> <a 
 id="likesection.4"></a><span 
class="aebx-10">[PCI]                       </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-4-2"  
class="td11">
 <!--l. 46--><p class="noindent" >Conventional PCI Specifications, <br 
class="newline" /><a 
href="http://www.pcisig.com/specifications/conventional/" class="url" >http://www.pcisig.com/specifications/conventional/</a>, PCI-SIG                             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-5-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-5-1"  
class="td11"> <a 
 id="likesection.5"></a><span 
class="aebx-10">[PCIe]                     </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-5-2"  
class="td11">
 <!--l. 50--><p class="noindent" >PCI Express Specifications <br 
class="newline" /><a 
href="http://www.pcisig.com/specifications/pciexpress/" class="url" >http://www.pcisig.com/specifications/pciexpress/</a>, PCI-SIG                                </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-6-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-6-1"  
class="td11"> <a 
 id="likesection.6"></a><span 
class="aebx-10">[IEEE 802]               </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-6-2"  
class="td11">
 <!--l. 54--><p class="noindent" >IEEE  Standard  for  Local  and  Metropolitan  Area  Networks:  Overview  and
  Architecture, <br 
class="newline" /><a 
href="http://standards.ieee.org/about/get/802/802.html" class="url" >http://standards.ieee.org/about/get/802/802.html</a>, IEEE                                   </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-7-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-7-1"  
class="td11"> <a 
 id="likesection.7"></a><span 
class="aebx-10">[SAM]                     </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-7-2"  
class="td11">
 <!--l. 58--><p class="noindent" >SCSI Architectural Model, <br 
class="newline" /><a 
href="http://www.t10.org/cgi-bin/ac.pl?t=f&f=sam4r05.pdf" class="url" >http://www.t10.org/cgi-bin/ac.pl?t=f&f=sam4r05.pdf</a>                                       </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-8-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-8-1"  
class="td11"> <a 
 id="likesection.8"></a><span 
class="aebx-10">[SCSI MMC]             </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-8-2"  
class="td11">
 <!--l. 61--><p class="noindent" >SCSI Multimedia Commands, <br 
class="newline" /><a 
href="http://www.t10.org/cgi-bin/ac.pl?t=f&f=mmc6r00.pdf" class="url" >http://www.t10.org/cgi-bin/ac.pl?t=f&f=mmc6r00.pdf</a>                                      </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-9-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-9-1"  
class="td11"> <a 
 id="likesection.9"></a><span 
class="aebx-10">[Vhost-user Protocol]  </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-2-9-2"  
class="td11">
 <!--l. 63--><p class="noindent" >Vhost-user Protocol, <br 
class="newline" /><a 
href="https://git.qemu.org/?p=qemu.git;a=blob_plain;f=docs/interop/vhost-user.txt;hb=HEAD" class="url" >https://git.qemu.org/?p=qemu.git;a=blob_plain;f=docs/interop/vhost-user.txt;hb=HEAD</a>,
  and any future revisions                                                                               </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-10-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-10-1"  
class="td11">                    </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-11-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-11-1"  
class="td11">                    </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-12-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-12-1"  
class="td11">                    </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-13-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-13-1"  
class="td11">                    </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-14-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-14-1"  
class="td11">                       </td><td  style="white-space:wrap; text-align:left;" id="TBL-2-14-2"  
class="td11">
</td></tr>
</table></div>
<a 
 id="x1-3002r3"></a>
<h3 class="sectionHead"><span class="titlemark">1.2   </span> <a 
 id="x1-40002"></a>Non-Normative References</h3>
<a 
 id="x1-4001r2"></a><!--l. 70--><div class="longtable"> <table id="TBL-3" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-3-1g"><col 
id="TBL-3-1"><col 
id="TBL-3-2"></colgroup>
<tr  
 style="vertical-align:baseline;" id="TBL-3-1-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-1-1"  
class="td11"> <a 
 id="likesection.10"></a><span 
class="aebx-10">[Virtio PCI Draft]  </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-3-1-2"  
class="td11">
 <!--l. 71--><p class="noindent" >Virtio PCI Draft Specification <br 
class="newline" /><a 
href="http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf" class="url" >http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf</a>                                          </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-2-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-2-1"  
class="td11">                 </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-3-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-3-1"  
class="td11">                 </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-4-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-4-1"  
class="td11">                 </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-5-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-5-1"  
class="td11">                 </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-6-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-6-1"  
class="td11">                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-3-6-2"  
class="td11">
</td></tr>
</table></div>
<a 
 id="x1-4002r4"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">1.3   </span> <a 
 id="x1-50003"></a>Terminology</h3>
<!--l. 77--><p class="noindent" >The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in
this document are to be interpreted as described in <a 
href="#x1-3001r1">[RFC2119]</a>.
<a 
 id="x1-5001r1"></a>
<h4 class="subsectionHead"><span class="titlemark">1.3.1   </span> <a 
 id="x1-60001"></a>Legacy Interface: Terminology</h4>
<!--l. 82--><p class="noindent" >Earlier drafts of this specification (i.e. revisions before 1.0, see e.g. <a 
href="#x1-4001r2">[Virtio PCI Draft]</a>)
defined a similar, but different interface between the driver and the device. Since
these are widely deployed, this specification accommodates OPTIONAL features to
simplify transition from these earlier draft interfaces.
<!--l. 90--><p class="noindent" >Specifically devices and drivers MAY support:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Legacy Interface</span> </dt><dd 
class="description">is  an  interface  specified  by  an  earlier  draft  of  this
     specification (before 1.0)
     </dd><dt class="description">
<span 
class="aebx-10">Legacy Device</span> </dt><dd 
class="description">is a device implemented before this specification was released,
     and implementing a legacy interface on the host side
     </dd><dt class="description">
<span 
class="aebx-10">Legacy Driver</span> </dt><dd 
class="description">is a driver implemented before this specification was released,
     and implementing a legacy interface on the guest side</dd></dl>
<!--l. 103--><p class="noindent" >Legacy devices and legacy drivers are not compliant with this specification.
<!--l. 106--><p class="noindent" >To simplify transition from these earlier draft interfaces, a device MAY implement:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Transitional Device</span> </dt><dd 
class="description">a  device  supporting  both  drivers  conforming  to  this
     specification, and allowing legacy drivers.</dd></dl>
<!--l. 115--><p class="noindent" >Similarly, a driver MAY implement:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">Transitional Driver</span> </dt><dd 
class="description">a  driver  supporting  both  devices  conforming  to  this
     specification, and legacy devices.</dd></dl>
<span 
class="aebx-10">Note:</span> Legacy interfaces are not required; ie. don’t implement them unless you
      have a need for backwards compatibility!
<!--l. 127--><p class="noindent" >Devices or drivers with no legacy compatibility are referred to as non-transitional
devices and drivers, respectively.
<a 
 id="x1-6001r6"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">1.3.2   </span> <a 
 id="x1-70002"></a>Transition from earlier specification drafts</h4>
<!--l. 132--><p class="noindent" >For devices and drivers already implementing the legacy interface, some changes will
have to be made to support this specification.
<!--l. 136--><p class="noindent" >In this case, it might be beneficial for the reader to focus on sections tagged "Legacy
Interface" in the section title. These highlight the changes made since the earlier
drafts.
<a 
 id="x1-7001r5"></a>
<h3 class="sectionHead"><span class="titlemark">1.4   </span> <a 
 id="x1-80004"></a>Structure Specifications</h3>
<!--l. 142--><p class="noindent" >Many device and driver in-memory structure layouts are documented using the C
struct syntax. All structures are assumed to be without additional padding.
To stress this, cases where common C compilers are known to insert extra
padding within structures are tagged using the GNU C __attribute__((packed))
syntax.
<!--l. 148--><p class="noindent" >For the integer data types used in the structure definitions, the following conventions
are used:
     <dl class="description"><dt class="description">
<span 
class="aebx-10">u8, u16, u32, u64</span> </dt><dd 
class="description">An unsigned integer of the specified length in bits.
     </dd><dt class="description">
<span 
class="aebx-10">le16, le32, le64</span> </dt><dd 
class="description">An  unsigned  integer  of  the  specified  length  in  bits,  in
     little-endian byte order.
     </dd><dt class="description">
<span 
class="aebx-10">be16, be32, be64</span> </dt><dd 
class="description">An  unsigned  integer  of  the  specified  length  in  bits,  in
     big-endian byte order.</dd></dl>
<!--l. 161--><p class="noindent" >
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 1--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">2</span> <a 
 id="x1-90002"></a>Basic Facilities of a Virtio Device</h2>
A virtio device is discovered and identified by a bus-specific method (see
the bus specific sections: <a 
href="#x1-650001">4.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus --></a> <a 
href="#x1-650001">Virtio Over PCI Bus<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus --></a>, <a 
href="#x1-1090002">4.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO --></a> <a 
href="#x1-1090002">Virtio Over MMIO<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO --></a>
and <a 
href="#x1-1220003">4.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over Channel I/O --></a> <a 
href="#x1-1220003">Virtio Over Channel I/O<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over Channel I/O --></a>). Each device consists of the following
parts:
     <ul class="itemize1">
     <li class="itemize">Device status field
     </li>
     <li class="itemize">Feature bits
     </li>
     <li class="itemize">Device Configuration space
     </li>
     <li class="itemize">One or more virtqueues</li></ul>
<a 
 id="x1-9001r8"></a>
<h3 class="sectionHead"><span class="titlemark">2.1   </span> <a 
 id="x1-100001"></a><span 
class="aeti-10">Device Status </span>Field</h3>
<!--l. 16--><p class="noindent" >During device initialization by a driver, the driver follows the sequence of steps
specified in <a 
href="#x1-490001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.
<!--l. 21--><p class="noindent" >The <span 
class="aeti-10">device status </span>field provides a simple low-level indication of the completed steps of
this sequence. It’s most useful to imagine it hooked up to traffic lights on the console
indicating the status of each device. The following bits are defined (listed below in
the order in which they would be typically set):
     <dl class="description"><dt class="description">
<span 
class="aebx-10">ACKNOWLEDGE (1)</span> </dt><dd 
class="description">Indicates that the guest OS has found the device and
     recognized it as a valid virtio device.
     </dd><dt class="description">
<span 
class="aebx-10">DRIVER (2)</span> </dt><dd 
class="description">Indicates that the guest OS knows how to drive the device.
     <span 
class="aebx-10">Note:</span> There could be a significant (or infinite) delay before setting this
           bit. For example, under Linux, drivers can be loadable modules.
     </dd><dt class="description">
<span 
class="aebx-10">FAILED (128)</span> </dt><dd 
class="description">Indicates that something went wrong in the guest, and it has given
     up on the device. This could be an internal error, or the driver didn’t
     like the device for some reason, or even a fatal error during device
     operation.
     </dd><dt class="description">
<span 
class="aebx-10">FEATURES_OK (8)</span> </dt><dd 
class="description">Indicates that the driver has acknowledged all the features it
     understands, and feature negotiation is complete.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebx-10">DRIVER_OK (4)</span> </dt><dd 
class="description">Indicates that the driver is set up and ready to drive the
     device.
     </dd><dt class="description">
<span 
class="aebx-10">DEVICE_NEEDS_RESET (64)</span> </dt><dd 
class="description">Indicates that the device has experienced an
     error from which it can’t recover.</dd></dl>
<a 
 id="x1-10001r7"></a>
<h4 class="subsectionHead"><span class="titlemark">2.1.1   </span> <a 
 id="x1-110001"></a>Driver Requirements: Device Status Field</h4>
<!--l. 54--><p class="noindent" >The driver MUST update <span 
class="aeti-10">device status</span>, setting bits to indicate the completed steps of
the driver initialization sequence specified in <a 
href="#x1-490001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>. The driver MUST NOT clear a
<span 
class="aeti-10">device status </span>bit. If the driver sets the FAILED bit, the driver MUST later reset the
device before attempting to re-initialize.
<!--l. 63--><p class="noindent" >The driver SHOULD NOT rely on completion of operations of a device if
DEVICE_NEEDS_RESET is set.
<span 
class="aebx-10">Note:</span> For example, the driver can’t assume requests in flight will be completed
      if DEVICE_NEEDS_RESET is set, nor can it assume that they have not
      been completed. A good implementation will try to recover by issuing a
      reset.
<a 
 id="x1-11001r11"></a>
<h4 class="subsectionHead"><span class="titlemark">2.1.2   </span> <a 
 id="x1-120002"></a>Device Requirements: Device Status Field</h4>
<!--l. 73--><p class="noindent" >The device MUST initialize <span 
class="aeti-10">device status </span>to 0 upon reset.
<!--l. 75--><p class="noindent" >The device MUST NOT consume buffers or notify the driver before DRIVER_OK.
<!--l. 77--><p class="noindent" >The device SHOULD set DEVICE_NEEDS_RESET when it enters an error state
that a reset is needed. If DRIVER_OK is set, after it sets DEVICE_NEEDS_RESET,
the device MUST send a device configuration change notification to the
driver.
<a 
 id="x1-12001r10"></a>
<h3 class="sectionHead"><span class="titlemark">2.2   </span> <a 
 id="x1-130002"></a>Feature Bits</h3>
<!--l. 83--><p class="noindent" >Each virtio device offers all the features it understands. During device initialization,
the driver reads this and tells the device the subset that it accepts. The only way to
renegotiate is to reset the device.
<!--l. 88--><p class="noindent" >This allows for forwards and backwards compatibility: if the device is enhanced with
a new feature bit, older drivers will not write that feature bit back to the device.
Similarly, if a driver is enhanced with a feature that the device doesn’t support, it see
the new feature is not offered.
<!--l. 93--><p class="noindent" >Feature bits are allocated as follows:
                                                                  

                                                                  
     <dl class="description"><dt class="description">
<span 
class="aebx-10">0 to 23</span> </dt><dd 
class="description">Feature bits for the specific device type
     </dd><dt class="description">
<span 
class="aebx-10">24 to 33</span> </dt><dd 
class="description">Feature  bits  reserved  for  extensions  to  the  queue  and  feature
     negotiation mechanisms
     </dd><dt class="description">
<span 
class="aebx-10">34 and above</span> </dt><dd 
class="description">Feature bits reserved for future extensions.</dd></dl>
<span 
class="aebx-10">Note:</span> For example, feature bit 0 for a network device (i.e. Device ID 1) indicates
      that the device supports checksumming of packets.
<!--l. 110--><p class="noindent" >In particular, new fields in the device configuration space are indicated by offering a
new feature bit.
<a 
 id="x1-13001r12"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.1   </span> <a 
 id="x1-140001"></a>Driver Requirements: Feature Bits</h4>
<!--l. 114--><p class="noindent" >The driver MUST NOT accept a feature which the device did not offer, and
MUST NOT accept a feature which requires another feature which was not
accepted.
<!--l. 118--><p class="noindent" >The driver SHOULD go into backwards compatibility mode if the device does not
offer a feature it understands, otherwise MUST set the FAILED <span 
class="aeti-10">device status </span>bit and
cease initialization.
<a 
 id="x1-14001r14"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.2   </span> <a 
 id="x1-150002"></a>Device Requirements: Feature Bits</h4>
<!--l. 123--><p class="noindent" >The device MUST NOT offer a feature which requires another feature which was not
offered. The device SHOULD accept any valid subset of features the driver accepts,
otherwise it MUST fail to set the FEATURES_OK <span 
class="aeti-10">device status </span>bit when the driver
writes it.
<a 
 id="x1-15001r15"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.3   </span> <a 
 id="x1-160003"></a>Legacy Interface: A Note on Feature Bits</h4>
<!--l. 132--><p class="noindent" >Transitional Drivers MUST detect Legacy Devices by detecting that the feature bit
VIRTIO_F_VERSION_1 is not offered. Transitional devices MUST detect Legacy
drivers by detecting that VIRTIO_F_VERSION_1 has not been acknowledged by the
driver.
<!--l. 137--><p class="noindent" >In this case device is used through the legacy interface.
<!--l. 139--><p class="noindent" >Legacy interface support is OPTIONAL. Thus, both transitional and non-transitional
devices and drivers are compliant with this specification.
<!--l. 143--><p class="noindent" >Requirements pertaining to transitional devices and drivers is contained in sections
named ’Legacy Interface’ like this one.
                                                                  

                                                                  
<!--l. 146--><p class="noindent" >When device is used through the legacy interface, transitional devices and
transitional drivers MUST operate according to the requirements documented within
these legacy interface sections. Specification text within these sections generally does
not apply to non-transitional devices.
<a 
 id="x1-16001r13"></a>
<h3 class="sectionHead"><span class="titlemark">2.3   </span> <a 
 id="x1-170003"></a>Device Configuration Space</h3>
<!--l. 154--><p class="noindent" >Device configuration space is generally used for rarely-changing or initialization-time
parameters. Where configuration fields are optional, their existence is indicated by
feature bits: Future versions of this specification will likely extend the device
configuration space by adding extra fields at the tail.
<span 
class="aebx-10">Note:</span> The  device  configuration  space  uses  the  little-endian  format  for
      multi-byte fields.
<!--l. 165--><p class="noindent" >Each transport also provides a generation count for the device configuration space,
which will change whenever there is a possibility that two accesses to the device
configuration space can see different versions of that space.
<a 
 id="x1-17001r16"></a>
<h4 class="subsectionHead"><span class="titlemark">2.3.1   </span> <a 
 id="x1-180001"></a>Driver Requirements: Device Configuration Space</h4>
<!--l. 171--><p class="noindent" >Drivers MUST NOT assume reads from fields greater than 32 bits wide are atomic,
nor are reads from multiple fields: drivers SHOULD read device configuration space
fields like so:
<!--l. 175-->
<div class="lstlisting" id="listing-1"><span class="label"><a 
 id="x1-18001r1"></a></span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-18002r2"></a></span><span 
class="pcrr8t-x-x-80">do</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-18003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_config_generation</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-18004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">entry</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-18005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_config_generation</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-18006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">while</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 184--><p class="noindent" >For optional configuration space fields, the driver MUST check that the
corresponding feature is offered before accessing that part of the configuration
space.
<span 
class="aebx-10">Note:</span> See section <a 
href="#x1-490001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> for details on feature negotiation.
<!--l. 191--><p class="noindent" >Drivers MUST NOT limit structure size and device configuration space size. Instead,
drivers SHOULD only check that device configuration space is <span 
class="aeti-10">large enough </span>to
contain the fields necessary for device operation.
<span 
class="aebx-10">Note:</span> For example, if the specification states that device configuration space
      ’includes a single 8-bit field’ drivers should understand this to mean that
      the device configuration space might also include an arbitrary amount
      of tail padding, and accept any device configuration space size equal to
                                                                  

                                                                  
      or greater than the specified 8-bit size.
<a 
 id="x1-18007r18"></a>
<h4 class="subsectionHead"><span class="titlemark">2.3.2   </span> <a 
 id="x1-190002"></a>Device Requirements: Device Configuration Space</h4>
<!--l. 205--><p class="noindent" >The device MUST allow reading of any device-specific configuration field
before FEATURES_OK is set by the driver. This includes fields which are
conditional on feature bits, as long as those feature bits are offered by the
device.
<a 
 id="x1-19001r19"></a>
<h4 class="subsectionHead"><span class="titlemark">2.3.3   </span> <a 
 id="x1-200003"></a>Legacy Interface: A Note on Device Configuration Space endian-ness</h4>
<!--l. 212--><p class="noindent" >Note that for legacy interfaces, device configuration space is generally the guest’s
native endian, rather than PCI’s little-endian. The correct endian-ness is documented
for each device.
<a 
 id="x1-20001r20"></a>
<h4 class="subsectionHead"><span class="titlemark">2.3.4   </span> <a 
 id="x1-210004"></a>Legacy Interface: Device Configuration Space</h4>
<!--l. 218--><p class="noindent" >Legacy devices did not have a configuration generation field, thus are susceptible to
race conditions if configuration is updated. This affects the block <span 
class="aeti-10">capacity </span>(see <a 
href="#x1-2070004">5.2.4<!--tex4ht:ref: sec:Device Types / Block Device / Device configuration layout --></a>)
and network <span 
class="aeti-10">mac </span>(see <a 
href="#x1-1630004">5.1.4<!--tex4ht:ref: sec:Device Types / Network Device / Device configuration layout --></a>) fields; when using the legacy interface, drivers
SHOULD read these fields multiple times until two reads generate a consistent
result.
<a 
 id="x1-21001r17"></a>
<h3 class="sectionHead"><span class="titlemark">2.4   </span> <a 
 id="x1-220004"></a>Virtqueues</h3>
<!--l. 230--><p class="noindent" >The mechanism for bulk data transport on virtio devices is
pretentiously called a virtqueue. Each device can have zero or more
virtqueues<span class="footnote-mark"><a 
href="#fn3x2" id="fn3x2-bk"><sup class="textsuperscript">3</sup></a></span><a 
 id="x1-22001f3"></a>.
Each queue has a 16-bit queue size parameter, which sets the number of entries and
implies the total size of the queue.
<!--l. 237--><p class="noindent" >Each virtqueue consists of three parts:
     <ul class="itemize1">
     <li class="itemize">Descriptor Table
     </li>
     <li class="itemize">Available Ring
     </li>
     <li class="itemize">Used Ring</li></ul>
<!--l. 245--><p class="noindent" >where each part is physically-contiguous in guest memory, and has different
alignment requirements.
<!--l. 248--><p class="noindent" >The memory aligment and size requirements, in bytes, of each part of the virtqueue
                                                                  

                                                                  
are summarized in the following table:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtqueue Part    </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Alignment  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Size                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Descriptor Table  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16            </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">16</span><span 
class="cmsy-10">∗</span>(Queue Size)     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Available Ring    </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">6 + 2</span><span 
class="cmsy-10">∗</span>(Queue Size)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Used Ring          </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">6 + 8</span><span 
class="cmsy-10">∗</span>(Queue Size)  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 263--><p class="noindent" >The Alignment column gives the minimum alignment for each part of the
virtqueue.
<!--l. 266--><p class="noindent" >The Size column gives the total number of bytes for each part of the virtqueue.
<!--l. 269--><p class="noindent" >Queue Size corresponds to the maximum number of buffers in the
virtqueue<span class="footnote-mark"><a 
href="#fn4x2" id="fn4x2-bk"><sup class="textsuperscript">4</sup></a></span><a 
 id="x1-22002f4"></a>.
Queue Size value is always a power of 2. The maximum Queue Size value is 32768.
This value is specified in a bus-specific way.
<!--l. 275--><p class="noindent" >When the driver wants to send a buffer to the device, it fills in a slot in
the descriptor table (or chains several together), and writes the descriptor
index into the available ring. It then notifies the device. When the device has
finished a buffer, it writes the descriptor index into the used ring, and sends an
interrupt.
<a 
 id="x1-22003r21"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.1   </span> <a 
 id="x1-230001"></a>Driver Requirements: Virtqueues</h4>
<!--l. 282--><p class="noindent" >The driver MUST ensure that the physical address of the first byte of each
virtqueue part is a multiple of the specified alignment value in the above
table.
<a 
 id="x1-23001r23"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.2   </span> <a 
 id="x1-240002"></a>Legacy Interfaces: A Note on Virtqueue Layout</h4>
<!--l. 288--><p class="noindent" >For Legacy Interfaces, several additional restrictions are placed on the virtqueue
layout:
<!--l. 291--><p class="noindent" >Each virtqueue occupies two or more physically-contiguous pages (usually defined as
4096 bytes, but depending on the transport; henceforth referred to as Queue Align)
and consists of three parts:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Descriptor Table  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Available Ring (…padding…)  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Used Ring  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
</div>
<!--l. 302--><p class="noindent" >The bus-specific Queue Size field controls the total number of bytes for the virtqueue.
When using the legacy interface, the transitional driver MUST retrieve the Queue
Size field from the device and MUST allocate the total number of bytes for the
virtqueue according to the following formula (Queue Align given in qalign and Queue
Size given in qsz):
<!--l. 310-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-2"><span class="label"><a 
 id="x1-24001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(((</span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qalign</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">qalign</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24002r2"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_size</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24003r3"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">u16</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*(3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">u16</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<!--l. 319--><p class="noindent" >This wastes some space with padding. When using the legacy interface, both
transitional devices and drivers MUST use the following virtqueue layout structure to
locate elements of the virtqueue:
<!--l. 324-->
<div class="lstlisting" id="listing-3"><span class="label"><a 
 id="x1-24007r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24008r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24009r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24010r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24011r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">running</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24012r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24013r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24014r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Align</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">boundary</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24015r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24016r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24017r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">running</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24018r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-24019r13"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-24020r24"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.3   </span> <a 
 id="x1-250003"></a>Legacy Interfaces: A Note on Virtqueue Endianness</h4>
<!--l. 342--><p class="noindent" >Note that when using the legacy interface, transitional devices and drivers
MUST use the native endian of the guest as the endian of fields and in the
virtqueue. This is opposed to little-endian for non-legacy interface as specified
by this standard. It is assumed that the host is already aware of the guest
endian.
<a 
 id="x1-25001r25"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.4   </span> <a 
 id="x1-260004"></a>Message Framing</h4>
<!--l. 350--><p class="noindent" >The framing of messages with descriptors is independent of the contents of the
buffers. For example, a network transmit buffer consists of a 12 byte header followed
by the network packet. This could be most simply placed in the descriptor table as a
12 byte output descriptor followed by a 1514 byte output descriptor, but it could also
consist of a single 1526 byte output descriptor in the case where the header and
packet are adjacent, or even three or more descriptors (possibly with loss of efficiency
in that case).
<!--l. 359--><p class="noindent" >Note that, some device implementations have large-but-reasonable restrictions on
total descriptor size (such as based on IOV_MAX in the host OS). This has not been
a problem in practice: little sympathy will be given to drivers which create
unreasonably-sized descriptors such as by dividing a network packet into 1500
single-byte descriptors!
<a 
 id="x1-26001r1"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.4.1   </span> <a 
 id="x1-270001"></a>Device Requirements: Message Framing</h5>
<!--l. 367--><p class="noindent" >The device MUST NOT make assumptions about the particular arrangement of
descriptors. The device MAY have a reasonable limit of descriptors it will allow in a
chain.
<a 
 id="x1-27001r27"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.4.4.2   </span> <a 
 id="x1-280002"></a>Driver Requirements: Message Framing</h5>
<!--l. 372--><p class="noindent" >The driver MUST place any device-writable descriptor elements after any
device-readable descriptor elements.
<!--l. 375--><p class="noindent" >The driver SHOULD NOT use an excessive number of descriptors to describe a
buffer.
<a 
 id="x1-28001r28"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.4.3   </span> <a 
 id="x1-290003"></a>Legacy Interface: Message Framing</h5>
<!--l. 380--><p class="noindent" >Regrettably, initial driver implementations used simple layouts, and devices came to
rely on it, despite this specification wording. In addition, the specification for
virtio_blk SCSI commands required intuiting field lengths from frame boundaries (see
<a 
href="#x1-2160003">5.2.6.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a> <a 
href="#x1-2160003">Legacy Interface: Device Operation<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a>)
<!--l. 386--><p class="noindent" >Thus when using the legacy interface, the VIRTIO_F_ANY_LAYOUT feature
indicates to both the device and the driver that no assumptions were made about
framing. Requirements for transitional drivers when this is not negotiated are
included in each device section.
<a 
 id="x1-29001r26"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.5   </span> <a 
 id="x1-300005"></a>The Virtqueue Descriptor Table</h4>
<!--l. 394--><p class="noindent" >The descriptor table refers to the buffers the driver is using for the device. <span 
class="aeti-10">addr </span>is a
physical address, and the buffers can be chained via <span 
class="aeti-10">next</span>. Each descriptor describes a
buffer which is read-only for the device (“device-readable”) or write-only for the
device (“device-writable”), but a chain of descriptors can contain both device-readable
and device-writable buffers.
<!--l. 400--><p class="noindent" >The actual contents of the memory offered to the device depends on the device type.
Most common is to begin the data with a header (containing little-endian fields)
for the device to read, and postfix it with a status tailer for the device to
write.
<!--l. 405-->
<div class="lstlisting" id="listing-4"><span class="label"><a 
 id="x1-30001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30007r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">continuing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30009r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">otherwise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30011r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">means</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contains</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_INDIRECT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-30017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 425--><p class="noindent" >The number of descriptors in the table is defined by the queue size for this virtqueue:
this is the maximum possible descriptor chain length.
<span 
class="aebx-10">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to this structure as vring_desc,
      and the constants as VRING_DESC_F_NEXT, etc, but the layout and
      values were identical.
<a 
 id="x1-30018r29"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.4.5.1   </span> <a 
 id="x1-310001"></a>Device Requirements: The Virtqueue Descriptor Table</h5>
<!--l. 435--><p class="noindent" >A device MUST NOT write to a device-readable buffer, and a device SHOULD NOT
read a device-writable buffer (it MAY do so for debugging or diagnostic
purposes).
<a 
 id="x1-31001r31"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.5.2   </span> <a 
 id="x1-320002"></a>Driver Requirements: The Virtqueue Descriptor Table</h5>
<!--l. 440--><p class="noindent" >Drivers MUST NOT add a descriptor chain over than <span 
class="cmr-10">2</span><sup><span 
class="cmr-7">32</span></sup> bytes long in total; this
implies that loops in the descriptor chain are forbidden!
<a 
 id="x1-32001r32"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.5.3   </span> <a 
 id="x1-330003"></a>Indirect Descriptors</h5>
<!--l. 445--><p class="noindent" >Some devices benefit by concurrently dispatching a large number of large requests.
The VIRTIO_F_INDIRECT_DESC feature allows this (see <a 
href="#x1-329000A">A<!--tex4ht:ref: sec:virtio-queue.h --></a> <a 
href="#x1-329000A">virtio_queue.h<!--tex4ht:ref: sec:virtio-queue.h --></a>). To
increase ring capacity the driver can store a table of indirect descriptors
anywhere in memory, and insert a descriptor in main virtqueue (with
<span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_INDIRECT on) that refers to memory buffer containing this
indirect descriptor table; <span 
class="aeti-10">addr </span>and <span 
class="aeti-10">len </span>refer to the indirect table address and length
in bytes, respectively.
<!--l. 454--><p class="noindent" >The indirect table layout structure looks like this (<span 
class="aeti-10">len </span>is the length of the
descriptor that refers to this table, which is a variable, so this code won’t
compile):
<!--l. 458-->
<div class="lstlisting" id="listing-5"><span class="label"><a 
 id="x1-33001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indirect_descriptor_table</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-33002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-33003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-33004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 465--><p class="noindent" >The first indirect descriptor is located at start of the indirect descriptor table (index
0), additional indirect descriptors are chained by <span 
class="aeti-10">next</span>. An indirect descriptor without
a valid <span 
class="aeti-10">next </span>(with <span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_NEXT off) signals the end of the
descriptor. A single indirect descriptor table can include both device-readable and
device-writable descriptors.
<a 
 id="x1-33005r1"></a>
<h5 class="paragraphHead"><span class="titlemark">2.4.5.3.1</span> <a 
 id="x1-340001"></a>Driver Requirements: Indirect Descriptors</h5>
The driver MUST NOT set the VIRTQ_DESC_F_INDIRECT flag unless the
VIRTIO_F_INDIRECT_DESC feature was negotiated. The driver MUST NOT set
the VIRTQ_DESC_F_INDIRECT flag within an indirect descriptor (ie. only one table
per descriptor).
<!--l. 478--><p class="noindent" >A driver MUST NOT create a descriptor chain longer than the Queue Size of the
device.
                                                                  

                                                                  
<!--l. 481--><p class="noindent" >A driver MUST NOT set both VIRTQ_DESC_F_INDIRECT and VIRTQ_DESC_F_NEXT
in <span 
class="aeti-10">flags</span>.
<a 
 id="x1-34001r34"></a>
<h5 class="paragraphHead"><span class="titlemark">2.4.5.3.2</span> <a 
 id="x1-350002"></a>Device Requirements: Indirect Descriptors</h5>
The device MUST ignore the write-only flag (<span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_WRITE) in the
descriptor that refers to an indirect table.
<!--l. 487--><p class="noindent" >The device MUST handle the case of zero or more normal chained descriptors
followed by a single descriptor with <span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_INDIRECT.
<span 
class="aebx-10">Note:</span> While unusual (most implementations either create a chain solely using
      non-indirect descriptors, or use a single indirect element), such a layout
      is valid.
<a 
 id="x1-35001r30"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.6   </span> <a 
 id="x1-360006"></a>The Virtqueue Available Ring</h4>
<!--l. 498-->
<div class="lstlisting" id="listing-6"><span class="label"><a 
 id="x1-36001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-36002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_AVAIL_F_NO_INTERRUPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-36003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-36004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-36005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-36006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-36007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 508--><p class="noindent" >The driver uses the available ring to offer buffers to the device: each ring entry refers
to the head of a descriptor chain. It is only written by the driver and read by the
device.
<!--l. 512--><p class="noindent" ><span 
class="aeti-10">idx </span>field indicates where the driver would put the next descriptor entry in the ring
(modulo the queue size). This starts at 0, and increases.
<span 
class="aebx-10">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to this structure as vring_avail,
      and  the  constant  as  VRING_AVAIL_F_NO_INTERRUPT,  but  the
      layout and value were identical.
<a 
 id="x1-36008r36"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.7   </span> <a 
 id="x1-370007"></a>Virtqueue Interrupt Suppression</h4>
<!--l. 523--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated, the <span 
class="aeti-10">flags </span>field in the
available ring offers a crude mechanism for the driver to inform the device that it
doesn’t want interrupts when buffers are used. Otherwise <span 
class="aeti-10">used_event </span>is a more
performant alternative where the driver specifies how far the device can progress
before interrupting.
<!--l. 529--><p class="noindent" >Neither of these interrupt suppression methods are reliable, as they are not
synchronized with the device, but they serve as useful optimizations.
<a 
 id="x1-37001r33"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.4.7.1   </span> <a 
 id="x1-380001"></a>Driver Requirements: Virtqueue Interrupt Suppression</h5>
<!--l. 534--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST set <span 
class="aeti-10">flags </span>to 0 or 1.
     </li>
     <li class="itemize">The driver MAY set <span 
class="aeti-10">flags </span>to 1 to advise the device that interrupts are not
     needed.</li></ul>
<!--l. 541--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST set <span 
class="aeti-10">flags </span>to 0.
     </li>
     <li class="itemize">The  driver  MAY  use  <span 
class="aeti-10">used_event  </span>to  advise  the  device  that  interrupts
     are unnecessary until the device writes entry with an index specified by
     <span 
class="aeti-10">used_event </span>into the used ring (equivalently, until <span 
class="aeti-10">idx </span>in the used ring will
     reach the value <span 
class="aeti-10">used_event </span>+ 1).</li></ul>
<!--l. 548--><p class="noindent" >The driver MUST handle spurious interrupts from the device.
<a 
 id="x1-38001r38"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.7.2   </span> <a 
 id="x1-390002"></a>Device Requirements: Virtqueue Interrupt Suppression</h5>
<!--l. 552--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST ignore the <span 
class="aeti-10">used_event </span>value.
     </li>
     <li class="itemize">After the device writes a descriptor index into the used ring:
         <ul class="itemize2">
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 1, the device SHOULD NOT send an interrupt.
         </li>
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 0, the device MUST send an interrupt.</li></ul>
     </li></ul>
<!--l. 562--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST ignore the lower bit of <span 
class="aeti-10">flags</span>.
     </li>
     <li class="itemize">After the device writes a descriptor index into the used ring:
         <ul class="itemize2">
         <li class="itemize">If  the  <span 
class="aeti-10">idx  </span>field  in  the  used  ring  (which  determined  where  that
                                                                  

                                                                  
         descriptor  index  was  placed)  was  equal  to  <span 
class="aeti-10">used_event</span>,  the  device
         MUST send an interrupt.
         </li>
         <li class="itemize">Otherwise the device SHOULD NOT send an interrupt.</li></ul>
     </li></ul>
<span 
class="aebx-10">Note:</span> For                     example,                     if                     <span 
class="aeti-10">used_event</span>
      is 0, then a device using VIRTIO_F_EVENT_IDX would interrupt after
      the first buffer is used (and again after the 65536th buffer, etc).
<a 
 id="x1-39001r37"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.8   </span> <a 
 id="x1-400008"></a>The Virtqueue Used Ring</h4>
<!--l. 582-->
<div class="lstlisting" id="listing-7"><span class="label"><a 
 id="x1-40001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_USED_F_NO_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40009r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">here</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reasons</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40010r10"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Total</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">was</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-40015r15"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 600--><p class="noindent" >The used ring is where the device returns buffers once it is done with them: it is only
written to by the device, and read by the driver.
<!--l. 603--><p class="noindent" >Each entry in the ring is a pair: <span 
class="aeti-10">id </span>indicates the head entry of the descriptor chain
describing the buffer (this matches an entry placed in the available ring by the guest
earlier), and <span 
class="aeti-10">len </span>the total of bytes written into the buffer.
<span 
class="aebx-10">Note:</span> <span 
class="aeti-10">len </span>is particularly useful for drivers using untrusted buffers: if a driver
      does not know exactly how much has been written by the device, the
      driver would have to zero the buffer in advance to ensure no data leakage
      occurs.
      <!--l. 614--><p class="noindent" >For example, a network driver may hand a received buffer directly to
      an unprivileged userspace application. If the network device has not
      overwritten  the  bytes  which  were  in  that  buffer,  this  could  leak  the
      contents of freed memory from other processes to the application.
<!--l. 620--><p class="noindent" ><span 
class="aeti-10">idx </span>field indicates where the driver would put the next descriptor entry in the ring
(modulo the queue size). This starts at 0, and increases.
<span 
class="aebx-10">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to these structures as vring_used
      and                                                                   vring_used_elem,
      and the constant as VRING_USED_F_NO_NOTIFY, but the layout and
      value were identical.
<a 
 id="x1-40016r39"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.4.8.1   </span> <a 
 id="x1-410001"></a>Legacy Interface: The Virtqueue Used Ring</h5>
<!--l. 635--><p class="noindent" >Historically, many drivers ignored the <span 
class="aeti-10">len </span>value, as a result, many devices set <span 
class="aeti-10">len</span>
incorrectly. Thus, when using the legacy interface, it is generally a good idea to
ignore the <span 
class="aeti-10">len </span>value in used ring entries if possible. Specific known issues are listed
per device type.
<a 
 id="x1-41001r41"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.8.2   </span> <a 
 id="x1-420002"></a>Device Requirements: The Virtqueue Used Ring</h5>
<!--l. 643--><p class="noindent" >The device MUST set <span 
class="aeti-10">len </span>prior to updating the used <span 
class="aeti-10">idx</span>.
<!--l. 645--><p class="noindent" >The device MUST write at least <span 
class="aeti-10">len </span>bytes to descriptor, beginning at the first
device-writable buffer, prior to updating the used <span 
class="aeti-10">idx</span>.
<!--l. 649--><p class="noindent" >The device MAY write more than <span 
class="aeti-10">len </span>bytes to descriptor.
<span 
class="aebx-10">Note:</span> There are potential error cases where a device might not know what parts
      of the buffers have been written. This is why <span 
class="aeti-10">len </span>is permitted to be an
      underestimate: that’s preferable to the driver believing that uninitialized
      memory has been overwritten when it has not.
<a 
 id="x1-42001r42"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.8.3   </span> <a 
 id="x1-430003"></a>Driver Requirements: The Virtqueue Used Ring</h5>
<!--l. 660--><p class="noindent" >The driver MUST NOT make assumptions about data in device-writable buffers
beyond the first <span 
class="aeti-10">len </span>bytes, and SHOULD ignore this data.
<a 
 id="x1-43001r40"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.9   </span> <a 
 id="x1-440009"></a>Virtqueue Notification Suppression</h4>
<!--l. 665--><p class="noindent" >The device can suppress notifications in a manner analogous to the way drivers can
suppress interrupts as detailed in section <a 
href="#x1-370007">2.4.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Interrupt Suppression --></a>. The device manipulates <span 
class="aeti-10">flags </span>or
<span 
class="aeti-10">avail_event </span>in the used ring the same way the driver manipulates <span 
class="aeti-10">flags </span>or <span 
class="aeti-10">used_event</span>
in the available ring.
<a 
 id="x1-44001r43"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.9.1   </span> <a 
 id="x1-450001"></a>Driver Requirements: Virtqueue Notification Suppression</h5>
<!--l. 672--><p class="noindent" >The driver MUST initialize <span 
class="aeti-10">flags </span>in the used ring to 0 when allocating the used
ring.
<!--l. 675--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST ignore the <span 
class="aeti-10">avail_event </span>value.
     </li>
     <li class="itemize">After the driver writes a descriptor index into the available ring:
                                                                  

                                                                  
         <ul class="itemize2">
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 1, the driver SHOULD NOT send a notification.
         </li>
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 0, the driver MUST send a notification.</li></ul>
     </li></ul>
<!--l. 685--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST ignore the lower bit of <span 
class="aeti-10">flags</span>.
     </li>
     <li class="itemize">After the driver writes a descriptor index into the available ring:
         <ul class="itemize2">
         <li class="itemize">If the <span 
class="aeti-10">idx  </span>field in the available ring (which determined where that
         descriptor  index  was  placed)  was  equal  to  <span 
class="aeti-10">avail_event</span>,  the  driver
         MUST send a notification.
         </li>
         <li class="itemize">Otherwise the driver SHOULD NOT send a notification.</li></ul>
     </li></ul>
<a 
 id="x1-45001r45"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.4.9.2   </span> <a 
 id="x1-460002"></a>Device Requirements: Virtqueue Notification Suppression</h5>
<!--l. 698--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST set <span 
class="aeti-10">flags </span>to 0 or 1.
     </li>
     <li class="itemize">The device MAY set <span 
class="aeti-10">flags </span>to 1 to advise the driver that notifications are
     not needed.</li></ul>
<!--l. 705--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST set <span 
class="aeti-10">flags </span>to 0.
     </li>
     <li class="itemize">The device MAY use <span 
class="aeti-10">avail_event </span>to advise the driver that notifications
     are unnecessary until the driver writes entry with an index specified by
     <span 
class="aeti-10">avail_event </span>into the available ring (equivalently, until <span 
class="aeti-10">idx </span>in the available
     ring will reach the value <span 
class="aeti-10">avail_event </span>+ 1).</li></ul>
<!--l. 712--><p class="noindent" >The device MUST handle spurious notifications from the driver.
<a 
 id="x1-46001r44"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">2.4.10   </span> <a 
 id="x1-4700010"></a>Helpers for Operating Virtqueues</h4>
<!--l. 716--><p class="noindent" >The Linux Kernel Source code contains the definitions above and helper routines in a
more usable form, in include/uapi/linux/virtio_ring.h. This was explicitly licensed
by IBM and Red Hat under the (3-clause) BSD license so that it can be
freely used by all other projects, and is reproduced (with slight variation) in
<a 
href="#x1-329000A">A<!--tex4ht:ref: sec:virtio-queue.h --></a> <a 
href="#x1-329000A">virtio_queue.h<!--tex4ht:ref: sec:virtio-queue.h --></a>.
                                                                  

                                                                  
<!--l. 723--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">3</span> <a 
 id="x1-480003"></a>General Initialization And Device Operation</h2>
We start with an overview of device initialization, then expand on the details of the
device and how each step is preformed. This section is best read along with the
bus-specific section which describes how to communicate with the specific
device.
<a 
 id="x1-48001r22"></a>
<h3 class="sectionHead"><span class="titlemark">3.1   </span> <a 
 id="x1-490001"></a>Device Initialization</h3>
<a 
 id="x1-49001r47"></a>
<h4 class="subsectionHead"><span class="titlemark">3.1.1   </span> <a 
 id="x1-500001"></a>Driver Requirements: Device Initialization</h4>
<!--l. 733--><p class="noindent" >The driver MUST follow this sequence to initialize a device:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-50002x1">Reset the device.
     </li>
     <li 
  class="enumerate" id="x1-50004x2">Set the ACKNOWLEDGE status bit: the guest OS has notice the device.
     </li>
     <li 
  class="enumerate" id="x1-50006x3">Set the DRIVER status bit: the guest OS knows how to drive the device.
     </li>
     <li 
  class="enumerate" id="x1-50008x4"><a 
 id="x1-500074"></a> Read device feature bits, and write the subset of feature bits understood
     by the OS and driver to the device. During this step the driver MAY read
     (but MUST NOT write) the device-specific configuration fields to check
     that it can support the device before accepting it.
     </li>
     <li 
  class="enumerate" id="x1-50010x5"><a 
 id="x1-500095"></a> Set the FEATURES_OK status bit. The driver MUST NOT accept new
     feature bits after this step.
     </li>
     <li 
  class="enumerate" id="x1-50012x6"><a 
 id="x1-500116"></a> Re-read  <span 
class="aeti-10">device  status  </span>to  ensure  the  FEATURES_OK  bit  is  still  set:
     otherwise, the device does not support our subset of features and the
     device is unusable.
     </li>
     <li 
  class="enumerate" id="x1-50014x7"><a 
 id="x1-500137"></a> Perform device-specific setup, including discovery of virtqueues for the
     device, optional per-bus setup, reading and possibly writing the device’s
     virtio configuration space, and population of virtqueues.
     </li>
     <li 
  class="enumerate" id="x1-50016x8"><a 
 id="x1-500158"></a> Set the DRIVER_OK status bit. At this point the device is “live”.</li></ol>
<!--l. 762--><p class="noindent" >If any of these steps go irrecoverably wrong, the driver SHOULD set the FAILED
status bit to indicate that it has given up on the device (it can reset the device later
to restart if desired). The driver MUST NOT continue initialization in that
case.
                                                                  

                                                                  
<!--l. 767--><p class="noindent" >The driver MUST NOT notify the device before setting DRIVER_OK.
<a 
 id="x1-50017r50"></a>
<h4 class="subsectionHead"><span class="titlemark">3.1.2   </span> <a 
 id="x1-510002"></a>Legacy Interface: Device Initialization</h4>
<!--l. 770--><p class="noindent" >Legacy devices did not support the FEATURES_OK status bit, and thus did not
have a graceful way for the device to indicate unsupported feature combinations.
They also did not provide a clear mechanism to end feature negotiation,
which meant that devices finalized features on first-use, and no features
could be introduced which radically changed the initial operation of the
device.
<!--l. 777--><p class="noindent" >Legacy driver implementations often used the device before setting the DRIVER_OK
bit, and sometimes even before writing the feature bits to the device.
<!--l. 781--><p class="noindent" >The result was the steps <a 
href="#x1-500095">5<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set FEATURES-OK --></a> and <a 
href="#x1-500116">6<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Re-read FEATURES-OK --></a> were omitted, and steps <a 
href="#x1-500074">4<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Read feature bits --></a>, <a 
href="#x1-500137">7<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Device-specific Setup --></a> and <a 
href="#x1-500158">8<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set DRIVER-OK --></a> were
conflated.
<!--l. 790--><p class="noindent" >Therefore, when using the legacy interface:
     <ul class="itemize1">
     <li class="itemize">The  transitional  driver  MUST  execute  the  initialization  sequence  as
     described in <a 
href="#x1-490001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> but omitting the steps <a 
href="#x1-500095">5<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set FEATURES-OK --></a> and <a 
href="#x1-500116">6<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Re-read FEATURES-OK --></a>.
     </li>
     <li class="itemize">The  transitional  device  MUST  support  the  driver  writing  device
     configuration fields before the step <a 
href="#x1-500074">4<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Read feature bits --></a>.
     </li>
     <li class="itemize">The transitional device MUST support the driver using the device before
     the step <a 
href="#x1-500158">8<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set DRIVER-OK --></a>.</li></ul>
<a 
 id="x1-51001r49"></a>
<h3 class="sectionHead"><span class="titlemark">3.2   </span> <a 
 id="x1-520002"></a>Device Operation</h3>
<!--l. 814--><p class="noindent" >There are two parts to device operation: supplying new buffers to the device, and
processing used buffers from the device.
<span 
class="aebx-10">Note:</span> As an example, the simplest virtio network device has two virtqueues: the
      transmit virtqueue and the receive virtqueue. The driver adds outgoing
      (device-readable) packets to the transmit virtqueue, and then frees them
      after  they  are  used.  Similarly,  incoming  (device-writable)  buffers  are
      added to the receive virtqueue, and processed after they are used.
<a 
 id="x1-52001r51"></a>
<h4 class="subsectionHead"><span class="titlemark">3.2.1   </span> <a 
 id="x1-530001"></a>Supplying Buffers to The Device</h4>
<!--l. 828--><p class="noindent" >The driver offers buffers to one of the device’s virtqueues as follows:
                                                                  

                                                                  
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-53002x1"><a 
 id="x1-530011"></a> The driver places the buffer into free descriptor(s) in the descriptor table,
     chaining as necessary (see <a 
href="#x1-300005">2.4.5<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a> <a 
href="#x1-300005">The Virtqueue Descriptor Table<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>).
     </li>
     <li 
  class="enumerate" id="x1-53004x2"><a 
 id="x1-530032"></a> The driver places the index of the head of the descriptor chain into the
     next ring entry of the available ring.
     </li>
     <li 
  class="enumerate" id="x1-53006x3">Steps <a 
href="#x1-530011">1<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Operation / Supplying Buffers to The Device / Place Buffers --></a> and <a 
href="#x1-530032">2<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Operation / Supplying Buffers to The Device / Place Index --></a> MAY be performed repeatedly if batching is possible.
     </li>
     <li 
  class="enumerate" id="x1-53008x4">The driver performs suitable a memory barrier to ensure the device sees
     the updated descriptor table and available ring before the next step.
     </li>
     <li 
  class="enumerate" id="x1-53010x5">The available <span 
class="aeti-10">idx  </span>is increased by the number of descriptor chain heads
     added to the available ring.
     </li>
     <li 
  class="enumerate" id="x1-53012x6">The driver performs a suitable memory barrier to ensure that it updates
     the <span 
class="aeti-10">idx </span>field before checking for notification suppression.
     </li>
     <li 
  class="enumerate" id="x1-53014x7">If notifications are not suppressed, the driver notifies the device of the new
     available buffers.</li></ol>
<!--l. 854--><p class="noindent" >Note that the above code does not take precautions against the available ring buffer
wrapping around: this is not possible since the ring buffer is the same size as the
descriptor table, so step (1) will prevent such a condition.
<!--l. 859--><p class="noindent" >In addition, the maximum queue size is 32768 (the highest power of 2 which fits in 16
bits), so the 16-bit <span 
class="aeti-10">idx </span>value can always distinguish between a full and empty
buffer.
<!--l. 863--><p class="noindent" >What follows is the requirements of each stage in more detail.
<a 
 id="x1-53015r46"></a>
<h5 class="subsubsectionHead"><span class="titlemark">3.2.1.1   </span> <a 
 id="x1-540001"></a>Placing Buffers Into The Descriptor Table</h5>
<!--l. 867--><p class="noindent" >A buffer consists of zero or more device-readable physically-contiguous elements
followed by zero or more physically-contiguous device-writable elements (each has at
least one element). This algorithm maps it into the descriptor table to form a
descriptor chain:
<!--l. 873--><p class="noindent" >for each buffer element, b:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-54002x1">Get the next free descriptor table entry, d
     </li>
     <li 
  class="enumerate" id="x1-54004x2">Set <span 
class="aeti-10">d.addr </span>to the physical address of the start of b
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x1-54006x3">Set <span 
class="aeti-10">d.len </span>to the length of b.
     </li>
     <li 
  class="enumerate" id="x1-54008x4">If b is device-writable, set <span 
class="aeti-10">d.flags </span>to VIRTQ_DESC_F_WRITE, otherwise
     0.
     </li>
     <li 
  class="enumerate" id="x1-54010x5">If there is a buffer element after this:
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x1-54012x1">Set <span 
class="aeti-10">d.next </span>to the index of the next free descriptor element.
         </li>
         <li 
  class="enumerate" id="x1-54014x2">Set the VIRTQ_DESC_F_NEXT bit in <span 
class="aeti-10">d.flags</span>.</li></ol>
     </li></ol>
<!--l. 889--><p class="noindent" >In practice, <span 
class="aeti-10">d.next </span>is usually used to chain free descriptors, and a separate
count kept to check there are enough free descriptors before beginning the
mappings.
<a 
 id="x1-54015r54"></a>
<h5 class="subsubsectionHead"><span class="titlemark">3.2.1.2   </span> <a 
 id="x1-550002"></a>Updating The Available Ring</h5>
<!--l. 895--><p class="noindent" >The descriptor chain head is the first d in the algorithm above, ie. the index of the
descriptor table entry referring to the first part of the buffer. A naive driver
implementation MAY do the following (with the appropriate conversion to-and-from
little-endian assumed):
<!--l. 900-->
<div class="lstlisting" id="listing-8"><span class="label"><a 
 id="x1-55001r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 904--><p class="noindent" >However, in general the driver MAY add many descriptor chains before it updates <span 
class="aeti-10">idx</span>
(at which point they become visible to the device), so it is common to keep a counter
of how many the driver has added:
<!--l. 908-->
<div class="lstlisting" id="listing-9"><span class="label"><a 
 id="x1-55002r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[(</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">added</span><span 
class="pcrr8t-x-x-80">++)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<a 
 id="x1-55003r55"></a>
<h5 class="subsubsectionHead"><span class="titlemark">3.2.1.3   </span> <a 
 id="x1-560003"></a>Updating <span 
class="aeti-10">idx</span></h5>
<!--l. 914--><p class="noindent" ><span 
class="aeti-10">idx </span>always increments, and wraps naturally at 65536:
<!--l. 917-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-10"><span class="label"><a 
 id="x1-56001r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">added</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 921--><p class="noindent" >Once available <span 
class="aeti-10">idx </span>is updated by the driver, this exposes the descriptor and its
contents. The device MAY access the descriptor chains the driver created and the
memory they refer to immediately.
<a 
 id="x1-56002r35"></a>
<h5 class="paragraphHead"><span class="titlemark">3.2.1.3.1</span> <a 
 id="x1-570001"></a>Driver Requirements: Updating idx</h5>
The driver MUST perform a suitable memory barrier before the <span 
class="aeti-10">idx </span>update, to
ensure the device sees the most up-to-date copy.
<a 
 id="x1-57001r56"></a>
<h5 class="subsubsectionHead"><span class="titlemark">3.2.1.4   </span> <a 
 id="x1-580004"></a>Notifying The Device</h5>
<!--l. 932--><p class="noindent" >The actual method of device notification is bus-specific, but generally it can be
expensive. So the device MAY suppress such notifications if it doesn’t need them, as
detailed in section <a 
href="#x1-440009">2.4.9<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Notification Suppression --></a>.
<!--l. 936--><p class="noindent" >The driver has to be careful to expose the new <span 
class="aeti-10">idx </span>value before checking if
notifications are suppressed.
<a 
 id="x1-58001r57"></a>
<h5 class="paragraphHead"><span class="titlemark">3.2.1.4.1</span> <a 
 id="x1-590001"></a>Driver Requirements: Notifying The Device</h5>
The driver MUST perform a suitable memory barrier before reading <span 
class="aeti-10">flags </span>or
<span 
class="aeti-10">avail_event</span>, to avoid missing a notification.
<a 
 id="x1-59001r53"></a>
<h4 class="subsectionHead"><span class="titlemark">3.2.2   </span> <a 
 id="x1-600002"></a>Receiving Used Buffers From The Device</h4>
<!--l. 945--><p class="noindent" >Once the device has used buffers referred to by a descriptor (read from or written to
them, or parts of both, depending on the nature of the virtqueue and the device), it
interrupts the driver as detailed in section <a 
href="#x1-370007">2.4.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Interrupt Suppression --></a>.
<span 
class="aebx-10">Note:</span> For  optimal  performance,  a  driver  MAY  disable  interrupts  while
      processing the used ring, but beware the problem of missing interrupts
      between emptying the ring and reenabling interrupts. This is usually
      handled  by  re-checking  for  more  used  buffers  after  interrups  are
      re-enabled:
      <!--l. 955-->
      <div class="lstlisting" id="listing-11"><span class="label"><a 
 id="x1-60001r1"></a></span><span 
class="pcrr8t-x-x-80">virtq_disable_interrupts</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60003r3"></a></span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(;;)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16_to_cpu</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_enable_interrupts</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mb</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16_to_cpu</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">break</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_disable_interrupts</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80">vsz</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">process_buffer</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80">++;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-60017r17"></a></span><span 
class="pcrr8t-x-x-80">}</span>
      
                                                                  

                                                                  
      </div>
<a 
 id="x1-60018r60"></a>
<h4 class="subsectionHead"><span class="titlemark">3.2.3   </span> <a 
 id="x1-610003"></a>Notification of Device Configuration Changes</h4>
<!--l. 978--><p class="noindent" >For devices where the device-specific configuration information can be changed, an
interrupt is delivered when a device-specific configuration change occurs.
<!--l. 981--><p class="noindent" >In addition, this interrupt is triggered by the device setting DEVICE_NEEDS_RESET
(see <a 
href="#x1-120002">2.1.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Status Field / DEVICENEEDSRESET --></a>).
<a 
 id="x1-61001r52"></a>
<h3 class="sectionHead"><span class="titlemark">3.3   </span> <a 
 id="x1-620003"></a>Device Cleanup</h3>
<!--l. 986--><p class="noindent" >Once the driver has set the DRIVER_OK status bit, all the configured virtqueue of
the device are considered live. None of the virtqueues of a device are live once the
device has been reset.
<a 
 id="x1-62001r61"></a>
<h4 class="subsectionHead"><span class="titlemark">3.3.1   </span> <a 
 id="x1-630001"></a>Driver Requirements: Device Cleanup</h4>
<!--l. 992--><p class="noindent" >A driver MUST NOT alter descriptor table entries which have been exposed in the
available ring (and not marked consumed by the device in the used ring) of a live
virtqueue.
<!--l. 996--><p class="noindent" >A driver MUST NOT decrement the available <span 
class="aeti-10">idx </span>on a live virtqueue (ie. there is no
way to “unexpose” buffers).
<!--l. 999--><p class="noindent" >Thus a driver MUST ensure a virtqueue isn’t live (by device reset) before removing
exposed buffers.
                                                                  

                                                                  
<!--l. 1001--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">4</span> <a 
 id="x1-640004"></a>Virtio Transport Options</h2>
Virtio can use various different buses, thus the standard is split into virtio general
and bus-specific sections.
<a 
 id="x1-64001r62"></a>
<h3 class="sectionHead"><span class="titlemark">4.1   </span> <a 
 id="x1-650001"></a>Virtio Over PCI Bus</h3>
<!--l. 1008--><p class="noindent" >Virtio devices are commonly implemented as PCI devices.
<!--l. 1010--><p class="noindent" >A Virtio device can be implemented as any kind of PCI device: a Conventional PCI
device or a PCI Express device. To assure designs meet the latest level requirements,
see the PCI-SIG home page at <a 
href="http://www.pcisig.com" class="url" >http://www.pcisig.com</a> for any approved
changes.
<a 
 id="x1-65001r63"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.1   </span> <a 
 id="x1-660001"></a>Device Requirements: Virtio Over PCI Bus</h4>
<!--l. 1018--><p class="noindent" >A Virtio device using Virtio Over PCI Bus MUST expose to guest an interface that
meets the specification requirements of the appropriate PCI specification: <a 
href="#x1-3001r1">[PCI]</a> and
<a 
href="#x1-3001r1">[PCIe]</a> respectively.
<a 
 id="x1-66001r66"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.2   </span> <a 
 id="x1-670002"></a>PCI Device Discovery</h4>
<!--l. 1026--><p class="noindent" >Any PCI device with PCI Vendor ID 0x1AF4, and PCI Device ID 0x1000 through
0x107F inclusive is a virtio device. The actual value within this range indicates which
virtio device is supported by the device. The PCI Device ID is calculated by adding
0x1040 to the Virtio Device ID, as indicated in section <a 
href="#x1-1560005">5<!--tex4ht:ref: sec:Device Types --></a>. Additionally, devices MAY
utilize a Transitional PCI Device ID range, 0x1000 to 0x103F depending on the
device type.
<a 
 id="x1-67001r58"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.1   </span> <a 
 id="x1-680001"></a>Device Requirements: PCI Device Discovery</h5>
<!--l. 1036--><p class="noindent" >Devices MUST have the PCI Vendor ID 0x1AF4. Devices MUST either have the PCI
Device ID calculated by adding 0x1040 to the Virtio Device ID, as indicated in
section <a 
href="#x1-1560005">5<!--tex4ht:ref: sec:Device Types --></a> or have the Transitional PCI Device ID depending on the device type, as
follows:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Transitional PCI Device ID  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Virtio Device              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0x1000 </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >network card</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1001                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         block device               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1002                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > memory ballooning (traditional)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1003                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            console                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1004                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          SCSI host                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1005                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         entropy source             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1009                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         9P transport               </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-9"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 1062--><p class="noindent" >For example, the network card device with the Virtio Device ID 1 has the PCI Device
ID 0x1041 or the Transitional PCI Device ID 0x1000.
                                                                  

                                                                  
<!--l. 1065--><p class="noindent" >The PCI Subsystem Vendor ID and the PCI Subsystem Device ID MAY reflect the
PCI Vendor and Device ID of the environment (for informational purposes by the
driver).
<!--l. 1068--><p class="noindent" >Non-transitional devices SHOULD have a PCI Device ID in the range 0x1040 to
0x107f. Non-transitional devices SHOULD have a PCI Revision ID of 1 or higher.
Non-transitional devices SHOULD have a PCI Subsystem Device ID of 0x40 or
higher.
<!--l. 1073--><p class="noindent" >This is to reduce the chance of a legacy driver attempting to drive the device.
<a 
 id="x1-68001r68"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.2   </span> <a 
 id="x1-690002"></a>Driver Requirements: PCI Device Discovery</h5>
<!--l. 1077--><p class="noindent" >Drivers MUST match devices with the PCI Vendor ID 0x1AF4 and the PCI Device
ID in the range 0x1040 to 0x107f, calculated by adding 0x1040 to the Virtio Device
ID, as indicated in section <a 
href="#x1-1560005">5<!--tex4ht:ref: sec:Device Types --></a>. Drivers for device types listed in section <a 
href="#x1-670002">4.1.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a> MUST
match devices with the PCI Vendor ID 0x1AF4 and the Transitional PCI Device ID
indicated in section <a 
href="#x1-670002">4.1.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>.
<!--l. 1088--><p class="noindent" >Drivers MUST match any PCI Revision ID value. Drivers MAY match any PCI
Subsystem Vendor ID and any PCI Subsystem Device ID value.
<a 
 id="x1-69001r69"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.3   </span> <a 
 id="x1-700003"></a>Legacy Interfaces: A Note on PCI Device Discovery</h5>
<!--l. 1093--><p class="noindent" >Transitional devices MUST have a PCI Revision ID of 0. Transitional devices MUST
have the PCI Subsystem Device ID matching the Virtio Device ID, as indicated in
section <a 
href="#x1-1560005">5<!--tex4ht:ref: sec:Device Types --></a>. Transitional devices MUST have the Transitional PCI Device ID in the
range 0x1000 to 0x103f.
<!--l. 1099--><p class="noindent" >This is to match legacy drivers.
<a 
 id="x1-70001r67"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.3   </span> <a 
 id="x1-710003"></a>PCI Device Layout</h4>
<!--l. 1103--><p class="noindent" >The device is configured via I/O and/or memory regions (though see <a 
href="#x1-870007">4.1.4.7<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a> for
access via the PCI configuration space), as specified by Virtio Structure PCI
Capabilities.
<!--l. 1108--><p class="noindent" >Fields of different sizes are present in the device configuration regions. All 64-bit,
32-bit and 16-bit fields are little-endian. 64-bit fields are to be treated as two 32-bit
fields, with low 32 bit part followed by the high 32 bit part.
<a 
 id="x1-71001r70"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.3.1   </span> <a 
 id="x1-720001"></a>Driver Requirements: PCI Device Layout</h5>
<!--l. 1116--><p class="noindent" >For device configuration access, the driver MUST use 8-bit wide accesses for 8-bit
wide fields, 16-bit wide and aligned accesses for 16-bit wide fields and 32-bit
wide and aligned accesses for 32-bit and 64-bit wide fields. For 64-bit fields,
                                                                  

                                                                  
the driver MAY access each of the high and low 32-bit parts of the field
independently.
<a 
 id="x1-72001r72"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.3.2   </span> <a 
 id="x1-730002"></a>Device Requirements: PCI Device Layout</h5>
<!--l. 1125--><p class="noindent" >For 64-bit device configuration fields, the device MUST allow driver independent
access to high and low 32-bit parts of the field.
<a 
 id="x1-73001r71"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.4   </span> <a 
 id="x1-740004"></a>Virtio Structure PCI Capabilities</h4>
<!--l. 1130--><p class="noindent" >The virtio device configuration layout includes several structures:
     <ul class="itemize1">
     <li class="itemize">Common configuration
     </li>
     <li class="itemize">Notifications
     </li>
     <li class="itemize">ISR Status
     </li>
     <li class="itemize">Device-specific configuration (optional)
     </li>
     <li class="itemize">PCI configuration access</li></ul>
<!--l. 1139--><p class="noindent" >Each structure can be mapped by a Base Address register (BAR) belonging to the
function, or accessed via the special VIRTIO_PCI_CAP_PCI_CFG field in the PCI
configuration space.
<!--l. 1142--><p class="noindent" >The location of each structure is specified using a vendor-specific PCI capability
located on the capability list in PCI configuration space of the device. This virtio
structure capability uses little-endian format; all fields are read-only for the driver
unless stated otherwise:
<!--l. 1147-->
<div class="lstlisting" id="listing-12"><span class="label"><a 
 id="x1-74001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_vndr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI_CAP_ID_VNDR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ptr</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capability</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cfg_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Identifies</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structure</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bar</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Where</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">find</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Pad</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">full</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dword</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">within</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bar</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structure</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1160--><p class="noindent" >This structure can be followed by extra data, depending on <span 
class="aeti-10">cfg_type</span>, as documented
below.
<!--l. 1163--><p class="noindent" >The fields are interpreted as follows:
     <dl class="description"><dt class="description">
<span 
class="aebxti-10">cap_vndr</span> </dt><dd 
class="description">0x09; Identifies a vendor-specific capability.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebxti-10">cap_next</span> </dt><dd 
class="description">Link to next capability in the capability list in the PCI configuration
     space.
     </dd><dt class="description">
<span 
class="aebxti-10">cap_len</span> </dt><dd 
class="description">Length  of  this  capability  structure,  including  the  whole  of  struct
     virtio_pci_cap, and extra data if any. This length MAY include padding,
     or fields unused by the driver.
     </dd><dt class="description">
<span 
class="aebxti-10">cfg_type</span> </dt><dd 
class="description">identifies the structure, according to the following table:
     <!--l. 1180-->
     <div class="lstlisting" id="listing-13"><span class="label"><a 
 id="x1-74011r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Common</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74012r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_COMMON_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74013r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Notifications</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74014r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_NOTIFY_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74015r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ISR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74016r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_ISR_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74017r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74018r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_DEVICE_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74019r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">access</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-74020r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_PCI_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span>
     
     </div>
     <!--l. 1193--><p class="noindent" >Any other value is reserved for future use.
     <!--l. 1195--><p class="noindent" >Each structure is detailed individually below.
     <!--l. 1197--><p class="noindent" >The device MAY offer more than one structure of any type - this makes it
     possible for the device to expose multiple interfaces to drivers. The order of the
     capabilities in the capability list specifies the order of preference suggested by
     the device.
     <span 
class="aebx-10">Note:</span> For   example,   on   some   hypervisors,   notifications   using   IO
           accesses  are  faster  than  memory  accesses.  In  this  case,  the
           device  would  expose  two  capabilities  with  <span 
class="aeti-10">cfg_type   </span>set  to
           VIRTIO_PCI_CAP_NOTIFY_CFG:  the  first  one  addressing  an
           I/O  BAR,  the  second  one  addressing  a  memory  BAR.  In  this
           example, the driver would use the I/O BAR if I/O resources are
           available, and fall back on memory BAR when I/O resources are
           unavailable.
     </dd><dt class="description">
<span 
class="aebxti-10">bar</span> </dt><dd 
class="description">values 0x0 to 0x5 specify a Base Address register (BAR) belonging to the
     function located beginning at 10h in PCI Configuration Space and
     used to map the structure into Memory or I/O Space. The BAR is
     permitted to be either 32-bit or 64-bit, it can map Memory Space or I/O
     Space.
     <!--l. 1217--><p class="noindent" >Any other value is reserved for future use.
     </dd><dt class="description">
<span 
class="aebxti-10">offset</span> </dt><dd 
class="description">indicates where the structure begins relative to the base address associated
     with the BAR. The alignment requirements of <span 
class="aeti-10">offset </span>are indicated in each
     structure-specific section below.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebxti-10">length</span> </dt><dd 
class="description">indicates the length of the structure.
     <!--l. 1227--><p class="noindent" ><span 
class="aeti-10">length </span>MAY include padding, or fields unused by the driver, or future
     extensions.
     <span 
class="aebx-10">Note:</span> For example, a future device might present a large structure size of
           several MBytes. As current devices never utilize structures larger
           than 4KBytes in size, driver MAY limit the mapped structure size
           to e.g. 4KBytes (thus ignoring parts of structure after the first
           4KBytes) to allow forward compatibility with such devices without
           loss of functionality and without wasting resources.
     </dd></dl>
<a 
 id="x1-74021r73"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.1   </span> <a 
 id="x1-750001"></a>Driver Requirements: Virtio Structure PCI Capabilities</h5>
<!--l. 1243--><p class="noindent" >The driver MUST ignore any vendor-specific capability structure which has a
reserved <span 
class="aeti-10">cfg_type </span>value.
<!--l. 1246--><p class="noindent" >The driver SHOULD use the first instance of each virtio structure type they can
support.
<!--l. 1249--><p class="noindent" >The driver MUST accept a <span 
class="aeti-10">cap_len </span>value which is larger than specified here.
<!--l. 1251--><p class="noindent" >The driver MUST ignore any vendor-specific capability structure which has a
reserved <span 
class="aeti-10">bar </span>value.
<!--l. 1254--><p class="noindent" >The drivers SHOULD only map part of configuration structure large enough for
device operation. The drivers MUST handle an unexpectedly large <span 
class="aeti-10">length</span>, but MAY
check that <span 
class="aeti-10">length </span>is large enough for device operation.
<!--l. 1259--><p class="noindent" >The driver MUST NOT write into any field of the capability structure, with the
exception of those with <span 
class="aeti-10">cap_type </span>VIRTIO_PCI_CAP_PCI_CFG as detailed in
<a 
href="#x1-890002">4.1.4.7.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>.
<a 
 id="x1-75001r75"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.2   </span> <a 
 id="x1-760002"></a>Device Requirements: Virtio Structure PCI Capabilities</h5>
<!--l. 1265--><p class="noindent" >The device MUST include any extra data (from the beginning of the <span 
class="aeti-10">cap_vndr </span>field
through end of the extra data fields if any) in <span 
class="aeti-10">cap_len</span>. The device MAY append extra
data or padding to any structure beyond that.
<!--l. 1270--><p class="noindent" >If the device presents multiple structures of the same type, it SHOULD order them
from optimal (first) to least-optimal (last).
<a 
 id="x1-76001r76"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.3   </span> <a 
 id="x1-770003"></a>Common configuration structure layout</h5>
<!--l. 1275--><p class="noindent" >The common configuration structure is found at the <span 
class="aeti-10">bar </span>and <span 
class="aeti-10">offset </span>within the
VIRTIO_PCI_CAP_COMMON_CFG capability; its layout is below.
<!--l. 1277-->
<div class="lstlisting" id="listing-14"><span class="label"><a 
 id="x1-77001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_common_cfg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">About</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">whole</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_feature_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_feature</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver_feature_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver_feature</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">msix_config</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">config_generation</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">About</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">power</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_msix_vector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_enable</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-77021r21"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
     <dl class="description"><dt class="description">
<span 
class="aebxti-10">device_feature_select</span> </dt><dd 
class="description">The  driver  uses  this  to  select  which  feature  bits
     <span 
class="aeti-10">device_feature </span>shows. Value 0x0 selects Feature Bits 0 to 31, 0x1 selects
     Feature Bits 32 to 63, etc.
     </dd><dt class="description">
<span 
class="aebxti-10">device_feature</span> </dt><dd 
class="description">The device uses this to report which feature bits it is offering to
     the driver: the driver writes to <span 
class="aeti-10">device_feature_select </span>to select which feature
     bits are presented.
     </dd><dt class="description">
<span 
class="aebxti-10">driver_feature_select</span> </dt><dd 
class="description">The  driver  uses  this  to  select  which  feature  bits
     <span 
class="aeti-10">driver_feature </span>shows. Value 0x0 selects Feature Bits 0 to 31, 0x1 selects
     Feature Bits 32 to 63, etc.
     </dd><dt class="description">
<span 
class="aebxti-10">driver_feature</span> </dt><dd 
class="description">The driver writes this to accept feature bits offered by the
     device. Driver Feature Bits selected by <span 
class="aeti-10">driver_feature_select</span>.
     </dd><dt class="description">
<span 
class="aebxti-10">config_msix_vector</span> </dt><dd 
class="description">The driver sets the Configuration Vector for MSI-X.
     </dd><dt class="description">
<span 
class="aebxti-10">num_queues</span> </dt><dd 
class="description">The  device  specifies  the  maximum  number  of  virtqueues
     supported here.
     </dd><dt class="description">
<span 
class="aebxti-10">device_status</span> </dt><dd 
class="description">The driver writes the device status here (see <a 
href="#x1-100001">2.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Status Field --></a>). Writing 0 into
     this field resets the device.
     </dd><dt class="description">
<span 
class="aebxti-10">config_generation</span> </dt><dd 
class="description">Configuration  atomicity  value.  The  device  changes  this
     every time the configuration noticeably changes.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_select</span> </dt><dd 
class="description">Queue Select. The driver selects which virtqueue the following
     fields refer to.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_size</span> </dt><dd 
class="description">Queue Size. On reset, specifies the maximum queue size supported
                                                                  

                                                                  
     by  the  hypervisor.  This  can  be  modified  by  driver  to  reduce  memory
     requirements. A 0 means the queue is unavailable.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_msix_vector</span> </dt><dd 
class="description">The driver uses this to specify the queue vector for MSI-X.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_enable</span> </dt><dd 
class="description">The  driver  uses  this  to  selectively  prevent  the  device  from
     executing requests from this virtqueue. 1 - enabled; 0 - disabled.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_notify_off</span> </dt><dd 
class="description">The driver reads this to calculate the offset from start of
     Notification structure at which this virtqueue is located.
     <span 
class="aebx-10">Note:</span> this is <span 
class="aeti-10">not an offset in bytes. See </span><a 
href="#x1-800004"><span 
class="aeti-10">4.1.4.4</span><!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a> <span 
class="aeti-10">below.</span>
     </dd><dt class="description">
<span 
class="aebxti-10">queue_desc</span> </dt><dd 
class="description">The driver writes the physical address of Descriptor Table here. See
     section <a 
href="#x1-220004">2.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_avail</span> </dt><dd 
class="description">The driver writes the physical address of Available Ring here. See
     section <a 
href="#x1-220004">2.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_used</span> </dt><dd 
class="description">The driver writes the physical address of Used Ring here. See section
     <a 
href="#x1-220004">2.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.</dd></dl>
<a 
 id="x1-77022r59"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.3.1</span> <a 
 id="x1-780001"></a>Device Requirements: Common configuration structure layout</h5>
<span 
class="aeti-10">offset </span>MUST be 4-byte aligned.
<!--l. 1369--><p class="noindent" >The device MUST present at least one common configuration capability.
<!--l. 1371--><p class="noindent" >The device MUST present the feature bits it is offering in <span 
class="aeti-10">device_feature</span>, starting at
bit <span 
class="aeti-10">device_feature_select </span><span 
class="cmsy-10">∗ </span>32 for any <span 
class="aeti-10">device_feature_select </span>written by the
driver.
<span 
class="aebx-10">Note:</span> This means that it will present 0 for any <span 
class="aeti-10">device_feature_select </span>other than
      0 or 1, since no feature defined here exceeds 63.
<!--l. 1376--><p class="noindent" >The device MUST present any valid feature bits the driver has written in
<span 
class="aeti-10">driver_feature</span>, starting at bit <span 
class="aeti-10">driver_feature_select </span><span 
class="cmsy-10">∗ </span>32 for any <span 
class="aeti-10">driver_feature_select</span>
written by the driver. Valid feature bits are those which are subset of the
corresponding <span 
class="aeti-10">device_feature </span>bits. The device MAY present invalid bits written by the
driver.
<span 
class="aebx-10">Note:</span> This means that a device can ignore writes for feature bits it never
                                                                  

                                                                  
      offers, and simply present 0 on reads. Or it can just mirror what the
      driver wrote (but it will still have to check them when the driver sets
      FEATURES_OK).
<span 
class="aebx-10">Note:</span> A  driver  shouldn’t  write  invalid  bits  anyway,  as  per  <a 
href="#x1-500001">3.1.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Initialization --></a>,  but  this
      attempts to handle it.
<!--l. 1388--><p class="noindent" >The device MUST present a changed <span 
class="aeti-10">config_generation </span>after the driver has read a
device-specific configuration value which has changed since any part of the
device-specific configuration was last read.
<span 
class="aebx-10">Note:</span> As <span 
class="aeti-10">config_generation </span>is an 8-bit value, simply incrementing it on every
      configuration change could violate this requirement due to wrap. Better
      would be to set an internal flag when it has changed, and if that flag is set
      when the driver reads from the device-specific configuration, increment
      <span 
class="aeti-10">config_generation </span>and clear the flag.
<!--l. 1400--><p class="noindent" >The device MUST reset when 0 is written to <span 
class="aeti-10">device_status</span>, and present a 0 in
<span 
class="aeti-10">device_status </span>once that is done.
<!--l. 1403--><p class="noindent" >The device MUST present a 0 in <span 
class="aeti-10">queue_enable </span>on reset.
<!--l. 1405--><p class="noindent" >The device MUST present a 0 in <span 
class="aeti-10">queue_size </span>if the virtqueue corresponding to the
current <span 
class="aeti-10">queue_select </span>is unavailable.
<a 
 id="x1-78001r78"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.3.2</span> <a 
 id="x1-790002"></a>Driver Requirements: Common configuration structure layout</h5>
The driver MUST NOT write to <span 
class="aeti-10">device_feature</span>, <span 
class="aeti-10">num_queues</span>, <span 
class="aeti-10">config_generation </span>or
<span 
class="aeti-10">queue_notify_off</span>.
<!--l. 1412--><p class="noindent" >The driver MUST NOT write a value which is not a power of 2 to <span 
class="aeti-10">queue_size</span>.
<!--l. 1414--><p class="noindent" >The driver MUST configure the other virtqueue fields before enabling the virtqueue
with <span 
class="aeti-10">queue_enable</span>.
<!--l. 1417--><p class="noindent" >After writing 0 to <span 
class="aeti-10">device_status</span>, the driver MUST wait for a read of <span 
class="aeti-10">device_status </span>to
return 0 before reinitializing the device.
<!--l. 1420--><p class="noindent" >The driver MUST NOT write a 0 to <span 
class="aeti-10">queue_enable</span>.
<a 
 id="x1-79001r77"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.4   </span> <a 
 id="x1-800004"></a>Notification structure layout</h5>
<!--l. 1424--><p class="noindent" >The notification location is found using the VIRTIO_PCI_CAP_NOTIFY_CFG
capability. This capability is immediately followed by an additional field, like
so:
<!--l. 1428-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-15"><span class="label"><a 
 id="x1-80001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_notify_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-80002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-80003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-80004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1435--><p class="noindent" ><span 
class="aeti-10">notify_off_multiplier </span>is combined with the <span 
class="aeti-10">queue_notify_off  </span>to derive the Queue
Notify address within a BAR for a virtqueue:
<!--l. 1438-->
<div class="lstlisting" id="listing-16"><span class="label"><a 
 id="x1-80005r1"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span>
</div>
<!--l. 1442--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>and <span 
class="aeti-10">notify_off_multiplier </span>are taken from the notification capability
structure above, and the <span 
class="aeti-10">queue_notify_off </span>is taken from the common configuration
structure.
<span 
class="aebx-10">Note:</span> For  example,  if  <span 
class="aeti-10">notifier_off_multiplier  </span>is  0,  the  device  uses  the  same
      Queue Notify address for all queues.
<a 
 id="x1-80006r79"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.4.1</span> <a 
 id="x1-810001"></a>Device Requirements: Notification capability</h5>
The device MUST present at least one notification capability.
<!--l. 1454--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 2-byte aligned.
<!--l. 1456--><p class="noindent" >The device MUST either present <span 
class="aeti-10">notify_off_multiplier </span>as an even power of 2, or
present <span 
class="aeti-10">notify_off_multiplier </span>as 0.
<!--l. 1459--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 2 and MUST be large
enough to support queue notification offsets for all supported queues in all possible
configurations.
<!--l. 1463--><p class="noindent" >For all queues, the value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy:
<!--l. 1464-->
<div class="lstlisting" id="listing-17"><span class="label"><a 
 id="x1-81001r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">>=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<a 
 id="x1-81002r80"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.5   </span> <a 
 id="x1-820005"></a>ISR status capability</h5>
<!--l. 1470--><p class="noindent" >The VIRTIO_PCI_CAP_ISR_CFG capability refers to at least a single byte,
which contains the 8-bit ISR status field to be used for INT#x interrupt
handling.
<!--l. 1474--><p class="noindent" >The <span 
class="aeti-10">offset </span>for the <span 
class="aeti-10">ISR status </span>has no alignment requirements.
                                                                  

                                                                  
<!--l. 1476--><p class="noindent" >The ISR bits allow the device to distinguish between device-specific configuration
change interrupts and normal virtqueue interrupts:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits       </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                      </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1                                         </td><td style="text-align: left; min-width: \@testpach 4 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2 to 31    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Queue Interrupt  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Configuration Interrupt  </td><td style="text-align: left; min-width: \@testpach 4 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
</div>
<!--l. 1487--><p class="noindent" >To avoid an extra access, simply reading this register resets it to 0 and causes the
device to de-assert the interrupt.
<!--l. 1490--><p class="noindent" >In this way, driver read of ISR status causes the device to de-assert an interrupt.
<!--l. 1493--><p class="noindent" >See sections <a 
href="#x1-1030003">4.1.5.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Virtqueue Interrupts From The Device --></a> and <a 
href="#x1-1050004">4.1.5.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a> for how this is used.
<a 
 id="x1-82001r81"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.5.1</span> <a 
 id="x1-830001"></a>Device Requirements: ISR status capability</h5>
The device MUST present at least one VIRTIO_PCI_CAP_ISR_CFG capability.
<!--l. 1499--><p class="noindent" >The device MUST set the Device Configuration Interrupt bit in <span 
class="aeti-10">ISR status </span>before
sending a device configuration change notification to the driver.
<!--l. 1503--><p class="noindent" >If MSI-X capability is disabled, the device MUST set the Queue Interrupt bit in <span 
class="aeti-10">ISR</span>
<span 
class="aeti-10">status </span>before sending a virtqueue notification to the driver.
<!--l. 1507--><p class="noindent" >If MSI-X capability is disabled, the device MUST set the Interrupt Status bit
in the PCI Status register in the PCI Configuration Header of the device
to the logical OR of all bits in <span 
class="aeti-10">ISR status </span>of the device. The device then
asserts/deasserts INT#x interrupts unless masked according to standard PCI rules
<a 
href="#x1-3001r1">[PCI]</a>.
<!--l. 1513--><p class="noindent" >The device MUST reset <span 
class="aeti-10">ISR status </span>to 0 on driver read.
<a 
 id="x1-83001r83"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.5.2</span> <a 
 id="x1-840002"></a>Driver Requirements: ISR status capability</h5>
If MSI-X capability is enabled, the driver SHOULD NOT access <span 
class="aeti-10">ISR status </span>upon
detecting a Queue Interrupt.
<a 
 id="x1-84001r82"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.6   </span> <a 
 id="x1-850006"></a>Device-specific configuration</h5>
<!--l. 1522--><p class="noindent" >The device MUST present at least one VIRTIO_PCI_CAP_DEVICE_CFG capability
for any device type which has a device-specific configuration.
<a 
 id="x1-85001r84"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.6.1</span> <a 
 id="x1-860001"></a>Device Requirements: Device-specific configuration</h5>
The <span 
class="aeti-10">offset </span>for the device-specific configuration MUST be 4-byte aligned.
<a 
 id="x1-86001r85"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.7   </span> <a 
 id="x1-870007"></a>PCI configuration access capability</h5>
<!--l. 1531--><p class="noindent" >The VIRTIO_PCI_CAP_PCI_CFG capability creates an alternative (and likely
suboptimal) access method to the common configuration, notification, ISR and
device-specific configuration regions.
<!--l. 1535--><p class="noindent" >The capability is immediately followed by an additional field like so:
<!--l. 1537-->
<div class="lstlisting" id="listing-18"><span class="label"><a 
 id="x1-87001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cfg_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pci_cfg_data</span><span 
class="pcrr8t-x-x-80">[4];</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BAR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">access</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1544--><p class="noindent" >The fields <span 
class="aeti-10">cap.bar</span>, <span 
class="aeti-10">cap.length</span>, <span 
class="aeti-10">cap.offset </span>and <span 
class="aeti-10">pci_cfg_data </span>are read-write (RW) for the
driver.
<!--l. 1547--><p class="noindent" >To access a device region, the driver writes into the capability structure (ie. within
the PCI configuration space) as follows:
     <ul class="itemize1">
     <li class="itemize">The driver sets the BAR to access by writing to <span 
class="aeti-10">cap.bar</span>.
     </li>
     <li class="itemize">The driver sets the size of the access by writing 1, 2 or 4 to <span 
class="aeti-10">cap.length</span>.
     </li>
     <li class="itemize">The driver sets the offset within the BAR by writing to <span 
class="aeti-10">cap.offset</span>.</li></ul>
<!--l. 1560--><p class="noindent" >At that point, <span 
class="aeti-10">pci_cfg_data </span>will provide a window of size <span 
class="aeti-10">cap.length </span>into the given
<span 
class="aeti-10">cap.bar </span>at offset <span 
class="aeti-10">cap.offset</span>.
<a 
 id="x1-87005r86"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.7.1</span> <a 
 id="x1-880001"></a>Device Requirements: PCI configuration access capability</h5>
The device MUST present at least one VIRTIO_PCI_CAP_PCI_CFG capability.
<!--l. 1567--><p class="noindent" >Upon detecting driver write access to <span 
class="aeti-10">pci_cfg_data</span>, the device MUST execute a write
access at offset <span 
class="aeti-10">cap.offset </span>at BAR selected by <span 
class="aeti-10">cap.bar </span>using the first <span 
class="aeti-10">cap.length </span>bytes
from <span 
class="aeti-10">pci_cfg_data</span>.
<!--l. 1572--><p class="noindent" >Upon detecting driver read access to <span 
class="aeti-10">pci_cfg_data</span>, the device MUST execute a read
access of length cap.length at offset <span 
class="aeti-10">cap.offset </span>at BAR selected by <span 
class="aeti-10">cap.bar </span>and store
the first <span 
class="aeti-10">cap.length </span>bytes in <span 
class="aeti-10">pci_cfg_data</span>.
<a 
 id="x1-88001r88"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.7.2</span> <a 
 id="x1-890002"></a>Driver Requirements: PCI configuration access capability</h5>
The driver MUST NOT write a <span 
class="aeti-10">cap.offset </span>which is not a multiple of <span 
class="aeti-10">cap.length </span>(ie. all
accesses MUST be aligned).
                                                                  

                                                                  
<!--l. 1583--><p class="noindent" >The driver MUST NOT read or write <span 
class="aeti-10">pci_cfg_data </span>unless <span 
class="aeti-10">cap.bar</span>, <span 
class="aeti-10">cap.length </span>and
<span 
class="aeti-10">cap.offset </span>address <span 
class="aeti-10">cap.length </span>bytes within a BAR range specified by some other
Virtio Structure PCI Capability of type other than <span 
class="aeti-10">VIRTIO_PCI_CAP_PCI_CFG</span>.
<a 
 id="x1-89001r87"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.8   </span> <a 
 id="x1-900008"></a>Legacy Interfaces: A Note on PCI Device Layout</h5>
<!--l. 1591--><p class="noindent" >Transitional devices MUST present part of configuration registers in a legacy
configuration structure in BAR0 in the first I/O region of the PCI device, as
documented below. When using the legacy interface, transitional drivers MUST use
the legacy configuration structure in BAR0 in the first I/O region of the PCI device,
as documented below.
<!--l. 1598--><p class="noindent" >When using the legacy interface the driver MAY access the device-specific
configuration region using any width accesses, and a transitional device MUST
present driver with the same results as when accessed using the “natural” access
method (i.e. 32-bit accesses for 32-bit fields, etc).
<!--l. 1604--><p class="noindent" >Note that this is possible because while the virtio common configuration structure is
PCI (i.e. little) endian, when using the legacy interface the device-specific
configuration region is encoded in the native endian of the guest (where such
distinction is applicable).
<!--l. 1609--><p class="noindent" >When used through the legacy interface, the virtio common configuration structure
looks as follows:
<!--l. 1621--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Read
 /
 Write  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose</td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device
 Features
 bits
 0:31   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Driver
 Features
 bits
 0:31   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Queue
 Address</td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">queue_size</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ><span 
class="aeti-10">queue_select</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Queue
 Notify </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device
 Status </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > ISR <br 
class="newline" />Status </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       </td>
</tr></table>
<!--l. 1623--><p class="noindent" >If MSI-X is enabled for the device, two additional fields immediately follow this
header:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits                   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16                       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16                       </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Read/Write         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W                  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose (MSI-X)  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">config_msix_vector  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">queue_msix_vector  </span></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 1636--><p class="noindent" >Note: When MSI-X capability is enabled, device-specific configuration starts at byte
offset 24 in virtio common configuration structure structure. When MSI-X capability
is not enabled, device-specific configuration starts at byte offset 20 in virtio header.
ie. once you enable MSI-X on the device, the other fields move. If you turn it off
again, they move back!
<!--l. 1642--><p class="noindent" >Any device-specific configuration space immediately follows these general
headers:
                                                                  

                                                                  
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <div class="multirow"><!-- rows=3 -->
…</div>  </td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >
</td></tr><tr 
class="cline"><td><hr></td><td><hr></td><td></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Read / Write  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >   </td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >
</td></tr><tr 
class="cline"><td><hr></td><td><hr></td><td></td></tr><tr class="row-5"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >   </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 1655--><p class="noindent" >When accessing the device-specific configuration space using the legacy interface,
transitional drivers MUST access the device-specific configuration space at an offset
immediately following the general headers.
<!--l. 1660--><p class="noindent" >When using the legacy interface, transitional devices MUST present the
device-specific configuration space if any at an offset immediately following the
general headers.
<!--l. 1664--><p class="noindent" >Note that only Feature Bits 0 to 31 are accessible through the Legacy Interface.
When used through the Legacy Interface, Transitional Devices MUST assume that
Feature Bits 32 to 63 are not acknowledged by Driver.
<!--l. 1669--><p class="noindent" >As legacy devices had no <span 
class="aeti-10">config_generation </span>field, see <a 
href="#x1-210004">2.3.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a> <a 
href="#x1-210004">Legacy Interface: Device
Configuration Space<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a> for workarounds.
<a 
 id="x1-90001r90"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.9   </span> <a 
 id="x1-910009"></a>Non-transitional Device With Legacy Driver: A Note on PCI Device
Layout</h5>
<!--l. 1679--><p class="noindent" >All known legacy drivers check either the PCI Revision or the Device and Vendor
IDs, and thus won’t attempt to drive a non-transitional device.
<!--l. 1683--><p class="noindent" >A buggy legacy driver might mistakenly attempt to drive a non-transitional device. If
support for such drivers is required (as opposed to fixing the bug), the following
would be the recommended way to detect and handle them.
<span 
class="aebx-10">Note:</span> Such buggy drivers are not currently known to be used in production.
<a 
 id="x1-91001r1"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.4.9.0.1</span> <a 
 id="x1-920001"></a>  Device Requirements: Non-transitional Device With Legacy Driver
</h6>
Non-transitional devices, on a platform where a legacy driver for a legacy device with
the same ID (including PCI Revision, Device and Vendor IDs) is known to have
previously existed, SHOULD take the following steps to cause the legacy driver to fail
gracefully when it attempts to drive them:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-92002x1">Present an I/O BAR in BAR0, and
     </li>
     <li 
  class="enumerate" id="x1-92004x2">Respond to a single-byte zero write to offset 18 (corresponding to Device
     Status register in the legacy layout) of BAR0 by presenting zeroes on every
     BAR and ignoring writes.</li></ol>
<a 
 id="x1-92005r74"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">4.1.5   </span> <a 
 id="x1-930005"></a>PCI-specific Initialization And Device Operation</h4>
<a 
 id="x1-93001r91"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.1   </span> <a 
 id="x1-940001"></a>Device Initialization</h5>
<!--l. 1722--><p class="noindent" >This documents PCI-specific steps executed during Device Initialization.
<a 
 id="x1-94001r89"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.1</span> <a 
 id="x1-950001"></a>Virtio Device Configuration Layout Detection</h5>
As a prerequisite to device initialization, the driver scans the PCI capability list,
detecting virtio configuration layout using Virtio Structure PCI capabilities as
detailed in <a 
href="#x1-740004">4.1.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
<a 
 id="x1-95001r92"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.1.1</span> <a 
 id="x1-960001"></a>Legacy Interface: A Note on Device Layout Detection</h6>
Legacy drivers skipped the Device Layout Detection step, assuming legacy device
configuration space in BAR0 in I/O space unconditionally.
<!--l. 1735--><p class="noindent" >Legacy devices did not have the Virtio PCI Capability in their capability
list.
<!--l. 1738--><p class="noindent" >Therefore:
<!--l. 1740--><p class="noindent" >Transitional devices MUST expose the Legacy Interface in I/O space in
BAR0.
<!--l. 1743--><p class="noindent" >Transitional drivers MUST look for the Virtio PCI Capabilities on the capability list.
If these are not present, driver MUST assume a legacy device, and use it through the
legacy interface.
<!--l. 1748--><p class="noindent" >Non-transitional drivers MUST look for the Virtio PCI Capabilities on the capability
list. If these are not present, driver MUST assume a legacy device, and fail
gracefully.
<a 
 id="x1-96001r95"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.2</span> <a 
 id="x1-970002"></a>MSI-X Vector Configuration</h5>
When MSI-X capability is present and enabled in the device (through standard PCI
configuration space) <span 
class="aeti-10">config_msix_vector </span>and <span 
class="aeti-10">queue_msix_vector </span>are used to map
configuration change and queue interrupts to MSI-X vectors. In this case, the ISR
Status is unused.
<!--l. 1759--><p class="noindent" >Writing a valid MSI-X Table entry number, 0 to 0x7FF, to <span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector</span>
maps interrupts triggered by the configuration change/selected queue events
respectively to the corresponding MSI-X vector. To disable interrupts for an
event type, the driver unmaps this event by writing a special NO_VECTOR
value:
                                                                  

                                                                  
<!--l. 1766-->
<div class="lstlisting" id="listing-19"><span class="label"><a 
 id="x1-97001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">MSI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-97002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MSI_NO_VECTOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">xffff</span>
</div>
<!--l. 1771--><p class="noindent" >Note that mapping an event to vector might require device to allocate internal device
resources, and thus could fail.
<a 
 id="x1-97003r96"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.2.1</span> <a 
 id="x1-980001"></a>Device Requirements: MSI-X Vector Configuration</h6>
A device that has an MSI-X capability SHOULD support at least 2 and at most
0x800 MSI-X vectors. Device MUST report the number of vectors supported in <span 
class="aeti-10">Table</span>
<span 
class="aeti-10">Size </span>in the MSI-X Capability as specified in <a 
href="#x1-3001r1">[PCI]</a>. The device SHOULD restrict
the reported MSI-X Table Size field to a value that might benefit system
performance.
<span 
class="aebx-10">Note:</span> For example, a device which does not expect to send interrupts at a high
      rate might only specify 2 MSI-X vectors.
<!--l. 1787--><p class="noindent" >Device MUST support mapping any event type to any valid vector 0 to MSI-X <span 
class="aeti-10">Table</span>
<span 
class="aeti-10">Size</span>. Device MUST support unmapping any event type.
<!--l. 1791--><p class="noindent" >The device MUST return vector mapped to a given event, (NO_VECTOR if
unmapped) on read of <span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector</span>. The device
MUST have all queue and configuration change events are unmapped upon
reset.
<!--l. 1796--><p class="noindent" >Devices SHOULD NOT cause mapping an event to vector to fail unless it is
impossible for the device to satisfy the mapping request. Devices MUST report
mapping failures by returning the NO_VECTOR value when the relevant
<span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector </span>field is read.
<a 
 id="x1-98001r98"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.2.2</span> <a 
 id="x1-990002"></a>Driver Requirements: MSI-X Vector Configuration</h6>
Driver MUST support device with any MSI-X Table Size 0 to 0x7FF. Driver MAY
fall back on using INT#x interrupts for a device which only supports one MSI-X
vector (MSI-X Table Size = 0).
<!--l. 1808--><p class="noindent" >Driver MAY intepret the Table Size as a hint from the device for the suggested
number of MSI-X vectors to use.
<!--l. 1811--><p class="noindent" >Driver MUST NOT attempt to map an event to a vector outside the MSI-X Table
supported by the device, as reported by <span 
class="aeti-10">Table Size </span>in the MSI-X Capability.
<!--l. 1815--><p class="noindent" >After mapping an event to vector, the driver MUST verify success by reading the
Vector field value: on success, the previously written value is returned, and on
                                                                  

                                                                  
failure, NO_VECTOR is returned. If a mapping failure is detected, the driver
MAY retry mapping with fewer vectors, disable MSI-X or report device
failure.
<a 
 id="x1-99001r97"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.3</span> <a 
 id="x1-1000003"></a>Virtqueue Configuration</h5>
As a device can have zero or more virtqueues for bulk data
transport<span class="footnote-mark"><a 
href="#fn5x4" id="fn5x4-bk"><sup class="textsuperscript">5</sup></a></span><a 
 id="x1-100001f5"></a>,
the driver needs to configure them as part of the device-specific configuration.
<!--l. 1829--><p class="noindent" >The driver typically does this as follows, for each virtqueue a device has:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-100003x1">Write the virtqueue index (first queue is 0) to <span 
class="aeti-10">queue_select</span>.
     </li>
     <li 
  class="enumerate" id="x1-100005x2">Read  the  virtqueue  size  from  <span 
class="aeti-10">queue_size</span>.  This  controls  how  big  the
     virtqueue is (see <a 
href="#x1-220004">2.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a> <a 
href="#x1-220004">Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>). If this field is 0, the virtqueue does not
     exist.
     </li>
     <li 
  class="enumerate" id="x1-100007x3">Optionally, select a smaller virtqueue size and write it to <span 
class="aeti-10">queue_size</span>.
     </li>
     <li 
  class="enumerate" id="x1-100009x4">Allocate  and  zero  Descriptor  Table,  Available  and  Used  rings  for  the
     virtqueue in contiguous physical memory.
     </li>
     <li 
  class="enumerate" id="x1-100011x5">Optionally,  if  MSI-X  capability  is  present  and  enabled  on  the  device,
     select a vector to use to request interrupts triggered by virtqueue events.
     Write the MSI-X Table entry number corresponding to this vector into
     <span 
class="aeti-10">queue_msix_vector</span>. Read <span 
class="aeti-10">queue_msix_vector</span>: on success, previously written
     value is returned; on failure, NO_VECTOR value is returned.</li></ol>
<a 
 id="x1-100012r99"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.3.1</span> <a 
 id="x1-1010001"></a>Legacy Interface: A Note on Virtqueue Configuration</h6>
When using the legacy interface, the queue layout follows <a 
href="#x1-240002">2.4.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-240002">Legacy
Interfaces: A Note on Virtqueue Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> with an alignment of 4096. Driver
writes the physical address, divided by 4096 to the Queue Address
field<span class="footnote-mark"><a 
href="#fn6x4" id="fn6x4-bk"><sup class="textsuperscript">6</sup></a></span><a 
 id="x1-101001f6"></a>.
There was no mechanism to negotiate the queue size.
<a 
 id="x1-101002r94"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.2   </span> <a 
 id="x1-1020002"></a>Notifying The Device</h5>
<!--l. 1860--><p class="noindent" >The driver notifies the device by writing the 16-bit virtqueue index of this
virtqueue to the Queue Notify address. See <a 
href="#x1-800004">4.1.4.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a> for how to calculate this
                                                                  

                                                                  
address.
<a 
 id="x1-102001r102"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.3   </span> <a 
 id="x1-1030003"></a>Virtqueue Interrupts From The Device</h5>
<!--l. 1865--><p class="noindent" >If an interrupt is necessary for a virtqueue, the device would typically act as
follows:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-103002x1">Set the lower bit of the ISR Status field for the device.
         </li>
         <li 
  class="enumerate" id="x1-103004x2">Send the appropriate PCI interrupt for the device.</li></ol>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-103006x1">If <span 
class="aeti-10">queue_msix_vector </span>is not NO_VECTOR, request the appropriate
         MSI-X interrupt message for the device, <span 
class="aeti-10">queue_msix_vector </span>sets the
         MSI-X Table entry number.</li></ol>
     </li></ul>
<a 
 id="x1-103007r100"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.3.1</span> <a 
 id="x1-1040001"></a>Device Requirements: Virtqueue Interrupts From The Device</h5>
If MSI-X capability is enabled and <span 
class="aeti-10">queue_msix_vector </span>is NO_VECTOR for a
virtqueue, the device MUST NOT deliver an interrupt for that virtqueue.
<a 
 id="x1-104001r103"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.4   </span> <a 
 id="x1-1050004"></a>Notification of Device Configuration Changes</h5>
<!--l. 1892--><p class="noindent" >Some virtio PCI devices can change the device configuration state, as reflected in the
device-specific configuration region of the device. In this case:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-105002x1">Set the second lower bit of the ISR Status field for the device.
         </li>
         <li 
  class="enumerate" id="x1-105004x2">Send the appropriate PCI interrupt for the device.</li></ol>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
                                                                  

                                                                  
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-105006x1">If <span 
class="aeti-10">config_msix_vector </span>is not NO_VECTOR, request the appropriate
         MSI-X interrupt message for the device, <span 
class="aeti-10">config_msix_vector </span>sets the
         MSI-X Table entry number.</li></ol>
     </li></ul>
<!--l. 1912--><p class="noindent" >A single interrupt MAY indicate both that one or more virtqueue has been used and
that the configuration space has changed.
<a 
 id="x1-105007r104"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.4.1</span> <a 
 id="x1-1060001"></a>Device Requirements: Notification of Device Configuration Changes</h5>
If MSI-X capability is enabled and <span 
class="aeti-10">config_msix_vector </span>is NO_VECTOR,
the device MUST NOT deliver an interrupt for device configuration space
changes.
<a 
 id="x1-106001r106"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.4.2</span> <a 
 id="x1-1070002"></a>Driver Requirements: Notification of Device Configuration Changes</h5>
A driver MUST handle the case where the same interrupt is used to indicate
both device configuration space change and one or more virtqueues being
used.
<a 
 id="x1-107001r105"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.5   </span> <a 
 id="x1-1080005"></a>Driver Handling Interrupts</h5>
<!--l. 1927--><p class="noindent" >The driver interrupt handler would typically:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
         <ul class="itemize2">
         <li class="itemize">Read the ISR Status field, which will reset it to zero.
         </li>
         <li class="itemize">If the lower bit is set: look through the used rings of all virtqueues
         for the device, to see if any progress has been made by the device
         which requires servicing.
         </li>
         <li class="itemize">If the second lower bit is set: re-examine the configuration space to
         see what changed.</li></ul>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
         <ul class="itemize2">
         <li class="itemize">Look through the used rings of all virtqueues mapped to that MSI-X
         vector for the device, to see if any progress has been made by the
                                                                  

                                                                  
         device which requires servicing.
         </li>
         <li class="itemize">If the MSI-X vector is equal to <span 
class="aeti-10">config_msix_vector</span>, re-examine the
         configuration space to see what changed.</li></ul>
     </li></ul>
<a 
 id="x1-108001r65"></a>
<h3 class="sectionHead"><span class="titlemark">4.2   </span> <a 
 id="x1-1090002"></a>Virtio Over MMIO</h3>
<!--l. 1955--><p class="noindent" >Virtual environments without PCI support (a common situation in embedded devices
models) might use simple memory mapped device (“virtio-mmio”) instead of the PCI
device.
<!--l. 1959--><p class="noindent" >The memory mapped virtio device behaviour is based on the PCI device
specification. Therefore most operations including device initialization, queues
configuration and buffer transfers are nearly identical. Existing differences are
described in the following sections.
<a 
 id="x1-109001r93"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.1   </span> <a 
 id="x1-1100001"></a>MMIO Device Discovery</h4>
<!--l. 1967--><p class="noindent" >Unlike PCI, MMIO provides no generic device discovery mechanism. For each device,
the guest OS will need to know the location of the registers and interrupt(s) used.
The suggested binding for systems using flattened device trees is shown in this
example:
<!--l. 1972-->
<div class="lstlisting" id="listing-20"><span class="label"><a 
 id="x1-110001r1"></a></span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXAMPLE</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">taking</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1e000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">42.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-110002r2"></a></span><span 
class="pcrr8t-x-x-80">virtio_block@1e000</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-110003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compatible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">virtio</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80">mmio</span><span 
class="pcrr8t-x-x-80">";</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-110004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><0</span><span 
class="pcrr8t-x-x-80">x1e000</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x200</span><span 
class="pcrr8t-x-x-80">>;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-110005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupts</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><42>;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-110006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<a 
 id="x1-110007r110"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.2   </span> <a 
 id="x1-1110002"></a>MMIO Device Register Layout</h4>
<!--l. 1983--><p class="noindent" >MMIO virtio devices provide a set of memory mapped control registers followed by a
device-specific configuration space, described in the table <a 
href="#x1-111001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>.
<!--l. 1987--><p class="noindent" >All register values are organized as Little Endian.
<a 
 id="x1-111001r1"></a>
<!--l. 1998--><div class="longtable"> <table id="TBL-13" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-13-1g"><col 
id="TBL-13-1"><col 
id="TBL-13-2"></colgroup>
                                                                  

                                                                  
<tr  
 style="vertical-align:baseline;" id="TBL-13-1-"><td colspan="2" style="white-space:nowrap; text-align:center;" id="TBL-13-1-1"  
class="td11">    <div class="multicolumn"  style="white-space:nowrap; text-align:center;"> <div class="caption" 
><span class="id">Table 4.1: </span><span  
class="content">MMIO Device Register Layout</span></div><!--tex4ht:label?: x1-111001r1 -->                               </div>        <a 
 id="x1-111002"></a>
</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-2-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-2-1"  
class="td11">
 <!--l. 2001--><p class="noindent" ><span 
class="aeti-10">Name </span><br 
class="newline" />Offset       from
  base <br 
class="newline" />Direction          </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-2-2"  
class="td11">
 <!--l. 2001--><p class="noindent" ><span 
class="aebx-10">Function </span><br 
class="newline" />Description                                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-3-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-3-1"  
class="td11">
 <!--l. 2004--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-13-4-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-4-1"  
class="td11">               </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-4-2"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-13-12-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-12-1"  
class="td11">
 <!--l. 2015--><p class="noindent" ><span 
class="aeti-10">MagicValue </span><br 
class="newline" />0x000 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-12-2"  
class="td11">
 <!--l. 2015--><p class="noindent" ><span 
class="aebx-10">Magic value </span><br 
class="newline" />0x74726976  (a  Little  Endian  equivalent  of  the  “virt”
  string).                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-13-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-13-1"  
class="td11">
 <!--l. 2022--><p class="noindent" ><span 
class="aeti-10">Version </span><br 
class="newline" />0x004 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-13-2"  
class="td11">
 <!--l. 2022--><p class="noindent" ><span 
class="aebx-10">Device version number </span><br 
class="newline" />0x2.
  <span 
class="aebx-10">Note:</span> Legacy devices (see <a 
href="#x1-1210004">4.2.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a> <a 
href="#x1-1210004">Legacy interface<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a>) used
            0x1.
  <!--l. 2023--><p class="noindent" >                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-14-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-14-1"  
class="td11">
 <!--l. 2030--><p class="noindent" ><span 
class="aeti-10">DeviceID </span><br 
class="newline" />0x008 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-14-2"  
class="td11">
 <!--l. 2030--><p class="noindent" ><span 
class="aebx-10">Virtio Subsystem Device ID </span><br 
class="newline" />See  <a 
href="#x1-1560005">5<!--tex4ht:ref: sec:Device Types --></a> <a 
href="#x1-1560005">Device  Types<!--tex4ht:ref: sec:Device Types --></a>  for  possible  values.  Value  zero
  (0x0)  is  used  to  define  a  system  memory  map  with
  placeholder  devices  at  static,  well  known  addresses,
  assigning functions to them depending on user’s needs.  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-15-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-15-1"  
class="td11">
 <!--l. 2032--><p class="noindent" ><span 
class="aeti-10">VendorID </span><br 
class="newline" />0x00c <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-15-2"  
class="td11">
 <!--l. 2032--><p class="noindent" ><span 
class="aebx-10">Virtio Subsystem Vendor ID </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-16-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-16-1"  
class="td11">
 <!--l. 2042--><p class="noindent" ><span 
class="aeti-10">DeviceFeatures </span><br 
class="newline" />0x010 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-16-2"  
class="td11">
 <!--l. 2042--><p class="noindent" ><span 
class="aebx-10">Flags representing features the device supports </span><br 
class="newline" />Reading  from  this  register  returns  32  consecutive
  flag  bits,  the  least  significant  bit  depending  on  the
  last  value  written  to  <span 
class="aeti-10">DeviceFeaturesSel</span>.  Access  to
  this  register  returns  bits  <span 
class="aeti-10">DeviceFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32  </span>to
  <span 
class="cmr-10">(</span><span 
class="aeti-10">DeviceFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32) + 31</span>, eg. feature bits 0 to 31 if
  <span 
class="aeti-10">DeviceFeaturesSel </span>is set to 0 and features bits 32 to 63 if
  <span 
class="aeti-10">DeviceFeaturesSel </span>is set to 1. Also see <a 
href="#x1-130002">2.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a> <a 
href="#x1-130002">Feature Bits<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a>.  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-17-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-17-1"  
class="td11">
 <!--l. 2047--><p class="noindent" ><span 
class="aeti-10">DeviceFeaturesSel</span>
  <br 
class="newline" />0x014 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-17-2"  
class="td11">
 <!--l. 2047--><p class="noindent" ><span 
class="aebx-10">Device (host) features word selection. </span><br 
class="newline" />Writing to this register selects a set of 32 device feature
  bits accessible by reading from <span 
class="aeti-10">DeviceFeatures</span>.             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-18-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-18-1"  
class="td11">
 <!--l. 2056--><p class="noindent" ><span 
class="aeti-10">DriverFeatures </span><br 
class="newline" />0x020 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-18-2"  
class="td11">
 <!--l. 2056--><p class="noindent" ><span 
class="aebx-10">Flags  representing  device  features  understood</span>
  <span 
class="aebx-10">and activated by the driver </span><br 
class="newline" />Writing to this register sets 32 consecutive flag bits, the
  least significant bit depending on the last value written
  to <span 
class="aeti-10">DriverFeaturesSel</span>. Access to this register sets bits
  <span 
class="aeti-10">DriverFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32 </span>to <span 
class="cmr-10">(</span><span 
class="aeti-10">DriverFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32) + 31</span>,
  eg. feature bits 0 to 31 if <span 
class="aeti-10">DriverFeaturesSel </span>is set to 0
  and features bits 32 to 63 if <span 
class="aeti-10">DriverFeaturesSel </span>is set to
  1. Also see <a 
href="#x1-130002">2.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a> <a 
href="#x1-130002">Feature Bits<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a>.                                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-19-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-19-1"  
class="td11">
 <!--l. 2061--><p class="noindent" ><span 
class="aeti-10">DriverFeaturesSel</span>
  <br 
class="newline" />0x024 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-19-2"  
class="td11">
 <!--l. 2061--><p class="noindent" ><span 
class="aebx-10">Activated (guest) features word selection </span><br 
class="newline" />Writing  to  this  register  selects  a  set  of  32  activated
  feature bits accessible by writing to <span 
class="aeti-10">DriverFeatures</span>.       </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-20-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-20-1"  
class="td11">
 <!--l. 2069--><p class="noindent" ><span 
class="aeti-10">QueueSel </span><br 
class="newline" />0x030 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-20-2"  
class="td11">
 <!--l. 2069--><p class="noindent" ><span 
class="aebx-10">Virtual queue index </span><br 
class="newline" />Writing to this register selects the virtual queue that
  the following operations on <span 
class="aeti-10">QueueNumMax</span>, <span 
class="aeti-10">QueueNum</span>,
  <span 
class="aeti-10">QueueReady</span>,       <span 
class="aeti-10">QueueDescLow</span>,       <span 
class="aeti-10">QueueDescHigh</span>,
  <span 
class="aeti-10">QueueAvailLow</span>,  <span 
class="aeti-10">QueueAvailHigh</span>,  <span 
class="aeti-10">QueueUsedLow  </span>and
  <span 
class="aeti-10">QueueUsedHigh </span>apply to. The index number of the first
  queue is zero (0x0).                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-21-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-21-1"  
class="td11">
 <!--l. 2076--><p class="noindent" ><span 
class="aeti-10">QueueNumMax</span>
  <br 
class="newline" />0x034 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-21-2"  
class="td11">
 <!--l. 2076--><p class="noindent" ><span 
class="aebx-10">Maximum virtual queue size </span><br 
class="newline" />Reading  from  the  register  returns  the  maximum  size
  (number of elements) of the queue the device is ready to
  process or zero (0x0) if the queue is not available. This
  applies to the queue selected by writing to <span 
class="aeti-10">QueueSel</span>.     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-22-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-22-1"  
class="td11">
 <!--l. 2084--><p class="noindent" ><span 
class="aeti-10">QueueNum </span><br 
class="newline" />0x038 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-22-2"  
class="td11">
 <!--l. 2084--><p class="noindent" ><span 
class="aebx-10">Virtual queue size </span><br 
class="newline" />Queue  size  is  the  number  of  elements  in  the  queue,
  therefore in each of the Descriptor Table, the Available
  Ring and the Used Ring. Writing to this register notifies
  the device what size of the queue the driver will use. This
  applies to the queue selected by writing to <span 
class="aeti-10">QueueSel</span>.     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-23-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-23-1"  
class="td11">
 <!--l. 2091--><p class="noindent" ><span 
class="aeti-10">QueueReady </span><br 
class="newline" />0x044 <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-23-2"  
class="td11">
 <!--l. 2091--><p class="noindent" ><span 
class="aebx-10">Virtual queue ready bit </span><br 
class="newline" />Writing one (0x1) to this register notifies the device that
  it can execute requests from this virtual queue. Reading
  from this register returns the last value written to it.
  Both read and write accesses apply to the queue selected
  by writing to <span 
class="aeti-10">QueueSel</span>.                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-24-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-24-1"  
class="td11">
 <!--l. 2096--><p class="noindent" ><span 
class="aeti-10">QueueNotify </span><br 
class="newline" />0x050 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-24-2"  
class="td11">
 <!--l. 2096--><p class="noindent" ><span 
class="aebx-10">Queue notifier </span><br 
class="newline" />Writing a queue index to this register notifies the device
  that there are new buffers to process in the queue.        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-25-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-25-1"  
class="td11">
 <!--l. 2109--><p class="noindent" ><span 
class="aeti-10">InterruptStatus</span>
  <br 
class="newline" />0x60 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-25-2"  
class="td11">
 <!--l. 2109--><p class="noindent" ><span 
class="aebx-10">Interrupt status </span><br 
class="newline" />Reading from this register returns a bit mask of events that
  caused the device interrupt to be asserted. The following
  events are possible:
         <dl class="description"><dt class="description">
  <span 
class="aebx-10">Used Ring Update</span> </dt><dd 
class="description">-  bit  0  -  the  interrupt  was
         asserted because the device has updated the Used
         Ring in at least one of the active virtual queues.
         </dd><dt class="description">
  <span 
class="aebx-10">Configuration Change</span> </dt><dd 
class="description">-  bit  1  -  the  interrupt  was
         asserted because the configuration of the device
         has changed.</dd></dl>
  <!--l. 2110--><p class="noindent" >                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-26-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-26-1"  
class="td11">
 <!--l. 2115--><p class="noindent" ><span 
class="aeti-10">InterruptACK </span><br 
class="newline" />0x064 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-26-2"  
class="td11">
 <!--l. 2115--><p class="noindent" ><span 
class="aebx-10">Interrupt acknowledge </span><br 
class="newline" />Writing           a           value           with           bits
  set as defined in <span 
class="aeti-10">InterruptStatus </span>to this register notifies
  the device that events causing the interrupt have been
  handled.                                                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-27-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-27-1"  
class="td11">
 <!--l. 2124--><p class="noindent" ><span 
class="aeti-10">Status </span><br 
class="newline" />0x070 <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-27-2"  
class="td11">
 <!--l. 2124--><p class="noindent" ><span 
class="aebx-10">Device status </span><br 
class="newline" />Reading from this register returns the current device
  status flags. Writing non-zero values to this register sets
  the status flags, indicating the driver progress. Writing
  zero (0x0) to this register triggers a device reset. See
  also p. <a 
href="#x1-1150001">4.2.3.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-1150001">Device Initialization<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a>.                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-28-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-28-1"  
class="td11">
 <!--l. 2131--><p class="noindent" ><span 
class="aeti-10">QueueDescLow</span>
  <br 
class="newline" />0x080 <br 
class="newline" /><span 
class="aeti-10">QueueDescHigh</span>
  <br 
class="newline" />0x084 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-28-2"  
class="td11">
 <!--l. 2131--><p class="noindent" ><span 
class="aebx-10">Virtual  queue’s  Descriptor  Table  64  bit  long</span>
  <span 
class="aebx-10">physical address </span><br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueDescLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueDescHigh</span>) notifies the device about location of
  the Descriptor Table of the queue selected by writing to
  <span 
class="aeti-10">QueueSel </span>register.                                                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-29-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-29-1"  
class="td11">
 <!--l. 2138--><p class="noindent" ><span 
class="aeti-10">QueueAvailLow</span>
  <br 
class="newline" />0x090 <br 
class="newline" /><span 
class="aeti-10">QueueAvailHigh</span>
  <br 
class="newline" />0x094 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-29-2"  
class="td11">
 <!--l. 2138--><p class="noindent" ><span 
class="aebx-10">Virtual  queue’s  Available  Ring  64  bit  long</span>
  <span 
class="aebx-10">physical address </span><br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueAvailLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueAvailHigh</span>) notifies the device about location of
  the Available Ring of the queue selected by writing to
  <span 
class="aeti-10">QueueSel</span>.                                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-30-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-30-1"  
class="td11">
 <!--l. 2145--><p class="noindent" ><span 
class="aeti-10">QueueUsedLow</span>
  <br 
class="newline" />0x0a0 <br 
class="newline" /><span 
class="aeti-10">QueueUsedHigh</span>
  <br 
class="newline" />0x0a4 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-30-2"  
class="td11">
 <!--l. 2145--><p class="noindent" ><span 
class="aebx-10">Virtual queue’s Used Ring 64 bit long physical</span>
  <span 
class="aebx-10">address </span><br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueUsedLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueUsedHigh</span>) notifies the device about location of
  the  Used  Ring  of  the  queue  selected  by  writing  to
  <span 
class="aeti-10">QueueSel</span>.                                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-31-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-31-1"  
class="td11">
 <!--l. 2153--><p class="noindent" ><span 
class="aeti-10">ConfigGeneration</span>
  <br 
class="newline" />0x0fc <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-31-2"  
class="td11">
 <!--l. 2153--><p class="noindent" ><span 
class="aebx-10">Configuration atomicity value </span><br 
class="newline" /> Reading from this register returns a value describing
  a version of the device-specific configuration space (see
  <span 
class="aeti-10">Config</span>). The driver can then access the configuration
  space and, when finished, read <span 
class="aeti-10">ConfigGeneration </span>again.
  If  no  part  of  the  configuration  space  has  changed
  between these two <span 
class="aeti-10">ConfigGeneration </span>reads, the returned
  values  are  identical.  If  the  values  are  different,  the
  configuration space accesses were not atomic and the
  driver has to perform the operations again. See also <a 
href="#x1-170003">2.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space --></a>.  </td>

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-13-32-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-32-1"  
class="td11">
 <!--l. 2154--><p class="noindent" >            </td>
</tr>
<tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-33-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-33-1"  
class="td11">
 <!--l. 2159--><p class="noindent" ><span 
class="aeti-10">Config </span><br 
class="newline" />0x100+ <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-13-33-2"  
class="td11">
 <!--l. 2159--><p class="noindent" ><span 
class="aebx-10">Configuration space </span><br 
class="newline" /> Device-specific configuration space starts at the offset
  0x100 and is accessed with byte alignment. Its meaning
  and size depend on the device and the driver.              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-13-34-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-34-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-13-35-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-35-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-13-36-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-36-1"  
class="td11">
 <!--l. 2161--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-13-37-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-37-1"  
class="td11">
 <!--l. 2161--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-13-38-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-38-1"  
class="td11">
 <!--l. 2161--><p class="noindent" >            </td>
</tr>
<tr  
 style="vertical-align:baseline;" id="TBL-13-10-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-10-1"  
class="td11">
 <!--l. 2011--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-13-11-"><td  style="white-space:wrap; text-align:left;" id="TBL-13-11-1"  
class="td11">
 <!--l. 2011--><p class="noindent" >            </td>
</tr>
</table></div>
<a 
 id="x1-111003r108"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.2.1   </span> <a 
 id="x1-1120001"></a>Device Requirements: MMIO Device Register Layout</h5>
<!--l. 2165--><p class="nopar" >The device MUST return 0x74726976 in <span 
class="aeti-10">MagicValue</span>.
<!--l. 2167--><p class="noindent" >The device MUST return value 0x2 in <span 
class="aeti-10">Version</span>.
<!--l. 2169--><p class="noindent" >The device MUST present each event by setting the corresponding bit in
<span 
class="aeti-10">InterruptStatus </span>from the moment it takes place, until the driver acknowledges
the interrupt by writing a corresponding bit mask to the <span 
class="aeti-10">InterruptACK</span>
register. Bits which do not represent events which took place MUST be
zero.
<!--l. 2174--><p class="noindent" >Upon reset, the device MUST clear all bits in <span 
class="aeti-10">InterruptStatus </span>and ready bits in the
<span 
class="aeti-10">QueueReady </span>register for all queues in the device.
<!--l. 2177--><p class="noindent" >The device MUST change value returned in <span 
class="aeti-10">ConfigGeneration </span>if there is any risk of a
driver seeing an inconsistent configuration state.
<!--l. 2180--><p class="noindent" >The device MUST NOT access virtual queue contents when <span 
class="aeti-10">QueueReady </span>is zero
(0x0).
<a 
 id="x1-112001r113"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.2.2   </span> <a 
 id="x1-1130002"></a>Driver Requirements: MMIO Device Register Layout</h5>
<!--l. 2183--><p class="nopar" >The driver MUST NOT access memory locations not described in the table <a 
href="#x1-111001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a> (or, in
                                                                  

                                                                  
case of the configuration space, described in the device specification), MUST NOT
write to the read-only registers (direction R) and MUST NOT read from the
write-only registers (direction W).
<!--l. 2189--><p class="noindent" >The driver MUST only use 32 bit wide and aligned reads and writes to access the
control registers described in table <a 
href="#x1-111001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>. For the device-specific configuration space,
the driver MUST use 8 bit wide accesses for 8 bit wide fields, 16 bit wide and aligned
accesses for 16 bit wide fields and 32 bit wide and aligned accesses for 32 and 64 bit
wide fields.
<!--l. 2195--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">MagicValue </span>which is not 0x74726976,
although it MAY report an error.
<!--l. 2198--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">Version </span>which is not 0x2, although it MAY
report an error.
<!--l. 2201--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">DeviceID </span>0x0, but MUST NOT report any
error.
<!--l. 2204--><p class="noindent" >Before reading from <span 
class="aeti-10">DeviceFeatures</span>, the driver MUST write a value to
<span 
class="aeti-10">DeviceFeaturesSel</span>.
<!--l. 2206--><p class="noindent" >Before writing to the <span 
class="aeti-10">DriverFeatures </span>register, the driver MUST write a value to the
<span 
class="aeti-10">DriverFeaturesSel </span>register.
<!--l. 2208--><p class="noindent" >The driver MUST write a value to <span 
class="aeti-10">QueueNum </span>which is less than or equal to the value
presented by the device in <span 
class="aeti-10">QueueNumMax</span>.
<!--l. 2211--><p class="noindent" >When <span 
class="aeti-10">QueueReady </span>is not zero, the driver MUST NOT access <span 
class="aeti-10">QueueNum</span>,
<span 
class="aeti-10">QueueDescLow</span>, <span 
class="aeti-10">QueueDescHigh</span>, <span 
class="aeti-10">QueueAvailLow</span>, <span 
class="aeti-10">QueueAvailHigh</span>, <span 
class="aeti-10">QueueUsedLow</span>,
<span 
class="aeti-10">QueueUsedHigh</span>.
<!--l. 2215--><p class="noindent" >To stop using the queue the driver MUST write zero (0x0) to this <span 
class="aeti-10">QueueReady </span>and
MUST read the value back to ensure synchronization.
<!--l. 2219--><p class="noindent" >The driver MUST ignore undefined bits in <span 
class="aeti-10">InterruptStatus</span>.
<!--l. 2221--><p class="noindent" >The driver MUST write a value with a bit mask describing events it handled into
<span 
class="aeti-10">InterruptACK </span>when it finishes handling an interrupt and MUST NOT set any of the
undefined bits in the value.
<a 
 id="x1-113001r111"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.3   </span> <a 
 id="x1-1140003"></a>MMIO-specific Initialization And Device Operation</h4>
<a 
 id="x1-114001r114"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.1   </span> <a 
 id="x1-1150001"></a>Device Initialization</h5>
<a 
 id="x1-115001r107"></a>
<h5 class="paragraphHead"><span class="titlemark">4.2.3.1.1</span> <a 
 id="x1-1160001"></a>Driver Requirements: Device Initialization</h5>
The driver MUST start the device initialization by reading and checking values from
                                                                  

                                                                  
<span 
class="aeti-10">MagicValue </span>and <span 
class="aeti-10">Version</span>. If both values are valid, it MUST read <span 
class="aeti-10">DeviceID </span>and if its
value is zero (0x0) MUST abort initialization and MUST NOT access any other
register.
<!--l. 2236--><p class="noindent" >Further initialization MUST follow the procedure described in <a 
href="#x1-490001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-490001">Device
Initialization<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.
<a 
 id="x1-116001r116"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.2   </span> <a 
 id="x1-1170002"></a>Virtqueue Configuration</h5>
<!--l. 2241--><p class="nopar" >The driver will typically initialize the virtual queue in the following way:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-117002x1">Select the queue writing its index (first queue is 0) to <span 
class="aeti-10">QueueSel</span>.
     </li>
     <li 
  class="enumerate" id="x1-117004x2">Check if the queue is not already in use: read <span 
class="aeti-10">QueueReady</span>, and expect a
     returned value of zero (0x0).
     </li>
     <li 
  class="enumerate" id="x1-117006x3">Read maximum queue size (number of elements) from <span 
class="aeti-10">QueueNumMax</span>. If
     the returned value is zero (0x0) the queue is not available.
     </li>
     <li 
  class="enumerate" id="x1-117008x4">Allocate and zero the queue pages, making sure the memory is physically
     contiguous.  It  is  recommended  to  align  the  Used  Ring  to  an  optimal
     boundary (usually the page size).
     </li>
     <li 
  class="enumerate" id="x1-117010x5">Notify the device about the queue size by writing the size to <span 
class="aeti-10">QueueNum</span>.
     </li>
     <li 
  class="enumerate" id="x1-117012x6">Write physical addresses of the queue’s Descriptor Table, Available Ring
     and  Used  Ring  to  (respectively)  the  <span 
class="aeti-10">QueueDescLow</span>/<span 
class="aeti-10">QueueDescHigh</span>,
     <span 
class="aeti-10">QueueAvailLow</span>/<span 
class="aeti-10">QueueAvailHigh   </span>and   <span 
class="aeti-10">QueueUsedLow</span>/<span 
class="aeti-10">QueueUsedHigh</span>
     register pairs.
     </li>
     <li 
  class="enumerate" id="x1-117014x7">Write 0x1 to <span 
class="aeti-10">QueueReady</span>.</li></ol>
<a 
 id="x1-117015r118"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.3   </span> <a 
 id="x1-1180003"></a>Notifying The Device</h5>
<!--l. 2272--><p class="nopar" >The driver notifies the device about new buffers being available in a queue by writing
the index of the updated queue to <span 
class="aeti-10">QueueNotify</span>.
<a 
 id="x1-118001r119"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.4   </span> <a 
 id="x1-1190004"></a>Notifications From The Device</h5>
<!--l. 2277--><p class="nopar" >The memory mapped virtio device is using a single, dedicated interrupt signal,
which is asserted when at least one of the bits described in the description of
                                                                  

                                                                  
<span 
class="aeti-10">InterruptStatus </span>is set. This is how the device notifies the driver about a new
used buffer being available in the queue or about a change in the device
configuration.
<a 
 id="x1-119001r117"></a>
<h5 class="paragraphHead"><span class="titlemark">4.2.3.4.1</span> <a 
 id="x1-1200001"></a>Driver Requirements: Notifications From The Device</h5>
After receiving an interrupt, the driver MUST read <span 
class="aeti-10">InterruptStatus </span>to check what
caused the interrupt (see the register description). After the interrupt is handled, the
driver MUST acknowledge it by writing a bit mask corresponding to the handled
events to the InterruptACK register.
<a 
 id="x1-120001r115"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.4   </span> <a 
 id="x1-1210004"></a>Legacy interface</h4>
<!--l. 2293--><p class="nopar" >The legacy MMIO transport used page-based addressing, resulting in a slightly
different control register layout, the device initialization and the virtual queue
configuration procedure.
<!--l. 2297--><p class="noindent" >Table <a 
href="#x1-121001r2">4.2<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Legacy Register Layout --></a> presents control registers layout, omitting descriptions of registers which
did not change their function nor behaviour:
<a 
 id="x1-121001r2"></a>
<!--l. 2303--><div class="longtable"> <table id="TBL-14" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-14-1g"><col 
id="TBL-14-1"><col 
id="TBL-14-2"></colgroup>
                                                                  

                                                                  
<tr  
 style="vertical-align:baseline;" id="TBL-14-1-"><td colspan="2" style="white-space:nowrap; text-align:center;" id="TBL-14-1-1"  
class="td11">    <div class="multicolumn"  style="white-space:nowrap; text-align:center;"> <div class="caption" 
><span class="id">Table 4.2: </span><span  
class="content">MMIO Device Legacy Register Layout</span></div><!--tex4ht:label?: x1-121001r2 -->                     </div>        <a 
 id="x1-121002"></a>
</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-2-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-2-1"  
class="td11">
 <!--l. 2306--><p class="noindent" ><span 
class="aeti-10">Name </span><br 
class="newline" />Offset       from
  base <br 
class="newline" />Direction          </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-2-2"  
class="td11">
 <!--l. 2306--><p class="noindent" ><span 
class="aebx-10">Function </span><br 
class="newline" />Description                                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-3-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-3-1"  
class="td11">
 <!--l. 2309--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-4-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-4-1"  
class="td11">               </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-4-2"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-14-12-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-12-1"  
class="td11">
 <!--l. 2317--><p class="noindent" ><span 
class="aeti-10">MagicValue </span><br 
class="newline" />0x000 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-12-2"  
class="td11">
 <!--l. 2317--><p class="noindent" ><span 
class="aebx-10">Magic value </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-13-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-13-1"  
class="td11">
 <!--l. 2319--><p class="noindent" ><span 
class="aeti-10">Version </span><br 
class="newline" />0x004 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-13-2"  
class="td11">
 <!--l. 2319--><p class="noindent" ><span 
class="aebx-10">Device version number </span><br 
class="newline" />Legacy device returns value 0x1.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-14-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-14-1"  
class="td11">
 <!--l. 2321--><p class="noindent" ><span 
class="aeti-10">DeviceID </span><br 
class="newline" />0x008 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-14-2"  
class="td11">
 <!--l. 2321--><p class="noindent" ><span 
class="aebx-10">Virtio Subsystem Device ID </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-15-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-15-1"  
class="td11">
 <!--l. 2323--><p class="noindent" ><span 
class="aeti-10">VendorID </span><br 
class="newline" />0x00c <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-15-2"  
class="td11">
 <!--l. 2323--><p class="noindent" ><span 
class="aebx-10">Virtio Subsystem Vendor ID </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-16-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-16-1"  
class="td11">
 <!--l. 2325--><p class="noindent" ><span 
class="aeti-10">HostFeatures </span><br 
class="newline" />0x010 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-16-2"  
class="td11">
 <!--l. 2325--><p class="noindent" ><span 
class="aebx-10">Flags representing features the device supports </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-17-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-17-1"  
class="td11">
 <!--l. 2327--><p class="noindent" ><span 
class="aeti-10">HostFeaturesSel</span>
  <br 
class="newline" />0x014 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-17-2"  
class="td11">
 <!--l. 2327--><p class="noindent" ><span 
class="aebx-10">Device (host) features word selection. </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-18-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-18-1"  
class="td11">
 <!--l. 2329--><p class="noindent" ><span 
class="aeti-10">GuestFeatures </span><br 
class="newline" />0x020 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-18-2"  
class="td11">
 <!--l. 2329--><p class="noindent" ><span 
class="aebx-10">Flags  representing  device  features  understood</span>
  <span 
class="aebx-10">and activated by the driver </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-19-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-19-1"  
class="td11">
 <!--l. 2331--><p class="noindent" ><span 
class="aeti-10">GuestFeaturesSel</span>
  <br 
class="newline" />0x024 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-19-2"  
class="td11">
 <!--l. 2331--><p class="noindent" ><span 
class="aebx-10">Activated (guest) features word selection </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-20-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-20-1"  
class="td11">
 <!--l. 2339--><p class="noindent" ><span 
class="aeti-10">GuestPageSize </span><br 
class="newline" />0x028 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-20-2"  
class="td11">
 <!--l. 2339--><p class="noindent" ><span 
class="aebx-10">Guest page size </span><br 
class="newline" />The driver writes the guest page size in bytes to the
  register during initialization, before any queues are used.
  This value should be a power of 2 and is used by the
  device to calculate the Guest address of the first queue
  page (see QueuePFN).                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-21-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-21-1"  
class="td11">
 <!--l. 2347--><p class="noindent" ><span 
class="aeti-10">QueueSel </span><br 
class="newline" />0x030 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-21-2"  
class="td11">
 <!--l. 2347--><p class="noindent" ><span 
class="aebx-10">Virtual queue index </span><br 
class="newline" />Writing to this register selects the virtual queue that the
  following operations on the <span 
class="aeti-10">QueueNumMax</span>, <span 
class="aeti-10">QueueNum</span>,
  <span 
class="aeti-10">QueueAlign  </span>and  <span 
class="aeti-10">QueuePFN  </span>registers  apply  to.  The
  index number of the first queue is zero (0x0). .             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-22-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-22-1"  
class="td11">
 <!--l. 2355--><p class="noindent" ><span 
class="aeti-10">QueueNumMax</span>
  <br 
class="newline" />0x034 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-22-2"  
class="td11">
 <!--l. 2355--><p class="noindent" ><span 
class="aebx-10">Maximum virtual queue size </span><br 
class="newline" />Reading from the register returns the maximum size of
  the queue the device is ready to process or zero (0x0)
  if the queue is not available. This applies to the queue
  selected  by  writing  to  <span 
class="aeti-10">QueueSel  </span>and  is  allowed  only
  when <span 
class="aeti-10">QueuePFN </span>is set to zero (0x0), so when the queue
  is not actively used.                                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-23-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-23-1"  
class="td11">
 <!--l. 2363--><p class="noindent" ><span 
class="aeti-10">QueueNum </span><br 
class="newline" />0x038 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-23-2"  
class="td11">
 <!--l. 2363--><p class="noindent" ><span 
class="aebx-10">Virtual queue size </span><br 
class="newline" />Queue  size  is  the  number  of  elements  in  the  queue,
  therefore size of the descriptor table and both available
  and  used  rings.  Writing  to  this  register  notifies  the
  device what size of the queue the driver will use. This
  applies to the queue selected by writing to <span 
class="aeti-10">QueueSel</span>.     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-24-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-24-1"  
class="td11">
 <!--l. 2369--><p class="noindent" ><span 
class="aeti-10">QueueAlign </span><br 
class="newline" />0x03c <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-24-2"  
class="td11">
 <!--l. 2369--><p class="noindent" ><span 
class="aebx-10">Used Ring alignment in the virtual queue </span><br 
class="newline" />Writing  to  this  register  notifies  the  device  about
  alignment boundary of the Used Ring in bytes. This
  value should be a power of 2 and applies to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-25-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-25-1"  
class="td11">
 <!--l. 2383--><p class="noindent" ><span 
class="aeti-10">QueuePFN </span><br 
class="newline" />0x040 <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-25-2"  
class="td11">
 <!--l. 2383--><p class="noindent" ><span 
class="aebx-10">Guest physical page number of the virtual queue</span>
  <br 
class="newline" />Writing to this register notifies the device about location
  of  the  virtual  queue  in  the  Guest’s  physical  address
  space. This value is the index number of a page starting
  with the queue Descriptor Table. Value zero (0x0) means
  physical address zero (0x00000000) and is illegal. When
  the driver stops using the queue it writes zero (0x0)
  to this register. Reading from this register returns the
  currently used page number of the queue, therefore a
  value other than zero (0x0) means that the queue is in
  use. Both read and write accesses apply to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-26-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-26-1"  
class="td11">
 <!--l. 2385--><p class="noindent" ><span 
class="aeti-10">QueueNotify </span><br 
class="newline" />0x050 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-26-2"  
class="td11">
 <!--l. 2385--><p class="noindent" ><span 
class="aebx-10">Queue notifier </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-27-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-27-1"  
class="td11">
 <!--l. 2387--><p class="noindent" ><span 
class="aeti-10">InterruptStatus</span>
  <br 
class="newline" />0x60 <br 
class="newline" />R                    </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-27-2"  
class="td11">
 <!--l. 2387--><p class="noindent" ><span 
class="aebx-10">Interrupt status </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-28-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-28-1"  
class="td11">
 <!--l. 2389--><p class="noindent" ><span 
class="aeti-10">InterruptACK </span><br 
class="newline" />0x064 <br 
class="newline" />W                   </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-28-2"  
class="td11">
 <!--l. 2389--><p class="noindent" ><span 
class="aebx-10">Interrupt acknowledge </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-29-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-29-1"  
class="td11">
 <!--l. 2399--><p class="noindent" ><span 
class="aeti-10">Status </span><br 
class="newline" />0x070 <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-29-2"  
class="td11">
 <!--l. 2399--><p class="noindent" ><span 
class="aebx-10">Device status </span><br 
class="newline" />Reading from this register returns the current device
  status  flags.  Writing  non-zero  values  to  this  register
  sets the status flags, indicating the OS/driver progress.
  Writing zero (0x0) to this register triggers a device reset.
  The device sets <span 
class="aeti-10">QueuePFN </span>to zero (0x0) for all queues
  in the device. Also see <a 
href="#x1-490001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-490001">Device Initialization<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-30-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-30-1"  
class="td11">
 <!--l. 2401--><p class="noindent" ><span 
class="aeti-10">Config </span><br 
class="newline" />0x100+ <br 
class="newline" />RW                  </td><td  style="white-space:wrap; text-align:left;" id="TBL-14-30-2"  
class="td11">
 <!--l. 2401--><p class="noindent" ><span 
class="aebx-10">Configuration space </span><br 
class="newline" />                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-31-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-31-1"  
class="td11">             </td>                                                

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-32-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-32-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-33-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-33-1"  
class="td11">
 <!--l. 2403--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-34-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-34-1"  
class="td11">
 <!--l. 2403--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-35-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-35-1"  
class="td11">
 <!--l. 2403--><p class="noindent" >            </td>
</tr>
<tr  
 style="vertical-align:baseline;" id="TBL-14-10-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-10-1"  
class="td11">
 <!--l. 2316--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-11-"><td  style="white-space:wrap; text-align:left;" id="TBL-14-11-1"  
class="td11">
 <!--l. 2316--><p class="noindent" >            </td>
</tr>
</table></div>
<!--l. 2405--><p class="noindent" >The virtual queue page size is defined by writing to <span 
class="aeti-10">GuestPageSize</span>, as written by the
guest. The driver does this before the virtual queues are configured.
<!--l. 2409--><p class="noindent" >The virtual queue layout follows p. <a 
href="#x1-240002">2.4.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-240002">Legacy Interfaces: A Note on Virtqueue
Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>, with the alignment defined in <span 
class="aeti-10">QueueAlign</span>.
<!--l. 2413--><p class="noindent" >The virtual queue is configured as follows:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-121004x1">Select the queue writing its index (first queue is 0) to <span 
class="aeti-10">QueueSel</span>.
     </li>
     <li 
  class="enumerate" id="x1-121006x2">Check if the queue is not already in use: read <span 
class="aeti-10">QueuePFN</span>, expecting a
     returned value of zero (0x0).
     </li>
     <li 
  class="enumerate" id="x1-121008x3">Read maximum queue size (number of elements) from <span 
class="aeti-10">QueueNumMax</span>. If
     the returned value is zero (0x0) the queue is not available.
     </li>
     <li 
  class="enumerate" id="x1-121010x4">Allocate and zero the queue pages in contiguous virtual memory, aligning
     the Used Ring to an optimal boundary (usually page size). The driver
     should choose a queue size smaller than or equal to <span 
class="aeti-10">QueueNumMax</span>.
     </li>
     <li 
  class="enumerate" id="x1-121012x5">Notify the device about the queue size by writing the size to <span 
class="aeti-10">QueueNum</span>.
     </li>
     <li 
  class="enumerate" id="x1-121014x6">Notify the device about the used alignment by writing its value in bytes
     to <span 
class="aeti-10">QueueAlign</span>.
     </li>
     <li 
  class="enumerate" id="x1-121016x7">Write the physical number of the first page of the queue to the <span 
class="aeti-10">QueuePFN</span>
     register.</li></ol>
<!--l. 2440--><p class="noindent" >Notification mechanisms did not change.
                                                                  

                                                                  
<a 
 id="x1-121017r109"></a>
<h3 class="sectionHead"><span class="titlemark">4.3   </span> <a 
 id="x1-1220003"></a>Virtio Over Channel I/O</h3>
<!--l. 2444--><p class="nopar" >S/390 based virtual machines support neither PCI nor MMIO, so a different
transport is needed there.
<!--l. 2447--><p class="noindent" >virtio-ccw uses the standard channel I/O based mechanism used for the majority of
devices on S/390. A virtual channel device with a special control unit type acts as
proxy to the virtio device (similar to the way virtio-pci uses a PCI device) and
configuration and operation of the virtio device is accomplished (mostly) via channel
commands. This means virtio devices are discoverable via standard operating system
algorithms, and adding virtio support is mainly a question of supporting a new
control unit type.
<!--l. 2457--><p class="noindent" >As the S/390 is a big endian machine, the data structures transmitted via channel
commands are big-endian: this is made clear by use of the types be16, be32 and
be64.
<a 
 id="x1-122001r122"></a>
<h4 class="subsectionHead"><span class="titlemark">4.3.1   </span> <a 
 id="x1-1230001"></a>Basic Concepts</h4>
<!--l. 2463--><p class="nopar" >As a proxy device, virtio-ccw uses a channel-attached I/O control unit with a special
control unit type (0x3832) and a control unit model corresponding to the attached
virtio device’s subsystem device ID, accessed via a virtual I/O subchannel and a
virtual channel path of type 0x32. This proxy device is discoverable via normal
channel subsystem device discovery (usually a STORE SUBCHANNEL loop) and
answers to the basic channel commands:
     <ul class="itemize1">
     <li class="itemize">NO-OPERATION (0x03)
     </li>
     <li class="itemize">BASIC SENSE (0x04)
     </li>
     <li class="itemize">TRANSFER IN CHANNEL (0x08)
     </li>
     <li class="itemize">SENSE ID (0xe4)</li></ul>
<!--l. 2478--><p class="noindent" >For a virtio-ccw proxy device, SENSE ID will return the following information:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bytes  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Description                </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Contents              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > reserved                     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0xff                     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >1-2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >control unit type </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0x3832</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > control unit model       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <virtio device id>  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4-5     </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > device type                </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 6        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > device model              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 7-255  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > extended SenseId data  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
                                                                  

                                                                  
<!--l. 2499--><p class="noindent" >In addition to the basic channel commands, virtio-ccw defines a set of channel
commands related to configuration and operation of virtio:
<!--l. 2503-->
<div class="lstlisting" id="listing-21"><span class="label"><a 
 id="x1-123001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_VQ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x13</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_VDEV_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x33</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_IND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x43</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_CONF_IND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x53</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_IND_ADAPTER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x73</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_FEAT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x12</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_FEAT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x22</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x21</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_STATUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x31</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_VQ_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x32</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_VIRTIO_REV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x83</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-123013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_STATUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x72</span>
</div>
<a 
 id="x1-123014r120"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.1   </span> <a 
 id="x1-1240001"></a>Device Requirements: Basic Concepts</h5>
<!--l. 2521--><p class="nopar" >The virtio-ccw device acts like a normal channel device, as specified in <a 
href="#x1-3001r1">[S390 PoP]</a>
and <a 
href="#x1-3001r1">[S390 Common I/O]</a>. In particular:
     <ul class="itemize1">
     <li class="itemize">A device MUST post a unit check with command reject for any command
     it does not support.
     </li>
     <li class="itemize">If a driver did not suppress length checks for a channel command, the
     device MUST present a subchannel status as detailed in the architecture
     when the actual length did not match the expected length.
     </li>
     <li class="itemize">If a driver did suppress length checks for a channel command, the device
     MUST present a check condition if the transmitted data does not contain
     enough data to process the command. If the driver submitted a buffer that
     was too long, the device SHOULD accept the command.</li></ul>
<a 
 id="x1-124001r126"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.2   </span> <a 
 id="x1-1250002"></a>Driver Requirements: Basic Concepts</h5>
<!--l. 2540--><p class="nopar" >A driver for virtio-ccw devices MUST check for a control unit type of 0x3832 and
MUST ignore the device type and model.
<!--l. 2543--><p class="noindent" >A driver SHOULD attempt to provide the correct length in a channel command even
if it suppresses length checks for that command.
<a 
 id="x1-125001r125"></a>
<h4 class="subsectionHead"><span class="titlemark">4.3.2   </span> <a 
 id="x1-1260002"></a>Device Initialization</h4>
<!--l. 2548--><p class="nopar" >virtio-ccw uses several channel commands to set up a device.
<a 
 id="x1-126001r127"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.1   </span> <a 
 id="x1-1270001"></a>Setting the Virtio Revision</h5>
<!--l. 2552--><p class="nopar" >CCW_CMD_SET_VIRTIO_REV is issued by the driver to set the revision of the
virtio-ccw transport it intends to drive the device with. It uses the following
communication structure:
                                                                  

                                                                  
<!--l. 2556-->
<div class="lstlisting" id="listing-22"><span class="label"><a 
 id="x1-127001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_rev_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">revision</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2564--><p class="noindent" ><span 
class="aeti-10">revision </span>contains the desired revision id, <span 
class="aeti-10">length </span>the length of the data portion and
<span 
class="aeti-10">data </span>revision-dependent additional desired options.
<!--l. 2567--><p class="noindent" >The following values are supported:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">revision  </span></td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">length  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">data        </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > remarks                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > legacy interface; transitional devices only  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtio 1.0                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > CCW_CMD_READ_STATUS support      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3-n        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > reserved for later revisions                     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 2583--><p class="noindent" >Note that a change in the virtio standard does not necessarily correspond to a change
in the virtio-ccw revision.
<a 
 id="x1-127006r121"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.1</span> <a 
 id="x1-1280001"></a>Device Requirements: Setting the Virtio Revision</h5>
A device MUST post a unit check with command reject for any <span 
class="aeti-10">revision </span>it does not
support. For any invalid combination of <span 
class="aeti-10">revision</span>, <span 
class="aeti-10">length </span>and <span 
class="aeti-10">data</span>, it MUST post a
unit check with command reject as well. A non-transitional device MUST reject
revision id 0.
<!--l. 2593--><p class="noindent" >A device MUST answer with command reject to any virtio-ccw specific channel
command that is not contained in the revision selected by the driver.
<!--l. 2597--><p class="noindent" >A device MUST answer with command reject to any attempt to select a different
revision after a revision has been successfully selected by the driver.
<!--l. 2600--><p class="noindent" >A device MUST treat the revision as unset from the time the associated subchannel
has been enabled until a revision has been successfully set by the driver. This implies
that revisions are not persistent across disabling and enabling of the associated
subchannel.
<a 
 id="x1-128001r130"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.2</span> <a 
 id="x1-1290002"></a>Driver Requirements: Setting the Virtio Revision</h5>
A driver SHOULD start with trying to set the highest revision it supports and
continue with lower revisions if it gets a command reject.
<!--l. 2610--><p class="noindent" >A driver MUST NOT issue any other virtio-ccw specific channel commands prior to
setting the revision.
<!--l. 2613--><p class="noindent" >After a revision has been successfully selected by the driver, it MUST NOT attempt
to select a different revision.
<a 
 id="x1-129001r131"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.3</span> <a 
 id="x1-1300003"></a>Legacy Interfaces: A Note on Setting the Virtio Revision</h5>
A legacy device will not support the CCW_CMD_SET_VIRTIO_REV and answer
with a command reject. A non-transitional driver MUST stop trying to operate this
device in that case. A transitional driver MUST operate the device as if it had been
able to set revision 0.
<!--l. 2623--><p class="noindent" >A legacy driver will not issue the CCW_CMD_SET_VIRTIO_REV prior
to issuing other virtio-ccw specific channel commands. A non-transitional
device therefore MUST answer any such attempts with a command reject. A
transitional device MUST assume in this case that the driver is a legacy driver and
continue as if the driver selected revision 0. This implies that the device
MUST reject any command not valid for revision 0, including a subsequent
CCW_CMD_SET_VIRTIO_REV.
<a 
 id="x1-130001r129"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.2   </span> <a 
 id="x1-1310002"></a>Configuring a Virtqueue</h5>
<!--l. 2633--><p class="nopar" >CCW_CMD_READ_VQ_CONF is issued by the driver to obtain information about a
queue. It uses the following structure for communicating:
<!--l. 2636-->
<div class="lstlisting" id="listing-23"><span class="label"><a 
 id="x1-131001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_config_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2643--><p class="noindent" >The requested number of buffers for queue <span 
class="aeti-10">index </span>is returned in <span 
class="aeti-10">max_num</span>.
<!--l. 2646--><p class="noindent" >Afterwards, CCW_CMD_SET_VQ is issued by the driver to inform the device about
the location used for its queue. The transmitted structure is
<!--l. 2650-->
<div class="lstlisting" id="listing-24"><span class="label"><a 
 id="x1-131005r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_info_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131006r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131007r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">res0</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131008r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131009r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131010r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131011r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-131012r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2661--><p class="noindent" ><span 
class="aeti-10">desc</span>, <span 
class="aeti-10">avail </span>and <span 
class="aeti-10">used </span>contain the guest addresses for the descriptor table, available
ring and used ring for queue <span 
class="aeti-10">index</span>, respectively. The actual virtqueue size (number of
allocated buffers) is transmitted in <span 
class="aeti-10">num</span>.
<a 
 id="x1-131013r132"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.2.1</span> <a 
 id="x1-1320001"></a>Device Requirements: Configuring a Virtqueue</h5>
<span 
class="aeti-10">res0 </span>is reserved and MUST be ignored by the device.
<a 
 id="x1-132001r134"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">4.3.2.2.2</span> <a 
 id="x1-1330002"></a>Legacy Interface: A Note on Configuring a Virtqueue</h5>
For a legacy driver or for a driver that selected revision 0, CCW_CMD_SET_VQ uses
the following communication block:
<!--l. 2674-->
<div class="lstlisting" id="listing-25"><span class="label"><a 
 id="x1-133001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_info_block_legacy</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-133002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-133003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">align</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-133004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-133005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-133006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2683--><p class="noindent" ><span 
class="aeti-10">queue </span>contains the guest address for queue <span 
class="aeti-10">index</span>, <span 
class="aeti-10">num </span>the number of buffers and
<span 
class="aeti-10">align </span>the alignment. The queue layout follows <a 
href="#x1-240002">2.4.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-240002">Legacy Interfaces: A Note on
Virtqueue Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>.
<a 
 id="x1-133007r133"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.3   </span> <a 
 id="x1-1340003"></a>Communicating Status Information</h5>
<!--l. 2688--><p class="nopar" >The driver changes the status of a device via the CCW_CMD_WRITE_STATUS
command, which transmits an 8 bit status value.
<!--l. 2692--><p class="noindent" >As described in <a 
href="#x1-150002">2.2.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Feature Bits --></a>, a device sometimes fails to set the <span 
class="aeti-10">status </span>field: For
example, it might fail to accept the FEATURES_OK status bit during device
initialization.
<!--l. 2697--><p class="noindent" >With revision 2, CCW_CMD_READ_STATUS is defined: It reads an 8 bit status value
from the device and acts as a reverse operation to CCW_CMD_WRITE_STATUS.
<a 
 id="x1-134001r135"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.3.1</span> <a 
 id="x1-1350001"></a>Driver Requirements: Communicating Status Information</h5>
If the device posts a unit check with command reject in response to the
CCW_CMD_WRITE_STATUS command, the driver MUST assume that
the device failed to set the status and the <span 
class="aeti-10">status </span>field retained its previous
value.
<!--l. 2706--><p class="noindent" >If at least revision 2 has been negotiated, the driver SHOULD use the
CCW_CMD_READ_STATUS command to retrieve the <span 
class="aeti-10">status </span>field after a
configuration change has been detected.
<!--l. 2710--><p class="noindent" >If not at least revision 2 has been negotiated, the driver MUST NOT attempt to issue
the CCW_CMD_READ_STATUS command.
<a 
 id="x1-135001r137"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.3.2</span> <a 
 id="x1-1360002"></a>Device Requirements: Communicating Status Information</h5>
If the device fails to set the <span 
class="aeti-10">status </span>field to the value written by the driver, the device
MUST assure that the <span 
class="aeti-10">status </span>field is left unchanged and MUST post a unit check
with command reject.
                                                                  

                                                                  
<!--l. 2719--><p class="noindent" >If at least revision 2 has been negotiated, the device MUST return the current <span 
class="aeti-10">status</span>
field if the CCW_CMD_READ_STATUS command is issued.
<a 
 id="x1-136001r136"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.4   </span> <a 
 id="x1-1370004"></a>Handling Device Features</h5>
<!--l. 2724--><p class="nopar" >Feature bits are arranged in an array of 32 bit values, making for a total of 8192
feature bits. Feature bits are in little-endian byte order.
<!--l. 2728--><p class="noindent" >The CCW commands dealing with features use the following communication
block:
<!--l. 2731-->
<div class="lstlisting" id="listing-26"><span class="label"><a 
 id="x1-137001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_feature_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-137002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">features</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-137003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-137004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2738--><p class="noindent" ><span 
class="aeti-10">features </span>are the 32 bits of features currently accessed, while <span 
class="aeti-10">index </span>describes which of
the feature bit values is to be accessed. No padding is added at the end of the
structure, it is exactly 5 bytes in length.
<!--l. 2743--><p class="noindent" >The guest obtains the device’s device feature set via the CCW_CMD_READ_FEAT
command. The device stores the features at <span 
class="aeti-10">index </span>to <span 
class="aeti-10">features</span>.
<!--l. 2747--><p class="noindent" >For communicating its supported features to the device, the driver uses the
CCW_CMD_WRITE_FEAT command, denoting a <span 
class="aeti-10">features</span>/<span 
class="aeti-10">index </span>combination.
<a 
 id="x1-137005r139"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.5   </span> <a 
 id="x1-1380005"></a>Device Configuration</h5>
<!--l. 2753--><p class="nopar" >The device’s configuration space is located in host memory.
<!--l. 2755--><p class="noindent" >To obtain information from the configuration space, the driver uses
CCW_CMD_READ_CONF, specifying the guest memory for the device to write
to.
<!--l. 2759--><p class="noindent" >For changing configuration information, the driver uses CCW_CMD_WRITE_CONF,
specifying the guest memory for the device to read from.
<!--l. 2763--><p class="noindent" >In both cases, the complete configuration space is transmitted. This allows the driver
to compare the new configuration space with the old version, and keep a generation
count internally whenever it changes.
<a 
 id="x1-138001r140"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.6   </span> <a 
 id="x1-1390006"></a>Setting Up Indicators</h5>
<!--l. 2769--><p class="nopar" >In order to set up the indicator bits for host->guest notification, the driver
uses different channel commands depending on whether it wishes to use
traditional I/O interrupts tied to a subchannel or adapter I/O interrupts for
virtqueue notifications. For any given device, the two mechanisms are mutually
                                                                  

                                                                  
exclusive.
<!--l. 2775--><p class="noindent" >For the configuration change indicators, only a mechanism using traditional I/O
interrupts is provided, regardless of whether traditional or adapter I/O interrupts are
used for virtqueue notifications.
<a 
 id="x1-139001r138"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.1</span> <a 
 id="x1-1400001"></a>Setting Up Classic Queue Indicators</h5>
Indicators for notification via classic I/O interrupts are contained in a 64 bit value
per virtio-ccw proxy device.
<!--l. 2785--><p class="noindent" >To communicate the location of the indicator bits for host->guest notification, the
driver uses the CCW_CMD_SET_IND command, pointing to a location containing
the guest address of the indicators in a 64 bit value.
<!--l. 2790--><p class="noindent" >If the driver has already set up two-staged queue indicators via the
CCW_CMD_SET_IND_ADAPTER command, the device MUST post a unit check
with command reject to any subsequent CCW_CMD_SET_IND command.
<a 
 id="x1-140001r142"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.2</span> <a 
 id="x1-1410002"></a>Setting Up Configuration Change Indicators</h5>
Indicators for configuration change host->guest notification are contained in a 64 bit
value per virtio-ccw proxy device.
<!--l. 2799--><p class="noindent" >To communicate the location of the indicator bits used in the configuration change
host->guest notification, the driver issues the CCW_CMD_SET_CONF_IND
command, pointing to a location containing the guest address of the indicators in a
64 bit value.
<a 
 id="x1-141001r143"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.3</span> <a 
 id="x1-1420003"></a>Setting Up Two-Stage Queue Indicators</h5>
Indicators for notification via adapter I/O interrupts consist of two stages:
     <ul class="itemize1">
     <li class="itemize">a  summary  indicator  byte  covering  the  virtqueues  for  one  or  more
     virtio-ccw proxy devices
     </li>
     <li class="itemize">a set of contigous indicator bits for the virtqueues for a virtio-ccw proxy
     device</li></ul>
<!--l. 2815--><p class="noindent" >To communicate the location of the summary and queue indicator bits, the driver
uses the CCW_CMD_SET_IND_ADAPTER command with the following
payload:
<!--l. 2819-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-27"><span class="label"><a 
 id="x1-142001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_thinint_area</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">summary_indicator</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicator</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bit_nr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">isc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-142006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">__attribute__</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">((</span><span 
class="pcrr8t-x-x-80">packed</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 2828--><p class="noindent" ><span 
class="aeti-10">summary_indicator </span>contains the guest address of the 8 bit summary indicator.
<span 
class="aeti-10">indicator </span>contains the guest address of an area wherein the indicators for the devices
are contained, starting at <span 
class="aeti-10">bit_nr</span>, one bit per virtqueue of the device. Bit numbers
start at the left, i.e. the most significant bit in the first byte is assigned the bit
number 0. <span 
class="aeti-10">isc </span>contains the I/O interruption subclass to be used for the adapter I/O
interrupt. It MAY be different from the isc used by the proxy virtio-ccw device’s
subchannel. No padding is added at the end of the structure, it is exactly 25 bytes in
length.
<a 
 id="x1-142007r101"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.3.2.6.3.1</span> <a 
 id="x1-1430001"></a>Device Requirements: Setting Up Two-Stage Queue Indicators</h6>
If the driver has already set up classic queue indicators via the CCW_CMD_SET_IND
command, the device MUST post a unit check with command reject to any
subsequent CCW_CMD_SET_IND_ADAPTER command.
<a 
 id="x1-143001r144"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.4</span> <a 
 id="x1-1440004"></a>Legacy Interfaces: A Note on Setting Up Indicators</h5>
In some cases, legacy devices will only support classic queue indicators; in that case,
they will reject CCW_CMD_SET_IND_ADAPTER as they don’t know that
command. Some legacy devices will support two-stage queue indicators, though, and
a driver will be able to successfully use CCW_CMD_SET_IND_ADAPTER to set
them up.
<a 
 id="x1-144001r128"></a>
<h4 class="subsectionHead"><span class="titlemark">4.3.3   </span> <a 
 id="x1-1450003"></a>Device Operation</h4>
<a 
 id="x1-145001r141"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.1   </span> <a 
 id="x1-1460001"></a>Host->Guest Notification</h5>
<!--l. 2858--><p class="nopar" >There are two modes of operation regarding host->guest notification, classic I/O
interrupts and adapter I/O interrupts. The mode to be used is determined by the driver
by using CCW_CMD_SET_IND respectively CCW_CMD_SET_IND_ADAPTER to
set up queue indicators.
<!--l. 2863--><p class="noindent" >For configuration changes, the driver always uses classic I/O interrupts.
<a 
 id="x1-146001r146"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.1</span> <a 
 id="x1-1470001"></a>Notification via Classic I/O Interrupts</h5>
If the driver used the CCW_CMD_SET_IND command to set up queue indicators,
the device will use classic I/O interrupts for host->guest notification about virtqueue
                                                                  

                                                                  
activity.
<!--l. 2872--><p class="noindent" >For notifying the driver of virtqueue buffers, the device sets the corresponding bit in
the guest-provided indicators. If an interrupt is not already pending for the
subchannel, the device generates an unsolicited I/O interrupt.
<!--l. 2877--><p class="noindent" >If the device wants to notify the driver about configuration changes, it sets bit 0
in the configuration indicators and generates an unsolicited I/O interrupt,
if needed. This also applies if adapter I/O interrupts are used for queue
notifications.
<a 
 id="x1-147001r149"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.2</span> <a 
 id="x1-1480002"></a>Notification via Adapter I/O Interrupts</h5>
If the driver used the CCW_CMD_SET_IND_ADAPTER command to set up queue
indicators, the device will use adapter I/O interrupts for host->guest notification
about virtqueue activity.
<!--l. 2888--><p class="noindent" >For notifying the driver of virtqueue buffers, the device sets the bit in the
guest-provided indicator area at the corresponding offset. The guest-provided
summary indicator is set to 0x01. An adapter I/O interrupt for the corresponding
interruption subclass is generated.
<!--l. 2893--><p class="noindent" >The recommended way to process an adapter I/O interrupt by the driver is as
follows:
     <ul class="itemize1">
     <li class="itemize">Process all queue indicator bits associated with the summary indicator.
     </li>
     <li class="itemize">Clear  the  summary  indicator,  performing  a  synchronization  (memory
     barrier) afterwards.
     </li>
     <li class="itemize">Process all queue indicator bits associated with the summary indicator
     again.</li></ul>
<a 
 id="x1-148001r145"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.3.3.1.2.1</span> <a 
 id="x1-1490001"></a>Device Requirements: Notification via Adapter I/O Interrupts</h6>
The device SHOULD only generate an adapter I/O interrupt if the summary
indicator had not been set prior to notification.
<a 
 id="x1-149001r151"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.3.3.1.2.2</span> <a 
 id="x1-1500002"></a>Driver Requirements: Notification via Adapter I/O Interrupts</h6>
The driver MUST clear the summary indicator after receiving an adapter I/O
interrupt before it processes the queue indicators.
<a 
 id="x1-150001r150"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.3</span> <a 
 id="x1-1510003"></a>Legacy Interfaces: A Note on Host->Guest Notification</h5>
As legacy devices and drivers support only classic queue indicators, host->guest
notification will always be done via classic I/O interrupts.
<a 
 id="x1-151001r148"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.2   </span> <a 
 id="x1-1520002"></a>Guest->Host Notification</h5>
<!--l. 2921--><p class="nopar" >For notifying the device of virtqueue buffers, the driver unfortunately can’t use a
channel command (the asynchronous characteristics of channel I/O interact badly
with the host block I/O backend). Instead, it uses a diagnose 0x500 call with subcode
3 specifying the queue, as follows:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > GPR  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Input Value          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Output Value  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x3                     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Subchannel ID </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Host Cookie</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtqueue number  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Host Cookie          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<a 
 id="x1-152001r153"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.2.1</span> <a 
 id="x1-1530001"></a>Device Requirements: Guest->Host Notification</h5>
The device MUST ignore bits 0-31 (counting from the left) of GPR2. This aligns
passing the subchannel ID with the way it is passed for the existing I/O
instructions.
<!--l. 2946--><p class="noindent" >The device MAY return a 64-bit host cookie in GPR2 to speed up the notification
execution.
<a 
 id="x1-153001r155"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.2.2</span> <a 
 id="x1-1540002"></a>Driver Requirements: Guest->Host Notification</h5>
For each notification, the driver SHOULD use GPR4 to pass the host cookie received
in GPR2 from the previous notication.
<span 
class="aebx-10">Note:</span> For example: <!--l. 2955-->
      <div class="lstlisting" id="listing-28"><span class="label"><a 
 id="x1-154001r1"></a></span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">cookie</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">do_notify</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">schid</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-154002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue_get_queue_index</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-154003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">cookie</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
      
      </div>
<a 
 id="x1-154004r154"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.3   </span> <a 
 id="x1-1550003"></a>Resetting Devices</h5>
<!--l. 2964--><p class="nopar" >In order to reset a device, a driver sends the CCW_CMD_VDEV_RESET
command.
                                                                  

                                                                  
<!--l. 2968--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">5</span> <a 
 id="x1-1560005"></a>Device Types</h2>
On top of the queues, config space and feature negotiation facilities built into virtio,
several devices are defined.
<!--l. 2973--><p class="noindent" >The following device IDs are used to identify different types of virtio devices. Some
device IDs are reserved for devices which are not currently defined in this
standard.
<!--l. 2977--><p class="noindent" >Discovering what devices are available and their type is bus-dependent.
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device ID  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Virtio Device              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       reserved (invalid)            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         network card              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >block device</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            console                  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >4 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >entropy source</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 5             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > memory ballooning (traditional)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 6             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          ioMemory                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-9"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 7             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            rpmsg                   </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-10"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          SCSI host                </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-11"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >9 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >9P transport</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-12"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 10            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >        mac80211 wlan             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-13"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 11            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          rproc serial                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-14"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 12            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          virtio CAIF               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-15"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 13            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >        memory balloon            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-16"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          GPU device               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-17"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 17            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >      Timer/Clock device          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-18"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 18            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Input device               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-19"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 19            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Socket device              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-20"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 20            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Crypto device              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-21"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 21            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >   Signal Distribution Module     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-22"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 22            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         pstore device              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-23"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 24            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >    vhost-user device backend      </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-24"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 3029--><p class="noindent" >Some of the devices above are unspecified by this document, because they are seen as
immature or especially niche. Be warned that some are only specified by the sole
existing implementation; they could become part of a future specification, be
abandoned entirely, or live on outside this standard. We shall speak of them no
further.
<a 
 id="x1-156001r124"></a>
<h3 class="sectionHead"><span class="titlemark">5.1   </span> <a 
 id="x1-1570001"></a>Network Device</h3>
<!--l. 3038--><p class="nopar" >The virtio network device is a virtual ethernet card, and is the most complex of the
devices supported so far by virtio. It has enhanced rapidly and demonstrates clearly
how support for new features are added to an existing device. Empty buffers are
placed in one virtqueue for receiving packets, and outgoing packets are enqueued into
another for transmission in that order. A third command queue is used to control
advanced filtering features.
<a 
 id="x1-157001r147"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.1   </span> <a 
 id="x1-1580001"></a>Device ID</h4>
<!--l. 3049--><p class="nopar" >1
                                                                  

                                                                  
<a 
 id="x1-158001r160"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.2   </span> <a 
 id="x1-1590002"></a>Virtqueues</h4>
     <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">receiveq1
     </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">transmitq1
     </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description">
     </dd><dt class="description">
<span 
class="aebx-10">2(N-1)</span> </dt><dd 
class="description">receiveqN
     </dd><dt class="description">
<span 
class="aebx-10">2(N-1)+1</span> </dt><dd 
class="description">transmitqN
     </dd><dt class="description">
<span 
class="aebx-10">2N</span> </dt><dd 
class="description">controlq</dd></dl>
<!--l. 3062--><p class="nopar" >N=1 if VIRTIO_NET_F_MQ is not negotiated, otherwise N is set by
<span 
class="aeti-10">max_virtqueue_pairs</span>.
<!--l. 3065--><p class="noindent" >controlq only exists if VIRTIO_NET_F_CTRL_VQ set.
<a 
 id="x1-159001r161"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.3   </span> <a 
 id="x1-1600003"></a>Feature bits</h4>
     <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CSUM (0)</span> </dt><dd 
class="description">Device handles packets with partial checksum.
     This “checksum offload” is a common feature on modern network cards.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_CSUM (1)</span> </dt><dd 
class="description">Driver handles packets with partial
     checksum.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_GUEST_OFFLOADS (2)</span> </dt><dd 
class="description">Control        channel
     offloads reconfiguration support.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MTU(3)</span> </dt><dd 
class="description">Device maximum MTU reporting is supported. If
     offered by the device, device advises driver about the value of its maximum
     MTU. If negotiated, the driver uses <span 
class="aeti-10">mtu </span>as the maximum MTU value.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MAC (5)</span> </dt><dd 
class="description">Device has given MAC address.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_TSO4 (7)</span> </dt><dd 
class="description">Driver can receive TSOv4.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_TSO6 (8)</span> </dt><dd 
class="description">Driver can receive TSOv6.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_ECN (9)</span> </dt><dd 
class="description">Driver can receive TSO with ECN.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_UFO (10)</span> </dt><dd 
class="description">Driver can receive UFO.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_TSO4 (11)</span> </dt><dd 
class="description">Device can receive TSOv4.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_TSO6 (12)</span> </dt><dd 
class="description">Device can receive TSOv6.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_ECN (13)</span> </dt><dd 
class="description">Device can receive TSO with ECN.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_UFO (14)</span> </dt><dd 
class="description">Device can receive UFO.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MRG_RXBUF (15)</span> </dt><dd 
class="description">Driver can merge receive buffers.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_STATUS (16)</span> </dt><dd 
class="description">Configuration status field is available.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_VQ (17)</span> </dt><dd 
class="description">Control channel is available.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_RX (18)</span> </dt><dd 
class="description">Control channel RX mode support.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_VLAN (19)</span> </dt><dd 
class="description">Control channel VLAN filtering.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_ANNOUNCE(21)</span> </dt><dd 
class="description">Driver can send gratuitous
     packets.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MQ(22)</span> </dt><dd 
class="description">Device   supports   multiqueue   with   automatic
     receive steering.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_MAC_ADDR(23)</span> </dt><dd 
class="description">Set   MAC   address   through
     control channel.</dd></dl>
<a 
 id="x1-160001r157"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.3.1   </span> <a 
 id="x1-1610001"></a>Feature bit requirements</h5>
<!--l. 3124--><p class="nopar" >Some networking feature bits require other networking feature bits (see <a 
href="#x1-140001">2.2.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Feature Bits --></a>):
                                                                  

                                                                  
     <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_TSO4</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_TSO6</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_ECN</span> </dt><dd 
class="description">Requires  VIRTIO_NET_F_GUEST_TSO4
     or VIRTIO_NET_F_GUEST_TSO6.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_UFO</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_TSO4</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_TSO6</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_ECN</span> </dt><dd 
class="description">Requires  VIRTIO_NET_F_HOST_TSO4  or
     VIRTIO_NET_F_HOST_TSO6.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_HOST_UFO</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_RX</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_VLAN</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GUEST_ANNOUNCE</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_MQ</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_CTRL_MAC_ADDR</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_CTRL_VQ.</dd></dl>
<a 
 id="x1-161001r163"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.3.2   </span> <a 
 id="x1-1620002"></a>Legacy Interface: Feature bits</h5>
     <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_NET_F_GSO (6)</span> </dt><dd 
class="description">Device handles packets with any GSO type.</dd></dl>
                                                                  

                                                                  
<!--l. 3150--><p class="nopar" >This was supposed to indicate segmentation offload support, but upon further
investigation it became clear that multiple bits were needed.
<a 
 id="x1-162001r162"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.4   </span> <a 
 id="x1-1630004"></a>Device configuration layout</h4>
<!--l. 3157--><p class="nopar" >Three driver-read-only configuration fields are currently defined. The <span 
class="aeti-10">mac </span>address
field always exists (though is only valid if VIRTIO_NET_F_MAC is set), and <span 
class="aeti-10">status</span>
only exists if VIRTIO_NET_F_STATUS is set. Two read-only bits (for the driver)
are currently defined for the status field: VIRTIO_NET_S_LINK_UP and
VIRTIO_NET_S_ANNOUNCE.
<!--l. 3163-->
<div class="lstlisting" id="listing-29"><span class="label"><a 
 id="x1-163001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_S_LINK_UP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-163002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_S_ANNOUNCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 3168--><p class="noindent" >The following driver-read-only field, <span 
class="aeti-10">max_virtqueue_pairs </span>only exists if
VIRTIO_NET_F_MQ is set. This field specifies the maximum number of each of
transmit and receive virtqueues (receiveq1…receiveqN and transmitq1…transmitqN
respectively) that can be configured once VIRTIO_NET_F_MQ is negotiated.
<!--l. 3174--><p class="noindent" >The following driver-read-only field, <span 
class="aeti-10">mtu </span>only exists if VIRTIO_NET_F_MTU is set.
This field specifies the maximum MTU for the driver to use.
<!--l. 3178-->
<div class="lstlisting" id="listing-30"><span class="label"><a 
 id="x1-163003r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-163004r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac</span><span 
class="pcrr8t-x-x-80">[6];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-163005r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-163006r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_virtqueue_pairs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-163007r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mtu</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-163008r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-163009r164"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.1   </span> <a 
 id="x1-1640001"></a>Device Requirements: Device configuration layout</h5>
<!--l. 3189--><p class="nopar" >The device MUST set <span 
class="aeti-10">max_virtqueue_pairs </span>to between 1 and 0x8000 inclusive, if it
offers VIRTIO_NET_F_MQ.
<!--l. 3192--><p class="noindent" >The device MUST set <span 
class="aeti-10">mtu </span>to between 68 and 65535 inclusive, if it offers
VIRTIO_NET_F_MTU.
<!--l. 3195--><p class="noindent" >The device SHOULD set <span 
class="aeti-10">mtu </span>to at least 1280, if it offers VIRTIO_NET_F_MTU.
<!--l. 3198--><p class="noindent" >The device MUST NOT modify <span 
class="aeti-10">mtu </span>once it has been set.
<!--l. 3200--><p class="noindent" >The device MUST NOT pass received packets that exceed <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) size with <span 
class="aeti-10">gso_type </span>NONE or ECN after VIRTIO_NET_F_MTU has
been successfully negotiated.
<!--l. 3204--><p class="noindent" >The device MUST forward transmitted packets of up to <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) size with <span 
class="aeti-10">gso_type </span>NONE or ECN, and do so without fragmentation,
                                                                  

                                                                  
after VIRTIO_NET_F_MTU has been successfully negotiated.
<a 
 id="x1-164001r166"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.2   </span> <a 
 id="x1-1650002"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 3211--><p class="nopar" >A driver SHOULD negotiate VIRTIO_NET_F_MAC if the device offers it. If
the driver negotiates the VIRTIO_NET_F_MAC feature, the driver MUST
set the physical address of the NIC to <span 
class="aeti-10">mac</span>. Otherwise, it SHOULD use a
locally-administered MAC address (see <a 
href="#x1-3001r1">IEEE 802</a>, “9.2 48-bit universal LAN MAC
addresses”).
<!--l. 3217--><p class="noindent" >If the driver does not negotiate the VIRTIO_NET_F_STATUS feature, it SHOULD
assume the link is active, otherwise it SHOULD read the link status from the bottom
bit of <span 
class="aeti-10">status</span>.
<!--l. 3221--><p class="noindent" >A driver SHOULD negotiate VIRTIO_NET_F_MTU if the device offers it.
<!--l. 3223--><p class="noindent" >If the driver negotiates VIRTIO_NET_F_MTU, it MUST supply enough receive
buffers to receive at least one receive packet of size <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) with <span 
class="aeti-10">gso_type </span>NONE or ECN.
<!--l. 3227--><p class="noindent" >If the driver negotiates VIRTIO_NET_F_MTU, it MUST NOT transmit packets of
size exceeding the value of <span 
class="aeti-10">mtu </span>(plus low level ethernet header length) with <span 
class="aeti-10">gso_type</span>
NONE or ECN.
<a 
 id="x1-165001r167"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.3   </span> <a 
 id="x1-1660003"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 3233--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format <span 
class="aeti-10">status</span>
and <span 
class="aeti-10">max_virtqueue_pairs </span>in struct virtio_net_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 3239--><p class="noindent" >When using the legacy interface, <span 
class="aeti-10">mac </span>is driver-writable which provided a way for drivers
to update the MAC without negotiating VIRTIO_NET_F_CTRL_MAC_ADDR.
<a 
 id="x1-166001r165"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.5   </span> <a 
 id="x1-1670005"></a>Device Initialization</h4>
<!--l. 3245--><p class="nopar" >A driver would perform a typical initialization routine like so:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-167002x1">Identify  and  initialize  the  receive  and  transmission  virtqueues,  up  to
     N  of  each  kind.  If  VIRTIO_NET_F_MQ  feature  bit  is  negotiated,
     N=<span 
class="aeti-10">max_virtqueue_pairs</span>, otherwise identify N=1.
     </li>
     <li 
  class="enumerate" id="x1-167004x2">If the VIRTIO_NET_F_CTRL_VQ feature bit is negotiated, identify the
     control virtqueue.
     </li>
                                                                  

                                                                  
     <li 
  class="enumerate" id="x1-167006x3">Fill the receive queues with buffers: see <a 
href="#x1-1740003">5.1.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>.
     </li>
     <li 
  class="enumerate" id="x1-167008x4">Even with VIRTIO_NET_F_MQ, only receiveq1, transmitq1 and controlq
     are       used       by       default.       The       driver       would       send
     the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command specifying the
     number of the transmit and receive queues to use.
     </li>
     <li 
  class="enumerate" id="x1-167010x5">If the VIRTIO_NET_F_MAC feature bit is set, the configuration space
     <span 
class="aeti-10">mac </span>entry indicates the “physical” address of the network card, otherwise
     the driver would typically generate a random local MAC address.
     </li>
     <li 
  class="enumerate" id="x1-167012x6">If the VIRTIO_NET_F_STATUS feature bit is negotiated, the link status
     comes from the bottom bit of <span 
class="aeti-10">status</span>. Otherwise, the driver assumes it’s
     active.
     </li>
     <li 
  class="enumerate" id="x1-167014x7">A performant driver would indicate that it will generate checksumless
     packets by negotating the VIRTIO_NET_F_CSUM feature.
     </li>
     <li 
  class="enumerate" id="x1-167016x8">If that feature is negotiated, a driver can use TCP or UDP segmentation
     offload  by  negotiating  the  VIRTIO_NET_F_HOST_TSO4  (IPv4  TCP),
     VIRTIO_NET_F_HOST_TSO6            (IPv6            TCP)            and
     VIRTIO_NET_F_HOST_UFO (UDP fragmentation) features.
     </li>
     <li 
  class="enumerate" id="x1-167018x9">The converse features are also available: a driver can save the virtual device
     some work by negotiating these features.
     <span 
class="aebx-10">Note:</span> For example, a network packet transported between two guests on
           the                                 same                                 system
           might not need checksumming at all, nor segmentation, if both
           guests are amenable. The VIRTIO_NET_F_GUEST_CSUM feature
           indicates  that  partially  checksummed  packets  can  be  received,
           and if it can do that then the VIRTIO_NET_F_GUEST_TSO4,
           VIRTIO_NET_F_GUEST_TSO6,  VIRTIO_NET_F_GUEST_UFO
           and VIRTIO_NET_F_GUEST_ECN are the input equivalents of
           the  features  described  above.  See  <a 
href="#x1-1740003">5.1.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a> <a 
href="#x1-1740003">Setting  Up  Receive
           Buffers<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a> and <a 
href="#x1-1770004">5.1.6.4<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a> <a 
href="#x1-1770004">Processing of Incoming Packets<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a> below.
<!--l. 3297--><p class="noindent" >A truly minimal driver would only accept VIRTIO_NET_F_MAC and ignore
everything else.
<a 
 id="x1-167019r169"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.1.6   </span> <a 
 id="x1-1680006"></a>Device Operation</h4>
<!--l. 3302--><p class="nopar" >Packets are transmitted by placing them in the transmitq1…transmitqN, and buffers
for incoming packets are placed in the receiveq1…receiveqN. In each case, the packet
itself is preceded by a header:
<!--l. 3307-->
<div class="lstlisting" id="listing-31"><span class="label"><a 
 id="x1-168001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_F_NEEDS_CSUM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_TCPV4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_UDP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_TCPV6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_ECN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gso_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gso_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">csum_start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">csum_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_buffers</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-168015r15"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 3325--><p class="noindent" >The controlq is used to control device features such as filtering.
<a 
 id="x1-168016r168"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.1   </span> <a 
 id="x1-1690001"></a>Legacy Interface: Device Operation</h5>
<!--l. 3329--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_net_hdr according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 3334--><p class="noindent" >The legacy driver only presented <span 
class="aeti-10">num_buffers </span>in the struct virtio_net_hdr when
VIRTIO_NET_F_MRG_RXBUF was negotiated; without that feature the structure
was 2 bytes shorter.
<!--l. 3338--><p class="noindent" >When using the legacy interface, the driver SHOULD ignore the <span 
class="aeti-10">len </span>value in used
ring entries for the transmit queues and the controlq queue.
<span 
class="aebx-10">Note:</span> Historically, some devices put the total descriptor length there, even
      though no data was actually written.
<a 
 id="x1-169001r171"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.2   </span> <a 
 id="x1-1700002"></a>Packet Transmission</h5>
<!--l. 3349--><p class="nopar" >Transmitting a single packet is simple, but varies depending on the different features
the driver negotiated.
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-170002x1">The driver can send a completely checksummed packet. In this case, <span 
class="aeti-10">flags</span>
    will be zero, and <span 
class="aeti-10">gso_type </span>will be VIRTIO_NET_HDR_GSO_NONE.
    </li>
    <li 
  class="enumerate" id="x1-170004x2">If the driver negotiated VIRTIO_NET_F_CSUM, it can skip checksumming the
    packet:
        <ul class="itemize1">
        <li class="itemize"><span 
class="aeti-10">flags </span>has the VIRTIO_NET_HDR_F_NEEDS_CSUM set,
                                                                  

                                                                  
        </li>
        <li class="itemize"><span 
class="aeti-10">csum_start   </span>is   set   to   the   offset   within   the   packet   to   begin
        checksumming, and
        </li>
        <li class="itemize"><span 
class="aeti-10">csum_offset </span>indicates how many bytes after the csum_start the new
        (16 bit ones’ complement) checksum is placed by the device.
        </li>
        <li class="itemize">The TCP checksum field in the packet is set to the sum of the TCP
        pseudo header, so that replacing it by the ones’ complement checksum
        of the TCP header and body will give the correct result.</li></ul>
    <span 
class="aebx-10">Note:</span> For example, consider a partially checksummed TCP (IPv4) packet.
          It will have a 14 byte ethernet header and 20 byte IP header followed
          by the TCP header (with the TCP checksum field 16 bytes into
          that header). <span 
class="aeti-10">csum_start </span>will be 14+20 = 34 (the TCP checksum
          includes the header), and <span 
class="aeti-10">csum_offset </span>will be 16.
    </li>
    <li 
  class="enumerate" id="x1-170006x3">If the driver negotiated VIRTIO_NET_F_HOST_TSO4, TSO6 or UFO, and the
    packet requires TCP segmentation or UDP fragmentation, then <span 
class="aeti-10">gso_type </span>is set
    to VIRTIO_NET_HDR_GSO_TCPV4, TCPV6 or UDP. (Otherwise, it is set to
    VIRTIO_NET_HDR_GSO_NONE). In this case, packets larger than 1514
    bytes can be transmitted: the metadata indicates how to replicate the
    packet header to cut it into smaller packets. The other gso fields are
    set:
        <ul class="itemize1">
        <li class="itemize"><span 
class="aeti-10">hdr_len </span>is a hint to the device as to how much of the header needs to be
        kept to copy into each packet, usually set to the length of the headers,
        including the transport header<span class="footnote-mark"><a 
href="#fn7x5" id="fn7x5-bk"><sup class="textsuperscript">7</sup></a></span><a 
 id="x1-170007f7"></a>.
        </li>
        <li class="itemize"><span 
class="aeti-10">gso_size </span>is the maximum size of each packet beyond that header (ie.
        MSS).
        </li>
        <li class="itemize">If the driver negotiated the VIRTIO_NET_F_HOST_ECN feature, the
        VIRTIO_NET_HDR_GSO_ECN bit in <span 
class="aeti-10">gso_type </span>indicates that the TCP
        packet has the ECN bit set<span class="footnote-mark"><a 
href="#fn8x5" id="fn8x5-bk"><sup class="textsuperscript">8</sup></a></span><a 
 id="x1-170008f8"></a>.</li></ul>
    </li>
    <li 
  class="enumerate" id="x1-170010x4"><span 
class="aeti-10">num_buffers </span>is set to zero. This field is unused on transmitted packets.
    </li>
    <li 
  class="enumerate" id="x1-170012x5">The header and packet are added as one output descriptor to the transmitq, and
    the device is notified of the new entry (see <a 
href="#x1-1670005">5.1.5<!--tex4ht:ref: sec:Device Types / Network Device / Device Initialization --></a> <a 
href="#x1-1670005">Device Initialization<!--tex4ht:ref: sec:Device Types / Network Device / Device Initialization --></a>).</li></ol>
<a 
 id="x1-170013r156"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.1</span> <a 
 id="x1-1710001"></a>Driver Requirements: Packet Transmission</h5>
The driver MUST set <span 
class="aeti-10">num_buffers </span>to zero.
<!--l. 3417--><p class="noindent" >If VIRTIO_NET_F_CSUM is not negotiated, the driver MUST set <span 
class="aeti-10">flags </span>to zero and
SHOULD supply a fully checksummed packet to the device.
<!--l. 3421--><p class="noindent" >If VIRTIO_NET_F_HOST_TSO4 is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_TCPV4 to request TCPv4 segmentation, otherwise the
driver MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV4.
<!--l. 3426--><p class="noindent" >If VIRTIO_NET_F_HOST_TSO6 is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_TCPV6 to request TCPv6 segmentation, otherwise the
driver MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV6.
<!--l. 3431--><p class="noindent" >If VIRTIO_NET_F_HOST_UFO is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_UDP to request UDP segmentation, otherwise the driver
MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_UDP.
<!--l. 3436--><p class="noindent" >The driver SHOULD NOT send to the device TCP packets requiring segmentation
offload which have the Explicit Congestion Notification bit set, unless the
VIRTIO_NET_F_HOST_ECN feature is negotiated, in which case the driver MUST
set the VIRTIO_NET_HDR_GSO_ECN bit in <span 
class="aeti-10">gso_type</span>.
<!--l. 3442--><p class="noindent" >If the VIRTIO_NET_F_CSUM feature has been negotiated, the driver MAY set the
VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags</span>, if so:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-171002x1">the driver MUST validate the packet checksum at offset <span 
class="aeti-10">csum_offset </span>from
    <span 
class="aeti-10">csum_start </span>as well as all preceding offsets;
    </li>
    <li 
  class="enumerate" id="x1-171004x2">the  driver  MUST  set  the  packet  checksum  stored  in  the  buffer  to  the
    TCP/UDP pseudo header;
    </li>
    <li 
  class="enumerate" id="x1-171006x3">the driver MUST set <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset </span>such that calculating a
    ones’ complement checksum from <span 
class="aeti-10">csum_start </span>up until the end of the packet
    and storing the result at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>will result in
    a fully checksummed packet;</li></ol>
<!--l. 3459--><p class="noindent" >If none of the VIRTIO_NET_F_HOST_TSO4, TSO6 or UFO options have been
negotiated, the driver MUST set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_NONE.
<!--l. 3463--><p class="noindent" >If <span 
class="aeti-10">gso_type </span>differs from VIRTIO_NET_HDR_GSO_NONE, then the driver MUST also
set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>and MUST set <span 
class="aeti-10">gso_size </span>to
indicate the desired MSS.
<!--l. 3468--><p class="noindent" >If one of the VIRTIO_NET_F_HOST_TSO4, TSO6 or UFO options have been
negotiated, the driver SHOULD set <span 
class="aeti-10">hdr_len </span>to a value not less than the length of the
headers, including the transport header.
                                                                  

                                                                  
<!--l. 3473--><p class="noindent" >The driver MUST NOT set the VIRTIO_NET_HDR_F_DATA_VALID bit in
<span 
class="aeti-10">flags</span>.
<a 
 id="x1-171007r173"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.2</span> <a 
 id="x1-1720002"></a>Device Requirements: Packet Transmission</h5>
The device MUST ignore <span 
class="aeti-10">flag </span>bits that it does not recognize.
<!--l. 3479--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>is not set, the device MUST
NOT use the <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset</span>.
<!--l. 3482--><p class="noindent" >If one of the VIRTIO_NET_F_HOST_TSO4, TSO6 or UFO options have been
negotiated, the device MAY use <span 
class="aeti-10">hdr_len </span>only as a hint about the transport header
size. The device MUST NOT rely on <span 
class="aeti-10">hdr_len </span>to be correct.
<span 
class="aebx-10">Note:</span> This is due to various bugs in implementations.
<!--l. 3490--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM is not set, the device MUST NOT rely on
the packet checksum being correct.
<a 
 id="x1-172001r174"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.3</span> <a 
 id="x1-1730003"></a>Packet Transmission Interrupt</h5>
Often a driver will suppress transmission interrupts using the
VIRTQ_AVAIL_F_NO_INTERRUPT flag (see <a 
href="#x1-600002">3.2.2<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Operation / Receiving Used Buffers From The Device --></a> <a 
href="#x1-600002">Receiving Used Buffers From
The Device<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Operation / Receiving Used Buffers From The Device --></a>) and check for used packets in the transmit path of following
packets.
<!--l. 3500--><p class="noindent" >The normal behavior in this interrupt handler is to retrieve and new descriptors from
the used ring and free the corresponding headers and packets.
<a 
 id="x1-173001r172"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.3   </span> <a 
 id="x1-1740003"></a>Setting Up Receive Buffers</h5>
<!--l. 3506--><p class="nopar" >It is generally a good idea to keep the receive virtqueue as fully populated as
possible: if it runs out, network performance will suffer.
<!--l. 3510--><p class="noindent" >If the VIRTIO_NET_F_GUEST_TSO4, VIRTIO_NET_F_GUEST_TSO6 or
VIRTIO_NET_F_GUEST_UFO features are used, the maximum incoming packet will
be to 65550 bytes long (the maximum size of a TCP or UDP packet, plus the 14 byte
ethernet header), otherwise 1514 bytes. The 12-byte struct virtio_net_hdr is
prepended to this, making for 65562 or 1526 bytes.
<a 
 id="x1-174001r175"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.3.1</span> <a 
 id="x1-1750001"></a>Driver Requirements: Setting Up Receive Buffers</h5>
    <ul class="itemize1">
    <li class="itemize">If VIRTIO_NET_F_MRG_RXBUF is not negotiated:
                                                                  

                                                                  
        <ul class="itemize2">
        <li class="itemize">If  VIRTIO_NET_F_GUEST_TSO4,  VIRTIO_NET_F_GUEST_TSO6
        or VIRTIO_NET_F_GUEST_UFO are negotiated, the driver SHOULD
        populate the receive queue(s) with buffers of at least 65562 bytes.
        </li>
        <li class="itemize">Otherwise, the driver SHOULD populate the receive queue(s) with
        buffers of at least 1526 bytes.</li></ul>
    </li>
    <li class="itemize">If VIRTIO_NET_F_MRG_RXBUF is negotiated, each buffer MUST be at least
    the size of the struct virtio_net_hdr.</li></ul>
<span 
class="aebx-10">Note:</span> Obviously each buffer can be split across multiple descriptor elements.
<!--l. 3536--><p class="nopar" >If VIRTIO_NET_F_MQ is negotiated, each of receiveq1…receiveqN that will be used
SHOULD be populated with receive buffers.
<a 
 id="x1-175001r177"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.3.2</span> <a 
 id="x1-1760002"></a>Device Requirements: Setting Up Receive Buffers</h5>
The device MUST set <span 
class="aeti-10">num_buffers </span>to the number of descriptors used to hold the
incoming packet.
<!--l. 3544--><p class="noindent" >The device MUST use only a single descriptor if VIRTIO_NET_F_MRG_RXBUF was
not negotiated.
<span 
class="aebx-10">Note:</span> This                                                                                means
      that <span 
class="aeti-10">num_buffers </span>will always be 1 if VIRTIO_NET_F_MRG_RXBUF is
      not negotiated.
<a 
 id="x1-176001r176"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.4   </span> <a 
 id="x1-1770004"></a>Processing of Incoming Packets</h5>
<!--l. 3554--><p class="nopar" >When a packet is copied into a buffer in the receiveq, the optimal path is to disable
further interrupts for the receiveq (see <a 
href="#x1-600002">3.2.2<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Operation / Receiving Used Buffers From The Device --></a> <a 
href="#x1-600002">Receiving Used Buffers From
The Device<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Operation / Receiving Used Buffers From The Device --></a>) and process packets until no more are found, then re-enable
them.
<!--l. 3559--><p class="noindent" >Processing incoming packets involves:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-177002x1"><span 
class="aeti-10">num_buffers                  </span>indicates                   how                   many
    descriptors this packet is spread over (including this one): this will always
    be 1 if VIRTIO_NET_F_MRG_RXBUF was not negotiated. This allows
    receipt of large packets without having to allocate large buffers: a packet
    that does not fit in a single buffer can flow over to the next buffer, and so
    on. In this case, there will be at least <span 
class="aeti-10">num_buffers </span>in the used ring, and
                                                                  

                                                                  
    the device chains them together to form a single packet in a way similar
    to how it would store it in a single buffer spread over multiple descriptors.
    The other buffers will not begin with a struct virtio_net_hdr.
    </li>
    <li 
  class="enumerate" id="x1-177004x2">If <span 
class="aeti-10">num_buffers </span>is one, then the entire packet will be contained within this
    buffer, immediately following the struct virtio_net_hdr.
    </li>
    <li 
  class="enumerate" id="x1-177006x3">If  the  VIRTIO_NET_F_GUEST_CSUM  feature  was  negotiated,  the
    VIRTIO_NET_HDR_F_DATA_VALID bit in <span 
class="aeti-10">flags </span>can be set: if so, device
    has  validated  the  packet  checksum.  In  case  of  multiple  encapsulated
    protocols, one level of checksums has been validated.</li></ol>
<!--l. 3585--><p class="noindent" >Additionally, VIRTIO_NET_F_GUEST_CSUM, TSO4, TSO6, UDP and ECN
features enable receive checksum, large receive offload and ECN support which are
the input equivalents of the transmit checksum, transmit segmentation offloading and
ECN features, as described in <a 
href="#x1-1700002">5.1.6.2<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Packet Transmission --></a>:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-177008x1">If  the  VIRTIO_NET_F_GUEST_CSUM  feature  was  negotiated,  the
    VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>can be set: if so, the
    packet checksum at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>and any preceding
    checksums have been validated. The checksum on the packet is incomplete
    and <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset </span>indicate how to calculate it (see Packet
    Transmission point 1).
    </li>
    <li 
  class="enumerate" id="x1-177010x2">If                        the                        VIRTIO_NET_F_GUEST_TSO4,
    TSO6 or UFO options were negotiated, then <span 
class="aeti-10">gso_type </span>MAY be something
    other than VIRTIO_NET_HDR_GSO_NONE, and <span 
class="aeti-10">gso_size </span>field indicates
    the desired MSS (see Packet Transmission point 2).</li></ol>
<a 
 id="x1-177011r178"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.4.1</span> <a 
 id="x1-1780001"></a>Device Requirements: Processing of Incoming Packets</h5>
If VIRTIO_NET_F_MRG_RXBUF has not been negotiated, the device MUST set
<span 
class="aeti-10">num_buffers </span>to 1.
<!--l. 3612--><p class="noindent" >If VIRTIO_NET_F_MRG_RXBUF has been negotiated, the device MUST set
<span 
class="aeti-10">num_buffers </span>to indicate the number of buffers the packet (including the header) is
spread over.
<!--l. 3616--><p class="noindent" >If a receive packet is spread over multiple buffers, the device MUST use all buffers
but the last (i.e. the first <span 
class="cmmi-10">num</span><sub><span 
class="cmmi-7">b</span></sub><span 
class="cmmi-10">uffers</span><span 
class="cmsy-10">− </span><span 
class="cmr-10">1 </span>buffers) completely up to the full length of
each buffer supplied by the driver.
<!--l. 3621--><p class="noindent" >The device MUST use all buffers used by a single receive packet together, by
atomically incrementing <span 
class="aeti-10">idx </span>in the used ring by the <span 
class="aeti-10">num_buffers </span>value.
                                                                  

                                                                  
<!--l. 3625--><p class="noindent" >If VIRTIO_NET_F_GUEST_CSUM is not negotiated, the device MUST
set <span 
class="aeti-10">flags </span>to zero and SHOULD supply a fully checksummed packet to the
driver.
<!--l. 3629--><p class="noindent" >If VIRTIO_NET_F_GUEST_TSO4 is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV4.
<!--l. 3632--><p class="noindent" >If VIRTIO_NET_F_GUEST_UDP is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_UDP.
<!--l. 3635--><p class="noindent" >If VIRTIO_NET_F_GUEST_TSO6 is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV6.
<!--l. 3638--><p class="noindent" >The device SHOULD NOT send to the driver TCP packets requiring segmentation
offload which have the Explicit Congestion Notification bit set, unless the
VIRTIO_NET_F_GUEST_ECN feature is negotiated, in which case the device MUST
set the VIRTIO_NET_HDR_GSO_ECN bit in <span 
class="aeti-10">gso_type</span>.
<!--l. 3644--><p class="noindent" >If the VIRTIO_NET_F_GUEST_CSUM feature has been negotiated, the
device MAY set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags</span>, if
so:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-178002x1">the device MUST validate the packet checksum at offset <span 
class="aeti-10">csum_offset </span>from
    <span 
class="aeti-10">csum_start </span>as well as all preceding offsets;
    </li>
    <li 
  class="enumerate" id="x1-178004x2">the device MUST set the packet checksum stored in the receive buffer to
    the TCP/UDP pseudo header;
    </li>
    <li 
  class="enumerate" id="x1-178006x3">the device MUST set <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset </span>such that calculating a
    ones’ complement checksum from <span 
class="aeti-10">csum_start </span>up until the end of the packet
    and storing the result at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>will result in
    a fully checksummed packet;</li></ol>
<!--l. 3661--><p class="noindent" >If none of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the device MUST set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_NONE.
<!--l. 3665--><p class="noindent" >If <span 
class="aeti-10">gso_type </span>differs from VIRTIO_NET_HDR_GSO_NONE, then the device MUST also
set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>MUST set <span 
class="aeti-10">gso_size </span>to
indicate the desired MSS.
<!--l. 3669--><p class="noindent" >If one of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the device SHOULD set <span 
class="aeti-10">hdr_len </span>to a value not less than the length of the
headers, including the transport header.
<!--l. 3674--><p class="noindent" >If the VIRTIO_NET_F_GUEST_CSUM feature has been negotiated, the device MAY
set the VIRTIO_NET_HDR_F_DATA_VALID bit in <span 
class="aeti-10">flags</span>, if so, the device MUST
validate the packet checksum (in case of multiple encapsulated protocols, one level of
checksums is validated).
<a 
 id="x1-178007r180"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.1.6.4.2</span> <a 
 id="x1-1790002"></a>Driver Requirements: Processing of Incoming Packets</h5>
The driver MUST ignore <span 
class="aeti-10">flag </span>bits that it does not recognize.
<!--l. 3686--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>is not set, the driver MUST
NOT use the <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset</span>.
<!--l. 3689--><p class="noindent" >If one of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the driver MAY use <span 
class="aeti-10">hdr_len </span>only as a hint about the transport header
size. The driver MUST NOT rely on <span 
class="aeti-10">hdr_len </span>to be correct.
<span 
class="aebx-10">Note:</span> This is due to various bugs in implementations.
<!--l. 3697--><p class="noindent" >If neither VIRTIO_NET_HDR_F_NEEDS_CSUM nor VIRTIO_NET_HDR_F_DATA_VALID
is set, the driver MUST NOT rely on the packet checksum being correct.
<a 
 id="x1-179001r179"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.5   </span> <a 
 id="x1-1800005"></a>Control Virtqueue</h5>
<!--l. 3702--><p class="nopar" >The driver uses the control virtqueue (if VIRTIO_NET_F_CTRL_VQ is negotiated)
to send commands to manipulate various features of the device which would not
easily map into the configuration space.
<!--l. 3707--><p class="noindent" >All commands are of the following form:
<!--l. 3709-->
<div class="lstlisting" id="listing-32"><span class="label"><a 
 id="x1-180001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">class</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ack</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180008r8"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ack</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-180010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_ERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 3722--><p class="noindent" >The <span 
class="aeti-10">class</span>, <span 
class="aeti-10">command </span>and command-specific-data are set by the driver, and the device
sets the <span 
class="aeti-10">ack </span>byte. There is little it can do except issue a diagnostic if <span 
class="aeti-10">ack </span>is not
VIRTIO_NET_OK.
<a 
 id="x1-180011r181"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.1</span> <a 
 id="x1-1810001"></a>Packet Receive Filtering</h5>
If the VIRTIO_NET_F_CTRL_RX and VIRTIO_NET_F_CTRL_RX_EXTRA features
are negotiated, the driver can send control commands for promiscuous mode,
multicast, unicast and broadcast receiving.
<span 
class="aebx-10">Note:</span> In general, these commands are best-effort: unwanted packets could still
      arrive.
<!--l. 3739-->
<div class="lstlisting" id="listing-33"><span class="label"><a 
 id="x1-181001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-181002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_PROMISC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-181003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_ALLMULTI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-181004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_ALLUNI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-181005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOMULTI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-181006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOUNI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-181007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOBCAST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span>
                                                                  

                                                                  
</div>
<a 
 id="x1-181008r152"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.1.1</span> <a 
 id="x1-1820001"></a>Device Requirements: Packet Receive Filtering</h6>
If the VIRTIO_NET_F_CTRL_RX feature has been negotiated, the device MUST
support the following VIRTIO_NET_CTRL_RX class commands:
    <ul class="itemize1">
    <li class="itemize">VIRTIO_NET_CTRL_RX_PROMISC turns promiscuous mode on and off.
    The command-specific-data is one byte containing 0 (off) or 1 (on). If
    promiscous mode is on, the device SHOULD receive all incoming packets.
    This  SHOULD  take  effect  even  if  one  of  the  other  modes  set  by  a
    VIRTIO_NET_CTRL_RX class command is on.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_ALLMULTI turns all-multicast receive on and
    off. The command-specific-data is one byte containing 0 (off) or 1 (on).
    When all-multicast receive is on the device SHOULD allow all incoming
    multicast packets.</li></ul>
<!--l. 3768--><p class="noindent" >If the VIRTIO_NET_F_CTRL_RX_EXTRA feature has been negotiated, the device
MUST support the following VIRTIO_NET_CTRL_RX class commands:
    <ul class="itemize1">
    <li class="itemize">VIRTIO_NET_CTRL_RX_ALLUNI  turns  all-unicast  receive  on  and  off.
    The command-specific-data is one byte containing 0 (off) or 1 (on). When
    all-unicast receive is on the device SHOULD allow all incoming unicast
    packets.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOMULTI  suppresses  multicast  receive.  The
    command-specific-data is one byte containing 0 (multicast receive allowed)
    or 1 (multicast receive suppressed). When multicast receive is suppressed,
    the  device  SHOULD  NOT  send  multicast  packets  to  the  driver.  This
    SHOULD take effect even if VIRTIO_NET_CTRL_RX_ALLMULTI is on.
    This filter SHOULD NOT apply to broadcast packets.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOUNI    suppresses    unicast    receive.    The
    command-specific-data is one byte containing 0 (unicast receive allowed)
    or 1 (unicast receive suppressed). When unicast receive is suppressed, the
    device SHOULD NOT send unicast packets to the driver. This SHOULD
    take effect even if VIRTIO_NET_CTRL_RX_ALLUNI is on.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOBCAST suppresses broadcast receive. The
    command-specific-data is one byte containing 0 (broadcast receive allowed)
    or 1 (broadcast receive suppressed). When broadcast receive is suppressed,
                                                                  

                                                                  
    the  device  SHOULD  NOT  send  broadcast  packets  to  the  driver.  This
    SHOULD take effect even if VIRTIO_NET_CTRL_RX_ALLMULTI is on.</li></ul>
<a 
 id="x1-182001r184"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.1.2</span> <a 
 id="x1-1830002"></a>Driver Requirements: Packet Receive Filtering</h6>
If the VIRTIO_NET_F_CTRL_RX feature has not been negotiated, the driver
MUST NOT issue commands VIRTIO_NET_CTRL_RX_PROMISC or
VIRTIO_NET_CTRL_RX_ALLMULTI.
<!--l. 3803--><p class="noindent" >If the VIRTIO_NET_F_CTRL_RX_EXTRA feature has not been negotiated, the
driver MUST NOT issue commands VIRTIO_NET_CTRL_RX_ALLUNI,
VIRTIO_NET_CTRL_RX_NOMULTI, VIRTIO_NET_CTRL_RX_NOUNI or
VIRTIO_NET_CTRL_RX_NOBCAST.
<a 
 id="x1-183001r183"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.2</span> <a 
 id="x1-1840002"></a>Setting MAC Address Filtering</h5>
If the VIRTIO_NET_F_CTRL_RX feature is negotiated, the driver can send control
commands for MAC address filtering.
<!--l. 3815-->
<div class="lstlisting" id="listing-34"><span class="label"><a 
 id="x1-184001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl_mac</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">macs</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">][6];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC_TABLE_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC_ADDR_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 3826--><p class="noindent" >The device can filter incoming packets by any number of destination MAC
addresses<span class="footnote-mark"><a 
href="#fn9x5" id="fn9x5-bk"><sup class="textsuperscript">9</sup></a></span><a 
 id="x1-184009f9"></a>.
This table is set using the class VIRTIO_NET_CTRL_MAC and the command
VIRTIO_NET_CTRL_MAC_TABLE_SET. The command-specific-data is
two variable length tables of 6-byte MAC addresses (as described in struct
virtio_net_ctrl_mac). The first table contains unicast addresses, and the second
contains multicast addresses.
<!--l. 3836--><p class="noindent" >The VIRTIO_NET_CTRL_MAC_ADDR_SET command is used to set the default
MAC address which rx filtering accepts (and if VIRTIO_NET_F_MAC_ADDR has
been negotiated, this will be reflected in <span 
class="aeti-10">mac </span>in config space).
<!--l. 3841--><p class="noindent" >The command-specific-data for VIRTIO_NET_CTRL_MAC_ADDR_SET is the 6-byte
MAC address.
<a 
 id="x1-184010r185"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.1</span> <a 
 id="x1-1850001"></a>Device Requirements: Setting MAC Address Filtering</h6>
The device MUST have an empty MAC filtering table on reset.
<!--l. 3848--><p class="noindent" >The device MUST update the MAC filtering table before it consumes the
VIRTIO_NET_CTRL_MAC_TABLE_SET command.
                                                                  

                                                                  
<!--l. 3851--><p class="noindent" >The device MUST update <span 
class="aeti-10">mac </span>in config space before it consumes the
VIRTIO_NET_CTRL_MAC_ADDR_SET command, if VIRTIO_NET_F_MAC_ADDR
has been negotiated.
<!--l. 3855--><p class="noindent" >The device SHOULD drop incoming packets which have a destination MAC which
matches neither the <span 
class="aeti-10">mac </span>(or that set with VIRTIO_NET_CTRL_MAC_ADDR_SET)
nor the MAC filtering table.
<a 
 id="x1-185001r187"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.2</span> <a 
 id="x1-1860002"></a>Driver Requirements: Setting MAC Address Filtering</h6>
If VIRTIO_NET_F_CTRL_RX has not been negotiated, the driver MUST NOT issue
VIRTIO_NET_CTRL_MAC class commands.
<!--l. 3864--><p class="noindent" >If VIRTIO_NET_F_CTRL_RX has been negotiated, the driver SHOULD issue
VIRTIO_NET_CTRL_MAC_ADDR_SET to set the default mac if it is different from
<span 
class="aeti-10">mac</span>.
<!--l. 3868--><p class="noindent" >The driver MUST follow the VIRTIO_NET_CTRL_MAC_TABLE_SET command by
a le32 number, followed by that number of non-multicast MAC addresses, followed by
another le32 number, followed by that number of multicast addresses. Either number
MAY be 0.
<a 
 id="x1-186001r188"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.3</span> <a 
 id="x1-1870003"></a>Legacy Interface: Setting MAC Address Filtering</h6>
When using the legacy interface, transitional devices and drivers MUST
format <span 
class="aeti-10">entries </span>in struct virtio_net_ctrl_mac according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 3879--><p class="noindent" >Legacy drivers that didn’t negotiate VIRTIO_NET_F_CTRL_MAC_ADDR changed
<span 
class="aeti-10">mac </span>in config space when NIC is accepting incoming packets. These drivers
always wrote the mac value from first to last byte, therefore after detecting
such drivers, a transitional device MAY defer MAC update, or MAY defer
processing incoming packets until driver writes the last byte of <span 
class="aeti-10">mac </span>in the config
space.
<a 
 id="x1-187001r186"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.3</span> <a 
 id="x1-1880003"></a>VLAN Filtering</h5>
If the driver negotiates the VIRTION_NET_F_CTRL_VLAN feature, it can control a
VLAN filter table in the device.
<!--l. 3892-->
<div class="lstlisting" id="listing-35"><span class="label"><a 
 id="x1-188001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-188002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN_ADD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-188003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN_DEL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
                                                                  

                                                                  
<!--l. 3898--><p class="noindent" >Both the VIRTIO_NET_CTRL_VLAN_ADD and VIRTIO_NET_CTRL_VLAN_DEL
command take a little-endian 16-bit VLAN id as the command-specific-data.
<a 
 id="x1-188004r189"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.3.1</span> <a 
 id="x1-1890001"></a>Legacy Interface: VLAN Filtering</h6>
When using the legacy interface, transitional devices and drivers MUST format the
VLAN id according to the native endian of the guest rather than (necessarily when
not using the legacy interface) little-endian.
<a 
 id="x1-189001r190"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.4</span> <a 
 id="x1-1900004"></a>Gratuitous Packet Sending</h5>
If the driver negotiates the VIRTIO_NET_F_GUEST_ANNOUNCE (depends on
VIRTIO_NET_F_CTRL_VQ), the device can ask the driver to send gratuitous
packets; this is usually done after the guest has been physically migrated, and needs
to announce its presence on the new network links. (As hypervisor does not have the
knowledge of guest network configuration (eg. tagged vlan) it is simplest to prod the
guest in this way).
<!--l. 3917-->
<div class="lstlisting" id="listing-36"><span class="label"><a 
 id="x1-190001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_ANNOUNCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-190002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_ANNOUNCE_ACK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
</div>
<!--l. 3922--><p class="noindent" >The driver checks VIRTIO_NET_S_ANNOUNCE bit in the device configuration
<span 
class="aeti-10">status </span>field when it notices the changes of device configuration. The command
VIRTIO_NET_CTRL_ANNOUNCE_ACK is used to indicate that driver has received
the notification and device clears the VIRTIO_NET_S_ANNOUNCE bit in
<span 
class="aeti-10">status</span>.
<!--l. 3928--><p class="noindent" >Processing this notification involves:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-190004x1">Sending the gratuitous packets (eg. ARP) or marking there are pending
    gratuitous packets to be sent and letting deferred routine to send them.
    </li>
    <li 
  class="enumerate" id="x1-190006x2">Sending   VIRTIO_NET_CTRL_ANNOUNCE_ACK   command   through
    control vq.</li></ol>
<a 
 id="x1-190007r191"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.4.1</span> <a 
 id="x1-1910001"></a>Driver Requirements: Gratuitous Packet Sending</h6>
If the driver negotiates VIRTIO_NET_F_GUEST_ANNOUNCE, it SHOULD notify
network peers of its new location after it sees the VIRTIO_NET_S_ANNOUNCE
bit in <span 
class="aeti-10">status</span>. The driver MUST send a command on the command
queue with class VIRTIO_NET_CTRL_ANNOUNCE and command
                                                                  

                                                                  
VIRTIO_NET_CTRL_ANNOUNCE_ACK.
<a 
 id="x1-191001r193"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.4.2</span> <a 
 id="x1-1920002"></a>Device Requirements: Gratuitous Packet Sending</h6>
If VIRTIO_NET_F_GUEST_ANNOUNCE is negotiated, the device MUST
clear the VIRTIO_NET_S_ANNOUNCE bit in <span 
class="aeti-10">status </span>upon receipt of a
command buffer with class VIRTIO_NET_CTRL_ANNOUNCE and command
VIRTIO_NET_CTRL_ANNOUNCE_ACK before marking the buffer as used.
<a 
 id="x1-192001r192"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.5</span> <a 
 id="x1-1930005"></a>Automatic receive steering in multiqueue mode</h5>
If the driver negotiates the VIRTIO_NET_F_MQ feature bit (depends on
VIRTIO_NET_F_CTRL_VQ), it MAY transmit outgoing packets on one of
the multiple transmitq1…transmitqN and ask the device to queue incoming
packets into one of the multiple receiveq1…receiveqN depending on the packet
flow.
<!--l. 3961-->
<div class="lstlisting" id="listing-37"><span class="label"><a 
 id="x1-193001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl_mq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue_pairs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_MIN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_MAX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x8000</span>
</div>
<!--l. 3972--><p class="noindent" >Multiqueue is disabled by default. The driver enables multiqueue by executing the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command, specifying the number of the
transmit and receive queues to be used up to <span 
class="aeti-10">max_virtqueue_pairs</span>; subsequently,
transmitq1…transmitqn and receiveq1…receiveqn where n=<span 
class="aeti-10">virtqueue_pairs </span>MAY be
used.
<!--l. 3979--><p class="noindent" >When multiqueue is enabled, the device MUST use automatic receive steering based
on packet flow. Programming of the receive steering classificator is implicit.
After the driver transmitted a packet of a flow on transmitqX, the device
SHOULD cause incoming packets for that flow to be steered to receiveqX.
For uni-directional protocols, or where no packets have been transmitted
yet, the device MAY steer a packet to a random queue out of the specified
receiveq1…receiveqn.
<!--l. 3987--><p class="noindent" >Multiqueue is disabled by setting <span 
class="aeti-10">virtqueue_pairs </span>to 1 (this is the default) and
waiting for the device to use the command buffer.
<a 
 id="x1-193009r194"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.5.1</span> <a 
 id="x1-1940001"></a>Driver Requirements: Automatic receive steering in multiqueue
mode</h6>
The driver MUST configure the virtqueues before enabling them with the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command.
                                                                  

                                                                  
<!--l. 3995--><p class="noindent" >The driver MUST NOT request a <span 
class="aeti-10">virtqueue_pairs </span>of 0 or greater than
<span 
class="aeti-10">max_virtqueue_pairs </span>in the device configuration space.
<!--l. 3998--><p class="noindent" >The driver MUST queue packets only on any transmitq1 before the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command.
<!--l. 4001--><p class="noindent" >The driver MUST NOT queue packets on transmit queues greater than
<span 
class="aeti-10">virtqueue_pairs </span>once it has placed the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET
command in the available ring.
<a 
 id="x1-194001r196"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.5.2</span> <a 
 id="x1-1950002"></a>Device Requirements: Automatic receive steering in multiqueue
mode</h6>
The device MUST queue packets only on any receiveq1 before the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command.
<!--l. 4009--><p class="noindent" >The device MUST NOT queue packets on receive queues greater than <span 
class="aeti-10">virtqueue_pairs</span>
once it has placed the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command in the
used ring.
<a 
 id="x1-195001r197"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.5.3</span> <a 
 id="x1-1960003"></a>Legacy Interface: Automatic receive steering in multiqueue mode</h6>
When using the legacy interface, transitional devices and drivers MUST format
<span 
class="aeti-10">virtqueue_pairs </span>according to the native endian of the guest rather than (necessarily
when not using the legacy interface) little-endian.
<a 
 id="x1-196001r195"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.6</span> <a 
 id="x1-1970006"></a>Offloads State Configuration</h5>
If the VIRTIO_NET_F_CTRL_GUEST_OFFLOADS feature is negotiated, the driver
can send control commands for dynamic offloads state configuration.
<a 
 id="x1-197001r198"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.1</span> <a 
 id="x1-1980001"></a>Setting Offloads State</h6>
<!--l. 4025-->
<div class="lstlisting" id="listing-38"><span class="label"><a 
 id="x1-198001r1"></a></span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offloads</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_CSUM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_TSO4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_TSO6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_ECN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_UFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_GUEST_OFFLOADS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-198010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_GUEST_OFFLOADS_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
</div>
<!--l. 4038--><p class="noindent" >The class VIRTIO_NET_CTRL_GUEST_OFFLOADS has one command:
VIRTIO_NET_CTRL_GUEST_OFFLOADS_SET applies the new offloads
configuration.
<!--l. 4041--><p class="noindent" >le64 value passed as command data is a bitmask, bits set define offloads to be
enabled, bits cleared - offloads to be disabled.
                                                                  

                                                                  
<!--l. 4044--><p class="noindent" >There is a corresponding device feature for each offload. Upon feature negotiation
corresponding offload gets enabled to preserve backward compartibility.
<a 
 id="x1-198011r200"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.2</span> <a 
 id="x1-1990002"></a>Driver Requirements: Setting Offloads State</h6>
A driver MUST NOT enable an offload for which the appropriate feature has not
been negotiated.
<a 
 id="x1-199001r201"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.3</span> <a 
 id="x1-2000003"></a>Legacy Interface: Setting Offloads State</h6>
When using the legacy interface, transitional devices and drivers MUST format
<span 
class="aeti-10">offloads </span>according to the native endian of the guest rather than (necessarily when not
using the legacy interface) little-endian.
<a 
 id="x1-200001r182"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.6   </span> <a 
 id="x1-2010006"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 4063--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use a single descriptor for the struct
virtio_net_hdr on both transmit and receive, with the network data in the following
descriptors.
<!--l. 4068--><p class="noindent" >Additionally, when using the control virtqueue (see <a 
href="#x1-1800005">5.1.6.5<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue --></a>) , transitional drivers
which have not negotiated VIRTIO_F_ANY_LAYOUT MUST:
    <ul class="itemize1">
    <li class="itemize">for all commands, use a single 2-byte descriptor including the first two
    fields: <span 
class="aeti-10">class </span>and <span 
class="aeti-10">command</span>
    </li>
    <li class="itemize">for all commands except VIRTIO_NET_CTRL_MAC_TABLE_SET use a
    single descriptor including command-specific-data with no padding.
    </li>
    <li class="itemize">for  the  VIRTIO_NET_CTRL_MAC_TABLE_SET  command  use  exactly
    two descriptors including command-specific-data with no padding: the first
    of these descriptors MUST include the virtio_net_ctrl_mac table structure
    for the unicast addresses with no padding, the second of these descriptors
    MUST include the virtio_net_ctrl_mac table structure for the multicast
    addresses with no padding.
    </li>
    <li class="itemize">for all commands, use a single 1-byte descriptor for the <span 
class="aeti-10">ack </span>field</li></ul>
<!--l. 4089--><p class="noindent" >See <a 
href="#x1-260004">2.4.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing --></a>.
<a 
 id="x1-201001r159"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">5.2   </span> <a 
 id="x1-2020002"></a>Block Device</h3>
<!--l. 4094--><p class="nopar" >The virtio block device is a simple virtual block device (ie. disk). Read and write
requests (and other exotic requests) are placed in the queue, and serviced (probably
out of order) by the device except where noted.
<a 
 id="x1-202001r170"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.1   </span> <a 
 id="x1-2030001"></a>Device ID</h4>
<!--l. 4100--><p class="nopar" >2
<a 
 id="x1-203001r205"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.2   </span> <a 
 id="x1-2040002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">requestq</dd></dl>
<a 
 id="x1-204001r206"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.3   </span> <a 
 id="x1-2050003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_SIZE_MAX (1)</span> </dt><dd 
class="description">Maximum size of any single segment is in
    <span 
class="aeti-10">size_max</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_SEG_MAX (2)</span> </dt><dd 
class="description">Maximum   number   of   segments   in   a
    request is in <span 
class="aeti-10">seg_max</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_GEOMETRY (4)</span> </dt><dd 
class="description">Disk-style    geometry    specified    in
    <span 
class="aeti-10">geometry</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_RO (5)</span> </dt><dd 
class="description">Device is read-only.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_BLK_SIZE (6)</span> </dt><dd 
class="description">Block size of disk is in <span 
class="aeti-10">blk_size</span>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_FLUSH (9)</span> </dt><dd 
class="description">Cache flush command support.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_TOPOLOGY (10)</span> </dt><dd 
class="description">Device    exports    information    on
    optimal I/O alignment.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_CONFIG_WCE (11)</span> </dt><dd 
class="description">Device can toggle its cache between
    writeback and writethrough modes.</dd></dl>
<a 
 id="x1-205001r203"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.2.3.1   </span> <a 
 id="x1-2060001"></a>Legacy Interface: Feature bits</h5>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_BARRIER (0)</span> </dt><dd 
class="description">Device supports request barriers.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BLK_F_SCSI (7)</span> </dt><dd 
class="description">Device supports scsi packet commands.</dd></dl>
<span 
class="aebx-10">Note:</span> In  the  legacy  interface,  VIRTIO_BLK_F_FLUSH  was  also  called
      VIRTIO_BLK_F_WCE.
<a 
 id="x1-206001r207"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.4   </span> <a 
 id="x1-2070004"></a>Device configuration layout</h4>
<!--l. 4147--><p class="nopar" >The <span 
class="aeti-10">capacity </span>of the device (expressed in 512-byte sectors) is always present.
The availability of the others all depend on various feature bits as indicated
above.
<!--l. 4151-->
<div class="lstlisting" id="listing-39"><span class="label"><a 
 id="x1-207001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capacity</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">seg_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_geometry</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cylinders</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">geometry</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blk_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_topology</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">logical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">per</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">log2</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">physical_block_exp</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aligned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">logical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alignment_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">suggested</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">minimum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">min_io_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimal</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">suggested</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">maximum</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opt_io_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">topology</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">writeback</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-207022r22"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-207023r208"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.4.1   </span> <a 
 id="x1-2080001"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 4178--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_blk_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-208001r209"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.5   </span> <a 
 id="x1-2090005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-209002x1">The device size can be read from <span 
class="aeti-10">capacity</span>.
    </li>
    <li 
  class="enumerate" id="x1-209004x2">If the VIRTIO_BLK_F_BLK_SIZE feature is negotiated, <span 
class="aeti-10">blk_size </span>can be
    read to determine the optimal sector size for the driver to use. This does
    not affect the units used in the protocol (always 512 bytes), but awareness
    of the correct value can affect performance.
    </li>
    <li 
  class="enumerate" id="x1-209006x3">If the VIRTIO_BLK_F_RO feature is set by the device, any write requests
    will fail.
                                                                  

                                                                  
    </li>
    <li 
  class="enumerate" id="x1-209008x4">If the VIRTIO_BLK_F_TOPOLOGY feature is negotiated, the fields in the
    <span 
class="aeti-10">topology </span>struct can be read to determine the physical block size and optimal
    I/O lengths for the driver to use. This also does not affect the units in the
    protocol, only performance.
    </li>
    <li 
  class="enumerate" id="x1-209010x5">If  the  VIRTIO_BLK_F_CONFIG_WCE  feature  is  negotiated,  the  cache
    mode can be read or set through the <span 
class="aeti-10">writeback </span>field. 0 corresponds to a
    writethrough cache, 1 to a writeback cache<span class="footnote-mark"><a 
href="#fn10x5" id="fn10x5-bk"><sup class="textsuperscript">10</sup></a></span><a 
 id="x1-209011f10"></a>.
    The cache mode after reset can be either writeback or writethrough. The
    actual mode can be determined by reading <span 
class="aeti-10">writeback </span>after feature negotiation.</li></ol>
<a 
 id="x1-209012r210"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.1   </span> <a 
 id="x1-2100001"></a>Driver Requirements: Device Initialization</h5>
<!--l. 4218--><p class="nopar" >Drivers SHOULD NOT negotiate VIRTIO_BLK_F_FLUSH if they are incapable of
sending VIRTIO_BLK_T_FLUSH commands.
<!--l. 4221--><p class="noindent" >If neither VIRTIO_BLK_F_CONFIG_WCE nor VIRTIO_BLK_F_FLUSH are
negotiated, the driver MAY deduce the presence of a writethrough cache. If
VIRTIO_BLK_F_CONFIG_WCE was not negotiated but VIRTIO_BLK_F_FLUSH
was, the driver SHOULD assume presence of a writeback cache.
<!--l. 4226--><p class="noindent" >The driver MUST NOT read <span 
class="aeti-10">writeback </span>before setting the FEATURES_OK <span 
class="aeti-10">status</span>
bit.
<a 
 id="x1-210001r212"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.2   </span> <a 
 id="x1-2110002"></a>Device Requirements: Device Initialization</h5>
<!--l. 4231--><p class="nopar" >Devices SHOULD always offer VIRTIO_BLK_F_FLUSH, and MUST offer it if they
offer VIRTIO_BLK_F_CONFIG_WCE.
<!--l. 4234--><p class="noindent" >If VIRTIO_BLK_F_CONFIG_WCE is negotiated but VIRTIO_BLK_F_FLUSH is not,
the device MUST initialize <span 
class="aeti-10">writeback </span>to 0.
<a 
 id="x1-211001r213"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.3   </span> <a 
 id="x1-2120003"></a>Legacy Interface: Device Initialization</h5>
<!--l. 4239--><p class="nopar" >Because legacy devices do not have FEATURES_OK, transitional devices
MUST implement slightly different behavior around feature negotiation
when used through the legacy interface. In particular, when using the legacy
interface:
    <ul class="itemize1">
    <li class="itemize">the driver MAY read or write <span 
class="aeti-10">writeback  </span>before setting the DRIVER or
    DRIVER_OK <span 
class="aeti-10">status </span>bit
    </li>
    <li class="itemize">the device MUST NOT modify the cache mode (and <span 
class="aeti-10">writeback</span>) as a result
                                                                  

                                                                  
    of a driver setting a status bit, unless the DRIVER_OK bit is being set and
    the driver has not set the VIRTIO_BLK_F_CONFIG_WCE driver feature
    bit.
    </li>
    <li class="itemize">the device MUST NOT modify the cache mode (and <span 
class="aeti-10">writeback</span>) as a result
    of a driver modifying the driver feature bits, for example if the driver sets
    the VIRTIO_BLK_F_CONFIG_WCE driver feature bit but does not set
    the VIRTIO_BLK_F_FLUSH bit.</li></ul>
<a 
 id="x1-212001r211"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.6   </span> <a 
 id="x1-2130006"></a>Device Operation</h4>
<!--l. 4262--><p class="nopar" >The driver queues requests to the virtqueue, and they are used by the device (not
necessarily in order). Each request is of form:
<!--l. 4265-->
<div class="lstlisting" id="listing-40"><span class="label"><a 
 id="x1-213001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[][512];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4275--><p class="noindent" >The type of the request is either a read (VIRTIO_BLK_T_IN), a write
(VIRTIO_BLK_T_OUT), or a flush (VIRTIO_BLK_T_FLUSH).
<!--l. 4278-->
<div class="lstlisting" id="listing-41"><span class="label"><a 
 id="x1-213008r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213009r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213010r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_FLUSH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span>
</div>
<!--l. 4284--><p class="noindent" >The <span 
class="aeti-10">sector </span>number indicates the offset (multiplied by 512) where the read or write is
to occur. This field is unused and set to 0 for scsi packet commands and for flush
commands.
<!--l. 4288--><p class="noindent" >The final <span 
class="aeti-10">status </span>byte is written by the device: either VIRTIO_BLK_S_OK for success,
VIRTIO_BLK_S_IOERR for device or driver error or VIRTIO_BLK_S_UNSUPP for a
request unsupported by device:
<!--l. 4292-->
<div class="lstlisting" id="listing-42"><span class="label"><a 
 id="x1-213011r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213012r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_IOERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-213013r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_UNSUPP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<a 
 id="x1-213014r214"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.1   </span> <a 
 id="x1-2140001"></a>Driver Requirements: Device Operation</h5>
<!--l. 4300--><p class="nopar" >A driver MUST NOT submit a request which would cause a read or write beyond
<span 
class="aeti-10">capacity</span>.
                                                                  

                                                                  
<!--l. 4303--><p class="noindent" >A driver SHOULD accept the VIRTIO_BLK_F_RO feature if offered.
<!--l. 4305--><p class="noindent" >A driver MUST set <span 
class="aeti-10">sector </span>to 0 for a VIRTIO_BLK_T_FLUSH request. A driver
SHOULD NOT include any data in a VIRTIO_BLK_T_FLUSH request.
<!--l. 4308--><p class="noindent" >If the VIRTIO_BLK_F_CONFIG_WCE feature is negotiated, the driver MAY switch
to writethrough or writeback mode by writing respectively 0 and 1 to the
<span 
class="aeti-10">writeback </span>field. After writing a 0 to <span 
class="aeti-10">writeback</span>, the driver MUST NOT assume
that any volatile writes have been committed to persistent device backend
storage.
<a 
 id="x1-214001r216"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.2   </span> <a 
 id="x1-2150002"></a>Device Requirements: Device Operation</h5>
<!--l. 4316--><p class="nopar" >A device MUST set the <span 
class="aeti-10">status </span>byte to VIRTIO_BLK_S_IOERR for a write request
if the VIRTIO_BLK_F_RO feature if offered, and MUST NOT write any
data.
<!--l. 4320--><p class="noindent" >A write is considered volatile when it is submitted; the contents of sectors covered by
a volatile write are undefined in persistent device backend storage until the write
becomes stable. A write becomes stable once it is completed and one or more of the
following conditions is true:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-215002x1"><a 
 id="x1-2150011"></a> neither  VIRTIO_BLK_F_CONFIG_WCE  nor  VIRTIO_BLK_F_FLUSH
    feature were negotiated, but VIRTIO_BLK_F_FLUSH was offered by the
    device;
    </li>
    <li 
  class="enumerate" id="x1-215004x2"><a 
 id="x1-2150032"></a> the  VIRTIO_BLK_F_CONFIG_WCE  feature  was  negotiated  and  the
    <span 
class="aeti-10">writeback </span>field in configuration space was 0 <span 
class="aebx-10">all the time between the</span>
    <span 
class="aebx-10">submission of the write and its completion</span>;
    </li>
    <li 
  class="enumerate" id="x1-215006x3"><a 
 id="x1-2150053"></a> a VIRTIO_BLK_T_FLUSH request is sent <span 
class="aebx-10">after the write is completed</span>
    and is completed itself.</li></ol>
<!--l. 4338--><p class="noindent" >If the device is backed by persistent storage, the device MUST ensure that stable
writes are committed to it, before reporting completion of the write (cases <a 
href="#x1-2150011">1<!--tex4ht:ref: item:flush1 --></a>
and <a 
href="#x1-2150032">2<!--tex4ht:ref: item:flush2 --></a>) or the flush (case <a 
href="#x1-2150053">3<!--tex4ht:ref: item:flush3 --></a>). Failure to do so can cause data loss in case of a
crash.
<!--l. 4344--><p class="noindent" >If the driver changes <span 
class="aeti-10">writeback </span>between the submission of the write and its
completion, the write could be either volatile or stable when its completion is
reported; in other words, the exact behavior is undefined.
<!--l. 4354--><p class="noindent" >If VIRTIO_BLK_F_FLUSH was not offered by the
device<span class="footnote-mark"><a 
href="#fn11x5" id="fn11x5-bk"><sup class="textsuperscript">11</sup></a></span><a 
 id="x1-215007f11"></a>,
the device MAY also commit writes to persistent device backend storage before
reporting their completion. Unlike case <a 
href="#x1-2150011">1<!--tex4ht:ref: item:flush1 --></a>, however, this is not an absolute
                                                                  

                                                                  
requirement of the specification.
<span 
class="aebx-10">Note:</span> An implementation that does not offer VIRTIO_BLK_F_FLUSH and
      does not commit completed writes will not be resilient to data loss in
      case  of  crashes.  Not  offering  VIRTIO_BLK_F_FLUSH  is  an  absolute
      requirement for implementations that do not wish to be safe against such
      data losses.
<a 
 id="x1-215008r217"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.3   </span> <a 
 id="x1-2160003"></a>Legacy Interface: Device Operation</h5>
<!--l. 4370--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format the
fields in struct virtio_blk_req according to the native endian of the guest rather than
(necessarily when not using the legacy interface) little-endian.
<!--l. 4375--><p class="noindent" >When using the legacy interface, transitional drivers SHOULD ignore the <span 
class="aeti-10">len </span>value in
used ring entries.
<span 
class="aebx-10">Note:</span> Historically, some devices put the total descriptor length, or the total
      length of device-writable buffers there, even when only the status byte
      was actually written.
<!--l. 4383--><p class="noindent" >The <span 
class="aeti-10">reserved </span>field was previously called <span 
class="aeti-10">ioprio</span>. <span 
class="aeti-10">ioprio </span>is a hint about the relative
priorities of requests to the device: higher numbers indicate more important
requests.
<!--l. 4387-->
<div class="lstlisting" id="listing-43"><span class="label"><a 
 id="x1-216001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_FLUSH_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span>
</div>
<!--l. 4391--><p class="noindent" >The command VIRTIO_BLK_T_FLUSH_OUT was a synonym for
VIRTIO_BLK_T_FLUSH; a driver MUST treat it as a VIRTIO_BLK_T_FLUSH
command.
<!--l. 4394-->
<div class="lstlisting" id="listing-44"><span class="label"><a 
 id="x1-216002r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_BARRIER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80000000</span>
</div>
<!--l. 4398--><p class="noindent" >If the device has VIRTIO_BLK_F_BARRIER feature the high bit
(VIRTIO_BLK_T_BARRIER) indicates that this request acts as a barrier and that
all preceding requests SHOULD be complete before this one, and all following
requests SHOULD NOT be started until this is complete.
                                                                  

                                                                  
<span 
class="aebx-10">Note:</span> A barrier does not flush caches in the underlying backend device in
      host, and thus does not serve as data consistency guarantee. Only a
      VIRTIO_BLK_T_FLUSH request does that.
<!--l. 4410--><p class="noindent" >Some older legacy devices did not commit completed writes to persistent device
backend storage when VIRTIO_BLK_F_FLUSH was offered but not negotiated.
In order to work around this, the driver MAY set the <span 
class="aeti-10">writeback </span>to 0 (if
available) or it MAY send an explicit flush request after every completed
write.
<!--l. 4416--><p class="noindent" >If the device has VIRTIO_BLK_F_SCSI feature, it can also support scsi packet
command requests, each of these requests is of form:
<!--l. 4419-->
<div class="lstlisting" id="listing-45"><span class="label"><a 
 id="x1-216003r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">All</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">native</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endian</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216004r2"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_pc_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216005r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216006r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ioprio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216007r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216008r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cmd</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216009r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[][512];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216010r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SCSI_SENSE_BUFFERSIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">96</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216011r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">SCSI_SENSE_BUFFERSIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216012r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">errors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216013r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216014r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216015r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">residual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216016r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216017r15"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4437--><p class="noindent" >A request type can also be a scsi packet command (VIRTIO_BLK_T_SCSI_CMD or
VIRTIO_BLK_T_SCSI_CMD_OUT). The two types are equivalent, the device does
not distinguish between them:
<!--l. 4441-->
<div class="lstlisting" id="listing-46"><span class="label"><a 
 id="x1-216018r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_SCSI_CMD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216019r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_SCSI_CMD_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 4446--><p class="noindent" >The <span 
class="aeti-10">cmd </span>field is only present for scsi packet command requests, and indicates the
command to perform. This field MUST reside in a single, separate device-readable
buffer; command length can be derived from the length of this buffer.
<!--l. 4451--><p class="noindent" >Note that these first three (four for scsi packet commands) fields are always
device-readable: <span 
class="aeti-10">data </span>is either device-readable or device-writable, depending on the
request. The size of the read or write can be derived from the total size of the request
buffers.
<!--l. 4456--><p class="noindent" ><span 
class="aeti-10">sense </span>is only present for scsi packet command requests, and indicates the buffer for
scsi sense data.
<!--l. 4459--><p class="noindent" ><span 
class="aeti-10">data_len </span>is only present for scsi packet command requests, this field is deprecated,
and SHOULD be ignored by the driver. Historically, devices copied data length
there.
<!--l. 4463--><p class="noindent" ><span 
class="aeti-10">sense_len </span>is only present for scsi packet command requests and indicates the number
of bytes actually written to the <span 
class="aeti-10">sense </span>buffer.
<!--l. 4467--><p class="noindent" ><span 
class="aeti-10">residual </span>field is only present for scsi packet command requests and indicates the
residual size, calculated as data length - number of bytes actually transferred.
<a 
 id="x1-216020r218"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.4   </span> <a 
 id="x1-2170004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 4474--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT:
    <ul class="itemize1">
    <li class="itemize">MUST use a single 8-byte descriptor containing <span 
class="aeti-10">type</span>, <span 
class="aeti-10">reserved </span>and <span 
class="aeti-10">sector</span>,
    followed by descriptors for <span 
class="aeti-10">data</span>, then finally a separate 1-byte descriptor
    for <span 
class="aeti-10">status</span>.
    </li>
    <li class="itemize">For  SCSI  commands  there  are  additional  constraints.  <span 
class="aeti-10">errors</span>,  <span 
class="aeti-10">data_len</span>,
    <span 
class="aeti-10">sense_len </span>and <span 
class="aeti-10">residual </span>MUST reside in a single, separate device-writable
    descriptor,  <span 
class="aeti-10">sense  </span>MUST  reside  in  a  single  separate  device-writable
    descriptor of size 96 bytes, and <span 
class="aeti-10">errors</span>, <span 
class="aeti-10">data_len</span>, <span 
class="aeti-10">sense_len  </span>and <span 
class="aeti-10">residual</span>
    MUST reside a single separate device-writable descriptor.</li></ul>
<!--l. 4493--><p class="noindent" >See <a 
href="#x1-260004">2.4.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing --></a>.
<a 
 id="x1-217001r204"></a>
<h3 class="sectionHead"><span class="titlemark">5.3   </span> <a 
 id="x1-2180003"></a>Console Device</h3>
<!--l. 4497--><p class="nopar" >The virtio console device is a simple device for data input and output. A
device MAY have one or more ports. Each port has a pair of input and
output virtqueues. Moreover, a device has a pair of control IO virtqueues. The
control virtqueues are used to communicate information between the device
and the driver about ports being opened and closed on either side of the
connection, indication from the device about whether a particular port is a console
port, adding new ports, port hot-plug/unplug, etc., and indication from
the driver about whether a port or a device was successfully added, port
open/close, etc. For data IO, one or more empty buffers are placed in the receive
queue for incoming data and outgoing characters are placed in the transmit
queue.
<a 
 id="x1-218001r215"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.1   </span> <a 
 id="x1-2190001"></a>Device ID</h4>
<!--l. 4512--><p class="nopar" >3
<a 
 id="x1-219001r221"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.2   </span> <a 
 id="x1-2200002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">receiveq(port0)
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">transmitq(port0)
    </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aebx-10">2</span> </dt><dd 
class="description">control receiveq
    </dd><dt class="description">
<span 
class="aebx-10">3</span> </dt><dd 
class="description">control transmitq
    </dd><dt class="description">
<span 
class="aebx-10">4</span> </dt><dd 
class="description">receiveq(port1)
    </dd><dt class="description">
<span 
class="aebx-10">5</span> </dt><dd 
class="description">transmitq(port1)
    </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description"></dd></dl>
<!--l. 4526--><p class="nopar" >The port 0 receive and transmit queues always exist: other queues only exist if
VIRTIO_CONSOLE_F_MULTIPORT is set.
<a 
 id="x1-220001r222"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.3   </span> <a 
 id="x1-2210003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_F_SIZE (0)</span> </dt><dd 
class="description">Configuration <span 
class="aeti-10">cols </span>and <span 
class="aeti-10">rows </span>are valid.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_F_MULTIPORT (1)</span> </dt><dd 
class="description">Device has support for multiple
    ports; <span 
class="aeti-10">max_nr_ports </span>is valid and control virtqueues will be used.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_F_EMERG_WRITE (2)</span> </dt><dd 
class="description">Device   has   support   for
    emergency write. Configuration field emerg_wr is valid.</dd></dl>
<a 
 id="x1-221001r223"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.4   </span> <a 
 id="x1-2220004"></a>Device configuration layout</h4>
<!--l. 4544--><p class="nopar" >The size of the console is supplied in the configuration space if
the VIRTIO_CONSOLE_F_SIZE feature is set. Furthermore, if the
VIRTIO_CONSOLE_F_MULTIPORT feature is set, the maximum number of ports
supported by the device can be fetched.
<!--l. 4550--><p class="noindent" >If VIRTIO_CONSOLE_F_EMERG_WRITE is set then the driver can use emergency
write to output a single character without initializing virtio queues, or even
acknowledging the feature.
<!--l. 4554-->
<div class="lstlisting" id="listing-47"><span class="label"><a 
 id="x1-222001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cols</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rows</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_nr_ports</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">emerg_wr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-222006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-222007r219"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.3.4.1   </span> <a 
 id="x1-2230001"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 4564--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_console_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-223001r224"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.5   </span> <a 
 id="x1-2240005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-224002x1">If         the         VIRTIO_CONSOLE_F_EMERG_WRITE         feature
    is offered, <span 
class="aeti-10">emerg_wr </span>field of the configuration can be written at any time.
    Thus it works for very early boot debugging output as well as catastophic
    OS failures (eg. virtio ring corruption).
    </li>
    <li 
  class="enumerate" id="x1-224004x2">If the VIRTIO_CONSOLE_F_SIZE feature is negotiated, the driver can
    read the console dimensions from <span 
class="aeti-10">cols </span>and <span 
class="aeti-10">rows</span>.
    </li>
    <li 
  class="enumerate" id="x1-224006x3">If  the  VIRTIO_CONSOLE_F_MULTIPORT  feature  is  negotiated,  the
    driver can spawn multiple ports, not all of which are necessarily attached to
    a console. Some could be generic ports. In this case, the control virtqueues
    are enabled and according to <span 
class="aeti-10">max_nr_ports</span>, the appropriate number of
    virtqueues are created. A control message indicating the driver is ready
    is  sent  to  the  device.  The  device  can  then  send  control  messages  for
    adding new ports to the device. After creating and initializing each port, a
    VIRTIO_CONSOLE_PORT_READY control message is sent to the device
    for  that  port  so  the  device  can  let  the  driver  know  of  any  additional
    configuration options set for that port.
    </li>
    <li 
  class="enumerate" id="x1-224008x4">The receiveq for each port is populated with one or more receive buffers.</li></ol>
<a 
 id="x1-224009r225"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.5.1   </span> <a 
 id="x1-2250001"></a>Device Requirements: Device Initialization</h5>
<!--l. 4599--><p class="nopar" >The device MUST allow a write to <span 
class="aeti-10">emerg_wr</span>, even on an unconfigured device.
<!--l. 4602--><p class="noindent" >The device SHOULD transmit the lower byte written to <span 
class="aeti-10">emerg_wr </span>to an appropriate
log or output method.
<a 
 id="x1-225001r226"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.6   </span> <a 
 id="x1-2260006"></a>Device Operation</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-226002x1">For output, a buffer containing the characters is placed in the port’s transmitq<span class="footnote-mark"><a 
href="#fn12x5" id="fn12x5-bk"><sup class="textsuperscript">12</sup></a></span><a 
 id="x1-226003f12"></a>.
                                                                  

                                                                  
    </li>
    <li 
  class="enumerate" id="x1-226005x2">When  a  buffer  is  used  in  the  receiveq  (signalled  by  an  interrupt),  the
    contents is the input to the port associated with the virtqueue for which
    the notification was received.
    </li>
    <li 
  class="enumerate" id="x1-226007x3">If  the  driver  negotiated  the  VIRTIO_CONSOLE_F_SIZE  feature,  a
    configuration change interrupt indicates that the updated size can be read
    from the configuration fields. This size applies to port 0 only.
    </li>
    <li 
  class="enumerate" id="x1-226009x4">If the driver negotiated the VIRTIO_CONSOLE_F_MULTIPORT feature,
    active      ports      are      announced      by      the      device      using
    the VIRTIO_CONSOLE_PORT_ADD control message. The same message
    is used for port hot-plug as well.</li></ol>
<a 
 id="x1-226010r227"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.1   </span> <a 
 id="x1-2270001"></a>Driver Requirements: Device Operation</h5>
<!--l. 4634--><p class="nopar" >The driver MUST NOT put a device-readable in a receiveq. The driver MUST NOT
put a device-writable buffer in a transmitq.
<a 
 id="x1-227001r229"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.2   </span> <a 
 id="x1-2280002"></a>Multiport Device Operation</h5>
<!--l. 4639--><p class="nopar" >If the driver negotiated the VIRTIO_CONSOLE_F_MULTIPORT, the two control
queues are used to manipulate the different console ports: the control receiveq for
messages from the device to the driver, and the control sendq for driver-to-device
messages. The layout of the control messages is:
<!--l. 4645-->
<div class="lstlisting" id="listing-48"><span class="label"><a 
 id="x1-228001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-228002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Port</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">number</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-228003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">kind</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-228004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Extra</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">information</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-228005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4653--><p class="noindent" >The values for <span 
class="aeti-10">event </span>are:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_DEVICE_READY (0)</span> </dt><dd 
class="description">Sent      by      the      driver
    at initialization to indicate that it is ready to receive control messages. A
    value of 1 indicates success, and 0 indicates failure. The port number <span 
class="aeti-10">id </span>is
    unused.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_DEVICE_ADD (1)</span> </dt><dd 
class="description">Sent by the device, to create a
    new port. <span 
class="aeti-10">value </span>is unused.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_DEVICE_REMOVE (2)</span> </dt><dd 
class="description">Sent   by   the   device,   to
                                                                  

                                                                  
    remove an existing port. <span 
class="aeti-10">value </span>is unused.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_PORT_READY (3)</span> </dt><dd 
class="description">Sent by the driver in response
    to the device’s VIRTIO_CONSOLE_PORT_ADD message, to indicate that
    the port is ready to be used. A <span 
class="aeti-10">value </span>of 1 indicates success, and 0 indicates
    failure.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_CONSOLE_PORT (4)</span> </dt><dd 
class="description">Sent   by   the   device   to
    nominate a port as a console port. There MAY be more than one console
    port.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_RESIZE (5)</span> </dt><dd 
class="description">Sent by the device to indicate a console size
    change. <span 
class="aeti-10">value </span>is unused. The buffer is followed by the number of columns and
    rows: <!--l. 4670-->
    <div class="lstlisting" id="listing-49"><span class="label"><a 
 id="x1-228006r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_resize</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-228007r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cols</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-228008r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rows</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-228009r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_PORT_OPEN (6)</span> </dt><dd 
class="description">This message is sent by both the device
    and the driver. <span 
class="aeti-10">value </span>indicates the state: 0 (port closed) or 1 (port open). This
    allows for ports to be used directly by guest and host processes to communicate
    in an application-defined manner.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_CONSOLE_PORT_NAME (7)</span> </dt><dd 
class="description">Sent by the device to give a tag to the
    port. This control command is immediately followed by the UTF-8
    name of the port for identification within the guest (without a NUL
    terminator).</dd></dl>
<a 
 id="x1-228010r199"></a>
<h5 class="paragraphHead"><span class="titlemark">5.3.6.2.1</span> <a 
 id="x1-2290001"></a>Device Requirements: Multiport Device Operation</h5>
The device MUST NOT specify a port which exists in a VIRTIO_CONSOLE_DEVICE_ADD
message, nor a port which is equal or greater than <span 
class="aeti-10">max_nr_ports</span>.
<!--l. 4693--><p class="noindent" >The device MUST NOT specify a port in VIRTIO_CONSOLE_DEVICE_REMOVE
which has not been created with a previous VIRTIO_CONSOLE_DEVICE_ADD.
<a 
 id="x1-229001r231"></a>
<h5 class="paragraphHead"><span class="titlemark">5.3.6.2.2</span> <a 
 id="x1-2300002"></a>Driver Requirements: Multiport Device Operation</h5>
The driver MUST send a VIRTIO_CONSOLE_DEVICE_READY message if
VIRTIO_CONSOLE_F_MULTIPORT is negotiated.
                                                                  

                                                                  
<!--l. 4701--><p class="noindent" >Upon receipt of a VIRTIO_CONSOLE_CONSOLE_PORT message, the driver
SHOULD treat the port in a manner suitable for text console access and MUST
respond with a VIRTIO_CONSOLE_PORT_OPEN message, which MUST have <span 
class="aeti-10">value</span>
set to 1.
<a 
 id="x1-230001r230"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.3   </span> <a 
 id="x1-2310003"></a>Legacy Interface: Device Operation</h5>
<!--l. 4707--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format
the fields in struct virtio_console_control according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 4712--><p class="noindent" >When using the legacy interface, the driver SHOULD ignore the <span 
class="aeti-10">len </span>value in used
ring entries for the transmit queues and the control transmitq.
<span 
class="aebx-10">Note:</span> Historically, some devices put the total descriptor length there, even
      though no data was actually written.
<a 
 id="x1-231001r233"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.4   </span> <a 
 id="x1-2320004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 4723--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use only a single descriptor for all buffers in the
control receiveq and control transmitq.
<a 
 id="x1-232001r220"></a>
<h3 class="sectionHead"><span class="titlemark">5.4   </span> <a 
 id="x1-2330004"></a>Entropy Device</h3>
<!--l. 4729--><p class="nopar" >The virtio entropy device supplies high-quality randomness for guest use.
<a 
 id="x1-233001r228"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.1   </span> <a 
 id="x1-2340001"></a>Device ID</h4>
<!--l. 4733--><p class="nopar" >4
<a 
 id="x1-234001r236"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.2   </span> <a 
 id="x1-2350002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">requestq</dd></dl>
<a 
 id="x1-235001r237"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.3   </span> <a 
 id="x1-2360003"></a>Feature bits</h4>
<!--l. 4741--><p class="nopar" >None currently defined
<a 
 id="x1-236001r238"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.4.4   </span> <a 
 id="x1-2370004"></a>Device configuration layout</h4>
<!--l. 4744--><p class="nopar" >None currently defined.
<a 
 id="x1-237001r239"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.5   </span> <a 
 id="x1-2380005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-238002x1">The virtqueue is initialized</li></ol>
<a 
 id="x1-238003r240"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.6   </span> <a 
 id="x1-2390006"></a>Device Operation</h4>
<!--l. 4754--><p class="nopar" >When the driver requires random bytes, it places the descriptor of one or more
buffers in the queue. It will be completely filled by random data by the
device.
<a 
 id="x1-239001r234"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.4.6.1   </span> <a 
 id="x1-2400001"></a>Driver Requirements: Device Operation</h5>
<!--l. 4760--><p class="nopar" >The driver MUST NOT place driver-readable buffers into the queue.
<!--l. 4762--><p class="noindent" >The driver MUST examine the length written by the device to determine how many
random bytes were received.
<a 
 id="x1-240001r242"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.4.6.2   </span> <a 
 id="x1-2410002"></a>Device Requirements: Device Operation</h5>
<!--l. 4767--><p class="nopar" >The device MUST place one or more random bytes into the buffer, but it MAY use
less than the entire buffer length.
<a 
 id="x1-241001r235"></a>
<h3 class="sectionHead"><span class="titlemark">5.5   </span> <a 
 id="x1-2420005"></a>Traditional Memory Balloon Device</h3>
<!--l. 4772--><p class="nopar" >This is the traditional balloon device. The device number 13 is reserved for a new
memory balloon interface, with different semantics, which is expected in a future
version of the standard.
<!--l. 4776--><p class="noindent" >The traditional virtio memory balloon device is a primitive device for managing guest
memory: the device asks for a certain amount of memory, and the driver supplies it
(or withdraws it, if the device has more than it asks for). This allows the guest to
adapt to changes in allowance of underlying physical memory. If the feature is
negotiated, the device can also be used to communicate guest memory statistics to
the host.
<a 
 id="x1-242001r241"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.1   </span> <a 
 id="x1-2430001"></a>Device ID</h4>
<!--l. 4785--><p class="nopar" >5
                                                                  

                                                                  
<a 
 id="x1-243001r245"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.2   </span> <a 
 id="x1-2440002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">inflateq
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">deflateq
    </dd><dt class="description">
<span 
class="aebx-10">2</span> </dt><dd 
class="description">statsq.</dd></dl>
<!--l. 4794--><p class="nopar" >Virtqueue 2 only exists if VIRTIO_BALLON_F_STATS_VQ set.
<a 
 id="x1-244001r246"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.3   </span> <a 
 id="x1-2450003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_F_MUST_TELL_HOST (0)</span> </dt><dd 
class="description">Host  has  to  be  told
    before pages from the balloon are used.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_F_STATS_VQ (1)</span> </dt><dd 
class="description">A  virtqueue  for  reporting  guest
    memory statistics is present.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_F_DEFLATE_ON_OOM (2)</span>  </dt><dd 
class="description">Deflate   balloon   on
    guest out of memory condition.
    </dd></dl>
<a 
 id="x1-245001r243"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.3.1   </span> <a 
 id="x1-2460001"></a>Driver Requirements: Feature bits</h5>
<!--l. 4809--><p class="nopar" >The driver SHOULD accept the VIRTIO_BALLOON_F_MUST_TELL_HOST feature
if offered by the device.
<a 
 id="x1-246001r248"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.3.2   </span> <a 
 id="x1-2470002"></a>Device Requirements: Feature bits</h5>
<!--l. 4813--><p class="nopar" >If the device offers the VIRTIO_BALLOON_F_MUST_TELL_HOST feature bit, and
if the driver did not accept this feature bit, the device MAY signal failure
by failing to set FEATURES_OK <span 
class="aeti-10">device status </span>bit when the driver writes
it.
<a 
 id="x1-247001r202"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.5.3.2.0.1</span> <a 
 id="x1-2480001"></a>Legacy Interface: Feature bits</h6>
As the legacy interface does not have a way to gracefully report feature negotiation
failure, when using the legacy interface, transitional devices MUST support
                                                                  

                                                                  
guests which do not negotiate VIRTIO_BALLOON_F_MUST_TELL_HOST
feature, and SHOULD allow guest to use memory before notifying host if
VIRTIO_BALLOON_F_MUST_TELL_HOST is not negotiated.
<a 
 id="x1-248001r247"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.4   </span> <a 
 id="x1-2490004"></a>Device configuration layout</h4>
<!--l. 4828--><p class="nopar" >Both fields of this configuration are always available.
<!--l. 4831-->
<div class="lstlisting" id="listing-50"><span class="label"><a 
 id="x1-249001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_balloon_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_pages</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-249005r250"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.5.4.0.0.1</span> <a 
 id="x1-2500001"></a>Legacy Interface: Device configuration layout</h6>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_balloon_config according to the little-endian
format.
<span 
class="aebx-10">Note:</span> This is unlike the usual convention that legacy device fields are guest
      endian.
<a 
 id="x1-250001r251"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.5   </span> <a 
 id="x1-2510005"></a>Device Initialization</h4>
<!--l. 4849--><p class="nopar" >The device initialization process is outlined below:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-251002x1">The inflate and deflate virtqueues are identified.
    </li>
    <li 
  class="enumerate" id="x1-251004x2">If the VIRTIO_BALLOON_F_STATS_VQ feature bit is negotiated:
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-251006x1">Identify the stats virtqueue.
        </li>
        <li 
  class="enumerate" id="x1-251008x2">Add one empty buffer to the stats virtqueue.
        </li>
        <li 
  class="enumerate" id="x1-251010x3">DRIVER_OK is set: device operation begins.
        </li>
        <li 
  class="enumerate" id="x1-251012x4">Notify the device about the stats virtqueue buffer.</li></ol>
    </li></ol>
<a 
 id="x1-251013r253"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.5.6   </span> <a 
 id="x1-2520006"></a>Device Operation</h4>
<!--l. 4865--><p class="nopar" >The device is driven either by the receipt of a configuration change interrupt, or by
changing guest memory needs, such as performing memory compaction or responding
to out of memory conditions.
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-252002x1"><span 
class="aeti-10">num_pages </span>configuration field is examined. If this is greater than the <span 
class="aeti-10">actual</span>
    number of pages, the balloon wants more memory from the guest. If it is
    less than <span 
class="aeti-10">actual</span>, the balloon doesn’t need it all.
    </li>
    <li 
  class="enumerate" id="x1-252004x2">To supply memory to the balloon (aka. inflate):
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-252006x1">The driver constructs an array of addresses of unused memory pages.
        These addresses are divided by 4096<span class="footnote-mark"><a 
href="#fn13x5" id="fn13x5-bk"><sup class="textsuperscript">13</sup></a></span><a 
 id="x1-252007f13"></a>
        and the descriptor describing the resulting 32-bit array is added to the
        inflateq.</li></ol>
    </li>
    <li 
  class="enumerate" id="x1-252009x3">To remove memory from the balloon (aka. deflate):
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-252011x1">The driver constructs an array of addresses of memory pages it has
        previously given to the balloon, as described above. This descriptor is
        added to the deflateq.
        </li>
        <li 
  class="enumerate" id="x1-252013x2">If    the    VIRTIO_BALLOON_F_MUST_TELL_HOST    feature    is
        negotiated, the guest informs the device of pages before it uses them.
        </li>
        <li 
  class="enumerate" id="x1-252015x3">Otherwise, the guest is allowed to re-use pages previously given to the
        balloon before the device has acknowledged their withdrawal<span class="footnote-mark"><a 
href="#fn14x5" id="fn14x5-bk"><sup class="textsuperscript">14</sup></a></span><a 
 id="x1-252016f14"></a>.</li></ol>
    </li>
    <li 
  class="enumerate" id="x1-252018x4">In either case, the device acknowledges inflate and deflate requests by using the
    descriptor.
    </li>
    <li 
  class="enumerate" id="x1-252020x5">Once the device has acknowledged the inflation or deflation, the driver updates
    <span 
class="aeti-10">actual </span>to reflect the new number of pages in the balloon.</li></ol>
<a 
 id="x1-252021r249"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.1   </span> <a 
 id="x1-2530001"></a>Driver Requirements: Device Operation</h5>
<!--l. 4906--><p class="nopar" >The driver SHOULD supply pages to the balloon when <span 
class="aeti-10">num_pages </span>is greater than the
actual number of pages in the balloon.
<!--l. 4909--><p class="noindent" >The driver MAY use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than the actual
                                                                  

                                                                  
number of pages in the balloon.
<!--l. 4912--><p class="noindent" >The driver MAY supply pages to the balloon when <span 
class="aeti-10">num_pages </span>is greater than or
equal to the actual number of pages in the balloon.
<!--l. 4915--><p class="noindent" >If VIRTIO_BALLOON_F_DEFLATE_ON_OOM has not been negotiated, the driver
MUST NOT use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than or equal to the
actual number of pages in the balloon.
<!--l. 4920--><p class="noindent" >If VIRTIO_BALLOON_F_DEFLATE_ON_OOM has been negotiated, the
driver MAY use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than or
equal to the actual number of pages in the balloon if this is required for
system stability (e.g. if memory is required by applications running within the
guest).
<!--l. 4927--><p class="noindent" >The driver MUST use the deflateq to inform the device of pages that it wants to use
from the balloon.
<!--l. 4930--><p class="noindent" >If the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is negotiated, the driver
MUST NOT use pages from the balloon until the device has acknowledged the deflate
request.
<!--l. 4934--><p class="noindent" >Otherwise, if the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is not
negotiated, the driver MAY begin to re-use pages previously given to the balloon
before the device has acknowledged the deflate request.
<!--l. 4939--><p class="noindent" >In any case, the driver MUST NOT use pages from the balloon after adding the
pages to the balloon, but before the device has acknowledged the inflate
request.
<!--l. 4943--><p class="noindent" >The driver MUST NOT request deflation of pages in the balloon before the device
has acknowledged the inflate request.
<!--l. 4947--><p class="noindent" >The driver MUST update <span 
class="aeti-10">actual </span>after changing the number of pages in the
balloon.
<!--l. 4950--><p class="noindent" >The driver MAY update <span 
class="aeti-10">actual </span>once after multiple inflate and deflate operations.
<a 
 id="x1-253001r255"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.2   </span> <a 
 id="x1-2540002"></a>Device Requirements: Device Operation</h5>
<!--l. 4955--><p class="nopar" >The device MAY modify the contents of a page in the balloon after detecting its
physical number in an inflate request and before acknowledging the inflate request by
using the inflateq descriptor.
<!--l. 4960--><p class="noindent" >If the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is negotiated, the device
MAY modify the contents of a page in the balloon after detecting its physical number
in an inflate request and before detecting its physical number in a deflate request and
acknowledging the deflate request.
<a 
 id="x1-254001r232"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.5.6.2.1</span> <a 
 id="x1-2550001"></a>Legacy Interface: Device Operation</h5>
When using the legacy interface, the driver SHOULD ignore the <span 
class="aeti-10">len </span>value in used
ring entries.
<span 
class="aebx-10">Note:</span> Historically, some devices put the total descriptor length there, even
      though no data was actually written.
<!--l. 4974--><p class="nopar" >When using the legacy interface, the driver MUST write out all 4 bytes each time it
updates the <span 
class="aeti-10">actual </span>value in the configuration space, using a single atomic
operation.
<!--l. 4978--><p class="noindent" >When using the legacy interface, the device SHOULD NOT use the <span 
class="aeti-10">actual </span>value
written by the driver in the configuration space, until the last, most-significant byte
of the value has been written.
<span 
class="aebx-10">Note:</span> Historically, devices used the <span 
class="aeti-10">actual </span>value, even though when using Virtio
      Over PCI Bus the device-specific configuration space was not guaranteed
      to be atomic. Using intermediate values during update by driver is best
      avoided, except for debugging.
      <!--l. 4989--><p class="noindent" >Historically, drivers using Virtio Over PCI Bus wrote the <span 
class="aeti-10">actual </span>value
      by using multiple single-byte writes in order, from the least-significant
      to the most-significant value.
<a 
 id="x1-255001r256"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.3   </span> <a 
 id="x1-2560003"></a>Memory Statistics</h5>
<!--l. 4995--><p class="nopar" >The stats virtqueue is atypical because communication is driven by the device (not
the driver). The channel becomes active at driver initialization time when the driver
adds an empty buffer and notifies the device. A request for memory statistics
proceeds as follows:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-256002x1">The device pushes the buffer onto the used ring and sends an interrupt.
    </li>
    <li 
  class="enumerate" id="x1-256004x2">The driver pops the used buffer and discards it.
    </li>
    <li 
  class="enumerate" id="x1-256006x3">The driver collects memory statistics and writes them into a new buffer.
    </li>
    <li 
  class="enumerate" id="x1-256008x4">The driver adds the buffer to the virtqueue and notifies the device.
    </li>
    <li 
  class="enumerate" id="x1-256010x5">The device pops the buffer (retaining it to initiate a subsequent request)
    and consumes the statistics.</li></ol>
                                                                  

                                                                  
<!--l. 5017--><p class="noindent" >Within the buffer, statistics are an array of 6-byte entries. Each statistic consists of a
16 bit tag and a 64 bit value. All statistics are optional and the driver chooses which
ones to supply. To guarantee backwards compatibility, devices omit unsupported
statistics.
<!--l. 5023-->
<div class="lstlisting" id="listing-51"><span class="label"><a 
 id="x1-256011r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_balloon_stat</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256012r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_SWAP_IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256013r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_SWAP_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256014r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MAJFLT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256015r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MINFLT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256016r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MEMFREE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256017r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MEMTOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256018r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256019r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">val</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-256020r10"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">__attribute__</span><span 
class="pcrr8t-x-x-80">((</span><span 
class="pcrr8t-x-x-80">packed</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<a 
 id="x1-256021r257"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.1</span> <a 
 id="x1-2570001"></a>Driver Requirements: Memory Statistics</h5>
Normative statements in this section apply if and only if the
VIRTIO_BALLOON_F_STATS_VQ feature has been negotiated.
<!--l. 5040--><p class="noindent" >The driver MUST make at most one buffer available to the device in the statsq, at all
times.
<!--l. 5043--><p class="noindent" >After initializing the device, the driver MUST make an output buffer available in the
statsq.
<!--l. 5046--><p class="noindent" >Upon detecting that device has used a buffer in the statsq, the driver MUST make an
output buffer available in the statsq.
<!--l. 5049--><p class="noindent" >Before making an output buffer available in the statsq, the driver MUST initialize
it, including one struct virtio_balloon_stat entry for each statistic that it
supports.
<!--l. 5053--><p class="noindent" >Driver MUST use an output buffer size which is a multiple of 6 bytes for all buffers
submitted to the statsq.
<!--l. 5056--><p class="noindent" >Driver MAY supply struct virtio_balloon_stat entries in the output buffer submitted
to the statsq in any order, without regard to <span 
class="aeti-10">tag </span>values.
<!--l. 5060--><p class="noindent" >Driver MAY supply a subset of all statistics in the output buffer submitted to the
statsq.
<!--l. 5063--><p class="noindent" >Driver MUST supply the same subset of statistics in all buffers submitted to the
statsq.
<a 
 id="x1-257001r259"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.2</span> <a 
 id="x1-2580002"></a>Device Requirements: Memory Statistics</h5>
Normative statements in this section apply if and only if the
VIRTIO_BALLOON_F_STATS_VQ feature has been negotiated.
<!--l. 5070--><p class="noindent" >Within an output buffer submitted to the statsq, the device MUST ignore entries
with <span 
class="aeti-10">tag </span>values that it does not recognize.
                                                                  

                                                                  
<!--l. 5073--><p class="noindent" >Within an output buffer submitted to the statsq, the device MUST accept struct
virtio_balloon_stat entries in any order without regard to <span 
class="aeti-10">tag </span>values.
<a 
 id="x1-258001r260"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.3</span> <a 
 id="x1-2590003"></a>Legacy Interface: Memory Statistics</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_balloon_stat according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 5084--><p class="noindent" >When using the legacy interface, the device SHOULD ignore all values in the first
buffer in the statsq supplied by the driver after device initialization.
<span 
class="aebx-10">Note:</span> Historically, drivers supplied an uninitialized buffer in the first buffer.
<a 
 id="x1-259001r258"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.4   </span> <a 
 id="x1-2600004"></a>Memory Statistics Tags</h5>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_SWAP_IN (0)</span> </dt><dd 
class="description">The  amount  of  memory  that  has
    been swapped in (in bytes).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_SWAP_OUT (1)</span> </dt><dd 
class="description">The amount of memory that has
    been swapped out to disk (in bytes).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_MAJFLT (2)</span> </dt><dd 
class="description">The  number  of  major  page  faults
    that have occurred.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_MINFLT (3)</span> </dt><dd 
class="description">The  number  of  minor  page  faults
    that have occurred.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_MEMFREE (4)</span> </dt><dd 
class="description">The amount of memory not being
    used for any purpose (in bytes).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_BALLOON_S_MEMTOT (5)</span> </dt><dd 
class="description">The   total   amount   of   memory
    available (in bytes).</dd></dl>
<a 
 id="x1-260001r244"></a>
<h3 class="sectionHead"><span class="titlemark">5.6   </span> <a 
 id="x1-2610006"></a>SCSI Host Device</h3>
<!--l. 5116--><p class="nopar" >The virtio SCSI host device groups together one or more virtual logical units (such as
disks), and allows communicating to them using the SCSI protocol. An instance of
the device represents a SCSI host to which many targets and LUNs are
                                                                  

                                                                  
attached.
<!--l. 5121--><p class="noindent" >The virtio SCSI device services two kinds of requests:
    <ul class="itemize1">
    <li class="itemize">command requests for a logical unit;
    </li>
    <li class="itemize">task management functions related to a logical unit, target or command.</li></ul>
<!--l. 5129--><p class="noindent" >The device is also able to send out notifications about added and removed logical
units. Together, these capabilities provide a SCSI transport protocol that uses
virtqueues as the transfer medium. In the transport protocol, the virtio driver acts as
the initiator, while the virtio SCSI host provides one or more targets that receive and
process the requests.
<!--l. 5136--><p class="noindent" >This section relies on definitions from <a 
href="#x1-3001r1">SAM</a>.
<a 
 id="x1-261001r254"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.1   </span> <a 
 id="x1-2620001"></a>Device ID</h4>
<!--l. 5139--><p class="nopar" >8
<a 
 id="x1-262001r264"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.2   </span> <a 
 id="x1-2630002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">controlq
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">eventq
    </dd><dt class="description">
<span 
class="aebx-10">2</span><span 
class="aebx-10">…n</span> </dt><dd 
class="description">request queues</dd></dl>
<a 
 id="x1-263001r265"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.3   </span> <a 
 id="x1-2640003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_F_INOUT (0)</span> </dt><dd 
class="description">A    single    request    can    include    both
    device-readable and device-writable data buffers.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_F_HOTPLUG (1)</span> </dt><dd 
class="description">The host SHOULD enable reporting of
    hot-plug and hot-unplug events for LUNs and targets on the SCSI bus.
    The guest SHOULD handle hot-plug and hot-unplug events.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_F_CHANGE (2)</span> </dt><dd 
class="description">The  host  will  report  changes  to  LUN
    parameters  via  a  VIRTIO_SCSI_T_PARAM_CHANGE  event;  the  guest
    SHOULD handle them.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_F_T10_PI (3)</span> </dt><dd 
class="description">The   extended   fields   for   T10   protection
    information (DIF/DIX) are included in the SCSI request header.</dd></dl>
<a 
 id="x1-264001r266"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.4   </span> <a 
 id="x1-2650004"></a>Device configuration layout</h4>
<!--l. 5169--><p class="nopar" >All fields of this configuration are always available.
<!--l. 5171-->
<div class="lstlisting" id="listing-52"><span class="label"><a 
 id="x1-265001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">seg_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cmd_per_lun</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_info_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cdb_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_channel</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_target</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_lun</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-265012r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">num_queues</span> </dt><dd 
class="description">is the total number of request virtqueues exposed by the device.
    The driver MAY use only one request queue, or it can use more to achieve
    better performance.
    </dd><dt class="description">
<span 
class="aebxti-10">seg_max</span> </dt><dd 
class="description">is the maximum number of segments that can be in a command. A
    bidirectional command can include <span 
class="aeti-10">seg_max </span>input segments and <span 
class="aeti-10">seg_max</span>
    output segments.
    </dd><dt class="description">
<span 
class="aebxti-10">max_sectors</span> </dt><dd 
class="description">is a hint to the driver about the maximum transfer size to use.
    </dd><dt class="description">
<span 
class="aebxti-10">cmd_per_lun</span> </dt><dd 
class="description">is tells the driver the maximum number of linked commands it
    can send to one LUN.
    </dd><dt class="description">
<span 
class="aebxti-10">event_info_size</span> </dt><dd 
class="description">is the maximum size that the device will fill for buffers that
    the driver places in the eventq. It is written by the device depending on
    the set of negotiated features.
    </dd><dt class="description">
<span 
class="aebxti-10">sense_size</span> </dt><dd 
class="description">is the maximum size of the sense data that the device will write.
    The default value is written by the device and MUST be 96, but the driver
    can modify it. It is restored to the default when the device is reset.
    </dd><dt class="description">
<span 
class="aebxti-10">cdb_size</span> </dt><dd 
class="description">is the maximum size of the CDB that the driver will write. The default
    value is written by the device and MUST be 32, but the driver can likewise
    modify it. It is restored to the default when the device is reset.
    </dd><dt class="description">
<span 
class="aebxti-10">max_channel</span><span 
class="aebx-10">, </span><span 
class="aebxti-10">max_target </span><span 
class="aebx-10">and </span><span 
class="aebxti-10">max_lun</span> </dt><dd 
class="description">can be used by the driver as hints
    to constrain scanning the logical units on the host to channel/target/logical
    unit  numbers  that  are  less  than  or  equal  to  the  value  of  the  fields.
                                                                  

                                                                  
    <span 
class="aeti-10">max_channel </span>SHOULD be zero. <span 
class="aeti-10">max_target </span>SHOULD be less than or equal
    to 255. <span 
class="aeti-10">max_lun </span>SHOULD be less than or equal to 16383.</dd></dl>
<a 
 id="x1-265013r262"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.1   </span> <a 
 id="x1-2660001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 5226--><p class="nopar" >The driver MUST NOT write to device configuration fields other than <span 
class="aeti-10">sense_size </span>and
<span 
class="aeti-10">cdb_size</span>.
<!--l. 5229--><p class="noindent" >The driver MUST NOT send more than <span 
class="aeti-10">cmd_per_lun </span>linked commands to one LUN,
and MUST NOT send more than the virtqueue size number of linked commands to
one LUN.
<a 
 id="x1-266001r268"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.2   </span> <a 
 id="x1-2670002"></a>Device Requirements: Device configuration layout</h5>
<!--l. 5235--><p class="nopar" >On reset, the device MUST set <span 
class="aeti-10">sense_size </span>to 96 and <span 
class="aeti-10">cdb_size </span>to 32.
<a 
 id="x1-267001r269"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.3   </span> <a 
 id="x1-2680003"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 5239--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-268001r267"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.5   </span> <a 
 id="x1-2690005"></a>Device Requirements: Device Initialization</h4>
<!--l. 5246--><p class="nopar" >On initialization the driver SHOULD first discover the device’s virtqueues.
<!--l. 5249--><p class="noindent" >If the driver uses the eventq, the driver SHOULD place at least one buffer in the
eventq.
<!--l. 5252--><p class="noindent" >The  driver  MAY  immediately  issue
requests<span class="footnote-mark"><a 
href="#fn15x5" id="fn15x5-bk"><sup class="textsuperscript">15</sup></a></span><a 
 id="x1-269001f15"></a> or task
management functions<span class="footnote-mark"><a 
href="#fn16x5" id="fn16x5-bk"><sup class="textsuperscript">16</sup></a></span><a 
 id="x1-269002f16"></a>.
<a 
 id="x1-269003r271"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.6   </span> <a 
 id="x1-2700006"></a>Device Operation</h4>
<!--l. 5258--><p class="nopar" >Device operation consists of operating request queues, the control queue and the
event queue.
<a 
 id="x1-270001r261"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.0.1</span> <a 
 id="x1-2710001"></a>Legacy Interface: Device Operation</h5>
When using the legacy interface, the driver SHOULD ignore the <span 
class="aeti-10">len </span>value in used
ring entries.
                                                                  

                                                                  
<span 
class="aebx-10">Note:</span> Historically, devices put the total descriptor length, or the total length
      of device-writable buffers there, even when only part of the buffers were
      actually written.
<a 
 id="x1-271001r270"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.1   </span> <a 
 id="x1-2720001"></a>Device Operation: Request Queues</h5>
<!--l. 5273--><p class="nopar" >The driver queues requests to an arbitrary request queue, and they are used by the
device on that same queue. It is the responsibility of the driver to ensure strict
request ordering for commands placed on different queues, because they will be
consumed with no order constraints.
<!--l. 5279--><p class="noindent" >Requests have the following format:
<!--l. 5281-->
<div class="lstlisting" id="listing-53"><span class="label"><a 
 id="x1-272001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_req_cmd</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">task_attr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">prio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">crn</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cdb</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">cdb_size</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">two</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">present</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_F_T10_PI</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_bytesout</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_bytesin</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_out</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">pi_bytesout</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dataout</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">residual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status_qualifier</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sense_size</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">two</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">present</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_F_T10_PI</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_in</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">pi_bytesin</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">datain</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272027r27"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272030r30"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272031r31"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272032r32"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OVERRUN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272033r33"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ABORTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272034r34"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BAD_TARGET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272035r35"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272036r36"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272037r37"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272038r38"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TARGET_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272039r39"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_NEXUS_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272040r40"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272042r42"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">task_attr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272043r43"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_SIMPLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272044r44"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ORDERED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272045r45"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_HEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-272046r46"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ACA</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 5330--><p class="noindent" ><span 
class="aeti-10">lun </span>addresses the REPORT LUNS well-known logical unit, or a target and
logical unit in the virtio-scsi device’s SCSI domain. When used to address the
REPORT LUNS logical unit, <span 
class="aeti-10">lun </span>is 0xC1, 0x01 and six zero bytes. The
virtio-scsi device SHOULD implement the REPORT LUNS well-known logical
unit.
<!--l. 5336--><p class="noindent" >When used to address a target and logical unit, the only supported format for <span 
class="aeti-10">lun </span>is:
first byte set to 1, second byte set to target, third and fourth byte representing a
single level LUN structure, followed by four zero bytes. With this representation, a
virtio-scsi device can serve up to 256 targets and 16384 LUNs per target. The device
MAY also support having a well-known logical units in the third and fourth
byte.
<!--l. 5343--><p class="noindent" ><span 
class="aeti-10">id </span>is the command identifier (“tag”).
<!--l. 5345--><p class="noindent" ><span 
class="aeti-10">task_attr </span>defines the task attribute as in the table above, but all task attributes MAY
be mapped to SIMPLE by the device. Some commands are defined by SCSI
standards as "implicit head of queue"; for such commands, all task attributes MAY
also be mapped to HEAD OF QUEUE. Drivers and applications SHOULD NOT
send a command with the ORDERED task attribute if the command has an implicit
HEAD OF QUEUE attribute, because whether the ORDERED task attribute is
honored is vendor-specific.
<!--l. 5353--><p class="noindent" ><span 
class="aeti-10">crn </span>may also be provided by clients, but is generally expected to be 0. The maximum
CRN value defined by the protocol is 255, since CRN is stored in an 8-bit
integer.
<!--l. 5357--><p class="noindent" >The CDB is included in <span 
class="aeti-10">cdb </span>and its size, <span 
class="aeti-10">cdb_size</span>, is taken from the configuration
space.
                                                                  

                                                                  
<!--l. 5360--><p class="noindent" >All of these fields are defined in <a 
href="#x1-3001r1">SAM</a> and are always device-readable.
<!--l. 5363--><p class="noindent" ><span 
class="aeti-10">pi_bytesout </span>determines the size of the <span 
class="aeti-10">pi_out </span>field in bytes. If it is nonzero, the
<span 
class="aeti-10">pi_out </span>field contains outgoing protection information for write operations.
<span 
class="aeti-10">pi_bytesin </span>determines the size of the <span 
class="aeti-10">pi_in </span>field in the device-writable section, in
bytes. All three fields are only present if VIRTIO_SCSI_F_T10_PI has been
negotiated.
<!--l. 5369--><p class="noindent" >The remainder of the device-readable part is the data output buffer, <span 
class="aeti-10">dataout</span>.
<!--l. 5372--><p class="noindent" ><span 
class="aeti-10">sense </span>and subsequent fields are always device-writable. <span 
class="aeti-10">sense_len </span>indicates the
number of bytes actually written to the sense buffer.
<!--l. 5376--><p class="noindent" ><span 
class="aeti-10">residual </span>indicates the residual size, calculated as “data_length - number_of_transferred_bytes”,
for read or write operations. For bidirectional commands, the number_of_transferred_bytes
includes both read and written bytes. A <span 
class="aeti-10">residual </span>that is less than the size of <span 
class="aeti-10">datain</span>
means that <span 
class="aeti-10">dataout </span>was processed entirely. A <span 
class="aeti-10">residual </span>that exceeds the size of <span 
class="aeti-10">datain</span>
means that <span 
class="aeti-10">dataout </span>was processed partially and <span 
class="aeti-10">datain </span>was not processed at
all.
<!--l. 5386--><p class="noindent" >If the <span 
class="aeti-10">pi_bytesin </span>is nonzero, the <span 
class="aeti-10">pi_in </span>field contains incoming protection information
for read operations. <span 
class="aeti-10">pi_in </span>is only present if VIRTIO_SCSI_F_T10_PI has been
negotiated<span class="footnote-mark"><a 
href="#fn17x5" id="fn17x5-bk"><sup class="textsuperscript">17</sup></a></span><a 
 id="x1-272047f17"></a>.
<!--l. 5394--><p class="noindent" >The remainder of the device-writable part is the data input buffer, <span 
class="aeti-10">datain</span>.
<a 
 id="x1-272048r273"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.1</span> <a 
 id="x1-2730001"></a>Device Requirements: Device Operation: Request Queues</h5>
The device MUST write the <span 
class="aeti-10">status </span>byte as the status code as defined in
<a 
href="#x1-3001r1">SAM</a>.
<!--l. 5403--><p class="noindent" >The device MUST write the <span 
class="aeti-10">response </span>byte as one of the following:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_OK</span> </dt><dd 
class="description">when the request was completed and the <span 
class="aeti-10">status </span>byte is
    filled with a SCSI status code (not necessarily “GOOD”).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_OVERRUN</span> </dt><dd 
class="description">if  the  content  of  the  CDB  (such  as  the
    allocation length, parameter length or transfer size) requires more data
    than is available in the datain and dataout buffers.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_ABORTED</span> </dt><dd 
class="description">if the request was cancelled due to an ABORT
    TASK or ABORT TASK SET task management function.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_BAD_TARGET</span> </dt><dd 
class="description">if   the   request   was   never   processed
    because the target indicated by <span 
class="aeti-10">lun </span>does not exist.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_RESET</span> </dt><dd 
class="description">if the request was cancelled due to a bus or device
    reset (including a task management function).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span> </dt><dd 
class="description">if the request failed due to a
    problem in the connection between the host and the target (severed link).
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_TARGET_FAILURE</span> </dt><dd 
class="description">if the target is suffering a failure
    and to tell the driver not to retry on other paths.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_NEXUS_FAILURE</span> </dt><dd 
class="description">if the nexus is suffering a failure but
    retrying on other paths might yield a different result.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_BUSY</span> </dt><dd 
class="description">if the request failed but retrying on the same path
    is likely to work.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_SCSI_S_FAILURE</span> </dt><dd 
class="description">for other host or driver error. In particular, if
    neither  <span 
class="aeti-10">dataout  </span>nor  <span 
class="aeti-10">datain  </span>is  empty,  and  the  VIRTIO_SCSI_F_INOUT
    feature has not been negotiated, the request will be immediately returned
    with a response equal to VIRTIO_SCSI_S_FAILURE.</dd></dl>
<!--l. 5444--><p class="noindent" >All commands must be completed before the virtio-scsi device is reset or unplugged.
The device MAY choose to abort them, or if it does not do so MUST pick the
VIRTIO_SCSI_S_FAILURE response.
<a 
 id="x1-273001r275"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.2</span> <a 
 id="x1-2740002"></a>Driver Requirements: Device Operation: Request Queues</h5>
<span 
class="aeti-10">task_attr</span>, <span 
class="aeti-10">prio </span>and <span 
class="aeti-10">crn </span>SHOULD be zero.
<!--l. 5452--><p class="noindent" >Upon receiving a VIRTIO_SCSI_S_TARGET_FAILURE response, the driver
SHOULD NOT retry the request on other paths.
<a 
 id="x1-274001r276"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.3</span> <a 
 id="x1-2750003"></a>Legacy Interface: Device Operation: Request Queues</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_req_cmd according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-275001r274"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.2   </span> <a 
 id="x1-2760002"></a>Device Operation: controlq</h5>
<!--l. 5463--><p class="nopar" >The controlq is used for other SCSI transport operations. Requests have the following
                                                                  

                                                                  
format:
<!--l. 5468-->
<div class="lstlisting" id="listing-54"><span class="label"><a 
 id="x1-276001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276003r3"></a></span><span 
class="pcrr8t-x-x-80">…</span><a 
 id="x1-276004r4"></a><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><a 
 id="x1-276005r5"></a><span 
class="pcrr8t-x-x-80">};</span><a 
 id="x1-276006r6"></a><a 
 id="x1-276007r7"></a><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">all</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">commands</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><a 
 id="x1-276008r8"></a><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><a 
 id="x1-276009r9"></a><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BAD_TARGET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><a 
 id="x1-276010r10"></a><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><a 
 id="x1-276011r11"></a><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><a 
 id="x1-276012r12"></a><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TARGET_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><a 
 id="x1-276013r13"></a><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_NEXUS_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><a 
 id="x1-276014r14"></a><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><a 
 id="x1-276015r15"></a><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_INCORRECT_LUN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span>
</div>
<!--l. 5487--><p class="noindent" >The <span 
class="aeti-10">type </span>identifies the remaining fields.
<!--l. 5489--><p class="noindent" >The following commands are defined:
    <ul class="itemize1">
    <li class="itemize">Task management function. <!--l. 5493-->
    <div class="lstlisting" id="listing-55"><span class="label"><a 
 id="x1-276016r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276017r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276018r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_ABORT_TASK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276019r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_ABORT_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276020r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_CLEAR_ACA</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276021r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_CLEAR_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276022r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_I_T_NEXUS_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276023r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_LOGICAL_UNIT_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276024r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_QUERY_TASK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276025r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_QUERY_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276026r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276027r12"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_tmf</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276028r13"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276029r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276030r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276031r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">subtype</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276032r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276033r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276034r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276035r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276036r21"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276037r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276038r23"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276039r24"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_COMPLETE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276040r25"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_SUCCEEDED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276041r26"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_REJECTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span>
    
    </div>
    <!--l. 5522--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_TMF; <span 
class="aeti-10">subtype </span>defines which task management
    function. All fields except <span 
class="aeti-10">response </span>are filled by the driver.
    <!--l. 5526--><p class="noindent" >Other fields which are irrelevant for the requested TMF are ignored but they are
    still present. <span 
class="aeti-10">lun </span>is in the same format specified for request queues; the single
    level LUN is ignored when the task management function addresses a whole I_T
    nexus. When relevant, the value of <span 
class="aeti-10">id </span>is matched against the id values passed on
    the requestq.
    <!--l. 5533--><p class="noindent" >The outcome of the task management function is written by the device in
    <span 
class="aeti-10">response</span>. The command-specific response values map 1-to-1 with those defined
    in <a 
href="#x1-3001r1">SAM</a>.
    <!--l. 5537--><p class="noindent" >Task management function can affect the response value for commands that are
    in the request queue and have not been completed yet. For example,
    the device MUST complete all active commands on a logical unit or
    target (possibly with a VIRTIO_SCSI_S_RESET response code) upon
    receiving a "logical unit reset" or "I_T nexus reset" TMF. Similarly,
    the device MUST complete the selected commands (possibly with a
    VIRTIO_SCSI_S_ABORTED response code) upon receiving an "abort task" or
    "abort task set" TMF. Such effects MUST take place before the TMF itself is
    successfully completed, and the device MUST use memory barriers
    appropriately in order to ensure that the driver sees these writes in the correct
    order.
    </li>
    <li class="itemize">Asynchronous notification query. <!--l. 5550-->
    <div class="lstlisting" id="listing-56"><span class="label"><a 
 id="x1-276042r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_AN_QUERY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276043r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276044r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276045r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276046r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276047r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276048r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_requested</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276049r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276050r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276051r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276052r11"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276053r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276054r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_OPERATIONAL_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276055r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_POWER_MGMT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276056r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_EXTERNAL_REQUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276057r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_MEDIA_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276058r17"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_MULTI_HOST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276059r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_DEVICE_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">64</span>
    
    </div>
                                                                  

                                                                  
    <!--l. 5571--><p class="noindent" >By sending this command, the driver asks the device which events the given
    LUN can report, as described in paragraphs 6.6 and A.6 of <a 
href="#x1-3001r1">SCSI MMC</a>. The
    driver writes the events it is interested in into <span 
class="aeti-10">event_requested</span>; the device
    responds by writing the events that it supports into <span 
class="aeti-10">event_actual</span>.
    <!--l. 5578--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_AN_QUERY. <span 
class="aeti-10">lun </span>and <span 
class="aeti-10">event_requested </span>are
    written by the driver. <span 
class="aeti-10">event_actual </span>and <span 
class="aeti-10">response </span>fields are written by the
    device.
    <!--l. 5582--><p class="noindent" >No command-specific values are defined for the <span 
class="aeti-10">response </span>byte.
    </li>
    <li class="itemize">Asynchronous notification subscription. <!--l. 5585-->
    <div class="lstlisting" id="listing-57"><span class="label"><a 
 id="x1-276060r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_AN_SUBSCRIBE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276061r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276062r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276063r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276064r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276065r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276066r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_requested</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276067r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276068r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276069r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-276070r11"></a></span><span 
class="pcrr8t-x-x-80">}</span>
    
    </div>
    <!--l. 5599--><p class="noindent" >By sending this command, the driver asks the specified LUN to report events for
    its physical interface, again as described in <a 
href="#x1-3001r1">SCSI MMC</a>. The driver writes the
    events it is interested in into <span 
class="aeti-10">event_requested</span>; the device responds by writing the
    events that it supports into <span 
class="aeti-10">event_actual</span>.
    <!--l. 5605--><p class="noindent" >Event types are the same as for the asynchronous notification query
    message.
    <!--l. 5608--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_AN_SUBSCRIBE. <span 
class="aeti-10">lun </span>and <span 
class="aeti-10">event_requested </span>are
    written by the driver. <span 
class="aeti-10">event_actual </span>and <span 
class="aeti-10">response </span>are written by the
    device.
    <!--l. 5612--><p class="noindent" >No command-specific values are defined for the response byte.</li></ul>
<a 
 id="x1-276071r277"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.2.1</span> <a 
 id="x1-2770001"></a>Legacy Interface: Device Operation: controlq</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_ctrl, struct virtio_scsi_ctrl_tmf, struct
virtio_scsi_ctrl_an and struct virtio_scsi_ctrl_an according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-277001r278"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.3   </span> <a 
 id="x1-2780003"></a>Device Operation: eventq</h5>
<!--l. 5627--><p class="nopar" >The eventq is populated by the driver for the device to report information on
logical units that are attached to it. In general, the device will not queue
events to cope with an empty eventq, and will end up dropping events if it
finds no buffer ready. However, when reporting events for many LUNs (e.g.
when a whole target disappears), the device can throttle events to avoid
dropping them. For this reason, placing 10-15 buffers on the event queue is
                                                                  

                                                                  
sufficient.
<!--l. 5636--><p class="noindent" >Buffers returned by the device on the eventq will be referred to as “events” in the rest
of this section. Events have the following format:
<!--l. 5640-->
<div class="lstlisting" id="listing-58"><span class="label"><a 
 id="x1-278001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_EVENTS_MISSED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80000000</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reason</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278008r8"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<!--l. 5651--><p class="noindent" >The devices sets bit 31 in <span 
class="aeti-10">event </span>to report lost events due to missing buffers.
<!--l. 5654--><p class="noindent" >The meaning of <span 
class="aeti-10">reason </span>depends on the contents of <span 
class="aeti-10">event</span>. The following events are
defined:
    <ul class="itemize1">
    <li class="itemize">No event. <!--l. 5659-->
    <div class="lstlisting" id="listing-59"><span class="label"><a 
 id="x1-278009r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_NO_EVENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
    
    </div>
    <!--l. 5663--><p class="noindent" >This event is fired in the following cases:
        <ul class="itemize2">
        <li class="itemize">When the device detects in the eventq a buffer that is shorter than
        what is indicated in the configuration field, it MAY use it immediately
        and put this dummy value in <span 
class="aeti-10">event</span>. A well-written driver will never
        observe this situation.
        </li>
        <li class="itemize">When events are dropped, the device MAY signal this event as soon
        as the drivers makes a buffer available, in order to request action from
        the driver. In this case, of course, this event will be reported with the
        VIRTIO_SCSI_T_EVENTS_MISSED flag.</li></ul>
    </li>
    <li class="itemize">Transport reset <!--l. 5680-->
    <div class="lstlisting" id="listing-60"><span class="label"><a 
 id="x1-278010r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TRANSPORT_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278011r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278012r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_HARD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278013r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_RESCAN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-278014r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_REMOVED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
    
    </div>
    <!--l. 5688--><p class="noindent" >By sending this event, the device signals that a logical unit on a target
    has been reset, including the case of a new device appearing or
    disappearing on the bus. The device fills in all fields. <span 
class="aeti-10">event </span>is set to
    VIRTIO_SCSI_T_TRANSPORT_RESET. <span 
class="aeti-10">lun </span>addresses a logical unit in the
    SCSI host.
    <!--l. 5695--><p class="noindent" >The <span 
class="aeti-10">reason </span>value is one of the three #define values appearing above:
                                                                  

                                                                  
        <dl class="description"><dt class="description">
    <span 
class="aebx-10">VIRTIO_SCSI_EVT_RESET_REMOVED</span> </dt><dd 
class="description">(“LUN/target  removed”)
        is  used  if  the  target  or  logical  unit  is  no  longer  able  to  receive
        commands.
        </dd><dt class="description">
    <span 
class="aebx-10">VIRTIO_SCSI_EVT_RESET_HARD</span> </dt><dd 
class="description">(“LUN hard reset”) is used if the
        logical unit has been reset, but is still present.
        </dd><dt class="description">
    <span 
class="aebx-10">VIRTIO_SCSI_EVT_RESET_RESCAN</span> </dt><dd 
class="description">(“rescan   LUN/target”)   is
        used if a target or logical unit has just appeared on the device.</dd></dl>
    <!--l. 5710--><p class="noindent" >The “removed” and “rescan” events can happen when VIRTIO_SCSI_F_HOTPLUG
    feature was negotiated; when sent for LUN 0, they MAY apply to the entire
    target so the driver can ask the initiator to rescan the target to detect
    this.
    <!--l. 5715--><p class="noindent" >Events will also be reported via sense codes (this obviously does not apply to
    newly appeared buses or targets, since the application has never discovered
    them):
        <ul class="itemize2">
        <li class="itemize">“LUN/target removed” maps to sense key ILLEGAL REQUEST, asc
        0x25, ascq 0x00 (LOGICAL UNIT NOT SUPPORTED)
        </li>
        <li class="itemize">“LUN hard reset” maps to sense key UNIT ATTENTION, asc 0x29
        (POWER ON, RESET OR BUS DEVICE RESET OCCURRED)
        </li>
        <li class="itemize">“rescan LUN/target” maps to sense key UNIT ATTENTION, asc 0x3f,
        ascq 0x0e (REPORTED LUNS DATA HAS CHANGED)</li></ul>
    <!--l. 5730--><p class="noindent" >The preferred way to detect transport reset is always to use events, because
    sense codes are only seen by the driver when it sends a SCSI command to
    the logical unit or target. However, in case events are dropped, the
    initiator will still be able to synchronize with the actual state of the
    controller if the driver asks the initiator to rescan of the SCSI bus. During
    the rescan, the initiator will be able to observe the above sense codes,
    and it will process them as if it the driver had received the equivalent
    event.
    </li>
    <li class="itemize">Asynchronous notification <!--l. 5741-->
    <div class="lstlisting" id="listing-61"><span class="label"><a 
 id="x1-278015r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_ASYNC_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
    
    </div>
                                                                  

                                                                  
    <!--l. 5745--><p class="noindent" >By sending this event, the device signals that an asynchronous event was fired
    from a physical interface.
    <!--l. 5748--><p class="noindent" >All fields are written by the device. <span 
class="aeti-10">event </span>is set to VIRTIO_SCSI_T_ASYNC_NOTIFY.
    <span 
class="aeti-10">lun </span>addresses a logical unit in the SCSI host. <span 
class="aeti-10">reason </span>is a subset of the events
    that the driver has subscribed to via the “Asynchronous notification
    subscription” command.
    </li>
    <li class="itemize">LUN parameter change <!--l. 5755-->
    <div class="lstlisting" id="listing-62"><span class="label"><a 
 id="x1-278016r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_PARAM_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
    
    </div>
    <!--l. 5759--><p class="noindent" >By sending this event, the device signals a change in the configuration
    parameters of a logical unit, for example the capacity or cache mode. <span 
class="aeti-10">event </span>is
    set to VIRTIO_SCSI_T_PARAM_CHANGE. <span 
class="aeti-10">lun </span>addresses a logical unit in the
    SCSI host.
    <!--l. 5764--><p class="noindent" >The same event SHOULD also be reported as a unit attention condition. <span 
class="aeti-10">reason</span>
    contains the additional sense code and additional sense code qualifier,
    respectively in bits 0…7 and 8…15.
    <span 
class="aebx-10">Note:</span> For example, a change in capacity will be reported as asc 0x2a, ascq
          0x09 (CAPACITY DATA HAS CHANGED).
    <!--l. 5772--><p class="noindent" >For MMC devices (inquiry type 5) there would be some overlap between this
    event and the asynchronous notification event, so for simplicity the host never
    reports this event for MMC devices.</li></ul>
<a 
 id="x1-278017r279"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.1</span> <a 
 id="x1-2790001"></a>Driver Requirements: Device Operation: eventq</h5>
The driver SHOULD keep the eventq populated with buffers. These buffers MUST be
device-writable, and SHOULD be at least <span 
class="aeti-10">event_info_size </span>bytes long, and MUST be
at least the size of struct virtio_scsi_event.
<!--l. 5784--><p class="noindent" >If <span 
class="aeti-10">event </span>has bit 31 set, the driver SHOULD poll the logical units for unit attention
conditions, and/or do whatever form of bus scan is appropriate for the guest
operating system and SHOULD poll for asynchronous events manually using SCSI
commands.
<!--l. 5789--><p class="noindent" >When receiving a VIRTIO_SCSI_T_TRANSPORT_RESET message with <span 
class="aeti-10">reason </span>set to
VIRTIO_SCSI_EVT_RESET_REMOVED or VIRTIO_SCSI_EVT_RESET_RESCAN
for LUN 0, the driver SHOULD ask the initiator to rescan the target, in order to
detect the case when an entire target has appeared or disappeared.
<a 
 id="x1-279001r281"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.2</span> <a 
 id="x1-2800002"></a>Device Requirements: Device Operation: eventq</h5>
The device MUST set bit 31 in <span 
class="aeti-10">event </span>if events were lost due to missing
buffers, and it MAY use a VIRTIO_SCSI_T_NO_EVENT event to report
this.
<!--l. 5801--><p class="noindent" >The device MUST NOT send VIRTIO_SCSI_T_TRANSPORT_RESET
messages with <span 
class="aeti-10">reason </span>set to VIRTIO_SCSI_EVT_RESET_REMOVED or
VIRTIO_SCSI_EVT_RESET_RESCAN unless VIRTIO_SCSI_F_HOTPLUG was
negotiated.
<!--l. 5805--><p class="noindent" >The device MUST NOT report VIRTIO_SCSI_T_PARAM_CHANGE for MMC
devices.
<a 
 id="x1-280001r282"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.3</span> <a 
 id="x1-2810003"></a>Legacy Interface: Device Operation: eventq</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_event according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-281001r280"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.4   </span> <a 
 id="x1-2820004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 5816--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use a single descriptor for the <span 
class="aeti-10">lun</span>, <span 
class="aeti-10">id</span>, <span 
class="aeti-10">task_attr</span>,
<span 
class="aeti-10">prio</span>, <span 
class="aeti-10">crn </span>and <span 
class="aeti-10">cdb </span>fields, and MUST only use a single descriptor for the <span 
class="aeti-10">sense_len</span>,
<span 
class="aeti-10">residual</span>, <span 
class="aeti-10">status_qualifier</span>, <span 
class="aeti-10">status</span>, <span 
class="aeti-10">response </span>and <span 
class="aeti-10">sense </span>fields.
<a 
 id="x1-282001r263"></a>
<h3 class="sectionHead"><span class="titlemark">5.7   </span> <a 
 id="x1-2830007"></a>Vhost-user Device Backend</h3>
<!--l. 5826--><p class="nopar" >The vhost-user device backend facilitates vhost-user device emulation through
vhost-user protocol exchanges and access to shared memory. Software-defined
networking, storage, and other I/O appliances can provide services through this
device.
<!--l. 5831--><p class="noindent" >This section relies on definitions from the <a 
href="#x1-3001r1">Vhost-user Protocol</a>. Knowledge of the
vhost-user protocol is a prerequisite for understanding this device.
<!--l. 5835--><p class="noindent" >The <a 
href="#x1-3001r1">Vhost-user Protocol</a> was originally designed for processes on a single system
communicating over UNIX domain sockets. The virtio vhost-user device
backend allows the vhost-user slave to communicate with the vhost-user master
over the device instead of a UNIX domain socket. This allows the slave and
master to run on two separate systems such as a virtual machine and a
hypervisor.
                                                                  

                                                                  
<!--l. 5842--><p class="noindent" >The vhost-user slave program exchanges vhost-user protocol messages with the
vhost-user master through this device. How the device implementation communicates
with the vhost-user master is beyond the scope of this specification. One possible
device implementation uses a UNIX domain socket to relay messages to a vhost-user
master process running on the same host.
<!--l. 5848--><p class="noindent" >Existing vhost-user slave programs that communicate over UNIX domain sockets can
support the virtio vhost-user device backend without invasive changes because the
pre-existing vhost-user wire protocol is used.
<a 
 id="x1-283001r272"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.1   </span> <a 
 id="x1-2840001"></a>Device ID</h4>
<!--l. 5853--><p class="nopar" >24
<a 
 id="x1-284001r286"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.2   </span> <a 
 id="x1-2850002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">rxq (device-to-driver vhost-user protocol messages)
    </dd><dt class="description">
<span 
class="aebx-10">1</span> </dt><dd 
class="description">txq (driver-to-device vhost-user protocol messages)</dd></dl>
<a 
 id="x1-285001r287"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.3   </span> <a 
 id="x1-2860003"></a>Feature bits</h4>
<!--l. 5864--><p class="nopar" >No feature bits are defined at this time.
<a 
 id="x1-286001r288"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.4   </span> <a 
 id="x1-2870004"></a>Device configuration layout</h4>
<!--l. 5868--><p class="nopar" >All fields of this configuration are always available.
<!--l. 5870-->
<div class="lstlisting" id="listing-63"><span class="label"><a 
 id="x1-287001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vhost_user_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-287002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-287003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VHOST_USER_STATUS_SLAVE_UP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-287004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VHOST_USER_STATUS_MASTER_UP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-287005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_vhost_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-287006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uuid</span><span 
class="pcrr8t-x-x-80">[16];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-287007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">status</span> </dt><dd 
class="description">contains the vhost-user operational status. The default value of this field
    is 0.
    <!--l. 5884--><p class="noindent" >The driver sets VIRTIO_VHOST_USER_STATUS_SLAVE_UP to indicate
    readiness  for  the  vhost-user  master  to  connect.  The  vhost-user  master
    cannot connect unless the driver has set this bit first.
    <!--l. 5888--><p class="noindent" >When  the  driver  clears  VIRTIO_VHOST_USER_SLAVE_UP  while  the
    vhost-user master is connected, the vhost-user master is disconnected.
                                                                  

                                                                  
    <!--l. 5891--><p class="noindent" >When                                    the                                    vhost-user
    master  disconnects,  both  VIRTIO_VHOST_USER_STATUS_SLAVE_UP
    and   VIRTIO_VHOST_USER_STATUS_MASTER_UP   are   cleared   by
    the  device.  Communication  can  be  restarted  by  the  driver  setting
    VIRTIO_VHOST_USER_STATUS_SLAVE_UP again.
    <!--l. 5896--><p class="noindent" >A configuration change notification is sent when the device changes this
    field unless a write to the field by the driver caused the change.
    </dd><dt class="description">
<span 
class="aebxti-10">max_vhost_queues</span> </dt><dd 
class="description">is the maximum number of vhost-user queues supported
    by this device. This field is always greater than 0.
    </dd><dt class="description">
<span 
class="aebxti-10">uuid</span> </dt><dd 
class="description">is the Universally Unique Identifier (UUID) for this device. If the device
    has no UUID then this field contains the nil UUID (all zeroes). The UUID
    allows vhost-user slave programs to identify a specific vhost-user device
    backend among many without relying on bus addresses.</dd></dl>
<a 
 id="x1-287008r284"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.4.1   </span> <a 
 id="x1-2880001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 5911--><p class="nopar" >The driver MUST NOT write to device configuration fields other than <span 
class="aeti-10">status</span>.
<!--l. 5914--><p class="noindent" >The driver MUST NOT set undefined bits in the <span 
class="aeti-10">status </span>configuration field.
<a 
 id="x1-288001r289"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.5   </span> <a 
 id="x1-2890005"></a>Device Requirements: Device Initialization</h4>
<!--l. 5918--><p class="nopar" >The driver SHOULD check the <span 
class="aeti-10">max_vhost_queues </span>configuration field to determine
how many queues the vhost-user slave will be able to support.
<!--l. 5921--><p class="noindent" >The driver SHOULD fetch the <span 
class="aeti-10">uuid </span>configuration field to allow vhost-user slave
programs to identify a specific device among many.
<!--l. 5924--><p class="noindent" >The driver SHOULD place at least one buffer in rxq before setting the
VIRTIO_VHOST_USER_SLAVE_UP bit in the <span 
class="aeti-10">status </span>configuration field.
<!--l. 5927--><p class="noindent" >The driver MUST handle rxq virtqueue notifications that occur before the
configuration change notification. It is possible that a vhost-user protocol message
from the vhost-user master arrives before the driver has seen the configuration
change notification for the VIRTIO_VHOST_USER_STATUS_MASTER_UP <span 
class="aeti-10">status</span>
change.
<a 
 id="x1-289001r291"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.6   </span> <a 
 id="x1-2900006"></a>Device Operation</h4>
<!--l. 5935--><p class="nopar" >Device operation consists of operating request queues and response queues.
<a 
 id="x1-290001r290"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.1   </span> <a 
 id="x1-2910001"></a>Device Operation: Request Queues</h5>
<!--l. 5939--><p class="nopar" >The driver receives vhost-user protocol messages from the vhost-user master on rxq.
The driver sends responses to the vhost-user master on txq.
<!--l. 5942--><p class="noindent" >The driver sends slave-initiated requests on txq. The driver receives responses from
the vhost-user master on rxq.
<!--l. 5945--><p class="noindent" >All virtqueues offer in-order guaranteed delivery semantics for vhost-user protocol
messages.
<!--l. 5948--><p class="noindent" >Each buffer is a vhost-user protocol message as defined by the <a 
href="#x1-3001r1">Vhost-user Protocol</a>.
In order to enable cross-endian communication, all message fields are little-endian
instead of the native byte order normally used by the protocol.
<!--l. 5953--><p class="noindent" >The appropriate size of rxq buffers is at least as large as the largest message defined
by the <a 
href="#x1-3001r1">Vhost-user Protocol</a> standard version that the driver supports. If the
vhost-user master sends a message that is too large for an rxq buffer then
DEVICE_NEEDS_RESET is set and the driver must reset the device.
<!--l. 5959--><p class="noindent" >File descriptor passing is handled differently by the vhost-user device backend. When
a message is received that carries one or more file descriptors according to the
vhost-user protocol, additional device resources become available to the
driver.
<a 
 id="x1-291001r292"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.7   </span> <a 
 id="x1-2920007"></a>Additional Device Resources over PCI</h4>
<!--l. 5966--><p class="nopar" >The vhost-user device backend contains additional device resources beyond
configuration space and virtqueues. The nature of these resources is transport-specific
and therefore only virtio transports that provide these resources support the
vhost-user device backend.
<!--l. 5971--><p class="noindent" >The following additional resources exist:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">Doorbells</span> </dt><dd 
class="description">The driver signals the vhost-user master through doorbells. The
    signal does not carry any data, it is purely an event.
    </dd><dt class="description">
<span 
class="aebx-10">Notifications</span> </dt><dd 
class="description">The  vhost-user  master  signals  the  driver  for  events  besides
    virtqueue activity and configuration changes by sending notifications.
    </dd><dt class="description">
<span 
class="aebx-10">Shared memory</span> </dt><dd 
class="description">The vhost-user master gives access to memory that can be
    mapped by the driver.</dd></dl>
<a 
 id="x1-292001r293"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.7.1   </span> <a 
 id="x1-2930001"></a>Doorbell Numbering</h5>
<!--l. 5980--><p class="nopar" >Doorbells are laid out as follows:
                                                                  

                                                                  
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">Vring call for vhost-user queue 0
    </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aebx-10">N</span> </dt><dd 
class="description">Vring err for vhost-user queue 0
    </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aebx-10">2N</span> </dt><dd 
class="description">Log</dd></dl>
<a 
 id="x1-293001r295"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.7.2   </span> <a 
 id="x1-2940002"></a>Notifications</h5>
<!--l. 5992--><p class="nopar" >Notifications are laid out as follows:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">Vring kick for vhost-user queue 0
    </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aebx-10">N-1</span> </dt><dd 
class="description">Vring kick for vhost-user queue N-1</dd></dl>
<a 
 id="x1-294001r296"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.7.3   </span> <a 
 id="x1-2950003"></a>Shared Memory Layout</h5>
<!--l. 6002--><p class="nopar" >Shared memory is laid out as follows:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">0</span> </dt><dd 
class="description">Vhost memory region 0
    </dd><dt class="description">
<span 
class="aebx-10">SIZE0</span> </dt><dd 
class="description">Vhost memory region 1
    </dd><dt class="description">
<span 
class="aebx-10">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aebx-10">SIZE0 + SIZE1 + </span><span 
class="aebx-10">…</span> </dt><dd 
class="description">Log</dd></dl>
<!--l. 6011--><p class="noindent" >The size of vhost memory region 0 is <span 
class="aeti-10">SIZE0</span>, the size of vhost memory region 1 is
<span 
class="aeti-10">SIZE1</span>, and so on.
<a 
 id="x1-295001r297"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.7.4   </span> <a 
 id="x1-2960004"></a>Availability of Additional Resources</h5>
<!--l. 6016--><p class="nopar" >The following vhost-user protocol messages convey access to additional device
                                                                  

                                                                  
resources:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VHOST_USER_SET_MEM_TABLE</span> </dt><dd 
class="description">Contents of vhost memory regions are
    available to the driver in shared memory. Region contents are laid out in
    the same order as the vhost memory region list.
    </dd><dt class="description">
<span 
class="aebx-10">VHOST_USER_SET_LOG_BASE</span> </dt><dd 
class="description">Contents of the log are available to the
    driver in shared memory.
    </dd><dt class="description">
<span 
class="aebx-10">VHOST_USER_SET_LOG_FD</span> </dt><dd 
class="description">The log doorbell is available to the driver.
    Writes to the log doorbell before this message is received produce no effect.
    </dd><dt class="description">
<span 
class="aebx-10">VHOST_USER_SET_VRING_KICK</span> </dt><dd 
class="description">The vring kick notification for this
    queue is available to the driver. The first notification may occur before the
    driver has processed this message.
    </dd><dt class="description">
<span 
class="aebx-10">VHOST_USER_SET_VRING_CALL</span> </dt><dd 
class="description">The vring call doorbell for this queue
    is  available  to  the  driver.  Writes  to  the  vring  call  doorbell  before  this
    message is received produce no effect.
    </dd><dt class="description">
<span 
class="aebx-10">VHOST_USER_SET_VRING_ERR</span> </dt><dd 
class="description">The vring err doorbell for this queue is
    available to the driver. Writes to the vring err doorbell before this message
    is received produce no effect.
    </dd><dt class="description">
<span 
class="aebx-10">VHOST_USER_SET_SLAVE_REQ_FD</span> </dt><dd 
class="description">The  driver  may  send  vhost-user
    protocol slave messages on txq. Buffers put onto txq before this message is
    received are discarded by the device.</dd></dl>
<!--l. 6029--><p class="noindent" >Additional resources are configured on the virtio PCI transport by the following
<span 
class="aeti-10">struct virtio_pci_cap.cfg_type </span>values:
<!--l. 6031-->
<div class="lstlisting" id="listing-64"><span class="label"><a 
 id="x1-296001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_DOORBELL_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-296002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_NOTIFICATION_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-296003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_SHARED_MEMORY_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span>
</div>
<a 
 id="x1-296004r298"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.7.5   </span> <a 
 id="x1-2970005"></a>Doorbell structure layout</h5>
<!--l. 6039--><p class="nopar" >The doorbell location is found using the VIRTIO_PCI_CAP_DOORBELL_CFG
capability. This capability is immediately followed by an additional field, like
so:
                                                                  

                                                                  
<!--l. 6043-->
<div class="lstlisting" id="listing-65"><span class="label"><a 
 id="x1-297001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_doorbell_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-297002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-297003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">doorbell_off_multiplier</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-297004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 6050--><p class="noindent" >The doorbell address within a BAR is calculated as follows:
<!--l. 6052-->
<div class="lstlisting" id="listing-66"><span class="label"><a 
 id="x1-297005r1"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">doorbell_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">doorbell_off_multiplier</span>
</div>
<!--l. 6056--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>and <span 
class="aeti-10">doorbell_off_multiplier </span>are taken from the notification capability
structure above, and the <span 
class="aeti-10">doorbell_idx </span>is the doorbell number.
<a 
 id="x1-297006r283"></a>
<h5 class="paragraphHead"><span class="titlemark">5.7.7.5.1</span> <a 
 id="x1-2980001"></a>Device Requirements: Doorbell capability</h5>
The device MUST present at least one doorbell capability.
<!--l. 6063--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 2-byte aligned.
<!--l. 6065--><p class="noindent" >The device MUST either present <span 
class="aeti-10">doorbell_off_multiplier </span>as an even power of 2, or
present <span 
class="aeti-10">doorbell_off_multiplier </span>as 0.
<!--l. 6068--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 2 and MUST be large
enough to support doorbell offsets for all supported doorbells in all possible
configurations.
<!--l. 6072--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy: <!--l. 6073-->
<div class="lstlisting" id="listing-67"><span class="label"><a 
 id="x1-298001r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">>=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_doorbells</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">doorbell_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 6077--><p class="noindent" >The number of doorbells is <span 
class="aeti-10">num_doorbells </span>and is dependent on the device.
<a 
 id="x1-298002r299"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.7.6   </span> <a 
 id="x1-2990006"></a>Notification structure layout</h5>
<!--l. 6082--><p class="nopar" >The notification structure allows MSI-X vectors to be configured for notification
interrupts. If MSI-X is not available, bit 2 of the ISR status indicates that a
notification occurred.
<!--l. 6086--><p class="noindent" >The notification structure is found using the VIRTIO_PCI_CAP_DOORBELL_CFG
capability.
<!--l. 6089-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-68"><span class="label"><a 
 id="x1-299001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_notification_cfg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-299002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notification_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-299003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notification_msix_vector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-299004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 6096--><p class="noindent" >The driver indicates which notification is of interest by writing the <span 
class="aeti-10">notification_select</span>
field. The driver then writes the MSI-X vector or <span 
class="aeti-10">VIRTIO_MSI_NO_VECTOR </span>to
<span 
class="aeti-10">notification_msix_vector </span>to change the MSI-X vector for that notification.
<a 
 id="x1-299005r301"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.7.7   </span> <a 
 id="x1-3000007"></a>Shared memory capability</h5>
<!--l. 6103--><p class="nopar" >The shared memory location is found using the VIRTIO_PCI_CAP_SHARED_MEMORY_CFG
capability.
<a 
 id="x1-300001r300"></a>
<h5 class="paragraphHead"><span class="titlemark">5.7.7.7.1</span> <a 
 id="x1-3010001"></a>Device Requirements: Shared Memory capability</h5>
The device MUST present exactly one shared memory capability.
<!--l. 6109--><p class="noindent" >The device MUST locate shared memory in a Memory Space BAR.
<!--l. 6111--><p class="noindent" >The device SHOULD locate shared memory in a Prefetchable BAR.
<!--l. 6113--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 4096-byte aligned.
<!--l. 6115--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be non-zero and 4096-byte
aligned.
                                                                  

                                                                  
<!--l. 6117--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">6</span> <a 
 id="x1-3020006"></a>Reserved Feature Bits</h2>
Currently these device-independent feature bits defined:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_F_RING_INDIRECT_DESC (28)</span> </dt><dd 
class="description">
    Negotiating this feature indicates that the driver can use descriptors with
    the VIRTQ_DESC_F_INDIRECT flag set, as described in <a 
href="#x1-330003">2.4.5.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a> <a 
href="#x1-330003">Indirect
    Descriptors<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_RING_EVENT_IDX(29)</span> </dt><dd 
class="description">This  feature  enables  the  <span 
class="aeti-10">used_event</span>
    and the <span 
class="aeti-10">avail_event </span>fields as described in <a 
href="#x1-370007">2.4.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Interrupt Suppression --></a> and <a 
href="#x1-400008">2.4.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_VERSION_1(32)</span> </dt><dd 
class="description">This
    indicates compliance with this specification, giving a simple way to detect
    legacy devices or drivers.
    </dd><dt class="description">
<span 
class="aebx-10">VIRTIO_F_IOMMU_PLATFORM(33)</span> </dt><dd 
class="description">This  feature  indicates  that  the
    device is behind an IOMMU that translates bus addresses from the device
    into physical addresses in memory. If this feature bit is set to 0, then
    the device emits physical addresses which are not translated further, even
    though an IOMMU may be present.</dd></dl>
<a 
 id="x1-302001r285"></a>
<h3 class="sectionHead"><span class="titlemark">6.1   </span> <a 
 id="x1-3030001"></a>Driver Requirements: Reserved Feature Bits</h3>
<!--l. 6141--><p class="nopar" >A driver MUST accept VIRTIO_F_VERSION_1 if it is offered. A driver MAY fail to
operate further if VIRTIO_F_VERSION_1 is not offered.
<!--l. 6144--><p class="noindent" >A driver SHOULD accept VIRTIO_F_IOMMU_PLATFORM if it is offered, and it
MUST then either disable the IOMMU or configure the IOMMU to translate
bus addresses passed to the device into physical addresses in memory. If
VIRTIO_F_IOMMU_PLATFORM is not offered, then a driver MUST pass only
physical addresses to the device.
<a 
 id="x1-303001r305"></a>
<h3 class="sectionHead"><span class="titlemark">6.2   </span> <a 
 id="x1-3040002"></a>Device Requirements: Reserved Feature Bits</h3>
<!--l. 6152--><p class="nopar" >A device MUST offer VIRTIO_F_VERSION_1. A device MAY fail to operate further
if VIRTIO_F_VERSION_1 is not accepted.
<!--l. 6155--><p class="noindent" >A device SHOULD offer VIRTIO_F_IOMMU_PLATFORM if it is behind an IOMMU
that translates bus addresses from the device into physical addresses in memory. A
device MAY fail to operate further if VIRTIO_F_IOMMU_PLATFORM is not
accepted.
<a 
 id="x1-304001r306"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">6.3   </span> <a 
 id="x1-3050003"></a>Legacy Interface: Reserved Feature Bits</h3>
<!--l. 6162--><p class="nopar" >Transitional devices MAY offer the following:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_F_NOTIFY_ON_EMPTY (24)</span> </dt><dd 
class="description">If this feature has been negotiated by
    driver, the device MUST issue an interrupt if the device runs out of
    available descriptors on a virtqueue, even though interrupts are suppressed
    using the VIRTQ_AVAIL_F_NO_INTERRUPT flag or the <span 
class="aeti-10">used_event</span>
    field.
    <span 
class="aebx-10">Note:</span> An example of a driver using this feature is the legacy networking
          driver: it doesn’t need to know every time a packet is transmitted,
          but it does need to free the transmitted packets a finite time after
          they  are  transmitted.  It  can  avoid  using  a  timer  if  the  device
          interrupts it when all the packets are transmitted.
    </dd></dl>
<!--l. 6180--><p class="noindent" >Transitional devices MUST offer, and if offered by the device transitional drivers
MUST accept the following:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">VIRTIO_F_ANY_LAYOUT (27)</span> </dt><dd 
class="description">This  feature  indicates  that  the  device
    accepts arbitrary descriptor layouts, as described in Section <a 
href="#x1-290003">2.4.4.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a> <a 
href="#x1-290003">Legacy
    Interface: Message Framing<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a>.
    </dd><dt class="description">
<span 
class="aebx-10">UNUSED (30)</span> </dt><dd 
class="description">Bit  30  is  used  by  qemu’s  implementation  to  check  for
    experimental early versions of virtio which did not perform correct feature
    negotiation, and SHOULD NOT be negotiated.</dd></dl>
                                                                  

                                                                  
<!--l. 4--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">7</span> <a 
 id="x1-3060007"></a>Conformance</h2>
This chapter lists the conformance targets and clauses for each; this also forms a
useful checklist which authors are asked to consult for their implementations!
<a 
 id="x1-306001r307"></a>
<h3 class="sectionHead"><span class="titlemark">7.1   </span> <a 
 id="x1-3070001"></a>Conformance Targets</h3>
<!--l. 12--><p class="nopar" >Conformance targets:
    <dl class="description"><dt class="description">
<span 
class="aebx-10">Driver</span> </dt><dd 
class="description">A driver MUST conform to three conformance clauses:
        <ul class="itemize1">
        <li class="itemize">Clause <a 
href="#x1-3080002">7.2<!--tex4ht:ref: sec:Conformance / Driver Conformance --></a>,
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-3090001">7.2.1<!--tex4ht:ref: sec:Conformance / Driver Conformance / PCI Driver Conformance --></a>, <a 
href="#x1-3100002">7.2.2<!--tex4ht:ref: sec:Conformance / Driver Conformance / MMIO Driver Conformance --></a> or <a 
href="#x1-3110003">7.2.3<!--tex4ht:ref: sec:Conformance / Driver Conformance / Channel I/O Driver Conformance --></a>.
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-3120004">7.2.4<!--tex4ht:ref: sec:Conformance / Driver Conformance / Network Driver Conformance --></a>, <a 
href="#x1-3130005">7.2.5<!--tex4ht:ref: sec:Conformance / Driver Conformance / Block Driver Conformance --></a>, <a 
href="#x1-3140006">7.2.6<!--tex4ht:ref: sec:Conformance / Driver Conformance / Console Driver Conformance --></a>, <a 
href="#x1-3150007">7.2.7<!--tex4ht:ref: sec:Conformance / Driver Conformance / Entropy Driver Conformance --></a>, <a 
href="#x1-3160008">7.2.8<!--tex4ht:ref: sec:Conformance / Driver Conformance / Traditional Memory Balloon Driver Conformance --></a> or <a 
href="#x1-3170009">7.2.9<!--tex4ht:ref: sec:Conformance / Driver Conformance / SCSI Host Driver Conformance --></a>.</li></ul>
    </dd><dt class="description">
<span 
class="aebx-10">Device</span> </dt><dd 
class="description">A device MUST conform to three conformance clauses:
        <ul class="itemize1">
        <li class="itemize">Clause <a 
href="#x1-3180003">7.3<!--tex4ht:ref: sec:Conformance / Device Conformance --></a>,
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-3190001">7.3.1<!--tex4ht:ref: sec:Conformance / Device Conformance / PCI Device Conformance --></a>, <a 
href="#x1-3200002">7.3.2<!--tex4ht:ref: sec:Conformance / Device Conformance / MMIO Device Conformance --></a> or <a 
href="#x1-3210003">7.3.3<!--tex4ht:ref: sec:Conformance / Device Conformance / Channel I/O Device Conformance --></a>.
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-3220004">7.3.4<!--tex4ht:ref: sec:Conformance / Device Conformance / Network Device Conformance --></a>, <a 
href="#x1-3230005">7.3.5<!--tex4ht:ref: sec:Conformance / Device Conformance / Block Device Conformance --></a>, <a 
href="#x1-3240006">7.3.6<!--tex4ht:ref: sec:Conformance / Device Conformance / Console Device Conformance --></a>, <a 
href="#x1-3250007">7.3.7<!--tex4ht:ref: sec:Conformance / Device Conformance / Entropy Device Conformance --></a>, <a 
href="#x1-3260008">7.3.8<!--tex4ht:ref: sec:Conformance / Device Conformance / Traditional Memory Balloon Device Conformance --></a> or <a 
href="#x1-3270009">7.3.9<!--tex4ht:ref: sec:Conformance / Device Conformance / SCSI Host Device Conformance --></a>.</li></ul>
    </dd></dl>
<a 
 id="x1-307001r309"></a>
<h3 class="sectionHead"><span class="titlemark">7.2   </span> <a 
 id="x1-3080002"></a>Driver Conformance</h3>
<!--l. 30--><p class="nopar" >A driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-110001">2.1.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Device Status Field --></a>
    </li>
    <li class="itemize"><a 
href="#x1-140001">2.2.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Feature Bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-180001">2.3.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Device Configuration Space --></a>
    </li>
    <li class="itemize"><a 
href="#x1-230001">2.4.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-280002">2.4.4.2<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Message Framing --></a>
    </li>
    <li class="itemize"><a 
href="#x1-320002">2.4.5.2<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>
    </li>
    <li class="itemize"><a 
href="#x1-340001">2.4.5.3.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a>
    </li>
    <li class="itemize"><a 
href="#x1-380001">2.4.7.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Interrupt Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-430003">2.4.8.3<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>
    </li>
    <li class="itemize"><a 
href="#x1-450001">2.4.9.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-500001">3.1.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-570001">3.2.1.3.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Operation / Supplying Buffers to The Device / Updating idx --></a>
    </li>
    <li class="itemize"><a 
href="#x1-590001">3.2.1.4.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Operation / Supplying Buffers to The Device / Notifying The Device --></a>
    </li>
    <li class="itemize"><a 
href="#x1-630001">3.3.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Cleanup --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3030001">6.1<!--tex4ht:ref: drivernormative:Reserved Feature Bits --></a></li></ul>
<a 
 id="x1-308001r294"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.1   </span> <a 
 id="x1-3090001"></a>PCI Driver Conformance</h4>
<!--l. 52--><p class="nopar" >A PCI driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-690002">4.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>
    </li>
    <li class="itemize"><a 
href="#x1-720001">4.1.3.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-750001">4.1.4.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
    </li>
    <li class="itemize"><a 
href="#x1-790002">4.1.4.3.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Common configuration structure layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-840002">4.1.4.5.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / ISR status capability --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-890002">4.1.4.7.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-990002">4.1.5.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / MSI-X Vector Configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1070002">4.1.5.4.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a></li></ul>
<a 
 id="x1-309001r311"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.2   </span> <a 
 id="x1-3100002"></a>MMIO Driver Conformance</h4>
<!--l. 67--><p class="nopar" >An MMIO driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1130002">4.2.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1160001">4.2.3.1.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1200001">4.2.3.4.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Notifications From The Device --></a></li></ul>
<a 
 id="x1-310001r312"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.3   </span> <a 
 id="x1-3110003"></a>Channel I/O Driver Conformance</h4>
<!--l. 77--><p class="nopar" >A Channel I/O driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1250002">4.3.1.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Basic Concepts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1290002">4.3.2.1.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1350001">4.3.2.3.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Communicating Status Information --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1500002">4.3.3.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Adapter I/O Interrupts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1540002">4.3.3.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Guest->Host Notification --></a></li></ul>
<a 
 id="x1-311001r313"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.4   </span> <a 
 id="x1-3120004"></a>Network Driver Conformance</h4>
<!--l. 89--><p class="nopar" >A network driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1650002">5.1.4.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1710001">5.1.6.2.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Packet Transmission --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-1750001">5.1.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1790002">5.1.6.4.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1830002">5.1.6.5.1.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Packet Receive Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1860002">5.1.6.5.2.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1910001">5.1.6.5.4.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Gratuitous Packet Sending --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1940001">5.1.6.5.5.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1990002">5.1.6.5.6.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Offloads State Configuration / Setting Offloads State --></a></li></ul>
<a 
 id="x1-312001r314"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.5   </span> <a 
 id="x1-3130005"></a>Block Driver Conformance</h4>
<!--l. 105--><p class="nopar" >A block driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2100001">5.2.5.1<!--tex4ht:ref: drivernormative:Device Types / Block Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2140001">5.2.6.1<!--tex4ht:ref: drivernormative:Device Types / Block Device / Device Operation --></a></li></ul>
<a 
 id="x1-313001r315"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.6   </span> <a 
 id="x1-3140006"></a>Console Driver Conformance</h4>
<!--l. 114--><p class="nopar" >A console driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2270001">5.3.6.1<!--tex4ht:ref: drivernormative:Device Types / Console Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2300002">5.3.6.2.2<!--tex4ht:ref: drivernormative:Device Types / Console Device / Device Operation / Multiport Device Operation --></a></li></ul>
<a 
 id="x1-314001r316"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.7   </span> <a 
 id="x1-3150007"></a>Entropy Driver Conformance</h4>
<!--l. 123--><p class="nopar" >An entropy driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2400001">5.4.6.1<!--tex4ht:ref: drivernormative:Device Types / Entropy Device / Device Operation --></a></li></ul>
<a 
 id="x1-315001r317"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.2.8   </span> <a 
 id="x1-3160008"></a>Traditional Memory Balloon Driver Conformance</h4>
<!--l. 131--><p class="nopar" >A traditional memory balloon driver MUST conform to the following normative
statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2460001">5.5.3.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Feature bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2530001">5.5.6.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2570001">5.5.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation / Memory Statistics --></a></li></ul>
<a 
 id="x1-316001r318"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.9   </span> <a 
 id="x1-3170009"></a>SCSI Host Driver Conformance</h4>
<!--l. 141--><p class="nopar" >An SCSI host driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2660001">5.6.4.1<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2740002">5.6.6.1.2<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2790001">5.6.6.3.1<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq --></a></li></ul>
<a 
 id="x1-317001r310"></a>
<h3 class="sectionHead"><span class="titlemark">7.3   </span> <a 
 id="x1-3180003"></a>Device Conformance</h3>
<!--l. 151--><p class="nopar" >A device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-120002">2.1.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Device Status Field --></a>
    </li>
    <li class="itemize"><a 
href="#x1-150002">2.2.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Feature Bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-190002">2.3.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Device Configuration Space --></a>
    </li>
    <li class="itemize"><a 
href="#x1-270001">2.4.4.1<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Message Framing --></a>
    </li>
    <li class="itemize"><a 
href="#x1-310001">2.4.5.1<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>
    </li>
    <li class="itemize"><a 
href="#x1-350002">2.4.5.3.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a>
    </li>
    <li class="itemize"><a 
href="#x1-390002">2.4.7.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Interrupt Suppression --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-420002">2.4.8.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>
    </li>
    <li class="itemize"><a 
href="#x1-460002">2.4.9.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3040002">6.2<!--tex4ht:ref: devicenormative:Reserved Feature Bits --></a></li></ul>
<a 
 id="x1-318001r319"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.1   </span> <a 
 id="x1-3190001"></a>PCI Device Conformance</h4>
<!--l. 168--><p class="nopar" >A PCI device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-660001">4.1.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus --></a>
    </li>
    <li class="itemize"><a 
href="#x1-680001">4.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>
    </li>
    <li class="itemize"><a 
href="#x1-730002">4.1.3.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-760002">4.1.4.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
    </li>
    <li class="itemize"><a 
href="#x1-780001">4.1.4.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Common configuration structure layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-810001">4.1.4.4.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-830001">4.1.4.5.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / ISR status capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-860001">4.1.4.6.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Device-specific configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-880001">4.1.4.7.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-920001">4.1.4.9.0.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Non-transitional Device With Legacy Driver --></a>
    </li>
    <li class="itemize"><a 
href="#x1-980001">4.1.5.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / MSI-X Vector Configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1040001">4.1.5.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Virtqueue Interrupts From The Device --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1060001">4.1.5.4.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a></li></ul>
<a 
 id="x1-319001r321"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.3.2   </span> <a 
 id="x1-3200002"></a>MMIO Device Conformance</h4>
<!--l. 188--><p class="nopar" >An MMIO device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1120001">4.2.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over MMIO / MMIO Device Register Layout --></a></li></ul>
<a 
 id="x1-320001r322"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.3   </span> <a 
 id="x1-3210003"></a>Channel I/O Device Conformance</h4>
<!--l. 196--><p class="nopar" >A Channel I/O device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1240001">4.3.1.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Basic Concepts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1280001">4.3.2.1.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1320001">4.3.2.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Configuring a Virtqueue --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1360002">4.3.2.3.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Communicating Status Information --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1430001">4.3.2.6.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Two-Stage Queue Indicators --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1490001">4.3.3.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Adapter I/O Interrupts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1530001">4.3.3.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Guest->Host Notification --></a></li></ul>
<a 
 id="x1-321001r323"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.4   </span> <a 
 id="x1-3220004"></a>Network Device Conformance</h4>
<!--l. 210--><p class="nopar" >A network device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1640001">5.1.4.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1720002">5.1.6.2.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Packet Transmission --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1760002">5.1.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1780001">5.1.6.4.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1820001">5.1.6.5.1.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Packet Receive Filtering --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-1850001">5.1.6.5.2.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1920002">5.1.6.5.4.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Gratuitous Packet Sending --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1950002">5.1.6.5.5.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode --></a></li></ul>
<a 
 id="x1-322001r324"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.5   </span> <a 
 id="x1-3230005"></a>Block Device Conformance</h4>
<!--l. 225--><p class="nopar" >A block device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2110002">5.2.5.2<!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2150002">5.2.6.2<!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Operation --></a></li></ul>
<a 
 id="x1-323001r325"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.6   </span> <a 
 id="x1-3240006"></a>Console Device Conformance</h4>
<!--l. 234--><p class="nopar" >A console device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2250001">5.3.5.1<!--tex4ht:ref: devicenormative:Device Types / Console Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2290001">5.3.6.2.1<!--tex4ht:ref: devicenormative:Device Types / Console Device / Device Operation / Multiport Device Operation --></a></li></ul>
<a 
 id="x1-324001r326"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.7   </span> <a 
 id="x1-3250007"></a>Entropy Device Conformance</h4>
<!--l. 243--><p class="nopar" >An entropy device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2410002">5.4.6.2<!--tex4ht:ref: devicenormative:Device Types / Entropy Device / Device Operation --></a></li></ul>
<a 
 id="x1-325001r327"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.8   </span> <a 
 id="x1-3260008"></a>Traditional Memory Balloon Device Conformance</h4>
<!--l. 251--><p class="nopar" >A traditional memory balloon device MUST conform to the following normative
statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2470002">5.5.3.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Feature bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2540002">5.5.6.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-2580002">5.5.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation / Memory Statistics --></a></li></ul>
<a 
 id="x1-326001r328"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.9   </span> <a 
 id="x1-3270009"></a>SCSI Host Device Conformance</h4>
<!--l. 261--><p class="nopar" >An SCSI host device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2670002">5.6.4.2<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2690005">5.6.5<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2730001">5.6.6.1.1<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2800002">5.6.6.3.2<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq --></a></li></ul>
<a 
 id="x1-327001r320"></a>
<h3 class="sectionHead"><span class="titlemark">7.4   </span> <a 
 id="x1-3280004"></a>Legacy Interface: Transitional Device and Transitional Driver Conformance</h3>
<!--l. 274--><p class="nopar" >A conformant implementation MUST be either transitional or non-transitional, see
<a 
href="#x1-60001">1.3.1<!--tex4ht:ref: intro:Legacy Interface: Terminology --></a>.
<!--l. 278--><p class="noindent" >A non-transitional implementation conforms to this specification if it satisfies all of
the MUST or REQUIRED level requirements defined above.
<!--l. 282--><p class="noindent" >An implementation MAY choose to implement OPTIONAL support for the legacy
interface, including support for legacy drivers or devices, by additionally conforming
to all of the MUST or REQUIRED level requirements for the legacy interface for the
transitional devices and drivers.
<!--l. 288--><p class="noindent" >The requirements for the legacy interface for transitional implementations are located
in sections named “Legacy Interface” listed below:
    <ul class="itemize1">
    <li class="itemize">Section <a 
href="#x1-160003">2.2.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits / Legacy Interface: A Note on Feature Bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-200003">2.3.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: A Note on Configuration Space endian-ness --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-210004">2.3.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-240002">2.4.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-250003">2.4.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Endianness --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize">Section <a 
href="#x1-290003">2.4.4.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-510002">3.1.2<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization / Legacy Interface: Device Initialization --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-700003">4.1.2.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery / Legacy Interfaces: A Note on PCI Device Discovery --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-900008">4.1.4.8<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Legacy Interfaces: A Note on PCI Device Layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-960001">4.1.5.1.1.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Virtio Device Configuration Layout Detection / Legacy Interface: A Note on Device Layout Detection --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1010001">4.1.5.1.3.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Virtqueue Configuration / Legacy Interface: A Note on Virtqueue Configuration --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1210004">4.2.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1300003">4.3.2.1.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision / Legacy Interfaces: A Note on Setting the Virtio Revision --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1330002">4.3.2.2.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Configuring a Virtqueue / Legacy Interface: A Note on Configuring a Virtqueue --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1510003">4.3.3.1.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Legacy Interfaces: A Note on Host->Guest Notification --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1440004">4.3.2.6.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Legacy Interfaces: A Note on Setting Up Indicators --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1620002">5.1.3.2<!--tex4ht:ref: sec:Device Types / Network Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1660003">5.1.4.3<!--tex4ht:ref: sec:Device Types / Network Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1690001">5.1.6.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1870003">5.1.6.5.2.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering / Legacy Interface: Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1890001">5.1.6.5.3.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / VLAN Filtering / Legacy Interface: VLAN Filtering --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1960003">5.1.6.5.5.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode / Legacy Interface: Automatic receive steering in multiqueue mode --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2000003">5.1.6.5.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Offloads State Configuration / Setting Offloads State / Legacy Interface: Setting Offloads State --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize">Section <a 
href="#x1-2060001">5.2.3.1<!--tex4ht:ref: sec:Device Types / Block Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2080001">5.2.4.1<!--tex4ht:ref: sec:Device Types / Block Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2120003">5.2.5.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Initialization / Legacy Interface: Device Initialization --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2160003">5.2.6.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2230001">5.3.4.1<!--tex4ht:ref: sec:Device Types / Console Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2310003">5.3.6.3<!--tex4ht:ref: sec:Device Types / Console Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2480001">5.5.3.2.0.1<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2550001">5.5.6.2.1<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2590003">5.5.6.3.3<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Device Operation / Memory Statistics / Legacy Interface: Memory Statistics --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2680003">5.6.4.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2710001">5.6.6.0.1<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2750003">5.6.6.1.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues / Legacy Interface: Device Operation: Request Queues --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2770001">5.6.6.2.1<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: controlq / Legacy Interface: Device Operation: controlq --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2810003">5.6.6.3.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq / Legacy Interface: Device Operation: eventq --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3050003">6.3<!--tex4ht:ref: sec:Reserved Feature Bits / Legacy Interface: Reserved Feature Bits --></a></li></ul>
                                                                  

                                                                  
<a 
 id="x1-328001r308"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix A</span>. <a 
 id="x1-329000A"></a>virtio_queue.h</h2>
This file is also available at the link <a 
href="http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/listings/virtio_queue.h" class="url" >http://docs.oasis-open.org/virtio/virtio/v1.0/cs04/listings/virtio_queue.h</a>.
All definitions in this section are for non-normative reference only.
<!--l. 8--><div class="lstinputlisting">
<a 
 id="x1-329001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329002r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">ifndef</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329003r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329004r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">An</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interface</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">efficient</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">implementation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329006r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BSD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">licensed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">anyone</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">can</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">use</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">definitions</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329007r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">implement</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compatible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">drivers</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">servers</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329008r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329009r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Copyright</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2007,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2009,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Corporation</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329010r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Copyright</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2011,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Red</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Inc</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329011r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">All</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rights</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329012r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329013r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistribution</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">use</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">binary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">forms</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">without</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329014r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">modification</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">permitted</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">provided</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329015r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">met</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329016r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistributions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">code</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">retain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">copyright</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329017r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notice</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disclaimer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329018r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistributions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">binary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">form</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reproduce</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">copyright</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329019r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notice</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disclaimer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329020r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">documentation</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">other</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">materials</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">provided</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">distribution</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329021r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Neither</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">name</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">names</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">its</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contributors</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329022r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">may</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endorse</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">promote</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">products</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">derived</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">software</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329023r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">without</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">prior</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">permission</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329024r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THIS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SOFTWARE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROVIDED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">COPYRIGHT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">HOLDERS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRIBUTORS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">‘‘</span><span 
class="pcrr8t-x-x-80">AS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IS</span><span 
class="pcrr8t-x-x-80">’’</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329025r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXPRESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IMPLIED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WARRANTIES</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIMITED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329026r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IMPLIED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WARRANTIES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">MERCHANTABILITY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FITNESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PARTICULAR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PURPOSE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329027r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ARE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DISCLAIMED</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EVENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SHALL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRIBUTORS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABLE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329028r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DIRECT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INDIRECT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INCIDENTAL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SPECIAL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXEMPLARY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONSEQUENTIAL</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329029r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DAMAGES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIMITED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROCUREMENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SUBSTITUTE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GOODS</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329030r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SERVICES</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LOSS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">USE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DATA</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROFITS</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUSINESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INTERRUPTION</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329031r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">HOWEVER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CAUSED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ON</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THEORY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABILITY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WHETHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRACT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">STRICT</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329032r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABILITY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TORT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NEGLIGENCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OTHERWISE</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ARISING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WAY</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329033r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">USE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THIS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SOFTWARE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EVEN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ADVISED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">POSSIBILITY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329034r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SUCH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DAMAGE</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329035r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329036r35"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">include</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><</span><span 
class="pcrr8t-x-x-80">stdint</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">h</span><span 
class="pcrr8t-x-x-80">></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329037r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329038r37"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">continuing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329039r38"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329040r39"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">otherwise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329041r40"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329042r41"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">means</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contains</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329043r42"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_INDIRECT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329044r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329045r44"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">advise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">don</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">kick</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">me</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329046r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">when</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">you</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">add</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">It</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unreliable</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">simply</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329047r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimization</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329048r47"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_USED_F_NO_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329049r48"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">advise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">don</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329050r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">me</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">when</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">you</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">consume</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">It</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unreliable</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329051r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">simply</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimization</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329052r51"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_AVAIL_F_NO_INTERRUPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329053r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329054r53"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Support</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indirect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329055r54"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_INDIRECT_DESC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">28</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329056r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329057r56"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Support</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329058r57"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">29</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329059r58"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329060r59"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Arbitrary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">layouts</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329061r60"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_ANY_LAYOUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">27</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329062r61"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329063r62"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Virtqueue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329064r63"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">These</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">can</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">together</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">".</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329065r64"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329066r65"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329067r66"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329068r67"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329069r68"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329070r69"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329071r70"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329072r71"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">We</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unused</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">too</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329073r72"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329074r73"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329075r74"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329076r75"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329077r76"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329078r77"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329079r78"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329080r79"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329081r80"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329082r81"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329083r82"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">here</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reasons</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329084r83"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329085r84"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329086r85"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329087r86"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Total</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">was</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329088r87"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329089r88"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329090r89"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329091r90"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329092r91"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329093r92"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329094r93"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329095r94"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329096r95"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329097r96"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329098r97"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329099r98"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329100r99"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329101r100"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329102r101"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329103r102"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329104r103"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329105r104"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329106r105"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_need_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_idx</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">old_idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329107r106"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329108r107"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"><</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">old_idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329109r108"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329110r109"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329111r110"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Get</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">location</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indices</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329112r111"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">virtq_used_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329113r112"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329114r113"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">backwards</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329115r114"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329116r115"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329117r116"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329118r117"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">virtq_avail_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329119r118"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329120r119"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">backwards</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329121r120"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*)</span><span 
class="pcrr8t-x-x-80">&</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-></span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329122r121"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-329123r122"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">endif</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span>
</div>
                                                                  

                                                                  
<a 
 id="x1-329124r308"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix B</span>. <a 
 id="x1-330000B"></a>Creating New Device Types</h2>
Various considerations are necessary when creating a new device type.
<a 
 id="x1-330001r330"></a>
<h3 class="sectionHead"><span class="titlemark">B.1   </span> <a 
 id="x1-3310001"></a>How Many Virtqueues?</h3>
<!--l. 8--><p class="nopar" >It is possible that a very simple device will operate entirely through its device
configuration space, but most will need at least one virtqueue in which it
will place requests. A device with both input and output (eg. console and
network devices described here) need two queues: one which the driver fills with
buffers to receive input, and one which the driver places buffers to transmit
output.
<a 
 id="x1-331001r334"></a>
<h3 class="sectionHead"><span class="titlemark">B.2   </span> <a 
 id="x1-3320002"></a>What Device Configuration Space Layout?</h3>
<!--l. 18--><p class="nopar" >Device configuration space should only be used for initialization-time parameters. It
is a limited resource with no synchronization between field written by the driver, so
for most uses it is better to use a virtqueue to update configuration information (the
network device does this for filtering, otherwise the table in the config space could
potentially be very large).
<!--l. 25--><p class="noindent" >Remember that configuration fields over 32 bits wide might not be atomically
writable by the driver. Therefore, no writeable field which triggers an action ought to
be wider than 32 bits.
<a 
 id="x1-332001r335"></a>
<h3 class="sectionHead"><span class="titlemark">B.3   </span> <a 
 id="x1-3330003"></a>What Device Number?</h3>
<!--l. 31--><p class="nopar" >Device numbers can be reserved by the OASIS committee: email
virtio-dev@lists.oasis-open.org to secure a unique one.
<!--l. 34--><p class="noindent" >Meanwhile for experimental drivers, use 65535 and work backwards.
<a 
 id="x1-333001r336"></a>
<h3 class="sectionHead"><span class="titlemark">B.4   </span> <a 
 id="x1-3340004"></a>How many MSI-X vectors? (for PCI)</h3>
<!--l. 38--><p class="nopar" >Using the optional MSI-X capability devices can speed up interrupt processing by
removing the need to read ISR Status register by guest driver (which might be an
expensive operation), reducing interrupt sharing between devices and queues within
the device, and handling interrupts from multiple CPUs. However, some systems
impose a limit (which might be as low as 256) on the total number of MSI-X vectors
that can be allocated to all devices. Devices and/or drivers should take this into
account, limiting the number of vectors used unless the device is expected
to cause a high volume of interrupts. Devices can control the number of
                                                                  

                                                                  
vectors used by limiting the MSI-X Table Size or not presenting MSI-X
capability in PCI configuration space. Drivers can control this by mapping events
to as small number of vectors as possible, or disabling MSI-X capability
altogether.
<a 
 id="x1-334001r337"></a>
<h3 class="sectionHead"><span class="titlemark">B.5   </span> <a 
 id="x1-3350005"></a>Device Improvements</h3>
<!--l. 56--><p class="nopar" >Any change to device configuration space, or new virtqueues, or behavioural changes,
should be indicated by negotiation of a new feature bit. This establishes
clarity<span class="footnote-mark"><a 
href="#fn18x9" id="fn18x9-bk"><sup class="textsuperscript">18</sup></a></span><a 
 id="x1-335001f18"></a>
and avoids future expansion problems.
<!--l. 62--><p class="noindent" >Clusters of functionality which are always implemented together can use a single bit,
but if one feature makes sense without the others they should not be gratuitously
grouped together to conserve feature bits.
                                                                  

                                                                  
<a 
 id="x1-335002r308"></a>
<!--l. 4--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix C</span>. <a 
 id="x1-336000C"></a>Acknowledgements</h2>
The following individuals have participated in the creation of this specification and
are gratefully acknowledged:
<!--l. 8--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Participants: </span></div> <div style="margin-left: 20px;">  Amit Shah, Red Hat <br 
class="newline" />Amos Kong, Red Hat <br 
class="newline" />Anthony Liguori, IBM <br 
class="newline" />Bruce Rogers, Novell <br 
class="newline" />Bryan Venteicher, NetApp <br 
class="newline" />Cornelia Huck, Red Hat <br 
class="newline" />Daniel Kiper, Oracle <br 
class="newline" />Geoff Brown, Machine-to-Machine Intelligence (M2MI) Corporation <br 
class="newline" />Gershon Janssen, Individual Member <br 
class="newline" />James Bottomley, Parallels IP Holdings GmbH <br 
class="newline" />Luiz Capitulino, Red Hat <br 
class="newline" />Michael S. Tsirkin, Red Hat <br 
class="newline" />Paolo Bonzini, Red Hat <br 
class="newline" />Pawel Moll, ARM <br 
class="newline" />Richard Sohn, Alcatel-Lucent <br 
class="newline" />Rusty Russell, IBM <br 
class="newline" />Sasha Levin, Oracle <br 
class="newline" />Sergey Tverdyshev, Thales e-Security <br 
class="newline" />Stefan Hajnoczi, Red Hat <br 
class="newline" />Tom Lyon, Samya Systems, Inc. <br 
class="newline" /> </div>
<!--l. 31--><p class="noindent" >The following non-members have provided valuable feedback on this specification and
are gratefully acknowledged:
<!--l. 34--><p class="noindent" ><div style="color: #552681; font-size: 10pt;"> <span 
class="aebx-10">Reviewers: </span></div> <div style="margin-left: 20px;">  Andrew Thornton, Google <br 
class="newline" />Arun Subbarao, LynuxWorks <br 
class="newline" />Brian Foley, ARM <br 
class="newline" />David Alan Gilbert, Red Hat <br 
class="newline" />Fam Zheng, Red Hat <br 
class="newline" />Gerd Hoffmann, Red Hat <br 
class="newline" />Jason Wang, Red Hat <br 
class="newline" />Laura Novich, Red Hat <br 
class="newline" />Patrick Durusau, Technical Advisory Board, OASIS <br 
class="newline" />Thomas Huth, Red Hat <br 
class="newline" />Yan Vugenfirer, Red Hat / Daynix <br 
class="newline" />Kevin Lo, MSI <br 
class="newline" /> </div>
                                                                  

                                                                  
<a 
 id="x1-336001r308"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix D</span>. <a 
 id="x1-337000D"></a>Revision History</h2>
The following changes have been made since the previous version of this
specification:
<a 
 id="x1-337001r1"></a><!--l. 8--><div class="longtable"> <table id="TBL-19" class="longtable" 
cellspacing="0" cellpadding="0" rules="groups" 
><colgroup id="TBL-19-1g"><col 
id="TBL-19-1"></colgroup><colgroup id="TBL-19-2g"><col 
id="TBL-19-2"></colgroup><colgroup id="TBL-19-3g"><col 
id="TBL-19-3"></colgroup><colgroup id="TBL-19-4g"><col 
id="TBL-19-4"></colgroup>
                                                                  

                                                                  
<tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-1-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-1-1"  
class="td11"> <span 
class="aebx-10">Revision  </span></td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-1-2"  
class="td11"> <span 
class="aebx-10">Date  </span></td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-1-3"  
class="td11"> <span 
class="aebx-10">Editor  </span></td><td  style="white-space:wrap; text-align:left;" id="TBL-19-1-4"  
class="td11">
 <!--l. 8--><p class="noindent" ><span 
class="aebx-10">Changes Made</span>                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-2-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-2-1"  
class="td11">         </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-19-3-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-3-1"  
class="td11">          </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-3-2"  
class="td11">       </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-3-3"  
class="td11">        </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-3-4"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-19-4-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-4-1"  
class="td11"> 540  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-4-2"  
class="td11"> 11 Oct 2015  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-4-3"  
class="td11">    Greg Kurz       </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-4-4"  
class="td11">
 <!--l. 1--><p class="noindent" >virtqueues: fix trivial typo
  <!--l. 4--><p class="noindent" >See <a 
href="#x1-370007">2.4.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Interrupt Suppression --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-5-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-5-1"  
class="td11"> 541  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-5-2"  
class="td11"> 11 Oct 2015  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-5-3"  
class="td11">   Paolo Bonzini     </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-5-4"  
class="td11">
 <!--l. 8--><p class="noindent" >virtio-blk:  fix  typo  in  legacy
  framing requirements section
  <!--l. 11--><p class="noindent" >See <a 
href="#x1-2170004">5.2.6.4<!--tex4ht:ref: sec:Device Types / Block Device / Legacy Interface: Framing Requirements --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-6-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-6-1"  
class="td11"> 545  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-6-2"  
class="td11"> 18 Oct 2015  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-6-3"  
class="td11">   Paolo Bonzini     </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-6-4"  
class="td11">
 <!--l. 15--><p class="noindent" >virtio-blk:                    restore
  VIRTIO_BLK_F_FLUSH    and
  VIRTIO_BLK_F_CONFIG_WCE
  <!--l. 17--><p class="noindent" >VIRTIO_BLK_F_CONFIG_WCE
  is important in order to achieve
  good    performance    (up    to
  2x,  though  more  realistically
  +30-40%)    in    latency-bound
  workloads.   However,   it   was
  removed  by  mistake  together
  with VIRTIO_BLK_F_FLUSH.
  <!--l. 21--><p class="noindent" >In   addition,   even   removing
  VIRTIO_BLK_F_FLUSH
  was probably not a great idea,
  because   it   simplifies   simple
  drivers (e.g. firmware) that are
  okay with a writethrough cache
  but  still  need  data  to  persist
  after  power  loss.  What  really
  should  have  been  removed  is
  just the possibility that devices
  not                           propose
  VIRTIO_BLK_F_FLUSH,
  but  even  that  only  deserves  a
  "SHOULD" in the new world of
  conformance statements.
  <!--l. 28--><p class="noindent" >Restore     these,     with     the
  following changes:
  <!--l. 30--><p class="noindent" >*  clarify  and  use  conformance
  statements
  in order to define writeback and
  writethrough caching according
  to  what  is  commonly  done  by
  high-end storage.
  <!--l. 34--><p class="noindent" >*   clarify   (with   conformance
  statements)   the   influence   of
  the    VIRTIO_BLK_F_FLUSH
  feature  on  caching  and  how
  to   proceed   if   only   one   of
  VIRTIO_BLK_F_FLUSH    and
  VIRTIO_BLK_F_CONFIG_WCE
  is negotiated.
  <!--l. 38--><p class="noindent" >*
  strengthen the requirement for
  persisting writes to MUST after
  a       VIRTIO_BLK_T_FLUSH
  request (and in other cases too
  involving the new features).
  <!--l. 42--><p class="noindent" >The  suggested  behavior  upon
  feature  negotiation  is  okay  for
  the  Linux  implementation  of
  virtio1,          even          after
  the implementation is modified
  to support the two new features.
  <!--l. 46--><p class="noindent" >This fixes VIRTIO-144.
  <!--l. 48--><p class="noindent" >See <a 
href="#x1-2020002">5.2<!--tex4ht:ref: sec:Device Types / Block Device --></a>, <a 
href="#x1-3130005">7.2.5<!--tex4ht:ref: sec:Conformance / Driver Conformance / Block Driver Conformance --></a> and <a 
href="#x1-3230005">7.3.5<!--tex4ht:ref: sec:Conformance / Device Conformance / Block Device Conformance --></a>.            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-7-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-7-1"  
class="td11"> 546  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-7-2"  
class="td11"> 18 Oct 2015  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-7-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-7-4"  
class="td11">
 <!--l. 53--><p class="noindent" >pci: clarify configuration access
  capability rules
  <!--l. 55--><p class="noindent" >The point of the configuration
  access  capability  is  to  enable
  access to other capabilities. The
  intent never was to allow writes
  to a random place within device
  BARs.                      Limiting
  drivers simplifies devices - and
  devices can always add another
  capability if drivers ever want to
  access some other range.
  <!--l. 62--><p class="noindent" >This resolves VIRTIO-145.
  <!--l. 64--><p class="noindent" >See <a 
href="#x1-890002">4.1.4.7.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>.                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-8-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-8-1"  
class="td11"> 547  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-8-2"  
class="td11"> 18 Oct 2015  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-8-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-8-4"  
class="td11">
 <!--l. 69--><p class="noindent" >add  advice  on  transition  from
  legacy interfaces
  <!--l. 71--><p class="noindent" >Reading legacy chapters gives a
  hint about what changed, let’s
  help readers discover this useful
  shortcut.
  <!--l. 74--><p class="noindent" >This resolves VIRTIO-146.
  <!--l. 76--><p class="noindent" >See <a 
href="#x1-70002">1.3.2<!--tex4ht:ref: sec:Transition from earlier specification drafts --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-9-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-9-1"  
class="td11"> 554  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-9-2"  
class="td11"> 16 Feb 2016  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-9-3"  
class="td11">   Thomas Huth     </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-9-4"  
class="td11">
 <!--l. 79--><p class="noindent" >virtio-net:     fix     inconsistent
  legacy header size
  <!--l. 81--><p class="noindent" >Current     text     says:     The
  legacy   driver   only   presented
  num_buffers    in    the    struct
  virtio_net_hdr                when
  VIRTIO_NET_F_MRG_RXBUF
  was not negotiated;
  <!--l. 85--><p class="noindent" >Should be: "…was negotiated …"
  instead of "…was not negotiated
  …"
  <!--l. 88--><p class="noindent" >To   be   consistent   with   the
  following: without that feature
  the   structure   was   2   bytes
  shorter.
  <!--l. 91--><p class="noindent" >See <a 
href="#x1-1690001">5.1.6.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Legacy Interface: Device Operation --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-10-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-10-1"  
class="td11"> 555  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-10-2"  
class="td11"> 16 Feb 2016  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-10-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-10-4"  
class="td11">
 <!--l. 94--><p class="noindent" >virtio   header:   tweak   change
  motivation
  <!--l. 97--><p class="noindent" >The  changes  are  not  just  to
  remove Linux assumptions, we
  have also renamed ring->queue.
  Tweak  the  header  description
  accordingly.
  <!--l. 101--><p class="noindent" >See <a 
href="#x1-4700010">2.4.10<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Helpers for Operating Virtqueues --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-11-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-11-1"  
class="td11"> 558  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-11-2"  
class="td11"> 16 Feb 2016  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-11-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-11-4"  
class="td11">
 <!--l. 104--><p class="noindent" >rename       virtio_ring.h       to
  virtio_queue.h
  <!--l. 106--><p class="noindent" >Since vring* and VRING* have
  been  replaced  with  virtq*  and
  VIRTQ*              respectively,
  rename the header virtio_ring.h
  to virtio_queue.h.
  <!--l. 109--><p class="noindent" >See <a 
href="#x1-329000A">A<!--tex4ht:ref: sec:virtio-queue.h --></a>.                                   </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-12-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-12-1"  
class="td11"> 559  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-12-2"  
class="td11"> 16 Feb 2016  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-19-12-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:wrap; text-align:left;" id="TBL-19-12-4"  
class="td11">
 <!--l. 112--><p class="noindent" >init: sort status bits
  <!--l. 114--><p class="noindent" >Status bit order is inconsistent:
  they  are  neither  in  increasing
  order nor in the order they are
  likely to be used.
  <!--l. 117--><p class="noindent" >The   second   approach   seems
  more  useful  since  there  aren’t
  that many bits, so the numerical
  order does not help much.
  <!--l. 120--><p class="noindent" >A typical order of use would be:
        <ul class="itemize1">
        <li class="itemize">ACKNOWLEDGE
        </li>
        <li class="itemize">DRIVER
        </li>
        <li class="itemize">then   either   FAILED   or
        FEATURES_OK
        </li>
        <li class="itemize">then   either   FAILED   or
        DRIVER_OK
        </li>
        <li class="itemize">then
        DEVICE_NEEDS_RESET
        (if device detects an error)</li></ul>
  <!--l. 130--><p class="noindent" >Sort the bits accordingly.
  <!--l. 132--><p class="noindent" >See <a 
href="#x1-100001">2.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Status Field --></a>.                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-19-13-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-13-1"  
class="td11">    </td>                                                          

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-19-14-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-14-1"  
class="td11">    </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-19-15-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-15-1"  
class="td11">    </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-19-16-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-16-1"  
class="td11">    </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-19-17-"><td  style="white-space:nowrap; text-align:center;" id="TBL-19-17-1"  
class="td11">    </td>
</tr>
</table></div>
                                                                  

                                                                  
<div class="footnotes"><!--l. 13--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn1x1-bk" id="fn1x1"><sup class="textsuperscript">1</sup></a></span><span 
class="aer-8">This lack of page-sharing implies that the implementation of the device (e.g. the hypervisor</span>
<span 
class="aer-8">or host) needs full access to the guest memory. Communication with untrusted parties (i.e.</span>
<span 
class="aer-8">inter-guest communication) requires copying.</span>
<!--l. 27--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn2x1-bk" id="fn2x1"><sup class="textsuperscript">2</sup></a></span><span 
class="aer-8">The Linux implementation further separates the virtio transport code from the specific</span>
<span 
class="aer-8">virtio drivers: these drivers are shared between different transports.</span>
<!--l. 233--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn3x2-bk" id="fn3x2"><sup class="textsuperscript">3</sup></a></span><span 
class="aer-8">For example, the simplest network device has one virtqueue for transmit and one for</span>
<span 
class="aer-8">receive.</span>
<!--l. 271--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn4x2-bk" id="fn4x2"><sup class="textsuperscript">4</sup></a></span><span 
class="aer-8">For example, if Queue Size is 4 then at most 4 buffers can be queued at any given</span>
<span 
class="aer-8">time.</span>
<!--l. 1825--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn5x4-bk" id="fn5x4"><sup class="textsuperscript">5</sup></a></span><span 
class="aer-8">For example, the simplest network device has two virtqueues.</span>
<!--l. 1856--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn6x4-bk" id="fn6x4"><sup class="textsuperscript">6</sup></a></span><span 
class="aer-8">The 4096 is based on the x86 page size, but it’s also large enough to ensure that the separate</span>
<span 
class="aer-8">parts of the virtqueue are on separate cache lines.</span>
<!--l. 3395--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn7x5-bk" id="fn7x5"><sup class="textsuperscript">7</sup></a></span><span 
class="aer-8">Due to various bugs in implementations, this field is not useful as a guarantee of the</span>
<span 
class="aer-8">transport header size.</span>
<!--l. 3403--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn8x5-bk" id="fn8x5"><sup class="textsuperscript">8</sup></a></span><span 
class="aer-8">This case is not handled by some older hardware, so is called out specifically in the</span>
<span 
class="aer-8">protocol.</span>
<!--l. 3830--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn9x5-bk" id="fn9x5"><sup class="textsuperscript">9</sup></a></span><span 
class="aer-8">Since there are no guarantees, it can use a hash filter or silently switch to allmulti or</span>
<span 
class="aer-8">promiscuous mode if it is given too many addresses.</span>
<!--l. 4210--><p class="nopar" ><span class="footnote-mark"><a 
href="#fn10x5-bk" id="fn10x5"><sup class="textsuperscript">10</sup></a></span><span 
class="aer-8">Consistent with </span><a 
href="#x1-2150002"><span 
class="aer-8">5.2.6.2</span><!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Operation --></a><span 
class="aer-8">, a writethrough cache can be defined broadly as a cache that</span>
<span 
class="aer-8">commits writes to persistent device backend storage before reporting their completion. For</span>
<span 
class="aer-8">example, a battery-backed writeback cache actually counts as writethrough according to this</span>
<span 
class="aer-8">definition.</span>
<!--l. 4357--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn11x5-bk" id="fn11x5"><sup class="textsuperscript">11</sup></a></span><span 
class="aer-8">Note that in this case, according to </span><a 
href="#x1-2110002"><span 
class="aer-8">5.2.5.2</span><!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Initialization --></a><span 
class="aer-8">, the device will not have offered</span>
<span 
class="aer-8">VIRTIO_BLK_F_CONFIG_WCE either.</span>
<!--l. 4616--><p class="nopar" ><span class="footnote-mark"><a 
href="#fn12x5-bk" id="fn12x5"><sup class="textsuperscript">12</sup></a></span><span 
class="aer-8">Because this is high importance and low bandwidth, the current Linux implementation</span>
<span 
class="aer-8">polls  for  the  buffer  to  be  used,  rather  than  waiting  for  an  interrupt,  simplifying  the</span>
<span 
class="aer-8">implementation significantly. However, for generic serial ports with the O_NONBLOCK flag</span>
<span 
class="aer-8">set, the polling limitation is relaxed and the consumed buffers are freed upon the next write</span>
<span 
class="aer-8">or poll call or when a port is closed or hot-unplugged.</span>
<!--l. 4880--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn13x5-bk" id="fn13x5"><sup class="textsuperscript">13</sup></a></span><span 
class="aer-8">This is historical, and independent of the guest page size.</span>
<!--l. 4896--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn14x5-bk" id="fn14x5"><sup class="textsuperscript">14</sup></a></span><span 
class="aer-8">In this case, deflation advice is merely a courtesy.</span>
<!--l. 5253--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn15x5-bk" id="fn15x5"><sup class="textsuperscript">15</sup></a></span><span 
class="aer-8">For example, INQUIRY or REPORT LUNS.</span>
<!--l. 5254--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn16x5-bk" id="fn16x5"><sup class="textsuperscript">16</sup></a></span><span 
class="aer-8">For example, I_T RESET.</span>
<!--l. 5392--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn17x5-bk" id="fn17x5"><sup class="textsuperscript">17</sup></a></span><span 
class="aer-8">There is no separate residual size for </span><span 
class="aeti8-">pi_bytesout </span><span 
class="aer-8">and </span><span 
class="aeti8-">pi_bytesin</span><span 
class="aer-8">. It can be computed from the</span>
<span 
class="aeti8-">residual </span><span 
class="aer-8">field, the size of the data integrity information per sector, and the sizes of </span><span 
class="aeti8-">pi_out</span><span 
class="aer-8">, </span><span 
class="aeti8-">pi_in</span><span 
class="aer-8">,</span>
<span 
class="aeti8-">dataout </span><span 
class="aer-8">and </span><span 
class="aeti8-">datain</span><span 
class="aer-8">.</span>
<!--l. 60--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn18x9-bk" id="fn18x9"><sup class="textsuperscript">18</sup></a></span><span 
class="aer-8">Even if it does mean documenting design or implementation mistakes!</span>             </div>
 
</body></html> 

                                                                  

                                                                  
                                                                  


